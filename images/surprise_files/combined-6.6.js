/** @preserve Notice 
 *
 * This file contains works from many authors under various (but compatible)
 * licenses. Please see ./combined-latest.js for more information.
 *
 */
function initMessenger(window){Array.prototype.remove=function(from,to){var rest=this.slice((to||from)+1||this.length);this.length=from<0?this.length+from:from;return this.push.apply(this,rest)};var Messenger;Messenger={el:null,ob_els:{},ob_callbacks:{},init:function(cb){this.el=document.getElementById("messengerEventPasser");if(!this.el){this.el=document.createElement("div");this.el.setAttribute("id","messengerEventPasser");this.el.setAttribute("style","display:none;");document.body.appendChild(this.el)}if(cb)cb(this)},observe:function(msgName,cb,id){var self=this;if(!id){id="noid"}if(!this.ob_els[msgName]){var e=document.getElementById(msgName+"_eventPasser");if(!e){e=document.createElement("div");e.setAttribute("id",msgName+"_eventPasser");e.setAttribute("style","display:none");this.el.appendChild(e)}this.ob_els[msgName]=e}this.ob_els[msgName].addEventListener(msgName,function(e){var data=null;var kids=self.listToArray(this.childNodes);for(var i=0;el=kids[i];i++){var eid=el.getAttribute("id").split("_")[1];if(id=="all"||eid==id){var subkids=self.listToArray(el.childNodes);var mpEl=subkids[subkids.length-1];try{data=JSON.parse(mpEl.innerText)}catch(err){}el.parentNode.removeChild(el);var tCBs=[];var len=self.ob_callbacks[msgName][id].length;for(var j=0;j<len;j++){var cb=self.ob_callbacks[msgName][id][j];if(!cb.runOnce){tCBs.push(cb)}cb(data,eid)}if(el){el.innerText=""}if(self.ob_callbacks[msgName][id]){for(var k=len;k<self.ob_callbacks[msgName][id].length;k++){tCBs.push(self.ob_callbacks[msgName][id][k])}}self.ob_callbacks[msgName][id]=tCBs}}});if(!this.ob_callbacks[msgName])this.ob_callbacks[msgName]={};if(!this.ob_callbacks[msgName][id])this.ob_callbacks[msgName][id]=[];this.ob_callbacks[msgName][id].push(cb)},unobserve:function(msgName,id){delete this.ob_callbacks[msgName][id]},sendMessage:function(msgName,data,retMsgName,cb,id){var cEl=document.getElementById(msgName+"_eventPasser");if(cEl){if(!id){id="noid"}if(retMsgName){if(cb){cb.runOnce=true;this.observe(retMsgName,cb,id)}}var cEvent=document.createEvent("Event");cEvent.initEvent(msgName,true,true);cEvent.callId=id;var mEl=document.getElementById(msgName+"_"+id+"_eventPasser");if(!mEl){mEl=this.createElement(msgName+"_"+id+"_eventPasser");cEl.appendChild(mEl)}var mpEl=document.createElement("div");mpEl.setAttribute("style","display:none");mEl.appendChild(mpEl);var copy={};try{var fields=Object.getOwnPropertyNames(data);for(var i=0;i<fields.length;i++){var field=fields[i];try{copy[field]=data[field]}catch(err){copy[field]=null}}}catch(outerErr){}try{mpEl.innerText=JSON.stringify(copy)}catch(err){}cEl.dispatchEvent(cEvent)}},storeData:function(id,data){var theId="messenger_"+id+"_dataStore";var d=document.getElementById(theId);if(!d){d=document.createElement("div");d.setAttribute("style","display:none;");d.setAttribute("id",theId);this.el.appendChild(d)}d.innerText=JSON.stringify(data)},getData:function(id){var theId="messenger_"+id+"_dataStore";var d=document.getElementById(theId);if(d){try{return JSON.parse(d.innerText)}catch(err){}}},createElement:function(id){var e=document.createElement("div");e.setAttribute("style","display:none");e.setAttribute("id",id);return e},listToArray:function(nodeList){var arr=[];for(var i=0;node=nodeList[i];i++){arr.push(node)}return arr}};window.Messenger=Messenger;Messenger.init()}if(top.document==document){initMessenger(window)}var Streak={};Streak.clientVersion="6.1467";Streak.optimizelyAccountID=173001298;Streak.optimizelyExperimentID=181337382;Streak.optimizelyOriginalVariationID=181261759;Streak.stripePublishableKey="pk_live_hOZ1AIegCBt7wAuQuXPxgSKd";Streak.googleAnalyticsID="UA-25304962-3";Streak.extVersion=Messenger.getData("extVersion");Streak.server=Messenger.getData("server");Streak.combinedPath=Messenger.getData("combinedPath");Streak.devRealtimeServer=Messenger.getData("devRealtimeServer");Streak.isSafari=Messenger.getData("isSafari");Streak.getCombined=function(type,includeServer){return(includeServer?Streak.server:"")+Streak.combinedPath+"combined-"+Streak.extVersion+"."+type};if(!top.document.getElementById("js_frame")){throw new Error("not in gmail")}Streak.iframe=document.createElement("iframe");Streak.iframe.style.display="none";document.body.appendChild(Streak.iframe);Streak.Date=Streak.iframe.contentWindow.Date;(function(Streak){var CryptoJS=CryptoJS||function(Math,undefined){var C={};var C_lib=C.lib={};var Base=C_lib.Base=function(){function F(){}return{extend:function(overrides){F.prototype=this;var subtype=new F;if(overrides){subtype.mixIn(overrides)}if(!subtype.hasOwnProperty("init")){subtype.init=function(){subtype.$super.init.apply(this,arguments)}}subtype.init.prototype=subtype;subtype.$super=this;return subtype},create:function(){var instance=this.extend();instance.init.apply(instance,arguments);return instance},init:function(){},mixIn:function(properties){for(var propertyName in properties){if(properties.hasOwnProperty(propertyName)){this[propertyName]=properties[propertyName]}}if(properties.hasOwnProperty("toString")){this.toString=properties.toString}},clone:function(){return this.init.prototype.extend(this)}}}();var WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[];if(sigBytes!=undefined){this.sigBytes=sigBytes}else{this.sigBytes=words.length*4}},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words;var thatWords=wordArray.words;var thisSigBytes=this.sigBytes;var thatSigBytes=wordArray.sigBytes;this.clamp();if(thisSigBytes%4){for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}}else if(thatWords.length>65535){for(var i=0;i<thatSigBytes;i+=4){thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2]}}else{thisWords.push.apply(thisWords,thatWords)}this.sigBytes+=thatSigBytes;return this},clamp:function(){var words=this.words;var sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8;words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);clone.words=this.words.slice(0);return clone},random:function(nBytes){var words=[];for(var i=0;i<nBytes;i+=4){words.push(Math.random()*4294967296|0)}return new WordArray.init(words,nBytes)}});var C_enc=C.enc={};var Hex=C_enc.Hex={stringify:function(wordArray){var words=wordArray.words;var sigBytes=wordArray.sigBytes;var hexChars=[];for(var i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16));hexChars.push((bite&15).toString(16))}return hexChars.join("")},parse:function(hexStr){var hexStrLength=hexStr.length;var words=[];for(var i=0;i<hexStrLength;i+=2){words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4}return new WordArray.init(words,hexStrLength/2)}};var Latin1=C_enc.Latin1={stringify:function(wordArray){var words=wordArray.words;var sigBytes=wordArray.sigBytes;var latin1Chars=[];for(var i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){var latin1StrLength=latin1Str.length;var words=[];for(var i=0;i<latin1StrLength;i++){words[i>>>2]|=(latin1Str.charCodeAt(i)&255)<<24-i%4*8}return new WordArray.init(words,latin1StrLength)}};var Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}};var BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init;this._nDataBytes=0},_append:function(data){if(typeof data=="string"){data=Utf8.parse(data)}this._data.concat(data);this._nDataBytes+=data.sigBytes},_process:function(doFlush){var data=this._data;var dataWords=data.words;var dataSigBytes=data.sigBytes;var blockSize=this.blockSize;var blockSizeBytes=blockSize*4;var nBlocksReady=dataSigBytes/blockSizeBytes;if(doFlush){nBlocksReady=Math.ceil(nBlocksReady)}else{nBlocksReady=Math.max((nBlocksReady|0)-this._minBufferSize,0)}var nWordsReady=nBlocksReady*blockSize;var nBytesReady=Math.min(nWordsReady*4,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize){this._doProcessBlock(dataWords,offset)}var processedWords=dataWords.splice(0,nWordsReady);data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);clone._data=this._data.clone();return clone},_minBufferSize:0});var Hasher=C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg);this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this);this._doReset()},update:function(messageUpdate){this._append(messageUpdate);this._process();return this},finalize:function(messageUpdate){if(messageUpdate){this._append(messageUpdate)}var hash=this._doFinalize();return hash},blockSize:512/32,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}});var C_algo=C.algo={};return C}(Math);Streak.CryptoJS=CryptoJS})(Streak);(function(Math,Streak){var C=Streak.CryptoJS;var C_lib=C.lib;var WordArray=C_lib.WordArray;var Hasher=C_lib.Hasher;var C_algo=C.algo;var T=[];(function(){for(var i=0;i<64;i++){T[i]=Math.abs(Math.sin(i+1))*4294967296|0}})();var MD5=C_algo.MD5=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i;var M_offset_i=M[offset_i];M[offset_i]=(M_offset_i<<8|M_offset_i>>>24)&16711935|(M_offset_i<<24|M_offset_i>>>8)&4278255360}var H=this._hash.words;var M_offset_0=M[offset+0];var M_offset_1=M[offset+1];var M_offset_2=M[offset+2];var M_offset_3=M[offset+3];var M_offset_4=M[offset+4];var M_offset_5=M[offset+5];var M_offset_6=M[offset+6];var M_offset_7=M[offset+7];var M_offset_8=M[offset+8];var M_offset_9=M[offset+9];var M_offset_10=M[offset+10];var M_offset_11=M[offset+11];var M_offset_12=M[offset+12];var M_offset_13=M[offset+13];var M_offset_14=M[offset+14];var M_offset_15=M[offset+15];var a=H[0];var b=H[1];var c=H[2];var d=H[3];a=FF(a,b,c,d,M_offset_0,7,T[0]);d=FF(d,a,b,c,M_offset_1,12,T[1]);c=FF(c,d,a,b,M_offset_2,17,T[2]);b=FF(b,c,d,a,M_offset_3,22,T[3]);a=FF(a,b,c,d,M_offset_4,7,T[4]);d=FF(d,a,b,c,M_offset_5,12,T[5]);c=FF(c,d,a,b,M_offset_6,17,T[6]);b=FF(b,c,d,a,M_offset_7,22,T[7]);a=FF(a,b,c,d,M_offset_8,7,T[8]);d=FF(d,a,b,c,M_offset_9,12,T[9]);c=FF(c,d,a,b,M_offset_10,17,T[10]);b=FF(b,c,d,a,M_offset_11,22,T[11]);a=FF(a,b,c,d,M_offset_12,7,T[12]);d=FF(d,a,b,c,M_offset_13,12,T[13]);c=FF(c,d,a,b,M_offset_14,17,T[14]);b=FF(b,c,d,a,M_offset_15,22,T[15]);a=GG(a,b,c,d,M_offset_1,5,T[16]);d=GG(d,a,b,c,M_offset_6,9,T[17]);c=GG(c,d,a,b,M_offset_11,14,T[18]);b=GG(b,c,d,a,M_offset_0,20,T[19]);a=GG(a,b,c,d,M_offset_5,5,T[20]);d=GG(d,a,b,c,M_offset_10,9,T[21]);c=GG(c,d,a,b,M_offset_15,14,T[22]);b=GG(b,c,d,a,M_offset_4,20,T[23]);a=GG(a,b,c,d,M_offset_9,5,T[24]);d=GG(d,a,b,c,M_offset_14,9,T[25]);c=GG(c,d,a,b,M_offset_3,14,T[26]);b=GG(b,c,d,a,M_offset_8,20,T[27]);a=GG(a,b,c,d,M_offset_13,5,T[28]);d=GG(d,a,b,c,M_offset_2,9,T[29]);c=GG(c,d,a,b,M_offset_7,14,T[30]);b=GG(b,c,d,a,M_offset_12,20,T[31]);a=HH(a,b,c,d,M_offset_5,4,T[32]);d=HH(d,a,b,c,M_offset_8,11,T[33]);c=HH(c,d,a,b,M_offset_11,16,T[34]);b=HH(b,c,d,a,M_offset_14,23,T[35]);a=HH(a,b,c,d,M_offset_1,4,T[36]);d=HH(d,a,b,c,M_offset_4,11,T[37]);c=HH(c,d,a,b,M_offset_7,16,T[38]);b=HH(b,c,d,a,M_offset_10,23,T[39]);a=HH(a,b,c,d,M_offset_13,4,T[40]);d=HH(d,a,b,c,M_offset_0,11,T[41]);c=HH(c,d,a,b,M_offset_3,16,T[42]);b=HH(b,c,d,a,M_offset_6,23,T[43]);a=HH(a,b,c,d,M_offset_9,4,T[44]);d=HH(d,a,b,c,M_offset_12,11,T[45]);c=HH(c,d,a,b,M_offset_15,16,T[46]);b=HH(b,c,d,a,M_offset_2,23,T[47]);a=II(a,b,c,d,M_offset_0,6,T[48]);d=II(d,a,b,c,M_offset_7,10,T[49]);c=II(c,d,a,b,M_offset_14,15,T[50]);b=II(b,c,d,a,M_offset_5,21,T[51]);a=II(a,b,c,d,M_offset_12,6,T[52]);d=II(d,a,b,c,M_offset_3,10,T[53]);c=II(c,d,a,b,M_offset_10,15,T[54]);b=II(b,c,d,a,M_offset_1,21,T[55]);a=II(a,b,c,d,M_offset_8,6,T[56]);d=II(d,a,b,c,M_offset_15,10,T[57]);c=II(c,d,a,b,M_offset_6,15,T[58]);b=II(b,c,d,a,M_offset_13,21,T[59]);a=II(a,b,c,d,M_offset_4,6,T[60]);d=II(d,a,b,c,M_offset_11,10,T[61]);c=II(c,d,a,b,M_offset_2,15,T[62]);b=II(b,c,d,a,M_offset_9,21,T[63]);H[0]=H[0]+a|0;H[1]=H[1]+b|0;H[2]=H[2]+c|0;H[3]=H[3]+d|0},_doFinalize:function(){var data=this._data;var dataWords=data.words;var nBitsTotal=this._nDataBytes*8;var nBitsLeft=data.sigBytes*8;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32;var nBitsTotalH=Math.floor(nBitsTotal/4294967296);var nBitsTotalL=nBitsTotal;dataWords[(nBitsLeft+64>>>9<<4)+15]=(nBitsTotalH<<8|nBitsTotalH>>>24)&16711935|(nBitsTotalH<<24|nBitsTotalH>>>8)&4278255360;dataWords[(nBitsLeft+64>>>9<<4)+14]=(nBitsTotalL<<8|nBitsTotalL>>>24)&16711935|(nBitsTotalL<<24|nBitsTotalL>>>8)&4278255360;data.sigBytes=(dataWords.length+1)*4;this._process();var hash=this._hash;var H=hash.words;for(var i=0;i<4;i++){var H_i=H[i];H[i]=(H_i<<8|H_i>>>24)&16711935|(H_i<<24|H_i>>>8)&4278255360}return hash},clone:function(){var clone=Hasher.clone.call(this);clone._hash=this._hash.clone();return clone}});function FF(a,b,c,d,x,s,t){var n=a+(b&c|~b&d)+x+t;return(n<<s|n>>>32-s)+b}function GG(a,b,c,d,x,s,t){var n=a+(b&d|c&~d)+x+t;return(n<<s|n>>>32-s)+b}function HH(a,b,c,d,x,s,t){var n=a+(b^c^d)+x+t;return(n<<s|n>>>32-s)+b}function II(a,b,c,d,x,s,t){var n=a+(c^(b|~d))+x+t;return(n<<s|n>>>32-s)+b}C.MD5=Hasher._createHelper(MD5);C.HmacMD5=Hasher._createHmacHelper(MD5)})(Math,Streak);(function(Streak){var CSSStyleManipulator={addRule:function(rule){var stylesheets=Streak.document.styleSheets;var insertedRule=null;var stylesheet=null;if(stylesheets.length==0){var head=head=document.head||document.getElementsByTagName("head")[0];var style=document.createElement("style");style.type="text/css";head.appendChild(style);stylesheets=Streak.document.styleSheets}for(var ii=0;ii<stylesheets.length;ii++){try{stylesheet=stylesheets[ii];insertedRule=stylesheet.insertRule(rule,0);break}catch(err){}}return{stylesheet:stylesheet,rule:insertedRule,destroy:function(){stylesheet.removeRule(rule)}}}};Streak.CSSStyleManipulator=CSSStyleManipulator})(Streak);(function(Streak){var delimiter=",";var delimiterCode=",".charCodeAt(0);Streak.csvParser={parse:function(text,f){var o;return this.parseRows(text,function(row,i){if(o)return o(row,i-1);var a=Streak.newFunction("d","return {"+row.map(function(name,i){return JSON.stringify(name)+": d["+i+"]"}).join(",")+"}");o=f?function(row,i){return f(a(row),i)}:a})},parseRows:function(text,f){var EOL={},EOF={},rows=[],N=text.length,I=0,n=0,t,eol;function token(){if(I>=N)return EOF;if(eol)return eol=false,EOL;var j=I;if(text.charCodeAt(j)===34){var i=j;while(i++<N){if(text.charCodeAt(i)===34){if(text.charCodeAt(i+1)!==34)break;++i}}I=i+2;var c=text.charCodeAt(i+1);if(c===13){eol=true;if(text.charCodeAt(i+2)===10)++I}else if(c===10){eol=true}return text.substring(j+1,i).replace(/""/g,'"')}while(I<N){var c=text.charCodeAt(I++),k=1;if(c===10)eol=true;else if(c===13){eol=true;if(text.charCodeAt(I)===10)++I,++k}else if(c!==delimiterCode)continue;return text.substring(j,I-k)}return text.substring(j)}while((t=token())!==EOF){var a=[];while(t!==EOL&&t!==EOF){a.push(t);t=token()}if(f&&!(a=f(a,n++)))continue;rows.push(a)}return rows}}})(Streak);(function(Streak){var Date=Streak.Date;var object=Object,array=Array,regexp=RegExp,date=Date,string=String,number=Number,math=Math,Undefined;var internalToString=object.prototype.toString;var globalContext=typeof global!=="undefined"?global:this;var typeChecks={};var definePropertySupport=object.defineProperty&&object.defineProperties;var ClassNames="Array,Boolean,Date,Function,Number,String,RegExp".split(",");var isArray=buildClassCheck(ClassNames[0]);var isBoolean=buildClassCheck(ClassNames[1]);var isDate=buildClassCheck(ClassNames[2]);var isFunction=buildClassCheck(ClassNames[3]);var isNumber=buildClassCheck(ClassNames[4]);var isString=buildClassCheck(ClassNames[5]);var isRegExp=buildClassCheck(ClassNames[6]);function buildClassCheck(name){var type,fn;if(/String|Number|Boolean/.test(name)){type=name.toLowerCase()}fn=name==="Array"&&array.isArray||function(obj){if(type&&typeof obj===type){return true}return className(obj)==="[object "+name+"]"};typeChecks[name]=fn;return fn}function className(obj){return internalToString.call(obj)}function initializeClasses(){initializeClass(object);initializeClass(date);iterateOverObject(ClassNames,function(i,name){initializeClass(globalContext[name])})}function initializeClass(klass){if(klass["SugarMethods"])return;defineProperty(klass,"SugarMethods",{});extend(klass,false,false,{extend:function(methods,override,instance){extend(klass,instance!==false,override,methods)},sugarRestore:function(){return batchMethodExecute(klass,arguments,function(target,name,m){defineProperty(target,name,m.method)})},sugarRevert:function(){return batchMethodExecute(klass,arguments,function(target,name,m){if(m.existed){defineProperty(target,name,m.original)}else{delete target[name]}})}})}function extend(klass,instance,override,methods){var extendee=instance?klass.prototype:klass;initializeClass(klass);iterateOverObject(methods,function(name,method){var original=extendee[name];var existed=hasOwnProperty(extendee,name);if(typeof override==="function"){method=wrapNative(extendee[name],method,override)}if(override!==false||!extendee[name]){defineProperty(extendee,name,method)}klass["SugarMethods"][name]={instance:instance,method:method,original:original,existed:existed}})}function extendSimilar(klass,instance,override,set,fn){var methods={};set=isString(set)?set.split(","):set;set.forEach(function(name,i){fn(methods,name,i)});extend(klass,instance,override,methods)}function batchMethodExecute(klass,args,fn){var all=args.length===0,methods=multiArgs(args),changed=false;iterateOverObject(klass["SugarMethods"],function(name,m){if(all||methods.indexOf(name)>-1){changed=true;fn(m.instance?klass.prototype:klass,name,m)}});return changed}function wrapNative(nativeFn,extendedFn,condition){return function(){var fn;if(nativeFn&&(condition===true||!condition.apply(this,arguments))){fn=nativeFn}else{fn=extendedFn}return fn.apply(this,arguments)}}function defineProperty(target,name,method){if(definePropertySupport){object.defineProperty(target,name,{value:method,configurable:true,enumerable:false,writable:true})}else{target[name]=method}}function multiArgs(args,fn){var result=[],i,len;for(i=0,len=args.length;i<len;i++){result.push(args[i]);if(fn)fn.call(args,args[i],i)}return result}function flattenedArgs(obj,fn,from){multiArgs(array.prototype.concat.apply([],array.prototype.slice.call(obj,from||0)),fn)}function checkCallback(fn){if(!fn||!fn.call){throw new TypeError("Callback is not callable")}}function isDefined(o){return o!==Undefined}function isUndefined(o){return o===Undefined}function isObjectPrimitive(obj){return obj&&typeof obj==="object"}function isObject(obj){return!!obj&&className(obj)==="[object Object]"&&"hasOwnProperty"in obj}function hasOwnProperty(obj,key){return object["hasOwnProperty"].call(obj,key)}function iterateOverObject(obj,fn){var key;for(key in obj){if(!hasOwnProperty(obj,key))continue;if(fn.call(obj,key,obj[key],obj)===false)break}}function simpleMerge(target,source){iterateOverObject(source,function(key){target[key]=source[key]});return target}function Hash(obj){simpleMerge(this,obj)}Hash.prototype.constructor=object;function getRange(start,stop,fn,step){var arr=[],i=parseInt(start),down=step<0;while(!down&&i<=stop||down&&i>=stop){arr.push(i);if(fn)fn.call(this,i);i+=step||1}return arr}function round(val,precision,method){var fn=math[method||"round"];var multiplier=math.pow(10,math.abs(precision||0));if(precision<0)multiplier=1/multiplier;return fn(val*multiplier)/multiplier}function ceil(val,precision){return round(val,precision,"ceil")}function floor(val,precision){return round(val,precision,"floor")}function padNumber(num,place,sign,base){var str=math.abs(num).toString(base||10);str=repeatString(place-str.replace(/\.\d+/,"").length,"0")+str;if(sign||num<0){str=(num<0?"-":"+")+str}return str}function getOrdinalizedSuffix(num){if(num>=11&&num<=13){return"th"}else{switch(num%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}function getTrimmableCharacters(){return"	\n\f\r   ᠎             \u2028\u2029　﻿"}function repeatString(times,str){return array(math.max(0,isDefined(times)?times:1)+1).join(str||"")}function getRegExpFlags(reg,add){var flags=reg.toString().match(/[^/]*$/)[0];if(add){flags=(flags+add).split("").sort().join("").replace(/([gimy])\1+/g,"$1")}return flags}function escapeRegExp(str){if(!isString(str))str=string(str);return str.replace(/([\\/'*+?|()\[\]{}.^$])/g,"\\$1")}function stringify(thing,stack){var type=typeof thing,thingIsObject,thingIsArray,klass,value,arr,key,i,len;if(type==="string")return thing;klass=internalToString.call(thing);thingIsObject=isObject(thing);thingIsArray=klass==="[object Array]";if(thing!=null&&thingIsObject||thingIsArray){if(!stack)stack=[];if(stack.length>1){i=stack.length;while(i--){if(stack[i]===thing){return"CYC"}}}stack.push(thing);value=string(thing.constructor);arr=thingIsArray?thing:object.keys(thing).sort();for(i=0,len=arr.length;i<len;i++){key=thingIsArray?i:arr[i];value+=key+stringify(thing[key],stack)}stack.pop()}else if(1/thing===-Infinity){value="-0"}else{value=string(thing&&thing.valueOf?thing.valueOf():thing)}return type+klass+value}function isEqual(a,b){if(objectIsMatchedByValue(a)&&objectIsMatchedByValue(b)){return stringify(a)===stringify(b)}else{return a===b}}function objectIsMatchedByValue(obj){var klass=className(obj);return/^\[object Date|Array|String|Number|RegExp|Boolean|Arguments\]$/.test(klass)||isObject(obj)}function entryAtIndex(arr,args,str){var result=[],length=arr.length,loop=args[args.length-1]!==false,r;multiArgs(args,function(index){if(isBoolean(index))return false;if(loop){index=index%length;if(index<0)index=length+index}r=str?arr.charAt(index)||"":arr[index];result.push(r)});return result.length<2?result[0]:result}function buildObjectInstanceMethods(set,target){extendSimilar(target,true,false,set,function(methods,name){methods[name+(name==="equal"?"s":"")]=function(){return object[name].apply(null,[this].concat(multiArgs(arguments)))}})}initializeClasses();function multiMatch(el,match,scope,params){var result=true;if(el===match){return true}else if(isRegExp(match)&&isString(el)){return regexp(match).test(el)}else if(isFunction(match)){return match.apply(scope,params)}else if(isObject(match)&&isObjectPrimitive(el)){iterateOverObject(match,function(key,value){if(!multiMatch(el[key],match[key],scope,[el[key],el])){result=false}});return result}else{return isEqual(el,match)}}function transformArgument(el,map,context,mapArgs){if(isUndefined(map)){return el}else if(isFunction(map)){return map.apply(context,mapArgs||[])}else if(isFunction(el[map])){return el[map].call(el)}else{return el[map]}}function arrayEach(arr,fn,startIndex,loop){var length,index,i;if(startIndex<0)startIndex=arr.length+startIndex;i=isNaN(startIndex)?0:startIndex;length=loop===true?arr.length+i:arr.length;while(i<length){index=i%arr.length;if(!(index in arr)){return iterateOverSparseArray(arr,fn,i,loop)}else if(fn.call(arr,arr[index],index,arr)===false){break}i++}}function iterateOverSparseArray(arr,fn,fromIndex,loop){var indexes=[],i;for(i in arr){if(isArrayIndex(arr,i)&&i>=fromIndex){indexes.push(parseInt(i))}}indexes.sort().each(function(index){return fn.call(arr,arr[index],index,arr)});return arr}function isArrayIndex(arr,i){return i in arr&&toUInt32(i)==i&&i!=4294967295}function toUInt32(i){return i>>>0}function arrayFind(arr,f,startIndex,loop,returnIndex){var result,index;arrayEach(arr,function(el,i,arr){if(multiMatch(el,f,arr,[el,i,arr])){result=el;index=i;return false}},startIndex,loop);return returnIndex?index:result}function arrayUnique(arr,map){var result=[],o={},transformed;arrayEach(arr,function(el,i){transformed=map?transformArgument(el,map,arr,[el,i,arr]):el;if(!checkForElementInHashAndSet(o,transformed)){result.push(el)}});return result}function arrayIntersect(arr1,arr2,subtract){var result=[],o={};arr2.each(function(el){checkForElementInHashAndSet(o,el)});arr1.each(function(el){var stringified=stringify(el),isReference=!objectIsMatchedByValue(el);if(elementExistsInHash(o,stringified,el,isReference)!=subtract){discardElementFromHash(o,stringified,el,isReference);result.push(el)}});return result}function arrayFlatten(arr,level,current){level=level||Infinity;current=current||0;var result=[];arrayEach(arr,function(el){if(isArray(el)&&current<level){result=result.concat(arrayFlatten(el,level,current+1))}else{result.push(el)}});return result}function flatArguments(args){var result=[];multiArgs(args,function(arg){result=result.concat(arg)});return result}function elementExistsInHash(hash,key,element,isReference){var exists=key in hash;if(isReference){if(!hash[key]){hash[key]=[]}exists=hash[key].indexOf(element)!==-1}return exists}function checkForElementInHashAndSet(hash,element){var stringified=stringify(element),isReference=!objectIsMatchedByValue(element),exists=elementExistsInHash(hash,stringified,element,isReference);if(isReference){hash[stringified].push(element)}else{hash[stringified]=element}return exists}function discardElementFromHash(hash,key,element,isReference){var arr,i=0;if(isReference){arr=hash[key];while(i<arr.length){if(arr[i]===element){arr.splice(i,1)}else{i+=1}}}else{delete hash[key]}}function getMinOrMax(obj,map,which,all){var edge,result=[],max=which==="max",min=which==="min",isArray=Array.isArray(obj);iterateOverObject(obj,function(key){var el=obj[key],test=transformArgument(el,map,obj,isArray?[el,parseInt(key),obj]:[]);if(isUndefined(test)){throw new TypeError("Cannot compare with undefined")}if(test===edge){result.push(el)}else if(isUndefined(edge)||max&&test>edge||min&&test<edge){result=[el];edge=test}});if(!isArray)result=arrayFlatten(result,1);return all?result:result[0]}function collateStrings(a,b){var aValue,bValue,aChar,bChar,aEquiv,bEquiv,index=0,tiebreaker=0;a=getCollationReadyString(a);b=getCollationReadyString(b);do{aChar=getCollationCharacter(a,index);bChar=getCollationCharacter(b,index);aValue=getCollationValue(aChar);bValue=getCollationValue(bChar);if(aValue===-1||bValue===-1){aValue=a.charCodeAt(index)||null;bValue=b.charCodeAt(index)||null}aEquiv=aChar!==a.charAt(index);bEquiv=bChar!==b.charAt(index);if(aEquiv!==bEquiv&&tiebreaker===0){tiebreaker=aEquiv-bEquiv}index+=1}while(aValue!=null&&bValue!=null&&aValue===bValue);if(aValue===bValue)return tiebreaker;return aValue<bValue?-1:1}function getCollationReadyString(str){if(array[AlphanumericSortIgnoreCase]){str=str.toLowerCase()}return str.replace(array[AlphanumericSortIgnore],"")}function getCollationCharacter(str,index){var chr=str.charAt(index),eq=array[AlphanumericSortEquivalents]||{};return eq[chr]||chr}function getCollationValue(chr){var order=array[AlphanumericSortOrder];if(!chr){return null}else{return order.indexOf(chr)}}var AlphanumericSortOrder="AlphanumericSortOrder";var AlphanumericSortIgnore="AlphanumericSortIgnore";var AlphanumericSortIgnoreCase="AlphanumericSortIgnoreCase";var AlphanumericSortEquivalents="AlphanumericSortEquivalents";function buildEnhancements(){var callbackCheck=function(){var a=arguments;return a.length>0&&!isFunction(a[0])};extendSimilar(array,true,callbackCheck,"map,every,all,some,any,none,filter",function(methods,name){methods[name]=function(f){return this[name](function(el,index){if(name==="map"){return transformArgument(el,f,this,[el,index,this])}else{return multiMatch(el,f,this,[el,index,this])}})}})}function buildAlphanumericSort(){var order="AÁÀÂÃĄBCĆČÇDĎÐEÉÈĚÊËĘFGĞHıIÍÌİÎÏJKLŁMNŃŇÑOÓÒÔPQRŘSŚŠŞTŤUÚÙŮÛÜVWXYÝZŹŻŽÞÆŒØÕÅÄÖ";var equiv="AÁÀÂÃÄ,CÇ,EÉÈÊË,IÍÌİÎÏ,OÓÒÔÕÖ,Sß,UÚÙÛÜ";array[AlphanumericSortOrder]=order.split("").map(function(str){return str+str.toLowerCase()}).join("");var equivalents={};arrayEach(equiv.split(","),function(set){var equivalent=set.charAt(0);arrayEach(set.slice(1).split(""),function(chr){equivalents[chr]=equivalent;equivalents[chr.toLowerCase()]=equivalent.toLowerCase()})});array[AlphanumericSortIgnoreCase]=true;array[AlphanumericSortEquivalents]=equivalents}extend(array,false,false,{create:function(){var result=[],tmp;multiArgs(arguments,function(a){if(isObjectPrimitive(a)){try{tmp=array.prototype.slice.call(a,0);if(tmp.length>0){a=tmp}}catch(e){}}result=result.concat(a)});return result}});extend(array,true,false,{find:function(f,index,loop){return arrayFind(this,f,index,loop)},findAll:function(f,index,loop){var result=[];arrayEach(this,function(el,i,arr){if(multiMatch(el,f,arr,[el,i,arr])){result.push(el)}},index,loop);return result},findIndex:function(f,startIndex,loop){var index=arrayFind(this,f,startIndex,loop,true);return isUndefined(index)?-1:index},count:function(f){if(isUndefined(f))return this.length;return this.findAll(f).length},removeAt:function(start,end){var i,len;if(isUndefined(start))return this;if(isUndefined(end))end=start;for(i=0,len=end-start;i<=len;i++){this.splice(start,1)}return this},include:function(el,index){return this.clone().add(el,index)},exclude:function(){return array.prototype.remove.apply(this.clone(),arguments)},clone:function(){return simpleMerge([],this)},unique:function(map){return arrayUnique(this,map)},flatten:function(limit){return arrayFlatten(this,limit)},union:function(){return arrayUnique(this.concat(flatArguments(arguments)))},intersect:function(){return arrayIntersect(this,flatArguments(arguments),false)},subtract:function(a){return arrayIntersect(this,flatArguments(arguments),true)},at:function(){return entryAtIndex(this,arguments)},first:function(num){if(isUndefined(num))return this[0];if(num<0)num=0;return this.slice(0,num)},last:function(num){if(isUndefined(num))return this[this.length-1];var start=this.length-num<0?0:this.length-num;return this.slice(start)},from:function(num){return this.slice(num)},to:function(num){if(isUndefined(num))num=this.length;return this.slice(0,num)},min:function(map,all){return getMinOrMax(this,map,"min",all)},max:function(map,all){return getMinOrMax(this,map,"max",all)},least:function(map,all){return getMinOrMax(this.groupBy.apply(this,[map]),"length","min",all)},most:function(map,all){return getMinOrMax(this.groupBy.apply(this,[map]),"length","max",all)},sum:function(map){var arr=map?this.map(map):this;return arr.length>0?arr.reduce(function(a,b){return a+b}):0},average:function(map){var arr=map?this.map(map):this;return arr.length>0?arr.sum()/arr.length:0},inGroups:function(num,padding){var pad=arguments.length>1;var arr=this;var result=[];var divisor=ceil(this.length/num);getRange(0,num-1,function(i){var index=i*divisor;var group=arr.slice(index,index+divisor);if(pad&&group.length<divisor){getRange(1,divisor-group.length,function(){group=group.add(padding)})}result.push(group)});return result},inGroupsOf:function(num,padding){var result=[],len=this.length,arr=this,group;if(len===0||num===0)return arr;if(isUndefined(num))num=1;if(isUndefined(padding))padding=null;getRange(0,ceil(len/num)-1,function(i){group=arr.slice(num*i,num*i+num);while(group.length<num){group.push(padding)}result.push(group)});return result},isEmpty:function(){return this.compact().length==0},sortBy:function(map,desc){var arr=this.clone();arr.sort(function(a,b){var aProperty,bProperty,comp;aProperty=transformArgument(a,map,arr,[a]);bProperty=transformArgument(b,map,arr,[b]);if(isString(aProperty)&&isString(bProperty)){comp=collateStrings(aProperty,bProperty)}else if(aProperty<bProperty){comp=-1}else if(aProperty>bProperty){comp=1}else{comp=0}return comp*(desc?-1:1)});return arr
},randomize:function(){var arr=this.concat(),i=arr.length,j,x;while(i){j=math.random()*i|0;x=arr[--i];arr[i]=arr[j];arr[j]=x}return arr},zip:function(){var args=multiArgs(arguments);return this.map(function(el,i){return[el].concat(args.map(function(k){return i in k?k[i]:null}))})},sample:function(num){var arr=this.randomize();return arguments.length>0?arr.slice(0,num):arr[0]},each:function(fn,index,loop){arrayEach(this,fn,index,loop);return this},add:function(el,index){if(!isNumber(number(index))||isNaN(index))index=this.length;array.prototype.splice.apply(this,[index,0].concat(el));return this},remove:function(){var i,arr=this;multiArgs(arguments,function(f){i=0;while(i<arr.length){if(multiMatch(arr[i],f,arr,[arr[i],i,arr])){arr.splice(i,1)}else{i++}}});return arr},compact:function(all){var result=[];arrayEach(this,function(el,i){if(isArray(el)){result.push(el.compact())}else if(all&&el){result.push(el)}else if(!all&&el!=null&&el.valueOf()===el.valueOf()){result.push(el)}});return result},groupBy:function(map,fn){var arr=this,result={},key;arrayEach(arr,function(el,index){key=transformArgument(el,map,arr,[el,index,arr]);if(!result[key])result[key]=[];result[key].push(el)});if(fn){iterateOverObject(result,fn)}return result},none:function(){return!this.any.apply(this,arguments)}});extend(array,true,false,{all:array.prototype.every,any:array.prototype.some,insert:array.prototype.add});function keysWithCoercion(obj){if(obj&&obj.valueOf){obj=obj.valueOf()}return object.keys(obj)}function buildEnumerableMethods(names,mapping){extendSimilar(object,false,false,names,function(methods,name){methods[name]=function(obj,arg1,arg2){var result,coerced=keysWithCoercion(obj);result=array.prototype[name].call(coerced,function(key){if(mapping){return transformArgument(obj[key],arg1,obj,[key,obj[key],obj])}else{return multiMatch(obj[key],arg1,obj,[key,obj[key],obj])}},arg2);if(isArray(result)){result=result.reduce(function(o,key,i){o[key]=obj[key];return o},{})}return result}});buildObjectInstanceMethods(names,Hash)}extend(object,false,false,{map:function(obj,map){return keysWithCoercion(obj).reduce(function(result,key){result[key]=transformArgument(obj[key],map,obj,[key,obj[key],obj]);return result},{})},reduce:function(obj){var values=keysWithCoercion(obj).map(function(key){return obj[key]});return values.reduce.apply(values,multiArgs(arguments).slice(1))},each:function(obj,fn){checkCallback(fn);iterateOverObject(obj,fn);return obj},size:function(obj){return keysWithCoercion(obj).length}});var EnumerableFindingMethods="any,all,none,count,find,findAll,isEmpty".split(",");var EnumerableMappingMethods="sum,average,min,max,least,most".split(",");var EnumerableOtherMethods="map,reduce,size".split(",");var EnumerableMethods=EnumerableFindingMethods.concat(EnumerableMappingMethods).concat(EnumerableOtherMethods);buildEnhancements();buildAlphanumericSort();buildEnumerableMethods(EnumerableFindingMethods);buildEnumerableMethods(EnumerableMappingMethods,true);buildObjectInstanceMethods(EnumerableOtherMethods,Hash);var English;var CurrentLocalization;var TimeFormat=["ampm","hour","minute","second","ampm","utc","offset_sign","offset_hours","offset_minutes","ampm"];var DecimalReg="(?:[,.]\\d+)?";var HoursReg="\\d{1,2}"+DecimalReg;var SixtyReg="[0-5]\\d"+DecimalReg;var RequiredTime="({t})?\\s*("+HoursReg+")(?:{h}("+SixtyReg+")?{m}(?::?("+SixtyReg+"){s})?\\s*(?:({t})|(Z)|(?:([+-])(\\d{2,2})(?::?(\\d{2,2}))?)?)?|\\s*({t}))";var KanjiDigits="〇一二三四五六七八九十百千万";var FullWidthDigits="０１２３４５６７８９";var AsianDigitMap={};var AsianDigitReg;var DateArgumentUnits;var DateUnitsReversed;var CoreDateFormats=[];var DateOutputFormats=[{token:"f{1,4}|ms|milliseconds",format:function(d){return callDateGet(d,"Milliseconds")}},{token:"ss?|seconds",format:function(d,len){return callDateGet(d,"Seconds")}},{token:"mm?|minutes",format:function(d,len){return callDateGet(d,"Minutes")}},{token:"hh?|hours|12hr",format:function(d){return getShortHour(d)}},{token:"HH?|24hr",format:function(d){return callDateGet(d,"Hours")}},{token:"dd?|date|day",format:function(d){return callDateGet(d,"Date")}},{token:"dow|weekday",word:true,format:function(d,loc,n,t){var dow=callDateGet(d,"Day");return loc["weekdays"][dow+(n-1)*7]}},{token:"MM?",format:function(d){return callDateGet(d,"Month")+1}},{token:"mon|month",word:true,format:function(d,loc,n,len){var month=callDateGet(d,"Month");return loc["months"][month+(n-1)*12]}},{token:"y{2,4}|year",format:function(d){return callDateGet(d,"FullYear")}},{token:"[Tt]{1,2}",format:function(d,loc,n,format){if(loc["ampm"].length==0)return"";var hours=callDateGet(d,"Hours");var str=loc["ampm"][floor(hours/12)];if(format.length===1)str=str.slice(0,1);if(format.slice(0,1)==="T")str=str.toUpperCase();return str}},{token:"z{1,4}|tz|timezone",text:true,format:function(d,loc,n,format){var tz=d.getUTCOffset();if(format=="z"||format=="zz"){tz=tz.replace(/(\d{2})(\d{2})/,function(f,h,m){return padNumber(h,format.length)})}return tz}},{token:"iso(tz|timezone)",format:function(d){return d.getUTCOffset(true)}},{token:"ord",format:function(d){var date=callDateGet(d,"Date");return date+getOrdinalizedSuffix(date)}}];var DateUnits=[{unit:"year",method:"FullYear",ambiguous:true,multiplier:function(d){var adjust=d?d.isLeapYear()?1:0:.25;return(365+adjust)*24*60*60*1e3}},{unit:"month",method:"Month",ambiguous:true,multiplier:function(d,ms){var days=30.4375,inMonth;if(d){inMonth=d.daysInMonth();if(ms<=inMonth.days()){days=inMonth}}return days*24*60*60*1e3},error:.919},{unit:"week",method:"ISOWeek",multiplier:function(){return 7*24*60*60*1e3}},{unit:"day",method:"Date",ambiguous:true,multiplier:function(){return 24*60*60*1e3}},{unit:"hour",method:"Hours",multiplier:function(){return 60*60*1e3}},{unit:"minute",method:"Minutes",multiplier:function(){return 60*1e3}},{unit:"second",method:"Seconds",multiplier:function(){return 1e3}},{unit:"millisecond",method:"Milliseconds",multiplier:function(){return 1}}];var Localizations={};function Localization(l){simpleMerge(this,l);this.compiledFormats=CoreDateFormats.concat()}Localization.prototype={getMonth:function(n){if(isNumber(n)){return n-1}else{return this["months"].indexOf(n)%12}},getWeekday:function(n){return this["weekdays"].indexOf(n)%7},getNumber:function(n){var i;if(isNumber(n)){return n}else if(n&&(i=this["numbers"].indexOf(n))!==-1){return(i+1)%10}else{return 1}},getNumericDate:function(n){var self=this;return n.replace(regexp(this["num"],"g"),function(d){var num=self.getNumber(d);return num||""})},getEnglishUnit:function(n){return English["units"][this["units"].indexOf(n)%8]},getRelativeFormat:function(adu){return this.convertAdjustedToFormat(adu,adu[2]>0?"future":"past")},getDuration:function(ms){return this.convertAdjustedToFormat(getAdjustedUnit(ms),"duration")},hasVariant:function(code){code=code||this.code;return code==="en"||code==="en-US"?true:this["variant"]},matchAM:function(str){return str===this["ampm"][0]},matchPM:function(str){return str&&str===this["ampm"][1]},convertAdjustedToFormat:function(adu,mode){var sign,unit,mult,num=adu[0],u=adu[1],ms=adu[2],format=this[mode]||this["relative"];if(isFunction(format)){return format.call(this,num,u,ms,mode)}mult=this["plural"]&&num>1?1:0;unit=this["units"][mult*8+u]||this["units"][u];if(this["capitalizeUnit"])unit=simpleCapitalize(unit);sign=this["modifiers"].filter(function(m){return m.name=="sign"&&m.value==(ms>0?1:-1)})[0];return format.replace(/\{(.*?)\}/g,function(full,match){switch(match){case"num":return num;case"unit":return unit;case"sign":return sign.src}})},getFormats:function(){return this.cachedFormat?[this.cachedFormat].concat(this.compiledFormats):this.compiledFormats},addFormat:function(src,allowsTime,match,variant,iso){var to=match||[],loc=this,time,timeMarkers,lastIsNumeral;src=src.replace(/\s+/g,"[-,. ]*");src=src.replace(/\{([^,]+?)\}/g,function(all,k){var value,arr,result,opt=k.match(/\?$/),nc=k.match(/^(\d+)\??$/),slice=k.match(/(\d)(?:-(\d))?/),key=k.replace(/[^a-z]+$/,"");if(nc){value=loc["tokens"][nc[1]]}else if(loc[key]){value=loc[key]}else if(loc[key+"s"]){value=loc[key+"s"];if(slice){arr=[];value.forEach(function(m,i){var mod=i%(loc["units"]?8:value.length);if(mod>=slice[1]&&mod<=(slice[2]||slice[1])){arr.push(m)}});value=arr}value=arrayToAlternates(value)}if(nc){result="(?:"+value+")"}else{if(!match){to.push(key)}result="("+value+")"}if(opt){result+="?"}return result});if(allowsTime){time=prepareTime(RequiredTime,loc,iso);timeMarkers=["t","[\\s\\u3000]"].concat(loc["timeMarker"]);lastIsNumeral=src.match(/\\d\{\d,\d\}\)+\??$/);addDateInputFormat(loc,"(?:"+time+")[,\\s\\u3000]+?"+src,TimeFormat.concat(to),variant);addDateInputFormat(loc,src+"(?:[,\\s]*(?:"+timeMarkers.join("|")+(lastIsNumeral?"+":"*")+")"+time+")?",to.concat(TimeFormat),variant)}else{addDateInputFormat(loc,src,to,variant)}}};function getLocalization(localeCode,fallback){var loc;if(!isString(localeCode))localeCode="";loc=Localizations[localeCode]||Localizations[localeCode.slice(0,2)];if(fallback===false&&!loc){throw new Error("Invalid locale.")}return loc||CurrentLocalization}function setLocalization(localeCode,set){var loc,canAbbreviate;function initializeField(name){var val=loc[name];if(isString(val)){loc[name]=val.split(",")}else if(!val){loc[name]=[]}}function eachAlternate(str,fn){str=str.split("+").map(function(split){return split.replace(/(.+):(.+)$/,function(full,base,suffixes){return suffixes.split("|").map(function(suffix){return base+suffix}).join("|")})}).join("|");return str.split("|").forEach(fn)}function setArray(name,abbreviate,multiple){var arr=[];loc[name].forEach(function(full,i){if(abbreviate){full+="+"+full.slice(0,3)}eachAlternate(full,function(day,j){arr[j*multiple+i]=day.toLowerCase()})});loc[name]=arr}function getDigit(start,stop,allowNumbers){var str="\\d{"+start+","+stop+"}";if(allowNumbers)str+="|(?:"+arrayToAlternates(loc["numbers"])+")+";return str}function getNum(){var arr=["\\d+"].concat(loc["articles"]);if(loc["numbers"])arr=arr.concat(loc["numbers"]);return arrayToAlternates(arr)}function setDefault(name,value){loc[name]=loc[name]||value}function setModifiers(){var arr=[];loc.modifiersByName={};loc["modifiers"].push({name:"day",src:"yesterday",value:-1});loc["modifiers"].push({name:"day",src:"today",value:0});loc["modifiers"].push({name:"day",src:"tonight",value:0});loc["modifiers"].push({name:"day",src:"tomorrow",value:1});loc["modifiers"].forEach(function(modifier){var name=modifier.name;eachAlternate(modifier.src,function(t){var locEntry=loc[name];loc.modifiersByName[t]=modifier;arr.push({name:name,src:t,value:modifier.value});loc[name]=locEntry?locEntry+"|"+t:t})});loc["day"]+="|"+arrayToAlternates(loc["weekdays"]);loc["modifiers"]=arr}loc=new Localization(set);initializeField("modifiers");"months,weekdays,units,numbers,articles,tokens,timeMarker,ampm,timeSuffixes,dateParse,timeParse".split(",").forEach(initializeField);canAbbreviate=!loc["monthSuffix"];setArray("months",canAbbreviate,12);setArray("weekdays",canAbbreviate,7);setArray("units",false,8);setArray("numbers",false,10);setDefault("code",localeCode);setDefault("date",getDigit(1,2,loc["digitDate"]));setDefault("year","'\\d{2}|"+getDigit(4,4));setDefault("num",getNum());setModifiers();if(loc["monthSuffix"]){loc["month"]=getDigit(1,2);loc["months"]=getRange(1,12).map(function(n){return n+loc["monthSuffix"]})}loc["full_month"]=getDigit(1,2)+"|"+arrayToAlternates(loc["months"]);if(loc["timeSuffixes"].length>0){loc.addFormat(prepareTime(RequiredTime,loc),false,TimeFormat)}loc.addFormat("{day}",true);loc.addFormat("{month}"+(loc["monthSuffix"]||""));loc.addFormat("{year}"+(loc["yearSuffix"]||""));loc["timeParse"].forEach(function(src){loc.addFormat(src,true)});loc["dateParse"].forEach(function(src){loc.addFormat(src)});return Localizations[localeCode]=loc}function addDateInputFormat(locale,format,match,variant){locale.compiledFormats.unshift({variant:variant,locale:locale,reg:regexp("^"+format+"$","i"),to:match})}function simpleCapitalize(str){return str.slice(0,1).toUpperCase()+str.slice(1)}function arrayToAlternates(arr){return arr.filter(function(el){return!!el}).join("|")}function collectDateArguments(args,allowDuration){var obj,arr;if(isObject(args[0])){return args}else if(isNumber(args[0])&&!isNumber(args[1])){return[args[0]]}else if(isString(args[0])&&allowDuration){return[getDateParamsFromString(args[0]),args[1]]}obj={};DateArgumentUnits.forEach(function(u,i){obj[u.unit]=args[i]});return[obj]}function getDateParamsFromString(str,num){var params={};match=str.match(/^(\d+)?\s?(\w+?)s?$/i);if(match){if(isUndefined(num)){num=parseInt(match[1])||1}params[match[2].toLowerCase()]=num}return params}function getFormatMatch(match,arr){var obj={},value,num;arr.forEach(function(key,i){value=match[i+1];if(isUndefined(value)||value==="")return;if(key==="year"){obj.yearAsString=value.replace(/'/,"")}num=parseFloat(value.replace(/'/,"").replace(/,/,"."));obj[key]=!isNaN(num)?num:value.toLowerCase()});return obj}function cleanDateInput(str){str=str.trim().replace(/^just (?=now)|\.+$/i,"");return convertAsianDigits(str)}function convertAsianDigits(str){return str.replace(AsianDigitReg,function(full,disallowed,match){var sum=0,place=1,lastWasHolder,lastHolder;if(disallowed)return full;match.split("").reverse().forEach(function(letter){var value=AsianDigitMap[letter],holder=value>9;if(holder){if(lastWasHolder)sum+=place;place*=value/(lastHolder||1);lastHolder=value}else{if(lastWasHolder===false){place*=10}sum+=place*value}lastWasHolder=holder});if(lastWasHolder)sum+=place;return sum})}function getExtendedDate(f,localeCode,prefer,forceUTC){var d=new date,relative=false,staticTime=false,baseLocalization,loc,format,set,unit,weekday,num,tmp,after;d.utc(forceUTC);if(isDate(f)){d.utc(f.isUTC()).setTime(f.getTime())}else if(isNumber(f)){d.setTime(f)}else if(isObject(f)){d.set(f,true);set=f}else if(isString(f)){baseLocalization=getLocalization(localeCode);f=cleanDateInput(f);if(baseLocalization){iterateOverObject(baseLocalization.getFormats(),function(i,dif){var match=f.match(dif.reg);if(match){format=dif;loc=format.locale;set=getFormatMatch(match,format.to,loc);if(set["utc"]){d.utc()}loc.cachedFormat=format;if(set.timestamp){set=set.timestamp;return false}if(format.variant&&!isString(set["month"])&&(isString(set["date"])||baseLocalization.hasVariant(localeCode))){tmp=set["month"];set["month"]=set["date"];set["date"]=tmp}if(set["year"]&&set.yearAsString.length===2){set["year"]=getYearFromAbbreviation(set["year"])}if(set["month"]){set["month"]=loc.getMonth(set["month"]);if(set["shift"]&&!set["unit"])set["unit"]=loc["units"][7]}if(set["weekday"]&&set["date"]){delete set["weekday"]}else if(set["weekday"]){set["weekday"]=loc.getWeekday(set["weekday"]);if(set["shift"]&&!set["unit"])set["unit"]=loc["units"][5]}if(set["day"]&&(tmp=loc.modifiersByName[set["day"]])){set["day"]=tmp.value;d.reset();relative=true}else if(set["day"]&&(weekday=loc.getWeekday(set["day"]))>-1){delete set["day"];if(set["num"]&&set["month"]){after=function(){var w=d.getWeekday();d.setWeekday(7*(set["num"]-1)+(w>weekday?weekday+7:weekday))};set["day"]=1}else{set["weekday"]=weekday}}if(set["date"]&&!isNumber(set["date"])){set["date"]=loc.getNumericDate(set["date"])}if(loc.matchPM(set["ampm"])&&set["hour"]<12){set["hour"]+=12}else if(loc.matchAM(set["ampm"])&&set["hour"]===12){set["hour"]=0}if("offset_hours"in set||"offset_minutes"in set){d.utc();set["offset_minutes"]=set["offset_minutes"]||0;set["offset_minutes"]+=set["offset_hours"]*60;if(set["offset_sign"]==="-"){set["offset_minutes"]*=-1}set["minute"]-=set["offset_minutes"]}if(set["unit"]){relative=true;num=loc.getNumber(set["num"]);unit=loc.getEnglishUnit(set["unit"]);if(set["shift"]||set["edge"]){num*=(tmp=loc.modifiersByName[set["shift"]])?tmp.value:0;if(unit==="month"&&isDefined(set["date"])){d.set({day:set["date"]},true);delete set["date"]}if(unit==="year"&&isDefined(set["month"])){d.set({month:set["month"],day:set["date"]},true);delete set["month"];delete set["date"]}}if(set["sign"]&&(tmp=loc.modifiersByName[set["sign"]])){num*=tmp.value}if(isDefined(set["weekday"])){d.set({weekday:set["weekday"]},true);delete set["weekday"]}set[unit]=(set[unit]||0)+num;if((unit==="day"||unit==="week"||unit==="month"||unit==="year")&&isDefined(set["hour"])){staticTime=true}}else if(set["edge"]&&set["hour"]){staticTime=true}if(set["year_sign"]==="-"){set["year"]*=-1}DateUnitsReversed.slice(1,4).forEach(function(u,i){var value=set[u.unit],fraction=value%1;if(fraction){set[DateUnitsReversed[i].unit]=round(fraction*(u.unit==="second"?1e3:60));set[u.unit]=floor(value)}});return false}})}if(!format){if(f!=="now"){d=new date(f)}if(forceUTC){d.addMinutes(-d.getTimezoneOffset())}}else if(relative){if(staticTime){d.reset()}d.advance(set)}else{if(d._utc){d.reset()}updateDate(d,set,true,false,prefer)}if(set&&set["edge"]){tmp=loc.modifiersByName[set["edge"]];iterateOverObject(DateUnitsReversed.slice(4),function(i,u){if(isDefined(set[u.unit])){unit=u.unit;return false}});if(unit==="year")set.specificity="month";else if(unit==="month"||unit==="week")set.specificity="day";d[(tmp.value<0?"endOf":"beginningOf")+simpleCapitalize(unit)]();if(tmp.value===-2)d.reset()}if(staticTime){d.reset();if(isDefined(set["hour"])){d.setHours(set["hour"])}if(isDefined(set["minute"])){d.setMinutes(set["minute"])}if(isDefined(set["second"])){d.setSeconds(set["second"])}}if(d&&d.getTime()&&isDefined(set)){var currentWeekday=(new date).getWeekday();var weekday=d.getWeekday();if(isDefined(set["week"])||isDefined(set["weekday"])){if(isDefined(set["shift"])){if((set["shift"]==="this"||set["shift"]==="last")&&set["unit"]==="week"){if(currentWeekday>weekday){d.addWeeks(1)}}}else{if(currentWeekday>weekday){d.addWeeks(1)}}}}if(after){after()}d.utc(false)}return{date:d,set:set}}function getYearFromAbbreviation(year){return round(callDateGet(new date,"FullYear")/100)*100-round(year/100)*100+year}function getShortHour(d){var hours=callDateGet(d,"Hours");return hours===0?12:hours-floor(hours/13)*12}function getWeekNumber(date){date=date.clone();var dow=callDateGet(date,"Day")||7;date.addDays(4-dow).reset();return 1+floor(date.daysSince(date.clone().beginningOfYear())/7)}function getAdjustedUnit(ms){var next,ams=math.abs(ms),value=ams,unit=0;DateUnitsReversed.slice(1).forEach(function(u,i){next=floor(round(ams/u.multiplier()*10)/10);if(next>=1){value=next;unit=i+1}});return[value,unit,ms]}function getAdjustedUnitWithMonthFallback(date){var adu=getAdjustedUnit(date.millisecondsFromNow());if(adu[1]===6){adu[0]=math.abs(date.monthsFromNow())}return adu}function formatDate(date,format,relative,localeCode){var adu,loc=getLocalization(localeCode),caps=regexp(/^[A-Z]/),value,shortcut;if(!date.isValid()){return"Invalid Date"}else if(Date[format]){format=Date[format]}else if(isFunction(format)){adu=getAdjustedUnitWithMonthFallback(date);format=format.apply(date,adu.concat(loc))}if(!format&&relative){adu=adu||getAdjustedUnitWithMonthFallback(date);if(adu[1]===0){adu[1]=1;adu[0]=1}return loc.getRelativeFormat(adu)}format=format||"long";format=loc[format]||format;DateOutputFormats.forEach(function(dof){format=format.replace(regexp("\\{("+dof.token+")(\\d)?\\}",dof.word?"i":""),function(m,t,d){var val=dof.format(date,loc,d||1,t),l=t.length,one=t.match(/^(.)\1+$/);if(dof.word){if(l===3)val=val.slice(0,3);if(one||t.match(caps))val=simpleCapitalize(val)}else if(one&&!dof.text){val=(isNumber(val)?padNumber(val,l):val.toString()).slice(-l)}return val})});return format}function compareDate(d,find,buffer,forceUTC){var p,t,min,max,minOffset,maxOffset,override,capitalized,accuracy=0,loBuffer=0,hiBuffer=0;p=getExtendedDate(find,null,null,forceUTC);if(buffer>0){loBuffer=hiBuffer=buffer;override=true}if(!p.date.isValid())return false;if(p.set&&p.set.specificity){DateUnits.forEach(function(u,i){if(u.unit===p.set.specificity){accuracy=u.multiplier(p.date,d-p.date)-1}});capitalized=simpleCapitalize(p.set.specificity);if(p.set["edge"]||p.set["shift"]){p.date["beginningOf"+capitalized]()}if(p.set.specificity==="month"){max=p.date.clone()["endOf"+capitalized]().getTime()}if(!override&&p.set["sign"]&&p.set.specificity!="millisecond"){loBuffer=50;hiBuffer=-50}}t=d.getTime();min=p.date.getTime();max=max||min+accuracy;max=compensateForTimezoneTraversal(d,min,max);return t>=min-loBuffer&&t<=max+hiBuffer}function compensateForTimezoneTraversal(d,min,max){var dMin,dMax,minOffset,maxOffset;dMin=new Date(min);dMax=new Date(max).utc(d.isUTC());if(callDateGet(dMax,"Hours")!==23){minOffset=dMin.getTimezoneOffset();maxOffset=dMax.getTimezoneOffset();if(minOffset!==maxOffset){max+=(maxOffset-minOffset).minutes()}}return max}function updateDate(d,params,reset,advance,prefer){var weekday,specificityIndex;function getParam(key){return isDefined(params[key])?params[key]:params[key+"s"]}function paramExists(key){return isDefined(getParam(key))}function uniqueParamExists(key,isDay){return paramExists(key)||isDay&&paramExists("weekday")}function canDisambiguate(){var now=new date;return prefer===-1&&d>now||prefer===1&&d<now}if(isNumber(params)&&advance){params={milliseconds:params}}else if(isNumber(params)){d.setTime(params);return d}if(isDefined(params["date"])){params["day"]=params["date"]}iterateOverObject(DateUnitsReversed,function(i,u){var isDay=u.unit==="day";if(uniqueParamExists(u.unit,isDay)){params.specificity=u.unit;specificityIndex=+i;return false}else if(reset&&u.unit!=="week"&&(!isDay||!paramExists("week"))){callDateSet(d,u.method,isDay?1:0)}});DateUnits.forEach(function(u,i){var unit=u.unit,method=u.method,higherUnit=DateUnits[i-1],value;value=getParam(unit);if(isUndefined(value))return;if(advance){if(unit==="week"){value=value*7;method="Date"}value=value*advance+callDateGet(d,method)}else if(unit==="month"&&paramExists("day")){callDateSet(d,"Date",15)}callDateSet(d,method,value);if(advance&&unit==="month"){checkMonthTraversal(d,value)}});if(!advance&&!paramExists("day")&&paramExists("weekday")){var weekday=getParam("weekday"),isAhead,futurePreferred;d.setWeekday(weekday)}if(canDisambiguate()){iterateOverObject(DateUnitsReversed.slice(specificityIndex+1),function(i,u){var ambiguous=u.ambiguous||u.unit==="week"&&paramExists("weekday");if(ambiguous&&!uniqueParamExists(u.unit,u.unit==="day")){d[u.addMethod](prefer);return false}})}return d}function callDateGet(d,method){return d["get"+(d._utc?"UTC":"")+method]()}function callDateSet(d,method,value){return d["set"+(d._utc&&method!="ISOWeek"?"UTC":"")+method](value)}function prepareTime(format,loc,iso){var timeSuffixMapping={h:0,m:1,s:2},add;loc=loc||English;return format.replace(/{([a-z])}/g,function(full,token){var separators=[],isHours=token==="h",tokenIsRequired=isHours&&!iso;if(token==="t"){return loc["ampm"].join("|")}else{if(isHours){separators.push(":")}if(add=loc["timeSuffixes"][timeSuffixMapping[token]]){separators.push(add+"\\s*")}return separators.length===0?"":"(?:"+separators.join("|")+")"+(tokenIsRequired?"":"?")}})}function checkMonthTraversal(date,targetMonth){if(targetMonth<0){targetMonth=targetMonth%12+12}if(targetMonth%12!=callDateGet(date,"Month")){callDateSet(date,"Date",0)}}function createDate(args,prefer,forceUTC){var f,localeCode;if(isNumber(args[1])){f=collectDateArguments(args)[0]}else{f=args[0];localeCode=args[1]}return getExtendedDate(f,localeCode,prefer,forceUTC).date}function buildDateUnits(){DateUnitsReversed=DateUnits.concat().reverse();DateArgumentUnits=DateUnits.concat();DateArgumentUnits.splice(2,1)}function buildDateMethods(){extendSimilar(date,true,false,DateUnits,function(methods,u,i){var unit=u.unit,caps=simpleCapitalize(unit),multiplier=u.multiplier(),since,until;u.addMethod="add"+caps+"s";function applyErrorMargin(ms){var num=ms/multiplier,fraction=num%1,error=u.error||.999;if(fraction&&math.abs(fraction%1)>error){num=round(num)}return parseInt(num)}since=function(f,localeCode){return applyErrorMargin(this.getTime()-date.create(f,localeCode).getTime())};until=function(f,localeCode){return applyErrorMargin(date.create(f,localeCode).getTime()-this.getTime())};methods[unit+"sAgo"]=until;methods[unit+"sUntil"]=until;methods[unit+"sSince"]=since;methods[unit+"sFromNow"]=since;methods[u.addMethod]=function(num,reset){var set={};set[unit]=num;return this.advance(set,reset)};buildNumberToDateAlias(u,multiplier);if(i<3){["Last","This","Next"].forEach(function(shift){methods["is"+shift+caps]=function(){return this.is(shift+" "+unit)}})}if(i<4){methods["beginningOf"+caps]=function(){var set={};switch(unit){case"year":set["year"]=callDateGet(this,"FullYear");break;case"month":set["month"]=callDateGet(this,"Month");break;case"day":set["day"]=callDateGet(this,"Date");break;case"week":set["weekday"]=0;break}return this.set(set,true)};methods["endOf"+caps]=function(){var set={hours:23,minutes:59,seconds:59,milliseconds:999};switch(unit){case"year":set["month"]=11;set["day"]=31;break;case"month":set["day"]=this.daysInMonth();break;case"week":set["weekday"]=6;break}return this.set(set,true)}}})}function buildCoreInputFormats(){English.addFormat("([+-])?(\\d{4,4})[-.]?{full_month}[-.]?(\\d{1,2})?",true,["year_sign","year","month","date"],false,true);English.addFormat("(\\d{1,2})[-.\\/]{full_month}(?:[-.\\/](\\d{2,4}))?",true,["date","month","year"],true);English.addFormat("{full_month}[-.](\\d{4,4})",false,["month","year"]);English.addFormat("\\/Date\\((\\d+(?:\\+\\d{4,4})?)\\)\\/",false,["timestamp"]);English.addFormat(prepareTime(RequiredTime,English),false,TimeFormat);CoreDateFormats=English.compiledFormats.slice(0,7).reverse();English.compiledFormats=English.compiledFormats.slice(7).concat(CoreDateFormats)}function buildDateOutputShortcuts(){extendSimilar(date,true,false,"short,long,full",function(methods,name){methods[name]=function(localeCode){return formatDate(this,name,false,localeCode)}})}function buildAsianDigits(){KanjiDigits.split("").forEach(function(digit,value){var holder;if(value>9){value=math.pow(10,value-9)}AsianDigitMap[digit]=value});FullWidthDigits.split("").forEach(function(digit,value){AsianDigitMap[digit]=value});AsianDigitReg=regexp("([期週周])?(["+KanjiDigits+FullWidthDigits+"]+)(?!昨)","g")}function buildRelativeAliases(){var special="today,yesterday,tomorrow,weekday,weekend,future,past".split(",");var weekdays=English["weekdays"].slice(0,7);var months=English["months"].slice(0,12);extendSimilar(date,true,false,special.concat(weekdays).concat(months),function(methods,name){methods["is"+simpleCapitalize(name)]=function(utc){return this.is(name,0,utc)}})}function buildUTCAliases(){date.extend({utc:{create:function(){return createDate(arguments,0,true)},past:function(){return createDate(arguments,-1,true)},future:function(){return createDate(arguments,1,true)}}},false,false)}function setDateProperties(){date.extend({RFC1123:"{Dow}, {dd} {Mon} {yyyy} {HH}:{mm}:{ss} {tz}",RFC1036:"{Weekday}, {dd}-{Mon}-{yy} {HH}:{mm}:{ss} {tz}",ISO8601_DATE:"{yyyy}-{MM}-{dd}",ISO8601_DATETIME:"{yyyy}-{MM}-{dd}T{HH}:{mm}:{ss}.{fff}{isotz}"},false,false)}date.extend({create:function(){return createDate(arguments)},past:function(){return createDate(arguments,-1)},future:function(){return createDate(arguments,1)},addLocale:function(localeCode,set){return setLocalization(localeCode,set)},setLocale:function(localeCode,set){var loc=getLocalization(localeCode,false);CurrentLocalization=loc;if(localeCode&&localeCode!=loc["code"]){loc["code"]=localeCode}return loc},getLocale:function(localeCode){return!localeCode?CurrentLocalization:getLocalization(localeCode,false)},addFormat:function(format,match,localeCode){addDateInputFormat(getLocalization(localeCode),format,match)},addOutputFormat:function(format){DateOutputFormats.push(format)}},false,false);date.extend({set:function(){var args=collectDateArguments(arguments);return updateDate(this,args[0],args[1])},setWeekday:function(dow){if(isUndefined(dow))return;return callDateSet(this,"Date",callDateGet(this,"Date")+dow-callDateGet(this,"Day"))},setISOWeek:function(week){var weekday=callDateGet(this,"Day")||7;if(isUndefined(week))return;this.set({month:0,date:4});this.set({weekday:1});if(week>1){this.addWeeks(week-1)}if(weekday!==1){this.advance({days:weekday-1})}return this.getTime()},getISOWeek:function(){return getWeekNumber(this)},getUTCOffset:function(iso){var offset=this._utc?0:this.getTimezoneOffset();var colon=iso===true?":":"";if(!offset&&iso)return"Z";return padNumber(floor(-offset/60),2,true)+colon+padNumber(math.abs(offset%60),2)},utc:function(set){defineProperty(this,"_utc",set===true||arguments.length===0);return this},isUTC:function(){return!!this._utc||this.getTimezoneOffset()===0},advance:function(){var args=collectDateArguments(arguments,true);return updateDate(this,args[0],args[1],1)},rewind:function(){var args=collectDateArguments(arguments,true);return updateDate(this,args[0],args[1],-1)},isValid:function(){return!isNaN(this.getTime())},isAfter:function(d,margin,utc){return this.getTime()>date.create(d).getTime()-(margin||0)},isBefore:function(d,margin){return this.getTime()<date.create(d).getTime()+(margin||0)},isBetween:function(d1,d2,margin){var t=this.getTime();var t1=date.create(d1).getTime();var t2=date.create(d2).getTime();var lo=math.min(t1,t2);var hi=math.max(t1,t2);margin=margin||0;return lo-margin<t&&hi+margin>t},isLeapYear:function(){var year=callDateGet(this,"FullYear");return year%4===0&&year%100!==0||year%400===0},daysInMonth:function(){return 32-callDateGet(new date(callDateGet(this,"FullYear"),callDateGet(this,"Month"),32),"Date")},format:function(f,localeCode){return formatDate(this,f,false,localeCode)},relative:function(f,localeCode){if(isString(f)){localeCode=f;f=null}return formatDate(this,f,true,localeCode)},is:function(d,margin,utc){var tmp,comp;if(!this.isValid())return;if(isString(d)){d=d.trim().toLowerCase();comp=this.clone().utc(utc);switch(true){case d==="future":return this.getTime()>(new date).getTime();case d==="past":return this.getTime()<(new date).getTime();case d==="weekday":return callDateGet(comp,"Day")>0&&callDateGet(comp,"Day")<6;case d==="weekend":return callDateGet(comp,"Day")===0||callDateGet(comp,"Day")===6;case(tmp=English["weekdays"].indexOf(d)%7)>-1:return callDateGet(comp,"Day")===tmp;case(tmp=English["months"].indexOf(d)%12)>-1:return callDateGet(comp,"Month")===tmp}}return compareDate(this,d,margin,utc)},reset:function(unit){var params={},recognized;unit=unit||"hours";if(unit==="date")unit="days";recognized=DateUnits.some(function(u){return unit===u.unit||unit===u.unit+"s"});params[unit]=unit.match(/^days?/)?1:0;return recognized?this.set(params,true):this},clone:function(){var d=new date(this.getTime());d.utc(!!this._utc);return d}});date.extend({iso:function(){return this.toISOString()},getWeekday:date.prototype.getDay,getUTCWeekday:date.prototype.getUTCDay});function buildNumberToDateAlias(u,multiplier){var unit=u.unit,methods={};function base(){return round(this*multiplier)}function after(){return createDate(arguments)[u.addMethod](this)}function before(){return createDate(arguments)[u.addMethod](-this)}methods[unit]=base;methods[unit+"s"]=base;methods[unit+"Before"]=before;methods[unit+"sBefore"]=before;methods[unit+"Ago"]=before;methods[unit+"sAgo"]=before;methods[unit+"After"]=after;methods[unit+"sAfter"]=after;methods[unit+"FromNow"]=after;methods[unit+"sFromNow"]=after;number.extend(methods)}number.extend({duration:function(localeCode){return getLocalization(localeCode).getDuration(this)}});English=CurrentLocalization=date.addLocale("en",{plural:true,timeMarker:"at",ampm:"am,pm",months:"January,February,March,April,May,June,July,August,September,October,November,December",weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday",units:"millisecond:|s,second:|s,minute:|s,hour:|s,day:|s,week:|s,month:|s,year:|s",numbers:"one,two,three,four,five,six,seven,eight,nine,ten",articles:"a,an,the",tokens:"the,st|nd|rd|th,of","short":"{Month} {d}, {yyyy}","long":"{Month} {d}, {yyyy} {h}:{mm}{tt}",full:"{Weekday} {Month} {d}, {yyyy} {h}:{mm}:{ss}{tt}",past:"{num} {unit} {sign}",future:"{num} {unit} {sign}",duration:"{num} {unit}",modifiers:[{name:"sign",src:"ago|before",value:-1},{name:"sign",src:"from now|after|from|in|later",value:1},{name:"edge",src:"last day",value:-2},{name:"edge",src:"end",value:-1},{name:"edge",src:"first day|beginning",value:1},{name:"shift",src:"last",value:-1},{name:"shift",src:"the|this",value:0},{name:"shift",src:"next",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{month} {year}","{shift} {unit=5-7}","{0?} {date}{1}","{0?} {edge} of {shift?} {unit=4-7?}{month?}{year?}"],timeParse:["{0} {num}{1} {day} of {month} {year?}","{weekday?} {month} {date}{1?} {year?}","{date} {month} {year}","{date} {month}","{shift} {weekday}","{shift} week {weekday}","{weekday} {2?} {shift} week","{num} {unit=1-7} {sign} {day?}","in {num} {unit=1-7} {sign} {day?}","{0?} {edge} of {shift?} {unit?}{month?}{year?}","{num} {unit=1-7}","{0?} {date}{1} of {month}","{0?}{month?} {date?}{1?} of {shift} {unit=6-7}"]});
buildDateUnits();buildDateMethods();buildCoreInputFormats();buildDateOutputShortcuts();buildAsianDigits();buildRelativeAliases();buildUTCAliases();setDateProperties();Date.addLocale("da",{plural:true,months:"januar,februar,marts,april,maj,juni,juli,august,september,oktober,november,december",weekdays:"søndag|sondag,mandag,tirsdag,onsdag,torsdag,fredag,lørdag|lordag",units:"millisekund:|er,sekund:|er,minut:|ter,tim:e|er,dag:|e,ug:e|er|en,måned:|er|en+maaned:|er|en,år:||et+aar:||et",numbers:"en|et,to,tre,fire,fem,seks,syv,otte,ni,ti",tokens:"den,for",articles:"den","short":"d. {d}. {month} {yyyy}","long":"den {d}. {month} {yyyy} {H}:{mm}",full:"{Weekday} den {d}. {month} {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{sign} {num} {unit}",duration:"{num} {unit}",ampm:"am,pm",modifiers:[{name:"day",src:"forgårs|i forgårs|forgaars|i forgaars",value:-2},{name:"day",src:"i går|igår|i gaar|igaar",value:-1},{name:"day",src:"i dag|idag",value:0},{name:"day",src:"i morgen|imorgen",value:1},{name:"day",src:"over morgon|overmorgen|i over morgen|i overmorgen|iovermorgen",value:2},{name:"sign",src:"siden",value:-1},{name:"sign",src:"om",value:1},{name:"shift",src:"i sidste|sidste",value:-1},{name:"shift",src:"denne",value:0},{name:"shift",src:"næste|naeste",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{1?} {num} {unit} {sign}","{shift} {unit=5-7}"],timeParse:["{0?} {weekday?} {date?} {month} {year}","{date} {month}","{shift} {weekday}"]});Date.addLocale("de",{plural:true,capitalizeUnit:true,months:"Januar,Februar,März|Marz,April,Mai,Juni,Juli,August,September,Oktober,November,Dezember",weekdays:"Sonntag,Montag,Dienstag,Mittwoch,Donnerstag,Freitag,Samstag",units:"Millisekunde:|n,Sekunde:|n,Minute:|n,Stunde:|n,Tag:|en,Woche:|n,Monat:|en,Jahr:|en",numbers:"ein:|e|er|en|em,zwei,drei,vier,fuenf,sechs,sieben,acht,neun,zehn",tokens:"der","short":"{d}. {Month} {yyyy}","long":"{d}. {Month} {yyyy} {H}:{mm}",full:"{Weekday} {d}. {Month} {yyyy} {H}:{mm}:{ss}",past:"{sign} {num} {unit}",future:"{sign} {num} {unit}",duration:"{num} {unit}",timeMarker:"um",ampm:"am,pm",modifiers:[{name:"day",src:"vorgestern",value:-2},{name:"day",src:"gestern",value:-1},{name:"day",src:"heute",value:0},{name:"day",src:"morgen",value:1},{name:"day",src:"übermorgen|ubermorgen|uebermorgen",value:2},{name:"sign",src:"vor:|her",value:-1},{name:"sign",src:"in",value:1},{name:"shift",src:"letzte:|r|n|s",value:-1},{name:"shift",src:"nächste:|r|n|s+nachste:|r|n|s+naechste:|r|n|s+kommende:n|r",value:1}],dateParse:["{sign} {num} {unit}","{num} {unit} {sign}","{shift} {unit=5-7}"],timeParse:["{weekday?} {date?} {month} {year?}","{shift} {weekday}"]});Date.addLocale("es",{plural:true,months:"enero,febrero,marzo,abril,mayo,junio,julio,agosto,septiembre,octubre,noviembre,diciembre",weekdays:"domingo,lunes,martes,miércoles|miercoles,jueves,viernes,sábado|sabado",units:"milisegundo:|s,segundo:|s,minuto:|s,hora:|s,día|días|dia|dias,semana:|s,mes:|es,año|años|ano|anos",numbers:"uno,dos,tres,cuatro,cinco,seis,siete,ocho,nueve,diez",tokens:"el,de","short":"{d} {month} {yyyy}","long":"{d} {month} {yyyy} {H}:{mm}",full:"{Weekday} {d} {month} {yyyy} {H}:{mm}:{ss}",past:"{sign} {num} {unit}",future:"{num} {unit} {sign}",duration:"{num} {unit}",timeMarker:"a las",ampm:"am,pm",modifiers:[{name:"day",src:"anteayer",value:-2},{name:"day",src:"ayer",value:-1},{name:"day",src:"hoy",value:0},{name:"day",src:"mañana|manana",value:1},{name:"sign",src:"hace",value:-1},{name:"sign",src:"de ahora",value:1},{name:"shift",src:"pasad:o|a",value:-1},{name:"shift",src:"próximo|próxima|proximo|proxima",value:1}],dateParse:["{sign} {num} {unit}","{num} {unit} {sign}","{0?} {unit=5-7} {shift}","{0?} {shift} {unit=5-7}"],timeParse:["{shift} {weekday}","{weekday} {shift}","{date?} {1?} {month} {1?} {year?}"]});Date.addLocale("fi",{plural:true,timeMarker:"kello",ampm:",",months:"tammikuu,helmikuu,maaliskuu,huhtikuu,toukokuu,kesäkuu,heinäkuu,elokuu,syyskuu,lokakuu,marraskuu,joulukuu",weekdays:"sunnuntai,maanantai,tiistai,keskiviikko,torstai,perjantai,lauantai",units:"millisekun:ti|tia|teja|tina|nin,sekun:ti|tia|teja|tina|nin,minuut:ti|tia|teja|tina|in,tun:ti|tia|teja|tina|nin,päiv:ä|ää|iä|änä|än,viik:ko|koa|koja|on|kona,kuukau:si|sia|tta|den|tena,vuo:si|sia|tta|den|tena",numbers:"yksi|ensimmäinen,kaksi|toinen,kolm:e|as,neljä:s,vii:si|des,kuu:si|des,seitsemä:n|s,kahdeksa:n|s,yhdeksä:n|s,kymmene:n|s",articles:"",optionals:"","short":"{d}. {month}ta {yyyy}","long":"{d}. {month}ta {yyyy} kello {H}.{mm}",full:"{Weekday}na {d}. {month}ta {yyyy} kello {H}.{mm}",relative:function(num,unit,ms,format){var units=this["units"];function numberWithUnit(mult){return(num===1?"":num+" ")+units[8*mult+unit]}switch(format){case"duration":return numberWithUnit(0);case"past":return numberWithUnit(num>1?1:0)+" sitten";case"future":return numberWithUnit(4)+" päästä"}},modifiers:[{name:"day",src:"toissa päivänä|toissa päiväistä",value:-2},{name:"day",src:"eilen|eilistä",value:-1},{name:"day",src:"tänään",value:0},{name:"day",src:"huomenna|huomista",value:1},{name:"day",src:"ylihuomenna|ylihuomista",value:2},{name:"sign",src:"sitten|aiemmin",value:-1},{name:"sign",src:"päästä|kuluttua|myöhemmin",value:1},{name:"edge",src:"viimeinen|viimeisenä",value:-2},{name:"edge",src:"lopussa",value:-1},{name:"edge",src:"ensimmäinen|ensimmäisenä",value:1},{name:"shift",src:"edellinen|edellisenä|edeltävä|edeltävänä|viime|toissa",value:-1},{name:"shift",src:"tänä|tämän",value:0},{name:"shift",src:"seuraava|seuraavana|tuleva|tulevana|ensi",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{num} {unit=4-5} {sign} {day}","{month} {year}","{shift} {unit=5-7}"],timeParse:["{0} {num}{1} {day} of {month} {year?}","{weekday?} {month} {date}{1} {year?}","{date} {month} {year}","{shift} {weekday}","{shift} week {weekday}","{weekday} {2} {shift} week","{0} {date}{1} of {month}","{0}{month?} {date?}{1} of {shift} {unit=6-7}"]});Date.addLocale("fr",{plural:true,months:"janvier,février|fevrier,mars,avril,mai,juin,juillet,août,septembre,octobre,novembre,décembre|decembre",weekdays:"dimanche,lundi,mardi,mercredi,jeudi,vendredi,samedi",units:"milliseconde:|s,seconde:|s,minute:|s,heure:|s,jour:|s,semaine:|s,mois,an:|s|née|nee",numbers:"un:|e,deux,trois,quatre,cinq,six,sept,huit,neuf,dix",tokens:["l'|la|le"],"short":"{d} {month} {yyyy}","long":"{d} {month} {yyyy} {H}:{mm}",full:"{Weekday} {d} {month} {yyyy} {H}:{mm}:{ss}",past:"{sign} {num} {unit}",future:"{sign} {num} {unit}",duration:"{num} {unit}",timeMarker:"à",ampm:"am,pm",modifiers:[{name:"day",src:"hier",value:-1},{name:"day",src:"aujourd'hui",value:0},{name:"day",src:"demain",value:1},{name:"sign",src:"il y a",value:-1},{name:"sign",src:"dans|d'ici",value:1},{name:"shift",src:"derni:èr|er|ère|ere",value:-1},{name:"shift",src:"prochain:|e",value:1}],dateParse:["{sign} {num} {unit}","{sign} {num} {unit}","{0?} {unit=5-7} {shift}"],timeParse:["{weekday?} {0?} {date?} {month} {year?}","{0?} {weekday} {shift}"]});Date.addLocale("it",{plural:true,months:"Gennaio,Febbraio,Marzo,Aprile,Maggio,Giugno,Luglio,Agosto,Settembre,Ottobre,Novembre,Dicembre",weekdays:"Domenica,Luned:ì|i,Marted:ì|i,Mercoled:ì|i,Gioved:ì|i,Venerd:ì|i,Sabato",units:"millisecond:o|i,second:o|i,minut:o|i,or:a|e,giorn:o|i,settiman:a|e,mes:e|i,ann:o|i",numbers:"un:|a|o|',due,tre,quattro,cinque,sei,sette,otto,nove,dieci",tokens:"l'|la|il","short":"{d} {Month} {yyyy}","long":"{d} {Month} {yyyy} {H}:{mm}",full:"{Weekday} {d} {Month} {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{num} {unit} {sign}",duration:"{num} {unit}",timeMarker:"alle",ampm:"am,pm",modifiers:[{name:"day",src:"ieri",value:-1},{name:"day",src:"oggi",value:0},{name:"day",src:"domani",value:1},{name:"day",src:"dopodomani",value:2},{name:"sign",src:"fa",value:-1},{name:"sign",src:"da adesso",value:1},{name:"shift",src:"scors:o|a",value:-1},{name:"shift",src:"prossim:o|a",value:1}],dateParse:["{num} {unit} {sign}","{0?} {unit=5-7} {shift}","{0?} {shift} {unit=5-7}"],timeParse:["{weekday?} {date?} {month} {year?}","{shift} {weekday}"]});Date.addLocale("ja",{monthSuffix:"月",weekdays:"日曜日,月曜日,火曜日,水曜日,木曜日,金曜日,土曜日",units:"ミリ秒,秒,分,時間,日,週間|週,ヶ月|ヵ月|月,年","short":"{yyyy}年{M}月{d}日","long":"{yyyy}年{M}月{d}日 {H}時{mm}分",full:"{yyyy}年{M}月{d}日 {Weekday} {H}時{mm}分{ss}秒",past:"{num}{unit}{sign}",future:"{num}{unit}{sign}",duration:"{num}{unit}",timeSuffixes:"時,分,秒",ampm:"午前,午後",modifiers:[{name:"day",src:"一昨日",value:-2},{name:"day",src:"昨日",value:-1},{name:"day",src:"今日",value:0},{name:"day",src:"明日",value:1},{name:"day",src:"明後日",value:2},{name:"sign",src:"前",value:-1},{name:"sign",src:"後",value:1},{name:"shift",src:"去|先",value:-1},{name:"shift",src:"来",value:1}],dateParse:["{num}{unit}{sign}"],timeParse:["{shift}{unit=5-7}{weekday?}","{year}年{month?}月?{date?}日?","{month}月{date?}日?","{date}日"]});Date.addLocale("ko",{digitDate:true,monthSuffix:"월",weekdays:"일요일,월요일,화요일,수요일,목요일,금요일,토요일",units:"밀리초,초,분,시간,일,주,개월|달,년",numbers:"일|한,이,삼,사,오,육,칠,팔,구,십","short":"{yyyy}년{M}월{d}일","long":"{yyyy}년{M}월{d}일 {H}시{mm}분",full:"{yyyy}년{M}월{d}일 {Weekday} {H}시{mm}분{ss}초",past:"{num}{unit} {sign}",future:"{num}{unit} {sign}",duration:"{num}{unit}",timeSuffixes:"시,분,초",ampm:"오전,오후",modifiers:[{name:"day",src:"그저께",value:-2},{name:"day",src:"어제",value:-1},{name:"day",src:"오늘",value:0},{name:"day",src:"내일",value:1},{name:"day",src:"모레",value:2},{name:"sign",src:"전",value:-1},{name:"sign",src:"후",value:1},{name:"shift",src:"지난|작",value:-1},{name:"shift",src:"이번",value:0},{name:"shift",src:"다음|내",value:1}],dateParse:["{num}{unit} {sign}","{shift?} {unit=5-7}"],timeParse:["{shift} {unit=5?} {weekday}","{year}년{month?}월?{date?}일?","{month}월{date?}일?","{date}일"]});Date.addLocale("nl",{plural:true,months:"januari,februari,maart,april,mei,juni,juli,augustus,september,oktober,november,december",weekdays:"zondag|zo,maandag|ma,dinsdag|di,woensdag|woe|wo,donderdag|do,vrijdag|vrij|vr,zaterdag|za",units:"milliseconde:|n,seconde:|n,minu:ut|ten,uur,dag:|en,we:ek|ken,maand:|en,jaar",numbers:"een,twee,drie,vier,vijf,zes,zeven,acht,negen",tokens:"","short":"{d} {Month} {yyyy}","long":"{d} {Month} {yyyy} {H}:{mm}",full:"{Weekday} {d} {Month} {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{num} {unit} {sign}",duration:"{num} {unit}",timeMarker:"'s|om",modifiers:[{name:"day",src:"gisteren",value:-1},{name:"day",src:"vandaag",value:0},{name:"day",src:"morgen",value:1},{name:"day",src:"overmorgen",value:2},{name:"sign",src:"geleden",value:-1},{name:"sign",src:"vanaf nu",value:1},{name:"shift",src:"laatste|vorige|afgelopen",value:-1},{name:"shift",src:"volgend:|e",value:1}],dateParse:["{num} {unit} {sign}","{0?} {unit=5-7} {shift}","{0?} {shift} {unit=5-7}"],timeParse:["{weekday?} {date?} {month} {year?}","{shift} {weekday}"]});Date.addLocale("pl",{plural:true,months:"Styczeń|Stycznia,Luty|Lutego,Marzec|Marca,Kwiecień|Kwietnia,Maj|Maja,Czerwiec|Czerwca,Lipiec|Lipca,Sierpień|Sierpnia,Wrzesień|Września,Październik|Października,Listopad|Listopada,Grudzień|Grudnia",weekdays:"Niedziela|Niedzielę,Poniedziałek,Wtorek,Środ:a|ę,Czwartek,Piątek,Sobota|Sobotę",units:"milisekund:a|y|,sekund:a|y|,minut:a|y|,godzin:a|y|,dzień|dni,tydzień|tygodnie|tygodni,miesiące|miesiące|miesięcy,rok|lata|lat",numbers:"jeden|jedną,dwa|dwie,trzy,cztery,pięć,sześć,siedem,osiem,dziewięć,dziesięć",optionals:"w|we,roku","short":"{d} {Month} {yyyy}","long":"{d} {Month} {yyyy} {H}:{mm}",full:"{Weekday}, {d} {Month} {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{sign} {num} {unit}",duration:"{num} {unit}",timeMarker:"o",ampm:"am,pm",modifiers:[{name:"day",src:"przedwczoraj",value:-2},{name:"day",src:"wczoraj",value:-1},{name:"day",src:"dzisiaj|dziś",value:0},{name:"day",src:"jutro",value:1},{name:"day",src:"pojutrze",value:2},{name:"sign",src:"temu|przed",value:-1},{name:"sign",src:"za",value:1},{name:"shift",src:"zeszły|zeszła|ostatni|ostatnia",value:-1},{name:"shift",src:"następny|następna|następnego|przyszły|przyszła|przyszłego",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{month} {year}","{shift} {unit=5-7}","{0} {shift?} {weekday}"],timeParse:["{date} {month} {year?} {1}","{0} {shift?} {weekday}"]});Date.addLocale("pt",{plural:true,months:"janeiro,fevereiro,março,abril,maio,junho,julho,agosto,setembro,outubro,novembro,dezembro",weekdays:"domingo,segunda-feira,terça-feira,quarta-feira,quinta-feira,sexta-feira,sábado|sabado",units:"milisegundo:|s,segundo:|s,minuto:|s,hora:|s,dia:|s,semana:|s,mês|mêses|mes|meses,ano:|s",numbers:"um,dois,três|tres,quatro,cinco,seis,sete,oito,nove,dez,uma,duas",tokens:"a,de","short":"{d} de {month} de {yyyy}","long":"{d} de {month} de {yyyy} {H}:{mm}",full:"{Weekday}, {d} de {month} de {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{sign} {num} {unit}",duration:"{num} {unit}",timeMarker:"às",ampm:"am,pm",modifiers:[{name:"day",src:"anteontem",value:-2},{name:"day",src:"ontem",value:-1},{name:"day",src:"hoje",value:0},{name:"day",src:"amanh:ã|a",value:1},{name:"sign",src:"atrás|atras|há|ha",value:-1},{name:"sign",src:"daqui a",value:1},{name:"shift",src:"passad:o|a",value:-1},{name:"shift",src:"próximo|próxima|proximo|proxima",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{0?} {unit=5-7} {shift}","{0?} {shift} {unit=5-7}"],timeParse:["{date?} {1?} {month} {1?} {year?}","{0?} {shift} {weekday}"]});Date.addLocale("ru",{months:"Январ:я|ь,Феврал:я|ь,Март:а|,Апрел:я|ь,Ма:я|й,Июн:я|ь,Июл:я|ь,Август:а|,Сентябр:я|ь,Октябр:я|ь,Ноябр:я|ь,Декабр:я|ь",weekdays:"Воскресенье,Понедельник,Вторник,Среда,Четверг,Пятница,Суббота",units:"миллисекунд:а|у|ы|,секунд:а|у|ы|,минут:а|у|ы|,час:||а|ов,день|день|дня|дней,недел:я|ю|и|ь|е,месяц:||а|ев|е,год|год|года|лет|году",numbers:"од:ин|ну,дв:а|е,три,четыре,пять,шесть,семь,восемь,девять,десять",tokens:"в|на,года","short":"{d} {month} {yyyy} года","long":"{d} {month} {yyyy} года {H}:{mm}",full:"{Weekday} {d} {month} {yyyy} года {H}:{mm}:{ss}",relative:function(num,unit,ms,format){var numberWithUnit,last=num.toString().slice(-1);switch(true){case num>=11&&num<=15:mult=3;break;case last==1:mult=1;break;case last>=2&&last<=4:mult=2;break;default:mult=3}numberWithUnit=num+" "+this["units"][mult*8+unit];switch(format){case"duration":return numberWithUnit;case"past":return numberWithUnit+" назад";case"future":return"через "+numberWithUnit}},timeMarker:"в",ampm:" утра, вечера",modifiers:[{name:"day",src:"позавчера",value:-2},{name:"day",src:"вчера",value:-1},{name:"day",src:"сегодня",value:0},{name:"day",src:"завтра",value:1},{name:"day",src:"послезавтра",value:2},{name:"sign",src:"назад",value:-1},{name:"sign",src:"через",value:1},{name:"shift",src:"прошл:ый|ой|ом",value:-1},{name:"shift",src:"следующ:ий|ей|ем",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{month} {year}","{0?} {shift} {unit=5-7}"],timeParse:["{date} {month} {year?} {1?}","{0?} {shift} {weekday}"]});Date.addLocale("sv",{plural:true,months:"januari,februari,mars,april,maj,juni,juli,augusti,september,oktober,november,december",weekdays:"söndag|sondag,måndag:|en+mandag:|en,tisdag,onsdag,torsdag,fredag,lördag|lordag",units:"millisekund:|er,sekund:|er,minut:|er,timm:e|ar,dag:|ar,veck:a|or|an,månad:|er|en+manad:|er|en,år:||et+ar:||et",numbers:"en|ett,två|tva,tre,fyra,fem,sex,sju,åtta|atta,nio,tio",tokens:"den,för|for",articles:"den","short":"den {d} {month} {yyyy}","long":"den {d} {month} {yyyy} {H}:{mm}",full:"{Weekday} den {d} {month} {yyyy} {H}:{mm}:{ss}",past:"{num} {unit} {sign}",future:"{sign} {num} {unit}",duration:"{num} {unit}",ampm:"am,pm",modifiers:[{name:"day",src:"förrgår|i förrgår|iförrgår|forrgar|i forrgar|iforrgar",value:-2},{name:"day",src:"går|i går|igår|gar|i gar|igar",value:-1},{name:"day",src:"dag|i dag|idag",value:0},{name:"day",src:"morgon|i morgon|imorgon",value:1},{name:"day",src:"över morgon|övermorgon|i över morgon|i övermorgon|iövermorgon|over morgon|overmorgon|i over morgon|i overmorgon|iovermorgon",value:2},{name:"sign",src:"sedan|sen",value:-1},{name:"sign",src:"om",value:1},{name:"shift",src:"i förra|förra|i forra|forra",value:-1},{name:"shift",src:"denna",value:0},{name:"shift",src:"nästa|nasta",value:1}],dateParse:["{num} {unit} {sign}","{sign} {num} {unit}","{1?} {num} {unit} {sign}","{shift} {unit=5-7}"],timeParse:["{0?} {weekday?} {date?} {month} {year}","{date} {month}","{shift} {weekday}"]});Date.addLocale("zh-CN",{variant:true,monthSuffix:"月",weekdays:"星期日|周日,星期一|周一,星期二|周二,星期三|周三,星期四|周四,星期五|周五,星期六|周六",units:"毫秒,秒钟,分钟,小时,天,个星期|周,个月,年",tokens:"日|号","short":"{yyyy}年{M}月{d}日","long":"{yyyy}年{M}月{d}日 {tt}{h}:{mm}",full:"{yyyy}年{M}月{d}日 {weekday} {tt}{h}:{mm}:{ss}",past:"{num}{unit}{sign}",future:"{num}{unit}{sign}",duration:"{num}{unit}",timeSuffixes:"点|时,分钟?,秒",ampm:"上午,下午",modifiers:[{name:"day",src:"前天",value:-2},{name:"day",src:"昨天",value:-1},{name:"day",src:"今天",value:0},{name:"day",src:"明天",value:1},{name:"day",src:"后天",value:2},{name:"sign",src:"前",value:-1},{name:"sign",src:"后",value:1},{name:"shift",src:"上|去",value:-1},{name:"shift",src:"这",value:0},{name:"shift",src:"下|明",value:1}],dateParse:["{num}{unit}{sign}","{shift}{unit=5-7}"],timeParse:["{shift}{weekday}","{year}年{month?}月?{date?}{0?}","{month}月{date?}{0?}","{date}[日号]"]});Date.addLocale("zh-TW",{monthSuffix:"月",weekdays:"星期日|週日,星期一|週一,星期二|週二,星期三|週三,星期四|週四,星期五|週五,星期六|週六",units:"毫秒,秒鐘,分鐘,小時,天,個星期|週,個月,年",tokens:"日|號","short":"{yyyy}年{M}月{d}日","long":"{yyyy}年{M}月{d}日 {tt}{h}:{mm}",full:"{yyyy}年{M}月{d}日 {Weekday} {tt}{h}:{mm}:{ss}",past:"{num}{unit}{sign}",future:"{num}{unit}{sign}",duration:"{num}{unit}",timeSuffixes:"點|時,分鐘?,秒",ampm:"上午,下午",modifiers:[{name:"day",src:"前天",value:-2},{name:"day",src:"昨天",value:-1},{name:"day",src:"今天",value:0},{name:"day",src:"明天",value:1},{name:"day",src:"後天",value:2},{name:"sign",src:"前",value:-1},{name:"sign",src:"後",value:1},{name:"shift",src:"上|去",value:-1},{name:"shift",src:"這",value:0},{name:"shift",src:"下|明",value:1}],dateParse:["{num}{unit}{sign}","{shift}{unit=5-7}"],timeParse:["{shift}{weekday}","{year}年{month?}月?{date?}{0?}","{month}月{date?}{0?}","{date}[日號]"]});var DateRange=function(start,end){this.start=date.create(start);this.end=date.create(end)};DateRange.prototype.toString=function(){return this.isValid()?this.start.full()+".."+this.end.full():"Invalid DateRange"};extend(DateRange,true,false,{isValid:function(){return this.start<this.end},duration:function(){return this.isValid()?this.end.getTime()-this.start.getTime():NaN},contains:function(obj){var self=this,arr=obj.start&&obj.end?[obj.start,obj.end]:[obj];return arr.every(function(d){return d>=self.start&&d<=self.end})},every:function(increment,fn){var current=this.start.clone(),result=[],index=0,params,isDay;if(isString(increment)){current.advance(getDateParamsFromString(increment,0),true);params=getDateParamsFromString(increment);isDay=increment.toLowerCase()==="day"}else{params={milliseconds:increment}}while(current<=this.end){result.push(current);if(fn)fn(current,index);if(isDay&&callDateGet(current,"Hours")===23){current=current.clone();callDateSet(current,"Hours",48)}else{current=current.clone().advance(params,true)}index++}return result},union:function(range){return new DateRange(this.start<range.start?this.start:range.start,this.end>range.end?this.end:range.end)},intersect:function(range){return new DateRange(this.start>range.start?this.start:range.start,this.end<range.end?this.end:range.end)},clone:function(range){return new DateRange(this.start,this.end)}});extendSimilar(DateRange,true,false,"Millisecond,Second,Minute,Hour,Day,Week,Month,Year",function(methods,name){methods["each"+name]=function(fn){return this.every(name,fn)}});extend(date,false,false,{range:function(start,end){return new DateRange(start,end)}});function abbreviateNumber(num,roundTo,str,mid,limit,bytes){var fixed=num.toFixed(20),decimalPlace=fixed.search(/\./),numeralPlace=fixed.search(/[1-9]/),significant=decimalPlace-numeralPlace,unit,i,divisor;if(significant>0){significant-=1}i=math.max(math.min((significant/3).floor(),limit===false?str.length:limit),-mid);unit=str.charAt(i+mid-1);if(significant<-9){i=-3;roundTo=significant.abs()-9;unit=str.slice(0,1)}divisor=bytes?2..pow(10*i):10..pow(i*3);return(num/divisor).round(roundTo||0).format()+unit.trim()}extend(number,false,false,{random:function(n1,n2){var min,max;if(arguments.length==1)n2=n1,n1=0;min=math.min(n1||0,isUndefined(n2)?1:n2);max=math.max(n1||0,isUndefined(n2)?1:n2)+1;return floor(math.random()*(max-min)+min)}});extend(number,true,false,{log:function(base){return math.log(this)/(base?math.log(base):1)},abbr:function(precision){return abbreviateNumber(this,precision,"kmbt",0,4)},metric:function(precision,limit){return abbreviateNumber(this,precision,"nμm kMGTPE",4,isUndefined(limit)?1:limit)},bytes:function(precision,limit){return abbreviateNumber(this,precision,"kMGTPE",0,isUndefined(limit)?4:limit,true)+"B"},isInteger:function(){return this%1==0},isOdd:function(){return!isNaN(this)&&!this.isMultipleOf(2)},isEven:function(){return this.isMultipleOf(2)},isMultipleOf:function(num){return this%num===0},format:function(place,thousands,decimal){var i,str,split,integer,fraction,result="";if(isUndefined(thousands)){thousands=","}if(isUndefined(decimal)){decimal="."}str=(isNumber(place)?round(this,place||0).toFixed(math.max(place,0)):this.toString()).replace(/^-/,"");split=str.split(".");integer=split[0];fraction=split[1];for(i=integer.length;i>0;i-=3){if(i<integer.length){result=thousands+result}result=integer.slice(math.max(0,i-3),i)+result}if(fraction){result+=decimal+repeatString((place||0)-fraction.length,"0")+fraction}return(this<0?"-":"")+result},hex:function(pad){return this.pad(pad||1,false,16)},upto:function(num,fn,step){return getRange(this,num,fn,step||1)},downto:function(num,fn,step){return getRange(this,num,fn,-(step||1))},times:function(fn){if(fn){for(var i=0;i<this;i++){fn.call(this,i)}}return this.toNumber()},chr:function(){return string.fromCharCode(this)},pad:function(place,sign,base){return padNumber(this,place,sign,base)},ordinalize:function(){var suffix,num=this.abs(),last=parseInt(num.toString().slice(-2));return this+getOrdinalizedSuffix(last)},toNumber:function(){return parseFloat(this,10)}});function buildNumber(){extendSimilar(number,true,false,"round,floor,ceil",function(methods,name){methods[name]=function(precision){return round(this,precision,name)}});extendSimilar(number,true,false,"abs,pow,sin,asin,cos,acos,tan,atan,exp,pow,sqrt",function(methods,name){methods[name]=function(a,b){return math[name](this,a,b)}})}buildNumber();var ObjectTypeMethods="isObject,isNaN".split(",");var ObjectHashMethods="keys,values,select,reject,each,merge,clone,equal,watch,tap,has,toQueryString".split(",");function setParamsObject(obj,param,value,deep){var reg=/^(.+?)(\[.*\])$/,paramIsArray,match,allKeys,key;if(deep!==false&&(match=param.match(reg))){key=match[1];allKeys=match[2].replace(/^\[|\]$/g,"").split("][");allKeys.forEach(function(k){paramIsArray=!k||k.match(/^\d+$/);if(!key&&isArray(obj))key=obj.length;if(!hasOwnProperty(obj,key)){obj[key]=paramIsArray?[]:{}}obj=obj[key];key=k});if(!key&&paramIsArray)key=obj.length.toString();setParamsObject(obj,key,value)}else if(value.match(/^[+-]?\d+(\.\d+)?$/)){obj[param]=parseFloat(value)}else if(value==="true"){obj[param]=true}else if(value==="false"){obj[param]=false}else{obj[param]=value}}function objectToQueryString(base,obj){var tmp;if(isArray(obj)||isObject(obj)&&obj.toString===internalToString){tmp=[];iterateOverObject(obj,function(key,value){if(base){key=base+"["+key+"]"}tmp.push(objectToQueryString(key,value))});return tmp.join("&")}else{if(!base)return"";return sanitizeURIComponent(base)+"="+(isDate(obj)?obj.getTime():sanitizeURIComponent(obj))}}function sanitizeURIComponent(obj){return!obj&&obj!==false&&obj!==0?"":encodeURIComponent(obj).replace(/%20/g,"+")}function matchKey(key,match){if(isRegExp(match)){return match.test(key)}else if(isObjectPrimitive(match)){return hasOwnProperty(match,key)}else{return key===string(match)}}function selectFromObject(obj,args,select){var result={},match;iterateOverObject(obj,function(key,value){match=false;flattenedArgs(args,function(arg){if(matchKey(key,arg)){match=true}},1);if(match===select){result[key]=value}});return result}function buildTypeMethods(){extendSimilar(object,false,false,ClassNames,function(methods,name){var method="is"+name;ObjectTypeMethods.push(method);methods[method]=typeChecks[name]})}function buildObjectExtend(){extend(object,false,function(){return arguments.length===0},{extend:function(){var methods=ObjectTypeMethods.concat(ObjectHashMethods);if(typeof EnumerableMethods!=="undefined"){methods=methods.concat(EnumerableMethods)}buildObjectInstanceMethods(methods,object)}})}extend(object,false,true,{watch:function(obj,prop,fn){if(!definePropertySupport)return;var value=obj[prop];object.defineProperty(obj,prop,{enumerable:true,configurable:true,get:function(){return value},set:function(to){value=fn.call(obj,prop,value,to)}})}});extend(object,false,function(arg1,arg2){return isFunction(arg2)},{keys:function(obj,fn){var keys=object.keys(obj);keys.forEach(function(key){fn.call(obj,key,obj[key])});return keys}});extend(object,false,false,{isObject:function(obj){return isObject(obj)},isNaN:function(obj){return isNumber(obj)&&obj.valueOf()!==obj.valueOf()},equal:function(a,b){return isEqual(a,b)},extended:function(obj){return new Hash(obj)},merge:function(target,source,deep,resolve){var key,val;if(target&&typeof source!="string"){for(key in source){if(!hasOwnProperty(source,key)||!target)continue;val=source[key];if(isDefined(target[key])){if(resolve===false){continue}if(isFunction(resolve)){val=resolve.call(source,key,target[key],source[key])}}if(deep===true&&val&&isObjectPrimitive(val)){if(isDate(val)){val=new date(val.getTime())}else if(isRegExp(val)){val=new regexp(val.source,getRegExpFlags(val))}else{if(!target[key])target[key]=array.isArray(val)?[]:{};object.merge(target[key],source[key],deep,resolve);continue}}target[key]=val}}return target},values:function(obj,fn){var values=[];iterateOverObject(obj,function(k,v){values.push(v);if(fn)fn.call(obj,v)});return values},clone:function(obj,deep){var target;if(isDate(obj)&&obj.clone){return obj.clone()}else if(!isObjectPrimitive(obj)){return obj}else if(obj instanceof Hash){target=new Hash}else{target=new obj.constructor}return object.merge(target,obj,deep)},fromQueryString:function(str,deep){var result=object.extended(),split;str=str&&str.toString?str.toString():"";str.replace(/^.*?\?/,"").split("&").forEach(function(p){var split=p.split("=");if(split.length!==2)return;setParamsObject(result,split[0],decodeURIComponent(split[1]),deep)});return result},toQueryString:function(obj,namespace){return objectToQueryString(namespace,obj)},tap:function(obj,arg){var fn=arg;if(!isFunction(arg)){fn=function(){if(arg)obj[arg]()}}fn.call(obj,obj);return obj},has:function(obj,key){return hasOwnProperty(obj,key)},select:function(obj){return selectFromObject(obj,arguments,true)},reject:function(obj){return selectFromObject(obj,arguments,false)}});buildTypeMethods();buildObjectExtend();buildObjectInstanceMethods(ObjectHashMethods,Hash);extend(regexp,false,false,{escape:function(str){return escapeRegExp(str)}});extend(regexp,true,false,{getFlags:function(){return getRegExpFlags(this)},setFlags:function(flags){return regexp(this.source,flags)},addFlag:function(flag){return this.setFlags(getRegExpFlags(this,flag))},removeFlag:function(flag){return this.setFlags(getRegExpFlags(this).replace(flag,""))}});function getAcronym(word){var inflector=string.Inflector;var word=inflector&&inflector.acronyms[word];if(isString(word)){return word}}function padString(str,p,left,right){var padding=string(p);if(padding!=p){padding=""}if(!isNumber(left))left=1;if(!isNumber(right))right=1;return padding.repeat(left)+str+padding.repeat(right)}function chr(num){return string.fromCharCode(num)}var btoa,atob;function buildBase64(key){if(this.btoa){btoa=this.btoa;atob=this.atob;return}var base64reg=/[^A-Za-z0-9\+\/\=]/g;btoa=function(str){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;do{chr1=str.charCodeAt(i++);chr2=str.charCodeAt(i++);chr3=str.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+key.charAt(enc1)+key.charAt(enc2)+key.charAt(enc3)+key.charAt(enc4);chr1=chr2=chr3="";enc1=enc2=enc3=enc4=""}while(i<str.length);return output};atob=function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;if(input.match(base64reg)){throw new Error("String contains invalid base64 characters")}input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=key.indexOf(input.charAt(i++));enc2=key.indexOf(input.charAt(i++));enc3=key.indexOf(input.charAt(i++));enc4=key.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+chr(chr1);if(enc3!=64){output=output+chr(chr2)}if(enc4!=64){output=output+chr(chr3)}chr1=chr2=chr3="";enc1=enc2=enc3=enc4=""}while(i<input.length);return output}}extend(string,true,function(reg){return isRegExp(reg)||arguments.length>2},{startsWith:function(reg,pos,c){var str=this,source;if(pos)str=str.slice(pos);if(isUndefined(c))c=true;source=isRegExp(reg)?reg.source.replace("^",""):escapeRegExp(reg);return regexp("^"+source,c?"":"i").test(str)},endsWith:function(reg,pos,c){var str=this,source;if(isDefined(pos))str=str.slice(0,pos);if(isUndefined(c))c=true;source=isRegExp(reg)?reg.source.replace("$",""):escapeRegExp(reg);return regexp(source+"$",c?"":"i").test(str)}});extend(string,true,false,{escapeRegExp:function(){return escapeRegExp(this)},escapeURL:function(param){return param?encodeURIComponent(this):encodeURI(this)},unescapeURL:function(param){return param?decodeURI(this):decodeURIComponent(this)},escapeHTML:function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\//g,"&#x2f;")},unescapeHTML:function(){return this.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#x2f;/g,"/").replace(/&amp;/g,"&")},encodeBase64:function(){return btoa(this)},decodeBase64:function(){return atob(this)},each:function(search,fn){var match,i,len;if(isFunction(search)){fn=search;search=/[\s\S]/g}else if(!search){search=/[\s\S]/g}else if(isString(search)){search=regexp(escapeRegExp(search),"gi")}else if(isRegExp(search)){search=regexp(search.source,getRegExpFlags(search,"g"))}match=this.match(search)||[];if(fn){for(i=0,len=match.length;i<len;i++){match[i]=fn.call(this,match[i],i,match)||match[i]}}return match},shift:function(n){var result="";n=n||0;this.codes(function(c){result+=chr(c+n)});return result},codes:function(fn){var codes=[],i,len;for(i=0,len=this.length;i<len;i++){var code=this.charCodeAt(i);codes.push(code);if(fn)fn.call(this,code,i)}return codes},chars:function(fn){return this.each(fn)},words:function(fn){return this.trim().each(/\S+/g,fn)},lines:function(fn){return this.trim().each(/^.*$/gm,fn)},paragraphs:function(fn){var paragraphs=this.trim().split(/[\r\n]{2,}/);paragraphs=paragraphs.map(function(p){if(fn)var s=fn.call(p);return s?s:p});return paragraphs},isBlank:function(){return this.trim().length===0},has:function(find){return this.search(isRegExp(find)?find:escapeRegExp(find))!==-1},add:function(str,index){index=isUndefined(index)?this.length:index;return this.slice(0,index)+str+this.slice(index)},remove:function(f){return this.replace(f,"")},reverse:function(){return this.split("").reverse().join("")},compact:function(){return this.trim().replace(/([\r\n\s　])+/g,function(match,whitespace){return whitespace==="　"?whitespace:" "})},at:function(){return entryAtIndex(this,arguments,true)},from:function(num){return this.slice(num)},to:function(num){if(isUndefined(num))num=this.length;return this.slice(0,num)},dasherize:function(){return this.underscore().replace(/_/g,"-")},underscore:function(){return this.replace(/[-\s]+/g,"_").replace(string.Inflector&&string.Inflector.acronymRegExp,function(acronym,index){return(index>0?"_":"")+acronym.toLowerCase()
}).replace(/([A-Z\d]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase()},camelize:function(first){return this.underscore().replace(/(^|_)([^_]+)/g,function(match,pre,word,index){var acronym=getAcronym(word),capitalize=first!==false||index>0;if(acronym)return capitalize?acronym:acronym.toLowerCase();return capitalize?word.capitalize():word})},spacify:function(){return this.underscore().replace(/_/g," ")},stripTags:function(){var str=this,args=arguments.length>0?arguments:[""];flattenedArgs(args,function(tag){str=str.replace(regexp("</?"+escapeRegExp(tag)+"[^<>]*>","gi"),"")});return str},removeTags:function(){var str=this,args=arguments.length>0?arguments:["\\S+"];flattenedArgs(args,function(t){var reg=regexp("<("+t+")[^<>]*(?:\\/>|>.*?<\\/\\1>)","gi");str=str.replace(reg,"")});return str},truncate:function(length,split,from,ellipsis){var pos,prepend="",append="",str=this.toString(),chars="["+getTrimmableCharacters()+"]+",space="[^"+getTrimmableCharacters()+"]*",reg=regexp(chars+space+"$");ellipsis=isUndefined(ellipsis)?"...":string(ellipsis);if(str.length<=length){return str}switch(from){case"left":pos=str.length-length;prepend=ellipsis;str=str.slice(pos);reg=regexp("^"+space+chars);break;case"middle":pos=floor(length/2);append=ellipsis+str.slice(str.length-pos).trimLeft();str=str.slice(0,pos);break;default:pos=length;append=ellipsis;str=str.slice(0,pos)}if(split===false&&this.slice(pos,pos+1).match(/\S/)){str=str.remove(reg)}return prepend+str+append},pad:function(padding,num){return repeatString(num,padding)+this+repeatString(num,padding)},padLeft:function(padding,num){return repeatString(num,padding)+this},padRight:function(padding,num){return this+repeatString(num,padding)},first:function(num){if(isUndefined(num))num=1;return this.substr(0,num)},last:function(num){if(isUndefined(num))num=1;var start=this.length-num<0?0:this.length-num;return this.substr(start)},repeat:function(num){var result="",str=this;if(!isNumber(num)||num<1)return"";while(num){if(num&1){result+=str}if(num>>=1){str+=str}}return result},toNumber:function(base){var str=this.replace(/,/g,"");return str.match(/\./)?parseFloat(str):parseInt(str,base||10)},capitalize:function(all){var lastResponded;return this.toLowerCase().replace(all?/[\s\S]/g:/^\S/,function(lower){var upper=lower.toUpperCase(),result;result=lastResponded?lower:upper;lastResponded=upper!==lower;return result})},assign:function(){var assign={};multiArgs(arguments,function(a,i){if(isObject(a)){simpleMerge(assign,a)}else{assign[i+1]=a}});return this.replace(/\{([^{]+?)\}/g,function(m,key){return hasOwnProperty(assign,key)?assign[key]:m})}});extend(string,true,false,{insert:string.prototype.add});buildBase64("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=");var plurals=[],singulars=[],uncountables=[],humans=[],acronyms={},Downcased,Inflector;function removeFromArray(arr,find){var index=arr.indexOf(find);if(index>-1){arr.splice(index,1)}}function removeFromUncountablesAndAddTo(arr,rule,replacement){if(isString(rule)){removeFromArray(uncountables,rule)}removeFromArray(uncountables,replacement);arr.unshift({rule:rule,replacement:replacement})}function paramMatchesType(param,type){return param==type||param=="all"||!param}function isUncountable(word){return uncountables.some(function(uncountable){return new regexp("\\b"+uncountable+"$","i").test(word)})}function inflect(word,pluralize){word=isString(word)?word.toString():"";if(word.isBlank()||isUncountable(word)){return word}else{return runReplacements(word,pluralize?plurals:singulars)}}function runReplacements(word,table){iterateOverObject(table,function(i,inflection){if(word.match(inflection.rule)){word=word.replace(inflection.rule,inflection.replacement);return false}});return word}function capitalize(word){return word.replace(/^\W*[a-z]/,function(w){return w.toUpperCase()})}Inflector={acronym:function(word){acronyms[word.toLowerCase()]=word;var all=object.keys(acronyms).map(function(key){return acronyms[key]});Inflector.acronymRegExp=regexp(all.join("|"),"g")},plural:function(rule,replacement){removeFromUncountablesAndAddTo(plurals,rule,replacement)},singular:function(rule,replacement){removeFromUncountablesAndAddTo(singulars,rule,replacement)},irregular:function(singular,plural){var singularFirst=singular.first(),singularRest=singular.from(1),pluralFirst=plural.first(),pluralRest=plural.from(1),pluralFirstUpper=pluralFirst.toUpperCase(),pluralFirstLower=pluralFirst.toLowerCase(),singularFirstUpper=singularFirst.toUpperCase(),singularFirstLower=singularFirst.toLowerCase();removeFromArray(uncountables,singular);removeFromArray(uncountables,plural);if(singularFirstUpper==pluralFirstUpper){Inflector.plural(new regexp("({1}){2}$".assign(singularFirst,singularRest),"i"),"$1"+pluralRest);Inflector.plural(new regexp("({1}){2}$".assign(pluralFirst,pluralRest),"i"),"$1"+pluralRest);Inflector.singular(new regexp("({1}){2}$".assign(pluralFirst,pluralRest),"i"),"$1"+singularRest)}else{Inflector.plural(new regexp("{1}{2}$".assign(singularFirstUpper,singularRest)),pluralFirstUpper+pluralRest);Inflector.plural(new regexp("{1}{2}$".assign(singularFirstLower,singularRest)),pluralFirstLower+pluralRest);Inflector.plural(new regexp("{1}{2}$".assign(pluralFirstUpper,pluralRest)),pluralFirstUpper+pluralRest);Inflector.plural(new regexp("{1}{2}$".assign(pluralFirstLower,pluralRest)),pluralFirstLower+pluralRest);Inflector.singular(new regexp("{1}{2}$".assign(pluralFirstUpper,pluralRest)),singularFirstUpper+singularRest);Inflector.singular(new regexp("{1}{2}$".assign(pluralFirstLower,pluralRest)),singularFirstLower+singularRest)}},uncountable:function(first){var add=array.isArray(first)?first:multiArgs(arguments);uncountables=uncountables.concat(add)},human:function(rule,replacement){humans.unshift({rule:rule,replacement:replacement})},clear:function(type){if(paramMatchesType(type,"singulars"))singulars=[];if(paramMatchesType(type,"plurals"))plurals=[];if(paramMatchesType(type,"uncountables"))uncountables=[];if(paramMatchesType(type,"humans"))humans=[];if(paramMatchesType(type,"acronyms"))acronyms={}}};Downcased=["and","or","nor","a","an","the","so","but","to","of","at","by","from","into","on","onto","off","out","in","over","with","for"];Inflector.plural(/$/,"s");Inflector.plural(/s$/gi,"s");Inflector.plural(/(ax|test)is$/gi,"$1es");Inflector.plural(/(octop|vir|fung|foc|radi|alumn)(i|us)$/gi,"$1i");Inflector.plural(/(census|alias|status)$/gi,"$1es");Inflector.plural(/(bu)s$/gi,"$1ses");Inflector.plural(/(buffal|tomat)o$/gi,"$1oes");Inflector.plural(/([ti])um$/gi,"$1a");Inflector.plural(/([ti])a$/gi,"$1a");Inflector.plural(/sis$/gi,"ses");Inflector.plural(/f+e?$/gi,"ves");Inflector.plural(/(cuff|roof)$/gi,"$1s");Inflector.plural(/([ht]ive)$/gi,"$1s");Inflector.plural(/([^aeiouy]o)$/gi,"$1es");Inflector.plural(/([^aeiouy]|qu)y$/gi,"$1ies");Inflector.plural(/(x|ch|ss|sh)$/gi,"$1es");Inflector.plural(/(matr|vert|ind)(?:ix|ex)$/gi,"$1ices");Inflector.plural(/([ml])ouse$/gi,"$1ice");Inflector.plural(/([ml])ice$/gi,"$1ice");Inflector.plural(/^(ox)$/gi,"$1en");Inflector.plural(/^(oxen)$/gi,"$1");Inflector.plural(/(quiz)$/gi,"$1zes");Inflector.plural(/(phot|cant|hom|zer|pian|portic|pr|quart|kimon)o$/gi,"$1os");Inflector.plural(/(craft)$/gi,"$1");Inflector.plural(/([ft])[eo]{2}(th?)$/gi,"$1ee$2");Inflector.singular(/s$/gi,"");Inflector.singular(/([pst][aiu]s)$/gi,"$1");Inflector.singular(/([aeiouy])ss$/gi,"$1ss");Inflector.singular(/(n)ews$/gi,"$1ews");Inflector.singular(/([ti])a$/gi,"$1um");Inflector.singular(/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/gi,"$1$2sis");Inflector.singular(/(^analy)ses$/gi,"$1sis");Inflector.singular(/(i)(f|ves)$/i,"$1fe");Inflector.singular(/([aeolr]f?)(f|ves)$/i,"$1f");Inflector.singular(/([ht]ive)s$/gi,"$1");Inflector.singular(/([^aeiouy]|qu)ies$/gi,"$1y");Inflector.singular(/(s)eries$/gi,"$1eries");Inflector.singular(/(m)ovies$/gi,"$1ovie");Inflector.singular(/(x|ch|ss|sh)es$/gi,"$1");Inflector.singular(/([ml])(ous|ic)e$/gi,"$1ouse");Inflector.singular(/(bus)(es)?$/gi,"$1");Inflector.singular(/(o)es$/gi,"$1");Inflector.singular(/(shoe)s?$/gi,"$1");Inflector.singular(/(cris|ax|test)[ie]s$/gi,"$1is");Inflector.singular(/(octop|vir|fung|foc|radi|alumn)(i|us)$/gi,"$1us");Inflector.singular(/(census|alias|status)(es)?$/gi,"$1");Inflector.singular(/^(ox)(en)?/gi,"$1");Inflector.singular(/(vert|ind)(ex|ices)$/gi,"$1ex");Inflector.singular(/(matr)(ix|ices)$/gi,"$1ix");Inflector.singular(/(quiz)(zes)?$/gi,"$1");Inflector.singular(/(database)s?$/gi,"$1");Inflector.singular(/ee(th?)$/gi,"oo$1");Inflector.irregular("person","people");Inflector.irregular("man","men");Inflector.irregular("child","children");Inflector.irregular("sex","sexes");Inflector.irregular("move","moves");Inflector.irregular("save","saves");Inflector.irregular("save","saves");Inflector.irregular("cow","kine");Inflector.irregular("goose","geese");Inflector.irregular("zombie","zombies");Inflector.uncountable("equipment,information,rice,money,species,series,fish,sheep,jeans".split(","));extend(string,true,false,{pluralize:function(){return inflect(this,true)},singularize:function(){return inflect(this,false)},humanize:function(){var str=runReplacements(this,humans),acronym;str=str.replace(/_id$/g,"");str=str.replace(/(_)?([a-z\d]*)/gi,function(match,_,word){acronym=hasOwnProperty(acronyms,word)?acronyms[word]:null;return(_?" ":"")+(acronym||word.toLowerCase())});return capitalize(str)},titleize:function(){var fullStopPunctuation=/[.:;!]$/,hasPunctuation,lastHadPunctuation,isFirstOrLast;return this.spacify().humanize().words(function(word,index,words){hasPunctuation=fullStopPunctuation.test(word);isFirstOrLast=index==0||index==words.length-1||hasPunctuation||lastHadPunctuation;lastHadPunctuation=hasPunctuation;if(isFirstOrLast||Downcased.indexOf(word)===-1){return capitalize(word)}else{return word}}).join(" ")},parameterize:function(separator){var str=this;if(separator===undefined)separator="-";if(str.normalize){str=str.normalize()}str=str.replace(/[^a-z0-9\-_]+/gi,separator);if(separator){str=str.replace(new regexp("^{sep}+|{sep}+$|({sep}){sep}+".assign({sep:escapeRegExp(separator)}),"g"),"$1")}return encodeURI(str.toLowerCase())}});string.Inflector=Inflector;string.Inflector.acronyms=acronyms})(Streak);(function(Streak){var save=["$","jQuery","_","moment","jwerty","Stripe","Bacon","RSVP","html","html4","html_sanitize","sanitizeCssProperty","sanitizeCssSelectorList","sanitizeStylesheet","sanitizeStylesheetWithExternals","sanitizeMediaQuery","parseCssStylesheet","parseCssDeclarations","cssSchema","decodeCss","lexCss","URI"];Streak._old_globals={};save.forEach(function(name){Streak._old_globals[name]=window[name]})})(Streak);(function(undefined){var moment,VERSION="2.6.0",globalScope=typeof global!=="undefined"?global:this,oldGlobalMoment,round=Math.round,i,YEAR=0,MONTH=1,DATE=2,HOUR=3,MINUTE=4,SECOND=5,MILLISECOND=6,languages={},momentProperties={_isAMomentObject:null,_i:null,_f:null,_l:null,_strict:null,_isUTC:null,_offset:null,_pf:null,_lang:null},hasModule=typeof module!=="undefined"&&module.exports,aspNetJsonRegex=/^\/?Date\((\-?\d+)/i,aspNetTimeSpanJsonRegex=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,isoDurationRegex=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,formattingTokens=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,localFormattingTokens=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,parseTokenOneOrTwoDigits=/\d\d?/,parseTokenOneToThreeDigits=/\d{1,3}/,parseTokenOneToFourDigits=/\d{1,4}/,parseTokenOneToSixDigits=/[+\-]?\d{1,6}/,parseTokenDigits=/\d+/,parseTokenWord=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,parseTokenTimezone=/Z|[\+\-]\d\d:?\d\d/gi,parseTokenT=/T/i,parseTokenTimestampMs=/[\+\-]?\d+(\.\d{1,3})?/,parseTokenOrdinal=/\d{1,2}/,parseTokenOneDigit=/\d/,parseTokenTwoDigits=/\d\d/,parseTokenThreeDigits=/\d{3}/,parseTokenFourDigits=/\d{4}/,parseTokenSixDigits=/[+-]?\d{6}/,parseTokenSignedNumber=/[+-]?\d+/,isoRegex=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,isoFormat="YYYY-MM-DDTHH:mm:ssZ",isoDates=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],isoTimes=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],parseTimezoneChunker=/([\+\-]|\d\d)/gi,proxyGettersAndSetters="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),unitMillisecondFactors={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},unitAliases={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",Q:"quarter",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},camelFunctions={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},formatFunctions={},ordinalizeTokens="DDD w W M D d".split(" "),paddedTokens="M D H h m s w W".split(" "),formatTokenFunctions={M:function(){return this.month()+1},MMM:function(format){return this.lang().monthsShort(this,format)},MMMM:function(format){return this.lang().months(this,format)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(format){return this.lang().weekdaysMin(this,format)},ddd:function(format){return this.lang().weekdaysShort(this,format)},dddd:function(format){return this.lang().weekdays(this,format)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return leftZeroFill(this.year()%100,2)},YYYY:function(){return leftZeroFill(this.year(),4)},YYYYY:function(){return leftZeroFill(this.year(),5)},YYYYYY:function(){var y=this.year(),sign=y>=0?"+":"-";return sign+leftZeroFill(Math.abs(y),6)},gg:function(){return leftZeroFill(this.weekYear()%100,2)},gggg:function(){return leftZeroFill(this.weekYear(),4)},ggggg:function(){return leftZeroFill(this.weekYear(),5)},GG:function(){return leftZeroFill(this.isoWeekYear()%100,2)},GGGG:function(){return leftZeroFill(this.isoWeekYear(),4)},GGGGG:function(){return leftZeroFill(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),true)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),false)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return toInt(this.milliseconds()/100)},SS:function(){return leftZeroFill(toInt(this.milliseconds()/10),2)},SSS:function(){return leftZeroFill(this.milliseconds(),3)},SSSS:function(){return leftZeroFill(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-"}return b+leftZeroFill(toInt(a/60),2)+":"+leftZeroFill(toInt(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-"}return b+leftZeroFill(toInt(a/60),2)+leftZeroFill(toInt(a)%60,2)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()},Q:function(){return this.quarter()}},lists=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];function defaultParsingFlags(){return{empty:false,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:false,invalidMonth:null,invalidFormat:false,userInvalidated:false,iso:false}}function deprecate(msg,fn){var firstTime=true;function printMsg(){if(moment.suppressDeprecationWarnings===false&&typeof console!=="undefined"&&console.warn){console.warn("Deprecation warning: "+msg)}}return extend(function(){if(firstTime){printMsg();firstTime=false}return fn.apply(this,arguments)},fn)}function padToken(func,count){return function(a){return leftZeroFill(func.call(this,a),count)}}function ordinalizeToken(func,period){return function(a){return this.lang().ordinal(func.call(this,a),period)}}while(ordinalizeTokens.length){i=ordinalizeTokens.pop();formatTokenFunctions[i+"o"]=ordinalizeToken(formatTokenFunctions[i],i)}while(paddedTokens.length){i=paddedTokens.pop();formatTokenFunctions[i+i]=padToken(formatTokenFunctions[i],2)}formatTokenFunctions.DDDD=padToken(formatTokenFunctions.DDD,3);function Language(){}function Moment(config){checkOverflow(config);extend(this,config)}function Duration(duration){var normalizedInput=normalizeObjectUnits(duration),years=normalizedInput.year||0,quarters=normalizedInput.quarter||0,months=normalizedInput.month||0,weeks=normalizedInput.week||0,days=normalizedInput.day||0,hours=normalizedInput.hour||0,minutes=normalizedInput.minute||0,seconds=normalizedInput.second||0,milliseconds=normalizedInput.millisecond||0;this._milliseconds=+milliseconds+seconds*1e3+minutes*6e4+hours*36e5;this._days=+days+weeks*7;this._months=+months+quarters*3+years*12;this._data={};this._bubble()}function extend(a,b){for(var i in b){if(b.hasOwnProperty(i)){a[i]=b[i]}}if(b.hasOwnProperty("toString")){a.toString=b.toString}if(b.hasOwnProperty("valueOf")){a.valueOf=b.valueOf}return a}function cloneMoment(m){var result={},i;for(i in m){if(m.hasOwnProperty(i)&&momentProperties.hasOwnProperty(i)){result[i]=m[i]}}return result}function absRound(number){if(number<0){return Math.ceil(number)}else{return Math.floor(number)}}function leftZeroFill(number,targetLength,forceSign){var output=""+Math.abs(number),sign=number>=0;while(output.length<targetLength){output="0"+output}return(sign?forceSign?"+":"":"-")+output}function addOrSubtractDurationFromMoment(mom,duration,isAdding,updateOffset){var milliseconds=duration._milliseconds,days=duration._days,months=duration._months;updateOffset=updateOffset==null?true:updateOffset;if(milliseconds){mom._d.setTime(+mom._d+milliseconds*isAdding)}if(days){rawSetter(mom,"Date",rawGetter(mom,"Date")+days*isAdding)}if(months){rawMonthSetter(mom,rawGetter(mom,"Month")+months*isAdding)}if(updateOffset){moment.updateOffset(mom,days||months)}}function isArray(input){return Object.prototype.toString.call(input)==="[object Array]"}function isDate(input){return Object.prototype.toString.call(input)==="[object Date]"||input instanceof Date}function compareArrays(array1,array2,dontConvert){var len=Math.min(array1.length,array2.length),lengthDiff=Math.abs(array1.length-array2.length),diffs=0,i;for(i=0;i<len;i++){if(dontConvert&&array1[i]!==array2[i]||!dontConvert&&toInt(array1[i])!==toInt(array2[i])){diffs++}}return diffs+lengthDiff}function normalizeUnits(units){if(units){var lowered=units.toLowerCase().replace(/(.)s$/,"$1");units=unitAliases[units]||camelFunctions[lowered]||lowered}return units}function normalizeObjectUnits(inputObject){var normalizedInput={},normalizedProp,prop;for(prop in inputObject){if(inputObject.hasOwnProperty(prop)){normalizedProp=normalizeUnits(prop);if(normalizedProp){normalizedInput[normalizedProp]=inputObject[prop]}}}return normalizedInput}function makeList(field){var count,setter;if(field.indexOf("week")===0){count=7;setter="day"}else if(field.indexOf("month")===0){count=12;setter="month"}else{return}moment[field]=function(format,index){var i,getter,method=moment.fn._lang[field],results=[];if(typeof format==="number"){index=format;format=undefined}getter=function(i){var m=moment().utc().set(setter,i);return method.call(moment.fn._lang,m,format||"")};if(index!=null){return getter(index)}else{for(i=0;i<count;i++){results.push(getter(i))}return results}}}function toInt(argumentForCoercion){var coercedNumber=+argumentForCoercion,value=0;if(coercedNumber!==0&&isFinite(coercedNumber)){if(coercedNumber>=0){value=Math.floor(coercedNumber)}else{value=Math.ceil(coercedNumber)}}return value}function daysInMonth(year,month){return new Date(Date.UTC(year,month+1,0)).getUTCDate()}function weeksInYear(year,dow,doy){return weekOfYear(moment([year,11,31+dow-doy]),dow,doy).week}function daysInYear(year){return isLeapYear(year)?366:365}function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0}function checkOverflow(m){var overflow;if(m._a&&m._pf.overflow===-2){overflow=m._a[MONTH]<0||m._a[MONTH]>11?MONTH:m._a[DATE]<1||m._a[DATE]>daysInMonth(m._a[YEAR],m._a[MONTH])?DATE:m._a[HOUR]<0||m._a[HOUR]>23?HOUR:m._a[MINUTE]<0||m._a[MINUTE]>59?MINUTE:m._a[SECOND]<0||m._a[SECOND]>59?SECOND:m._a[MILLISECOND]<0||m._a[MILLISECOND]>999?MILLISECOND:-1;if(m._pf._overflowDayOfYear&&(overflow<YEAR||overflow>DATE)){overflow=DATE}m._pf.overflow=overflow}}function isValid(m){if(m._isValid==null){m._isValid=!isNaN(m._d.getTime())&&m._pf.overflow<0&&!m._pf.empty&&!m._pf.invalidMonth&&!m._pf.nullInput&&!m._pf.invalidFormat&&!m._pf.userInvalidated;if(m._strict){m._isValid=m._isValid&&m._pf.charsLeftOver===0&&m._pf.unusedTokens.length===0}}return m._isValid}function normalizeLanguage(key){return key?key.toLowerCase().replace("_","-"):key}function makeAs(input,model){return model._isUTC?moment(input).zone(model._offset||0):moment(input).local()}extend(Language.prototype,{set:function(config){var prop,i;for(i in config){prop=config[i];if(typeof prop==="function"){this[i]=prop}else{this["_"+i]=prop}}},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(m){return this._months[m.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(m){return this._monthsShort[m.month()]},monthsParse:function(monthName){var i,mom,regex;if(!this._monthsParse){this._monthsParse=[]}for(i=0;i<12;i++){if(!this._monthsParse[i]){mom=moment.utc([2e3,i]);regex="^"+this.months(mom,"")+"|^"+this.monthsShort(mom,"");this._monthsParse[i]=new RegExp(regex.replace(".",""),"i")}if(this._monthsParse[i].test(monthName)){return i}}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(m){return this._weekdays[m.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(m){return this._weekdaysShort[m.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(m){return this._weekdaysMin[m.day()]},weekdaysParse:function(weekdayName){var i,mom,regex;if(!this._weekdaysParse){this._weekdaysParse=[]}for(i=0;i<7;i++){if(!this._weekdaysParse[i]){mom=moment([2e3,1]).day(i);regex="^"+this.weekdays(mom,"")+"|^"+this.weekdaysShort(mom,"")+"|^"+this.weekdaysMin(mom,"");this._weekdaysParse[i]=new RegExp(regex.replace(".",""),"i")}if(this._weekdaysParse[i].test(weekdayName)){return i}}},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(key){var output=this._longDateFormat[key];if(!output&&this._longDateFormat[key.toUpperCase()]){output=this._longDateFormat[key.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(val){return val.slice(1)});this._longDateFormat[key]=output}return output},isPM:function(input){return(input+"").toLowerCase().charAt(0)==="p"},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(hours,minutes,isLower){if(hours>11){return isLower?"pm":"PM"}else{return isLower?"am":"AM"}},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(key,mom){var output=this._calendar[key];return typeof output==="function"?output.apply(mom):output},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(number,withoutSuffix,string,isFuture){var output=this._relativeTime[string];return typeof output==="function"?output(number,withoutSuffix,string,isFuture):output.replace(/%d/i,number)},pastFuture:function(diff,output){var format=this._relativeTime[diff>0?"future":"past"];return typeof format==="function"?format(output):format.replace(/%s/i,output)},ordinal:function(number){return this._ordinal.replace("%d",number)},_ordinal:"%d",preparse:function(string){return string},postformat:function(string){return string},week:function(mom){return weekOfYear(mom,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}});function loadLang(key,values){values.abbr=key;if(!languages[key]){languages[key]=new Language}languages[key].set(values);return languages[key]}function unloadLang(key){delete languages[key]}function getLangDefinition(key){var i=0,j,lang,next,split,get=function(k){if(!languages[k]&&hasModule){try{require("./lang/"+k)}catch(e){}}return languages[k]};if(!key){return moment.fn._lang}if(!isArray(key)){lang=get(key);if(lang){return lang}key=[key]}while(i<key.length){split=normalizeLanguage(key[i]).split("-");j=split.length;next=normalizeLanguage(key[i+1]);next=next?next.split("-"):null;while(j>0){lang=get(split.slice(0,j).join("-"));if(lang){return lang}if(next&&next.length>=j&&compareArrays(split,next,true)>=j-1){break}j--}i++}return moment.fn._lang}function removeFormattingTokens(input){if(input.match(/\[[\s\S]/)){return input.replace(/^\[|\]$/g,"")}return input.replace(/\\/g,"")}function makeFormatFunction(format){var array=format.match(formattingTokens),i,length;for(i=0,length=array.length;i<length;i++){if(formatTokenFunctions[array[i]]){array[i]=formatTokenFunctions[array[i]]}else{array[i]=removeFormattingTokens(array[i])}}return function(mom){var output="";for(i=0;i<length;i++){output+=array[i]instanceof Function?array[i].call(mom,format):array[i]}return output}}function formatMoment(m,format){if(!m.isValid()){return m.lang().invalidDate()}format=expandFormat(format,m.lang());if(!formatFunctions[format]){formatFunctions[format]=makeFormatFunction(format)}return formatFunctions[format](m)}function expandFormat(format,lang){var i=5;function replaceLongDateFormatTokens(input){return lang.longDateFormat(input)||input}localFormattingTokens.lastIndex=0;while(i>=0&&localFormattingTokens.test(format)){format=format.replace(localFormattingTokens,replaceLongDateFormatTokens);localFormattingTokens.lastIndex=0;i-=1}return format}function getParseRegexForToken(token,config){var a,strict=config._strict;switch(token){case"Q":return parseTokenOneDigit;case"DDDD":return parseTokenThreeDigits;case"YYYY":case"GGGG":case"gggg":return strict?parseTokenFourDigits:parseTokenOneToFourDigits;case"Y":case"G":case"g":return parseTokenSignedNumber;case"YYYYYY":case"YYYYY":case"GGGGG":case"ggggg":return strict?parseTokenSixDigits:parseTokenOneToSixDigits;case"S":if(strict){return parseTokenOneDigit}case"SS":if(strict){return parseTokenTwoDigits}case"SSS":if(strict){return parseTokenThreeDigits}case"DDD":return parseTokenOneToThreeDigits;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return parseTokenWord;case"a":case"A":return getLangDefinition(config._l)._meridiemParse;case"X":return parseTokenTimestampMs;case"Z":case"ZZ":return parseTokenTimezone;case"T":return parseTokenT;case"SSSS":return parseTokenDigits;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"ww":case"WW":return strict?parseTokenTwoDigits:parseTokenOneOrTwoDigits;case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"W":case"e":case"E":return parseTokenOneOrTwoDigits;case"Do":return parseTokenOrdinal;default:a=new RegExp(regexpEscape(unescapeFormat(token.replace("\\","")),"i"));return a}}function timezoneMinutesFromString(string){string=string||"";var possibleTzMatches=string.match(parseTokenTimezone)||[],tzChunk=possibleTzMatches[possibleTzMatches.length-1]||[],parts=(tzChunk+"").match(parseTimezoneChunker)||["-",0,0],minutes=+(parts[1]*60)+toInt(parts[2]);return parts[0]==="+"?-minutes:minutes}function addTimeToArrayFromToken(token,input,config){var a,datePartArray=config._a;switch(token){case"Q":if(input!=null){datePartArray[MONTH]=(toInt(input)-1)*3}break;case"M":case"MM":if(input!=null){datePartArray[MONTH]=toInt(input)-1}break;case"MMM":case"MMMM":a=getLangDefinition(config._l).monthsParse(input);if(a!=null){datePartArray[MONTH]=a}else{config._pf.invalidMonth=input}break;case"D":case"DD":if(input!=null){datePartArray[DATE]=toInt(input)}break;case"Do":if(input!=null){datePartArray[DATE]=toInt(parseInt(input,10))}break;case"DDD":case"DDDD":if(input!=null){config._dayOfYear=toInt(input)}break;case"YY":datePartArray[YEAR]=moment.parseTwoDigitYear(input);break;case"YYYY":case"YYYYY":case"YYYYYY":datePartArray[YEAR]=toInt(input);break;case"a":case"A":config._isPm=getLangDefinition(config._l).isPM(input);break;case"H":case"HH":case"h":case"hh":datePartArray[HOUR]=toInt(input);break;case"m":case"mm":datePartArray[MINUTE]=toInt(input);break;case"s":case"ss":datePartArray[SECOND]=toInt(input);break;case"S":case"SS":case"SSS":case"SSSS":datePartArray[MILLISECOND]=toInt(("0."+input)*1e3);break;case"X":config._d=new Date(parseFloat(input)*1e3);break;case"Z":case"ZZ":config._useUTC=true;config._tzm=timezoneMinutesFromString(input);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":token=token.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":token=token.substr(0,2);if(input){config._w=config._w||{};config._w[token]=input}break}}function dateFromConfig(config){var i,date,input=[],currentDate,yearToUse,fixYear,w,temp,lang,weekday,week;if(config._d){return}currentDate=currentDateArray(config);if(config._w&&config._a[DATE]==null&&config._a[MONTH]==null){fixYear=function(val){var intVal=parseInt(val,10);return val?val.length<3?intVal>68?1900+intVal:2e3+intVal:intVal:config._a[YEAR]==null?moment().weekYear():config._a[YEAR]};w=config._w;if(w.GG!=null||w.W!=null||w.E!=null){temp=dayOfYearFromWeeks(fixYear(w.GG),w.W||1,w.E,4,1)}else{lang=getLangDefinition(config._l);weekday=w.d!=null?parseWeekday(w.d,lang):w.e!=null?parseInt(w.e,10)+lang._week.dow:0;week=parseInt(w.w,10)||1;if(w.d!=null&&weekday<lang._week.dow){week++}temp=dayOfYearFromWeeks(fixYear(w.gg),week,weekday,lang._week.doy,lang._week.dow)}config._a[YEAR]=temp.year;config._dayOfYear=temp.dayOfYear}if(config._dayOfYear){yearToUse=config._a[YEAR]==null?currentDate[YEAR]:config._a[YEAR];if(config._dayOfYear>daysInYear(yearToUse)){config._pf._overflowDayOfYear=true}date=makeUTCDate(yearToUse,0,config._dayOfYear);config._a[MONTH]=date.getUTCMonth();config._a[DATE]=date.getUTCDate()}for(i=0;i<3&&config._a[i]==null;++i){config._a[i]=input[i]=currentDate[i]}for(;i<7;i++){config._a[i]=input[i]=config._a[i]==null?i===2?1:0:config._a[i]}input[HOUR]+=toInt((config._tzm||0)/60);input[MINUTE]+=toInt((config._tzm||0)%60);config._d=(config._useUTC?makeUTCDate:makeDate).apply(null,input)}function dateFromObject(config){var normalizedInput;if(config._d){return}normalizedInput=normalizeObjectUnits(config._i);config._a=[normalizedInput.year,normalizedInput.month,normalizedInput.day,normalizedInput.hour,normalizedInput.minute,normalizedInput.second,normalizedInput.millisecond];dateFromConfig(config)}function currentDateArray(config){var now=new Date;if(config._useUTC){return[now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()]}else{return[now.getFullYear(),now.getMonth(),now.getDate()]}}function makeDateFromStringAndFormat(config){config._a=[];config._pf.empty=true;var lang=getLangDefinition(config._l),string=""+config._i,i,parsedInput,tokens,token,skipped,stringLength=string.length,totalParsedInputLength=0;tokens=expandFormat(config._f,lang).match(formattingTokens)||[];for(i=0;i<tokens.length;i++){token=tokens[i];parsedInput=(string.match(getParseRegexForToken(token,config))||[])[0];if(parsedInput){skipped=string.substr(0,string.indexOf(parsedInput));if(skipped.length>0){config._pf.unusedInput.push(skipped)
}string=string.slice(string.indexOf(parsedInput)+parsedInput.length);totalParsedInputLength+=parsedInput.length}if(formatTokenFunctions[token]){if(parsedInput){config._pf.empty=false}else{config._pf.unusedTokens.push(token)}addTimeToArrayFromToken(token,parsedInput,config)}else if(config._strict&&!parsedInput){config._pf.unusedTokens.push(token)}}config._pf.charsLeftOver=stringLength-totalParsedInputLength;if(string.length>0){config._pf.unusedInput.push(string)}if(config._isPm&&config._a[HOUR]<12){config._a[HOUR]+=12}if(config._isPm===false&&config._a[HOUR]===12){config._a[HOUR]=0}dateFromConfig(config);checkOverflow(config)}function unescapeFormat(s){return s.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(matched,p1,p2,p3,p4){return p1||p2||p3||p4})}function regexpEscape(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function makeDateFromStringAndArray(config){var tempConfig,bestMoment,scoreToBeat,i,currentScore;if(config._f.length===0){config._pf.invalidFormat=true;config._d=new Date(NaN);return}for(i=0;i<config._f.length;i++){currentScore=0;tempConfig=extend({},config);tempConfig._pf=defaultParsingFlags();tempConfig._f=config._f[i];makeDateFromStringAndFormat(tempConfig);if(!isValid(tempConfig)){continue}currentScore+=tempConfig._pf.charsLeftOver;currentScore+=tempConfig._pf.unusedTokens.length*10;tempConfig._pf.score=currentScore;if(scoreToBeat==null||currentScore<scoreToBeat){scoreToBeat=currentScore;bestMoment=tempConfig}}extend(config,bestMoment||tempConfig)}function makeDateFromString(config){var i,l,string=config._i,match=isoRegex.exec(string);if(match){config._pf.iso=true;for(i=0,l=isoDates.length;i<l;i++){if(isoDates[i][1].exec(string)){config._f=isoDates[i][0]+(match[6]||" ");break}}for(i=0,l=isoTimes.length;i<l;i++){if(isoTimes[i][1].exec(string)){config._f+=isoTimes[i][0];break}}if(string.match(parseTokenTimezone)){config._f+="Z"}makeDateFromStringAndFormat(config)}else{moment.createFromInputFallback(config)}}function makeDateFromInput(config){var input=config._i,matched=aspNetJsonRegex.exec(input);if(input===undefined){config._d=new Date}else if(matched){config._d=new Date(+matched[1])}else if(typeof input==="string"){makeDateFromString(config)}else if(isArray(input)){config._a=input.slice(0);dateFromConfig(config)}else if(isDate(input)){config._d=new Date(+input)}else if(typeof input==="object"){dateFromObject(config)}else if(typeof input==="number"){config._d=new Date(input)}else{moment.createFromInputFallback(config)}}function makeDate(y,m,d,h,M,s,ms){var date=new Date(y,m,d,h,M,s,ms);if(y<1970){date.setFullYear(y)}return date}function makeUTCDate(y){var date=new Date(Date.UTC.apply(null,arguments));if(y<1970){date.setUTCFullYear(y)}return date}function parseWeekday(input,language){if(typeof input==="string"){if(!isNaN(input)){input=parseInt(input,10)}else{input=language.weekdaysParse(input);if(typeof input!=="number"){return null}}}return input}function substituteTimeAgo(string,number,withoutSuffix,isFuture,lang){return lang.relativeTime(number||1,!!withoutSuffix,string,isFuture)}function relativeTime(milliseconds,withoutSuffix,lang){var seconds=round(Math.abs(milliseconds)/1e3),minutes=round(seconds/60),hours=round(minutes/60),days=round(hours/24),years=round(days/365),args=seconds<45&&["s",seconds]||minutes===1&&["m"]||minutes<45&&["mm",minutes]||hours===1&&["h"]||hours<22&&["hh",hours]||days===1&&["d"]||days<=25&&["dd",days]||days<=45&&["M"]||days<345&&["MM",round(days/30)]||years===1&&["y"]||["yy",years];args[2]=withoutSuffix;args[3]=milliseconds>0;args[4]=lang;return substituteTimeAgo.apply({},args)}function weekOfYear(mom,firstDayOfWeek,firstDayOfWeekOfYear){var end=firstDayOfWeekOfYear-firstDayOfWeek,daysToDayOfWeek=firstDayOfWeekOfYear-mom.day(),adjustedMoment;if(daysToDayOfWeek>end){daysToDayOfWeek-=7}if(daysToDayOfWeek<end-7){daysToDayOfWeek+=7}adjustedMoment=moment(mom).add("d",daysToDayOfWeek);return{week:Math.ceil(adjustedMoment.dayOfYear()/7),year:adjustedMoment.year()}}function dayOfYearFromWeeks(year,week,weekday,firstDayOfWeekOfYear,firstDayOfWeek){var d=makeUTCDate(year,0,1).getUTCDay(),daysToAdd,dayOfYear;weekday=weekday!=null?weekday:firstDayOfWeek;daysToAdd=firstDayOfWeek-d+(d>firstDayOfWeekOfYear?7:0)-(d<firstDayOfWeek?7:0);dayOfYear=7*(week-1)+(weekday-firstDayOfWeek)+daysToAdd+1;return{year:dayOfYear>0?year:year-1,dayOfYear:dayOfYear>0?dayOfYear:daysInYear(year-1)+dayOfYear}}function makeMoment(config){var input=config._i,format=config._f;if(input===null||format===undefined&&input===""){return moment.invalid({nullInput:true})}if(typeof input==="string"){config._i=input=getLangDefinition().preparse(input)}if(moment.isMoment(input)){config=cloneMoment(input);config._d=new Date(+input._d)}else if(format){if(isArray(format)){makeDateFromStringAndArray(config)}else{makeDateFromStringAndFormat(config)}}else{makeDateFromInput(config)}return new Moment(config)}moment=function(input,format,lang,strict){var c;if(typeof lang==="boolean"){strict=lang;lang=undefined}c={};c._isAMomentObject=true;c._i=input;c._f=format;c._l=lang;c._strict=strict;c._isUTC=false;c._pf=defaultParsingFlags();return makeMoment(c)};moment.suppressDeprecationWarnings=false;moment.createFromInputFallback=deprecate("moment construction falls back to js Date. This is "+"discouraged and will be removed in upcoming major "+"release. Please refer to "+"https://github.com/moment/moment/issues/1407 for more info.",function(config){config._d=new Date(config._i)});moment.utc=function(input,format,lang,strict){var c;if(typeof lang==="boolean"){strict=lang;lang=undefined}c={};c._isAMomentObject=true;c._useUTC=true;c._isUTC=true;c._l=lang;c._i=input;c._f=format;c._strict=strict;c._pf=defaultParsingFlags();return makeMoment(c).utc()};moment.unix=function(input){return moment(input*1e3)};moment.duration=function(input,key){var duration=input,match=null,sign,ret,parseIso;if(moment.isDuration(input)){duration={ms:input._milliseconds,d:input._days,M:input._months}}else if(typeof input==="number"){duration={};if(key){duration[key]=input}else{duration.milliseconds=input}}else if(!!(match=aspNetTimeSpanJsonRegex.exec(input))){sign=match[1]==="-"?-1:1;duration={y:0,d:toInt(match[DATE])*sign,h:toInt(match[HOUR])*sign,m:toInt(match[MINUTE])*sign,s:toInt(match[SECOND])*sign,ms:toInt(match[MILLISECOND])*sign}}else if(!!(match=isoDurationRegex.exec(input))){sign=match[1]==="-"?-1:1;parseIso=function(inp){var res=inp&&parseFloat(inp.replace(",","."));return(isNaN(res)?0:res)*sign};duration={y:parseIso(match[2]),M:parseIso(match[3]),d:parseIso(match[4]),h:parseIso(match[5]),m:parseIso(match[6]),s:parseIso(match[7]),w:parseIso(match[8])}}ret=new Duration(duration);if(moment.isDuration(input)&&input.hasOwnProperty("_lang")){ret._lang=input._lang}return ret};moment.version=VERSION;moment.defaultFormat=isoFormat;moment.momentProperties=momentProperties;moment.updateOffset=function(){};moment.lang=function(key,values){var r;if(!key){return moment.fn._lang._abbr}if(values){loadLang(normalizeLanguage(key),values)}else if(values===null){unloadLang(key);key="en"}else if(!languages[key]){getLangDefinition(key)}r=moment.duration.fn._lang=moment.fn._lang=getLangDefinition(key);return r._abbr};moment.langData=function(key){if(key&&key._lang&&key._lang._abbr){key=key._lang._abbr}return getLangDefinition(key)};moment.isMoment=function(obj){return obj instanceof Moment||obj!=null&&obj.hasOwnProperty("_isAMomentObject")};moment.isDuration=function(obj){return obj instanceof Duration};for(i=lists.length-1;i>=0;--i){makeList(lists[i])}moment.normalizeUnits=function(units){return normalizeUnits(units)};moment.invalid=function(flags){var m=moment.utc(NaN);if(flags!=null){extend(m._pf,flags)}else{m._pf.userInvalidated=true}return m};moment.parseZone=function(){return moment.apply(null,arguments).parseZone()};moment.parseTwoDigitYear=function(input){return toInt(input)+(toInt(input)>68?1900:2e3)};extend(moment.fn=Moment.prototype,{clone:function(){return moment(this)},valueOf:function(){return+this._d+(this._offset||0)*6e4},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){var m=moment(this).utc();if(0<m.year()&&m.year()<=9999){return formatMoment(m,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}else{return formatMoment(m,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}},toArray:function(){var m=this;return[m.year(),m.month(),m.date(),m.hours(),m.minutes(),m.seconds(),m.milliseconds()]},isValid:function(){return isValid(this)},isDSTShifted:function(){if(this._a){return this.isValid()&&compareArrays(this._a,(this._isUTC?moment.utc(this._a):moment(this._a)).toArray())>0}return false},parsingFlags:function(){return extend({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){this.zone(0);this._isUTC=false;return this},format:function(inputString){var output=formatMoment(this,inputString||moment.defaultFormat);return this.lang().postformat(output)},add:function(input,val){var dur;if(typeof input==="string"){dur=moment.duration(+val,input)}else{dur=moment.duration(input,val)}addOrSubtractDurationFromMoment(this,dur,1);return this},subtract:function(input,val){var dur;if(typeof input==="string"){dur=moment.duration(+val,input)}else{dur=moment.duration(input,val)}addOrSubtractDurationFromMoment(this,dur,-1);return this},diff:function(input,units,asFloat){var that=makeAs(input,this),zoneDiff=(this.zone()-that.zone())*6e4,diff,output;units=normalizeUnits(units);if(units==="year"||units==="month"){diff=(this.daysInMonth()+that.daysInMonth())*432e5;output=(this.year()-that.year())*12+(this.month()-that.month());output+=(this-moment(this).startOf("month")-(that-moment(that).startOf("month")))/diff;output-=(this.zone()-moment(this).startOf("month").zone()-(that.zone()-moment(that).startOf("month").zone()))*6e4/diff;if(units==="year"){output=output/12}}else{diff=this-that;output=units==="second"?diff/1e3:units==="minute"?diff/6e4:units==="hour"?diff/36e5:units==="day"?(diff-zoneDiff)/864e5:units==="week"?(diff-zoneDiff)/6048e5:diff}return asFloat?output:absRound(output)},from:function(time,withoutSuffix){return moment.duration(this.diff(time)).lang(this.lang()._abbr).humanize(!withoutSuffix)},fromNow:function(withoutSuffix){return this.from(moment(),withoutSuffix)},calendar:function(){var sod=makeAs(moment(),this).startOf("day"),diff=this.diff(sod,"days",true),format=diff<-6?"sameElse":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(format,this))},isLeapYear:function(){return isLeapYear(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(input){var day=this._isUTC?this._d.getUTCDay():this._d.getDay();if(input!=null){input=parseWeekday(input,this.lang());return this.add({d:input-day})}else{return day}},month:makeAccessor("Month",true),startOf:function(units){units=normalizeUnits(units);switch(units){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}if(units==="week"){this.weekday(0)}else if(units==="isoWeek"){this.isoWeekday(1)}if(units==="quarter"){this.month(Math.floor(this.month()/3)*3)}return this},endOf:function(units){units=normalizeUnits(units);return this.startOf(units).add(units==="isoWeek"?"week":units,1).subtract("ms",1)},isAfter:function(input,units){units=typeof units!=="undefined"?units:"millisecond";return+this.clone().startOf(units)>+moment(input).startOf(units)},isBefore:function(input,units){units=typeof units!=="undefined"?units:"millisecond";return+this.clone().startOf(units)<+moment(input).startOf(units)},isSame:function(input,units){units=units||"ms";return+this.clone().startOf(units)===+makeAs(input,this).startOf(units)},min:function(other){other=moment.apply(null,arguments);return other<this?this:other},max:function(other){other=moment.apply(null,arguments);return other>this?this:other},zone:function(input,keepTime){var offset=this._offset||0;if(input!=null){if(typeof input==="string"){input=timezoneMinutesFromString(input)}if(Math.abs(input)<16){input=input*60}this._offset=input;this._isUTC=true;if(offset!==input){if(!keepTime||this._changeInProgress){addOrSubtractDurationFromMoment(this,moment.duration(offset-input,"m"),1,false)}else if(!this._changeInProgress){this._changeInProgress=true;moment.updateOffset(this,true);this._changeInProgress=null}}}else{return this._isUTC?offset:this._d.getTimezoneOffset()}return this},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){if(this._tzm){this.zone(this._tzm)}else if(typeof this._i==="string"){this.zone(this._i)}return this},hasAlignedHourOffset:function(input){if(!input){input=0}else{input=moment(input).zone()}return(this.zone()-input)%60===0},daysInMonth:function(){return daysInMonth(this.year(),this.month())},dayOfYear:function(input){var dayOfYear=round((moment(this).startOf("day")-moment(this).startOf("year"))/864e5)+1;return input==null?dayOfYear:this.add("d",input-dayOfYear)},quarter:function(input){return input==null?Math.ceil((this.month()+1)/3):this.month((input-1)*3+this.month()%3)},weekYear:function(input){var year=weekOfYear(this,this.lang()._week.dow,this.lang()._week.doy).year;return input==null?year:this.add("y",input-year)},isoWeekYear:function(input){var year=weekOfYear(this,1,4).year;return input==null?year:this.add("y",input-year)},week:function(input){var week=this.lang().week(this);return input==null?week:this.add("d",(input-week)*7)},isoWeek:function(input){var week=weekOfYear(this,1,4).week;return input==null?week:this.add("d",(input-week)*7)},weekday:function(input){var weekday=(this.day()+7-this.lang()._week.dow)%7;return input==null?weekday:this.add("d",input-weekday)},isoWeekday:function(input){return input==null?this.day()||7:this.day(this.day()%7?input:input-7)},isoWeeksInYear:function(){return weeksInYear(this.year(),1,4)},weeksInYear:function(){var weekInfo=this._lang._week;return weeksInYear(this.year(),weekInfo.dow,weekInfo.doy)},get:function(units){units=normalizeUnits(units);return this[units]()},set:function(units,value){units=normalizeUnits(units);if(typeof this[units]==="function"){this[units](value)}return this},lang:function(key){if(key===undefined){return this._lang}else{this._lang=getLangDefinition(key);return this}}});function rawMonthSetter(mom,value){var dayOfMonth;if(typeof value==="string"){value=mom.lang().monthsParse(value);if(typeof value!=="number"){return mom}}dayOfMonth=Math.min(mom.date(),daysInMonth(mom.year(),value));mom._d["set"+(mom._isUTC?"UTC":"")+"Month"](value,dayOfMonth);return mom}function rawGetter(mom,unit){return mom._d["get"+(mom._isUTC?"UTC":"")+unit]()}function rawSetter(mom,unit,value){if(unit==="Month"){return rawMonthSetter(mom,value)}else{return mom._d["set"+(mom._isUTC?"UTC":"")+unit](value)}}function makeAccessor(unit,keepTime){return function(value){if(value!=null){rawSetter(this,unit,value);moment.updateOffset(this,keepTime);return this}else{return rawGetter(this,unit)}}}moment.fn.millisecond=moment.fn.milliseconds=makeAccessor("Milliseconds",false);moment.fn.second=moment.fn.seconds=makeAccessor("Seconds",false);moment.fn.minute=moment.fn.minutes=makeAccessor("Minutes",false);moment.fn.hour=moment.fn.hours=makeAccessor("Hours",true);moment.fn.date=makeAccessor("Date",true);moment.fn.dates=deprecate("dates accessor is deprecated. Use date instead.",makeAccessor("Date",true));moment.fn.year=makeAccessor("FullYear",true);moment.fn.years=deprecate("years accessor is deprecated. Use year instead.",makeAccessor("FullYear",true));moment.fn.days=moment.fn.day;moment.fn.months=moment.fn.month;moment.fn.weeks=moment.fn.week;moment.fn.isoWeeks=moment.fn.isoWeek;moment.fn.quarters=moment.fn.quarter;moment.fn.toJSON=moment.fn.toISOString;extend(moment.duration.fn=Duration.prototype,{_bubble:function(){var milliseconds=this._milliseconds,days=this._days,months=this._months,data=this._data,seconds,minutes,hours,years;data.milliseconds=milliseconds%1e3;seconds=absRound(milliseconds/1e3);data.seconds=seconds%60;minutes=absRound(seconds/60);data.minutes=minutes%60;hours=absRound(minutes/60);data.hours=hours%24;days+=absRound(hours/24);data.days=days%30;months+=absRound(days/30);data.months=months%12;years=absRound(months/12);data.years=years},weeks:function(){return absRound(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*864e5+this._months%12*2592e6+toInt(this._months/12)*31536e6},humanize:function(withSuffix){var difference=+this,output=relativeTime(difference,!withSuffix,this.lang());if(withSuffix){output=this.lang().pastFuture(difference,output)}return this.lang().postformat(output)},add:function(input,val){var dur=moment.duration(input,val);this._milliseconds+=dur._milliseconds;this._days+=dur._days;this._months+=dur._months;this._bubble();return this},subtract:function(input,val){var dur=moment.duration(input,val);this._milliseconds-=dur._milliseconds;this._days-=dur._days;this._months-=dur._months;this._bubble();return this},get:function(units){units=normalizeUnits(units);return this[units.toLowerCase()+"s"]()},as:function(units){units=normalizeUnits(units);return this["as"+units.charAt(0).toUpperCase()+units.slice(1)+"s"]()},lang:moment.fn.lang,toIsoString:function(){var years=Math.abs(this.years()),months=Math.abs(this.months()),days=Math.abs(this.days()),hours=Math.abs(this.hours()),minutes=Math.abs(this.minutes()),seconds=Math.abs(this.seconds()+this.milliseconds()/1e3);if(!this.asSeconds()){return"P0D"}return(this.asSeconds()<0?"-":"")+"P"+(years?years+"Y":"")+(months?months+"M":"")+(days?days+"D":"")+(hours||minutes||seconds?"T":"")+(hours?hours+"H":"")+(minutes?minutes+"M":"")+(seconds?seconds+"S":"")}});function makeDurationGetter(name){moment.duration.fn[name]=function(){return this._data[name]}}function makeDurationAsGetter(name,factor){moment.duration.fn["as"+name]=function(){return+this/factor}}for(i in unitMillisecondFactors){if(unitMillisecondFactors.hasOwnProperty(i)){makeDurationAsGetter(i,unitMillisecondFactors[i]);makeDurationGetter(i.toLowerCase())}}makeDurationAsGetter("Weeks",6048e5);moment.duration.fn.asMonths=function(){return(+this-this.years()*31536e6)/2592e6+this.years()*12};moment.lang("en",{ordinal:function(number){var b=number%10,output=toInt(number%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th";return number+output}});(function(factory){factory(moment)})(function(moment){return moment.lang("ar-ma",{months:"يناير_فبراير_مارس_أبريل_ماي_يونيو_يوليوز_غشت_شتنبر_أكتوبر_نونبر_دجنبر".split("_"),monthsShort:"يناير_فبراير_مارس_أبريل_ماي_يونيو_يوليوز_غشت_شتنبر_أكتوبر_نونبر_دجنبر".split("_"),weekdays:"الأحد_الإتنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"احد_اتنين_ثلاثاء_اربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},week:{dow:6,doy:12}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ar",{months:"يناير/ كانون الثاني_فبراير/ شباط_مارس/ آذار_أبريل/ نيسان_مايو/ أيار_يونيو/ حزيران_يوليو/ تموز_أغسطس/ آب_سبتمبر/ أيلول_أكتوبر/ تشرين الأول_نوفمبر/ تشرين الثاني_ديسمبر/ كانون الأول".split("_"),monthsShort:"يناير/ كانون الثاني_فبراير/ شباط_مارس/ آذار_أبريل/ نيسان_مايو/ أيار_يونيو/ حزيران_يوليو/ تموز_أغسطس/ آب_سبتمبر/ أيلول_أكتوبر/ تشرين الأول_نوفمبر/ تشرين الثاني_ديسمبر/ كانون الأول".split("_"),weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},week:{dow:6,doy:12}})});(function(factory){factory(moment)})(function(moment){return moment.lang("bg",{months:"януари_февруари_март_април_май_юни_юли_август_септември_октомври_ноември_декември".split("_"),monthsShort:"янр_фев_мар_апр_май_юни_юли_авг_сеп_окт_ное_дек".split("_"),weekdays:"неделя_понеделник_вторник_сряда_четвъртък_петък_събота".split("_"),weekdaysShort:"нед_пон_вто_сря_чет_пет_съб".split("_"),weekdaysMin:"нд_пн_вт_ср_чт_пт_сб".split("_"),longDateFormat:{LT:"H:mm",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Днес в] LT",nextDay:"[Утре в] LT",nextWeek:"dddd [в] LT",lastDay:"[Вчера в] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[В изминалата] dddd [в] LT";case 1:case 2:case 4:case 5:return"[В изминалия] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"след %s",past:"преди %s",s:"няколко секунди",m:"минута",mm:"%d минути",h:"час",hh:"%d часа",d:"ден",dd:"%d дни",M:"месец",MM:"%d месеца",y:"година",yy:"%d години"},ordinal:function(number){var lastDigit=number%10,last2Digits=number%100;if(number===0){return number+"-ев"}else if(last2Digits===0){return number+"-ен"}else if(last2Digits>10&&last2Digits<20){return number+"-ти"}else if(lastDigit===1){return number+"-ви"}else if(lastDigit===2){return number+"-ри"}else if(lastDigit===7||lastDigit===8){return number+"-ми"}else{return number+"-ти"}},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){function relativeTimeWithMutation(number,withoutSuffix,key){var format={mm:"munutenn",MM:"miz",dd:"devezh"};return number+" "+mutation(format[key],number)}function specialMutationForYears(number){switch(lastNumber(number)){case 1:case 3:case 4:case 5:case 9:return number+" bloaz";default:return number+" vloaz"}}function lastNumber(number){if(number>9){return lastNumber(number%10)}return number}function mutation(text,number){if(number===2){return softMutation(text)}return text}function softMutation(text){var mutationTable={m:"v",b:"v",d:"z"};if(mutationTable[text.charAt(0)]===undefined){return text}return mutationTable[text.charAt(0)]+text.substring(1)}return moment.lang("br",{months:"Genver_C'hwevrer_Meurzh_Ebrel_Mae_Mezheven_Gouere_Eost_Gwengolo_Here_Du_Kerzu".split("_"),monthsShort:"Gen_C'hwe_Meu_Ebr_Mae_Eve_Gou_Eos_Gwe_Her_Du_Ker".split("_"),weekdays:"Sul_Lun_Meurzh_Merc'her_Yaou_Gwener_Sadorn".split("_"),weekdaysShort:"Sul_Lun_Meu_Mer_Yao_Gwe_Sad".split("_"),weekdaysMin:"Su_Lu_Me_Mer_Ya_Gw_Sa".split("_"),longDateFormat:{LT:"h[e]mm A",L:"DD/MM/YYYY",LL:"D [a viz] MMMM YYYY",LLL:"D [a viz] MMMM YYYY LT",LLLL:"dddd, D [a viz] MMMM YYYY LT"},calendar:{sameDay:"[Hiziv da] LT",nextDay:"[Warc'hoazh da] LT",nextWeek:"dddd [da] LT",lastDay:"[Dec'h da] LT",lastWeek:"dddd [paset da] LT",sameElse:"L"},relativeTime:{future:"a-benn %s",past:"%s 'zo",s:"un nebeud segondennoù",m:"ur vunutenn",mm:relativeTimeWithMutation,h:"un eur",hh:"%d eur",d:"un devezh",dd:relativeTimeWithMutation,M:"ur miz",MM:relativeTimeWithMutation,y:"ur bloaz",yy:specialMutationForYears},ordinal:function(number){var output=number===1?"añ":"vet";return number+output},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"m":return withoutSuffix?"jedna minuta":"jedne minute";case"mm":if(number===1){result+="minuta"}else if(number===2||number===3||number===4){result+="minute"}else{result+="minuta"}return result;case"h":return withoutSuffix?"jedan sat":"jednog sata";case"hh":if(number===1){result+="sat"}else if(number===2||number===3||number===4){result+="sata"}else{result+="sati"}return result;case"dd":if(number===1){result+="dan"}else{result+="dana"}return result;case"MM":if(number===1){result+="mjesec"}else if(number===2||number===3||number===4){result+="mjeseca"}else{result+="mjeseci"}return result;case"yy":if(number===1){result+="godina"}else if(number===2||number===3||number===4){result+="godine"}else{result+="godina"}return result}}return moment.lang("bs",{months:"januar_februar_mart_april_maj_juni_juli_avgust_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._avg._sep._okt._nov._dec.".split("_"),weekdays:"nedjelja_ponedjeljak_utorak_srijeda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),longDateFormat:{LT:"H:mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jučer u] LT",lastWeek:function(){switch(this.day()){case 0:case 3:return"[prošlu] dddd [u] LT";case 6:return"[prošle] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[prošli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",m:translate,mm:translate,h:translate,hh:translate,d:"dan",dd:translate,M:"mjesec",MM:translate,y:"godinu",yy:translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ca",{months:"gener_febrer_març_abril_maig_juny_juliol_agost_setembre_octubre_novembre_desembre".split("_"),monthsShort:"gen._febr._mar._abr._mai._jun._jul._ag._set._oct._nov._des.".split("_"),weekdays:"diumenge_dilluns_dimarts_dimecres_dijous_divendres_dissabte".split("_"),weekdaysShort:"dg._dl._dt._dc._dj._dv._ds.".split("_"),weekdaysMin:"Dg_Dl_Dt_Dc_Dj_Dv_Ds".split("_"),longDateFormat:{LT:"H:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:function(){return"[avui a "+(this.hours()!==1?"les":"la")+"] LT"},nextDay:function(){return"[demà a "+(this.hours()!==1?"les":"la")+"] LT"},nextWeek:function(){return"dddd [a "+(this.hours()!==1?"les":"la")+"] LT"},lastDay:function(){return"[ahir a "+(this.hours()!==1?"les":"la")+"] LT"},lastWeek:function(){return"[el] dddd [passat a "+(this.hours()!==1?"les":"la")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"fa %s",s:"uns segons",m:"un minut",mm:"%d minuts",h:"una hora",hh:"%d hores",d:"un dia",dd:"%d dies",M:"un mes",MM:"%d mesos",y:"un any",yy:"%d anys"},ordinal:"%dº",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var months="leden_únor_březen_duben_květen_červen_červenec_srpen_září_říjen_listopad_prosinec".split("_"),monthsShort="led_úno_bře_dub_kvě_čvn_čvc_srp_zář_říj_lis_pro".split("_");function plural(n){return n>1&&n<5&&~~(n/10)!==1}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"pár sekund":"pár sekundami";case"m":return withoutSuffix?"minuta":isFuture?"minutu":"minutou";case"mm":if(withoutSuffix||isFuture){return result+(plural(number)?"minuty":"minut")}else{return result+"minutami"}break;case"h":return withoutSuffix?"hodina":isFuture?"hodinu":"hodinou";case"hh":if(withoutSuffix||isFuture){return result+(plural(number)?"hodiny":"hodin")}else{return result+"hodinami"}break;case"d":return withoutSuffix||isFuture?"den":"dnem";case"dd":if(withoutSuffix||isFuture){return result+(plural(number)?"dny":"dní")}else{return result+"dny"}break;case"M":return withoutSuffix||isFuture?"měsíc":"měsícem";case"MM":if(withoutSuffix||isFuture){return result+(plural(number)?"měsíce":"měsíců")}else{return result+"měsíci"}break;case"y":return withoutSuffix||isFuture?"rok":"rokem";case"yy":if(withoutSuffix||isFuture){return result+(plural(number)?"roky":"let")}else{return result+"lety"}break}}return moment.lang("cs",{months:months,monthsShort:monthsShort,monthsParse:function(months,monthsShort){var i,_monthsParse=[];for(i=0;i<12;i++){_monthsParse[i]=new RegExp("^"+months[i]+"$|^"+monthsShort[i]+"$","i")}return _monthsParse}(months,monthsShort),weekdays:"neděle_pondělí_úterý_středa_čtvrtek_pátek_sobota".split("_"),weekdaysShort:"ne_po_út_st_čt_pá_so".split("_"),weekdaysMin:"ne_po_út_st_čt_pá_so".split("_"),longDateFormat:{LT:"H.mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd D. MMMM YYYY LT"},calendar:{sameDay:"[dnes v] LT",nextDay:"[zítra v] LT",nextWeek:function(){switch(this.day()){case 0:return"[v neděli v] LT";case 1:case 2:return"[v] dddd [v] LT";case 3:return"[ve středu v] LT";case 4:return"[ve čtvrtek v] LT";case 5:return"[v pátek v] LT";case 6:return"[v sobotu v] LT"}},lastDay:"[včera v] LT",lastWeek:function(){switch(this.day()){case 0:return"[minulou neděli v] LT";case 1:case 2:return"[minulé] dddd [v] LT";case 3:return"[minulou středu v] LT";case 4:case 5:return"[minulý] dddd [v] LT";case 6:return"[minulou sobotu v] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"před %s",s:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("cv",{months:"кăрлач_нарăс_пуш_ака_май_çĕртме_утă_çурла_авăн_юпа_чӳк_раштав".split("_"),monthsShort:"кăр_нар_пуш_ака_май_çĕр_утă_çур_ав_юпа_чӳк_раш".split("_"),weekdays:"вырсарникун_тунтикун_ытларикун_юнкун_кĕçнерникун_эрнекун_шăматкун".split("_"),weekdaysShort:"выр_тун_ытл_юн_кĕç_эрн_шăм".split("_"),weekdaysMin:"вр_тн_ыт_юн_кç_эр_шм".split("_"),longDateFormat:{LT:"HH:mm",L:"DD-MM-YYYY",LL:"YYYY [çулхи] MMMM [уйăхĕн] D[-мĕшĕ]",LLL:"YYYY [çулхи] MMMM [уйăхĕн] D[-мĕшĕ], LT",LLLL:"dddd, YYYY [çулхи] MMMM [уйăхĕн] D[-мĕшĕ], LT"},calendar:{sameDay:"[Паян] LT [сехетре]",nextDay:"[Ыран] LT [сехетре]",lastDay:"[Ĕнер] LT [сехетре]",nextWeek:"[Çитес] dddd LT [сехетре]",lastWeek:"[Иртнĕ] dddd LT [сехетре]",sameElse:"L"},relativeTime:{future:function(output){var affix=/сехет$/i.exec(output)?"рен":/çул$/i.exec(output)?"тан":"ран";return output+affix},past:"%s каялла",s:"пĕр-ик çеккунт",m:"пĕр минут",mm:"%d минут",h:"пĕр сехет",hh:"%d сехет",d:"пĕр кун",dd:"%d кун",M:"пĕр уйăх",MM:"%d уйăх",y:"пĕр çул",yy:"%d çул"},ordinal:"%d-мĕш",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("cy",{months:"Ionawr_Chwefror_Mawrth_Ebrill_Mai_Mehefin_Gorffennaf_Awst_Medi_Hydref_Tachwedd_Rhagfyr".split("_"),monthsShort:"Ion_Chwe_Maw_Ebr_Mai_Meh_Gor_Aws_Med_Hyd_Tach_Rhag".split("_"),weekdays:"Dydd Sul_Dydd Llun_Dydd Mawrth_Dydd Mercher_Dydd Iau_Dydd Gwener_Dydd Sadwrn".split("_"),weekdaysShort:"Sul_Llun_Maw_Mer_Iau_Gwe_Sad".split("_"),weekdaysMin:"Su_Ll_Ma_Me_Ia_Gw_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Heddiw am] LT",nextDay:"[Yfory am] LT",nextWeek:"dddd [am] LT",lastDay:"[Ddoe am] LT",lastWeek:"dddd [diwethaf am] LT",sameElse:"L"},relativeTime:{future:"mewn %s",past:"%s yn àl",s:"ychydig eiliadau",m:"munud",mm:"%d munud",h:"awr",hh:"%d awr",d:"diwrnod",dd:"%d diwrnod",M:"mis",MM:"%d mis",y:"blwyddyn",yy:"%d flynedd"},ordinal:function(number){var b=number,output="",lookup=["","af","il","ydd","ydd","ed","ed","ed","fed","fed","fed","eg","fed","eg","eg","fed","eg","eg","fed","eg","fed"];
if(b>20){if(b===40||b===50||b===60||b===80||b===100){output="fed"}else{output="ain"}}else if(b>0){output=lookup[b]}return number+output},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("da",{months:"januar_februar_marts_april_maj_juni_juli_august_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"søndag_mandag_tirsdag_onsdag_torsdag_fredag_lørdag".split("_"),weekdaysShort:"søn_man_tir_ons_tor_fre_lør".split("_"),weekdaysMin:"sø_ma_ti_on_to_fr_lø".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D. MMMM, YYYY LT"},calendar:{sameDay:"[I dag kl.] LT",nextDay:"[I morgen kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[I går kl.] LT",lastWeek:"[sidste] dddd [kl] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s siden",s:"få sekunder",m:"et minut",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dage",M:"en måned",MM:"%d måneder",y:"et år",yy:"%d år"},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[number+" Tage",number+" Tagen"],M:["ein Monat","einem Monat"],MM:[number+" Monate",number+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[number+" Jahre",number+" Jahren"]};return withoutSuffix?format[key][0]:format[key][1]}return moment.lang("de",{months:"Januar_Februar_März_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Febr._Mrz._Apr._Mai_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So._Mo._Di._Mi._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm [Uhr]",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[Heute um] LT",sameElse:"L",nextDay:"[Morgen um] LT",nextWeek:"dddd [um] LT",lastDay:"[Gestern um] LT",lastWeek:"[letzten] dddd [um] LT"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",m:processRelativeTime,mm:"%d Minuten",h:processRelativeTime,hh:"%d Stunden",d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("el",{monthsNominativeEl:"Ιανουάριος_Φεβρουάριος_Μάρτιος_Απρίλιος_Μάιος_Ιούνιος_Ιούλιος_Αύγουστος_Σεπτέμβριος_Οκτώβριος_Νοέμβριος_Δεκέμβριος".split("_"),monthsGenitiveEl:"Ιανουαρίου_Φεβρουαρίου_Μαρτίου_Απριλίου_Μαΐου_Ιουνίου_Ιουλίου_Αυγούστου_Σεπτεμβρίου_Οκτωβρίου_Νοεμβρίου_Δεκεμβρίου".split("_"),months:function(momentToFormat,format){if(/D/.test(format.substring(0,format.indexOf("MMMM")))){return this._monthsGenitiveEl[momentToFormat.month()]}else{return this._monthsNominativeEl[momentToFormat.month()]}},monthsShort:"Ιαν_Φεβ_Μαρ_Απρ_Μαϊ_Ιουν_Ιουλ_Αυγ_Σεπ_Οκτ_Νοε_Δεκ".split("_"),weekdays:"Κυριακή_Δευτέρα_Τρίτη_Τετάρτη_Πέμπτη_Παρασκευή_Σάββατο".split("_"),weekdaysShort:"Κυρ_Δευ_Τρι_Τετ_Πεμ_Παρ_Σαβ".split("_"),weekdaysMin:"Κυ_Δε_Τρ_Τε_Πε_Πα_Σα".split("_"),meridiem:function(hours,minutes,isLower){if(hours>11){return isLower?"μμ":"ΜΜ"}else{return isLower?"πμ":"ΠΜ"}},longDateFormat:{LT:"h:mm A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendarEl:{sameDay:"[Σήμερα {}] LT",nextDay:"[Αύριο {}] LT",nextWeek:"dddd [{}] LT",lastDay:"[Χθες {}] LT",lastWeek:"[την προηγούμενη] dddd [{}] LT",sameElse:"L"},calendar:function(key,mom){var output=this._calendarEl[key],hours=mom&&mom.hours();return output.replace("{}",hours%12===1?"στη":"στις")},relativeTime:{future:"σε %s",past:"%s πριν",s:"δευτερόλεπτα",m:"ένα λεπτό",mm:"%d λεπτά",h:"μία ώρα",hh:"%d ώρες",d:"μία μέρα",dd:"%d μέρες",M:"ένας μήνας",MM:"%d μήνες",y:"ένας χρόνος",yy:"%d χρόνια"},ordinal:function(number){return number+"η"},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("en-au",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(number){var b=number%10,output=~~(number%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th";return number+output},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("en-ca",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",L:"YYYY-MM-DD",LL:"D MMMM, YYYY",LLL:"D MMMM, YYYY LT",LLLL:"dddd, D MMMM, YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(number){var b=number%10,output=~~(number%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th";return number+output}})});(function(factory){factory(moment)})(function(moment){return moment.lang("en-gb",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(number){var b=number%10,output=~~(number%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th";return number+output},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("eo",{months:"januaro_februaro_marto_aprilo_majo_junio_julio_aŭgusto_septembro_oktobro_novembro_decembro".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aŭg_sep_okt_nov_dec".split("_"),weekdays:"Dimanĉo_Lundo_Mardo_Merkredo_Ĵaŭdo_Vendredo_Sabato".split("_"),weekdaysShort:"Dim_Lun_Mard_Merk_Ĵaŭ_Ven_Sab".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Ĵa_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"YYYY-MM-DD",LL:"D[-an de] MMMM, YYYY",LLL:"D[-an de] MMMM, YYYY LT",LLLL:"dddd, [la] D[-an de] MMMM, YYYY LT"},meridiem:function(hours,minutes,isLower){if(hours>11){return isLower?"p.t.m.":"P.T.M."}else{return isLower?"a.t.m.":"A.T.M."}},calendar:{sameDay:"[Hodiaŭ je] LT",nextDay:"[Morgaŭ je] LT",nextWeek:"dddd [je] LT",lastDay:"[Hieraŭ je] LT",lastWeek:"[pasinta] dddd [je] LT",sameElse:"L"},relativeTime:{future:"je %s",past:"antaŭ %s",s:"sekundoj",m:"minuto",mm:"%d minutoj",h:"horo",hh:"%d horoj",d:"tago",dd:"%d tagoj",M:"monato",MM:"%d monatoj",y:"jaro",yy:"%d jaroj"},ordinal:"%da",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var monthsShortDot="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),monthsShort="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_");return moment.lang("es",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(m,format){if(/-MMM-/.test(format)){return monthsShort[m.month()]}else{return monthsShortDot[m.month()]}},weekdays:"domingo_lunes_martes_miércoles_jueves_viernes_sábado".split("_"),weekdaysShort:"dom._lun._mar._mié._jue._vie._sáb.".split("_"),weekdaysMin:"Do_Lu_Ma_Mi_Ju_Vi_Sá".split("_"),longDateFormat:{LT:"H:mm",L:"DD/MM/YYYY",LL:"D [de] MMMM [del] YYYY",LLL:"D [de] MMMM [del] YYYY LT",LLLL:"dddd, D [de] MMMM [del] YYYY LT"},calendar:{sameDay:function(){return"[hoy a la"+(this.hours()!==1?"s":"")+"] LT"},nextDay:function(){return"[mañana a la"+(this.hours()!==1?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(this.hours()!==1?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(this.hours()!==1?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(this.hours()!==1?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un año",yy:"%d años"},ordinal:"%dº",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){function processRelativeTime(number,withoutSuffix,key,isFuture){var format={s:["mõne sekundi","mõni sekund","paar sekundit"],m:["ühe minuti","üks minut"],mm:[number+" minuti",number+" minutit"],h:["ühe tunni","tund aega","üks tund"],hh:[number+" tunni",number+" tundi"],d:["ühe päeva","üks päev"],M:["kuu aja","kuu aega","üks kuu"],MM:[number+" kuu",number+" kuud"],y:["ühe aasta","aasta","üks aasta"],yy:[number+" aasta",number+" aastat"]};if(withoutSuffix){return format[key][2]?format[key][2]:format[key][1]}return isFuture?format[key][0]:format[key][1]}return moment.lang("et",{months:"jaanuar_veebruar_märts_aprill_mai_juuni_juuli_august_september_oktoober_november_detsember".split("_"),monthsShort:"jaan_veebr_märts_apr_mai_juuni_juuli_aug_sept_okt_nov_dets".split("_"),weekdays:"pühapäev_esmaspäev_teisipäev_kolmapäev_neljapäev_reede_laupäev".split("_"),weekdaysShort:"P_E_T_K_N_R_L".split("_"),weekdaysMin:"P_E_T_K_N_R_L".split("_"),longDateFormat:{LT:"H:mm",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[Täna,] LT",nextDay:"[Homme,] LT",nextWeek:"[Järgmine] dddd LT",lastDay:"[Eile,] LT",lastWeek:"[Eelmine] dddd LT",sameElse:"L"},relativeTime:{future:"%s pärast",past:"%s tagasi",s:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:"%d päeva",M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("eu",{months:"urtarrila_otsaila_martxoa_apirila_maiatza_ekaina_uztaila_abuztua_iraila_urria_azaroa_abendua".split("_"),monthsShort:"urt._ots._mar._api._mai._eka._uzt._abu._ira._urr._aza._abe.".split("_"),weekdays:"igandea_astelehena_asteartea_asteazkena_osteguna_ostirala_larunbata".split("_"),weekdaysShort:"ig._al._ar._az._og._ol._lr.".split("_"),weekdaysMin:"ig_al_ar_az_og_ol_lr".split("_"),longDateFormat:{LT:"HH:mm",L:"YYYY-MM-DD",LL:"YYYY[ko] MMMM[ren] D[a]",LLL:"YYYY[ko] MMMM[ren] D[a] LT",LLLL:"dddd, YYYY[ko] MMMM[ren] D[a] LT",l:"YYYY-M-D",ll:"YYYY[ko] MMM D[a]",lll:"YYYY[ko] MMM D[a] LT",llll:"ddd, YYYY[ko] MMM D[a] LT"},calendar:{sameDay:"[gaur] LT[etan]",nextDay:"[bihar] LT[etan]",nextWeek:"dddd LT[etan]",lastDay:"[atzo] LT[etan]",lastWeek:"[aurreko] dddd LT[etan]",sameElse:"L"},relativeTime:{future:"%s barru",past:"duela %s",s:"segundo batzuk",m:"minutu bat",mm:"%d minutu",h:"ordu bat",hh:"%d ordu",d:"egun bat",dd:"%d egun",M:"hilabete bat",MM:"%d hilabete",y:"urte bat",yy:"%d urte"},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var symbolMap={1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹",0:"۰"},numberMap={"۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","۰":"0"};return moment.lang("fa",{months:"ژانویه_فوریه_مارس_آوریل_مه_ژوئن_ژوئیه_اوت_سپتامبر_اکتبر_نوامبر_دسامبر".split("_"),monthsShort:"ژانویه_فوریه_مارس_آوریل_مه_ژوئن_ژوئیه_اوت_سپتامبر_اکتبر_نوامبر_دسامبر".split("_"),weekdays:"یک‌شنبه_دوشنبه_سه‌شنبه_چهارشنبه_پنج‌شنبه_جمعه_شنبه".split("_"),weekdaysShort:"یک‌شنبه_دوشنبه_سه‌شنبه_چهارشنبه_پنج‌شنبه_جمعه_شنبه".split("_"),weekdaysMin:"ی_د_س_چ_پ_ج_ش".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},meridiem:function(hour,minute,isLower){if(hour<12){return"قبل از ظهر"}else{return"بعد از ظهر"}},calendar:{sameDay:"[امروز ساعت] LT",nextDay:"[فردا ساعت] LT",nextWeek:"dddd [ساعت] LT",lastDay:"[دیروز ساعت] LT",lastWeek:"dddd [پیش] [ساعت] LT",sameElse:"L"},relativeTime:{future:"در %s",past:"%s پیش",s:"چندین ثانیه",m:"یک دقیقه",mm:"%d دقیقه",h:"یک ساعت",hh:"%d ساعت",d:"یک روز",dd:"%d روز",M:"یک ماه",MM:"%d ماه",y:"یک سال",yy:"%d سال"},preparse:function(string){return string.replace(/[۰-۹]/g,function(match){return numberMap[match]}).replace(/،/g,",")},postformat:function(string){return string.replace(/\d/g,function(match){return symbolMap[match]}).replace(/,/g,"،")},ordinal:"%dم",week:{dow:6,doy:12}})});(function(factory){factory(moment)})(function(moment){var numbersPast="nolla yksi kaksi kolme neljä viisi kuusi seitsemän kahdeksan yhdeksän".split(" "),numbersFuture=["nolla","yhden","kahden","kolmen","neljän","viiden","kuuden",numbersPast[7],numbersPast[8],numbersPast[9]];function translate(number,withoutSuffix,key,isFuture){var result="";switch(key){case"s":return isFuture?"muutaman sekunnin":"muutama sekunti";case"m":return isFuture?"minuutin":"minuutti";case"mm":result=isFuture?"minuutin":"minuuttia";break;case"h":return isFuture?"tunnin":"tunti";case"hh":result=isFuture?"tunnin":"tuntia";break;case"d":return isFuture?"päivän":"päivä";case"dd":result=isFuture?"päivän":"päivää";break;case"M":return isFuture?"kuukauden":"kuukausi";case"MM":result=isFuture?"kuukauden":"kuukautta";break;case"y":return isFuture?"vuoden":"vuosi";case"yy":result=isFuture?"vuoden":"vuotta";break}result=verbalNumber(number,isFuture)+" "+result;return result}function verbalNumber(number,isFuture){return number<10?isFuture?numbersFuture[number]:numbersPast[number]:number}return moment.lang("fi",{months:"tammikuu_helmikuu_maaliskuu_huhtikuu_toukokuu_kesäkuu_heinäkuu_elokuu_syyskuu_lokakuu_marraskuu_joulukuu".split("_"),monthsShort:"tammi_helmi_maalis_huhti_touko_kesä_heinä_elo_syys_loka_marras_joulu".split("_"),weekdays:"sunnuntai_maanantai_tiistai_keskiviikko_torstai_perjantai_lauantai".split("_"),weekdaysShort:"su_ma_ti_ke_to_pe_la".split("_"),weekdaysMin:"su_ma_ti_ke_to_pe_la".split("_"),longDateFormat:{LT:"HH.mm",L:"DD.MM.YYYY",LL:"Do MMMM[ta] YYYY",LLL:"Do MMMM[ta] YYYY, [klo] LT",LLLL:"dddd, Do MMMM[ta] YYYY, [klo] LT",l:"D.M.YYYY",ll:"Do MMM YYYY",lll:"Do MMM YYYY, [klo] LT",llll:"ddd, Do MMM YYYY, [klo] LT"},calendar:{sameDay:"[tänään] [klo] LT",nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"},relativeTime:{future:"%s päästä",past:"%s sitten",s:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("fo",{months:"januar_februar_mars_apríl_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan_feb_mar_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_"),weekdays:"sunnudagur_mánadagur_týsdagur_mikudagur_hósdagur_fríggjadagur_leygardagur".split("_"),weekdaysShort:"sun_mán_týs_mik_hós_frí_ley".split("_"),weekdaysMin:"su_má_tý_mi_hó_fr_le".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D. MMMM, YYYY LT"},calendar:{sameDay:"[Í dag kl.] LT",nextDay:"[Í morgin kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[Í gjár kl.] LT",lastWeek:"[síðstu] dddd [kl] LT",sameElse:"L"},relativeTime:{future:"um %s",past:"%s síðani",s:"fá sekund",m:"ein minutt",mm:"%d minuttir",h:"ein tími",hh:"%d tímar",d:"ein dagur",dd:"%d dagar",M:"ein mánaði",MM:"%d mánaðir",y:"eitt ár",yy:"%d ár"},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("fr-ca",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},ordinal:function(number){return number+(number===1?"er":"")}})});(function(factory){factory(moment)})(function(moment){return moment.lang("fr",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},ordinal:function(number){return number+(number===1?"er":"")},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("gl",{months:"Xaneiro_Febreiro_Marzo_Abril_Maio_Xuño_Xullo_Agosto_Setembro_Outubro_Novembro_Decembro".split("_"),monthsShort:"Xan._Feb._Mar._Abr._Mai._Xuñ._Xul._Ago._Set._Out._Nov._Dec.".split("_"),weekdays:"Domingo_Luns_Martes_Mércores_Xoves_Venres_Sábado".split("_"),weekdaysShort:"Dom._Lun._Mar._Mér._Xov._Ven._Sáb.".split("_"),weekdaysMin:"Do_Lu_Ma_Mé_Xo_Ve_Sá".split("_"),longDateFormat:{LT:"H:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:function(){return"[hoxe "+(this.hours()!==1?"ás":"á")+"] LT"},nextDay:function(){return"[mañá "+(this.hours()!==1?"ás":"á")+"] LT"},nextWeek:function(){return"dddd ["+(this.hours()!==1?"ás":"a")+"] LT"},lastDay:function(){return"[onte "+(this.hours()!==1?"á":"a")+"] LT"},lastWeek:function(){return"[o] dddd [pasado "+(this.hours()!==1?"ás":"a")+"] LT"},sameElse:"L"},relativeTime:{future:function(str){if(str==="uns segundos"){return"nuns segundos"}return"en "+str},past:"hai %s",s:"uns segundos",m:"un minuto",mm:"%d minutos",h:"unha hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un ano",yy:"%d anos"},ordinal:"%dº",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("he",{months:"ינואר_פברואר_מרץ_אפריל_מאי_יוני_יולי_אוגוסט_ספטמבר_אוקטובר_נובמבר_דצמבר".split("_"),monthsShort:"ינו׳_פבר׳_מרץ_אפר׳_מאי_יוני_יולי_אוג׳_ספט׳_אוק׳_נוב׳_דצמ׳".split("_"),weekdays:"ראשון_שני_שלישי_רביעי_חמישי_שישי_שבת".split("_"),weekdaysShort:"א׳_ב׳_ג׳_ד׳_ה׳_ו׳_ש׳".split("_"),weekdaysMin:"א_ב_ג_ד_ה_ו_ש".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D [ב]MMMM YYYY",LLL:"D [ב]MMMM YYYY LT",LLLL:"dddd, D [ב]MMMM YYYY LT",l:"D/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY LT",llll:"ddd, D MMM YYYY LT"},calendar:{sameDay:"[היום ב־]LT",nextDay:"[מחר ב־]LT",nextWeek:"dddd [בשעה] LT",lastDay:"[אתמול ב־]LT",lastWeek:"[ביום] dddd [האחרון בשעה] LT",sameElse:"L"},relativeTime:{future:"בעוד %s",past:"לפני %s",s:"מספר שניות",m:"דקה",mm:"%d דקות",h:"שעה",hh:function(number){if(number===2){return"שעתיים"}return number+" שעות"},d:"יום",dd:function(number){if(number===2){return"יומיים"}return number+" ימים"},M:"חודש",MM:function(number){if(number===2){return"חודשיים"}return number+" חודשים"},y:"שנה",yy:function(number){if(number===2){return"שנתיים"}return number+" שנים"}}})});(function(factory){factory(moment)})(function(moment){var symbolMap={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},numberMap={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};return moment.lang("hi",{months:"जनवरी_फ़रवरी_मार्च_अप्रैल_मई_जून_जुलाई_अगस्त_सितम्बर_अक्टूबर_नवम्बर_दिसम्बर".split("_"),monthsShort:"जन._फ़र._मार्च_अप्रै._मई_जून_जुल._अग._सित._अक्टू._नव._दिस.".split("_"),weekdays:"रविवार_सोमवार_मंगलवार_बुधवार_गुरूवार_शुक्रवार_शनिवार".split("_"),weekdaysShort:"रवि_सोम_मंगल_बुध_गुरू_शुक्र_शनि".split("_"),weekdaysMin:"र_सो_मं_बु_गु_शु_श".split("_"),longDateFormat:{LT:"A h:mm बजे",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, LT",LLLL:"dddd, D MMMM YYYY, LT"},calendar:{sameDay:"[आज] LT",nextDay:"[कल] LT",nextWeek:"dddd, LT",lastDay:"[कल] LT",lastWeek:"[पिछले] dddd, LT",sameElse:"L"},relativeTime:{future:"%s में",past:"%s पहले",s:"कुछ ही क्षण",m:"एक मिनट",mm:"%d मिनट",h:"एक घंटा",hh:"%d घंटे",d:"एक दिन",dd:"%d दिन",M:"एक महीने",MM:"%d महीने",y:"एक वर्ष",yy:"%d वर्ष"},preparse:function(string){return string.replace(/[१२३४५६७८९०]/g,function(match){return numberMap[match]})},postformat:function(string){return string.replace(/\d/g,function(match){return symbolMap[match]})},meridiem:function(hour,minute,isLower){if(hour<4){return"रात"}else if(hour<10){return"सुबह"}else if(hour<17){return"दोपहर"}else if(hour<20){return"शाम"}else{return"रात"}},week:{dow:0,doy:6}})});(function(factory){factory(moment)})(function(moment){function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"m":return withoutSuffix?"jedna minuta":"jedne minute";case"mm":if(number===1){result+="minuta"}else if(number===2||number===3||number===4){result+="minute"}else{result+="minuta"}return result;case"h":return withoutSuffix?"jedan sat":"jednog sata";case"hh":if(number===1){result+="sat"}else if(number===2||number===3||number===4){result+="sata"}else{result+="sati"}return result;case"dd":if(number===1){result+="dan"}else{result+="dana"}return result;case"MM":if(number===1){result+="mjesec"}else if(number===2||number===3||number===4){result+="mjeseca"}else{result+="mjeseci"}return result;case"yy":if(number===1){result+="godina"}else if(number===2||number===3||number===4){result+="godine"}else{result+="godina"}return result}}return moment.lang("hr",{months:"sječanj_veljača_ožujak_travanj_svibanj_lipanj_srpanj_kolovoz_rujan_listopad_studeni_prosinac".split("_"),monthsShort:"sje._vel._ožu._tra._svi._lip._srp._kol._ruj._lis._stu._pro.".split("_"),weekdays:"nedjelja_ponedjeljak_utorak_srijeda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),longDateFormat:{LT:"H:mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jučer u] LT",lastWeek:function(){switch(this.day()){case 0:case 3:return"[prošlu] dddd [u] LT";case 6:return"[prošle] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[prošli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",m:translate,mm:translate,h:translate,hh:translate,d:"dan",dd:translate,M:"mjesec",MM:translate,y:"godinu",yy:translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var weekEndings="vasárnap hétfőn kedden szerdán csütörtökön pénteken szombaton".split(" ");function translate(number,withoutSuffix,key,isFuture){var num=number,suffix;switch(key){case"s":return isFuture||withoutSuffix?"néhány másodperc":"néhány másodperce";case"m":return"egy"+(isFuture||withoutSuffix?" perc":" perce");case"mm":return num+(isFuture||withoutSuffix?" perc":" perce");case"h":return"egy"+(isFuture||withoutSuffix?" óra":" órája");case"hh":return num+(isFuture||withoutSuffix?" óra":" órája");case"d":return"egy"+(isFuture||withoutSuffix?" nap":" napja");case"dd":return num+(isFuture||withoutSuffix?" nap":" napja");case"M":return"egy"+(isFuture||withoutSuffix?" hónap":" hónapja");case"MM":return num+(isFuture||withoutSuffix?" hónap":" hónapja");case"y":return"egy"+(isFuture||withoutSuffix?" év":" éve");case"yy":return num+(isFuture||withoutSuffix?" év":" éve")}return""}function week(isFuture){return(isFuture?"":"[múlt] ")+"["+weekEndings[this.day()]+"] LT[-kor]"}return moment.lang("hu",{months:"január_február_március_április_május_június_július_augusztus_szeptember_október_november_december".split("_"),monthsShort:"jan_feb_márc_ápr_máj_jún_júl_aug_szept_okt_nov_dec".split("_"),weekdays:"vasárnap_hétfő_kedd_szerda_csütörtök_péntek_szombat".split("_"),weekdaysShort:"vas_hét_kedd_sze_csüt_pén_szo".split("_"),weekdaysMin:"v_h_k_sze_cs_p_szo".split("_"),longDateFormat:{LT:"H:mm",L:"YYYY.MM.DD.",LL:"YYYY. MMMM D.",LLL:"YYYY. MMMM D., LT",LLLL:"YYYY. MMMM D., dddd LT"},meridiem:function(hours,minutes,isLower){if(hours<12){return isLower===true?"de":"DE"}else{return isLower===true?"du":"DU"}},calendar:{sameDay:"[ma] LT[-kor]",nextDay:"[holnap] LT[-kor]",nextWeek:function(){return week.call(this,true)},lastDay:"[tegnap] LT[-kor]",lastWeek:function(){return week.call(this,false)},sameElse:"L"},relativeTime:{future:"%s múlva",past:"%s",s:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){function monthsCaseReplace(m,format){var months={nominative:"հունվար_փետրվար_մարտ_ապրիլ_մայիս_հունիս_հուլիս_օգոստոս_սեպտեմբեր_հոկտեմբեր_նոյեմբեր_դեկտեմբեր".split("_"),accusative:"հունվարի_փետրվարի_մարտի_ապրիլի_մայիսի_հունիսի_հուլիսի_օգոստոսի_սեպտեմբերի_հոկտեմբերի_նոյեմբերի_դեկտեմբերի".split("_")},nounCase=/D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/.test(format)?"accusative":"nominative";return months[nounCase][m.month()]}function monthsShortCaseReplace(m,format){var monthsShort="հնվ_փտր_մրտ_ապր_մյս_հնս_հլս_օգս_սպտ_հկտ_նմբ_դկտ".split("_");return monthsShort[m.month()]}function weekdaysCaseReplace(m,format){var weekdays="կիրակի_երկուշաբթի_երեքշաբթի_չորեքշաբթի_հինգշաբթի_ուրբաթ_շաբաթ".split("_");return weekdays[m.day()]}return moment.lang("hy-am",{months:monthsCaseReplace,monthsShort:monthsShortCaseReplace,weekdays:weekdaysCaseReplace,weekdaysShort:"կրկ_երկ_երք_չրք_հնգ_ուրբ_շբթ".split("_"),weekdaysMin:"կրկ_երկ_երք_չրք_հնգ_ուրբ_շբթ".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY թ.",LLL:"D MMMM YYYY թ., LT",LLLL:"dddd, D MMMM YYYY թ., LT"},calendar:{sameDay:"[այսօր] LT",nextDay:"[վաղը] LT",lastDay:"[երեկ] LT",nextWeek:function(){return"dddd [օրը ժամը] LT"},lastWeek:function(){return"[անցած] dddd [օրը ժամը] LT"},sameElse:"L"},relativeTime:{future:"%s հետո",past:"%s առաջ",s:"մի քանի վայրկյան",m:"րոպե",mm:"%d րոպե",h:"ժամ",hh:"%d ժամ",d:"օր",dd:"%d օր",M:"ամիս",MM:"%d ամիս",y:"տարի",yy:"%d տարի"},meridiem:function(hour){if(hour<4){return"գիշերվա"}else if(hour<12){return"առավոտվա"}else if(hour<17){return"ցերեկվա"}else{return"երեկոյան"}},ordinal:function(number,period){switch(period){case"DDD":case"w":case"W":case"DDDo":if(number===1){return number+"-ին"}return number+"-րդ";default:return number}},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("id",{months:"Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_November_Desember".split("_"),monthsShort:"Jan_Feb_Mar_Apr_Mei_Jun_Jul_Ags_Sep_Okt_Nov_Des".split("_"),weekdays:"Minggu_Senin_Selasa_Rabu_Kamis_Jumat_Sabtu".split("_"),weekdaysShort:"Min_Sen_Sel_Rab_Kam_Jum_Sab".split("_"),weekdaysMin:"Mg_Sn_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] LT",LLLL:"dddd, D MMMM YYYY [pukul] LT"},meridiem:function(hours,minutes,isLower){if(hours<11){return"pagi"}else if(hours<15){return"siang"}else if(hours<19){return"sore"}else{return"malam"}},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Besok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kemarin pukul] LT",lastWeek:"dddd [lalu pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lalu",s:"beberapa detik",m:"semenit",mm:"%d menit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){function plural(n){if(n%100===11){return true}else if(n%10===1){return false}return true}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"nokkrar sekúndur":"nokkrum sekúndum";case"m":return withoutSuffix?"mínúta":"mínútu";case"mm":if(plural(number)){return result+(withoutSuffix||isFuture?"mínútur":"mínútum")}else if(withoutSuffix){return result+"mínúta"}return result+"mínútu";case"hh":if(plural(number)){return result+(withoutSuffix||isFuture?"klukkustundir":"klukkustundum")}return result+"klukkustund";case"d":if(withoutSuffix){return"dagur"}return isFuture?"dag":"degi";case"dd":if(plural(number)){if(withoutSuffix){return result+"dagar"}return result+(isFuture?"daga":"dögum")}else if(withoutSuffix){return result+"dagur"}return result+(isFuture?"dag":"degi");case"M":if(withoutSuffix){return"mánuður"}return isFuture?"mánuð":"mánuði";case"MM":if(plural(number)){if(withoutSuffix){return result+"mánuðir"}return result+(isFuture?"mánuði":"mánuðum")}else if(withoutSuffix){return result+"mánuður"}return result+(isFuture?"mánuð":"mánuði");case"y":return withoutSuffix||isFuture?"ár":"ári";case"yy":if(plural(number)){return result+(withoutSuffix||isFuture?"ár":"árum")}return result+(withoutSuffix||isFuture?"ár":"ári")}}return moment.lang("is",{months:"janúar_febrúar_mars_apríl_maí_júní_júlí_ágúst_september_október_nóvember_desember".split("_"),monthsShort:"jan_feb_mar_apr_maí_jún_júl_ágú_sep_okt_nóv_des".split("_"),weekdays:"sunnudagur_mánudagur_þriðjudagur_miðvikudagur_fimmtudagur_föstudagur_laugardagur".split("_"),weekdaysShort:"sun_mán_þri_mið_fim_fös_lau".split("_"),weekdaysMin:"Su_Má_Þr_Mi_Fi_Fö_La".split("_"),longDateFormat:{LT:"H:mm",L:"DD/MM/YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] LT",LLLL:"dddd, D. MMMM YYYY [kl.] LT"},calendar:{sameDay:"[í dag kl.] LT",nextDay:"[á morgun kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[í gær kl.] LT",lastWeek:"[síðasta] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"eftir %s",past:"fyrir %s síðan",s:translate,m:translate,mm:translate,h:"klukkustund",hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},ordinal:"%d.",week:{dow:1,doy:4}})
});(function(factory){factory(moment)})(function(moment){return moment.lang("it",{months:"Gennaio_Febbraio_Marzo_Aprile_Maggio_Giugno_Luglio_Agosto_Settembre_Ottobre_Novembre_Dicembre".split("_"),monthsShort:"Gen_Feb_Mar_Apr_Mag_Giu_Lug_Ago_Set_Ott_Nov_Dic".split("_"),weekdays:"Domenica_Lunedì_Martedì_Mercoledì_Giovedì_Venerdì_Sabato".split("_"),weekdaysShort:"Dom_Lun_Mar_Mer_Gio_Ven_Sab".split("_"),weekdaysMin:"D_L_Ma_Me_G_V_S".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Oggi alle] LT",nextDay:"[Domani alle] LT",nextWeek:"dddd [alle] LT",lastDay:"[Ieri alle] LT",lastWeek:"[lo scorso] dddd [alle] LT",sameElse:"L"},relativeTime:{future:function(s){return(/^[0-9].+$/.test(s)?"tra":"in")+" "+s},past:"%s fa",s:"alcuni secondi",m:"un minuto",mm:"%d minuti",h:"un'ora",hh:"%d ore",d:"un giorno",dd:"%d giorni",M:"un mese",MM:"%d mesi",y:"un anno",yy:"%d anni"},ordinal:"%dº",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ja",{months:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"日曜日_月曜日_火曜日_水曜日_木曜日_金曜日_土曜日".split("_"),weekdaysShort:"日_月_火_水_木_金_土".split("_"),weekdaysMin:"日_月_火_水_木_金_土".split("_"),longDateFormat:{LT:"Ah時m分",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日LT",LLLL:"YYYY年M月D日LT dddd"},meridiem:function(hour,minute,isLower){if(hour<12){return"午前"}else{return"午後"}},calendar:{sameDay:"[今日] LT",nextDay:"[明日] LT",nextWeek:"[来週]dddd LT",lastDay:"[昨日] LT",lastWeek:"[前週]dddd LT",sameElse:"L"},relativeTime:{future:"%s後",past:"%s前",s:"数秒",m:"1分",mm:"%d分",h:"1時間",hh:"%d時間",d:"1日",dd:"%d日",M:"1ヶ月",MM:"%dヶ月",y:"1年",yy:"%d年"}})});(function(factory){factory(moment)})(function(moment){function monthsCaseReplace(m,format){var months={nominative:"იანვარი_თებერვალი_მარტი_აპრილი_მაისი_ივნისი_ივლისი_აგვისტო_სექტემბერი_ოქტომბერი_ნოემბერი_დეკემბერი".split("_"),accusative:"იანვარს_თებერვალს_მარტს_აპრილის_მაისს_ივნისს_ივლისს_აგვისტს_სექტემბერს_ოქტომბერს_ნოემბერს_დეკემბერს".split("_")},nounCase=/D[oD] *MMMM?/.test(format)?"accusative":"nominative";return months[nounCase][m.month()]}function weekdaysCaseReplace(m,format){var weekdays={nominative:"კვირა_ორშაბათი_სამშაბათი_ოთხშაბათი_ხუთშაბათი_პარასკევი_შაბათი".split("_"),accusative:"კვირას_ორშაბათს_სამშაბათს_ოთხშაბათს_ხუთშაბათს_პარასკევს_შაბათს".split("_")},nounCase=/(წინა|შემდეგ)/.test(format)?"accusative":"nominative";return weekdays[nounCase][m.day()]}return moment.lang("ka",{months:monthsCaseReplace,monthsShort:"იან_თებ_მარ_აპრ_მაი_ივნ_ივლ_აგვ_სექ_ოქტ_ნოე_დეკ".split("_"),weekdays:weekdaysCaseReplace,weekdaysShort:"კვი_ორშ_სამ_ოთხ_ხუთ_პარ_შაბ".split("_"),weekdaysMin:"კვ_ორ_სა_ოთ_ხუ_პა_შა".split("_"),longDateFormat:{LT:"h:mm A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[დღეს] LT[-ზე]",nextDay:"[ხვალ] LT[-ზე]",lastDay:"[გუშინ] LT[-ზე]",nextWeek:"[შემდეგ] dddd LT[-ზე]",lastWeek:"[წინა] dddd LT-ზე",sameElse:"L"},relativeTime:{future:function(s){return/(წამი|წუთი|საათი|წელი)/.test(s)?s.replace(/ი$/,"ში"):s+"ში"},past:function(s){if(/(წამი|წუთი|საათი|დღე|თვე)/.test(s)){return s.replace(/(ი|ე)$/,"ის წინ")}if(/წელი/.test(s)){return s.replace(/წელი$/,"წლის წინ")}},s:"რამდენიმე წამი",m:"წუთი",mm:"%d წუთი",h:"საათი",hh:"%d საათი",d:"დღე",dd:"%d დღე",M:"თვე",MM:"%d თვე",y:"წელი",yy:"%d წელი"},ordinal:function(number){if(number===0){return number}if(number===1){return number+"-ლი"}if(number<20||number<=100&&number%20===0||number%100===0){return"მე-"+number}return number+"-ე"},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("km",{months:"មករា_កុម្ភៈ_មិនា_មេសា_ឧសភា_មិថុនា_កក្កដា_សីហា_កញ្ញា_តុលា_វិច្ឆិកា_ធ្នូ".split("_"),monthsShort:"មករា_កុម្ភៈ_មិនា_មេសា_ឧសភា_មិថុនា_កក្កដា_សីហា_កញ្ញា_តុលា_វិច្ឆិកា_ធ្នូ".split("_"),weekdays:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),weekdaysShort:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),weekdaysMin:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[ថ្ងៃនៈ ម៉ោង] LT",nextDay:"[ស្អែក ម៉ោង] LT",nextWeek:"dddd [ម៉ោង] LT",lastDay:"[ម្សិលមិញ ម៉ោង] LT",lastWeek:"dddd [សប្តាហ៍មុន] [ម៉ោង] LT",sameElse:"L"},relativeTime:{future:"%sទៀត",past:"%sមុន",s:"ប៉ុន្មានវិនាទី",m:"មួយនាទី",mm:"%d នាទី",h:"មួយម៉ោង",hh:"%d ម៉ោង",d:"មួយថ្ងៃ",dd:"%d ថ្ងៃ",M:"មួយខែ",MM:"%d ខែ",y:"មួយឆ្នាំ",yy:"%d ឆ្នាំ"},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ko",{months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),longDateFormat:{LT:"A h시 mm분",L:"YYYY.MM.DD",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 LT",LLLL:"YYYY년 MMMM D일 dddd LT"},meridiem:function(hour,minute,isUpper){return hour<12?"오전":"오후"},calendar:{sameDay:"오늘 LT",nextDay:"내일 LT",nextWeek:"dddd LT",lastDay:"어제 LT",lastWeek:"지난주 dddd LT",sameElse:"L"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇초",ss:"%d초",m:"일분",mm:"%d분",h:"한시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한달",MM:"%d달",y:"일년",yy:"%d년"},ordinal:"%d일",meridiemParse:/(오전|오후)/,isPM:function(token){return token==="오후"}})});(function(factory){factory(moment)})(function(moment){function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eng Minutt","enger Minutt"],h:["eng Stonn","enger Stonn"],d:["een Dag","engem Dag"],dd:[number+" Deeg",number+" Deeg"],M:["ee Mount","engem Mount"],MM:[number+" Méint",number+" Méint"],y:["ee Joer","engem Joer"],yy:[number+" Joer",number+" Joer"]};return withoutSuffix?format[key][0]:format[key][1]}function processFutureTime(string){var number=string.substr(0,string.indexOf(" "));if(eifelerRegelAppliesToNumber(number)){return"a "+string}return"an "+string}function processPastTime(string){var number=string.substr(0,string.indexOf(" "));if(eifelerRegelAppliesToNumber(number)){return"viru "+string}return"virun "+string}function processLastWeek(string1){var weekday=this.format("d");if(eifelerRegelAppliesToWeekday(weekday)){return"[Leschte] dddd [um] LT"}return"[Leschten] dddd [um] LT"}function eifelerRegelAppliesToWeekday(weekday){weekday=parseInt(weekday,10);switch(weekday){case 0:case 1:case 3:case 5:case 6:return true;default:return false}}function eifelerRegelAppliesToNumber(number){number=parseInt(number,10);if(isNaN(number)){return false}if(number<0){return true}else if(number<10){if(4<=number&&number<=7){return true}return false}else if(number<100){var lastDigit=number%10,firstDigit=number/10;if(lastDigit===0){return eifelerRegelAppliesToNumber(firstDigit)}return eifelerRegelAppliesToNumber(lastDigit)}else if(number<1e4){while(number>=10){number=number/10}return eifelerRegelAppliesToNumber(number)}else{number=number/1e3;return eifelerRegelAppliesToNumber(number)}}return moment.lang("lb",{months:"Januar_Februar_Mäerz_Abrëll_Mee_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Febr._Mrz._Abr._Mee_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),weekdays:"Sonndeg_Méindeg_Dënschdeg_Mëttwoch_Donneschdeg_Freideg_Samschdeg".split("_"),weekdaysShort:"So._Mé._Dë._Më._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mé_Dë_Më_Do_Fr_Sa".split("_"),longDateFormat:{LT:"H:mm [Auer]",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[Haut um] LT",sameElse:"L",nextDay:"[Muer um] LT",nextWeek:"dddd [um] LT",lastDay:"[Gëschter um] LT",lastWeek:processLastWeek},relativeTime:{future:processFutureTime,past:processPastTime,s:"e puer Sekonnen",m:processRelativeTime,mm:"%d Minutten",h:processRelativeTime,hh:"%d Stonnen",d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var units={m:"minutė_minutės_minutę",mm:"minutės_minučių_minutes",h:"valanda_valandos_valandą",hh:"valandos_valandų_valandas",d:"diena_dienos_dieną",dd:"dienos_dienų_dienas",M:"mėnuo_mėnesio_mėnesį",MM:"mėnesiai_mėnesių_mėnesius",y:"metai_metų_metus",yy:"metai_metų_metus"},weekDays="pirmadienis_antradienis_trečiadienis_ketvirtadienis_penktadienis_šeštadienis_sekmadienis".split("_");function translateSeconds(number,withoutSuffix,key,isFuture){if(withoutSuffix){return"kelios sekundės"}else{return isFuture?"kelių sekundžių":"kelias sekundes"}}function translateSingular(number,withoutSuffix,key,isFuture){return withoutSuffix?forms(key)[0]:isFuture?forms(key)[1]:forms(key)[2]}function special(number){return number%10===0||number>10&&number<20}function forms(key){return units[key].split("_")}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";if(number===1){return result+translateSingular(number,withoutSuffix,key[0],isFuture)}else if(withoutSuffix){return result+(special(number)?forms(key)[1]:forms(key)[0])}else{if(isFuture){return result+forms(key)[1]}else{return result+(special(number)?forms(key)[1]:forms(key)[2])}}}function relativeWeekDay(moment,format){var nominative=format.indexOf("dddd HH:mm")===-1,weekDay=weekDays[moment.weekday()];return nominative?weekDay:weekDay.substring(0,weekDay.length-2)+"į"}return moment.lang("lt",{months:"sausio_vasario_kovo_balandžio_gegužės_biržėlio_liepos_rugpjūčio_rugsėjo_spalio_lapkričio_gruodžio".split("_"),monthsShort:"sau_vas_kov_bal_geg_bir_lie_rgp_rgs_spa_lap_grd".split("_"),weekdays:relativeWeekDay,weekdaysShort:"Sek_Pir_Ant_Tre_Ket_Pen_Šeš".split("_"),weekdaysMin:"S_P_A_T_K_Pn_Š".split("_"),longDateFormat:{LT:"HH:mm",L:"YYYY-MM-DD",LL:"YYYY [m.] MMMM D [d.]",LLL:"YYYY [m.] MMMM D [d.], LT [val.]",LLLL:"YYYY [m.] MMMM D [d.], dddd, LT [val.]",l:"YYYY-MM-DD",ll:"YYYY [m.] MMMM D [d.]",lll:"YYYY [m.] MMMM D [d.], LT [val.]",llll:"YYYY [m.] MMMM D [d.], ddd, LT [val.]"},calendar:{sameDay:"[Šiandien] LT",nextDay:"[Rytoj] LT",nextWeek:"dddd LT",lastDay:"[Vakar] LT",lastWeek:"[Praėjusį] dddd LT",sameElse:"L"},relativeTime:{future:"po %s",past:"prieš %s",s:translateSeconds,m:translateSingular,mm:translate,h:translateSingular,hh:translate,d:translateSingular,dd:translate,M:translateSingular,MM:translate,y:translateSingular,yy:translate},ordinal:function(number){return number+"-oji"},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var units={mm:"minūti_minūtes_minūte_minūtes",hh:"stundu_stundas_stunda_stundas",dd:"dienu_dienas_diena_dienas",MM:"mēnesi_mēnešus_mēnesis_mēneši",yy:"gadu_gadus_gads_gadi"};function format(word,number,withoutSuffix){var forms=word.split("_");if(withoutSuffix){return number%10===1&&number!==11?forms[2]:forms[3]}else{return number%10===1&&number!==11?forms[0]:forms[1]}}function relativeTimeWithPlural(number,withoutSuffix,key){return number+" "+format(units[key],number,withoutSuffix)}return moment.lang("lv",{months:"janvāris_februāris_marts_aprīlis_maijs_jūnijs_jūlijs_augusts_septembris_oktobris_novembris_decembris".split("_"),monthsShort:"jan_feb_mar_apr_mai_jūn_jūl_aug_sep_okt_nov_dec".split("_"),weekdays:"svētdiena_pirmdiena_otrdiena_trešdiena_ceturtdiena_piektdiena_sestdiena".split("_"),weekdaysShort:"Sv_P_O_T_C_Pk_S".split("_"),weekdaysMin:"Sv_P_O_T_C_Pk_S".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"YYYY. [gada] D. MMMM",LLL:"YYYY. [gada] D. MMMM, LT",LLLL:"YYYY. [gada] D. MMMM, dddd, LT"},calendar:{sameDay:"[Šodien pulksten] LT",nextDay:"[Rīt pulksten] LT",nextWeek:"dddd [pulksten] LT",lastDay:"[Vakar pulksten] LT",lastWeek:"[Pagājušā] dddd [pulksten] LT",sameElse:"L"},relativeTime:{future:"%s vēlāk",past:"%s agrāk",s:"dažas sekundes",m:"minūti",mm:relativeTimeWithPlural,h:"stundu",hh:relativeTimeWithPlural,d:"dienu",dd:relativeTimeWithPlural,M:"mēnesi",MM:relativeTimeWithPlural,y:"gadu",yy:relativeTimeWithPlural},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("mk",{months:"јануари_февруари_март_април_мај_јуни_јули_август_септември_октомври_ноември_декември".split("_"),monthsShort:"јан_фев_мар_апр_мај_јун_јул_авг_сеп_окт_ное_дек".split("_"),weekdays:"недела_понеделник_вторник_среда_четврток_петок_сабота".split("_"),weekdaysShort:"нед_пон_вто_сре_чет_пет_саб".split("_"),weekdaysMin:"нe_пo_вт_ср_че_пе_сa".split("_"),longDateFormat:{LT:"H:mm",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Денес во] LT",nextDay:"[Утре во] LT",nextWeek:"dddd [во] LT",lastDay:"[Вчера во] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[Во изминатата] dddd [во] LT";case 1:case 2:case 4:case 5:return"[Во изминатиот] dddd [во] LT"}},sameElse:"L"},relativeTime:{future:"после %s",past:"пред %s",s:"неколку секунди",m:"минута",mm:"%d минути",h:"час",hh:"%d часа",d:"ден",dd:"%d дена",M:"месец",MM:"%d месеци",y:"година",yy:"%d години"},ordinal:function(number){var lastDigit=number%10,last2Digits=number%100;if(number===0){return number+"-ев"}else if(last2Digits===0){return number+"-ен"}else if(last2Digits>10&&last2Digits<20){return number+"-ти"}else if(lastDigit===1){return number+"-ви"}else if(lastDigit===2){return number+"-ри"}else if(lastDigit===7||lastDigit===8){return number+"-ми"}else{return number+"-ти"}},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ml",{months:"ജനുവരി_ഫെബ്രുവരി_മാർച്ച്_ഏപ്രിൽ_മേയ്_ജൂൺ_ജൂലൈ_ഓഗസ്റ്റ്_സെപ്റ്റംബർ_ഒക്ടോബർ_നവംബർ_ഡിസംബർ".split("_"),monthsShort:"ജനു._ഫെബ്രു._മാർ._ഏപ്രി._മേയ്_ജൂൺ_ജൂലൈ._ഓഗ._സെപ്റ്റ._ഒക്ടോ._നവം._ഡിസം.".split("_"),weekdays:"ഞായറാഴ്ച_തിങ്കളാഴ്ച_ചൊവ്വാഴ്ച_ബുധനാഴ്ച_വ്യാഴാഴ്ച_വെള്ളിയാഴ്ച_ശനിയാഴ്ച".split("_"),weekdaysShort:"ഞായർ_തിങ്കൾ_ചൊവ്വ_ബുധൻ_വ്യാഴം_വെള്ളി_ശനി".split("_"),weekdaysMin:"ഞാ_തി_ചൊ_ബു_വ്യാ_വെ_ശ".split("_"),longDateFormat:{LT:"A h:mm -നു",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, LT",LLLL:"dddd, D MMMM YYYY, LT"},calendar:{sameDay:"[ഇന്ന്] LT",nextDay:"[നാളെ] LT",nextWeek:"dddd, LT",lastDay:"[ഇന്നലെ] LT",lastWeek:"[കഴിഞ്ഞ] dddd, LT",sameElse:"L"},relativeTime:{future:"%s കഴിഞ്ഞ്",past:"%s മുൻപ്",s:"അൽപ നിമിഷങ്ങൾ",m:"ഒരു മിനിറ്റ്",mm:"%d മിനിറ്റ്",h:"ഒരു മണിക്കൂർ",hh:"%d മണിക്കൂർ",d:"ഒരു ദിവസം",dd:"%d ദിവസം",M:"ഒരു മാസം",MM:"%d മാസം",y:"ഒരു വർഷം",yy:"%d വർഷം"},meridiem:function(hour,minute,isLower){if(hour<4){return"രാത്രി"}else if(hour<12){return"രാവിലെ"}else if(hour<17){return"ഉച്ച കഴിഞ്ഞ്"}else if(hour<20){return"വൈകുന്നേരം"}else{return"രാത്രി"}}})});(function(factory){factory(moment)})(function(moment){var symbolMap={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},numberMap={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};return moment.lang("mr",{months:"जानेवारी_फेब्रुवारी_मार्च_एप्रिल_मे_जून_जुलै_ऑगस्ट_सप्टेंबर_ऑक्टोबर_नोव्हेंबर_डिसेंबर".split("_"),monthsShort:"जाने._फेब्रु._मार्च._एप्रि._मे._जून._जुलै._ऑग._सप्टें._ऑक्टो._नोव्हें._डिसें.".split("_"),weekdays:"रविवार_सोमवार_मंगळवार_बुधवार_गुरूवार_शुक्रवार_शनिवार".split("_"),weekdaysShort:"रवि_सोम_मंगळ_बुध_गुरू_शुक्र_शनि".split("_"),weekdaysMin:"र_सो_मं_बु_गु_शु_श".split("_"),longDateFormat:{LT:"A h:mm वाजता",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, LT",LLLL:"dddd, D MMMM YYYY, LT"},calendar:{sameDay:"[आज] LT",nextDay:"[उद्या] LT",nextWeek:"dddd, LT",lastDay:"[काल] LT",lastWeek:"[मागील] dddd, LT",sameElse:"L"},relativeTime:{future:"%s नंतर",past:"%s पूर्वी",s:"सेकंद",m:"एक मिनिट",mm:"%d मिनिटे",h:"एक तास",hh:"%d तास",d:"एक दिवस",dd:"%d दिवस",M:"एक महिना",MM:"%d महिने",y:"एक वर्ष",yy:"%d वर्षे"},preparse:function(string){return string.replace(/[१२३४५६७८९०]/g,function(match){return numberMap[match]})},postformat:function(string){return string.replace(/\d/g,function(match){return symbolMap[match]})},meridiem:function(hour,minute,isLower){if(hour<4){return"रात्री"}else if(hour<10){return"सकाळी"}else if(hour<17){return"दुपारी"}else if(hour<20){return"सायंकाळी"}else{return"रात्री"}},week:{dow:0,doy:6}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ms-my",{months:"Januari_Februari_Mac_April_Mei_Jun_Julai_Ogos_September_Oktober_November_Disember".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ogs_Sep_Okt_Nov_Dis".split("_"),weekdays:"Ahad_Isnin_Selasa_Rabu_Khamis_Jumaat_Sabtu".split("_"),weekdaysShort:"Ahd_Isn_Sel_Rab_Kha_Jum_Sab".split("_"),weekdaysMin:"Ah_Is_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] LT",LLLL:"dddd, D MMMM YYYY [pukul] LT"},meridiem:function(hours,minutes,isLower){if(hours<11){return"pagi"}else if(hours<15){return"tengahari"}else if(hours<19){return"petang"}else{return"malam"}},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Esok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kelmarin pukul] LT",lastWeek:"dddd [lepas pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lepas",s:"beberapa saat",m:"seminit",mm:"%d minit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("nb",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan._feb._mars_april_mai_juni_juli_aug._sep._okt._nov._des.".split("_"),weekdays:"søndag_mandag_tirsdag_onsdag_torsdag_fredag_lørdag".split("_"),weekdaysShort:"sø._ma._ti._on._to._fr._lø.".split("_"),weekdaysMin:"sø_ma_ti_on_to_fr_lø".split("_"),longDateFormat:{LT:"H.mm",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] LT",LLLL:"dddd D. MMMM YYYY [kl.] LT"},calendar:{sameDay:"[i dag kl.] LT",nextDay:"[i morgen kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[i går kl.] LT",lastWeek:"[forrige] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"for %s siden",s:"noen sekunder",m:"ett minutt",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dager",M:"en måned",MM:"%d måneder",y:"ett år",yy:"%d år"},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var symbolMap={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},numberMap={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};return moment.lang("ne",{months:"जनवरी_फेब्रुवरी_मार्च_अप्रिल_मई_जुन_जुलाई_अगष्ट_सेप्टेम्बर_अक्टोबर_नोभेम्बर_डिसेम्बर".split("_"),monthsShort:"जन._फेब्रु._मार्च_अप्रि._मई_जुन_जुलाई._अग._सेप्ट._अक्टो._नोभे._डिसे.".split("_"),weekdays:"आइतबार_सोमबार_मङ्गलबार_बुधबार_बिहिबार_शुक्रबार_शनिबार".split("_"),weekdaysShort:"आइत._सोम._मङ्गल._बुध._बिहि._शुक्र._शनि.".split("_"),weekdaysMin:"आइ._सो._मङ्_बु._बि._शु._श.".split("_"),longDateFormat:{LT:"Aको h:mm बजे",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, LT",LLLL:"dddd, D MMMM YYYY, LT"},preparse:function(string){return string.replace(/[१२३४५६७८९०]/g,function(match){return numberMap[match]})},postformat:function(string){return string.replace(/\d/g,function(match){return symbolMap[match]})},meridiem:function(hour,minute,isLower){if(hour<3){return"राती"}else if(hour<10){return"बिहान"}else if(hour<15){return"दिउँसो"}else if(hour<18){return"बेलुका"}else if(hour<20){return"साँझ"}else{return"राती"}},calendar:{sameDay:"[आज] LT",nextDay:"[भोली] LT",nextWeek:"[आउँदो] dddd[,] LT",lastDay:"[हिजो] LT",lastWeek:"[गएको] dddd[,] LT",sameElse:"L"},relativeTime:{future:"%sमा",past:"%s अगाडी",s:"केही समय",m:"एक मिनेट",mm:"%d मिनेट",h:"एक घण्टा",hh:"%d घण्टा",d:"एक दिन",dd:"%d दिन",M:"एक महिना",MM:"%d महिना",y:"एक बर्ष",yy:"%d बर्ष"},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var monthsShortWithDots="jan._feb._mrt._apr._mei_jun._jul._aug._sep._okt._nov._dec.".split("_"),monthsShortWithoutDots="jan_feb_mrt_apr_mei_jun_jul_aug_sep_okt_nov_dec".split("_");return moment.lang("nl",{months:"januari_februari_maart_april_mei_juni_juli_augustus_september_oktober_november_december".split("_"),monthsShort:function(m,format){if(/-MMM-/.test(format)){return monthsShortWithoutDots[m.month()]}else{return monthsShortWithDots[m.month()]}},weekdays:"zondag_maandag_dinsdag_woensdag_donderdag_vrijdag_zaterdag".split("_"),weekdaysShort:"zo._ma._di._wo._do._vr._za.".split("_"),weekdaysMin:"Zo_Ma_Di_Wo_Do_Vr_Za".split("_"),longDateFormat:{LT:"HH:mm",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[vandaag om] LT",nextDay:"[morgen om] LT",nextWeek:"dddd [om] LT",lastDay:"[gisteren om] LT",lastWeek:"[afgelopen] dddd [om] LT",sameElse:"L"},relativeTime:{future:"over %s",past:"%s geleden",s:"een paar seconden",m:"één minuut",mm:"%d minuten",h:"één uur",hh:"%d uur",d:"één dag",dd:"%d dagen",M:"één maand",MM:"%d maanden",y:"één jaar",yy:"%d jaar"},ordinal:function(number){return number+(number===1||number===8||number>=20?"ste":"de")},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("nn",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan_feb_mar_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_"),weekdays:"sundag_måndag_tysdag_onsdag_torsdag_fredag_laurdag".split("_"),weekdaysShort:"sun_mån_tys_ons_tor_fre_lau".split("_"),weekdaysMin:"su_må_ty_on_to_fr_lø".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[I dag klokka] LT",nextDay:"[I morgon klokka] LT",nextWeek:"dddd [klokka] LT",lastDay:"[I går klokka] LT",lastWeek:"[Føregåande] dddd [klokka] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"for %s sidan",s:"nokre sekund",m:"eit minutt",mm:"%d minutt",h:"ein time",hh:"%d timar",d:"ein dag",dd:"%d dagar",M:"ein månad",MM:"%d månader",y:"eit år",yy:"%d år"},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var monthsNominative="styczeń_luty_marzec_kwiecień_maj_czerwiec_lipiec_sierpień_wrzesień_październik_listopad_grudzień".split("_"),monthsSubjective="stycznia_lutego_marca_kwietnia_maja_czerwca_lipca_sierpnia_września_października_listopada_grudnia".split("_");function plural(n){return n%10<5&&n%10>1&&~~(n/10)%10!==1}function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"m":return withoutSuffix?"minuta":"minutę";case"mm":return result+(plural(number)?"minuty":"minut");case"h":return withoutSuffix?"godzina":"godzinę";case"hh":return result+(plural(number)?"godziny":"godzin");case"MM":return result+(plural(number)?"miesiące":"miesięcy");case"yy":return result+(plural(number)?"lata":"lat")}}return moment.lang("pl",{months:function(momentToFormat,format){if(/D MMMM/.test(format)){return monthsSubjective[momentToFormat.month()]}else{return monthsNominative[momentToFormat.month()]}},monthsShort:"sty_lut_mar_kwi_maj_cze_lip_sie_wrz_paź_lis_gru".split("_"),weekdays:"niedziela_poniedziałek_wtorek_środa_czwartek_piątek_sobota".split("_"),weekdaysShort:"nie_pon_wt_śr_czw_pt_sb".split("_"),weekdaysMin:"N_Pn_Wt_Śr_Cz_Pt_So".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Dziś o] LT",nextDay:"[Jutro o] LT",nextWeek:"[W] dddd [o] LT",lastDay:"[Wczoraj o] LT",lastWeek:function(){switch(this.day()){case 0:return"[W zeszłą niedzielę o] LT";case 3:return"[W zeszłą środę o] LT";case 6:return"[W zeszłą sobotę o] LT";default:return"[W zeszły] dddd [o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"%s temu",s:"kilka sekund",m:translate,mm:translate,h:translate,hh:translate,d:"1 dzień",dd:"%d dni",M:"miesiąc",MM:translate,y:"rok",yy:translate},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("pt-br",{months:"janeiro_fevereiro_março_abril_maio_junho_julho_agosto_setembro_outubro_novembro_dezembro".split("_"),monthsShort:"jan_fev_mar_abr_mai_jun_jul_ago_set_out_nov_dez".split("_"),weekdays:"domingo_segunda-feira_terça-feira_quarta-feira_quinta-feira_sexta-feira_sábado".split("_"),weekdaysShort:"dom_seg_ter_qua_qui_sex_sáb".split("_"),weekdaysMin:"dom_2ª_3ª_4ª_5ª_6ª_sáb".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY [às] LT",LLLL:"dddd, D [de] MMMM [de] YYYY [às] LT"},calendar:{sameDay:"[Hoje às] LT",nextDay:"[Amanhã às] LT",nextWeek:"dddd [às] LT",lastDay:"[Ontem às] LT",lastWeek:function(){return this.day()===0||this.day()===6?"[Último] dddd [às] LT":"[Última] dddd [às] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"%s atrás",s:"segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",M:"um mês",MM:"%d meses",y:"um ano",yy:"%d anos"},ordinal:"%dº"})});(function(factory){factory(moment)})(function(moment){return moment.lang("pt",{months:"janeiro_fevereiro_março_abril_maio_junho_julho_agosto_setembro_outubro_novembro_dezembro".split("_"),monthsShort:"jan_fev_mar_abr_mai_jun_jul_ago_set_out_nov_dez".split("_"),weekdays:"domingo_segunda-feira_terça-feira_quarta-feira_quinta-feira_sexta-feira_sábado".split("_"),weekdaysShort:"dom_seg_ter_qua_qui_sex_sáb".split("_"),weekdaysMin:"dom_2ª_3ª_4ª_5ª_6ª_sáb".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY LT",LLLL:"dddd, D [de] MMMM [de] YYYY LT"},calendar:{sameDay:"[Hoje às] LT",nextDay:"[Amanhã às] LT",nextWeek:"dddd [às] LT",lastDay:"[Ontem às] LT",lastWeek:function(){return this.day()===0||this.day()===6?"[Último] dddd [às] LT":"[Última] dddd [às] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"%s atrás",s:"segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",M:"um mês",MM:"%d meses",y:"um ano",yy:"%d anos"},ordinal:"%dº",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){function relativeTimeWithPlural(number,withoutSuffix,key){var format={mm:"minute",hh:"ore",dd:"zile",MM:"luni",yy:"ani"},separator=" ";if(number%100>=20||number>=100&&number%100===0){separator=" de "}return number+separator+format[key]}return moment.lang("ro",{months:"ianuarie_februarie_martie_aprilie_mai_iunie_iulie_august_septembrie_octombrie_noiembrie_decembrie".split("_"),monthsShort:"ian._febr._mart._apr._mai_iun._iul._aug._sept._oct._nov._dec.".split("_"),weekdays:"duminică_luni_marți_miercuri_joi_vineri_sâmbătă".split("_"),weekdaysShort:"Dum_Lun_Mar_Mie_Joi_Vin_Sâm".split("_"),weekdaysMin:"Du_Lu_Ma_Mi_Jo_Vi_Sâ".split("_"),longDateFormat:{LT:"H:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[azi la] LT",nextDay:"[mâine la] LT",nextWeek:"dddd [la] LT",lastDay:"[ieri la] LT",lastWeek:"[fosta] dddd [la] LT",sameElse:"L"},relativeTime:{future:"peste %s",past:"%s în urmă",s:"câteva secunde",m:"un minut",mm:relativeTimeWithPlural,h:"o oră",hh:relativeTimeWithPlural,d:"o zi",dd:relativeTimeWithPlural,M:"o lună",MM:relativeTimeWithPlural,y:"un an",yy:relativeTimeWithPlural},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){function plural(word,num){var forms=word.split("_");return num%10===1&&num%100!==11?forms[0]:num%10>=2&&num%10<=4&&(num%100<10||num%100>=20)?forms[1]:forms[2]}function relativeTimeWithPlural(number,withoutSuffix,key){var format={mm:withoutSuffix?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"};if(key==="m"){return withoutSuffix?"минута":"минуту"}else{return number+" "+plural(format[key],+number)}}function monthsCaseReplace(m,format){var months={nominative:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),accusative:"января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_")},nounCase=/D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/.test(format)?"accusative":"nominative";return months[nounCase][m.month()]}function monthsShortCaseReplace(m,format){var monthsShort={nominative:"янв_фев_мар_апр_май_июнь_июль_авг_сен_окт_ноя_дек".split("_"),accusative:"янв_фев_мар_апр_мая_июня_июля_авг_сен_окт_ноя_дек".split("_")},nounCase=/D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/.test(format)?"accusative":"nominative";return monthsShort[nounCase][m.month()]}function weekdaysCaseReplace(m,format){var weekdays={nominative:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),accusative:"воскресенье_понедельник_вторник_среду_четверг_пятницу_субботу".split("_")},nounCase=/\[ ?[Вв] ?(?:прошлую|следующую)? ?\] ?dddd/.test(format)?"accusative":"nominative";return weekdays[nounCase][m.day()]}return moment.lang("ru",{months:monthsCaseReplace,monthsShort:monthsShortCaseReplace,weekdays:weekdaysCaseReplace,weekdaysShort:"вс_пн_вт_ср_чт_пт_сб".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),monthsParse:[/^янв/i,/^фев/i,/^мар/i,/^апр/i,/^ма[й|я]/i,/^июн/i,/^июл/i,/^авг/i,/^сен/i,/^окт/i,/^ноя/i,/^дек/i],longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., LT",LLLL:"dddd, D MMMM YYYY г., LT"},calendar:{sameDay:"[Сегодня в] LT",nextDay:"[Завтра в] LT",lastDay:"[Вчера в] LT",nextWeek:function(){return this.day()===2?"[Во] dddd [в] LT":"[В] dddd [в] LT"},lastWeek:function(){switch(this.day()){case 0:return"[В прошлое] dddd [в] LT";case 1:case 2:case 4:return"[В прошлый] dddd [в] LT";case 3:case 5:case 6:return"[В прошлую] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:relativeTimeWithPlural,mm:relativeTimeWithPlural,h:"час",hh:relativeTimeWithPlural,d:"день",dd:relativeTimeWithPlural,M:"месяц",MM:relativeTimeWithPlural,y:"год",yy:relativeTimeWithPlural},meridiem:function(hour,minute,isLower){if(hour<4){return"ночи"}else if(hour<12){return"утра"}else if(hour<17){return"дня"}else{return"вечера"}},ordinal:function(number,period){switch(period){case"M":case"d":case"DDD":return number+"-й";case"D":return number+"-го";case"w":case"W":return number+"-я";default:return number}},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var months="január_február_marec_apríl_máj_jún_júl_august_september_október_november_december".split("_"),monthsShort="jan_feb_mar_apr_máj_jún_júl_aug_sep_okt_nov_dec".split("_");function plural(n){return n>1&&n<5}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"pár sekúnd":"pár sekundami";case"m":return withoutSuffix?"minúta":isFuture?"minútu":"minútou";case"mm":if(withoutSuffix||isFuture){return result+(plural(number)?"minúty":"minút")}else{return result+"minútami"}break;case"h":return withoutSuffix?"hodina":isFuture?"hodinu":"hodinou";case"hh":if(withoutSuffix||isFuture){return result+(plural(number)?"hodiny":"hodín")}else{return result+"hodinami"}break;case"d":return withoutSuffix||isFuture?"deň":"dňom";case"dd":if(withoutSuffix||isFuture){return result+(plural(number)?"dni":"dní")}else{return result+"dňami"}break;case"M":return withoutSuffix||isFuture?"mesiac":"mesiacom";case"MM":if(withoutSuffix||isFuture){return result+(plural(number)?"mesiace":"mesiacov")}else{return result+"mesiacmi"}break;case"y":return withoutSuffix||isFuture?"rok":"rokom";case"yy":if(withoutSuffix||isFuture){return result+(plural(number)?"roky":"rokov")}else{return result+"rokmi"}break}}return moment.lang("sk",{months:months,monthsShort:monthsShort,monthsParse:function(months,monthsShort){var i,_monthsParse=[];for(i=0;i<12;i++){_monthsParse[i]=new RegExp("^"+months[i]+"$|^"+monthsShort[i]+"$","i")}return _monthsParse}(months,monthsShort),weekdays:"nedeľa_pondelok_utorok_streda_štvrtok_piatok_sobota".split("_"),weekdaysShort:"ne_po_ut_st_št_pi_so".split("_"),weekdaysMin:"ne_po_ut_st_št_pi_so".split("_"),longDateFormat:{LT:"H:mm",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd D. MMMM YYYY LT"},calendar:{sameDay:"[dnes o] LT",nextDay:"[zajtra o] LT",nextWeek:function(){switch(this.day()){case 0:return"[v nedeľu o] LT";
case 1:case 2:return"[v] dddd [o] LT";case 3:return"[v stredu o] LT";case 4:return"[vo štvrtok o] LT";case 5:return"[v piatok o] LT";case 6:return"[v sobotu o] LT"}},lastDay:"[včera o] LT",lastWeek:function(){switch(this.day()){case 0:return"[minulú nedeľu o] LT";case 1:case 2:return"[minulý] dddd [o] LT";case 3:return"[minulú stredu o] LT";case 4:case 5:return"[minulý] dddd [o] LT";case 6:return"[minulú sobotu o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"pred %s",s:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"m":return withoutSuffix?"ena minuta":"eno minuto";case"mm":if(number===1){result+="minuta"}else if(number===2){result+="minuti"}else if(number===3||number===4){result+="minute"}else{result+="minut"}return result;case"h":return withoutSuffix?"ena ura":"eno uro";case"hh":if(number===1){result+="ura"}else if(number===2){result+="uri"}else if(number===3||number===4){result+="ure"}else{result+="ur"}return result;case"dd":if(number===1){result+="dan"}else{result+="dni"}return result;case"MM":if(number===1){result+="mesec"}else if(number===2){result+="meseca"}else if(number===3||number===4){result+="mesece"}else{result+="mesecev"}return result;case"yy":if(number===1){result+="leto"}else if(number===2){result+="leti"}else if(number===3||number===4){result+="leta"}else{result+="let"}return result}}return moment.lang("sl",{months:"januar_februar_marec_april_maj_junij_julij_avgust_september_oktober_november_december".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._avg._sep._okt._nov._dec.".split("_"),weekdays:"nedelja_ponedeljek_torek_sreda_četrtek_petek_sobota".split("_"),weekdaysShort:"ned._pon._tor._sre._čet._pet._sob.".split("_"),weekdaysMin:"ne_po_to_sr_če_pe_so".split("_"),longDateFormat:{LT:"H:mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[danes ob] LT",nextDay:"[jutri ob] LT",nextWeek:function(){switch(this.day()){case 0:return"[v] [nedeljo] [ob] LT";case 3:return"[v] [sredo] [ob] LT";case 6:return"[v] [soboto] [ob] LT";case 1:case 2:case 4:case 5:return"[v] dddd [ob] LT"}},lastDay:"[včeraj ob] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[prejšnja] dddd [ob] LT";case 1:case 2:case 4:case 5:return"[prejšnji] dddd [ob] LT"}},sameElse:"L"},relativeTime:{future:"čez %s",past:"%s nazaj",s:"nekaj sekund",m:translate,mm:translate,h:translate,hh:translate,d:"en dan",dd:translate,M:"en mesec",MM:translate,y:"eno leto",yy:translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("sq",{months:"Janar_Shkurt_Mars_Prill_Maj_Qershor_Korrik_Gusht_Shtator_Tetor_Nëntor_Dhjetor".split("_"),monthsShort:"Jan_Shk_Mar_Pri_Maj_Qer_Kor_Gus_Sht_Tet_Nën_Dhj".split("_"),weekdays:"E Diel_E Hënë_E Martë_E Mërkurë_E Enjte_E Premte_E Shtunë".split("_"),weekdaysShort:"Die_Hën_Mar_Mër_Enj_Pre_Sht".split("_"),weekdaysMin:"D_H_Ma_Më_E_P_Sh".split("_"),meridiem:function(hours,minutes,isLower){return hours<12?"PD":"MD"},longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Sot në] LT",nextDay:"[Nesër në] LT",nextWeek:"dddd [në] LT",lastDay:"[Dje në] LT",lastWeek:"dddd [e kaluar në] LT",sameElse:"L"},relativeTime:{future:"në %s",past:"%s më parë",s:"disa sekonda",m:"një minutë",mm:"%d minuta",h:"një orë",hh:"%d orë",d:"një ditë",dd:"%d ditë",M:"një muaj",MM:"%d muaj",y:"një vit",yy:"%d vite"},ordinal:"%d.",week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var translator={words:{m:["један минут","једне минуте"],mm:["минут","минуте","минута"],h:["један сат","једног сата"],hh:["сат","сата","сати"],dd:["дан","дана","дана"],MM:["месец","месеца","месеци"],yy:["година","године","година"]},correctGrammaticalCase:function(number,wordKey){return number===1?wordKey[0]:number>=2&&number<=4?wordKey[1]:wordKey[2]},translate:function(number,withoutSuffix,key){var wordKey=translator.words[key];if(key.length===1){return withoutSuffix?wordKey[0]:wordKey[1]}else{return number+" "+translator.correctGrammaticalCase(number,wordKey)}}};return moment.lang("sr-cyr",{months:["јануар","фебруар","март","април","мај","јун","јул","август","септембар","октобар","новембар","децембар"],monthsShort:["јан.","феб.","мар.","апр.","мај","јун","јул","авг.","сеп.","окт.","нов.","дец."],weekdays:["недеља","понедељак","уторак","среда","четвртак","петак","субота"],weekdaysShort:["нед.","пон.","уто.","сре.","чет.","пет.","суб."],weekdaysMin:["не","по","ут","ср","че","пе","су"],longDateFormat:{LT:"H:mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[данас у] LT",nextDay:"[сутра у] LT",nextWeek:function(){switch(this.day()){case 0:return"[у] [недељу] [у] LT";case 3:return"[у] [среду] [у] LT";case 6:return"[у] [суботу] [у] LT";case 1:case 2:case 4:case 5:return"[у] dddd [у] LT"}},lastDay:"[јуче у] LT",lastWeek:function(){var lastWeekDays=["[прошле] [недеље] [у] LT","[прошлог] [понедељка] [у] LT","[прошлог] [уторка] [у] LT","[прошле] [среде] [у] LT","[прошлог] [четвртка] [у] LT","[прошлог] [петка] [у] LT","[прошле] [суботе] [у] LT"];return lastWeekDays[this.day()]},sameElse:"L"},relativeTime:{future:"за %s",past:"пре %s",s:"неколико секунди",m:translator.translate,mm:translator.translate,h:translator.translate,hh:translator.translate,d:"дан",dd:translator.translate,M:"месец",MM:translator.translate,y:"годину",yy:translator.translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){var translator={words:{m:["jedan minut","jedne minute"],mm:["minut","minute","minuta"],h:["jedan sat","jednog sata"],hh:["sat","sata","sati"],dd:["dan","dana","dana"],MM:["mesec","meseca","meseci"],yy:["godina","godine","godina"]},correctGrammaticalCase:function(number,wordKey){return number===1?wordKey[0]:number>=2&&number<=4?wordKey[1]:wordKey[2]},translate:function(number,withoutSuffix,key){var wordKey=translator.words[key];if(key.length===1){return withoutSuffix?wordKey[0]:wordKey[1]}else{return number+" "+translator.correctGrammaticalCase(number,wordKey)}}};return moment.lang("sr",{months:["januar","februar","mart","april","maj","jun","jul","avgust","septembar","oktobar","novembar","decembar"],monthsShort:["jan.","feb.","mar.","apr.","maj","jun","jul","avg.","sep.","okt.","nov.","dec."],weekdays:["nedelja","ponedeljak","utorak","sreda","četvrtak","petak","subota"],weekdaysShort:["ned.","pon.","uto.","sre.","čet.","pet.","sub."],weekdaysMin:["ne","po","ut","sr","če","pe","su"],longDateFormat:{LT:"H:mm",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY LT",LLLL:"dddd, D. MMMM YYYY LT"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedelju] [u] LT";case 3:return"[u] [sredu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[juče u] LT",lastWeek:function(){var lastWeekDays=["[prošle] [nedelje] [u] LT","[prošlog] [ponedeljka] [u] LT","[prošlog] [utorka] [u] LT","[prošle] [srede] [u] LT","[prošlog] [četvrtka] [u] LT","[prošlog] [petka] [u] LT","[prošle] [subote] [u] LT"];return lastWeekDays[this.day()]},sameElse:"L"},relativeTime:{future:"za %s",past:"pre %s",s:"nekoliko sekundi",m:translator.translate,mm:translator.translate,h:translator.translate,hh:translator.translate,d:"dan",dd:translator.translate,M:"mesec",MM:translator.translate,y:"godinu",yy:translator.translate},ordinal:"%d.",week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("sv",{months:"januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"söndag_måndag_tisdag_onsdag_torsdag_fredag_lördag".split("_"),weekdaysShort:"sön_mån_tis_ons_tor_fre_lör".split("_"),weekdaysMin:"sö_må_ti_on_to_fr_lö".split("_"),longDateFormat:{LT:"HH:mm",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[Idag] LT",nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"dddd LT",lastWeek:"[Förra] dddd[en] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"för %s sedan",s:"några sekunder",m:"en minut",mm:"%d minuter",h:"en timme",hh:"%d timmar",d:"en dag",dd:"%d dagar",M:"en månad",MM:"%d månader",y:"ett år",yy:"%d år"},ordinal:function(number){var b=number%10,output=~~(number%100/10)===1?"e":b===1?"a":b===2?"a":b===3?"e":"e";return number+output},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("ta",{months:"ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்".split("_"),monthsShort:"ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்".split("_"),weekdays:"ஞாயிற்றுக்கிழமை_திங்கட்கிழமை_செவ்வாய்கிழமை_புதன்கிழமை_வியாழக்கிழமை_வெள்ளிக்கிழமை_சனிக்கிழமை".split("_"),weekdaysShort:"ஞாயிறு_திங்கள்_செவ்வாய்_புதன்_வியாழன்_வெள்ளி_சனி".split("_"),weekdaysMin:"ஞா_தி_செ_பு_வி_வெ_ச".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, LT",LLLL:"dddd, D MMMM YYYY, LT"},calendar:{sameDay:"[இன்று] LT",nextDay:"[நாளை] LT",nextWeek:"dddd, LT",lastDay:"[நேற்று] LT",lastWeek:"[கடந்த வாரம்] dddd, LT",sameElse:"L"},relativeTime:{future:"%s இல்",past:"%s முன்",s:"ஒரு சில விநாடிகள்",m:"ஒரு நிமிடம்",mm:"%d நிமிடங்கள்",h:"ஒரு மணி நேரம்",hh:"%d மணி நேரம்",d:"ஒரு நாள்",dd:"%d நாட்கள்",M:"ஒரு மாதம்",MM:"%d மாதங்கள்",y:"ஒரு வருடம்",yy:"%d ஆண்டுகள்"},ordinal:function(number){return number+"வது"},meridiem:function(hour,minute,isLower){if(hour>=6&&hour<=10){return" காலை"}else if(hour>=10&&hour<=14){return" நண்பகல்"}else if(hour>=14&&hour<=18){return" எற்பாடு"}else if(hour>=18&&hour<=20){return" மாலை"}else if(hour>=20&&hour<=24){return" இரவு"}else if(hour>=0&&hour<=6){return" வைகறை"}},week:{dow:0,doy:6}})});(function(factory){factory(moment)})(function(moment){return moment.lang("th",{months:"มกราคม_กุมภาพันธ์_มีนาคม_เมษายน_พฤษภาคม_มิถุนายน_กรกฎาคม_สิงหาคม_กันยายน_ตุลาคม_พฤศจิกายน_ธันวาคม".split("_"),monthsShort:"มกรา_กุมภา_มีนา_เมษา_พฤษภา_มิถุนา_กรกฎา_สิงหา_กันยา_ตุลา_พฤศจิกา_ธันวา".split("_"),weekdays:"อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัสบดี_ศุกร์_เสาร์".split("_"),weekdaysShort:"อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัส_ศุกร์_เสาร์".split("_"),weekdaysMin:"อา._จ._อ._พ._พฤ._ศ._ส.".split("_"),longDateFormat:{LT:"H นาฬิกา m นาที",L:"YYYY/MM/DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY เวลา LT",LLLL:"วันddddที่ D MMMM YYYY เวลา LT"},meridiem:function(hour,minute,isLower){if(hour<12){return"ก่อนเที่ยง"}else{return"หลังเที่ยง"}},calendar:{sameDay:"[วันนี้ เวลา] LT",nextDay:"[พรุ่งนี้ เวลา] LT",nextWeek:"dddd[หน้า เวลา] LT",lastDay:"[เมื่อวานนี้ เวลา] LT",lastWeek:"[วัน]dddd[ที่แล้ว เวลา] LT",sameElse:"L"},relativeTime:{future:"อีก %s",past:"%sที่แล้ว",s:"ไม่กี่วินาที",m:"1 นาที",mm:"%d นาที",h:"1 ชั่วโมง",hh:"%d ชั่วโมง",d:"1 วัน",dd:"%d วัน",M:"1 เดือน",MM:"%d เดือน",y:"1 ปี",yy:"%d ปี"}})});(function(factory){factory(moment)})(function(moment){return moment.lang("tl-ph",{months:"Enero_Pebrero_Marso_Abril_Mayo_Hunyo_Hulyo_Agosto_Setyembre_Oktubre_Nobyembre_Disyembre".split("_"),monthsShort:"Ene_Peb_Mar_Abr_May_Hun_Hul_Ago_Set_Okt_Nob_Dis".split("_"),weekdays:"Linggo_Lunes_Martes_Miyerkules_Huwebes_Biyernes_Sabado".split("_"),weekdaysShort:"Lin_Lun_Mar_Miy_Huw_Biy_Sab".split("_"),weekdaysMin:"Li_Lu_Ma_Mi_Hu_Bi_Sab".split("_"),longDateFormat:{LT:"HH:mm",L:"MM/D/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY LT",LLLL:"dddd, MMMM DD, YYYY LT"},calendar:{sameDay:"[Ngayon sa] LT",nextDay:"[Bukas sa] LT",nextWeek:"dddd [sa] LT",lastDay:"[Kahapon sa] LT",lastWeek:"dddd [huling linggo] LT",sameElse:"L"},relativeTime:{future:"sa loob ng %s",past:"%s ang nakalipas",s:"ilang segundo",m:"isang minuto",mm:"%d minuto",h:"isang oras",hh:"%d oras",d:"isang araw",dd:"%d araw",M:"isang buwan",MM:"%d buwan",y:"isang taon",yy:"%d taon"},ordinal:function(number){return number},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){var suffixes={1:"'inci",5:"'inci",8:"'inci",70:"'inci",80:"'inci",2:"'nci",7:"'nci",20:"'nci",50:"'nci",3:"'üncü",4:"'üncü",100:"'üncü",6:"'ncı",9:"'uncu",10:"'uncu",30:"'uncu",60:"'ıncı",90:"'ıncı"};return moment.lang("tr",{months:"Ocak_Şubat_Mart_Nisan_Mayıs_Haziran_Temmuz_Ağustos_Eylül_Ekim_Kasım_Aralık".split("_"),monthsShort:"Oca_Şub_Mar_Nis_May_Haz_Tem_Ağu_Eyl_Eki_Kas_Ara".split("_"),weekdays:"Pazar_Pazartesi_Salı_Çarşamba_Perşembe_Cuma_Cumartesi".split("_"),weekdaysShort:"Paz_Pts_Sal_Çar_Per_Cum_Cts".split("_"),weekdaysMin:"Pz_Pt_Sa_Ça_Pe_Cu_Ct".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[bugün saat] LT",nextDay:"[yarın saat] LT",nextWeek:"[haftaya] dddd [saat] LT",lastDay:"[dün] LT",lastWeek:"[geçen hafta] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s sonra",past:"%s önce",s:"birkaç saniye",m:"bir dakika",mm:"%d dakika",h:"bir saat",hh:"%d saat",d:"bir gün",dd:"%d gün",M:"bir ay",MM:"%d ay",y:"bir yıl",yy:"%d yıl"},ordinal:function(number){if(number===0){return number+"'ıncı"}var a=number%10,b=number%100-a,c=number>=100?100:null;return number+(suffixes[a]||suffixes[b]||suffixes[c])},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("tzm-la",{months:"innayr_brˤayrˤ_marˤsˤ_ibrir_mayyw_ywnyw_ywlywz_ɣwšt_šwtanbir_ktˤwbrˤ_nwwanbir_dwjnbir".split("_"),monthsShort:"innayr_brˤayrˤ_marˤsˤ_ibrir_mayyw_ywnyw_ywlywz_ɣwšt_šwtanbir_ktˤwbrˤ_nwwanbir_dwjnbir".split("_"),weekdays:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),weekdaysShort:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),weekdaysMin:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[asdkh g] LT",nextDay:"[aska g] LT",nextWeek:"dddd [g] LT",lastDay:"[assant g] LT",lastWeek:"dddd [g] LT",sameElse:"L"},relativeTime:{future:"dadkh s yan %s",past:"yan %s",s:"imik",m:"minuḍ",mm:"%d minuḍ",h:"saɛa",hh:"%d tassaɛin",d:"ass",dd:"%d ossan",M:"ayowr",MM:"%d iyyirn",y:"asgas",yy:"%d isgasn"},week:{dow:6,doy:12}})});(function(factory){factory(moment)})(function(moment){return moment.lang("tzm",{months:"ⵉⵏⵏⴰⵢⵔ_ⴱⵕⴰⵢⵕ_ⵎⴰⵕⵚ_ⵉⴱⵔⵉⵔ_ⵎⴰⵢⵢⵓ_ⵢⵓⵏⵢⵓ_ⵢⵓⵍⵢⵓⵣ_ⵖⵓⵛⵜ_ⵛⵓⵜⴰⵏⴱⵉⵔ_ⴽⵟⵓⴱⵕ_ⵏⵓⵡⴰⵏⴱⵉⵔ_ⴷⵓⵊⵏⴱⵉⵔ".split("_"),monthsShort:"ⵉⵏⵏⴰⵢⵔ_ⴱⵕⴰⵢⵕ_ⵎⴰⵕⵚ_ⵉⴱⵔⵉⵔ_ⵎⴰⵢⵢⵓ_ⵢⵓⵏⵢⵓ_ⵢⵓⵍⵢⵓⵣ_ⵖⵓⵛⵜ_ⵛⵓⵜⴰⵏⴱⵉⵔ_ⴽⵟⵓⴱⵕ_ⵏⵓⵡⴰⵏⴱⵉⵔ_ⴷⵓⵊⵏⴱⵉⵔ".split("_"),weekdays:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),weekdaysShort:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),weekdaysMin:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[ⴰⵙⴷⵅ ⴴ] LT",nextDay:"[ⴰⵙⴽⴰ ⴴ] LT",nextWeek:"dddd [ⴴ] LT",lastDay:"[ⴰⵚⴰⵏⵜ ⴴ] LT",lastWeek:"dddd [ⴴ] LT",sameElse:"L"},relativeTime:{future:"ⴷⴰⴷⵅ ⵙ ⵢⴰⵏ %s",past:"ⵢⴰⵏ %s",s:"ⵉⵎⵉⴽ",m:"ⵎⵉⵏⵓⴺ",mm:"%d ⵎⵉⵏⵓⴺ",h:"ⵙⴰⵄⴰ",hh:"%d ⵜⴰⵙⵙⴰⵄⵉⵏ",d:"ⴰⵙⵙ",dd:"%d oⵙⵙⴰⵏ",M:"ⴰⵢoⵓⵔ",MM:"%d ⵉⵢⵢⵉⵔⵏ",y:"ⴰⵙⴳⴰⵙ",yy:"%d ⵉⵙⴳⴰⵙⵏ"},week:{dow:6,doy:12}})});(function(factory){factory(moment)})(function(moment){function plural(word,num){var forms=word.split("_");return num%10===1&&num%100!==11?forms[0]:num%10>=2&&num%10<=4&&(num%100<10||num%100>=20)?forms[1]:forms[2]}function relativeTimeWithPlural(number,withoutSuffix,key){var format={mm:"хвилина_хвилини_хвилин",hh:"година_години_годин",dd:"день_дні_днів",MM:"місяць_місяці_місяців",yy:"рік_роки_років"};if(key==="m"){return withoutSuffix?"хвилина":"хвилину"}else if(key==="h"){return withoutSuffix?"година":"годину"}else{return number+" "+plural(format[key],+number)}}function monthsCaseReplace(m,format){var months={nominative:"січень_лютий_березень_квітень_травень_червень_липень_серпень_вересень_жовтень_листопад_грудень".split("_"),accusative:"січня_лютого_березня_квітня_травня_червня_липня_серпня_вересня_жовтня_листопада_грудня".split("_")},nounCase=/D[oD]? *MMMM?/.test(format)?"accusative":"nominative";return months[nounCase][m.month()]}function weekdaysCaseReplace(m,format){var weekdays={nominative:"неділя_понеділок_вівторок_середа_четвер_п’ятниця_субота".split("_"),accusative:"неділю_понеділок_вівторок_середу_четвер_п’ятницю_суботу".split("_"),genitive:"неділі_понеділка_вівторка_середи_четверга_п’ятниці_суботи".split("_")},nounCase=/(\[[ВвУу]\]) ?dddd/.test(format)?"accusative":/\[?(?:минулої|наступної)? ?\] ?dddd/.test(format)?"genitive":"nominative";return weekdays[nounCase][m.day()]}function processHoursFunction(str){return function(){return str+"о"+(this.hours()===11?"б":"")+"] LT"}}return moment.lang("uk",{months:monthsCaseReplace,monthsShort:"січ_лют_бер_квіт_трав_черв_лип_серп_вер_жовт_лист_груд".split("_"),weekdays:weekdaysCaseReplace,weekdaysShort:"нд_пн_вт_ср_чт_пт_сб".split("_"),weekdaysMin:"нд_пн_вт_ср_чт_пт_сб".split("_"),longDateFormat:{LT:"HH:mm",L:"DD.MM.YYYY",LL:"D MMMM YYYY р.",LLL:"D MMMM YYYY р., LT",LLLL:"dddd, D MMMM YYYY р., LT"},calendar:{sameDay:processHoursFunction("[Сьогодні "),nextDay:processHoursFunction("[Завтра "),lastDay:processHoursFunction("[Вчора "),nextWeek:processHoursFunction("[У] dddd ["),lastWeek:function(){switch(this.day()){case 0:case 3:case 5:case 6:return processHoursFunction("[Минулої] dddd [").call(this);case 1:case 2:case 4:return processHoursFunction("[Минулого] dddd [").call(this)}},sameElse:"L"},relativeTime:{future:"за %s",past:"%s тому",s:"декілька секунд",m:relativeTimeWithPlural,mm:relativeTimeWithPlural,h:"годину",hh:relativeTimeWithPlural,d:"день",dd:relativeTimeWithPlural,M:"місяць",MM:relativeTimeWithPlural,y:"рік",yy:relativeTimeWithPlural},meridiem:function(hour,minute,isLower){if(hour<4){return"ночі"}else if(hour<12){return"ранку"}else if(hour<17){return"дня"}else{return"вечора"}},ordinal:function(number,period){switch(period){case"M":case"d":case"DDD":case"w":case"W":return number+"-й";case"D":return number+"-го";default:return number}},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("uz",{months:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),monthsShort:"янв_фев_мар_апр_май_июн_июл_авг_сен_окт_ноя_дек".split("_"),weekdays:"Якшанба_Душанба_Сешанба_Чоршанба_Пайшанба_Жума_Шанба".split("_"),weekdaysShort:"Якш_Душ_Сеш_Чор_Пай_Жум_Шан".split("_"),weekdaysMin:"Як_Ду_Се_Чо_Па_Жу_Ша".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"D MMMM YYYY, dddd LT"},calendar:{sameDay:"[Бугун соат] LT [да]",nextDay:"[Эртага] LT [да]",nextWeek:"dddd [куни соат] LT [да]",lastDay:"[Кеча соат] LT [да]",lastWeek:"[Утган] dddd [куни соат] LT [да]",sameElse:"L"},relativeTime:{future:"Якин %s ичида",past:"Бир неча %s олдин",s:"фурсат",m:"бир дакика",mm:"%d дакика",h:"бир соат",hh:"%d соат",d:"бир кун",dd:"%d кун",M:"бир ой",MM:"%d ой",y:"бир йил",yy:"%d йил"},week:{dow:1,doy:7}})});(function(factory){factory(moment)})(function(moment){return moment.lang("vi",{months:"tháng 1_tháng 2_tháng 3_tháng 4_tháng 5_tháng 6_tháng 7_tháng 8_tháng 9_tháng 10_tháng 11_tháng 12".split("_"),monthsShort:"Th01_Th02_Th03_Th04_Th05_Th06_Th07_Th08_Th09_Th10_Th11_Th12".split("_"),weekdays:"chủ nhật_thứ hai_thứ ba_thứ tư_thứ năm_thứ sáu_thứ bảy".split("_"),weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM [năm] YYYY",LLL:"D MMMM [năm] YYYY LT",LLLL:"dddd, D MMMM [năm] YYYY LT",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY LT",llll:"ddd, D MMM YYYY LT"},calendar:{sameDay:"[Hôm nay lúc] LT",nextDay:"[Ngày mai lúc] LT",nextWeek:"dddd [tuần tới lúc] LT",lastDay:"[Hôm qua lúc] LT",lastWeek:"dddd [tuần rồi lúc] LT",sameElse:"L"},relativeTime:{future:"%s tới",past:"%s trước",s:"vài giây",m:"một phút",mm:"%d phút",h:"một giờ",hh:"%d giờ",d:"một ngày",dd:"%d ngày",M:"một tháng",MM:"%d tháng",y:"một năm",yy:"%d năm"},ordinal:function(number){return number},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("zh-cn",{months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),longDateFormat:{LT:"Ah点mm",L:"YYYY-MM-DD",LL:"YYYY年MMMD日",LLL:"YYYY年MMMD日LT",LLLL:"YYYY年MMMD日ddddLT",l:"YYYY-MM-DD",ll:"YYYY年MMMD日",lll:"YYYY年MMMD日LT",llll:"YYYY年MMMD日ddddLT"},meridiem:function(hour,minute,isLower){var hm=hour*100+minute;if(hm<600){return"凌晨"}else if(hm<900){return"早上"}else if(hm<1130){return"上午"}else if(hm<1230){return"中午"}else if(hm<1800){return"下午"}else{return"晚上"}},calendar:{sameDay:function(){return this.minutes()===0?"[今天]Ah[点整]":"[今天]LT"},nextDay:function(){return this.minutes()===0?"[明天]Ah[点整]":"[明天]LT"},lastDay:function(){return this.minutes()===0?"[昨天]Ah[点整]":"[昨天]LT"},nextWeek:function(){var startOfWeek,prefix;startOfWeek=moment().startOf("week");prefix=this.unix()-startOfWeek.unix()>=7*24*3600?"[下]":"[本]";return this.minutes()===0?prefix+"dddAh点整":prefix+"dddAh点mm"},lastWeek:function(){var startOfWeek,prefix;startOfWeek=moment().startOf("week");prefix=this.unix()<startOfWeek.unix()?"[上]":"[本]";return this.minutes()===0?prefix+"dddAh点整":prefix+"dddAh点mm"},sameElse:"LL"},ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"日";case"M":return number+"月";case"w":case"W":return number+"周";default:return number}},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1分钟",mm:"%d分钟",h:"1小时",hh:"%d小时",d:"1天",dd:"%d天",M:"1个月",MM:"%d个月",y:"1年",yy:"%d年"},week:{dow:1,doy:4}})});(function(factory){factory(moment)})(function(moment){return moment.lang("zh-tw",{months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"週日_週一_週二_週三_週四_週五_週六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),longDateFormat:{LT:"Ah點mm",L:"YYYY年MMMD日",LL:"YYYY年MMMD日",LLL:"YYYY年MMMD日LT",LLLL:"YYYY年MMMD日ddddLT",l:"YYYY年MMMD日",ll:"YYYY年MMMD日",lll:"YYYY年MMMD日LT",llll:"YYYY年MMMD日ddddLT"},meridiem:function(hour,minute,isLower){var hm=hour*100+minute;if(hm<900){return"早上"}else if(hm<1130){return"上午"}else if(hm<1230){return"中午"}else if(hm<1800){return"下午"}else{return"晚上"}},calendar:{sameDay:"[今天]LT",nextDay:"[明天]LT",nextWeek:"[下]ddddLT",lastDay:"[昨天]LT",lastWeek:"[上]ddddLT",sameElse:"L"},ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"日";case"M":return number+"月";case"w":case"W":return number+"週";default:return number}},relativeTime:{future:"%s內",past:"%s前",s:"幾秒",m:"一分鐘",mm:"%d分鐘",h:"一小時",hh:"%d小時",d:"一天",dd:"%d天",M:"一個月",MM:"%d個月",y:"一年",yy:"%d年"}})});moment.lang("en");function makeGlobal(shouldDeprecate){if(typeof ender!=="undefined"){return}oldGlobalMoment=globalScope.moment;if(shouldDeprecate){globalScope.moment=deprecate("Accessing Moment through the global scope is "+"deprecated, and will be removed in an upcoming "+"release.",moment)}else{globalScope.moment=moment}}if(hasModule){module.exports=moment}else if(typeof define==="function"&&define.amd){define("moment",function(require,exports,module){if(module.config&&module.config()&&module.config().noGlobal===true){globalScope.moment=oldGlobalMoment}return moment});makeGlobal(true)}else{makeGlobal()}}).call(this);(function(global,factory){if(typeof module==="object"&&typeof module.exports==="object"){module.exports=global.document?factory(global,true):function(w){if(!w.document){throw new Error("jQuery requires a window with a document")}return factory(w)}}else{factory(global)}})(typeof window!=="undefined"?window:this,function(window,noGlobal){var arr=[];var slice=arr.slice;var concat=arr.concat;var push=arr.push;var indexOf=arr.indexOf;var class2type={};var toString=class2type.toString;var hasOwn=class2type.hasOwnProperty;var support={};var document=window.document,version="2.1.1",jQuery=function(selector,context){return new jQuery.fn.init(selector,context)},rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,rmsPrefix=/^-ms-/,rdashAlpha=/-([\da-z])/gi,fcamelCase=function(all,letter){return letter.toUpperCase()};jQuery.fn=jQuery.prototype={jquery:version,constructor:jQuery,selector:"",length:0,toArray:function(){return slice.call(this)},get:function(num){return num!=null?num<0?this[num+this.length]:this[num]:slice.call(this)},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);ret.prevObject=this;ret.context=this.context;return ret},each:function(callback,args){return jQuery.each(this,callback,args)},map:function(callback){return this.pushStack(jQuery.map(this,function(elem,i){return callback.call(elem,i,elem)}))},slice:function(){return this.pushStack(slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:push,sort:arr.sort,splice:arr.splice};jQuery.extend=jQuery.fn.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[i]||{};i++}if(typeof target!=="object"&&!jQuery.isFunction(target)){target={}}if(i===length){target=this;i--}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&jQuery.isArray(src)?src:[]}else{clone=src&&jQuery.isPlainObject(src)?src:{}}target[name]=jQuery.extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target};jQuery.extend({expando:"jQuery"+(version+Math.random()).replace(/\D/g,""),isReady:true,error:function(msg){throw new Error(msg)},noop:function(){},isFunction:function(obj){return jQuery.type(obj)==="function"},isArray:Array.isArray,isWindow:function(obj){return obj!=null&&obj===obj.window},isNumeric:function(obj){return!jQuery.isArray(obj)&&obj-parseFloat(obj)>=0},isPlainObject:function(obj){if(jQuery.type(obj)!=="object"||obj.nodeType||jQuery.isWindow(obj)){return false}if(obj.constructor&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf")){return false}return true},isEmptyObject:function(obj){var name;for(name in obj){return false}return true},type:function(obj){if(obj==null){return obj+""}return typeof obj==="object"||typeof obj==="function"?class2type[toString.call(obj)]||"object":typeof obj},globalEval:function(code){var script,indirect=eval;code=jQuery.trim(code);if(code){if(code.indexOf("use strict")===1){script=document.createElement("script");script.text=code;document.head.appendChild(script).parentNode.removeChild(script)}else{indirect(code)}}},camelCase:function(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)},nodeName:function(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()},each:function(obj,callback,args){var value,i=0,length=obj.length,isArray=isArraylike(obj);if(args){if(isArray){for(;i<length;i++){value=callback.apply(obj[i],args);if(value===false){break}}}else{for(i in obj){value=callback.apply(obj[i],args);if(value===false){break}}}}else{if(isArray){for(;i<length;i++){value=callback.call(obj[i],i,obj[i]);if(value===false){break}}}else{for(i in obj){value=callback.call(obj[i],i,obj[i]);if(value===false){break}}}}return obj},trim:function(text){return text==null?"":(text+"").replace(rtrim,"")},makeArray:function(arr,results){var ret=results||[];if(arr!=null){if(isArraylike(Object(arr))){jQuery.merge(ret,typeof arr==="string"?[arr]:arr)}else{push.call(ret,arr)}}return ret},inArray:function(elem,arr,i){return arr==null?-1:indexOf.call(arr,elem,i)},merge:function(first,second){var len=+second.length,j=0,i=first.length;for(;j<len;j++){first[i++]=second[j]}first.length=i;return first},grep:function(elems,callback,invert){var callbackInverse,matches=[],i=0,length=elems.length,callbackExpect=!invert;for(;i<length;i++){callbackInverse=!callback(elems[i],i);if(callbackInverse!==callbackExpect){matches.push(elems[i])}}return matches},map:function(elems,callback,arg){var value,i=0,length=elems.length,isArray=isArraylike(elems),ret=[];if(isArray){for(;i<length;i++){value=callback(elems[i],i,arg);if(value!=null){ret.push(value)}}}else{for(i in elems){value=callback(elems[i],i,arg);if(value!=null){ret.push(value)}}}return concat.apply([],ret)},guid:1,proxy:function(fn,context){var tmp,args,proxy;if(typeof context==="string"){tmp=fn[context];context=fn;fn=tmp}if(!jQuery.isFunction(fn)){return undefined}args=slice.call(arguments,2);proxy=function(){return fn.apply(context||this,args.concat(slice.call(arguments)))};proxy.guid=fn.guid=fn.guid||jQuery.guid++;return proxy},now:Date.now,support:support});jQuery.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(i,name){class2type["[object "+name+"]"]=name.toLowerCase()});function isArraylike(obj){var length=obj.length,type=jQuery.type(obj);if(type==="function"||jQuery.isWindow(obj)){return false}if(obj.nodeType===1&&length){return true}return type==="array"||length===0||typeof length==="number"&&length>0&&length-1 in obj}var Sizzle=function(window){var i,support,Expr,getText,isXML,tokenize,compile,select,outermostContext,sortInput,hasDuplicate,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+-new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),sortOrder=function(a,b){if(a===b){hasDuplicate=true}return 0},strundefined=typeof undefined,MAX_NEGATIVE=1<<31,hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,push_native=arr.push,push=arr.push,slice=arr.slice,indexOf=arr.indexOf||function(elem){var i=0,len=this.length;for(;i<len;i++){if(this[i]===elem){return i}}return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",characterEncoding="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",identifier=characterEncoding.replace("w","w#"),attributes="\\["+whitespace+"*("+characterEncoding+")(?:"+whitespace+"*([*^$|!~]?=)"+whitespace+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+identifier+"))|)"+whitespace+"*\\]",pseudos=":("+characterEncoding+")(?:\\(("+"('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|"+"((?:\\\\.|[^\\\\()[\\]]|"+attributes+")*)|"+".*"+")\\)|)",rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rattributeQuotes=new RegExp("="+whitespace+"*([^\\]'\"]*?)"+whitespace+"*\\]","g"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={ID:new RegExp("^#("+characterEncoding+")"),CLASS:new RegExp("^\\.("+characterEncoding+")"),TAG:new RegExp("^("+characterEncoding.replace("w","w*")+")"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rsibling=/[+~]/,rescape=/'|\\/g,runescape=new RegExp("\\\\([\\da-f]{1,6}"+whitespace+"?|("+whitespace+")|.)","ig"),funescape=function(_,escaped,escapedWhitespace){var high="0x"+escaped-65536;
return high!==high||escapedWhitespace?escaped:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,high&1023|56320)};try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes);arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){push_native.apply(target,slice.call(els))}:function(target,els){var j=target.length,i=0;while(target[j++]=els[i++]){}target.length=j-1}}}function Sizzle(selector,context,results,seed){var match,elem,m,nodeType,i,groups,old,nid,newContext,newSelector;if((context?context.ownerDocument||context:preferredDoc)!==document){setDocument(context)}context=context||document;results=results||[];if(!selector||typeof selector!=="string"){return results}if((nodeType=context.nodeType)!==1&&nodeType!==9){return[]}if(documentIsHTML&&!seed){if(match=rquickExpr.exec(selector)){if(m=match[1]){if(nodeType===9){elem=context.getElementById(m);if(elem&&elem.parentNode){if(elem.id===m){results.push(elem);return results}}else{return results}}else{if(context.ownerDocument&&(elem=context.ownerDocument.getElementById(m))&&contains(context,elem)&&elem.id===m){results.push(elem);return results}}}else if(match[2]){push.apply(results,context.getElementsByTagName(selector));return results}else if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName){push.apply(results,context.getElementsByClassName(m));return results}}if(support.qsa&&(!rbuggyQSA||!rbuggyQSA.test(selector))){nid=old=expando;newContext=context;newSelector=nodeType===9&&selector;if(nodeType===1&&context.nodeName.toLowerCase()!=="object"){groups=tokenize(selector);if(old=context.getAttribute("id")){nid=old.replace(rescape,"\\$&")}else{context.setAttribute("id",nid)}nid="[id='"+nid+"'] ";i=groups.length;while(i--){groups[i]=nid+toSelector(groups[i])}newContext=rsibling.test(selector)&&testContext(context.parentNode)||context;newSelector=groups.join(",")}if(newSelector){try{push.apply(results,newContext.querySelectorAll(newSelector));return results}catch(qsaError){}finally{if(!old){context.removeAttribute("id")}}}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){var keys=[];function cache(key,value){if(keys.push(key+" ")>Expr.cacheLength){delete cache[keys.shift()]}return cache[key+" "]=value}return cache}function markFunction(fn){fn[expando]=true;return fn}function assert(fn){var div=document.createElement("div");try{return!!fn(div)}catch(e){return false}finally{if(div.parentNode){div.parentNode.removeChild(div)}div=null}}function addHandle(attrs,handler){var arr=attrs.split("|"),i=attrs.length;while(i--){Expr.attrHandle[arr[i]]=handler}}function siblingCheck(a,b){var cur=b&&a,diff=cur&&a.nodeType===1&&b.nodeType===1&&(~b.sourceIndex||MAX_NEGATIVE)-(~a.sourceIndex||MAX_NEGATIVE);if(diff){return diff}if(cur){while(cur=cur.nextSibling){if(cur===b){return-1}}}return a?1:-1}function createInputPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&elem.type===type}}function createButtonPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&elem.type===type}}function createPositionalPseudo(fn){return markFunction(function(argument){argument=+argument;return markFunction(function(seed,matches){var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;while(i--){if(seed[j=matchIndexes[i]]){seed[j]=!(matches[j]=seed[j])}}})})}function testContext(context){return context&&typeof context.getElementsByTagName!==strundefined&&context}support=Sizzle.support={};isXML=Sizzle.isXML=function(elem){var documentElement=elem&&(elem.ownerDocument||elem).documentElement;return documentElement?documentElement.nodeName!=="HTML":false};setDocument=Sizzle.setDocument=function(node){var hasCompare,doc=node?node.ownerDocument||node:preferredDoc,parent=doc.defaultView;if(doc===document||doc.nodeType!==9||!doc.documentElement){return document}document=doc;docElem=doc.documentElement;documentIsHTML=!isXML(doc);if(parent&&parent!==parent.top){if(parent.addEventListener){parent.addEventListener("unload",function(){setDocument()},false)}else if(parent.attachEvent){parent.attachEvent("onunload",function(){setDocument()})}}support.attributes=assert(function(div){div.className="i";return!div.getAttribute("className")});support.getElementsByTagName=assert(function(div){div.appendChild(doc.createComment(""));return!div.getElementsByTagName("*").length});support.getElementsByClassName=rnative.test(doc.getElementsByClassName)&&assert(function(div){div.innerHTML="<div class='a'></div><div class='a i'></div>";div.firstChild.className="i";return div.getElementsByClassName("i").length===2});support.getById=assert(function(div){docElem.appendChild(div).id=expando;return!doc.getElementsByName||!doc.getElementsByName(expando).length});if(support.getById){Expr.find["ID"]=function(id,context){if(typeof context.getElementById!==strundefined&&documentIsHTML){var m=context.getElementById(id);return m&&m.parentNode?[m]:[]}};Expr.filter["ID"]=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId}}}else{delete Expr.find["ID"];Expr.filter["ID"]=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=typeof elem.getAttributeNode!==strundefined&&elem.getAttributeNode("id");return node&&node.value===attrId}}}Expr.find["TAG"]=support.getElementsByTagName?function(tag,context){if(typeof context.getElementsByTagName!==strundefined){return context.getElementsByTagName(tag)}}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if(tag==="*"){while(elem=results[i++]){if(elem.nodeType===1){tmp.push(elem)}}return tmp}return results};Expr.find["CLASS"]=support.getElementsByClassName&&function(className,context){if(typeof context.getElementsByClassName!==strundefined&&documentIsHTML){return context.getElementsByClassName(className)}};rbuggyMatches=[];rbuggyQSA=[];if(support.qsa=rnative.test(doc.querySelectorAll)){assert(function(div){div.innerHTML="<select msallowclip=''><option selected=''></option></select>";if(div.querySelectorAll("[msallowclip^='']").length){rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")")}if(!div.querySelectorAll("[selected]").length){rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")")}if(!div.querySelectorAll(":checked").length){rbuggyQSA.push(":checked")}});assert(function(div){var input=doc.createElement("input");input.setAttribute("type","hidden");div.appendChild(input).setAttribute("name","D");if(div.querySelectorAll("[name=d]").length){rbuggyQSA.push("name"+whitespace+"*[*^$|!~]?=")}if(!div.querySelectorAll(":enabled").length){rbuggyQSA.push(":enabled",":disabled")}div.querySelectorAll("*,:x");rbuggyQSA.push(",.*:")})}if(support.matchesSelector=rnative.test(matches=docElem.matches||docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector)){assert(function(div){support.disconnectedMatch=matches.call(div,"div");matches.call(div,"[s!='']:x");rbuggyMatches.push("!=",pseudos)})}rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|"));rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|"));hasCompare=rnative.test(docElem.compareDocumentPosition);contains=hasCompare||rnative.test(docElem.contains)?function(a,b){var adown=a.nodeType===9?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!!(bup&&bup.nodeType===1&&(adown.contains?adown.contains(bup):a.compareDocumentPosition&&a.compareDocumentPosition(bup)&16))}:function(a,b){if(b){while(b=b.parentNode){if(b===a){return true}}}return false};sortOrder=hasCompare?function(a,b){if(a===b){hasDuplicate=true;return 0}var compare=!a.compareDocumentPosition-!b.compareDocumentPosition;if(compare){return compare}compare=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1;if(compare&1||!support.sortDetached&&b.compareDocumentPosition(a)===compare){if(a===doc||a.ownerDocument===preferredDoc&&contains(preferredDoc,a)){return-1}if(b===doc||b.ownerDocument===preferredDoc&&contains(preferredDoc,b)){return 1}return sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0}return compare&4?-1:1}:function(a,b){if(a===b){hasDuplicate=true;return 0}var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(!aup||!bup){return a===doc?-1:b===doc?1:aup?-1:bup?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0}else if(aup===bup){return siblingCheck(a,b)}cur=a;while(cur=cur.parentNode){ap.unshift(cur)}cur=b;while(cur=cur.parentNode){bp.unshift(cur)}while(ap[i]===bp[i]){i++}return i?siblingCheck(ap[i],bp[i]):ap[i]===preferredDoc?-1:bp[i]===preferredDoc?1:0};return doc};Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)};Sizzle.matchesSelector=function(elem,expr){if((elem.ownerDocument||elem)!==document){setDocument(elem)}expr=expr.replace(rattributeQuotes,"='$1']");if(support.matchesSelector&&documentIsHTML&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr))){try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&elem.document.nodeType!==11){return ret}}catch(e){}}return Sizzle(expr,document,null,[elem]).length>0};Sizzle.contains=function(context,elem){if((context.ownerDocument||context)!==document){setDocument(context)}return contains(context,elem)};Sizzle.attr=function(elem,name){if((elem.ownerDocument||elem)!==document){setDocument(elem)}var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):undefined;return val!==undefined?val:support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null};Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)};Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;hasDuplicate=!support.detectDuplicates;sortInput=!support.sortStable&&results.slice(0);results.sort(sortOrder);if(hasDuplicate){while(elem=results[i++]){if(elem===results[i]){j=duplicates.push(i)}}while(j--){results.splice(duplicates[j],1)}}sortInput=null;return results};getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(!nodeType){while(node=elem[i++]){ret+=getText(node)}}else if(nodeType===1||nodeType===9||nodeType===11){if(typeof elem.textContent==="string"){return elem.textContent}else{for(elem=elem.firstChild;elem;elem=elem.nextSibling){ret+=getText(elem)}}}else if(nodeType===3||nodeType===4){return elem.nodeValue}return ret};Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:true}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:true},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){match[1]=match[1].replace(runescape,funescape);match[3]=(match[3]||match[4]||match[5]||"").replace(runescape,funescape);if(match[2]==="~="){match[3]=" "+match[3]+" "}return match.slice(0,4)},CHILD:function(match){match[1]=match[1].toLowerCase();if(match[1].slice(0,3)==="nth"){if(!match[3]){Sizzle.error(match[0])}match[4]=+(match[4]?match[5]+(match[6]||1):2*(match[3]==="even"||match[3]==="odd"));match[5]=+(match[7]+match[8]||match[3]==="odd")}else if(match[3]){Sizzle.error(match[0])}return match},PSEUDO:function(match){var excess,unquoted=!match[6]&&match[2];if(matchExpr["CHILD"].test(match[0])){return null}if(match[3]){match[2]=match[4]||match[5]||""}else if(unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,true))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)){match[0]=match[0].slice(0,excess);match[2]=unquoted.slice(0,excess)}return match.slice(0,3)}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return nodeNameSelector==="*"?function(){return true}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,function(elem){return pattern.test(typeof elem.className==="string"&&elem.className||typeof elem.getAttribute!==strundefined&&elem.getAttribute("class")||"")})},ATTR:function(name,operator,check){return function(elem){var result=Sizzle.attr(elem,name);if(result==null){return operator==="!="}if(!operator){return true}result+="";return operator==="="?result===check:operator==="!="?result!==check:operator==="^="?check&&result.indexOf(check)===0:operator==="*="?check&&result.indexOf(check)>-1:operator==="$="?check&&result.slice(-check.length)===check:operator==="~="?(" "+result+" ").indexOf(check)>-1:operator==="|="?result===check||result.slice(0,check.length+1)===check+"-":false}},CHILD:function(type,what,argument,first,last){var simple=type.slice(0,3)!=="nth",forward=type.slice(-4)!=="last",ofType=what==="of-type";return first===1&&last===0?function(elem){return!!elem.parentNode}:function(elem,context,xml){var cache,outerCache,node,diff,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType;if(parent){if(simple){while(dir){node=elem;while(node=node[dir]){if(ofType?node.nodeName.toLowerCase()===name:node.nodeType===1){return false}}start=dir=type==="only"&&!start&&"nextSibling"}return true}start=[forward?parent.firstChild:parent.lastChild];if(forward&&useCache){outerCache=parent[expando]||(parent[expando]={});cache=outerCache[type]||[];nodeIndex=cache[0]===dirruns&&cache[1];diff=cache[0]===dirruns&&cache[2];node=nodeIndex&&parent.childNodes[nodeIndex];while(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop()){if(node.nodeType===1&&++diff&&node===elem){outerCache[type]=[dirruns,nodeIndex,diff];break}}}else if(useCache&&(cache=(elem[expando]||(elem[expando]={}))[type])&&cache[0]===dirruns){diff=cache[1]}else{while(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop()){if((ofType?node.nodeName.toLowerCase()===name:node.nodeType===1)&&++diff){if(useCache){(node[expando]||(node[expando]={}))[type]=[dirruns,diff]}if(node===elem){break}}}}diff-=last;return diff===first||diff%first===0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);if(fn[expando]){return fn(argument)}if(fn.length>1){args=[pseudo,pseudo,"",argument];return Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction(function(seed,matches){var idx,matched=fn(seed,argument),i=matched.length;while(i--){idx=indexOf.call(seed,matched[i]);seed[idx]=!(matches[idx]=matched[i])}}):function(elem){return fn(elem,0,args)}}return fn}},pseudos:{not:markFunction(function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction(function(seed,matches,context,xml){var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;while(i--){if(elem=unmatched[i]){seed[i]=!(matches[i]=elem)}}}):function(elem,context,xml){input[0]=elem;matcher(input,null,xml,results);return!results.pop()}}),has:markFunction(function(selector){return function(elem){return Sizzle(selector,elem).length>0}}),contains:markFunction(function(text){return function(elem){return(elem.textContent||elem.innerText||getText(elem)).indexOf(text)>-1}}),lang:markFunction(function(lang){if(!ridentifier.test(lang||"")){Sizzle.error("unsupported lang: "+lang)}lang=lang.replace(runescape,funescape).toLowerCase();return function(elem){var elemLang;do{if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang")){elemLang=elemLang.toLowerCase();return elemLang===lang||elemLang.indexOf(lang+"-")===0}}while((elem=elem.parentNode)&&elem.nodeType===1);return false}}),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:function(elem){return elem.disabled===false},disabled:function(elem){return elem.disabled===true},checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return nodeName==="input"&&!!elem.checked||nodeName==="option"&&!!elem.selected},selected:function(elem){if(elem.parentNode){elem.parentNode.selectedIndex}return elem.selected===true},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling){if(elem.nodeType<6){return false}}return true},parent:function(elem){return!Expr.pseudos["empty"](elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&elem.type==="button"||name==="button"},text:function(elem){var attr;return elem.nodeName.toLowerCase()==="input"&&elem.type==="text"&&((attr=elem.getAttribute("type"))==null||attr.toLowerCase()==="text")},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(matchIndexes,length){return[length-1]}),eq:createPositionalPseudo(function(matchIndexes,length,argument){return[argument<0?argument+length:argument]}),even:createPositionalPseudo(function(matchIndexes,length){var i=0;for(;i<length;i+=2){matchIndexes.push(i)}return matchIndexes}),odd:createPositionalPseudo(function(matchIndexes,length){var i=1;for(;i<length;i+=2){matchIndexes.push(i)}return matchIndexes}),lt:createPositionalPseudo(function(matchIndexes,length,argument){var i=argument<0?argument+length:argument;for(;--i>=0;){matchIndexes.push(i)}return matchIndexes}),gt:createPositionalPseudo(function(matchIndexes,length,argument){var i=argument<0?argument+length:argument;for(;++i<length;){matchIndexes.push(i)}return matchIndexes})}};Expr.pseudos["nth"]=Expr.pseudos["eq"];for(i in{radio:true,checkbox:true,file:true,password:true,image:true}){Expr.pseudos[i]=createInputPseudo(i)}for(i in{submit:true,reset:true}){Expr.pseudos[i]=createButtonPseudo(i)}function setFilters(){}setFilters.prototype=Expr.filters=Expr.pseudos;Expr.setFilters=new setFilters;tokenize=Sizzle.tokenize=function(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached){return parseOnly?0:cached.slice(0)}soFar=selector;groups=[];preFilters=Expr.preFilter;while(soFar){if(!matched||(match=rcomma.exec(soFar))){if(match){soFar=soFar.slice(match[0].length)||soFar}groups.push(tokens=[])}matched=false;if(match=rcombinators.exec(soFar)){matched=match.shift();tokens.push({value:matched,type:match[0].replace(rtrim," ")});soFar=soFar.slice(matched.length)}for(type in Expr.filter){if((match=matchExpr[type].exec(soFar))&&(!preFilters[type]||(match=preFilters[type](match)))){matched=match.shift();tokens.push({value:matched,type:type,matches:match});soFar=soFar.slice(matched.length)}}if(!matched){break}}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)};function toSelector(tokens){var i=0,len=tokens.length,selector="";for(;i<len;i++){selector+=tokens[i].value}return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,checkNonElements=base&&dir==="parentNode",doneName=done++;return combinator.first?function(elem,context,xml){while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){return matcher(elem,context,xml)}}}:function(elem,context,xml){var oldCache,outerCache,newCache=[dirruns,doneName];if(xml){while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){if(matcher(elem,context,xml)){return true}}}}else{while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){outerCache=elem[expando]||(elem[expando]={});if((oldCache=outerCache[dir])&&oldCache[0]===dirruns&&oldCache[1]===doneName){return newCache[2]=oldCache[2]}else{outerCache[dir]=newCache;if(newCache[2]=matcher(elem,context,xml)){return true}}}}}}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){var i=matchers.length;while(i--){if(!matchers[i](elem,context,xml)){return false}}return true}:matchers[0]}function multipleContexts(selector,contexts,results){var i=0,len=contexts.length;for(;i<len;i++){Sizzle(selector,contexts[i],results)}return results}function condense(unmatched,map,filter,context,xml){var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=map!=null;for(;i<len;i++){if(elem=unmatched[i]){if(!filter||filter(elem,context,xml)){newUnmatched.push(elem);if(mapped){map.push(i)}}}}return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){if(postFilter&&!postFilter[expando]){postFilter=setMatcher(postFilter)}if(postFinder&&!postFinder[expando]){postFinder=setMatcher(postFinder,postSelector)}return markFunction(function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||multipleContexts(selector||"*",context.nodeType?[context]:context,[]),matcherIn=preFilter&&(seed||!selector)?condense(elems,preMap,preFilter,context,xml):elems,matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;if(matcher){matcher(matcherIn,matcherOut,context,xml)}if(postFilter){temp=condense(matcherOut,postMap);postFilter(temp,[],context,xml);i=temp.length;while(i--){if(elem=temp[i]){matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem)}}}if(seed){if(postFinder||preFilter){if(postFinder){temp=[];i=matcherOut.length;while(i--){if(elem=matcherOut[i]){temp.push(matcherIn[i]=elem)}}postFinder(null,matcherOut=[],temp,xml)}i=matcherOut.length;while(i--){if((elem=matcherOut[i])&&(temp=postFinder?indexOf.call(seed,elem):preMap[i])>-1){seed[temp]=!(results[temp]=elem)}}}}else{matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut);if(postFinder){postFinder(null,results,matcherOut,xml)}else{push.apply(results,matcherOut)}}})}function matcherFromTokens(tokens){var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator(function(elem){return elem===checkContext},implicitRelative,true),matchAnyContext=addCombinator(function(elem){return indexOf.call(checkContext,elem)>-1},implicitRelative,true),matchers=[function(elem,context,xml){return!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml))}];for(;i<len;i++){if(matcher=Expr.relative[tokens[i].type]){matchers=[addCombinator(elementMatcher(matchers),matcher)]}else{matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches);if(matcher[expando]){j=++i;for(;j<len;j++){if(Expr.relative[tokens[j].type]){break}}return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:tokens[i-2].type===" "?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}}return elementMatcher(matchers)}function matcherFromGroupMatchers(elementMatchers,setMatchers){var bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,outermost){var elem,j,matcher,matchedCount=0,i="0",unmatched=seed&&[],setMatched=[],contextBackup=outermostContext,elems=seed||byElement&&Expr.find["TAG"]("*",outermost),dirrunsUnique=dirruns+=contextBackup==null?1:Math.random()||.1,len=elems.length;if(outermost){outermostContext=context!==document&&context}for(;i!==len&&(elem=elems[i])!=null;i++){if(byElement&&elem){j=0;while(matcher=elementMatchers[j++]){if(matcher(elem,context,xml)){results.push(elem);break}}if(outermost){dirruns=dirrunsUnique}}if(bySet){if(elem=!matcher&&elem){matchedCount--}if(seed){unmatched.push(elem)}}}matchedCount+=i;if(bySet&&i!==matchedCount){j=0;while(matcher=setMatchers[j++]){matcher(unmatched,setMatched,context,xml)}if(seed){if(matchedCount>0){while(i--){if(!(unmatched[i]||setMatched[i])){setMatched[i]=pop.call(results)}}}setMatched=condense(setMatched)}push.apply(results,setMatched);if(outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1){Sizzle.uniqueSort(results)}}if(outermost){dirruns=dirrunsUnique;outermostContext=contextBackup}return unmatched};return bySet?markFunction(superMatcher):superMatcher}compile=Sizzle.compile=function(selector,match){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){if(!match){match=tokenize(selector)}i=match.length;while(i--){cached=matcherFromTokens(match[i]);if(cached[expando]){setMatchers.push(cached)}else{elementMatchers.push(cached)}}cached=compilerCache(selector,matcherFromGroupMatchers(elementMatchers,setMatchers));cached.selector=selector}return cached};select=Sizzle.select=function(selector,context,results,seed){var i,tokens,token,type,find,compiled=typeof selector==="function"&&selector,match=!seed&&tokenize(selector=compiled.selector||selector);results=results||[];if(match.length===1){tokens=match[0]=match[0].slice(0);if(tokens.length>2&&(token=tokens[0]).type==="ID"&&support.getById&&context.nodeType===9&&documentIsHTML&&Expr.relative[tokens[1].type]){context=(Expr.find["ID"](token.matches[0].replace(runescape,funescape),context)||[])[0];if(!context){return results}else if(compiled){context=context.parentNode}selector=selector.slice(tokens.shift().value.length)}i=matchExpr["needsContext"].test(selector)?0:tokens.length;while(i--){token=tokens[i];if(Expr.relative[type=token.type]){break}if(find=Expr.find[type]){if(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&testContext(context.parentNode)||context)){tokens.splice(i,1);selector=seed.length&&toSelector(tokens);if(!selector){push.apply(results,seed);return results}break}}}}(compiled||compile(selector,match))(seed,context,!documentIsHTML,results,rsibling.test(selector)&&testContext(context.parentNode)||context);return results};support.sortStable=expando.split("").sort(sortOrder).join("")===expando;support.detectDuplicates=!!hasDuplicate;setDocument();support.sortDetached=assert(function(div1){return div1.compareDocumentPosition(document.createElement("div"))&1});if(!assert(function(div){div.innerHTML="<a href='#'></a>";return div.firstChild.getAttribute("href")==="#"})){addHandle("type|href|height|width",function(elem,name,isXML){if(!isXML){return elem.getAttribute(name,name.toLowerCase()==="type"?1:2)}})}if(!support.attributes||!assert(function(div){div.innerHTML="<input/>";div.firstChild.setAttribute("value","");return div.firstChild.getAttribute("value")===""})){addHandle("value",function(elem,name,isXML){if(!isXML&&elem.nodeName.toLowerCase()==="input"){return elem.defaultValue}})}if(!assert(function(div){return div.getAttribute("disabled")==null})){addHandle(booleans,function(elem,name,isXML){var val;if(!isXML){return elem[name]===true?name.toLowerCase():(val=elem.getAttributeNode(name))&&val.specified?val.value:null}})}return Sizzle}(window);jQuery.find=Sizzle;jQuery.expr=Sizzle.selectors;jQuery.expr[":"]=jQuery.expr.pseudos;jQuery.unique=Sizzle.uniqueSort;jQuery.text=Sizzle.getText;jQuery.isXMLDoc=Sizzle.isXML;jQuery.contains=Sizzle.contains;var rneedsContext=jQuery.expr.match.needsContext;var rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>|)$/;var risSimple=/^.[^:#\[\.,]*$/;function winnow(elements,qualifier,not){if(jQuery.isFunction(qualifier)){return jQuery.grep(elements,function(elem,i){return!!qualifier.call(elem,i,elem)!==not})}if(qualifier.nodeType){return jQuery.grep(elements,function(elem){return elem===qualifier!==not})}if(typeof qualifier==="string"){if(risSimple.test(qualifier)){return jQuery.filter(qualifier,elements,not)}qualifier=jQuery.filter(qualifier,elements)}return jQuery.grep(elements,function(elem){return indexOf.call(qualifier,elem)>=0!==not})}jQuery.filter=function(expr,elems,not){var elem=elems[0];if(not){expr=":not("+expr+")"}return elems.length===1&&elem.nodeType===1?jQuery.find.matchesSelector(elem,expr)?[elem]:[]:jQuery.find.matches(expr,jQuery.grep(elems,function(elem){return elem.nodeType===1}))};jQuery.fn.extend({find:function(selector){var i,len=this.length,ret=[],self=this;if(typeof selector!=="string"){return this.pushStack(jQuery(selector).filter(function(){for(i=0;i<len;i++){if(jQuery.contains(self[i],this)){return true}}}))}for(i=0;i<len;i++){jQuery.find(selector,self[i],ret)}ret=this.pushStack(len>1?jQuery.unique(ret):ret);ret.selector=this.selector?this.selector+" "+selector:selector;return ret},filter:function(selector){return this.pushStack(winnow(this,selector||[],false))},not:function(selector){return this.pushStack(winnow(this,selector||[],true))},is:function(selector){return!!winnow(this,typeof selector==="string"&&rneedsContext.test(selector)?jQuery(selector):selector||[],false).length}});var rootjQuery,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,init=jQuery.fn.init=function(selector,context){var match,elem;if(!selector){return this}if(typeof selector==="string"){if(selector[0]==="<"&&selector[selector.length-1]===">"&&selector.length>=3){match=[null,selector,null]}else{match=rquickExpr.exec(selector)}if(match&&(match[1]||!context)){if(match[1]){context=context instanceof jQuery?context[0]:context;jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,true));if(rsingleTag.test(match[1])&&jQuery.isPlainObject(context)){for(match in context){if(jQuery.isFunction(this[match])){this[match](context[match])}else{this.attr(match,context[match])}}}return this}else{elem=document.getElementById(match[2]);if(elem&&elem.parentNode){this.length=1;this[0]=elem}this.context=document;this.selector=selector;return this}}else if(!context||context.jquery){return(context||rootjQuery).find(selector)}else{return this.constructor(context).find(selector)}}else if(selector.nodeType){this.context=this[0]=selector;this.length=1;return this}else if(jQuery.isFunction(selector)){return typeof rootjQuery.ready!=="undefined"?rootjQuery.ready(selector):selector(jQuery)}if(selector.selector!==undefined){this.selector=selector.selector;this.context=selector.context}return jQuery.makeArray(selector,this)};init.prototype=jQuery.fn;rootjQuery=jQuery(document);var rparentsprev=/^(?:parents|prev(?:Until|All))/,guaranteedUnique={children:true,contents:true,next:true,prev:true};jQuery.extend({dir:function(elem,dir,until){var matched=[],truncate=until!==undefined;while((elem=elem[dir])&&elem.nodeType!==9){if(elem.nodeType===1){if(truncate&&jQuery(elem).is(until)){break}matched.push(elem)}}return matched},sibling:function(n,elem){var matched=[];for(;n;n=n.nextSibling){if(n.nodeType===1&&n!==elem){matched.push(n)}}return matched}});jQuery.fn.extend({has:function(target){var targets=jQuery(target,this),l=targets.length;return this.filter(function(){var i=0;for(;i<l;i++){if(jQuery.contains(this,targets[i])){return true}}})},closest:function(selectors,context){var cur,i=0,l=this.length,matched=[],pos=rneedsContext.test(selectors)||typeof selectors!=="string"?jQuery(selectors,context||this.context):0;for(;i<l;i++){for(cur=this[i];cur&&cur!==context;cur=cur.parentNode){if(cur.nodeType<11&&(pos?pos.index(cur)>-1:cur.nodeType===1&&jQuery.find.matchesSelector(cur,selectors))){matched.push(cur);break}}}return this.pushStack(matched.length>1?jQuery.unique(matched):matched)},index:function(elem){if(!elem){return this[0]&&this[0].parentNode?this.first().prevAll().length:-1}if(typeof elem==="string"){return indexOf.call(jQuery(elem),this[0])}return indexOf.call(this,elem.jquery?elem[0]:elem)},add:function(selector,context){return this.pushStack(jQuery.unique(jQuery.merge(this.get(),jQuery(selector,context))))
},addBack:function(selector){return this.add(selector==null?this.prevObject:this.prevObject.filter(selector))}});function sibling(cur,dir){while((cur=cur[dir])&&cur.nodeType!==1){}return cur}jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&parent.nodeType!==11?parent:null},parents:function(elem){return jQuery.dir(elem,"parentNode")},parentsUntil:function(elem,i,until){return jQuery.dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return jQuery.dir(elem,"nextSibling")},prevAll:function(elem){return jQuery.dir(elem,"previousSibling")},nextUntil:function(elem,i,until){return jQuery.dir(elem,"nextSibling",until)},prevUntil:function(elem,i,until){return jQuery.dir(elem,"previousSibling",until)},siblings:function(elem){return jQuery.sibling((elem.parentNode||{}).firstChild,elem)},children:function(elem){return jQuery.sibling(elem.firstChild)},contents:function(elem){return elem.contentDocument||jQuery.merge([],elem.childNodes)}},function(name,fn){jQuery.fn[name]=function(until,selector){var matched=jQuery.map(this,fn,until);if(name.slice(-5)!=="Until"){selector=until}if(selector&&typeof selector==="string"){matched=jQuery.filter(selector,matched)}if(this.length>1){if(!guaranteedUnique[name]){jQuery.unique(matched)}if(rparentsprev.test(name)){matched.reverse()}}return this.pushStack(matched)}});var rnotwhite=/\S+/g;var optionsCache={};function createOptions(options){var object=optionsCache[options]={};jQuery.each(options.match(rnotwhite)||[],function(_,flag){object[flag]=true});return object}jQuery.Callbacks=function(options){options=typeof options==="string"?optionsCache[options]||createOptions(options):jQuery.extend({},options);var memory,fired,firing,firingStart,firingLength,firingIndex,list=[],stack=!options.once&&[],fire=function(data){memory=options.memory&&data;fired=true;firingIndex=firingStart||0;firingStart=0;firingLength=list.length;firing=true;for(;list&&firingIndex<firingLength;firingIndex++){if(list[firingIndex].apply(data[0],data[1])===false&&options.stopOnFalse){memory=false;break}}firing=false;if(list){if(stack){if(stack.length){fire(stack.shift())}}else if(memory){list=[]}else{self.disable()}}},self={add:function(){if(list){var start=list.length;(function add(args){jQuery.each(args,function(_,arg){var type=jQuery.type(arg);if(type==="function"){if(!options.unique||!self.has(arg)){list.push(arg)}}else if(arg&&arg.length&&type!=="string"){add(arg)}})})(arguments);if(firing){firingLength=list.length}else if(memory){firingStart=start;fire(memory)}}return this},remove:function(){if(list){jQuery.each(arguments,function(_,arg){var index;while((index=jQuery.inArray(arg,list,index))>-1){list.splice(index,1);if(firing){if(index<=firingLength){firingLength--}if(index<=firingIndex){firingIndex--}}}})}return this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:!!(list&&list.length)},empty:function(){list=[];firingLength=0;return this},disable:function(){list=stack=memory=undefined;return this},disabled:function(){return!list},lock:function(){stack=undefined;if(!memory){self.disable()}return this},locked:function(){return!stack},fireWith:function(context,args){if(list&&(!fired||stack)){args=args||[];args=[context,args.slice?args.slice():args];if(firing){stack.push(args)}else{fire(args)}}return this},fire:function(){self.fireWith(this,arguments);return this},fired:function(){return!!fired}};return self};jQuery.extend({Deferred:function(func){var tuples=[["resolve","done",jQuery.Callbacks("once memory"),"resolved"],["reject","fail",jQuery.Callbacks("once memory"),"rejected"],["notify","progress",jQuery.Callbacks("memory")]],state="pending",promise={state:function(){return state},always:function(){deferred.done(arguments).fail(arguments);return this},then:function(){var fns=arguments;return jQuery.Deferred(function(newDefer){jQuery.each(tuples,function(i,tuple){var fn=jQuery.isFunction(fns[i])&&fns[i];deferred[tuple[1]](function(){var returned=fn&&fn.apply(this,arguments);if(returned&&jQuery.isFunction(returned.promise)){returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify)}else{newDefer[tuple[0]+"With"](this===promise?newDefer.promise():this,fn?[returned]:arguments)}})});fns=null}).promise()},promise:function(obj){return obj!=null?jQuery.extend(obj,promise):promise}},deferred={};promise.pipe=promise.then;jQuery.each(tuples,function(i,tuple){var list=tuple[2],stateString=tuple[3];promise[tuple[1]]=list.add;if(stateString){list.add(function(){state=stateString},tuples[i^1][2].disable,tuples[2][2].lock)}deferred[tuple[0]]=function(){deferred[tuple[0]+"With"](this===deferred?promise:this,arguments);return this};deferred[tuple[0]+"With"]=list.fireWith});promise.promise(deferred);if(func){func.call(deferred,deferred)}return deferred},when:function(subordinate){var i=0,resolveValues=slice.call(arguments),length=resolveValues.length,remaining=length!==1||subordinate&&jQuery.isFunction(subordinate.promise)?length:0,deferred=remaining===1?subordinate:jQuery.Deferred(),updateFunc=function(i,contexts,values){return function(value){contexts[i]=this;values[i]=arguments.length>1?slice.call(arguments):value;if(values===progressValues){deferred.notifyWith(contexts,values)}else if(!--remaining){deferred.resolveWith(contexts,values)}}},progressValues,progressContexts,resolveContexts;if(length>1){progressValues=new Array(length);progressContexts=new Array(length);resolveContexts=new Array(length);for(;i<length;i++){if(resolveValues[i]&&jQuery.isFunction(resolveValues[i].promise)){resolveValues[i].promise().done(updateFunc(i,resolveContexts,resolveValues)).fail(deferred.reject).progress(updateFunc(i,progressContexts,progressValues))}else{--remaining}}}if(!remaining){deferred.resolveWith(resolveContexts,resolveValues)}return deferred.promise()}});var readyList;jQuery.fn.ready=function(fn){jQuery.ready.promise().done(fn);return this};jQuery.extend({isReady:false,readyWait:1,holdReady:function(hold){if(hold){jQuery.readyWait++}else{jQuery.ready(true)}},ready:function(wait){if(wait===true?--jQuery.readyWait:jQuery.isReady){return}jQuery.isReady=true;if(wait!==true&&--jQuery.readyWait>0){return}readyList.resolveWith(document,[jQuery]);if(jQuery.fn.triggerHandler){jQuery(document).triggerHandler("ready");jQuery(document).off("ready")}}});function completed(){document.removeEventListener("DOMContentLoaded",completed,false);window.removeEventListener("load",completed,false);jQuery.ready()}jQuery.ready.promise=function(obj){if(!readyList){readyList=jQuery.Deferred();if(document.readyState==="complete"){setTimeout(jQuery.ready)}else{document.addEventListener("DOMContentLoaded",completed,false);window.addEventListener("load",completed,false)}}return readyList.promise(obj)};jQuery.ready.promise();var access=jQuery.access=function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,len=elems.length,bulk=key==null;if(jQuery.type(key)==="object"){chainable=true;for(i in key){jQuery.access(elems,fn,i,key[i],true,emptyGet,raw)}}else if(value!==undefined){chainable=true;if(!jQuery.isFunction(value)){raw=true}if(bulk){if(raw){fn.call(elems,value);fn=null}else{bulk=fn;fn=function(elem,key,value){return bulk.call(jQuery(elem),value)}}}if(fn){for(;i<len;i++){fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)))}}}return chainable?elems:bulk?fn.call(elems):len?fn(elems[0],key):emptyGet};jQuery.acceptData=function(owner){return owner.nodeType===1||owner.nodeType===9||!+owner.nodeType};function Data(){Object.defineProperty(this.cache={},0,{get:function(){return{}}});this.expando=jQuery.expando+Math.random()}Data.uid=1;Data.accepts=jQuery.acceptData;Data.prototype={key:function(owner){if(!Data.accepts(owner)){return 0}var descriptor={},unlock=owner[this.expando];if(!unlock){unlock=Data.uid++;try{descriptor[this.expando]={value:unlock};Object.defineProperties(owner,descriptor)}catch(e){descriptor[this.expando]=unlock;jQuery.extend(owner,descriptor)}}if(!this.cache[unlock]){this.cache[unlock]={}}return unlock},set:function(owner,data,value){var prop,unlock=this.key(owner),cache=this.cache[unlock];if(typeof data==="string"){cache[data]=value}else{if(jQuery.isEmptyObject(cache)){jQuery.extend(this.cache[unlock],data)}else{for(prop in data){cache[prop]=data[prop]}}}return cache},get:function(owner,key){var cache=this.cache[this.key(owner)];return key===undefined?cache:cache[key]},access:function(owner,key,value){var stored;if(key===undefined||key&&typeof key==="string"&&value===undefined){stored=this.get(owner,key);return stored!==undefined?stored:this.get(owner,jQuery.camelCase(key))}this.set(owner,key,value);return value!==undefined?value:key},remove:function(owner,key){var i,name,camel,unlock=this.key(owner),cache=this.cache[unlock];if(key===undefined){this.cache[unlock]={}}else{if(jQuery.isArray(key)){name=key.concat(key.map(jQuery.camelCase))}else{camel=jQuery.camelCase(key);if(key in cache){name=[key,camel]}else{name=camel;name=name in cache?[name]:name.match(rnotwhite)||[]}}i=name.length;while(i--){delete cache[name[i]]}}},hasData:function(owner){return!jQuery.isEmptyObject(this.cache[owner[this.expando]]||{})},discard:function(owner){if(owner[this.expando]){delete this.cache[owner[this.expando]]}}};var data_priv=new Data;var data_user=new Data;var rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,rmultiDash=/([A-Z])/g;function dataAttr(elem,key,data){var name;if(data===undefined&&elem.nodeType===1){name="data-"+key.replace(rmultiDash,"-$1").toLowerCase();data=elem.getAttribute(name);if(typeof data==="string"){try{data=data==="true"?true:data==="false"?false:data==="null"?null:+data+""===data?+data:rbrace.test(data)?jQuery.parseJSON(data):data}catch(e){}data_user.set(elem,key,data)}else{data=undefined}}return data}jQuery.extend({hasData:function(elem){return data_user.hasData(elem)||data_priv.hasData(elem)},data:function(elem,name,data){return data_user.access(elem,name,data)},removeData:function(elem,name){data_user.remove(elem,name)},_data:function(elem,name,data){return data_priv.access(elem,name,data)},_removeData:function(elem,name){data_priv.remove(elem,name)}});jQuery.fn.extend({data:function(key,value){var i,name,data,elem=this[0],attrs=elem&&elem.attributes;if(key===undefined){if(this.length){data=data_user.get(elem);if(elem.nodeType===1&&!data_priv.get(elem,"hasDataAttrs")){i=attrs.length;while(i--){if(attrs[i]){name=attrs[i].name;if(name.indexOf("data-")===0){name=jQuery.camelCase(name.slice(5));dataAttr(elem,name,data[name])}}}data_priv.set(elem,"hasDataAttrs",true)}}return data}if(typeof key==="object"){return this.each(function(){data_user.set(this,key)})}return access(this,function(value){var data,camelKey=jQuery.camelCase(key);if(elem&&value===undefined){data=data_user.get(elem,key);if(data!==undefined){return data}data=data_user.get(elem,camelKey);if(data!==undefined){return data}data=dataAttr(elem,camelKey,undefined);if(data!==undefined){return data}return}this.each(function(){var data=data_user.get(this,camelKey);data_user.set(this,camelKey,value);if(key.indexOf("-")!==-1&&data!==undefined){data_user.set(this,key,value)}})},null,value,arguments.length>1,null,true)},removeData:function(key){return this.each(function(){data_user.remove(this,key)})}});jQuery.extend({queue:function(elem,type,data){var queue;if(elem){type=(type||"fx")+"queue";queue=data_priv.get(elem,type);if(data){if(!queue||jQuery.isArray(data)){queue=data_priv.access(elem,type,jQuery.makeArray(data))}else{queue.push(data)}}return queue||[]}},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type),next=function(){jQuery.dequeue(elem,type)};if(fn==="inprogress"){fn=queue.shift();startLength--}if(fn){if(type==="fx"){queue.unshift("inprogress")}delete hooks.stop;fn.call(elem,next,hooks)}if(!startLength&&hooks){hooks.empty.fire()}},_queueHooks:function(elem,type){var key=type+"queueHooks";return data_priv.get(elem,key)||data_priv.access(elem,key,{empty:jQuery.Callbacks("once memory").add(function(){data_priv.remove(elem,[type+"queue",key])})})}});jQuery.fn.extend({queue:function(type,data){var setter=2;if(typeof type!=="string"){data=type;type="fx";setter--}if(arguments.length<setter){return jQuery.queue(this[0],type)}return data===undefined?this:this.each(function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type);if(type==="fx"&&queue[0]!=="inprogress"){jQuery.dequeue(this,type)}})},dequeue:function(type){return this.each(function(){jQuery.dequeue(this,type)})},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){if(!--count){defer.resolveWith(elements,[elements])}};if(typeof type!=="string"){obj=type;type=undefined}type=type||"fx";while(i--){tmp=data_priv.get(elements[i],type+"queueHooks");if(tmp&&tmp.empty){count++;tmp.empty.add(resolve)}}resolve();return defer.promise(obj)}});var pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source;var cssExpand=["Top","Right","Bottom","Left"];var isHidden=function(elem,el){elem=el||elem;return jQuery.css(elem,"display")==="none"||!jQuery.contains(elem.ownerDocument,elem)};var rcheckableType=/^(?:checkbox|radio)$/i;(function(){var fragment=document.createDocumentFragment(),div=fragment.appendChild(document.createElement("div")),input=document.createElement("input");input.setAttribute("type","radio");input.setAttribute("checked","checked");input.setAttribute("name","t");div.appendChild(input);support.checkClone=div.cloneNode(true).cloneNode(true).lastChild.checked;div.innerHTML="<textarea>x</textarea>";support.noCloneChecked=!!div.cloneNode(true).lastChild.defaultValue})();var strundefined=typeof undefined;support.focusinBubbles="onfocusin"in window;var rkeyEvent=/^key/,rmouseEvent=/^(?:mouse|pointer|contextmenu)|click/,rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,rtypenamespace=/^([^.]*)(?:\.(.+)|)$/;function returnTrue(){return true}function returnFalse(){return false}function safeActiveElement(){try{return document.activeElement}catch(err){}}jQuery.event={global:{},add:function(elem,types,handler,data,selector){var handleObjIn,eventHandle,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=data_priv.get(elem);if(!elemData){return}if(handler.handler){handleObjIn=handler;handler=handleObjIn.handler;selector=handleObjIn.selector}if(!handler.guid){handler.guid=jQuery.guid++}if(!(events=elemData.events)){events=elemData.events={}}if(!(eventHandle=elemData.handle)){eventHandle=elemData.handle=function(e){return typeof jQuery!==strundefined&&jQuery.event.triggered!==e.type?jQuery.event.dispatch.apply(elem,arguments):undefined}}types=(types||"").match(rnotwhite)||[""];t=types.length;while(t--){tmp=rtypenamespace.exec(types[t])||[];type=origType=tmp[1];namespaces=(tmp[2]||"").split(".").sort();if(!type){continue}special=jQuery.event.special[type]||{};type=(selector?special.delegateType:special.bindType)||type;special=jQuery.event.special[type]||{};handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn);if(!(handlers=events[type])){handlers=events[type]=[];handlers.delegateCount=0;if(!special.setup||special.setup.call(elem,data,namespaces,eventHandle)===false){if(elem.addEventListener){elem.addEventListener(type,eventHandle,false)}}}if(special.add){special.add.call(elem,handleObj);if(!handleObj.handler.guid){handleObj.handler.guid=handler.guid}}if(selector){handlers.splice(handlers.delegateCount++,0,handleObj)}else{handlers.push(handleObj)}jQuery.event.global[type]=true}},remove:function(elem,types,handler,selector,mappedTypes){var j,origCount,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=data_priv.hasData(elem)&&data_priv.get(elem);if(!elemData||!(events=elemData.events)){return}types=(types||"").match(rnotwhite)||[""];t=types.length;while(t--){tmp=rtypenamespace.exec(types[t])||[];type=origType=tmp[1];namespaces=(tmp[2]||"").split(".").sort();if(!type){for(type in events){jQuery.event.remove(elem,type+types[t],handler,selector,true)}continue}special=jQuery.event.special[type]||{};type=(selector?special.delegateType:special.bindType)||type;handlers=events[type]||[];tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)");origCount=j=handlers.length;while(j--){handleObj=handlers[j];if((mappedTypes||origType===handleObj.origType)&&(!handler||handler.guid===handleObj.guid)&&(!tmp||tmp.test(handleObj.namespace))&&(!selector||selector===handleObj.selector||selector==="**"&&handleObj.selector)){handlers.splice(j,1);if(handleObj.selector){handlers.delegateCount--}if(special.remove){special.remove.call(elem,handleObj)}}}if(origCount&&!handlers.length){if(!special.teardown||special.teardown.call(elem,namespaces,elemData.handle)===false){jQuery.removeEvent(elem,type,elemData.handle)}delete events[type]}}if(jQuery.isEmptyObject(events)){delete elemData.handle;data_priv.remove(elem,"events")}},trigger:function(event,data,elem,onlyHandlers){var i,cur,tmp,bubbleType,ontype,handle,special,eventPath=[elem||document],type=hasOwn.call(event,"type")?event.type:event,namespaces=hasOwn.call(event,"namespace")?event.namespace.split("."):[];cur=tmp=elem=elem||document;if(elem.nodeType===3||elem.nodeType===8){return}if(rfocusMorph.test(type+jQuery.event.triggered)){return}if(type.indexOf(".")>=0){namespaces=type.split(".");type=namespaces.shift();namespaces.sort()}ontype=type.indexOf(":")<0&&"on"+type;event=event[jQuery.expando]?event:new jQuery.Event(type,typeof event==="object"&&event);event.isTrigger=onlyHandlers?2:3;event.namespace=namespaces.join(".");event.namespace_re=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null;event.result=undefined;if(!event.target){event.target=elem}data=data==null?[event]:jQuery.makeArray(data,[event]);special=jQuery.event.special[type]||{};if(!onlyHandlers&&special.trigger&&special.trigger.apply(elem,data)===false){return}if(!onlyHandlers&&!special.noBubble&&!jQuery.isWindow(elem)){bubbleType=special.delegateType||type;if(!rfocusMorph.test(bubbleType+type)){cur=cur.parentNode}for(;cur;cur=cur.parentNode){eventPath.push(cur);tmp=cur}if(tmp===(elem.ownerDocument||document)){eventPath.push(tmp.defaultView||tmp.parentWindow||window)}}i=0;while((cur=eventPath[i++])&&!event.isPropagationStopped()){event.type=i>1?bubbleType:special.bindType||type;handle=(data_priv.get(cur,"events")||{})[event.type]&&data_priv.get(cur,"handle");if(handle){handle.apply(cur,data)}handle=ontype&&cur[ontype];if(handle&&handle.apply&&jQuery.acceptData(cur)){event.result=handle.apply(cur,data);if(event.result===false){event.preventDefault()}}}event.type=type;if(!onlyHandlers&&!event.isDefaultPrevented()){if((!special._default||special._default.apply(eventPath.pop(),data)===false)&&jQuery.acceptData(elem)){if(ontype&&jQuery.isFunction(elem[type])&&!jQuery.isWindow(elem)){tmp=elem[ontype];if(tmp){elem[ontype]=null}jQuery.event.triggered=type;elem[type]();jQuery.event.triggered=undefined;if(tmp){elem[ontype]=tmp}}}}return event.result},dispatch:function(event){event=jQuery.event.fix(event);var i,j,ret,matched,handleObj,handlerQueue=[],args=slice.call(arguments),handlers=(data_priv.get(this,"events")||{})[event.type]||[],special=jQuery.event.special[event.type]||{};args[0]=event;event.delegateTarget=this;if(special.preDispatch&&special.preDispatch.call(this,event)===false){return}handlerQueue=jQuery.event.handlers.call(this,event,handlers);i=0;while((matched=handlerQueue[i++])&&!event.isPropagationStopped()){event.currentTarget=matched.elem;j=0;while((handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped()){if(!event.namespace_re||event.namespace_re.test(handleObj.namespace)){event.handleObj=handleObj;event.data=handleObj.data;ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args);if(ret!==undefined){if((event.result=ret)===false){event.preventDefault();event.stopPropagation()}}}}}if(special.postDispatch){special.postDispatch.call(this,event)}return event.result},handlers:function(event,handlers){var i,matches,sel,handleObj,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&(!event.button||event.type!=="click")){for(;cur!==this;cur=cur.parentNode||this){if(cur.disabled!==true||event.type!=="click"){matches=[];for(i=0;i<delegateCount;i++){handleObj=handlers[i];sel=handleObj.selector+" ";if(matches[sel]===undefined){matches[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>=0:jQuery.find(sel,this,null,[cur]).length}if(matches[sel]){matches.push(handleObj)}}if(matches.length){handlerQueue.push({elem:cur,handlers:matches})}}}}if(delegateCount<handlers.length){handlerQueue.push({elem:this,handlers:handlers.slice(delegateCount)})}return handlerQueue},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(event,original){if(event.which==null){event.which=original.charCode!=null?original.charCode:original.keyCode}return event}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(event,original){var eventDoc,doc,body,button=original.button;if(event.pageX==null&&original.clientX!=null){eventDoc=event.target.ownerDocument||document;doc=eventDoc.documentElement;body=eventDoc.body;event.pageX=original.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0);event.pageY=original.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)}if(!event.which&&button!==undefined){event.which=button&1?1:button&2?3:button&4?2:0}return event}},fix:function(event){if(event[jQuery.expando]){return event}var i,prop,copy,type=event.type,originalEvent=event,fixHook=this.fixHooks[type];if(!fixHook){this.fixHooks[type]=fixHook=rmouseEvent.test(type)?this.mouseHooks:rkeyEvent.test(type)?this.keyHooks:{}}copy=fixHook.props?this.props.concat(fixHook.props):this.props;event=new jQuery.Event(originalEvent);i=copy.length;while(i--){prop=copy[i];event[prop]=originalEvent[prop]}if(!event.target){event.target=document}if(event.target.nodeType===3){event.target=event.target.parentNode}return fixHook.filter?fixHook.filter(event,originalEvent):event},special:{load:{noBubble:true},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus){this.focus();return false}},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur){this.blur();return false}},delegateType:"focusout"},click:{trigger:function(){if(this.type==="checkbox"&&this.click&&jQuery.nodeName(this,"input")){this.click();return false}},_default:function(event){return jQuery.nodeName(event.target,"a")}},beforeunload:{postDispatch:function(event){if(event.result!==undefined&&event.originalEvent){event.originalEvent.returnValue=event.result}}}},simulate:function(type,elem,event,bubble){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:true,originalEvent:{}});if(bubble){jQuery.event.trigger(e,null,elem)}else{jQuery.event.dispatch.call(elem,e)}if(e.isDefaultPrevented()){event.preventDefault()}}};jQuery.removeEvent=function(elem,type,handle){if(elem.removeEventListener){elem.removeEventListener(type,handle,false)}};jQuery.Event=function(src,props){if(!(this instanceof jQuery.Event)){return new jQuery.Event(src,props)}if(src&&src.type){this.originalEvent=src;this.type=src.type;this.isDefaultPrevented=src.defaultPrevented||src.defaultPrevented===undefined&&src.returnValue===false?returnTrue:returnFalse}else{this.type=src}if(props){jQuery.extend(this,props)}this.timeStamp=src&&src.timeStamp||jQuery.now();this[jQuery.expando]=true};jQuery.Event.prototype={isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue;if(e&&e.preventDefault){e.preventDefault()}},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue;if(e&&e.stopPropagation){e.stopPropagation()}},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue;if(e&&e.stopImmediatePropagation){e.stopImmediatePropagation()}this.stopPropagation()}};jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;if(!related||related!==target&&!jQuery.contains(target,related)){event.type=handleObj.origType;ret=handleObj.handler.apply(this,arguments);event.type=fix}return ret}}});if(!support.focusinBubbles){jQuery.each({focus:"focusin",blur:"focusout"},function(orig,fix){var handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event),true)};jQuery.event.special[fix]={setup:function(){var doc=this.ownerDocument||this,attaches=data_priv.access(doc,fix);if(!attaches){doc.addEventListener(orig,handler,true)}data_priv.access(doc,fix,(attaches||0)+1)},teardown:function(){var doc=this.ownerDocument||this,attaches=data_priv.access(doc,fix)-1;if(!attaches){doc.removeEventListener(orig,handler,true);data_priv.remove(doc,fix)}else{data_priv.access(doc,fix,attaches)}}}})}jQuery.fn.extend({on:function(types,selector,data,fn,one){var origFn,type;if(typeof types==="object"){if(typeof selector!=="string"){data=data||selector;selector=undefined}for(type in types){this.on(type,selector,data,types[type],one)}return this}if(data==null&&fn==null){fn=selector;data=selector=undefined}else if(fn==null){if(typeof selector==="string"){fn=data;data=undefined}else{fn=data;data=selector;selector=undefined}}if(fn===false){fn=returnFalse}else if(!fn){return this}if(one===1){origFn=fn;fn=function(event){jQuery().off(event);return origFn.apply(this,arguments)};fn.guid=origFn.guid||(origFn.guid=jQuery.guid++)}return this.each(function(){jQuery.event.add(this,types,fn,data,selector)})},one:function(types,selector,data,fn){return this.on(types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj){handleObj=types.handleObj;jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler);return this}if(typeof types==="object"){for(type in types){this.off(type,selector,types[type])}return this}if(selector===false||typeof selector==="function"){fn=selector;selector=undefined}if(fn===false){fn=returnFalse}return this.each(function(){jQuery.event.remove(this,types,fn,selector)})},trigger:function(type,data){return this.each(function(){jQuery.event.trigger(type,data,this)})},triggerHandler:function(type,data){var elem=this[0];if(elem){return jQuery.event.trigger(type,data,elem,true)}}});var rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,rtagName=/<([\w:]+)/,rhtml=/<|&#?\w+;/,rnoInnerhtml=/<(?:script|style|link)/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rscriptType=/^$|\/(?:java|ecma)script/i,rscriptTypeMasked=/^true\/(.*)/,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,wrapMap={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};wrapMap.optgroup=wrapMap.option;wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead;wrapMap.th=wrapMap.td;function manipulationTarget(elem,content){return jQuery.nodeName(elem,"table")&&jQuery.nodeName(content.nodeType!==11?content:content.firstChild,"tr")?elem.getElementsByTagName("tbody")[0]||elem.appendChild(elem.ownerDocument.createElement("tbody")):elem}function disableScript(elem){elem.type=(elem.getAttribute("type")!==null)+"/"+elem.type;return elem}function restoreScript(elem){var match=rscriptTypeMasked.exec(elem.type);if(match){elem.type=match[1]}else{elem.removeAttribute("type")}return elem}function setGlobalEval(elems,refElements){var i=0,l=elems.length;for(;i<l;i++){data_priv.set(elems[i],"globalEval",!refElements||data_priv.get(refElements[i],"globalEval"))}}function cloneCopyEvent(src,dest){var i,l,type,pdataOld,pdataCur,udataOld,udataCur,events;if(dest.nodeType!==1){return}if(data_priv.hasData(src)){pdataOld=data_priv.access(src);pdataCur=data_priv.set(dest,pdataOld);events=pdataOld.events;if(events){delete pdataCur.handle;pdataCur.events={};for(type in events){for(i=0,l=events[type].length;i<l;i++){jQuery.event.add(dest,type,events[type][i])}}}}if(data_user.hasData(src)){udataOld=data_user.access(src);udataCur=jQuery.extend({},udataOld);data_user.set(dest,udataCur)}}function getAll(context,tag){var ret=context.getElementsByTagName?context.getElementsByTagName(tag||"*"):context.querySelectorAll?context.querySelectorAll(tag||"*"):[];return tag===undefined||tag&&jQuery.nodeName(context,tag)?jQuery.merge([context],ret):ret}function fixInput(src,dest){var nodeName=dest.nodeName.toLowerCase();if(nodeName==="input"&&rcheckableType.test(src.type)){dest.checked=src.checked}else if(nodeName==="input"||nodeName==="textarea"){dest.defaultValue=src.defaultValue}}jQuery.extend({clone:function(elem,dataAndEvents,deepDataAndEvents){var i,l,srcElements,destElements,clone=elem.cloneNode(true),inPage=jQuery.contains(elem.ownerDocument,elem);if(!support.noCloneChecked&&(elem.nodeType===1||elem.nodeType===11)&&!jQuery.isXMLDoc(elem)){destElements=getAll(clone);srcElements=getAll(elem);for(i=0,l=srcElements.length;i<l;i++){fixInput(srcElements[i],destElements[i])}}if(dataAndEvents){if(deepDataAndEvents){srcElements=srcElements||getAll(elem);destElements=destElements||getAll(clone);for(i=0,l=srcElements.length;i<l;i++){cloneCopyEvent(srcElements[i],destElements[i])}}else{cloneCopyEvent(elem,clone)}}destElements=getAll(clone,"script");if(destElements.length>0){setGlobalEval(destElements,!inPage&&getAll(elem,"script"))}return clone},buildFragment:function(elems,context,scripts,selection){var elem,tmp,tag,wrap,contains,j,fragment=context.createDocumentFragment(),nodes=[],i=0,l=elems.length;for(;i<l;i++){elem=elems[i];if(elem||elem===0){if(jQuery.type(elem)==="object"){jQuery.merge(nodes,elem.nodeType?[elem]:elem)}else if(!rhtml.test(elem)){nodes.push(context.createTextNode(elem))}else{tmp=tmp||fragment.appendChild(context.createElement("div"));tag=(rtagName.exec(elem)||["",""])[1].toLowerCase();wrap=wrapMap[tag]||wrapMap._default;tmp.innerHTML=wrap[1]+elem.replace(rxhtmlTag,"<$1></$2>")+wrap[2];j=wrap[0];while(j--){tmp=tmp.lastChild}jQuery.merge(nodes,tmp.childNodes);tmp=fragment.firstChild;tmp.textContent=""}}}fragment.textContent="";i=0;while(elem=nodes[i++]){if(selection&&jQuery.inArray(elem,selection)!==-1){continue}contains=jQuery.contains(elem.ownerDocument,elem);tmp=getAll(fragment.appendChild(elem),"script");if(contains){setGlobalEval(tmp)}if(scripts){j=0;while(elem=tmp[j++]){if(rscriptType.test(elem.type||"")){scripts.push(elem)}}}}return fragment},cleanData:function(elems){var data,elem,type,key,special=jQuery.event.special,i=0;for(;(elem=elems[i])!==undefined;i++){if(jQuery.acceptData(elem)){key=elem[data_priv.expando];if(key&&(data=data_priv.cache[key])){if(data.events){for(type in data.events){if(special[type]){jQuery.event.remove(elem,type)}else{jQuery.removeEvent(elem,type,data.handle)}}}if(data_priv.cache[key]){delete data_priv.cache[key]
}}}delete data_user.cache[elem[data_user.expando]]}}});jQuery.fn.extend({text:function(value){return access(this,function(value){return value===undefined?jQuery.text(this):this.empty().each(function(){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){this.textContent=value}})},null,value,arguments.length)},append:function(){return this.domManip(arguments,function(elem){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var target=manipulationTarget(this,elem);target.appendChild(elem)}})},prepend:function(){return this.domManip(arguments,function(elem){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}})},before:function(){return this.domManip(arguments,function(elem){if(this.parentNode){this.parentNode.insertBefore(elem,this)}})},after:function(){return this.domManip(arguments,function(elem){if(this.parentNode){this.parentNode.insertBefore(elem,this.nextSibling)}})},remove:function(selector,keepData){var elem,elems=selector?jQuery.filter(selector,this):this,i=0;for(;(elem=elems[i])!=null;i++){if(!keepData&&elem.nodeType===1){jQuery.cleanData(getAll(elem))}if(elem.parentNode){if(keepData&&jQuery.contains(elem.ownerDocument,elem)){setGlobalEval(getAll(elem,"script"))}elem.parentNode.removeChild(elem)}}return this},empty:function(){var elem,i=0;for(;(elem=this[i])!=null;i++){if(elem.nodeType===1){jQuery.cleanData(getAll(elem,false));elem.textContent=""}}return this},clone:function(dataAndEvents,deepDataAndEvents){dataAndEvents=dataAndEvents==null?false:dataAndEvents;deepDataAndEvents=deepDataAndEvents==null?dataAndEvents:deepDataAndEvents;return this.map(function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)})},html:function(value){return access(this,function(value){var elem=this[0]||{},i=0,l=this.length;if(value===undefined&&elem.nodeType===1){return elem.innerHTML}if(typeof value==="string"&&!rnoInnerhtml.test(value)&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=value.replace(rxhtmlTag,"<$1></$2>");try{for(;i<l;i++){elem=this[i]||{};if(elem.nodeType===1){jQuery.cleanData(getAll(elem,false));elem.innerHTML=value}}elem=0}catch(e){}}if(elem){this.empty().append(value)}},null,value,arguments.length)},replaceWith:function(){var arg=arguments[0];this.domManip(arguments,function(elem){arg=this.parentNode;jQuery.cleanData(getAll(this));if(arg){arg.replaceChild(elem,this)}});return arg&&(arg.length||arg.nodeType)?this:this.remove()},detach:function(selector){return this.remove(selector,true)},domManip:function(args,callback){args=concat.apply([],args);var fragment,first,scripts,hasScripts,node,doc,i=0,l=this.length,set=this,iNoClone=l-1,value=args[0],isFunction=jQuery.isFunction(value);if(isFunction||l>1&&typeof value==="string"&&!support.checkClone&&rchecked.test(value)){return this.each(function(index){var self=set.eq(index);if(isFunction){args[0]=value.call(this,index,self.html())}self.domManip(args,callback)})}if(l){fragment=jQuery.buildFragment(args,this[0].ownerDocument,false,this);first=fragment.firstChild;if(fragment.childNodes.length===1){fragment=first}if(first){scripts=jQuery.map(getAll(fragment,"script"),disableScript);hasScripts=scripts.length;for(;i<l;i++){node=fragment;if(i!==iNoClone){node=jQuery.clone(node,true,true);if(hasScripts){jQuery.merge(scripts,getAll(node,"script"))}}callback.call(this[i],node,i)}if(hasScripts){doc=scripts[scripts.length-1].ownerDocument;jQuery.map(scripts,restoreScript);for(i=0;i<hasScripts;i++){node=scripts[i];if(rscriptType.test(node.type||"")&&!data_priv.access(node,"globalEval")&&jQuery.contains(doc,node)){if(node.src){if(jQuery._evalUrl){jQuery._evalUrl(node.src)}}else{jQuery.globalEval(node.textContent.replace(rcleanScript,""))}}}}}}return this}});jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(name,original){jQuery.fn[name]=function(selector){var elems,ret=[],insert=jQuery(selector),last=insert.length-1,i=0;for(;i<=last;i++){elems=i===last?this:this.clone(true);jQuery(insert[i])[original](elems);push.apply(ret,elems.get())}return this.pushStack(ret)}});var iframe,elemdisplay={};function actualDisplay(name,doc){var style,elem=jQuery(doc.createElement(name)).appendTo(doc.body),display=window.getDefaultComputedStyle&&(style=window.getDefaultComputedStyle(elem[0]))?style.display:jQuery.css(elem[0],"display");elem.detach();return display}function defaultDisplay(nodeName){var doc=document,display=elemdisplay[nodeName];if(!display){display=actualDisplay(nodeName,doc);if(display==="none"||!display){iframe=(iframe||jQuery("<iframe frameborder='0' width='0' height='0'/>")).appendTo(doc.documentElement);doc=iframe[0].contentDocument;doc.write();doc.close();display=actualDisplay(nodeName,doc);iframe.detach()}elemdisplay[nodeName]=display}return display}var rmargin=/^margin/;var rnumnonpx=new RegExp("^("+pnum+")(?!px)[a-z%]+$","i");var getStyles=function(elem){return elem.ownerDocument.defaultView.getComputedStyle(elem,null)};function curCSS(elem,name,computed){var width,minWidth,maxWidth,ret,style=elem.style;computed=computed||getStyles(elem);if(computed){ret=computed.getPropertyValue(name)||computed[name]}if(computed){if(ret===""&&!jQuery.contains(elem.ownerDocument,elem)){ret=jQuery.style(elem,name)}if(rnumnonpx.test(ret)&&rmargin.test(name)){width=style.width;minWidth=style.minWidth;maxWidth=style.maxWidth;style.minWidth=style.maxWidth=style.width=ret;ret=computed.width;style.width=width;style.minWidth=minWidth;style.maxWidth=maxWidth}}return ret!==undefined?ret+"":ret}function addGetHookIf(conditionFn,hookFn){return{get:function(){if(conditionFn()){delete this.get;return}return(this.get=hookFn).apply(this,arguments)}}}(function(){var pixelPositionVal,boxSizingReliableVal,docElem=document.documentElement,container=document.createElement("div"),div=document.createElement("div");if(!div.style){return}div.style.backgroundClip="content-box";div.cloneNode(true).style.backgroundClip="";support.clearCloneStyle=div.style.backgroundClip==="content-box";container.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;"+"position:absolute";container.appendChild(div);function computePixelPositionAndBoxSizingReliable(){div.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;"+"box-sizing:border-box;display:block;margin-top:1%;top:1%;"+"border:1px;padding:1px;width:4px;position:absolute";div.innerHTML="";docElem.appendChild(container);var divStyle=window.getComputedStyle(div,null);pixelPositionVal=divStyle.top!=="1%";boxSizingReliableVal=divStyle.width==="4px";docElem.removeChild(container)}if(window.getComputedStyle){jQuery.extend(support,{pixelPosition:function(){computePixelPositionAndBoxSizingReliable();return pixelPositionVal},boxSizingReliable:function(){if(boxSizingReliableVal==null){computePixelPositionAndBoxSizingReliable()}return boxSizingReliableVal},reliableMarginRight:function(){var ret,marginDiv=div.appendChild(document.createElement("div"));marginDiv.style.cssText=div.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;"+"box-sizing:content-box;display:block;margin:0;border:0;padding:0";marginDiv.style.marginRight=marginDiv.style.width="0";div.style.width="1px";docElem.appendChild(container);ret=!parseFloat(window.getComputedStyle(marginDiv,null).marginRight);docElem.removeChild(container);return ret}})}})();jQuery.swap=function(elem,options,callback,args){var ret,name,old={};for(name in options){old[name]=elem.style[name];elem.style[name]=options[name]}ret=callback.apply(elem,args||[]);for(name in options){elem.style[name]=old[name]}return ret};var rdisplayswap=/^(none|table(?!-c[ea]).+)/,rnumsplit=new RegExp("^("+pnum+")(.*)$","i"),rrelNum=new RegExp("^([+-])=("+pnum+")","i"),cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:"0",fontWeight:"400"},cssPrefixes=["Webkit","O","Moz","ms"];function vendorPropName(style,name){if(name in style){return name}var capName=name[0].toUpperCase()+name.slice(1),origName=name,i=cssPrefixes.length;while(i--){name=cssPrefixes[i]+capName;if(name in style){return name}}return origName}function setPositiveNumber(elem,value,subtract){var matches=rnumsplit.exec(value);return matches?Math.max(0,matches[1]-(subtract||0))+(matches[2]||"px"):value}function augmentWidthOrHeight(elem,name,extra,isBorderBox,styles){var i=extra===(isBorderBox?"border":"content")?4:name==="width"?1:0,val=0;for(;i<4;i+=2){if(extra==="margin"){val+=jQuery.css(elem,extra+cssExpand[i],true,styles)}if(isBorderBox){if(extra==="content"){val-=jQuery.css(elem,"padding"+cssExpand[i],true,styles)}if(extra!=="margin"){val-=jQuery.css(elem,"border"+cssExpand[i]+"Width",true,styles)}}else{val+=jQuery.css(elem,"padding"+cssExpand[i],true,styles);if(extra!=="padding"){val+=jQuery.css(elem,"border"+cssExpand[i]+"Width",true,styles)}}}return val}function getWidthOrHeight(elem,name,extra){var valueIsBorderBox=true,val=name==="width"?elem.offsetWidth:elem.offsetHeight,styles=getStyles(elem),isBorderBox=jQuery.css(elem,"boxSizing",false,styles)==="border-box";if(val<=0||val==null){val=curCSS(elem,name,styles);if(val<0||val==null){val=elem.style[name]}if(rnumnonpx.test(val)){return val}valueIsBorderBox=isBorderBox&&(support.boxSizingReliable()||val===elem.style[name]);val=parseFloat(val)||0}return val+augmentWidthOrHeight(elem,name,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles)+"px"}function showHide(elements,show){var display,elem,hidden,values=[],index=0,length=elements.length;for(;index<length;index++){elem=elements[index];if(!elem.style){continue}values[index]=data_priv.get(elem,"olddisplay");display=elem.style.display;if(show){if(!values[index]&&display==="none"){elem.style.display=""}if(elem.style.display===""&&isHidden(elem)){values[index]=data_priv.access(elem,"olddisplay",defaultDisplay(elem.nodeName))}}else{hidden=isHidden(elem);if(display!=="none"||!hidden){data_priv.set(elem,"olddisplay",hidden?display:jQuery.css(elem,"display"))}}}for(index=0;index<length;index++){elem=elements[index];if(!elem.style){continue}if(!show||elem.style.display==="none"||elem.style.display===""){elem.style.display=show?values[index]||"":"none"}}return elements}jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");return ret===""?"1":ret}}}},cssNumber:{columnCount:true,fillOpacity:true,flexGrow:true,flexShrink:true,fontWeight:true,lineHeight:true,opacity:true,order:true,orphans:true,widows:true,zIndex:true,zoom:true},cssProps:{"float":"cssFloat"},style:function(elem,name,value,extra){if(!elem||elem.nodeType===3||elem.nodeType===8||!elem.style){return}var ret,type,hooks,origName=jQuery.camelCase(name),style=elem.style;name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(style,origName));hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName];if(value!==undefined){type=typeof value;if(type==="string"&&(ret=rrelNum.exec(value))){value=(ret[1]+1)*ret[2]+parseFloat(jQuery.css(elem,name));type="number"}if(value==null||value!==value){return}if(type==="number"&&!jQuery.cssNumber[origName]){value+="px"}if(!support.clearCloneStyle&&value===""&&name.indexOf("background")===0){style[name]="inherit"}if(!hooks||!("set"in hooks)||(value=hooks.set(elem,value,extra))!==undefined){style[name]=value}}else{if(hooks&&"get"in hooks&&(ret=hooks.get(elem,false,extra))!==undefined){return ret}return style[name]}},css:function(elem,name,extra,styles){var val,num,hooks,origName=jQuery.camelCase(name);name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(elem.style,origName));hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName];if(hooks&&"get"in hooks){val=hooks.get(elem,true,extra)}if(val===undefined){val=curCSS(elem,name,styles)}if(val==="normal"&&name in cssNormalTransform){val=cssNormalTransform[name]}if(extra===""||extra){num=parseFloat(val);return extra===true||jQuery.isNumeric(num)?num||0:val}return val}});jQuery.each(["height","width"],function(i,name){jQuery.cssHooks[name]={get:function(elem,computed,extra){if(computed){return rdisplayswap.test(jQuery.css(elem,"display"))&&elem.offsetWidth===0?jQuery.swap(elem,cssShow,function(){return getWidthOrHeight(elem,name,extra)}):getWidthOrHeight(elem,name,extra)}},set:function(elem,value,extra){var styles=extra&&getStyles(elem);return setPositiveNumber(elem,value,extra?augmentWidthOrHeight(elem,name,extra,jQuery.css(elem,"boxSizing",false,styles)==="border-box",styles):0)}}});jQuery.cssHooks.marginRight=addGetHookIf(support.reliableMarginRight,function(elem,computed){if(computed){return jQuery.swap(elem,{display:"inline-block"},curCSS,[elem,"marginRight"])}});jQuery.each({margin:"",padding:"",border:"Width"},function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){var i=0,expanded={},parts=typeof value==="string"?value.split(" "):[value];for(;i<4;i++){expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0]}return expanded}};if(!rmargin.test(prefix)){jQuery.cssHooks[prefix+suffix].set=setPositiveNumber}});jQuery.fn.extend({css:function(name,value){return access(this,function(elem,name,value){var styles,len,map={},i=0;if(jQuery.isArray(name)){styles=getStyles(elem);len=name.length;for(;i<len;i++){map[name[i]]=jQuery.css(elem,name[i],false,styles)}return map}return value!==undefined?jQuery.style(elem,name,value):jQuery.css(elem,name)},name,value,arguments.length>1)},show:function(){return showHide(this,true)},hide:function(){return showHide(this)},toggle:function(state){if(typeof state==="boolean"){return state?this.show():this.hide()}return this.each(function(){if(isHidden(this)){jQuery(this).show()}else{jQuery(this).hide()}})}});function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}jQuery.Tween=Tween;Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem;this.prop=prop;this.easing=easing||"swing";this.options=options;this.start=this.now=this.cur();this.end=end;this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];if(this.options.duration){this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration)}else{this.pos=eased=percent}this.now=(this.end-this.start)*eased+this.start;if(this.options.step){this.options.step.call(this.elem,this.now,this)}if(hooks&&hooks.set){hooks.set(this)}else{Tween.propHooks._default.set(this)}return this}};Tween.prototype.init.prototype=Tween.prototype;Tween.propHooks={_default:{get:function(tween){var result;if(tween.elem[tween.prop]!=null&&(!tween.elem.style||tween.elem.style[tween.prop]==null)){return tween.elem[tween.prop]}result=jQuery.css(tween.elem,tween.prop,"");return!result||result==="auto"?0:result},set:function(tween){if(jQuery.fx.step[tween.prop]){jQuery.fx.step[tween.prop](tween)}else if(tween.elem.style&&(tween.elem.style[jQuery.cssProps[tween.prop]]!=null||jQuery.cssHooks[tween.prop])){jQuery.style(tween.elem,tween.prop,tween.now+tween.unit)}else{tween.elem[tween.prop]=tween.now}}}};Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){if(tween.elem.nodeType&&tween.elem.parentNode){tween.elem[tween.prop]=tween.now}}};jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2}};jQuery.fx=Tween.prototype.init;jQuery.fx.step={};var fxNow,timerId,rfxtypes=/^(?:toggle|show|hide)$/,rfxnum=new RegExp("^(?:([+-])=|)("+pnum+")([a-z%]*)$","i"),rrun=/queueHooks$/,animationPrefilters=[defaultPrefilter],tweeners={"*":[function(prop,value){var tween=this.createTween(prop,value),target=tween.cur(),parts=rfxnum.exec(value),unit=parts&&parts[3]||(jQuery.cssNumber[prop]?"":"px"),start=(jQuery.cssNumber[prop]||unit!=="px"&&+target)&&rfxnum.exec(jQuery.css(tween.elem,prop)),scale=1,maxIterations=20;if(start&&start[3]!==unit){unit=unit||start[3];parts=parts||[];start=+target||1;do{scale=scale||".5";start=start/scale;jQuery.style(tween.elem,prop,start+unit)}while(scale!==(scale=tween.cur()/target)&&scale!==1&&--maxIterations)}if(parts){start=tween.start=+start||+target||0;tween.unit=unit;tween.end=parts[1]?start+(parts[1]+1)*parts[2]:+parts[2]}return tween}]};function createFxNow(){setTimeout(function(){fxNow=undefined});return fxNow=jQuery.now()}function genFx(type,includeWidth){var which,i=0,attrs={height:type};includeWidth=includeWidth?1:0;for(;i<4;i+=2-includeWidth){which=cssExpand[i];attrs["margin"+which]=attrs["padding"+which]=type}if(includeWidth){attrs.opacity=attrs.width=type}return attrs}function createTween(value,prop,animation){var tween,collection=(tweeners[prop]||[]).concat(tweeners["*"]),index=0,length=collection.length;for(;index<length;index++){if(tween=collection[index].call(animation,prop,value)){return tween}}}function defaultPrefilter(elem,props,opts){var prop,value,toggle,tween,hooks,oldfire,display,checkDisplay,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHidden(elem),dataShow=data_priv.get(elem,"fxshow");if(!opts.queue){hooks=jQuery._queueHooks(elem,"fx");if(hooks.unqueued==null){hooks.unqueued=0;oldfire=hooks.empty.fire;hooks.empty.fire=function(){if(!hooks.unqueued){oldfire()}}}hooks.unqueued++;anim.always(function(){anim.always(function(){hooks.unqueued--;if(!jQuery.queue(elem,"fx").length){hooks.empty.fire()}})})}if(elem.nodeType===1&&("height"in props||"width"in props)){opts.overflow=[style.overflow,style.overflowX,style.overflowY];display=jQuery.css(elem,"display");checkDisplay=display==="none"?data_priv.get(elem,"olddisplay")||defaultDisplay(elem.nodeName):display;if(checkDisplay==="inline"&&jQuery.css(elem,"float")==="none"){style.display="inline-block"}}if(opts.overflow){style.overflow="hidden";anim.always(function(){style.overflow=opts.overflow[0];style.overflowX=opts.overflow[1];style.overflowY=opts.overflow[2]})}for(prop in props){value=props[prop];if(rfxtypes.exec(value)){delete props[prop];toggle=toggle||value==="toggle";if(value===(hidden?"hide":"show")){if(value==="show"&&dataShow&&dataShow[prop]!==undefined){hidden=true}else{continue}}orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}else{display=undefined}}if(!jQuery.isEmptyObject(orig)){if(dataShow){if("hidden"in dataShow){hidden=dataShow.hidden}}else{dataShow=data_priv.access(elem,"fxshow",{})}if(toggle){dataShow.hidden=!hidden}if(hidden){jQuery(elem).show()}else{anim.done(function(){jQuery(elem).hide()})}anim.done(function(){var prop;data_priv.remove(elem,"fxshow");for(prop in orig){jQuery.style(elem,prop,orig[prop])}});for(prop in orig){tween=createTween(hidden?dataShow[prop]:0,prop,anim);if(!(prop in dataShow)){dataShow[prop]=tween.start;if(hidden){tween.end=tween.start;tween.start=prop==="width"||prop==="height"?1:0}}}}else if((display==="none"?defaultDisplay(elem.nodeName):display)==="inline"){style.display=display}}function propFilter(props,specialEasing){var index,name,easing,value,hooks;for(index in props){name=jQuery.camelCase(index);easing=specialEasing[name];value=props[index];if(jQuery.isArray(value)){easing=value[1];value=props[index]=value[0]}if(index!==name){props[name]=value;delete props[index]}hooks=jQuery.cssHooks[name];if(hooks&&"expand"in hooks){value=hooks.expand(value);delete props[name];for(index in value){if(!(index in props)){props[index]=value[index];specialEasing[index]=easing}}}else{specialEasing[name]=easing}}}function Animation(elem,properties,options){var result,stopped,index=0,length=animationPrefilters.length,deferred=jQuery.Deferred().always(function(){delete tick.elem}),tick=function(){if(stopped){return false}var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),temp=remaining/animation.duration||0,percent=1-temp,index=0,length=animation.tweens.length;for(;index<length;index++){animation.tweens[index].run(percent)}deferred.notifyWith(elem,[animation,percent,remaining]);if(percent<1&&length){return remaining}else{deferred.resolveWith(elem,[animation]);return false}},animation=deferred.promise({elem:elem,props:jQuery.extend({},properties),opts:jQuery.extend(true,{specialEasing:{}},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);animation.tweens.push(tween);return tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped){return this}stopped=true;for(;index<length;index++){animation.tweens[index].run(1)}if(gotoEnd){deferred.resolveWith(elem,[animation,gotoEnd])}else{deferred.rejectWith(elem,[animation,gotoEnd])}return this}}),props=animation.props;propFilter(props,animation.opts.specialEasing);for(;index<length;index++){result=animationPrefilters[index].call(animation,elem,props,animation.opts);if(result){return result}}jQuery.map(props,createTween,animation);if(jQuery.isFunction(animation.opts.start)){animation.opts.start.call(elem,animation)}jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue}));return animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always)}jQuery.Animation=jQuery.extend(Animation,{tweener:function(props,callback){if(jQuery.isFunction(props)){callback=props;props=["*"]}else{props=props.split(" ")}var prop,index=0,length=props.length;for(;index<length;index++){prop=props[index];tweeners[prop]=tweeners[prop]||[];tweeners[prop].unshift(callback)}},prefilter:function(callback,prepend){if(prepend){animationPrefilters.unshift(callback)}else{animationPrefilters.push(callback)}}});jQuery.speed=function(speed,easing,fn){var opt=speed&&typeof speed==="object"?jQuery.extend({},speed):{complete:fn||!fn&&easing||jQuery.isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!jQuery.isFunction(easing)&&easing};opt.duration=jQuery.fx.off?0:typeof opt.duration==="number"?opt.duration:opt.duration in jQuery.fx.speeds?jQuery.fx.speeds[opt.duration]:jQuery.fx.speeds._default;if(opt.queue==null||opt.queue===true){opt.queue="fx"}opt.old=opt.complete;opt.complete=function(){if(jQuery.isFunction(opt.old)){opt.old.call(this)}if(opt.queue){jQuery.dequeue(this,opt.queue)}};return opt};jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHidden).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);if(empty||data_priv.get(this,"finish")){anim.stop(true)}};doAnimation.finish=doAnimation;return empty||optall.queue===false?this.each(doAnimation):this.queue(optall.queue,doAnimation)},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop;stop(gotoEnd)};if(typeof type!=="string"){gotoEnd=clearQueue;clearQueue=type;type=undefined}if(clearQueue&&type!==false){this.queue(type||"fx",[])}return this.each(function(){var dequeue=true,index=type!=null&&type+"queueHooks",timers=jQuery.timers,data=data_priv.get(this);if(index){if(data[index]&&data[index].stop){stopQueue(data[index])}}else{for(index in data){if(data[index]&&data[index].stop&&rrun.test(index)){stopQueue(data[index])}}}for(index=timers.length;index--;){if(timers[index].elem===this&&(type==null||timers[index].queue===type)){timers[index].anim.stop(gotoEnd);dequeue=false;timers.splice(index,1)}}if(dequeue||!gotoEnd){jQuery.dequeue(this,type)}})},finish:function(type){if(type!==false){type=type||"fx"}return this.each(function(){var index,data=data_priv.get(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;data.finish=true;jQuery.queue(this,type,[]);if(hooks&&hooks.stop){hooks.stop.call(this,true)}for(index=timers.length;index--;){if(timers[index].elem===this&&timers[index].queue===type){timers[index].anim.stop(true);timers.splice(index,1)}}for(index=0;index<length;index++){if(queue[index]&&queue[index].finish){queue[index].finish.call(this)}}delete data.finish})}});jQuery.each(["toggle","show","hide"],function(i,name){var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return speed==null||typeof speed==="boolean"?cssFn.apply(this,arguments):this.animate(genFx(name,true),speed,easing,callback)}});jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}});jQuery.timers=[];jQuery.fx.tick=function(){var timer,i=0,timers=jQuery.timers;fxNow=jQuery.now();for(;i<timers.length;i++){timer=timers[i];if(!timer()&&timers[i]===timer){timers.splice(i--,1)}}if(!timers.length){jQuery.fx.stop()}fxNow=undefined};jQuery.fx.timer=function(timer){jQuery.timers.push(timer);if(timer()){jQuery.fx.start()}else{jQuery.timers.pop()}};jQuery.fx.interval=13;jQuery.fx.start=function(){if(!timerId){timerId=setInterval(jQuery.fx.tick,jQuery.fx.interval)}};jQuery.fx.stop=function(){clearInterval(timerId);timerId=null};jQuery.fx.speeds={slow:600,fast:200,_default:400};jQuery.fn.delay=function(time,type){time=jQuery.fx?jQuery.fx.speeds[time]||time:time;type=type||"fx";return this.queue(type,function(next,hooks){var timeout=setTimeout(next,time);hooks.stop=function(){clearTimeout(timeout)}})};(function(){var input=document.createElement("input"),select=document.createElement("select"),opt=select.appendChild(document.createElement("option"));input.type="checkbox";support.checkOn=input.value!=="";support.optSelected=opt.selected;select.disabled=true;support.optDisabled=!opt.disabled;input=document.createElement("input");input.value="t";input.type="radio";support.radioValue=input.value==="t"})();var nodeHook,boolHook,attrHandle=jQuery.expr.attrHandle;jQuery.fn.extend({attr:function(name,value){return access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each(function(){jQuery.removeAttr(this,name)})}});jQuery.extend({attr:function(elem,name,value){var hooks,ret,nType=elem.nodeType;if(!elem||nType===3||nType===8||nType===2){return}if(typeof elem.getAttribute===strundefined){return jQuery.prop(elem,name,value)}if(nType!==1||!jQuery.isXMLDoc(elem)){name=name.toLowerCase();hooks=jQuery.attrHooks[name]||(jQuery.expr.match.bool.test(name)?boolHook:nodeHook)}if(value!==undefined){if(value===null){jQuery.removeAttr(elem,name)}else if(hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined){return ret}else{elem.setAttribute(name,value+"");return value}}else if(hooks&&"get"in hooks&&(ret=hooks.get(elem,name))!==null){return ret}else{ret=jQuery.find.attr(elem,name);return ret==null?undefined:ret}},removeAttr:function(elem,value){var name,propName,i=0,attrNames=value&&value.match(rnotwhite);if(attrNames&&elem.nodeType===1){while(name=attrNames[i++]){propName=jQuery.propFix[name]||name;if(jQuery.expr.match.bool.test(name)){elem[propName]=false}elem.removeAttribute(name)}}},attrHooks:{type:{set:function(elem,value){if(!support.radioValue&&value==="radio"&&jQuery.nodeName(elem,"input")){var val=elem.value;elem.setAttribute("type",value);if(val){elem.value=val}return value}}}}});boolHook={set:function(elem,value,name){if(value===false){jQuery.removeAttr(elem,name)}else{elem.setAttribute(name,name)}return name}};jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),function(i,name){var getter=attrHandle[name]||jQuery.find.attr;attrHandle[name]=function(elem,name,isXML){var ret,handle;if(!isXML){handle=attrHandle[name];attrHandle[name]=ret;ret=getter(elem,name,isXML)!=null?name.toLowerCase():null;attrHandle[name]=handle}return ret}});var rfocusable=/^(?:input|select|textarea|button)$/i;jQuery.fn.extend({prop:function(name,value){return access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return this.each(function(){delete this[jQuery.propFix[name]||name]})}});jQuery.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(elem,name,value){var ret,hooks,notxml,nType=elem.nodeType;if(!elem||nType===3||nType===8||nType===2){return}notxml=nType!==1||!jQuery.isXMLDoc(elem);if(notxml){name=jQuery.propFix[name]||name;hooks=jQuery.propHooks[name]}if(value!==undefined){return hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined?ret:elem[name]=value}else{return hooks&&"get"in hooks&&(ret=hooks.get(elem,name))!==null?ret:elem[name]}},propHooks:{tabIndex:{get:function(elem){return elem.hasAttribute("tabindex")||rfocusable.test(elem.nodeName)||elem.href?elem.tabIndex:-1}}}});if(!support.optSelected){jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;if(parent&&parent.parentNode){parent.parentNode.selectedIndex}return null}}}jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){jQuery.propFix[this.toLowerCase()]=this});var rclass=/[\t\r\n\f]/g;jQuery.fn.extend({addClass:function(value){var classes,elem,cur,clazz,j,finalValue,proceed=typeof value==="string"&&value,i=0,len=this.length;if(jQuery.isFunction(value)){return this.each(function(j){jQuery(this).addClass(value.call(this,j,this.className))})}if(proceed){classes=(value||"").match(rnotwhite)||[];for(;i<len;i++){elem=this[i];cur=elem.nodeType===1&&(elem.className?(" "+elem.className+" ").replace(rclass," "):" ");if(cur){j=0;while(clazz=classes[j++]){if(cur.indexOf(" "+clazz+" ")<0){cur+=clazz+" "}}finalValue=jQuery.trim(cur);if(elem.className!==finalValue){elem.className=finalValue}}}}return this},removeClass:function(value){var classes,elem,cur,clazz,j,finalValue,proceed=arguments.length===0||typeof value==="string"&&value,i=0,len=this.length;if(jQuery.isFunction(value)){return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.className))})}if(proceed){classes=(value||"").match(rnotwhite)||[];for(;i<len;i++){elem=this[i];cur=elem.nodeType===1&&(elem.className?(" "+elem.className+" ").replace(rclass," "):"");if(cur){j=0;while(clazz=classes[j++]){while(cur.indexOf(" "+clazz+" ")>=0){cur=cur.replace(" "+clazz+" "," ")}}finalValue=value?jQuery.trim(cur):"";if(elem.className!==finalValue){elem.className=finalValue}}}}return this},toggleClass:function(value,stateVal){var type=typeof value;if(typeof stateVal==="boolean"&&type==="string"){return stateVal?this.addClass(value):this.removeClass(value)}if(jQuery.isFunction(value)){return this.each(function(i){jQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal)})}return this.each(function(){if(type==="string"){var className,i=0,self=jQuery(this),classNames=value.match(rnotwhite)||[];while(className=classNames[i++]){if(self.hasClass(className)){self.removeClass(className)}else{self.addClass(className)}}}else if(type===strundefined||type==="boolean"){if(this.className){data_priv.set(this,"__className__",this.className)}this.className=this.className||value===false?"":data_priv.get(this,"__className__")||""}})},hasClass:function(selector){var className=" "+selector+" ",i=0,l=this.length;for(;i<l;i++){if(this[i].nodeType===1&&(" "+this[i].className+" ").replace(rclass," ").indexOf(className)>=0){return true}}return false}});var rreturn=/\r/g;jQuery.fn.extend({val:function(value){var hooks,ret,isFunction,elem=this[0];if(!arguments.length){if(elem){hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()];if(hooks&&"get"in hooks&&(ret=hooks.get(elem,"value"))!==undefined){return ret
}ret=elem.value;return typeof ret==="string"?ret.replace(rreturn,""):ret==null?"":ret}return}isFunction=jQuery.isFunction(value);return this.each(function(i){var val;if(this.nodeType!==1){return}if(isFunction){val=value.call(this,i,jQuery(this).val())}else{val=value}if(val==null){val=""}else if(typeof val==="number"){val+=""}else if(jQuery.isArray(val)){val=jQuery.map(val,function(value){return value==null?"":value+""})}hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()];if(!hooks||!("set"in hooks)||hooks.set(this,val,"value")===undefined){this.value=val}})}});jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return val!=null?val:jQuery.trim(jQuery.text(elem))}},select:{get:function(elem){var value,option,options=elem.options,index=elem.selectedIndex,one=elem.type==="select-one"||index<0,values=one?null:[],max=one?index+1:options.length,i=index<0?max:one?index:0;for(;i<max;i++){option=options[i];if((option.selected||i===index)&&(support.optDisabled?!option.disabled:option.getAttribute("disabled")===null)&&(!option.parentNode.disabled||!jQuery.nodeName(option.parentNode,"optgroup"))){value=jQuery(option).val();if(one){return value}values.push(value)}}return values},set:function(elem,value){var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;while(i--){option=options[i];if(option.selected=jQuery.inArray(option.value,values)>=0){optionSet=true}}if(!optionSet){elem.selectedIndex=-1}return values}}}});jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]={set:function(elem,value){if(jQuery.isArray(value)){return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>=0}}};if(!support.checkOn){jQuery.valHooks[this].get=function(elem){return elem.getAttribute("value")===null?"on":elem.value}}});jQuery.each(("blur focus focusin focusout load resize scroll unload click dblclick "+"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave "+"change select submit keydown keypress keyup error contextmenu").split(" "),function(i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}});jQuery.fn.extend({hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)},bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return arguments.length===1?this.off(selector,"**"):this.off(types,selector||"**",fn)}});var nonce=jQuery.now();var rquery=/\?/;jQuery.parseJSON=function(data){return JSON.parse(data+"")};jQuery.parseXML=function(data){var xml,tmp;if(!data||typeof data!=="string"){return null}try{tmp=new DOMParser;xml=tmp.parseFromString(data,"text/xml")}catch(e){xml=undefined}if(!xml||xml.getElementsByTagName("parsererror").length){jQuery.error("Invalid XML: "+data)}return xml};var ajaxLocParts,ajaxLocation,rhash=/#.*$/,rts=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)$/gm,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rurl=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,prefilters={},transports={},allTypes="*/".concat("*");try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a");ajaxLocation.href="";ajaxLocation=ajaxLocation.href}ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[];function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){if(typeof dataTypeExpression!=="string"){func=dataTypeExpression;dataTypeExpression="*"}var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(rnotwhite)||[];if(jQuery.isFunction(func)){while(dataType=dataTypes[i++]){if(dataType[0]==="+"){dataType=dataType.slice(1)||"*";(structure[dataType]=structure[dataType]||[]).unshift(func)}else{(structure[dataType]=structure[dataType]||[]).push(func)}}}}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){var inspected={},seekingTransport=structure===transports;function inspect(dataType){var selected;inspected[dataType]=true;jQuery.each(structure[dataType]||[],function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);if(typeof dataTypeOrTransport==="string"&&!seekingTransport&&!inspected[dataTypeOrTransport]){options.dataTypes.unshift(dataTypeOrTransport);inspect(dataTypeOrTransport);return false}else if(seekingTransport){return!(selected=dataTypeOrTransport)}});return selected}return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var key,deep,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src){if(src[key]!==undefined){(flatOptions[key]?target:deep||(deep={}))[key]=src[key]}}if(deep){jQuery.extend(true,target,deep)}return target}function ajaxHandleResponses(s,jqXHR,responses){var ct,type,finalDataType,firstDataType,contents=s.contents,dataTypes=s.dataTypes;while(dataTypes[0]==="*"){dataTypes.shift();if(ct===undefined){ct=s.mimeType||jqXHR.getResponseHeader("Content-Type")}}if(ct){for(type in contents){if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}}}if(dataTypes[0]in responses){finalDataType=dataTypes[0]}else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}if(!firstDataType){firstDataType=type}}finalDataType=finalDataType||firstDataType}if(finalDataType){if(finalDataType!==dataTypes[0]){dataTypes.unshift(finalDataType)}return responses[finalDataType]}}function ajaxConvert(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1]){for(conv in s.converters){converters[conv.toLowerCase()]=s.converters[conv]}}current=dataTypes.shift();while(current){if(s.responseFields[current]){jqXHR[s.responseFields[current]]=response}if(!prev&&isSuccess&&s.dataFilter){response=s.dataFilter(response,s.dataType)}prev=current;current=dataTypes.shift();if(current){if(current==="*"){current=prev}else if(prev!=="*"&&prev!==current){conv=converters[prev+" "+current]||converters["* "+current];if(!conv){for(conv2 in converters){tmp=conv2.split(" ");if(tmp[1]===current){conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]];if(conv){if(conv===true){conv=converters[conv2]}else if(converters[conv2]!==true){current=tmp[0];dataTypes.unshift(tmp[1])}break}}}}if(conv!==true){if(conv&&s["throws"]){response=conv(response)}else{try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}}}}}return{state:"success",data:response}}jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ajaxLocation,type:"GET",isLocal:rlocalProtocol.test(ajaxLocParts[1]),global:true,processData:true,async:true,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":true,"text json":jQuery.parseJSON,"text xml":jQuery.parseXML},flatOptions:{url:true,context:true}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){if(typeof url==="object"){options=url;url=undefined}options=options||{};var transport,cacheURL,responseHeadersString,responseHeaders,timeoutTimer,parts,fireGlobals,i,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},state=0,strAbort="canceled",jqXHR={readyState:0,getResponseHeader:function(key){var match;if(state===2){if(!responseHeaders){responseHeaders={};while(match=rheaders.exec(responseHeadersString)){responseHeaders[match[1].toLowerCase()]=match[2]}}match=responseHeaders[key.toLowerCase()]}return match==null?null:match},getAllResponseHeaders:function(){return state===2?responseHeadersString:null},setRequestHeader:function(name,value){var lname=name.toLowerCase();if(!state){name=requestHeadersNames[lname]=requestHeadersNames[lname]||name;requestHeaders[name]=value}return this},overrideMimeType:function(type){if(!state){s.mimeType=type}return this},statusCode:function(map){var code;if(map){if(state<2){for(code in map){statusCode[code]=[statusCode[code],map[code]]}}else{jqXHR.always(map[jqXHR.status])}}return this},abort:function(statusText){var finalText=statusText||strAbort;if(transport){transport.abort(finalText)}done(0,finalText);return this}};deferred.promise(jqXHR).complete=completeDeferred.add;jqXHR.success=jqXHR.done;jqXHR.error=jqXHR.fail;s.url=((url||s.url||ajaxLocation)+"").replace(rhash,"").replace(rprotocol,ajaxLocParts[1]+"//");s.type=options.method||options.type||s.method||s.type;s.dataTypes=jQuery.trim(s.dataType||"*").toLowerCase().match(rnotwhite)||[""];if(s.crossDomain==null){parts=rurl.exec(s.url.toLowerCase());s.crossDomain=!!(parts&&(parts[1]!==ajaxLocParts[1]||parts[2]!==ajaxLocParts[2]||(parts[3]||(parts[1]==="http:"?"80":"443"))!==(ajaxLocParts[3]||(ajaxLocParts[1]==="http:"?"80":"443"))))}if(s.data&&s.processData&&typeof s.data!=="string"){s.data=jQuery.param(s.data,s.traditional)}inspectPrefiltersOrTransports(prefilters,s,options,jqXHR);if(state===2){return jqXHR}fireGlobals=s.global;if(fireGlobals&&jQuery.active++===0){jQuery.event.trigger("ajaxStart")}s.type=s.type.toUpperCase();s.hasContent=!rnoContent.test(s.type);cacheURL=s.url;if(!s.hasContent){if(s.data){cacheURL=s.url+=(rquery.test(cacheURL)?"&":"?")+s.data;delete s.data}if(s.cache===false){s.url=rts.test(cacheURL)?cacheURL.replace(rts,"$1_="+nonce++):cacheURL+(rquery.test(cacheURL)?"&":"?")+"_="+nonce++}}if(s.ifModified){if(jQuery.lastModified[cacheURL]){jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL])}if(jQuery.etag[cacheURL]){jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])}}if(s.data&&s.hasContent&&s.contentType!==false||options.contentType){jqXHR.setRequestHeader("Content-Type",s.contentType)}jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+(s.dataTypes[0]!=="*"?", "+allTypes+"; q=0.01":""):s.accepts["*"]);for(i in s.headers){jqXHR.setRequestHeader(i,s.headers[i])}if(s.beforeSend&&(s.beforeSend.call(callbackContext,jqXHR,s)===false||state===2)){return jqXHR.abort()}strAbort="abort";for(i in{success:1,error:1,complete:1}){jqXHR[i](s[i])}transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR);if(!transport){done(-1,"No Transport")}else{jqXHR.readyState=1;if(fireGlobals){globalEventContext.trigger("ajaxSend",[jqXHR,s])}if(s.async&&s.timeout>0){timeoutTimer=setTimeout(function(){jqXHR.abort("timeout")},s.timeout)}try{state=1;transport.send(requestHeaders,done)}catch(e){if(state<2){done(-1,e)}else{throw e}}}function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;if(state===2){return}state=2;if(timeoutTimer){clearTimeout(timeoutTimer)}transport=undefined;responseHeadersString=headers||"";jqXHR.readyState=status>0?4:0;isSuccess=status>=200&&status<300||status===304;if(responses){response=ajaxHandleResponses(s,jqXHR,responses)}response=ajaxConvert(s,response,jqXHR,isSuccess);if(isSuccess){if(s.ifModified){modified=jqXHR.getResponseHeader("Last-Modified");if(modified){jQuery.lastModified[cacheURL]=modified}modified=jqXHR.getResponseHeader("etag");if(modified){jQuery.etag[cacheURL]=modified}}if(status===204||s.type==="HEAD"){statusText="nocontent"}else if(status===304){statusText="notmodified"}else{statusText=response.state;success=response.data;error=response.error;isSuccess=!error}}else{error=statusText;if(status||!statusText){statusText="error";if(status<0){status=0}}}jqXHR.status=status;jqXHR.statusText=(nativeStatusText||statusText)+"";if(isSuccess){deferred.resolveWith(callbackContext,[success,statusText,jqXHR])}else{deferred.rejectWith(callbackContext,[jqXHR,statusText,error])}jqXHR.statusCode(statusCode);statusCode=undefined;if(fireGlobals){globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error])}completeDeferred.fireWith(callbackContext,[jqXHR,statusText]);if(fireGlobals){globalEventContext.trigger("ajaxComplete",[jqXHR,s]);if(!--jQuery.active){jQuery.event.trigger("ajaxStop")}}}return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,undefined,callback,"script")}});jQuery.each(["get","post"],function(i,method){jQuery[method]=function(url,data,callback,type){if(jQuery.isFunction(data)){type=type||callback;callback=data;data=undefined}return jQuery.ajax({url:url,type:method,dataType:type,data:data,success:callback})}});jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}});jQuery._evalUrl=function(url){return jQuery.ajax({url:url,type:"GET",dataType:"script",async:false,global:false,"throws":true})};jQuery.fn.extend({wrapAll:function(html){var wrap;if(jQuery.isFunction(html)){return this.each(function(i){jQuery(this).wrapAll(html.call(this,i))})}if(this[0]){wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(true);if(this[0].parentNode){wrap.insertBefore(this[0])}wrap.map(function(){var elem=this;while(elem.firstElementChild){elem=elem.firstElementChild}return elem}).append(this)}return this},wrapInner:function(html){if(jQuery.isFunction(html)){return this.each(function(i){jQuery(this).wrapInner(html.call(this,i))})}return this.each(function(){var self=jQuery(this),contents=self.contents();if(contents.length){contents.wrapAll(html)}else{self.append(html)}})},wrap:function(html){var isFunction=jQuery.isFunction(html);return this.each(function(i){jQuery(this).wrapAll(isFunction?html.call(this,i):html)})},unwrap:function(){return this.parent().each(function(){if(!jQuery.nodeName(this,"body")){jQuery(this).replaceWith(this.childNodes)}}).end()}});jQuery.expr.filters.hidden=function(elem){return elem.offsetWidth<=0&&elem.offsetHeight<=0};jQuery.expr.filters.visible=function(elem){return!jQuery.expr.filters.hidden(elem)};var r20=/%20/g,rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;function buildParams(prefix,obj,traditional,add){var name;if(jQuery.isArray(obj)){jQuery.each(obj,function(i,v){if(traditional||rbracket.test(prefix)){add(prefix,v)}else{buildParams(prefix+"["+(typeof v==="object"?i:"")+"]",v,traditional,add)}})}else if(!traditional&&jQuery.type(obj)==="object"){for(name in obj){buildParams(prefix+"["+name+"]",obj[name],traditional,add)}}else{add(prefix,obj)}}jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,value){value=jQuery.isFunction(value)?value():value==null?"":value;s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(traditional===undefined){traditional=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional}if(jQuery.isArray(a)||a.jquery&&!jQuery.isPlainObject(a)){jQuery.each(a,function(){add(this.name,this.value)})}else{for(prefix in a){buildParams(prefix,a[prefix],traditional,add)}}return s.join("&").replace(r20,"+")};jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this}).filter(function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!rcheckableType.test(type))}).map(function(i,elem){var val=jQuery(this).val();return val==null?null:jQuery.isArray(val)?jQuery.map(val,function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}):{name:elem.name,value:val.replace(rCRLF,"\r\n")}}).get()}});jQuery.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var xhrId=0,xhrCallbacks={},xhrSuccessStatus={0:200,1223:204},xhrSupported=jQuery.ajaxSettings.xhr();if(window.ActiveXObject){jQuery(window).on("unload",function(){for(var key in xhrCallbacks){xhrCallbacks[key]()}})}support.cors=!!xhrSupported&&"withCredentials"in xhrSupported;support.ajax=xhrSupported=!!xhrSupported;jQuery.ajaxTransport(function(options){var callback;if(support.cors||xhrSupported&&!options.crossDomain){return{send:function(headers,complete){var i,xhr=options.xhr(),id=++xhrId;xhr.open(options.type,options.url,options.async,options.username,options.password);if(options.xhrFields){for(i in options.xhrFields){xhr[i]=options.xhrFields[i]}}if(options.mimeType&&xhr.overrideMimeType){xhr.overrideMimeType(options.mimeType)}if(!options.crossDomain&&!headers["X-Requested-With"]){headers["X-Requested-With"]="XMLHttpRequest"}for(i in headers){xhr.setRequestHeader(i,headers[i])}callback=function(type){return function(){if(callback){delete xhrCallbacks[id];callback=xhr.onload=xhr.onerror=null;if(type==="abort"){xhr.abort()}else if(type==="error"){complete(xhr.status,xhr.statusText)}else{complete(xhrSuccessStatus[xhr.status]||xhr.status,xhr.statusText,typeof xhr.responseText==="string"?{text:xhr.responseText}:undefined,xhr.getAllResponseHeaders())}}}};xhr.onload=callback();xhr.onerror=callback("error");callback=xhrCallbacks[id]=callback("abort");try{xhr.send(options.hasContent&&options.data||null)}catch(e){if(callback){throw e}}},abort:function(){if(callback){callback()}}}}});jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(text){jQuery.globalEval(text);return text}}});jQuery.ajaxPrefilter("script",function(s){if(s.cache===undefined){s.cache=false}if(s.crossDomain){s.type="GET"}});jQuery.ajaxTransport("script",function(s){if(s.crossDomain){var script,callback;return{send:function(_,complete){script=jQuery("<script>").prop({async:true,charset:s.scriptCharset,src:s.url}).on("load error",callback=function(evt){script.remove();callback=null;if(evt){complete(evt.type==="error"?404:200,evt.type)}});document.head.appendChild(script[0])},abort:function(){if(callback){callback()}}}}});var oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+nonce++;this[callback]=true;return callback}});jQuery.ajaxPrefilter("json jsonp",function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=s.jsonp!==false&&(rjsonp.test(s.url)?"url":typeof s.data==="string"&&!(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&rjsonp.test(s.data)&&"data");if(jsonProp||s.dataTypes[0]==="jsonp"){callbackName=s.jsonpCallback=jQuery.isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback;if(jsonProp){s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName)}else if(s.jsonp!==false){s.url+=(rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName}s.converters["script json"]=function(){if(!responseContainer){jQuery.error(callbackName+" was not called")}return responseContainer[0]};s.dataTypes[0]="json";overwritten=window[callbackName];window[callbackName]=function(){responseContainer=arguments};jqXHR.always(function(){window[callbackName]=overwritten;if(s[callbackName]){s.jsonpCallback=originalSettings.jsonpCallback;oldCallbacks.push(callbackName)}if(responseContainer&&jQuery.isFunction(overwritten)){overwritten(responseContainer[0])}responseContainer=overwritten=undefined});return"script"}});jQuery.parseHTML=function(data,context,keepScripts){if(!data||typeof data!=="string"){return null}if(typeof context==="boolean"){keepScripts=context;context=false}context=context||document;var parsed=rsingleTag.exec(data),scripts=!keepScripts&&[];if(parsed){return[context.createElement(parsed[1])]}parsed=jQuery.buildFragment([data],context,scripts);if(scripts&&scripts.length){jQuery(scripts).remove()}return jQuery.merge([],parsed.childNodes)};var _load=jQuery.fn.load;jQuery.fn.load=function(url,params,callback){if(typeof url!=="string"&&_load){return _load.apply(this,arguments)}var selector,type,response,self=this,off=url.indexOf(" ");if(off>=0){selector=jQuery.trim(url.slice(off));url=url.slice(0,off)}if(jQuery.isFunction(params)){callback=params;params=undefined}else if(params&&typeof params==="object"){type="POST"}if(self.length>0){jQuery.ajax({url:url,type:type,dataType:"html",data:params}).done(function(responseText){response=arguments;self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)}).complete(callback&&function(jqXHR,status){self.each(callback,response||[jqXHR.responseText,status,jqXHR])})}return this};jQuery.expr.filters.animated=function(elem){return jQuery.grep(jQuery.timers,function(fn){return elem===fn.elem}).length};var docElem=window.document.documentElement;function getWindow(elem){return jQuery.isWindow(elem)?elem:elem.nodeType===9&&elem.defaultView}jQuery.offset={setOffset:function(elem,options,i){var curPosition,curLeft,curCSSTop,curTop,curOffset,curCSSLeft,calculatePosition,position=jQuery.css(elem,"position"),curElem=jQuery(elem),props={};if(position==="static"){elem.style.position="relative"}curOffset=curElem.offset();curCSSTop=jQuery.css(elem,"top");curCSSLeft=jQuery.css(elem,"left");calculatePosition=(position==="absolute"||position==="fixed")&&(curCSSTop+curCSSLeft).indexOf("auto")>-1;if(calculatePosition){curPosition=curElem.position();curTop=curPosition.top;curLeft=curPosition.left}else{curTop=parseFloat(curCSSTop)||0;curLeft=parseFloat(curCSSLeft)||0}if(jQuery.isFunction(options)){options=options.call(elem,i,curOffset)}if(options.top!=null){props.top=options.top-curOffset.top+curTop}if(options.left!=null){props.left=options.left-curOffset.left+curLeft}if("using"in options){options.using.call(elem,props)}else{curElem.css(props)}}};jQuery.fn.extend({offset:function(options){if(arguments.length){return options===undefined?this:this.each(function(i){jQuery.offset.setOffset(this,options,i)})}var docElem,win,elem=this[0],box={top:0,left:0},doc=elem&&elem.ownerDocument;if(!doc){return}docElem=doc.documentElement;if(!jQuery.contains(docElem,elem)){return box}if(typeof elem.getBoundingClientRect!==strundefined){box=elem.getBoundingClientRect()}win=getWindow(doc);return{top:box.top+win.pageYOffset-docElem.clientTop,left:box.left+win.pageXOffset-docElem.clientLeft}},position:function(){if(!this[0]){return}var offsetParent,offset,elem=this[0],parentOffset={top:0,left:0};if(jQuery.css(elem,"position")==="fixed"){offset=elem.getBoundingClientRect()}else{offsetParent=this.offsetParent();offset=this.offset();if(!jQuery.nodeName(offsetParent[0],"html")){parentOffset=offsetParent.offset()}parentOffset.top+=jQuery.css(offsetParent[0],"borderTopWidth",true);parentOffset.left+=jQuery.css(offsetParent[0],"borderLeftWidth",true)}return{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",true),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",true)}},offsetParent:function(){return this.map(function(){var offsetParent=this.offsetParent||docElem;while(offsetParent&&(!jQuery.nodeName(offsetParent,"html")&&jQuery.css(offsetParent,"position")==="static")){offsetParent=offsetParent.offsetParent}return offsetParent||docElem})}});jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(method,prop){var top="pageYOffset"===prop;jQuery.fn[method]=function(val){return access(this,function(elem,method,val){var win=getWindow(elem);if(val===undefined){return win?win[prop]:elem[method]}if(win){win.scrollTo(!top?val:window.pageXOffset,top?val:window.pageYOffset)}else{elem[method]=val}},method,val,arguments.length,null)}});jQuery.each(["top","left"],function(i,prop){jQuery.cssHooks[prop]=addGetHookIf(support.pixelPosition,function(elem,computed){if(computed){computed=curCSS(elem,prop);return rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed}})});jQuery.each({Height:"height",Width:"width"},function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||typeof margin!=="boolean"),extra=defaultExtra||(margin===true||value===true?"margin":"border");return access(this,function(elem,type,value){var doc;if(jQuery.isWindow(elem)){return elem.document.documentElement["client"+name]}if(elem.nodeType===9){doc=elem.documentElement;return Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])}return value===undefined?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra)},type,chainable?margin:undefined,chainable,null)}})});jQuery.fn.size=function(){return this.length};jQuery.fn.andSelf=jQuery.fn.addBack;if(typeof define==="function"&&define.amd){define("jquery",[],function(){return jQuery})}var _jQuery=window.jQuery,_$=window.$;jQuery.noConflict=function(deep){if(window.$===jQuery){window.$=_$}if(deep&&window.jQuery===jQuery){window.jQuery=_jQuery}return jQuery};if(typeof noGlobal===strundefined){window.jQuery=window.$=jQuery}return jQuery});(function(){var undefined;var idCounter=0;var indicatorObject={};var keyPrefix=+new Date+"";var reInterpolate=/<%=([\s\S]+?)%>/g;var reNoMatch=/($^)/;var reUnescapedString=/['\n\r\t\u2028\u2029\\]/g;var argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]";var objectTypes={"boolean":false,"function":true,object:true,number:false,string:false,undefined:false};var stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"};var root=objectTypes[typeof window]&&window||this;var freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports;var freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module;var moduleExports=freeModule&&freeModule.exports===freeExports&&freeExports;var freeGlobal=objectTypes[typeof global]&&global;if(freeGlobal&&(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal)){root=freeGlobal}function baseIndexOf(array,value,fromIndex){var index=(fromIndex||0)-1,length=array?array.length:0;while(++index<length){if(array[index]===value){return index}}return-1}function compareAscending(a,b){var ac=a.criteria,bc=b.criteria,index=-1,length=ac.length;while(++index<length){var value=ac[index],other=bc[index];if(value!==other){if(value>other||typeof value=="undefined"){return 1}if(value<other||typeof other=="undefined"){return-1}}}return a.index-b.index}function escapeStringChar(match){return"\\"+stringEscapes[match]}function slice(array,start,end){start||(start=0);if(typeof end=="undefined"){end=array?array.length:0}var index=-1,length=end-start||0,result=Array(length<0?0:length);while(++index<length){result[index]=array[start+index]}return result}var arrayRef=[];var objectProto=Object.prototype;var oldDash=root._;var toString=objectProto.toString;var reNative=RegExp("^"+String(toString).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");var ceil=Math.ceil,floor=Math.floor,hasOwnProperty=objectProto.hasOwnProperty,push=arrayRef.push,propertyIsEnumerable=objectProto.propertyIsEnumerable;var nativeCreate=isNative(nativeCreate=Object.create)&&nativeCreate,nativeIsArray=isNative(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=root.isFinite,nativeIsNaN=root.isNaN,nativeKeys=isNative(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeRandom=Math.random;function lodash(value){return value instanceof lodash?value:new lodashWrapper(value)}function lodashWrapper(value,chainAll){this.__chain__=!!chainAll;this.__wrapped__=value}lodashWrapper.prototype=lodash.prototype;var support={};(function(){var object={0:1,length:1};support.spliceObjects=(arrayRef.splice.call(object,0,1),!object[0])})(1);lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:""};function baseBind(bindData){var func=bindData[0],partialArgs=bindData[2],thisArg=bindData[4];function bound(){if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if(this instanceof bound){var thisBinding=baseCreate(func.prototype),result=func.apply(thisBinding,args||arguments);return isObject(result)?result:thisBinding}return func.apply(thisArg,args||arguments)}return bound}function baseCreate(prototype,properties){return isObject(prototype)?nativeCreate(prototype):{}}if(!nativeCreate){baseCreate=function(){function Object(){}return function(prototype){if(isObject(prototype)){Object.prototype=prototype;var result=new Object;Object.prototype=null}return result||root.Object()}}()}function baseCreateCallback(func,thisArg,argCount){if(typeof func!="function"){return identity}if(typeof thisArg=="undefined"||!("prototype"in func)){return func}switch(argCount){case 1:return function(value){return func.call(thisArg,value)};case 2:return function(a,b){return func.call(thisArg,a,b)};case 3:return function(value,index,collection){return func.call(thisArg,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)}}return bind(func,thisArg)}function baseCreateWrapper(bindData){var func=bindData[0],bitmask=bindData[1],partialArgs=bindData[2],partialRightArgs=bindData[3],thisArg=bindData[4],arity=bindData[5];var isBind=bitmask&1,isBindKey=bitmask&2,isCurry=bitmask&4,isCurryBound=bitmask&8,key=func;function bound(){var thisBinding=isBind?thisArg:this;if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if(partialRightArgs||isCurry){args||(args=slice(arguments));if(partialRightArgs){push.apply(args,partialRightArgs)}if(isCurry&&args.length<arity){bitmask|=16&~32;return baseCreateWrapper([func,isCurryBound?bitmask:bitmask&~3,args,null,thisArg,arity])}}args||(args=arguments);if(isBindKey){func=thisBinding[key]}if(this instanceof bound){thisBinding=baseCreate(func.prototype);var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}return bound}function baseDifference(array,values){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(indexOf(values,value)<0){result.push(value)}}return result}function baseFlatten(array,isShallow,isStrict,fromIndex){var index=(fromIndex||0)-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value&&typeof value=="object"&&typeof value.length=="number"&&(isArray(value)||isArguments(value))){if(!isShallow){value=baseFlatten(value,isShallow,isStrict)}var valIndex=-1,valLength=value.length,resIndex=result.length;result.length+=valLength;while(++valIndex<valLength){result[resIndex++]=value[valIndex]}}else if(!isStrict){result.push(value)}}return result}function baseIsEqual(a,b,stackA,stackB){if(a===b){return a!==0||1/a==1/b}var type=typeof a,otherType=typeof b;if(a===a&&!(a&&objectTypes[type])&&!(b&&objectTypes[otherType])){return false}if(a==null||b==null){return a===b}var className=toString.call(a),otherClass=toString.call(b);
if(className!=otherClass){return false}switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==String(b)}var isArr=className==arrayClass;if(!isArr){var aWrapped=a instanceof lodash,bWrapped=b instanceof lodash;if(aWrapped||bWrapped){return baseIsEqual(aWrapped?a.__wrapped__:a,bWrapped?b.__wrapped__:b,stackA,stackB)}if(className!=objectClass){return false}var ctorA=a.constructor,ctorB=b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB)&&("constructor"in a&&"constructor"in b)){return false}}stackA||(stackA=[]);stackB||(stackB=[]);var length=stackA.length;while(length--){if(stackA[length]==a){return stackB[length]==b}}var result=true,size=0;stackA.push(a);stackB.push(b);if(isArr){size=b.length;result=size==a.length;if(result){while(size--){if(!(result=baseIsEqual(a[size],b[size],stackA,stackB))){break}}}}else{forIn(b,function(value,key,b){if(hasOwnProperty.call(b,key)){size++;return!(result=hasOwnProperty.call(a,key)&&baseIsEqual(a[key],value,stackA,stackB))&&indicatorObject}});if(result){forIn(a,function(value,key,a){if(hasOwnProperty.call(a,key)){return!(result=--size>-1)&&indicatorObject}})}}stackA.pop();stackB.pop();return result}function baseRandom(min,max){return min+floor(nativeRandom()*(max-min+1))}function baseUniq(array,isSorted,callback){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[],seen=callback?[]:result;while(++index<length){var value=array[index],computed=callback?callback(value,index,array):value;if(isSorted?!index||seen[seen.length-1]!==computed:indexOf(seen,computed)<0){if(callback){seen.push(computed)}result.push(value)}}return result}function createAggregator(setter){return function(collection,callback,thisArg){var result={};callback=createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if(typeof length=="number"){while(++index<length){var value=collection[index];setter(result,value,callback(value,index,collection),collection)}}else{forOwn(collection,function(value,key,collection){setter(result,value,callback(value,key,collection),collection)})}return result}}function createWrapper(func,bitmask,partialArgs,partialRightArgs,thisArg,arity){var isBind=bitmask&1,isBindKey=bitmask&2,isCurry=bitmask&4,isCurryBound=bitmask&8,isPartial=bitmask&16,isPartialRight=bitmask&32;if(!isBindKey&&!isFunction(func)){throw new TypeError}if(isPartial&&!partialArgs.length){bitmask&=~16;isPartial=partialArgs=false}if(isPartialRight&&!partialRightArgs.length){bitmask&=~32;isPartialRight=partialRightArgs=false}var creater=bitmask==1||bitmask===17?baseBind:baseCreateWrapper;return creater([func,bitmask,partialArgs,partialRightArgs,thisArg,arity])}function escapeHtmlChar(match){return htmlEscapes[match]}function getIndexOf(){var result=(result=lodash.indexOf)===indexOf?baseIndexOf:result;return result}function isNative(value){return typeof value=="function"&&reNative.test(value)}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return value&&typeof value=="object"&&typeof value.length=="number"&&toString.call(value)==argsClass||false}if(!isArguments(arguments)){isArguments=function(value){return value&&typeof value=="object"&&typeof value.length=="number"&&hasOwnProperty.call(value,"callee")&&!propertyIsEnumerable.call(value,"callee")||false}}var isArray=nativeIsArray||function(value){return value&&typeof value=="object"&&typeof value.length=="number"&&toString.call(value)==arrayClass||false};var shimKeys=function(object){var index,iterable=object,result=[];if(!iterable)return result;if(!objectTypes[typeof object])return result;for(index in iterable){if(hasOwnProperty.call(iterable,index)){result.push(index)}}return result};var keys=!nativeKeys?shimKeys:function(object){if(!isObject(object)){return[]}return nativeKeys(object)};var htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"};var htmlUnescapes=invert(htmlEscapes);var reEscapedHtml=RegExp("("+keys(htmlUnescapes).join("|")+")","g"),reUnescapedHtml=RegExp("["+keys(htmlEscapes).join("")+"]","g");function assign(object){if(!object){return object}for(var argsIndex=1,argsLength=arguments.length;argsIndex<argsLength;argsIndex++){var iterable=arguments[argsIndex];if(iterable){for(var key in iterable){object[key]=iterable[key]}}}return object}function clone(value){return isObject(value)?isArray(value)?slice(value):assign({},value):value}function defaults(object){if(!object){return object}for(var argsIndex=1,argsLength=arguments.length;argsIndex<argsLength;argsIndex++){var iterable=arguments[argsIndex];if(iterable){for(var key in iterable){if(typeof object[key]=="undefined"){object[key]=iterable[key]}}}}return object}var forIn=function(collection,callback){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;for(index in iterable){if(callback(iterable[index],index,collection)===indicatorObject)return result}return result};var forOwn=function(collection,callback){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;for(index in iterable){if(hasOwnProperty.call(iterable,index)){if(callback(iterable[index],index,collection)===indicatorObject)return result}}return result};function functions(object){var result=[];forIn(object,function(value,key){if(isFunction(value)){result.push(key)}});return result.sort()}function has(object,key){return object?hasOwnProperty.call(object,key):false}function invert(object){var index=-1,props=keys(object),length=props.length,result={};while(++index<length){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===true||value===false||value&&typeof value=="object"&&toString.call(value)==boolClass||false}function isDate(value){return value&&typeof value=="object"&&toString.call(value)==dateClass||false}function isElement(value){return value&&value.nodeType===1||false}function isEmpty(value){if(!value){return true}if(isArray(value)||isString(value)){return!value.length}for(var key in value){if(hasOwnProperty.call(value,key)){return false}}return true}function isEqual(a,b){return baseIsEqual(a,b)}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return typeof value=="function"}if(isFunction(/x/)){isFunction=function(value){return typeof value=="function"&&toString.call(value)==funcClass}}function isObject(value){return!!(value&&objectTypes[typeof value])}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return value===null}function isNumber(value){return typeof value=="number"||value&&typeof value=="object"&&toString.call(value)==numberClass||false}function isRegExp(value){return value&&objectTypes[typeof value]&&toString.call(value)==regexpClass||false}function isString(value){return typeof value=="string"||value&&typeof value=="object"&&toString.call(value)==stringClass||false}function isUndefined(value){return typeof value=="undefined"}function omit(object){var props=[];forIn(object,function(value,key){props.push(key)});props=baseDifference(props,baseFlatten(arguments,true,false,1));var index=-1,length=props.length,result={};while(++index<length){var key=props[index];result[key]=object[key]}return result}function pairs(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object){var index=-1,props=baseFlatten(arguments,true,false,1),length=props.length,result={};while(++index<length){var key=props[index];if(key in object){result[key]=object[key]}}return result}function values(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){result[index]=object[props[index]]}return result}function contains(collection,target){var indexOf=getIndexOf(),length=collection?collection.length:0,result=false;if(length&&typeof length=="number"){result=indexOf(collection,target)>-1}else{forOwn(collection,function(value){return(result=value===target)&&indicatorObject})}return result}var countBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?result[key]++:result[key]=1});function every(collection,callback,thisArg){var result=true;callback=createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if(typeof length=="number"){while(++index<length){if(!(result=!!callback(collection[index],index,collection))){break}}}else{forOwn(collection,function(value,index,collection){return!(result=!!callback(value,index,collection))&&indicatorObject})}return result}function filter(collection,callback,thisArg){var result=[];callback=createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if(typeof length=="number"){while(++index<length){var value=collection[index];if(callback(value,index,collection)){result.push(value)}}}else{forOwn(collection,function(value,index,collection){if(callback(value,index,collection)){result.push(value)}})}return result}function find(collection,callback,thisArg){callback=createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if(typeof length=="number"){while(++index<length){var value=collection[index];if(callback(value,index,collection)){return value}}}else{var result;forOwn(collection,function(value,index,collection){if(callback(value,index,collection)){result=value;return indicatorObject}});return result}}function findWhere(object,properties){return where(object,properties,true)}function forEach(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;callback=callback&&typeof thisArg=="undefined"?callback:baseCreateCallback(callback,thisArg,3);if(typeof length=="number"){while(++index<length){if(callback(collection[index],index,collection)===indicatorObject){break}}}else{forOwn(collection,callback)}}function forEachRight(collection,callback){var length=collection?collection.length:0;if(typeof length=="number"){while(length--){if(callback(collection[length],length,collection)===false){break}}}else{var props=keys(collection);length=props.length;forOwn(collection,function(value,key,collection){key=props?props[--length]:--length;return callback(collection[key],key,collection)===false&&indicatorObject})}}var groupBy=createAggregator(function(result,value,key){(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)});var indexBy=createAggregator(function(result,value,key){result[key]=value});function invoke(collection,methodName){var args=slice(arguments,2),index=-1,isFunc=typeof methodName=="function",length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)});return result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;callback=createCallback(callback,thisArg,3);if(typeof length=="number"){var result=Array(length);while(++index<length){result[index]=callback(collection[index],index,collection)}}else{result=[];forOwn(collection,function(value,key,collection){result[++index]=callback(value,key,collection)})}return result}function max(collection,callback,thisArg){var computed=-Infinity,result=computed;if(typeof callback!="function"&&thisArg&&thisArg[callback]===collection){callback=null}var index=-1,length=collection?collection.length:0;if(callback==null&&typeof length=="number"){while(++index<length){var value=collection[index];if(value>result){result=value}}}else{callback=createCallback(callback,thisArg,3);forEach(collection,function(value,index,collection){var current=callback(value,index,collection);if(current>computed){computed=current;result=value}})}return result}function min(collection,callback,thisArg){var computed=Infinity,result=computed;if(typeof callback!="function"&&thisArg&&thisArg[callback]===collection){callback=null}var index=-1,length=collection?collection.length:0;if(callback==null&&typeof length=="number"){while(++index<length){var value=collection[index];if(value<result){result=value}}}else{callback=createCallback(callback,thisArg,3);forEach(collection,function(value,index,collection){var current=callback(value,index,collection);if(current<computed){computed=current;result=value}})}return result}var pluck=map;function reduce(collection,callback,accumulator,thisArg){if(!collection)return accumulator;var noaccum=arguments.length<3;callback=createCallback(callback,thisArg,4);var index=-1,length=collection.length;if(typeof length=="number"){if(noaccum){accumulator=collection[++index]}while(++index<length){accumulator=callback(accumulator,collection[index],index,collection)}}else{forOwn(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)})}return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;callback=createCallback(callback,thisArg,4);forEachRight(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)});return accumulator}function reject(collection,callback,thisArg){callback=createCallback(callback,thisArg,3);return filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function sample(collection,n,guard){if(collection&&typeof collection.length!="number"){collection=values(collection)}if(n==null||guard){return collection?collection[baseRandom(0,collection.length-1)]:undefined}var result=shuffle(collection);result.length=nativeMin(nativeMax(0,n),result.length);return result}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){var rand=baseRandom(0,++index);result[index]=result[rand];result[rand]=value});return result}function size(collection){var length=collection?collection.length:0;return typeof length=="number"?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=createCallback(callback,thisArg,3);var index=-1,length=collection?collection.length:0;if(typeof length=="number"){while(++index<length){if(result=callback(collection[index],index,collection)){break}}}else{forOwn(collection,function(value,index,collection){return(result=callback(value,index,collection))&&indicatorObject})}return!!result}function sortBy(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=createCallback(callback,thisArg,3);forEach(collection,function(value,key,collection){result[++index]={criteria:[callback(value,key,collection)],index:index,value:value}});length=result.length;result.sort(compareAscending);while(length--){result[length]=result[length].value}return result}function toArray(collection){if(isArray(collection)){return slice(collection)}if(collection&&typeof collection.length=="number"){return map(collection)}return values(collection)}function where(collection,properties,first){return first&&isEmpty(properties)?undefined:(first?find:filter)(collection,properties)}function compact(array){var index=-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value){result.push(value)}}return result}function difference(array){return baseDifference(array,baseFlatten(arguments,true,true,1))}function first(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=-1;callback=createCallback(callback,thisArg,3);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array?array[0]:undefined}}return slice(array,0,nativeMin(nativeMax(0,n),length))}function flatten(array,isShallow){return baseFlatten(array,isShallow)}function indexOf(array,value,fromIndex){if(typeof fromIndex=="number"){var length=array?array.length:0;fromIndex=fromIndex<0?nativeMax(0,length+fromIndex):fromIndex||0}else if(fromIndex){var index=sortedIndex(array,value);return array[index]===value?index:-1}return baseIndexOf(array,value,fromIndex)}function initial(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=length;callback=createCallback(callback,thisArg,3);while(index--&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:callback||n}return slice(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(){var args=[],argsIndex=-1,argsLength=arguments.length;while(++argsIndex<argsLength){var value=arguments[argsIndex];if(isArray(value)||isArguments(value)){args.push(value)}}var array=args[0],index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[];outer:while(++index<length){value=array[index];if(indexOf(result,value)<0){var argsIndex=argsLength;while(--argsIndex){if(indexOf(args[argsIndex],value)<0){continue outer}}result.push(value)}}return result}function last(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=length;callback=createCallback(callback,thisArg,3);while(index--&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array?array[length-1]:undefined}}return slice(array,nativeMax(0,length-n))}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1}while(index--){if(array[index]===value){return index}}return-1}function range(start,end,step){start=+start||0;step=+step||1;if(end==null){end=start;start=0}var index=-1,length=nativeMax(0,ceil((end-start)/step)),result=Array(length);while(++index<length){result[index]=start;start+=step}return result}function rest(array,callback,thisArg){if(typeof callback!="number"&&callback!=null){var n=0,index=-1,length=array?array.length:0;callback=createCallback(callback,thisArg,3);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:nativeMax(0,callback)}return slice(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;callback=callback?createCallback(callback,thisArg,1):identity;value=callback(value);while(low<high){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(){return baseUniq(baseFlatten(arguments,true,true))}function uniq(array,isSorted,callback,thisArg){if(typeof isSorted!="boolean"&&isSorted!=null){thisArg=callback;callback=typeof isSorted!="function"&&thisArg&&thisArg[isSorted]===array?null:isSorted;isSorted=false}if(callback!=null){callback=createCallback(callback,thisArg,3)}return baseUniq(array,isSorted,callback)}function without(array){return baseDifference(array,slice(arguments,1))}function zip(){var index=-1,length=max(pluck(arguments,"length")),result=Array(length<0?0:length);while(++index<length){result[index]=pluck(arguments,index)}return result}function zipObject(keys,values){var index=-1,length=keys?keys.length:0,result={};if(!values&&length&&!isArray(keys[0])){values=[]}while(++index<length){var key=keys[index];if(values){result[key]=values[index]}else if(key){result[key[0]]=key[1]}}return result}function after(n,func){if(!isFunction(func)){throw new TypeError}return function(){if(--n<1){return func.apply(this,arguments)}}}function bind(func,thisArg){return arguments.length>2?createWrapper(func,17,slice(arguments,2),null,thisArg):createWrapper(func,1,null,null,thisArg)}function bindAll(object){var funcs=arguments.length>1?baseFlatten(arguments,true,false,1):functions(object),index=-1,length=funcs.length;while(++index<length){var key=funcs[index];object[key]=createWrapper(object[key],1,null,null,object)}return object}function compose(){var funcs=arguments,length=funcs.length;while(length--){if(!isFunction(funcs[length])){throw new TypeError}}return function(){var args=arguments,length=funcs.length;while(length--){args=[funcs[length].apply(this,args)]}return args[0]}}function debounce(func,wait,options){var args,maxTimeoutId,result,stamp,thisArg,timeoutId,trailingCall,lastCalled=0,maxWait=false,trailing=true;if(!isFunction(func)){throw new TypeError}wait=nativeMax(0,wait)||0;if(options===true){var leading=true;trailing=false}else if(isObject(options)){leading=options.leading;maxWait="maxWait"in options&&(nativeMax(wait,options.maxWait)||0);trailing="trailing"in options?options.trailing:trailing}var delayed=function(){var remaining=wait-(now()-stamp);if(remaining<=0){if(maxTimeoutId){clearTimeout(maxTimeoutId)}var isCalled=trailingCall;maxTimeoutId=timeoutId=trailingCall=undefined;if(isCalled){lastCalled=now();result=func.apply(thisArg,args);if(!timeoutId&&!maxTimeoutId){args=thisArg=null}}}else{timeoutId=setTimeout(delayed,remaining)}};var maxDelayed=function(){if(timeoutId){clearTimeout(timeoutId)}maxTimeoutId=timeoutId=trailingCall=undefined;if(trailing||maxWait!==wait){lastCalled=now();result=func.apply(thisArg,args);if(!timeoutId&&!maxTimeoutId){args=thisArg=null}}};return function(){args=arguments;stamp=now();thisArg=this;trailingCall=trailing&&(timeoutId||!leading);if(maxWait===false){var leadingCall=leading&&!timeoutId}else{if(!maxTimeoutId&&!leading){lastCalled=stamp}var remaining=maxWait-(stamp-lastCalled),isCalled=remaining<=0;if(isCalled){if(maxTimeoutId){maxTimeoutId=clearTimeout(maxTimeoutId)}lastCalled=stamp;result=func.apply(thisArg,args)}else if(!maxTimeoutId){maxTimeoutId=setTimeout(maxDelayed,remaining)}}if(isCalled&&timeoutId){timeoutId=clearTimeout(timeoutId)}else if(!timeoutId&&wait!==maxWait){timeoutId=setTimeout(delayed,wait)}if(leadingCall){isCalled=true;result=func.apply(thisArg,args)}if(isCalled&&!timeoutId&&!maxTimeoutId){args=thisArg=null}return result}}function defer(func){if(!isFunction(func)){throw new TypeError}var args=slice(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}function delay(func,wait){if(!isFunction(func)){throw new TypeError}var args=slice(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function memoize(func,resolver){var cache={};return function(){var key=resolver?resolver.apply(this,arguments):keyPrefix+arguments[0];return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)}}function once(func){var ran,result;if(!isFunction(func)){throw new TypeError}return function(){if(ran){return result}ran=true;result=func.apply(this,arguments);func=null;return result}}function partial(func){return createWrapper(func,16,slice(arguments,1))}function throttle(func,wait,options){var leading=true,trailing=true;if(!isFunction(func)){throw new TypeError}if(options===false){leading=false}else if(isObject(options)){leading="leading"in options?options.leading:leading;trailing="trailing"in options?options.trailing:trailing}options={};options.leading=leading;options.maxWait=wait;options.trailing=trailing;return debounce(func,wait,options)}function wrap(value,wrapper){return createWrapper(wrapper,16,[value])}function createCallback(func,thisArg,argCount){var type=typeof func;if(func==null||type=="function"){return baseCreateCallback(func,thisArg,argCount)}if(type!="object"){return property(func)}var props=keys(func);return function(object){var length=props.length,result=false;while(length--){if(!(result=object[props[length]]===func[props[length]])){break}}return result}}function escape(string){return string==null?"":String(string).replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object){forEach(functions(object),function(methodName){var func=lodash[methodName]=object[methodName];lodash.prototype[methodName]=function(){var args=[this.__wrapped__];push.apply(args,arguments);var result=func.apply(lodash,args);return this.__chain__?new lodashWrapper(result,true):result}})}function noConflict(){root._=oldDash;return this}function noop(){}var now=isNative(now=Date.now)&&now||function(){return(new Date).getTime()};function property(key){return function(object){return object[key]}}function random(min,max){if(min==null&&max==null){max=1}min=+min||0;if(max==null){max=min;min=0}else{max=+max||0}return min+floor(nativeRandom()*(max-min+1))}function result(object,key){if(object){var value=object[key];return isFunction(value)?object[key]():value}}function template(text,data,options){var _=lodash,settings=_.templateSettings;text=String(text||"");options=defaults({},options,settings);var index=0,source="__p += '",variable=options.variable;var reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+(options.interpolate||reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,evaluateValue,offset){source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar);if(escapeValue){source+="' +\n_.escape("+escapeValue+") +\n'"}if(evaluateValue){source+="';\n"+evaluateValue+";\n__p += '"}if(interpolateValue){source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"}index=offset+match.length;return match});source+="';\n";if(!variable){variable="obj";source="with ("+variable+" || {}) {\n"+source+"\n}\n"}source="function("+variable+") {\n"+"var __t, __p = '', __j = Array.prototype.join;\n"+"function print() { __p += __j.call(arguments, '') }\n"+source+"return __p\n}";try{var result=Function("_","return "+source)(_)}catch(e){e.source=source;throw e}if(data){return result(data)}result.source=source;return result}function times(n,callback,thisArg){n=(n=+n)>-1?n:0;var index=-1,result=Array(n);callback=baseCreateCallback(callback,thisArg,1);while(++index<n){result[index]=callback(index)}return result}function unescape(string){return string==null?"":String(string).replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter+"";return prefix?prefix+id:id}function chain(value){value=new lodashWrapper(value);value.__chain__=true;return value}function tap(value,interceptor){interceptor(value);return value}function wrapperChain(){this.__chain__=true;return this}function wrapperValueOf(){return this.__wrapped__}lodash.after=after;lodash.bind=bind;lodash.bindAll=bindAll;lodash.chain=chain;lodash.compact=compact;lodash.compose=compose;lodash.countBy=countBy;lodash.debounce=debounce;lodash.defaults=defaults;lodash.defer=defer;lodash.delay=delay;lodash.difference=difference;lodash.filter=filter;lodash.flatten=flatten;lodash.forEach=forEach;lodash.functions=functions;lodash.groupBy=groupBy;lodash.indexBy=indexBy;lodash.initial=initial;lodash.intersection=intersection;lodash.invert=invert;lodash.invoke=invoke;lodash.keys=keys;lodash.map=map;lodash.max=max;lodash.memoize=memoize;lodash.min=min;lodash.omit=omit;lodash.once=once;lodash.pairs=pairs;lodash.partial=partial;lodash.pick=pick;lodash.pluck=pluck;lodash.range=range;lodash.reject=reject;lodash.rest=rest;lodash.shuffle=shuffle;lodash.sortBy=sortBy;lodash.tap=tap;lodash.throttle=throttle;lodash.times=times;lodash.toArray=toArray;lodash.union=union;lodash.uniq=uniq;lodash.values=values;lodash.where=where;lodash.without=without;lodash.wrap=wrap;lodash.zip=zip;lodash.collect=map;lodash.drop=rest;lodash.each=forEach;lodash.extend=assign;lodash.methods=functions;lodash.object=zipObject;lodash.select=filter;lodash.tail=rest;lodash.unique=uniq;lodash.clone=clone;lodash.contains=contains;lodash.escape=escape;lodash.every=every;lodash.find=find;lodash.has=has;lodash.identity=identity;lodash.indexOf=indexOf;lodash.isArguments=isArguments;lodash.isArray=isArray;lodash.isBoolean=isBoolean;lodash.isDate=isDate;lodash.isElement=isElement;lodash.isEmpty=isEmpty;lodash.isEqual=isEqual;lodash.isFinite=isFinite;lodash.isFunction=isFunction;lodash.isNaN=isNaN;lodash.isNull=isNull;lodash.isNumber=isNumber;lodash.isObject=isObject;lodash.isRegExp=isRegExp;lodash.isString=isString;lodash.isUndefined=isUndefined;lodash.lastIndexOf=lastIndexOf;lodash.mixin=mixin;lodash.noConflict=noConflict;lodash.random=random;lodash.reduce=reduce;lodash.reduceRight=reduceRight;lodash.result=result;lodash.size=size;lodash.some=some;lodash.sortedIndex=sortedIndex;lodash.template=template;lodash.unescape=unescape;lodash.uniqueId=uniqueId;lodash.all=every;lodash.any=some;lodash.detect=find;lodash.findWhere=findWhere;lodash.foldl=reduce;lodash.foldr=reduceRight;lodash.include=contains;lodash.inject=reduce;lodash.first=first;lodash.last=last;lodash.sample=sample;lodash.take=first;lodash.head=first;mixin(lodash);lodash.VERSION="2.4.1";lodash.prototype.chain=wrapperChain;lodash.prototype.value=wrapperValueOf;forEach(["pop","push","reverse","shift","sort","splice","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var value=this.__wrapped__;func.apply(value,arguments);if(!support.spliceObjects&&value.length===0){delete value[0]}return this}});forEach(["concat","join","slice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var value=this.__wrapped__,result=func.apply(value,arguments);if(this.__chain__){result=new lodashWrapper(result);result.__chain__=true}return result}});if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){root._=lodash;define(function(){return lodash})}else if(freeExports&&freeModule){if(moduleExports){(freeModule.exports=lodash)._=lodash}else{freeExports._=lodash}}else{root._=lodash}}).call(this);(function(){var Bacon,BufferingSource,Bus,CompositeUnsubscribe,ConsumingSource,DepCache,Desc,Dispatcher,End,Error,Event,EventStream,Initial,Next,None,Observable,Property,PropertyDispatcher,Some,Source,UpdateBarrier,addPropertyInitValueToStream,assert,assertArray,assertEventStream,assertFunction,assertNoArguments,assertString,cloneArray,compositeUnsubscribe,containsDuplicateDeps,convertArgsToFunction,describe,end,eventIdCounter,findDeps,flatMap_,former,idCounter,initial,isArray,isFieldKey,isFunction,isObservable,latterF,liftCallback,makeFunction,makeFunctionArgs,makeFunction_,makeObservable,makeSpawner,next,nop,partiallyApplied,recursionDepth,registerObs,spys,toCombinator,toEvent,toFieldExtractor,toFieldKey,toOption,toSimpleExtractor,withDescription,withMethodCallSupport,_,_ref,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Bacon={toString:function(){return"Bacon"}};Bacon.version="0.7.21";Bacon.fromBinder=function(binder,eventTransformer){if(eventTransformer==null){eventTransformer=_.id}return new EventStream(describe(Bacon,"fromBinder",binder,eventTransformer),function(sink){var unbind,unbinder,unbound;unbound=false;unbind=function(){if(typeof unbinder!=="undefined"&&unbinder!==null){if(!unbound){unbinder()}return unbound=true}};unbinder=binder(function(){var args,event,reply,value,_i,_len;args=1<=arguments.length?__slice.call(arguments,0):[];value=eventTransformer.apply(null,args);if(!(isArray(value)&&_.last(value)instanceof Event)){value=[value]}reply=Bacon.more;for(_i=0,_len=value.length;_i<_len;_i++){event=value[_i];reply=sink(event=toEvent(event));if(reply===Bacon.noMore||event.isEnd()){if(unbinder!=null){unbind()}else{Bacon.scheduler.setTimeout(unbind,0)}return reply}}return reply});return unbind})};Bacon.$={asEventStream:function(eventName,selector,eventTransformer){var _ref;if(isFunction(selector)){_ref=[selector,null],eventTransformer=_ref[0],selector=_ref[1]}return withDescription(this.selector||this,"asEventStream",eventName,Bacon.fromBinder(function(_this){return function(handler){_this.on(eventName,selector,handler);
return function(){return _this.off(eventName,selector,handler)}}}(this),eventTransformer))}};if((_ref=typeof jQuery!=="undefined"&&jQuery!==null?jQuery:typeof Zepto!=="undefined"&&Zepto!==null?Zepto:null)!=null){_ref.fn.asEventStream=Bacon.$.asEventStream}Bacon.fromEventTarget=function(target,eventName,eventTransformer){var sub,unsub,_ref1,_ref2,_ref3,_ref4;sub=(_ref1=target.addEventListener)!=null?_ref1:(_ref2=target.addListener)!=null?_ref2:target.bind;unsub=(_ref3=target.removeEventListener)!=null?_ref3:(_ref4=target.removeListener)!=null?_ref4:target.unbind;return withDescription(Bacon,"fromEventTarget",target,eventName,Bacon.fromBinder(function(handler){sub.call(target,eventName,handler);return function(){return unsub.call(target,eventName,handler)}},eventTransformer))};Bacon.fromPromise=function(promise,abort){return withDescription(Bacon,"fromPromise",promise,Bacon.fromBinder(function(handler){promise.then(handler,function(e){return handler(new Error(e))});return function(){if(abort){return typeof promise.abort==="function"?promise.abort():void 0}}},function(value){return[value,end()]}))};Bacon.noMore=["<no-more>"];Bacon.more=["<more>"];Bacon.later=function(delay,value){return withDescription(Bacon,"later",delay,value,Bacon.sequentially(delay,[value]))};Bacon.sequentially=function(delay,values){var index;index=0;return withDescription(Bacon,"sequentially",delay,values,Bacon.fromPoll(delay,function(){var value;value=values[index++];if(index<values.length){return value}else if(index===values.length){return[value,end()]}else{return end()}}))};Bacon.repeatedly=function(delay,values){var index;index=0;return withDescription(Bacon,"repeatedly",delay,values,Bacon.fromPoll(delay,function(){return values[index++%values.length]}))};Bacon.spy=function(spy){return spys.push(spy)};spys=[];registerObs=function(obs){var spy,_i,_len,_results;if(spys.length){if(!registerObs.running){try{registerObs.running=true;_results=[];for(_i=0,_len=spys.length;_i<_len;_i++){spy=spys[_i];_results.push(spy(obs))}return _results}finally{delete registerObs.running}}}};withMethodCallSupport=function(wrapped){return function(){var args,context,f,methodName;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(typeof f==="object"&&args.length){context=f;methodName=args[0];f=function(){return context[methodName].apply(context,arguments)};args=args.slice(1)}return wrapped.apply(null,[f].concat(__slice.call(args)))}};liftCallback=function(desc,wrapped){return withMethodCallSupport(function(){var args,f,stream;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];stream=partiallyApplied(wrapped,[function(values,callback){return f.apply(null,__slice.call(values).concat([callback]))}]);return withDescription.apply(null,[Bacon,desc,f].concat(__slice.call(args),[Bacon.combineAsArray(args).flatMap(stream)]))})};Bacon.fromCallback=liftCallback("fromCallback",function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return Bacon.fromBinder(function(handler){makeFunction(f,args)(handler);return nop},function(value){return[value,end()]})});Bacon.fromNodeCallback=liftCallback("fromNodeCallback",function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return Bacon.fromBinder(function(handler){makeFunction(f,args)(handler);return nop},function(error,value){if(error){return[new Error(error),end()]}return[value,end()]})});Bacon.fromPoll=function(delay,poll){return withDescription(Bacon,"fromPoll",delay,poll,Bacon.fromBinder(function(handler){var id;id=Bacon.scheduler.setInterval(handler,delay);return function(){return Bacon.scheduler.clearInterval(id)}},poll))};Bacon.interval=function(delay,value){if(value==null){value={}}return withDescription(Bacon,"interval",delay,value,Bacon.fromPoll(delay,function(){return next(value)}))};Bacon.constant=function(value){return new Property(describe(Bacon,"constant",value),function(sink){sink(initial(value));sink(end());return nop})};Bacon.never=function(){return withDescription(Bacon,"never",Bacon.fromArray([]))};Bacon.once=function(value){return withDescription(Bacon,"once",value,Bacon.fromArray([value]))};Bacon.fromArray=function(values){assertArray(values);values=cloneArray(values);return new EventStream(describe(Bacon,"fromArray",values),function(sink){var reply,unsubd,value;unsubd=false;reply=Bacon.more;while(reply!==Bacon.noMore&&!unsubd){if(_.empty(values)){sink(end());reply=Bacon.noMore}else{value=values.shift();reply=sink(toEvent(value))}}return function(){return unsubd=true}})};Bacon.mergeAll=function(){var streams;streams=1<=arguments.length?__slice.call(arguments,0):[];if(isArray(streams[0])){streams=streams[0]}if(streams.length){return new EventStream(describe.apply(null,[Bacon,"mergeAll"].concat(__slice.call(streams))),function(sink){var ends,sinks,smartSink;ends=0;smartSink=function(obs){return function(unsubBoth){return obs.subscribeInternal(function(event){var reply;if(event.isEnd()){ends++;if(ends===streams.length){return sink(end())}else{return Bacon.more}}else{reply=sink(event);if(reply===Bacon.noMore){unsubBoth()}return reply}})}};sinks=_.map(smartSink,streams);return compositeUnsubscribe.apply(null,sinks)})}else{return Bacon.never()}};Bacon.zipAsArray=function(){var streams;streams=1<=arguments.length?__slice.call(arguments,0):[];if(isArray(streams[0])){streams=streams[0]}return withDescription.apply(null,[Bacon,"zipAsArray"].concat(__slice.call(streams),[Bacon.zipWith(streams,function(){var xs;xs=1<=arguments.length?__slice.call(arguments,0):[];return xs})]))};Bacon.zipWith=function(){var f,streams,_ref1;f=arguments[0],streams=2<=arguments.length?__slice.call(arguments,1):[];if(!isFunction(f)){_ref1=[f,streams[0]],streams=_ref1[0],f=_ref1[1]}streams=_.map(function(s){return s.toEventStream()},streams);return withDescription.apply(null,[Bacon,"zipWith",f].concat(__slice.call(streams),[Bacon.when(streams,f)]))};Bacon.groupSimultaneous=function(){var s,sources,streams;streams=1<=arguments.length?__slice.call(arguments,0):[];if(streams.length===1&&isArray(streams[0])){streams=streams[0]}sources=function(){var _i,_len,_results;_results=[];for(_i=0,_len=streams.length;_i<_len;_i++){s=streams[_i];_results.push(new BufferingSource(s))}return _results}();return withDescription.apply(null,[Bacon,"groupSimultaneous"].concat(__slice.call(streams),[Bacon.when(sources,function(){var xs;xs=1<=arguments.length?__slice.call(arguments,0):[];return xs})]))};Bacon.combineAsArray=function(){var index,s,sources,stream,streams,_i,_len;streams=1<=arguments.length?__slice.call(arguments,0):[];if(streams.length===1&&isArray(streams[0])){streams=streams[0]}for(index=_i=0,_len=streams.length;_i<_len;index=++_i){stream=streams[index];if(!isObservable(stream)){streams[index]=Bacon.constant(stream)}}if(streams.length){sources=function(){var _j,_len1,_results;_results=[];for(_j=0,_len1=streams.length;_j<_len1;_j++){s=streams[_j];_results.push(new Source(s,true,s.subscribeInternal))}return _results}();return withDescription.apply(null,[Bacon,"combineAsArray"].concat(__slice.call(streams),[Bacon.when(sources,function(){var xs;xs=1<=arguments.length?__slice.call(arguments,0):[];return xs}).toProperty()]))}else{return Bacon.constant([])}};Bacon.onValues=function(){var f,streams,_i;streams=2<=arguments.length?__slice.call(arguments,0,_i=arguments.length-1):(_i=0,[]),f=arguments[_i++];return Bacon.combineAsArray(streams).onValues(f)};Bacon.combineWith=function(){var f,streams;f=arguments[0],streams=2<=arguments.length?__slice.call(arguments,1):[];return withDescription.apply(null,[Bacon,"combineWith",f].concat(__slice.call(streams),[Bacon.combineAsArray(streams).map(function(values){return f.apply(null,values)})]))};Bacon.combineTemplate=function(template){var applyStreamValue,combinator,compile,compileTemplate,constantValue,current,funcs,mkContext,setValue,streams;funcs=[];streams=[];current=function(ctxStack){return ctxStack[ctxStack.length-1]};setValue=function(ctxStack,key,value){return current(ctxStack)[key]=value};applyStreamValue=function(key,index){return function(ctxStack,values){return setValue(ctxStack,key,values[index])}};constantValue=function(key,value){return function(ctxStack){return setValue(ctxStack,key,value)}};mkContext=function(template){if(isArray(template)){return[]}else{return{}}};compile=function(key,value){var popContext,pushContext;if(isObservable(value)){streams.push(value);return funcs.push(applyStreamValue(key,streams.length-1))}else if(value===Object(value)&&typeof value!=="function"&&!(value instanceof RegExp)&&!(value instanceof Date)){pushContext=function(key){return function(ctxStack){var newContext;newContext=mkContext(value);setValue(ctxStack,key,newContext);return ctxStack.push(newContext)}};popContext=function(ctxStack){return ctxStack.pop()};funcs.push(pushContext(key));compileTemplate(value);return funcs.push(popContext)}else{return funcs.push(constantValue(key,value))}};compileTemplate=function(template){return _.each(template,compile)};compileTemplate(template);combinator=function(values){var ctxStack,f,rootContext,_i,_len;rootContext=mkContext(template);ctxStack=[rootContext];for(_i=0,_len=funcs.length;_i<_len;_i++){f=funcs[_i];f(ctxStack,values)}return rootContext};return withDescription(Bacon,"combineTemplate",template,Bacon.combineAsArray(streams).map(combinator))};Bacon.retry=function(options){var delay,isRetryable,maxRetries,retries,retry,source;if(!isFunction(options.source)){throw"'source' option has to be a function"}source=options.source;retries=options.retries||0;maxRetries=options.maxRetries||retries;delay=options.delay||function(){return 0};isRetryable=options.isRetryable||function(){return true};retry=function(context){var delayedRetry,nextAttemptOptions;nextAttemptOptions={source:source,retries:retries-1,maxRetries:maxRetries,delay:delay,isRetryable:isRetryable};delayedRetry=function(){return Bacon.retry(nextAttemptOptions)};return Bacon.later(delay(context)).filter(false).concat(Bacon.once().flatMap(delayedRetry))};return withDescription(Bacon,"retry",options,source().flatMapError(function(e){if(isRetryable(e)&&retries>0){return retry({error:e,retriesDone:maxRetries-retries})}else{return Bacon.once(new Bacon.Error(e))}}))};eventIdCounter=0;Event=function(){function Event(){this.id=++eventIdCounter}Event.prototype.isEvent=function(){return true};Event.prototype.isEnd=function(){return false};Event.prototype.isInitial=function(){return false};Event.prototype.isNext=function(){return false};Event.prototype.isError=function(){return false};Event.prototype.hasValue=function(){return false};Event.prototype.filter=function(){return true};Event.prototype.inspect=function(){return this.toString()};Event.prototype.log=function(){return this.toString()};return Event}();Next=function(_super){__extends(Next,_super);function Next(valueF){Next.__super__.constructor.call(this);if(isFunction(valueF)){this.value=_.cached(valueF)}else{this.value=_.always(valueF)}}Next.prototype.isNext=function(){return true};Next.prototype.hasValue=function(){return true};Next.prototype.fmap=function(f){var value;value=this.value;return this.apply(function(){return f(value())})};Next.prototype.apply=function(value){return new Next(value)};Next.prototype.filter=function(f){return f(this.value())};Next.prototype.toString=function(){return _.toString(this.value())};Next.prototype.log=function(){return this.value()};return Next}(Event);Initial=function(_super){__extends(Initial,_super);function Initial(){return Initial.__super__.constructor.apply(this,arguments)}Initial.prototype.isInitial=function(){return true};Initial.prototype.isNext=function(){return false};Initial.prototype.apply=function(value){return new Initial(value)};Initial.prototype.toNext=function(){return new Next(this.value)};return Initial}(Next);End=function(_super){__extends(End,_super);function End(){return End.__super__.constructor.apply(this,arguments)}End.prototype.isEnd=function(){return true};End.prototype.fmap=function(){return this};End.prototype.apply=function(){return this};End.prototype.toString=function(){return"<end>"};return End}(Event);Error=function(_super){__extends(Error,_super);function Error(error){this.error=error}Error.prototype.isError=function(){return true};Error.prototype.fmap=function(){return this};Error.prototype.apply=function(){return this};Error.prototype.toString=function(){return"<error> "+_.toString(this.error)};return Error}(Event);idCounter=0;Observable=function(){function Observable(desc){this.flatMapError=__bind(this.flatMapError,this);this.id=++idCounter;withDescription(desc,this);this.initialDesc=this.desc}Observable.prototype.onValue=function(){var f;f=makeFunctionArgs(arguments);return this.subscribe(function(event){if(event.hasValue()){return f(event.value())}})};Observable.prototype.onValues=function(f){return this.onValue(function(args){return f.apply(null,args)})};Observable.prototype.onError=function(){var f;f=makeFunctionArgs(arguments);return this.subscribe(function(event){if(event.isError()){return f(event.error)}})};Observable.prototype.onEnd=function(){var f;f=makeFunctionArgs(arguments);return this.subscribe(function(event){if(event.isEnd()){return f()}})};Observable.prototype.errors=function(){return withDescription(this,"errors",this.filter(function(){return false}))};Observable.prototype.filter=function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return convertArgsToFunction(this,f,args,function(f){return withDescription(this,"filter",f,this.withHandler(function(event){if(event.filter(f)){return this.push(event)}else{return Bacon.more}}))})};Observable.prototype.takeWhile=function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return convertArgsToFunction(this,f,args,function(f){return withDescription(this,"takeWhile",f,this.withHandler(function(event){if(event.filter(f)){return this.push(event)}else{this.push(end());return Bacon.noMore}}))})};Observable.prototype.endOnError=function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(f==null){f=true}return convertArgsToFunction(this,f,args,function(f){return withDescription(this,"endOnError",this.withHandler(function(event){if(event.isError()&&f(event.error)){this.push(event);return this.push(end())}else{return this.push(event)}}))})};Observable.prototype.take=function(count){if(count<=0){return Bacon.never()}return withDescription(this,"take",count,this.withHandler(function(event){if(!event.hasValue()){return this.push(event)}else{count--;if(count>0){return this.push(event)}else{if(count===0){this.push(event)}this.push(end());return Bacon.noMore}}}))};Observable.prototype.map=function(){var args,p;p=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(p instanceof Property){return p.sampledBy(this,former)}else{return convertArgsToFunction(this,p,args,function(f){return withDescription(this,"map",f,this.withHandler(function(event){return this.push(event.fmap(f))}))})}};Observable.prototype.mapError=function(){var f;f=makeFunctionArgs(arguments);return withDescription(this,"mapError",f,this.withHandler(function(event){if(event.isError()){return this.push(next(f(event.error)))}else{return this.push(event)}}))};Observable.prototype.mapEnd=function(){var f;f=makeFunctionArgs(arguments);return withDescription(this,"mapEnd",f,this.withHandler(function(event){if(event.isEnd()){this.push(next(f(event)));this.push(end());return Bacon.noMore}else{return this.push(event)}}))};Observable.prototype.doAction=function(){var f;f=makeFunctionArgs(arguments);return withDescription(this,"doAction",f,this.withHandler(function(event){if(event.hasValue()){f(event.value())}return this.push(event)}))};Observable.prototype.skip=function(count){return withDescription(this,"skip",count,this.withHandler(function(event){if(!event.hasValue()){return this.push(event)}else if(count>0){count--;return Bacon.more}else{return this.push(event)}}))};Observable.prototype.skipDuplicates=function(isEqual){if(isEqual==null){isEqual=function(a,b){return a===b}}return withDescription(this,"skipDuplicates",this.withStateMachine(None,function(prev,event){if(!event.hasValue()){return[prev,[event]]}else if(event.isInitial()||prev===None||!isEqual(prev.get(),event.value())){return[new Some(event.value()),[event]]}else{return[prev,[]]}}))};Observable.prototype.skipErrors=function(){return withDescription(this,"skipErrors",this.withHandler(function(event){if(event.isError()){return Bacon.more}else{return this.push(event)}}))};Observable.prototype.withStateMachine=function(initState,f){var state;state=initState;return withDescription(this,"withStateMachine",initState,f,this.withHandler(function(event){var fromF,newState,output,outputs,reply,_i,_len;fromF=f(state,event);newState=fromF[0],outputs=fromF[1];state=newState;reply=Bacon.more;for(_i=0,_len=outputs.length;_i<_len;_i++){output=outputs[_i];reply=this.push(output);if(reply===Bacon.noMore){return reply}}return reply}))};Observable.prototype.scan=function(seed,f,options){var acc,f_,resultProperty,subscribe;if(options==null){options={}}f_=toCombinator(f);f=options.lazyF?f_:function(x,y){return f_(x(),y())};acc=toOption(seed).map(function(x){return _.always(x)});subscribe=function(_this){return function(sink){var initSent,reply,sendInit,unsub;initSent=false;unsub=nop;reply=Bacon.more;sendInit=function(){if(!initSent){return acc.forEach(function(valueF){initSent=true;reply=sink(new Initial(valueF));if(reply===Bacon.noMore){unsub();return unsub=nop}})}};unsub=_this.subscribeInternal(function(event){var next,prev;if(event.hasValue()){if(initSent&&event.isInitial()){return Bacon.more}else{if(!event.isInitial()){sendInit()}initSent=true;prev=acc.getOrElse(function(){return void 0});next=_.cached(function(){return f(prev,event.value)});acc=new Some(next);if(options.eager){next()}return sink(event.apply(next))}}else{if(event.isEnd()){reply=sendInit()}if(reply!==Bacon.noMore){return sink(event)}}});UpdateBarrier.whenDoneWith(resultProperty,sendInit);return unsub}}(this);return resultProperty=new Property(describe(this,"scan",seed,f),subscribe)};Observable.prototype.fold=function(seed,f,options){return withDescription(this,"fold",seed,f,this.scan(seed,f,options).sampledBy(this.filter(false).mapEnd().toProperty()))};Observable.prototype.zip=function(other,f){if(f==null){f=Array}return withDescription(this,"zip",other,Bacon.zipWith([this,other],f))};Observable.prototype.diff=function(start,f){f=toCombinator(f);return withDescription(this,"diff",start,f,this.scan([start],function(prevTuple,next){return[next,f(prevTuple[0],next)]}).filter(function(tuple){return tuple.length===2}).map(function(tuple){return tuple[1]}))};Observable.prototype.flatMap=function(){return flatMap_(this,makeSpawner(arguments))};Observable.prototype.flatMapFirst=function(){return flatMap_(this,makeSpawner(arguments),true)};Observable.prototype.flatMapWithConcurrencyLimit=function(){var args,limit;limit=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return withDescription.apply(null,[this,"flatMapWithConcurrencyLimit",limit].concat(__slice.call(args),[flatMap_(this,makeSpawner(args),false,limit)]))};Observable.prototype.flatMapLatest=function(){var f,stream;f=makeSpawner(arguments);stream=this.toEventStream();return withDescription(this,"flatMapLatest",f,stream.flatMap(function(value){return makeObservable(f(value)).takeUntil(stream)}))};Observable.prototype.flatMapError=function(fn){return withDescription(this,"flatMapError",fn,this.mapError(function(err){return new Bacon.Error(err)}).flatMap(function(x){if(x instanceof Bacon.Error){return fn(x.error)}else{return Bacon.once(x)}}))};Observable.prototype.flatMapConcat=function(){return withDescription.apply(null,[this,"flatMapConcat"].concat(__slice.call(arguments),[this.flatMapWithConcurrencyLimit.apply(this,[1].concat(__slice.call(arguments)))]))};Observable.prototype.bufferingThrottle=function(minimumInterval){return withDescription(this,"bufferingThrottle",minimumInterval,this.flatMapConcat(function(x){return Bacon.once(x).concat(Bacon.later(minimumInterval).filter(false))}))};Observable.prototype.not=function(){return withDescription(this,"not",this.map(function(x){return!x}))};Observable.prototype.log=function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];this.subscribe(function(event){return typeof console!=="undefined"&&console!==null?typeof console.log==="function"?console.log.apply(console,__slice.call(args).concat([event.log()])):void 0:void 0});return this};Observable.prototype.slidingWindow=function(n,minValues){if(minValues==null){minValues=0}return withDescription(this,"slidingWindow",n,minValues,this.scan([],function(window,value){return window.concat([value]).slice(-n)}).filter(function(values){return values.length>=minValues}))};Observable.prototype.combine=function(other,f){var combinator;combinator=toCombinator(f);return withDescription(this,"combine",other,f,Bacon.combineAsArray(this,other).map(function(values){return combinator(values[0],values[1])}))};Observable.prototype.decode=function(cases){return withDescription(this,"decode",cases,this.combine(Bacon.combineTemplate(cases),function(key,values){return values[key]}))};Observable.prototype.awaiting=function(other){return withDescription(this,"awaiting",other,Bacon.groupSimultaneous(this,other).map(function(_arg){var myValues,otherValues;myValues=_arg[0],otherValues=_arg[1];return otherValues.length===0}).toProperty(false).skipDuplicates())};Observable.prototype.name=function(name){this._name=name;return this};Observable.prototype.withDescription=function(){return describe.apply(null,arguments).apply(this)};Observable.prototype.dependsOn=function(observable){return DepCache.dependsOn(this,observable)};Observable.prototype.toString=function(){if(this._name){return this._name}else{return this.desc.toString()}};Observable.prototype.internalDeps=function(){return this.initialDesc.deps()};return Observable}();Observable.prototype.reduce=Observable.prototype.fold;Observable.prototype.assign=Observable.prototype.onValue;Observable.prototype.inspect=Observable.prototype.toString;flatMap_=function(root,f,firstOnly,limit){var deps,result;deps=[root];result=new EventStream(describe(root,"flatMap"+(firstOnly?"First":""),f),function(sink){var checkEnd,checkQueue,composite,queue,spawn;composite=new CompositeUnsubscribe;queue=[];spawn=function(event){var child;child=makeObservable(f(event.value()));deps.push(child);DepCache.invalidate();return composite.add(function(unsubAll,unsubMe){return child.subscribeInternal(function(event){var reply;if(event.isEnd()){_.remove(child,deps);DepCache.invalidate();checkQueue();checkEnd(unsubMe);return Bacon.noMore}else{if(event instanceof Initial){event=event.toNext()}reply=sink(event);if(reply===Bacon.noMore){unsubAll()}return reply}})})};checkQueue=function(){var event;event=queue.shift();if(event){return spawn(event)}};checkEnd=function(unsub){unsub();if(composite.empty()){return sink(end())}};composite.add(function(__,unsubRoot){return root.subscribeInternal(function(event){if(event.isEnd()){return checkEnd(unsubRoot)}else if(event.isError()){return sink(event)}else if(firstOnly&&composite.count()>1){return Bacon.more}else{if(composite.unsubscribed){return Bacon.noMore}if(limit&&composite.count()>limit){return queue.push(event)}else{return spawn(event)}}})});return composite.unsubscribe});result.internalDeps=function(){return deps};return result};EventStream=function(_super){__extends(EventStream,_super);function EventStream(desc,subscribe){var dispatcher;if(isFunction(desc)){subscribe=desc;desc=[]}EventStream.__super__.constructor.call(this,desc);assertFunction(subscribe);dispatcher=new Dispatcher(subscribe);this.subscribeInternal=dispatcher.subscribe;this.subscribe=UpdateBarrier.wrappedSubscribe(this);this.hasSubscribers=dispatcher.hasSubscribers;registerObs(this)}EventStream.prototype.delay=function(delay){return withDescription(this,"delay",delay,this.flatMap(function(value){return Bacon.later(delay,value)}))};EventStream.prototype.debounce=function(delay){return withDescription(this,"debounce",delay,this.flatMapLatest(function(value){return Bacon.later(delay,value)}))};EventStream.prototype.debounceImmediate=function(delay){return withDescription(this,"debounceImmediate",delay,this.flatMapFirst(function(value){return Bacon.once(value).concat(Bacon.later(delay).filter(false))}))};EventStream.prototype.throttle=function(delay){return withDescription(this,"throttle",delay,this.bufferWithTime(delay).map(function(values){return values[values.length-1]}))};EventStream.prototype.bufferWithTime=function(delay){return withDescription(this,"bufferWithTime",delay,this.bufferWithTimeOrCount(delay,Number.MAX_VALUE))};EventStream.prototype.bufferWithCount=function(count){return withDescription(this,"bufferWithCount",count,this.bufferWithTimeOrCount(void 0,count))};EventStream.prototype.bufferWithTimeOrCount=function(delay,count){var flushOrSchedule;flushOrSchedule=function(buffer){if(buffer.values.length===count){return buffer.flush()}else if(delay!==void 0){return buffer.schedule()}};return withDescription(this,"bufferWithTimeOrCount",delay,count,this.buffer(delay,flushOrSchedule,flushOrSchedule))};EventStream.prototype.buffer=function(delay,onInput,onFlush){var buffer,delayMs,reply;if(onInput==null){onInput=function(){}}if(onFlush==null){onFlush=function(){}}buffer={scheduled:false,end:null,values:[],flush:function(){var reply;this.scheduled=false;if(this.values.length>0){reply=this.push(next(this.values));this.values=[];if(this.end!=null){return this.push(this.end)}else if(reply!==Bacon.noMore){return onFlush(this)}}else{if(this.end!=null){return this.push(this.end)}}},schedule:function(){if(!this.scheduled){this.scheduled=true;return delay(function(_this){return function(){return _this.flush()}}(this))}}};reply=Bacon.more;if(!isFunction(delay)){delayMs=delay;delay=function(f){return Bacon.scheduler.setTimeout(f,delayMs)}}return withDescription(this,"buffer",this.withHandler(function(event){buffer.push=this.push;if(event.isError()){reply=this.push(event)}else if(event.isEnd()){buffer.end=event;if(!buffer.scheduled){buffer.flush()}}else{buffer.values.push(event.value());onInput(buffer)}return reply}))};EventStream.prototype.merge=function(right){var left;assertEventStream(right);left=this;return withDescription(left,"merge",right,Bacon.mergeAll(this,right))};EventStream.prototype.toProperty=function(initValue){if(arguments.length===0){initValue=None}return withDescription(this,"toProperty",initValue,this.scan(initValue,latterF,{lazyF:true}))};EventStream.prototype.toEventStream=function(){return this};EventStream.prototype.sampledBy=function(sampler,combinator){return withDescription(this,"sampledBy",sampler,combinator,this.toProperty().sampledBy(sampler,combinator))};EventStream.prototype.concat=function(right){var left;left=this;return new EventStream(describe(left,"concat",right),function(sink){var unsubLeft,unsubRight;unsubRight=nop;unsubLeft=left.subscribeInternal(function(e){if(e.isEnd()){return unsubRight=right.subscribeInternal(sink)}else{return sink(e)}});return function(){unsubLeft();return unsubRight()}})};EventStream.prototype.takeUntil=function(stopper){var endMarker;endMarker={};return withDescription(this,"takeUntil",stopper,Bacon.groupSimultaneous(this.mapEnd(endMarker),stopper.skipErrors()).withHandler(function(event){var data,reply,value,_i,_len,_ref1;if(!event.hasValue()){return this.push(event)}else{_ref1=event.value(),data=_ref1[0],stopper=_ref1[1];if(stopper.length){return this.push(end())}else{reply=Bacon.more;for(_i=0,_len=data.length;_i<_len;_i++){value=data[_i];if(value===endMarker){reply=this.push(end())}else{reply=this.push(next(value))}}return reply}}}))};EventStream.prototype.skipUntil=function(starter){var started;started=starter.take(1).map(true).toProperty(false);return withDescription(this,"skipUntil",starter,this.filter(started))};EventStream.prototype.skipWhile=function(){var args,f,ok;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];ok=false;return convertArgsToFunction(this,f,args,function(f){return withDescription(this,"skipWhile",f,this.withHandler(function(event){if(ok||!event.hasValue()||!f(event.value())){if(event.hasValue()){ok=true}return this.push(event)}else{return Bacon.more}}))})};EventStream.prototype.holdWhen=function(valve){var putToHold,releaseHold,valve_;valve_=valve.startWith(false);releaseHold=valve_.filter(function(x){return!x});putToHold=valve_.filter(_.id);return withDescription(this,"holdWhen",valve,this.filter(false).merge(valve_.flatMapConcat(function(_this){return function(shouldHold){if(!shouldHold){return _this.takeUntil(putToHold)}else{return _this.scan([],function(xs,x){return xs.concat(x)},{eager:true}).sampledBy(releaseHold).take(1).flatMap(Bacon.fromArray)}}}(this))))};EventStream.prototype.startWith=function(seed){return withDescription(this,"startWith",seed,Bacon.once(seed).concat(this))};EventStream.prototype.withHandler=function(handler){var dispatcher;dispatcher=new Dispatcher(this.subscribeInternal,handler);return new EventStream(describe(this,"withHandler",handler),dispatcher.subscribe)};return EventStream}(Observable);Property=function(_super){__extends(Property,_super);function Property(desc,subscribe,handler){if(isFunction(desc)){handler=subscribe;subscribe=desc;desc=[]}Property.__super__.constructor.call(this,desc);assertFunction(subscribe);if(handler===true){this.subscribeInternal=subscribe}else{this.subscribeInternal=new PropertyDispatcher(this,subscribe,handler).subscribe}this.subscribe=UpdateBarrier.wrappedSubscribe(this);registerObs(this)}Property.prototype.sampledBy=function(sampler,combinator){var lazy,result,samplerSource,stream,thisSource;if(combinator!=null){combinator=toCombinator(combinator)}else{lazy=true;combinator=function(f){return f()}}thisSource=new Source(this,false,this.subscribeInternal,lazy);samplerSource=new Source(sampler,true,sampler.subscribeInternal,lazy);stream=Bacon.when([thisSource,samplerSource],combinator);result=sampler instanceof Property?stream.toProperty():stream;return withDescription(this,"sampledBy",sampler,combinator,result)};Property.prototype.sample=function(interval){return withDescription(this,"sample",interval,this.sampledBy(Bacon.interval(interval,{})))};Property.prototype.changes=function(){return new EventStream(describe(this,"changes"),function(_this){return function(sink){return _this.subscribeInternal(function(event){if(!event.isInitial()){return sink(event)}})}}(this))};Property.prototype.withHandler=function(handler){return new Property(describe(this,"withHandler",handler),this.subscribeInternal,handler)};Property.prototype.toProperty=function(){assertNoArguments(arguments);return this};Property.prototype.toEventStream=function(){return new EventStream(describe(this,"toEventStream"),function(_this){return function(sink){return _this.subscribeInternal(function(event){if(event.isInitial()){event=event.toNext()}return sink(event)})}}(this))};Property.prototype.and=function(other){return withDescription(this,"and",other,this.combine(other,function(x,y){return x&&y}))};Property.prototype.or=function(other){return withDescription(this,"or",other,this.combine(other,function(x,y){return x||y}))};Property.prototype.delay=function(delay){return this.delayChanges("delay",delay,function(changes){return changes.delay(delay)})};Property.prototype.debounce=function(delay){return this.delayChanges("debounce",delay,function(changes){return changes.debounce(delay)})};Property.prototype.throttle=function(delay){return this.delayChanges("throttle",delay,function(changes){return changes.throttle(delay)})};Property.prototype.delayChanges=function(){var desc,f,_i;desc=2<=arguments.length?__slice.call(arguments,0,_i=arguments.length-1):(_i=0,[]),f=arguments[_i++];return withDescription.apply(null,[this].concat(__slice.call(desc),[addPropertyInitValueToStream(this,f(this.changes()))]))
};Property.prototype.takeUntil=function(stopper){var changes;changes=this.changes().takeUntil(stopper);return withDescription(this,"takeUntil",stopper,addPropertyInitValueToStream(this,changes))};Property.prototype.startWith=function(value){return withDescription(this,"startWith",value,this.scan(value,function(prev,next){return next}))};Property.prototype.bufferingThrottle=function(){var _ref1;return(_ref1=Property.__super__.bufferingThrottle.apply(this,arguments)).bufferingThrottle.apply(_ref1,arguments).toProperty()};return Property}(Observable);convertArgsToFunction=function(obs,f,args,method){var sampled;if(f instanceof Property){sampled=f.sampledBy(obs,function(p,s){return[p,s]});return method.apply(sampled,[function(_arg){var p,s;p=_arg[0],s=_arg[1];return p}]).map(function(_arg){var p,s;p=_arg[0],s=_arg[1];return s})}else{f=makeFunction(f,args);return method.apply(obs,[f])}};addPropertyInitValueToStream=function(property,stream){var justInitValue;justInitValue=new EventStream(describe(property,"justInitValue"),function(sink){var unsub,value;value=null;unsub=property.subscribeInternal(function(event){if(event.hasValue()){value=event}return Bacon.noMore});UpdateBarrier.whenDoneWith(justInitValue,function(){if(value!=null){sink(value)}return sink(end())});return unsub});return justInitValue.concat(stream).toProperty()};Dispatcher=function(){function Dispatcher(subscribe,handleEvent){var done,ended,prevError,pushIt,pushing,queue,removeSub,subscriptions,unsubscribeFromSource,waiters;if(subscribe==null){subscribe=function(){return nop}}subscriptions=[];queue=[];pushing=false;ended=false;this.hasSubscribers=function(){return subscriptions.length>0};prevError=null;unsubscribeFromSource=nop;removeSub=function(subscription){return subscriptions=_.without(subscription,subscriptions)};waiters=null;done=function(){var w,ws,_i,_len,_results;if(waiters!=null){ws=waiters;waiters=null;_results=[];for(_i=0,_len=ws.length;_i<_len;_i++){w=ws[_i];_results.push(w())}return _results}};pushIt=function(event){var reply,sub,success,tmp,_i,_len;if(!pushing){if(event===prevError){return}if(event.isError()){prevError=event}success=false;try{pushing=true;tmp=subscriptions;for(_i=0,_len=tmp.length;_i<_len;_i++){sub=tmp[_i];reply=sub.sink(event);if(reply===Bacon.noMore||event.isEnd()){removeSub(sub)}}success=true}finally{pushing=false;if(!success){queue=[]}}success=true;while(queue.length){event=queue.shift();this.push(event)}done(event);if(this.hasSubscribers()){return Bacon.more}else{unsubscribeFromSource();return Bacon.noMore}}else{queue.push(event);return Bacon.more}};this.push=function(_this){return function(event){return UpdateBarrier.inTransaction(event,_this,pushIt,[event])}}(this);if(handleEvent==null){handleEvent=function(event){return this.push(event)}}this.handleEvent=function(_this){return function(event){if(event.isEnd()){ended=true}return handleEvent.apply(_this,[event])}}(this);this.subscribe=function(_this){return function(sink){var subscription,unsubSrc;if(ended){sink(end());return nop}else{assertFunction(sink);subscription={sink:sink};subscriptions.push(subscription);if(subscriptions.length===1){unsubSrc=subscribe(_this.handleEvent);unsubscribeFromSource=function(){unsubSrc();return unsubscribeFromSource=nop}}assertFunction(unsubscribeFromSource);return function(){removeSub(subscription);if(!_this.hasSubscribers()){return unsubscribeFromSource()}}}}}(this)}return Dispatcher}();PropertyDispatcher=function(_super){__extends(PropertyDispatcher,_super);function PropertyDispatcher(p,subscribe,handleEvent){var current,currentValueRootId,ended,push;PropertyDispatcher.__super__.constructor.call(this,subscribe,handleEvent);current=None;currentValueRootId=void 0;push=this.push;subscribe=this.subscribe;ended=false;this.push=function(_this){return function(event){if(event.isEnd()){ended=true}if(event.hasValue()){current=new Some(event);currentValueRootId=UpdateBarrier.currentEventId()}return push.apply(_this,[event])}}(this);this.subscribe=function(_this){return function(sink){var dispatchingId,initSent,maybeSubSource,reply,valId;initSent=false;reply=Bacon.more;maybeSubSource=function(){if(reply===Bacon.noMore){return nop}else if(ended){sink(end());return nop}else{return subscribe.apply(this,[sink])}};if(current.isDefined&&(_this.hasSubscribers()||ended)){dispatchingId=UpdateBarrier.currentEventId();valId=currentValueRootId;if(!ended&&valId&&dispatchingId&&dispatchingId!==valId){UpdateBarrier.whenDoneWith(p,function(){if(currentValueRootId===valId){return sink(initial(current.get().value()))}});return maybeSubSource()}else{UpdateBarrier.inTransaction(void 0,_this,function(){return reply=sink(initial(current.get().value()))},[]);return maybeSubSource()}}else{return maybeSubSource()}}}(this)}return PropertyDispatcher}(Dispatcher);Bus=function(_super){__extends(Bus,_super);function Bus(){var ended,guardedSink,sink,subscribeAll,subscribeInput,subscriptions,unsubAll,unsubscribeInput;sink=void 0;subscriptions=[];ended=false;guardedSink=function(input){return function(event){if(event.isEnd()){unsubscribeInput(input);return Bacon.noMore}else{return sink(event)}}};unsubAll=function(){var sub,_i,_len,_results;_results=[];for(_i=0,_len=subscriptions.length;_i<_len;_i++){sub=subscriptions[_i];_results.push(typeof sub.unsub==="function"?sub.unsub():void 0)}return _results};subscribeInput=function(subscription){return subscription.unsub=subscription.input.subscribeInternal(guardedSink(subscription.input))};unsubscribeInput=function(input){var i,sub,_i,_len;for(i=_i=0,_len=subscriptions.length;_i<_len;i=++_i){sub=subscriptions[i];if(sub.input===input){if(typeof sub.unsub==="function"){sub.unsub()}subscriptions.splice(i,1);return}}};subscribeAll=function(newSink){var subscription,_i,_len,_ref1;sink=newSink;_ref1=cloneArray(subscriptions);for(_i=0,_len=_ref1.length;_i<_len;_i++){subscription=_ref1[_i];subscribeInput(subscription)}return unsubAll};Bus.__super__.constructor.call(this,describe(Bacon,"Bus"),subscribeAll);this.plug=function(input){var sub;if(ended){return}sub={input:input};subscriptions.push(sub);if(sink!=null){subscribeInput(sub)}return function(){return unsubscribeInput(input)}};this.push=function(value){return typeof sink==="function"?sink(next(value)):void 0};this.error=function(error){return typeof sink==="function"?sink(new Error(error)):void 0};this.end=function(){ended=true;unsubAll();return typeof sink==="function"?sink(end()):void 0}}return Bus}(EventStream);Source=function(){function Source(obs,sync,subscribe,lazy){this.obs=obs;this.sync=sync;this.subscribe=subscribe;this.lazy=lazy!=null?lazy:false;this.queue=[];if(this.subscribe==null){this.subscribe=this.obs.subscribeInternal}}Source.prototype.toString=function(){return this.obs.toString.call(this)};Source.prototype.markEnded=function(){return this.ended=true};Source.prototype.consume=function(){if(this.lazy){return _.always(this.queue[0])}else{return this.queue[0]}};Source.prototype.push=function(x){return this.queue=[x]};Source.prototype.mayHave=function(){return true};Source.prototype.hasAtLeast=function(){return this.queue.length};Source.prototype.flatten=true;return Source}();ConsumingSource=function(_super){__extends(ConsumingSource,_super);function ConsumingSource(){return ConsumingSource.__super__.constructor.apply(this,arguments)}ConsumingSource.prototype.consume=function(){return this.queue.shift()};ConsumingSource.prototype.push=function(x){return this.queue.push(x)};ConsumingSource.prototype.mayHave=function(c){return!this.ended||this.queue.length>=c};ConsumingSource.prototype.hasAtLeast=function(c){return this.queue.length>=c};ConsumingSource.prototype.flatten=false;return ConsumingSource}(Source);BufferingSource=function(_super){__extends(BufferingSource,_super);function BufferingSource(obs){this.obs=obs;BufferingSource.__super__.constructor.call(this,this.obs,true,this.obs.subscribeInternal)}BufferingSource.prototype.consume=function(){var values;values=this.queue;this.queue=[];return function(){return values}};BufferingSource.prototype.push=function(x){return this.queue.push(x())};BufferingSource.prototype.hasAtLeast=function(){return true};return BufferingSource}(Source);Source.isTrigger=function(s){if(s instanceof Source){return s.sync}else{return s instanceof EventStream}};Source.fromObservable=function(s){if(s instanceof Source){return s}else if(s instanceof Property){return new Source(s,false)}else{return new ConsumingSource(s,true)}};describe=function(){var args,context,method;context=arguments[0],method=arguments[1],args=3<=arguments.length?__slice.call(arguments,2):[];if((context||method)instanceof Desc){return context||method}else{return new Desc(context,method,args)}};findDeps=function(x){if(isArray(x)){return _.flatMap(findDeps,x)}else if(isObservable(x)){return[x]}else if(x instanceof Source){return[x.obs]}else{return[]}};Desc=function(){function Desc(context,method,args){this.context=context;this.method=method;this.args=args;this.cached=null}Desc.prototype.deps=function(){return this.cached||(this.cached=findDeps([this.context].concat(this.args)))};Desc.prototype.apply=function(obs){obs.desc=this;return obs};Desc.prototype.toString=function(){return _.toString(this.context)+"."+_.toString(this.method)+"("+_.map(_.toString,this.args)+")"};return Desc}();withDescription=function(){var desc,obs,_i;desc=2<=arguments.length?__slice.call(arguments,0,_i=arguments.length-1):(_i=0,[]),obs=arguments[_i++];return describe.apply(null,desc).apply(obs)};Bacon.when=function(){var f,i,index,ix,len,needsBarrier,pat,patSources,pats,patterns,resultStream,s,sources,triggerFound,usage,_i,_j,_len,_len1,_ref1;patterns=1<=arguments.length?__slice.call(arguments,0):[];if(patterns.length===0){return Bacon.never()}len=patterns.length;usage="when: expecting arguments in the form (Observable+,function)+";assert(usage,len%2===0);sources=[];pats=[];i=0;while(i<len){patSources=_.toArray(patterns[i]);f=patterns[i+1];pat={f:isFunction(f)?f:function(){return f},ixs:[]};triggerFound=false;for(_i=0,_len=patSources.length;_i<_len;_i++){s=patSources[_i];index=_.indexOf(sources,s);if(!triggerFound){triggerFound=Source.isTrigger(s)}if(index<0){sources.push(s);index=sources.length-1}_ref1=pat.ixs;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){ix=_ref1[_j];if(ix.index===index){ix.count++}}pat.ixs.push({index:index,count:1})}assert("At least one EventStream required",triggerFound||!patSources.length);if(patSources.length>0){pats.push(pat)}i=i+2}if(!sources.length){return Bacon.never()}sources=_.map(Source.fromObservable,sources);needsBarrier=_.any(sources,function(s){return s.flatten})&&containsDuplicateDeps(_.map(function(s){return s.obs},sources));return resultStream=new EventStream(describe.apply(null,[Bacon,"when"].concat(__slice.call(patterns))),function(sink){var cannotMatch,cannotSync,ends,match,nonFlattened,part,triggers;triggers=[];ends=false;match=function(p){var _k,_len2,_ref2;_ref2=p.ixs;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){i=_ref2[_k];if(!sources[i.index].hasAtLeast(i.count)){return false}}return true};cannotSync=function(source){return!source.sync||source.ended};cannotMatch=function(p){var _k,_len2,_ref2;_ref2=p.ixs;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){i=_ref2[_k];if(!sources[i.index].mayHave(i.count)){return true}}};nonFlattened=function(trigger){return!trigger.source.flatten};part=function(source){return function(unsubAll){var flush,flushLater,flushWhileTriggers;flushLater=function(){return UpdateBarrier.whenDoneWith(resultStream,flush)};flushWhileTriggers=function(){var functions,p,reply,trigger,_k,_len2;if(triggers.length>0){reply=Bacon.more;trigger=triggers.pop();for(_k=0,_len2=pats.length;_k<_len2;_k++){p=pats[_k];if(match(p)){functions=function(){var _l,_len3,_ref2,_results;_ref2=p.ixs;_results=[];for(_l=0,_len3=_ref2.length;_l<_len3;_l++){i=_ref2[_l];_results.push(sources[i.index].consume())}return _results}();reply=sink(trigger.e.apply(function(){var fun,values;values=function(){var _l,_len3,_results;_results=[];for(_l=0,_len3=functions.length;_l<_len3;_l++){fun=functions[_l];_results.push(fun())}return _results}();return p.f.apply(p,values)}));if(triggers.length){triggers=_.filter(nonFlattened,triggers)}if(reply===Bacon.noMore){return reply}else{return flushWhileTriggers()}}}}else{return Bacon.more}};flush=function(){var reply;reply=flushWhileTriggers();if(ends){ends=false;if(_.all(sources,cannotSync)||_.all(pats,cannotMatch)){reply=Bacon.noMore;sink(end())}}if(reply===Bacon.noMore){unsubAll()}return reply};return source.subscribe(function(e){var reply;if(e.isEnd()){ends=true;source.markEnded();flushLater()}else if(e.isError()){reply=sink(e)}else{source.push(e.value);if(source.sync){triggers.push({source:source,e:e});if(needsBarrier||UpdateBarrier.hasWaiters()){flushLater()}else{flush()}}}if(reply===Bacon.noMore){unsubAll()}return reply||Bacon.more})}};return compositeUnsubscribe.apply(null,function(){var _k,_len2,_results;_results=[];for(_k=0,_len2=sources.length;_k<_len2;_k++){s=sources[_k];_results.push(part(s))}return _results}())})};containsDuplicateDeps=function(observables,state){var checkObservable;if(state==null){state=[]}checkObservable=function(obs){var deps;if(Bacon._.contains(state,obs)){return true}else{deps=obs.internalDeps();if(deps.length){state.push(obs);return Bacon._.any(deps,checkObservable)}else{state.push(obs);return false}}};return Bacon._.any(observables,checkObservable)};Bacon.update=function(){var i,initial,lateBindFirst,patterns;initial=arguments[0],patterns=2<=arguments.length?__slice.call(arguments,1):[];lateBindFirst=function(f){return function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];return function(i){return f.apply(null,[i].concat(args))}}};i=patterns.length-1;while(i>0){if(!(patterns[i]instanceof Function)){patterns[i]=function(x){return function(){return x}}(patterns[i])}patterns[i]=lateBindFirst(patterns[i]);i=i-2}return withDescription.apply(null,[Bacon,"update",initial].concat(__slice.call(patterns),[Bacon.when.apply(Bacon,patterns).scan(initial,function(x,f){return f(x)})]))};compositeUnsubscribe=function(){var ss;ss=1<=arguments.length?__slice.call(arguments,0):[];return new CompositeUnsubscribe(ss).unsubscribe};CompositeUnsubscribe=function(){function CompositeUnsubscribe(ss){var s,_i,_len;if(ss==null){ss=[]}this.unsubscribe=__bind(this.unsubscribe,this);this.unsubscribed=false;this.subscriptions=[];this.starting=[];for(_i=0,_len=ss.length;_i<_len;_i++){s=ss[_i];this.add(s)}}CompositeUnsubscribe.prototype.add=function(subscription){var ended,unsub,unsubMe;if(this.unsubscribed){return}ended=false;unsub=nop;this.starting.push(subscription);unsubMe=function(_this){return function(){if(_this.unsubscribed){return}ended=true;_this.remove(unsub);return _.remove(subscription,_this.starting)}}(this);unsub=subscription(this.unsubscribe,unsubMe);if(!(this.unsubscribed||ended)){this.subscriptions.push(unsub)}_.remove(subscription,this.starting);return unsub};CompositeUnsubscribe.prototype.remove=function(unsub){if(this.unsubscribed){return}if(_.remove(unsub,this.subscriptions)!==void 0){return unsub()}};CompositeUnsubscribe.prototype.unsubscribe=function(){var s,_i,_len,_ref1;if(this.unsubscribed){return}this.unsubscribed=true;_ref1=this.subscriptions;for(_i=0,_len=_ref1.length;_i<_len;_i++){s=_ref1[_i];s()}this.subscriptions=[];return this.starting=[]};CompositeUnsubscribe.prototype.count=function(){if(this.unsubscribed){return 0}return this.subscriptions.length+this.starting.length};CompositeUnsubscribe.prototype.empty=function(){return this.count()===0};return CompositeUnsubscribe}();Bacon.CompositeUnsubscribe=CompositeUnsubscribe;Some=function(){function Some(value){this.value=value}Some.prototype.getOrElse=function(){return this.value};Some.prototype.get=function(){return this.value};Some.prototype.filter=function(f){if(f(this.value)){return new Some(this.value)}else{return None}};Some.prototype.map=function(f){return new Some(f(this.value))};Some.prototype.forEach=function(f){return f(this.value)};Some.prototype.isDefined=true;Some.prototype.toArray=function(){return[this.value]};Some.prototype.inspect=function(){return"Some("+this.value+")"};Some.prototype.toString=function(){return this.inspect()};return Some}();None={getOrElse:function(value){return value},filter:function(){return None},map:function(){return None},forEach:function(){},isDefined:false,toArray:function(){return[]},inspect:function(){return"None"},toString:function(){return this.inspect()}};DepCache=function(){var collectDeps,dependsOn,flatDeps,invalidate;flatDeps={};dependsOn=function(orig,o){var myDeps;myDeps=flatDeps[orig.id];if(!myDeps){myDeps=flatDeps[orig.id]={};collectDeps(orig,orig)}return myDeps[o.id]};collectDeps=function(orig,o){var dep,_i,_len,_ref1,_results;_ref1=o.internalDeps();_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){dep=_ref1[_i];flatDeps[orig.id][dep.id]=true;_results.push(collectDeps(orig,dep))}return _results};invalidate=function(){return flatDeps={}};return{invalidate:invalidate,dependsOn:dependsOn}}();UpdateBarrier=function(){var afterTransaction,afters,currentEventId,findIndependent,flush,hasWaiters,inTransaction,independent,invalidateDeps,rootEvent,waiters,whenDoneWith,wrappedSubscribe;rootEvent=void 0;waiters=[];afters=[];afterTransaction=function(f){if(rootEvent){return afters.push(f)}else{return f()}};independent=function(waiter){return!_.any(waiters,function(other){return DepCache.dependsOn(waiter.obs,other.obs)})};whenDoneWith=function(obs,f){if(rootEvent){return waiters.push({obs:obs,f:f})}else{return f()}};findIndependent=function(){while(!independent(waiters[0])){waiters.push(waiters.shift())}return waiters.shift()};flush=function(){var _results;_results=[];while(waiters.length){_results.push(findIndependent().f())}return _results};invalidateDeps=DepCache.invalidate;inTransaction=function(event,context,f,args){var result,theseAfters,_i,_len;if(rootEvent){return f.apply(context,args)}else{rootEvent=event;try{result=f.apply(context,args);flush()}finally{rootEvent=void 0;while(afters.length){theseAfters=afters;afters=[];for(_i=0,_len=theseAfters.length;_i<_len;_i++){f=theseAfters[_i];f()}}invalidateDeps()}return result}};currentEventId=function(){if(rootEvent){return rootEvent.id}else{return void 0}};wrappedSubscribe=function(obs){return function(sink){var doUnsub,unsub,unsubd;unsubd=false;doUnsub=function(){};unsub=function(){unsubd=true;return doUnsub()};doUnsub=obs.subscribeInternal(function(event){return afterTransaction(function(){var reply;if(!unsubd){reply=sink(event);if(reply===Bacon.noMore){return unsub()}}})});return unsub}};hasWaiters=function(){return waiters.length>0};return{whenDoneWith:whenDoneWith,hasWaiters:hasWaiters,inTransaction:inTransaction,currentEventId:currentEventId,wrappedSubscribe:wrappedSubscribe}}();Bacon.EventStream=EventStream;Bacon.Property=Property;Bacon.Observable=Observable;Bacon.Bus=Bus;Bacon.Initial=Initial;Bacon.Next=Next;Bacon.End=End;Bacon.Error=Error;nop=function(){};latterF=function(_,x){return x()};former=function(x,_){return x};initial=function(value){return new Initial(_.always(value))};next=function(value){return new Next(_.always(value))};end=function(){return new End};toEvent=function(x){if(x instanceof Event){return x}else{return next(x)}};cloneArray=function(xs){return xs.slice(0)};assert=function(message,condition){if(!condition){throw message}};assertEventStream=function(event){if(!(event instanceof EventStream)){throw"not an EventStream : "+event}};assertFunction=function(f){return assert("not a function : "+f,isFunction(f))};isFunction=function(f){return typeof f==="function"};isArray=function(xs){return xs instanceof Array};isObservable=function(x){return x instanceof Observable};assertArray=function(xs){if(!isArray(xs)){throw"not an array : "+xs}};assertNoArguments=function(args){return assert("no arguments supported",args.length===0)};assertString=function(x){if(typeof x!=="string"){throw"not a string : "+x}};partiallyApplied=function(f,applied){return function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];return f.apply(null,applied.concat(args))}};makeSpawner=function(args){if(args.length===1&&isObservable(args[0])){return _.always(args[0])}else{return makeFunctionArgs(args)}};makeFunctionArgs=function(args){args=Array.prototype.slice.call(args);return makeFunction_.apply(null,args)};makeFunction_=withMethodCallSupport(function(){var args,f;f=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(isFunction(f)){if(args.length){return partiallyApplied(f,args)}else{return f}}else if(isFieldKey(f)){return toFieldExtractor(f,args)}else{return _.always(f)}});makeFunction=function(f,args){return makeFunction_.apply(null,[f].concat(__slice.call(args)))};makeObservable=function(x){if(isObservable(x)){return x}else{return Bacon.once(x)}};isFieldKey=function(f){return typeof f==="string"&&f.length>1&&f.charAt(0)==="."};Bacon.isFieldKey=isFieldKey;toFieldExtractor=function(f,args){var partFuncs,parts;parts=f.slice(1).split(".");partFuncs=_.map(toSimpleExtractor(args),parts);return function(value){var _i,_len;for(_i=0,_len=partFuncs.length;_i<_len;_i++){f=partFuncs[_i];value=f(value)}return value}};toSimpleExtractor=function(args){return function(key){return function(value){var fieldValue;if(value==null){return void 0}else{fieldValue=value[key];if(isFunction(fieldValue)){return fieldValue.apply(value,args)}else{return fieldValue}}}}};toFieldKey=function(f){return f.slice(1)};toCombinator=function(f){var key;if(isFunction(f)){return f}else if(isFieldKey(f)){key=toFieldKey(f);return function(left,right){return left[key](right)}}else{return assert("not a function or a field key: "+f,false)}};toOption=function(v){if(v instanceof Some||v===None){return v}else{return new Some(v)}};_={indexOf:Array.prototype.indexOf?function(xs,x){return xs.indexOf(x)}:function(xs,x){var i,y,_i,_len;for(i=_i=0,_len=xs.length;_i<_len;i=++_i){y=xs[i];if(x===y){return i}}return-1},indexWhere:function(xs,f){var i,y,_i,_len;for(i=_i=0,_len=xs.length;_i<_len;i=++_i){y=xs[i];if(f(y)){return i}}return-1},head:function(xs){return xs[0]},always:function(x){return function(){return x}},negate:function(f){return function(x){return!f(x)}},empty:function(xs){return xs.length===0},tail:function(xs){return xs.slice(1,xs.length)},filter:function(f,xs){var filtered,x,_i,_len;filtered=[];for(_i=0,_len=xs.length;_i<_len;_i++){x=xs[_i];if(f(x)){filtered.push(x)}}return filtered},map:function(f,xs){var x,_i,_len,_results;_results=[];for(_i=0,_len=xs.length;_i<_len;_i++){x=xs[_i];_results.push(f(x))}return _results},each:function(xs,f){var key,value,_results;_results=[];for(key in xs){value=xs[key];_results.push(f(key,value))}return _results},toArray:function(xs){if(isArray(xs)){return xs}else{return[xs]}},contains:function(xs,x){return _.indexOf(xs,x)!==-1},id:function(x){return x},last:function(xs){return xs[xs.length-1]},all:function(xs,f){var x,_i,_len;if(f==null){f=_.id}for(_i=0,_len=xs.length;_i<_len;_i++){x=xs[_i];if(!f(x)){return false}}return true},any:function(xs,f){var x,_i,_len;if(f==null){f=_.id}for(_i=0,_len=xs.length;_i<_len;_i++){x=xs[_i];if(f(x)){return true}}return false},without:function(x,xs){return _.filter(function(y){return y!==x},xs)},remove:function(x,xs){var i;i=_.indexOf(xs,x);if(i>=0){return xs.splice(i,1)}},fold:function(xs,seed,f){var x,_i,_len;for(_i=0,_len=xs.length;_i<_len;_i++){x=xs[_i];seed=f(seed,x)}return seed},flatMap:function(f,xs){return _.fold(xs,[],function(ys,x){return ys.concat(f(x))})},cached:function(f){var value;value=None;return function(){if(value===None){value=f();f=null}return value}},toString:function(obj){var ex,internals,key,value;try{recursionDepth++;if(obj==null){return"undefined"}else if(isFunction(obj)){return"function"}else if(isArray(obj)){if(recursionDepth>5){return"[..]"}return"["+_.map(_.toString,obj).toString()+"]"}else if((obj!=null?obj.toString:void 0)!=null&&obj.toString!==Object.prototype.toString){return obj.toString()}else if(typeof obj==="object"){if(recursionDepth>5){return"{..}"}internals=function(){var _results;_results=[];for(key in obj){if(!__hasProp.call(obj,key))continue;value=function(){try{return obj[key]}catch(_error){ex=_error;return ex}}();_results.push(_.toString(key)+":"+_.toString(value))}return _results}();return"{"+internals+"}"}else{return obj}}finally{recursionDepth--}}};recursionDepth=0;Bacon._=_;Bacon.scheduler={setTimeout:function(f,d){return setTimeout(f,d)},setInterval:function(f,i){return setInterval(f,i)},clearInterval:function(id){return clearInterval(id)},now:function(){return(new Date).getTime()}};if(typeof define!=="undefined"&&define!==null&&define.amd!=null){define([],function(){return Bacon});this.Bacon=Bacon}else if(typeof module!=="undefined"&&module!==null){module.exports=Bacon;Bacon.Bacon=Bacon}else{this.Bacon=Bacon}}).call(this);/*
 * jwerty - Awesome handling of keyboard events
 *
 * jwerty is a JS lib which allows you to bind, fire and assert key combination
 * strings against elements and events. It normalises the poor std api into
 * something easy to use and clear.
 *
 * This code is licensed under the MIT
 * For the full license see: http://keithamus.mit-license.org/
 * For more information see: http://keithamus.github.com/jwerty
 *
 * @author Keith Cirkel ('keithamus') <jwerty@keithcirkel.co.uk>
 * @license http://keithamus.mit-license.org/
 * @copyright Copyright © 2011, Keith Cirkel
 *
 */
(function(global,exports){var $d=global.document,$=global.jQuery||global.Zepto||global.ender||$d,$$,$b,$f,ke="keydown";function realTypeOf(v,s){return v===null?s==="null":v===undefined?s==="undefined":v.is&&v instanceof $?s==="element":Object.prototype.toString.call(v).toLowerCase().indexOf(s)>7}if($===$d){$$=function(selector,context){return selector?$.querySelector(selector,context||$):$};$b=function(e,fn){e.addEventListener(ke,fn,false)};$f=function(e,jwertyEv){var ret=$d.createEvent("Event"),i;ret.initEvent(ke,true,true);for(i in jwertyEv)ret[i]=jwertyEv[i];return(e||$).dispatchEvent(ret)}}else{$$=function(selector,context){return $(selector||$d,context)};$b=function(e,fn){$(e).bind(ke+".jwerty",fn)};$f=function(e,ob){$(e||$d).trigger($.Event(ke,ob))}}var _modProps={16:"shiftKey",17:"ctrlKey",18:"altKey",91:"metaKey"};var _keys={mods:{"⇧":16,shift:16,"⌃":17,ctrl:17,"⌥":18,alt:18,option:18,"⌘":91,meta:91,cmd:91,"super":91,win:91},keys:{"⌫":8,backspace:8,"⇥":9,"⇆":9,tab:9,"↩":13,"return":13,enter:13,"⌅":13,pause:19,"pause-break":19,"⇪":20,caps:20,"caps-lock":20,"⎋":27,escape:27,esc:27,space:32,"↖":33,pgup:33,"page-up":33,"↘":34,pgdown:34,"page-down":34,"⇟":35,end:35,"⇞":36,home:36,ins:45,insert:45,del:46,"delete":46,"←":37,left:37,"arrow-left":37,"↑":38,up:38,"arrow-up":38,"→":39,right:39,"arrow-right":39,"↓":40,down:40,"arrow-down":40,"*":106,star:106,asterisk:106,multiply:106,"+":107,plus:107,"-":109,subtract:109,"num-.":110,"num-period":110,"num-dot":110,"num-full-stop":110,"num-delete":110,";":186,semicolon:186,"=":187,equals:187,",":188,comma:188,".":190,period:190,"full-stop":190,"/":191,slash:191,"forward-slash":191,"`":192,tick:192,"back-quote":192,"[":219,"open-bracket":219,"\\":220,"back-slash":220,"]":221,"close-bracket":221,"'":222,quote:222,apostraphe:222}};var i=47,n=0;while(++i<106){_keys.keys[n]=i;_keys.keys["num-"+n]=i+48;++n}i=111,n=1;while(++i<136){_keys.keys["f"+n]=i;++n}i=64;while(++i<91){_keys.keys[String.fromCharCode(i).toLowerCase()]=i}function JwertyCode(jwertyCode){var i,c,n,z,keyCombo,optionals,jwertyCodeFragment,rangeMatches,rangeI;if(jwertyCode instanceof JwertyCode)return jwertyCode;if(!realTypeOf(jwertyCode,"array")){jwertyCode=String(jwertyCode).replace(/\s/g,"").toLowerCase().match(/(?:\+,|[^,])+/g)}for(i=0,c=jwertyCode.length;i<c;++i){if(!realTypeOf(jwertyCode[i],"array")){jwertyCode[i]=String(jwertyCode[i]).match(/(?:\+\/|[^\/])+/g)}optionals=[],n=jwertyCode[i].length;while(n--){jwertyCodeFragment=jwertyCode[i][n];keyCombo={jwertyCombo:String(jwertyCodeFragment),shiftKey:false,ctrlKey:false,altKey:false,metaKey:false};if(!realTypeOf(jwertyCodeFragment,"array")){jwertyCodeFragment=String(jwertyCodeFragment).toLowerCase().match(/(?:(?:[^\+])+|\+\+|^\+$)/g)}z=jwertyCodeFragment.length;while(z--){if(jwertyCodeFragment[z]==="++")jwertyCodeFragment[z]="+";if(jwertyCodeFragment[z]in _keys.mods){keyCombo[_modProps[_keys.mods[jwertyCodeFragment[z]]]]=true}else if(jwertyCodeFragment[z]in _keys.keys){keyCombo.keyCode=_keys.keys[jwertyCodeFragment[z]]}else{rangeMatches=jwertyCodeFragment[z].match(/^\[([^-]+\-?[^-]*)-([^-]+\-?[^-]*)\]$/)}}if(realTypeOf(keyCombo.keyCode,"undefined")){if(rangeMatches&&rangeMatches[1]in _keys.keys&&rangeMatches[2]in _keys.keys){rangeMatches[2]=_keys.keys[rangeMatches[2]];rangeMatches[1]=_keys.keys[rangeMatches[1]];for(rangeI=rangeMatches[1];rangeI<rangeMatches[2];++rangeI){optionals.push({altKey:keyCombo.altKey,shiftKey:keyCombo.shiftKey,metaKey:keyCombo.metaKey,ctrlKey:keyCombo.ctrlKey,keyCode:rangeI,jwertyCombo:String(jwertyCodeFragment)})}keyCombo.keyCode=rangeI}else{keyCombo.keyCode=0}}optionals.push(keyCombo)}this[i]=optionals}this.length=i;return this}var jwerty=exports.jwerty={event:function(jwertyCode,callbackFunction,callbackContext){if(realTypeOf(callbackFunction,"boolean")){var bool=callbackFunction;callbackFunction=function(){return bool}}jwertyCode=new JwertyCode(jwertyCode);var i=0,c=jwertyCode.length-1,returnValue,jwertyCodeIs;return function(event){if(jwertyCodeIs=jwerty.is(jwertyCode,event,i)){if(i<c){++i;return}else{returnValue=callbackFunction.call(callbackContext||this,event,jwertyCodeIs);if(returnValue===false)event.preventDefault();i=0;return}}i=jwerty.is(jwertyCode,event)?1:0}},is:function(jwertyCode,event,i){jwertyCode=new JwertyCode(jwertyCode);i=i||0;jwertyCode=jwertyCode[i];event=event.originalEvent||event;var n=jwertyCode.length,returnValue=false;while(n--){returnValue=jwertyCode[n].jwertyCombo;for(var p in jwertyCode[n]){if(p!=="jwertyCombo"&&event[p]!=jwertyCode[n][p])returnValue=false}if(returnValue!==false)return returnValue}return returnValue},key:function(jwertyCode,callbackFunction,callbackContext,selector,selectorContext){var realSelector=realTypeOf(callbackContext,"element")||realTypeOf(callbackContext,"string")?callbackContext:selector,realcallbackContext=realSelector===callbackContext?global:callbackContext,realSelectorContext=realSelector===callbackContext?selector:selectorContext;$b(realTypeOf(realSelector,"element")?realSelector:$$(realSelector,realSelectorContext),jwerty.event(jwertyCode,callbackFunction,realcallbackContext))},fire:function(jwertyCode,selector,selectorContext,i){jwertyCode=new JwertyCode(jwertyCode);var realI=realTypeOf(selectorContext,"number")?selectorContext:i;$f(realTypeOf(selector,"element")?selector:$$(selector,selectorContext),jwertyCode[realI||0][0])},KEYS:_keys}})(this,typeof module!=="undefined"&&module.exports?module.exports:this);(function(){var e,t,n,r,i,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},u=this;this.Stripe=function(){function e(){}return e.version=2,e.endpoint="https://api.stripe.com/v1",e.setPublishableKey=function(t){e.key=t},e.complete=function(t){return function(n,r,i){var s;if(n!=="success")return s=Math.round((new Date).getTime()/1e3),(new Image).src="https://q.stripe.com?event=stripejs-error&type="+n+"&key="+e.key+"&timestamp="+s,typeof t=="function"?t(500,{error:{code:n,type:n,message:"An unexpected error has occurred submitting your credit\ncard to our secure credit card processor. This may be\ndue to network connectivity issues, so you should try\nagain (you won't be charged twice). If this problem\npersists, please let us know!"}}):void 0}},e}.call(this),e=this.Stripe,this.Stripe.token=function(){function t(){}return t.validate=function(e,t){if(!e)throw t+" required";if(typeof e!="object")throw t+" invalid"},t.formatData=function(t,n){return e.utils.isElement(t)&&(t=e.utils.paramsFromForm(t,n)),e.utils.underscoreKeys(t),t},t.create=function(t,n){return t.key||(t.key=e.key||e.publishableKey),e.utils.validateKey(t.key),e.ajaxJSONP({url:""+e.endpoint+"/tokens",data:t,method:"POST",success:function(e,t){return typeof n=="function"?n(t,e):void 0},complete:e.complete(n),timeout:4e4})},t.get=function(t,n){if(!t)throw"token required";return e.utils.validateKey(e.key),e.ajaxJSONP({url:""+e.endpoint+"/tokens/"+t,data:{key:e.key},success:function(e,t){return typeof n=="function"?n(t,e):void 0},complete:e.complete(n),timeout:4e4})},t}.call(this),this.Stripe.card=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return o(n,t),n.tokenName="card",n.whitelistedAttrs=["number","cvc","exp_month","exp_year","name","address_line1","address_line2","address_city","address_state","address_zip","address_country"],n.createToken=function(t,r,i){var s;return r==null&&(r={}),e.token.validate(t,"card"),typeof r=="function"?(i=r,r={}):typeof r!="object"&&(s=parseInt(r,10),r={},s>0&&(r.amount=s)),r[n.tokenName]=e.token.formatData(t,n.whitelistedAttrs),e.token.create(r,i)},n.getToken=function(t,n){return e.token.get(t,n)},n.validateCardNumber=function(e){return e=(e+"").replace(/\s+|-/g,""),e.length>=10&&e.length<=16&&n.luhnCheck(e)},n.validateCVC=function(t){return t=e.utils.trim(t),/^\d+$/.test(t)&&t.length>=3&&t.length<=4},n.validateExpiry=function(t,n){var r,i;return t=e.utils.trim(t),n=e.utils.trim(n),/^\d+$/.test(t)?/^\d+$/.test(n)?parseInt(t,10)<=12?(i=new Date(n,t),r=new Date,i.setMonth(i.getMonth()-1),i.setMonth(i.getMonth()+1,1),i>r):!1:!1:!1},n.luhnCheck=function(e){var t,n,r,i,s,o;r=!0,i=0,n=(e+"").split("").reverse();for(s=0,o=n.length;s<o;s++){t=n[s],t=parseInt(t,10);if(r=!r)t*=2;t>9&&(t-=9),i+=t}return i%10===0},n.cardType=function(e){return n.cardTypes[e.slice(0,2)]||"Unknown"},n.cardTypes=function(){var e,t,n,r;t={};for(e=n=40;n<=49;e=++n)t[e]="Visa";for(e=r=50;r<=59;e=++r)t[e]="MasterCard";return t[34]=t[37]="American Express",t[60]=t[62]=t[64]=t[65]="Discover",t[35]="JCB",t[30]=t[36]=t[38]=t[39]="Diners Club",t}(),n}.call(this,this.Stripe.token),this.Stripe.bankAccount=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return o(n,t),n.tokenName="bank_account",n.whitelistedAttrs=["country","routing_number","account_number"],n.createToken=function(t,r,i){return r==null&&(r={}),e.token.validate(t,"bank account"),typeof r=="function"&&(i=r,r={}),r[n.tokenName]=e.token.formatData(t,n.whitelistedAttrs),e.token.create(r,i)},n.getToken=function(t,n){return e.token.get(t,n)},n.validateRoutingNumber=function(t,r){t=e.utils.trim(t);switch(r){case"US":return/^\d+$/.test(t)&&t.length===9&&n.routingChecksum(t);case"CA":return/\d{5}\-\d{3}/.test(t)&&t.length===9;default:return!0}},n.validateAccountNumber=function(t,n){t=e.utils.trim(t);switch(n){case"US":return/^\d+$/.test(t)&&t.length>=1&&t.length<=17;default:return!0}},n.routingChecksum=function(e){var t,n,r,i,s,o;r=0,t=(e+"").split(""),o=[0,3,6];for(i=0,s=o.length;i<s;i++)n=o[i],r+=parseInt(t[n])*3,r+=parseInt(t[n+1])*7,r+=parseInt(t[n+2]);return r!==0&&r%10===0},n}.call(this,this.Stripe.token),t=["createToken","getToken","cardType","validateExpiry","validateCVC","validateCardNumber"];for(r=0,i=t.length;r<i;r++)n=t[r],this.Stripe[n]=this.Stripe.card[n];typeof module!="undefined"&&module!==null&&(module.exports=this.Stripe),typeof define=="function"&&define("stripe",[],function(){return u.Stripe})}).call(this),function(){var e,t,n,r=[].slice;e=encodeURIComponent,t=(new Date).getTime(),n=function(t,r,i){var s,o;r==null&&(r=[]);for(s in t)o=t[s],i&&(s=""+i+"["+s+"]"),typeof o=="object"?n(o,r,s):r.push(""+s+"="+e(o));return r.join("&").replace(/%20/g,"+")},this.Stripe.ajaxJSONP=function(e){var i,s,o,u,a,f;return e==null&&(e={}),o="sjsonp"+ ++t,a=document.createElement("script"),s=null,i=function(t){var n;return t==null&&(t="abort"),clearTimeout(s),(n=a.parentNode)!=null&&n.removeChild(a),o in window&&(window[o]=function(){}),typeof e.complete=="function"?e.complete(t,f,e):void 0},f={abort:i},a.onerror=function(){return f.abort(),typeof e.error=="function"?e.error(f,e):void 0},window[o]=function(){var t;t=1<=arguments.length?r.call(arguments,0):[],clearTimeout(s),a.parentNode.removeChild(a);try{delete window[o]}catch(n){window[o]=void 0}return typeof e.success=="function"&&e.success.apply(e,t),typeof e.complete=="function"?e.complete("success",f,e):void 0},e.data||(e.data={}),e.data.callback=o,e.method&&(e.data._method=e.method),a.src=e.url+"?"+n(e.data),u=document.getElementsByTagName("head")[0],u.appendChild(a),e.timeout>0&&(s=setTimeout(function(){return f.abort("timeout")},e.timeout)),f}}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};this.Stripe.utils=function(){function t(){}return t.trim=function(e){return(e+"").replace(/^\s+|\s+$/g,"")},t.underscore=function(e){return(e+"").replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace(/-/g,"_")},t.underscoreKeys=function(e){var t,n,r;r=[];for(t in e)n=e[t],delete e[t],r.push(e[this.underscore(t)]=n);return r},t.isElement=function(e){return typeof e!="object"?!1:typeof jQuery!="undefined"&&jQuery!==null&&e instanceof jQuery?!0:e.nodeType===1},t.paramsFromForm=function(t,n){var r,i,s,o,u,a,f,l,c,h;n==null&&(n=[]),typeof jQuery!="undefined"&&jQuery!==null&&t instanceof jQuery&&(t=t[0]),s=t.getElementsByTagName("input"),u=t.getElementsByTagName("select"),a={};for(f=0,c=s.length;f<c;f++){i=s[f],r=this.underscore(i.getAttribute("data-stripe"));if(e.call(n,r)<0)continue;a[r]=i.value}for(l=0,h=u.length;l<h;l++){o=u[l],r=this.underscore(o.getAttribute("data-stripe"));if(e.call(n,r)<0)continue;o.selectedIndex!=null&&(a[r]=o.options[o.selectedIndex].value)}return a},t.validateKey=function(e){if(!e||typeof e!="string")throw new Error("You did not set a valid publishable key. Call Stripe.setPublishableKey() with your publishable key. For more info, see https://stripe.com/docs/stripe.js");if(/\s/g.test(e))throw new Error("Your key is invalid, as it contains whitespace. For more info, see https://stripe.com/docs/stripe.js");if(/^sk_/.test(e))throw new Error("You are using a secret key with Stripe.js, instead of the publishable one. For more info, see https://stripe.com/docs/stripe.js")},t}()}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};this.Stripe.validator={"boolean":function(e,t){if(t!=="true"&&t!=="false")return"Enter a boolean string (true or false)"},integer:function(e,t){if(!/^\d+$/.test(t))return"Enter an integer"},positive:function(e,t){if(!(!this.integer(e,t)&&parseInt(t,10)>0))return"Enter a positive value"},range:function(t,n){var r;if(r=parseInt(n,10),e.call(t,r)<0)return"Needs to be between "+t[0]+" and "+t[t.length-1]},required:function(e,t){if(e&&(t==null||t===""))return"Required"},year:function(e,t){if(!/^\d{4}$/.test(t))return"Enter a 4-digit year"},birthYear:function(e,t){var n;n=this.year(e,t);if(n)return n;if(parseInt(t,10)>2e3)return"You must be over 18";if(parseInt(t,10)<1900)return"Enter your birth year"},month:function(e,t){if(this.integer(e,t))return"Please enter a month";if(this.range([1,2,3,4,5,6,7,8,9,10,11,12],t))return"Needs to be between 1 and 12"},choices:function(t,n){if(e.call(t,n)<0)return"Not an acceptable value for this field"},email:function(e,t){if(!/^[^@<\s>]+@[^@<\s>]+$/.test(t))return"That doesn't look like an email address"},url:function(e,t){if(!/^https?:\/\/.+\..+/.test(t))return"Not a valid url"},usTaxID:function(e,t){if(!/^\d{2}-?\d{1}-?\d{2}-?\d{4}$/.test(t))return"Not a valid tax ID"},ein:function(e,t){if(!/^\d{2}-?\d{7}$/.test(t))return"Not a valid EIN"},ssnLast4:function(e,t){if(!/^\d{4}$/.test(t))return"Not a valid last 4 digits for an SSN"},ownerPersonalID:function(e,t){var n;n=function(){switch(e){case"CA":return/^\d{3}-?\d{3}-?\d{3}$/.test(t);case"US":return!0}}();if(!n)return"Not a valid ID"},bizTaxID:function(e,t){var n,r,i,s,o,u,a,f;u={CA:["Tax ID",[/^\d{9}$/]],US:["EIN",[/^\d{2}-?\d{7}$/]]},o=u[e];if(o!=null){n=o[0],s=o[1],r=!1;for(a=0,f=s.length;a<f;a++){i=s[a];if(i.test(t)){r=!0;break}}if(!r)return"Not a valid "+n}},zip:function(e,t){var n;n=function(){switch(e.toUpperCase()){case"CA":return/^[\d\w]{6}$/.test(t!=null?t.replace(/\s+/g,""):void 0);case"US":return/^\d{5}$/.test(t)||/^\d{9}$/.test(t)}}();if(!n)return"Not a valid zip"},bankAccountNumber:function(e,t){if(!/^\d{1,17}$/.test(t))return"Invalid bank account number"},usRoutingNumber:function(e){var t,n,r,i,s,o,u;if(!/^\d{9}$/.test(e))return"Routing number must have 9 digits";s=0;for(t=o=0,u=e.length-1;o<=u;t=o+=3)n=parseInt(e.charAt(t),10)*3,r=parseInt(e.charAt(t+1),10)*7,i=parseInt(e.charAt(t+2),10),s+=n+r+i;if(s===0||s%10!==0)return"Invalid routing number"},caRoutingNumber:function(e){if(!/^\d{5}\-\d{3}$/.test(e))return"Invalid transit number"},routingNumber:function(e,t){switch(e.toUpperCase()){case"CA":return this.caRoutingNumber(t);case"US":return this.usRoutingNumber(t)}},phoneNumber:function(e,t){var n;n=t.replace(/[^0-9]/g,"");if(n.length!==10)return"Invalid phone number"},bizDBA:function(e,t){if(!/^.{1,23}$/.test(t))return"Statement descriptors can only have up to 23 characters"},nameLength:function(e,t){if(t.length===1)return"Names need to be longer than one character"}}}.call(this);/*!
 * @overview RSVP - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/tildeio/rsvp.js/master/LICENSE
 * @version   3.0.13
 */
(function(){"use strict";function $$rsvp$events$$indexOf(callbacks,callback){for(var i=0,l=callbacks.length;i<l;i++){if(callbacks[i]===callback){return i}}return-1}function $$rsvp$events$$callbacksFor(object){var callbacks=object._promiseCallbacks;if(!callbacks){callbacks=object._promiseCallbacks={}}return callbacks}var $$rsvp$events$$default={mixin:function(object){object.on=this.on;object.off=this.off;object.trigger=this.trigger;object._promiseCallbacks=undefined;return object},on:function(eventName,callback){var allCallbacks=$$rsvp$events$$callbacksFor(this),callbacks;callbacks=allCallbacks[eventName];if(!callbacks){callbacks=allCallbacks[eventName]=[]}if($$rsvp$events$$indexOf(callbacks,callback)===-1){callbacks.push(callback)}},off:function(eventName,callback){var allCallbacks=$$rsvp$events$$callbacksFor(this),callbacks,index;if(!callback){allCallbacks[eventName]=[];return}callbacks=allCallbacks[eventName];index=$$rsvp$events$$indexOf(callbacks,callback);if(index!==-1){callbacks.splice(index,1)}},trigger:function(eventName,options){var allCallbacks=$$rsvp$events$$callbacksFor(this),callbacks,callback;if(callbacks=allCallbacks[eventName]){for(var i=0;i<callbacks.length;i++){callback=callbacks[i];callback(options)}}}};var $$rsvp$config$$config={instrument:false};$$rsvp$events$$default.mixin($$rsvp$config$$config);function $$rsvp$config$$configure(name,value){if(name==="onerror"){$$rsvp$config$$config.on("error",value);return}if(arguments.length===2){$$rsvp$config$$config[name]=value}else{return $$rsvp$config$$config[name]}}function $$utils$$objectOrFunction(x){return typeof x==="function"||typeof x==="object"&&x!==null}function $$utils$$isFunction(x){return typeof x==="function"}function $$utils$$isMaybeThenable(x){return typeof x==="object"&&x!==null}var $$utils$$_isArray;if(!Array.isArray){$$utils$$_isArray=function(x){return Object.prototype.toString.call(x)==="[object Array]"}}else{$$utils$$_isArray=Array.isArray}var $$utils$$isArray=$$utils$$_isArray;var $$utils$$now=Date.now||function(){return(new Date).getTime()};function $$utils$$F(){}var $$utils$$o_create=Object.create||function(o){if(arguments.length>1){throw new Error("Second argument not supported")}if(typeof o!=="object"){throw new TypeError("Argument must be an object")}$$utils$$F.prototype=o;return new $$utils$$F};var $$instrument$$queue=[];var $$instrument$$default=function instrument(eventName,promise,child){if(1===$$instrument$$queue.push({name:eventName,payload:{guid:promise._guidKey+promise._id,eventName:eventName,detail:promise._result,childGuid:child&&promise._guidKey+child._id,label:promise._label,timeStamp:$$utils$$now(),stack:new Error(promise._label).stack}})){setTimeout(function(){var entry;for(var i=0;i<$$instrument$$queue.length;i++){entry=$$instrument$$queue[i];$$rsvp$config$$config.trigger(entry.name,entry.payload)}$$instrument$$queue.length=0},50)}};function $$$internal$$noop(){}var $$$internal$$PENDING=void 0;var $$$internal$$FULFILLED=1;var $$$internal$$REJECTED=2;var $$$internal$$GET_THEN_ERROR=new $$$internal$$ErrorObject;function $$$internal$$getThen(promise){try{return promise.then}catch(error){$$$internal$$GET_THEN_ERROR.error=error;return $$$internal$$GET_THEN_ERROR}}function $$$internal$$tryThen(then,value,fulfillmentHandler,rejectionHandler){try{then.call(value,fulfillmentHandler,rejectionHandler)}catch(e){return e}}function $$$internal$$handleForeignThenable(promise,thenable,then){$$rsvp$config$$config.async(function(promise){var sealed=false;var error=$$$internal$$tryThen(then,thenable,function(value){if(sealed){return}sealed=true;if(thenable!==value){$$$internal$$resolve(promise,value)}else{$$$internal$$fulfill(promise,value)}},function(reason){if(sealed){return}sealed=true;$$$internal$$reject(promise,reason)},"Settle: "+(promise._label||" unknown promise"));if(!sealed&&error){sealed=true;$$$internal$$reject(promise,error)}},promise)}function $$$internal$$handleOwnThenable(promise,thenable){if(thenable._state===$$$internal$$FULFILLED){$$$internal$$fulfill(promise,thenable._result)}else if(promise._state===$$$internal$$REJECTED){$$$internal$$reject(promise,thenable._result)}else{$$$internal$$subscribe(thenable,undefined,function(value){if(thenable!==value){$$$internal$$resolve(promise,value)}else{$$$internal$$fulfill(promise,value)}},function(reason){$$$internal$$reject(promise,reason)})}}function $$$internal$$handleMaybeThenable(promise,maybeThenable){if(maybeThenable.constructor===promise.constructor){$$$internal$$handleOwnThenable(promise,maybeThenable)}else{var then=$$$internal$$getThen(maybeThenable);if(then===$$$internal$$GET_THEN_ERROR){$$$internal$$reject(promise,$$$internal$$GET_THEN_ERROR.error)}else if(then===undefined){$$$internal$$fulfill(promise,maybeThenable)}else if($$utils$$isFunction(then)){$$$internal$$handleForeignThenable(promise,maybeThenable,then)}else{$$$internal$$fulfill(promise,maybeThenable)}}}function $$$internal$$resolve(promise,value){if(promise===value){$$$internal$$fulfill(promise,value)}else if($$utils$$objectOrFunction(value)){$$$internal$$handleMaybeThenable(promise,value)}else{$$$internal$$fulfill(promise,value)}}function $$$internal$$publishRejection(promise){if(promise._onerror){promise._onerror(promise._result)}$$$internal$$publish(promise)}function $$$internal$$fulfill(promise,value){if(promise._state!==$$$internal$$PENDING){return}promise._result=value;promise._state=$$$internal$$FULFILLED;if(promise._subscribers.length===0){if($$rsvp$config$$config.instrument){$$instrument$$default("fulfilled",promise)}}else{$$rsvp$config$$config.async($$$internal$$publish,promise)}}function $$$internal$$reject(promise,reason){if(promise._state!==$$$internal$$PENDING){return}promise._state=$$$internal$$REJECTED;promise._result=reason;$$rsvp$config$$config.async($$$internal$$publishRejection,promise)}function $$$internal$$subscribe(parent,child,onFulfillment,onRejection){var subscribers=parent._subscribers;var length=subscribers.length;parent._onerror=null;subscribers[length]=child;subscribers[length+$$$internal$$FULFILLED]=onFulfillment;subscribers[length+$$$internal$$REJECTED]=onRejection;if(length===0&&parent._state){$$rsvp$config$$config.async($$$internal$$publish,parent)}}function $$$internal$$publish(promise){var subscribers=promise._subscribers;var settled=promise._state;if($$rsvp$config$$config.instrument){$$instrument$$default(settled===$$$internal$$FULFILLED?"fulfilled":"rejected",promise)}if(subscribers.length===0){return}var child,callback,detail=promise._result;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];if(child){$$$internal$$invokeCallback(settled,child,callback,detail)}else{callback(detail)}}promise._subscribers.length=0}function $$$internal$$ErrorObject(){this.error=null}var $$$internal$$TRY_CATCH_ERROR=new $$$internal$$ErrorObject;function $$$internal$$tryCatch(callback,detail){try{return callback(detail)}catch(e){$$$internal$$TRY_CATCH_ERROR.error=e;return $$$internal$$TRY_CATCH_ERROR}}function $$$internal$$invokeCallback(settled,promise,callback,detail){var hasCallback=$$utils$$isFunction(callback),value,error,succeeded,failed;if(hasCallback){value=$$$internal$$tryCatch(callback,detail);if(value===$$$internal$$TRY_CATCH_ERROR){failed=true;error=value.error;value=null}else{succeeded=true}if(promise===value){$$$internal$$reject(promise,new TypeError("A promises callback cannot return that same promise."));return}}else{value=detail;succeeded=true}if(promise._state!==$$$internal$$PENDING){}else if(hasCallback&&succeeded){$$$internal$$resolve(promise,value)}else if(failed){$$$internal$$reject(promise,error)}else if(settled===$$$internal$$FULFILLED){$$$internal$$fulfill(promise,value)}else if(settled===$$$internal$$REJECTED){$$$internal$$reject(promise,value)}}function $$$internal$$initializePromise(promise,resolver){try{resolver(function resolvePromise(value){$$$internal$$resolve(promise,value)},function rejectPromise(reason){$$$internal$$reject(promise,reason)})}catch(e){$$$internal$$reject(promise,e)}}function $$enumerator$$makeSettledResult(state,position,value){if(state===$$$internal$$FULFILLED){return{state:"fulfilled",value:value}}else{return{state:"rejected",reason:value}}}function $$enumerator$$Enumerator(Constructor,input,abortOnReject,label){this._instanceConstructor=Constructor;this.promise=new Constructor($$$internal$$noop,label);this._abortOnReject=abortOnReject;if(this._validateInput(input)){this._input=input;this.length=input.length;this._remaining=input.length;this._init();if(this.length===0){$$$internal$$fulfill(this.promise,this._result)}else{this.length=this.length||0;this._enumerate();if(this._remaining===0){$$$internal$$fulfill(this.promise,this._result)}}}else{$$$internal$$reject(this.promise,this._validationError())}}$$enumerator$$Enumerator.prototype._validateInput=function(input){return $$utils$$isArray(input)};$$enumerator$$Enumerator.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")};$$enumerator$$Enumerator.prototype._init=function(){this._result=new Array(this.length)};var $$enumerator$$default=$$enumerator$$Enumerator;$$enumerator$$Enumerator.prototype._enumerate=function(){var length=this.length;var promise=this.promise;var input=this._input;for(var i=0;promise._state===$$$internal$$PENDING&&i<length;i++){this._eachEntry(input[i],i)}};$$enumerator$$Enumerator.prototype._eachEntry=function(entry,i){var c=this._instanceConstructor;if($$utils$$isMaybeThenable(entry)){if(entry.constructor===c&&entry._state!==$$$internal$$PENDING){entry._onerror=null;this._settledAt(entry._state,i,entry._result)}else{this._willSettleAt(c.resolve(entry),i)}}else{this._remaining--;this._result[i]=this._makeResult($$$internal$$FULFILLED,i,entry)}};$$enumerator$$Enumerator.prototype._settledAt=function(state,i,value){var promise=this.promise;if(promise._state===$$$internal$$PENDING){this._remaining--;if(this._abortOnReject&&state===$$$internal$$REJECTED){$$$internal$$reject(promise,value)}else{this._result[i]=this._makeResult(state,i,value)}}if(this._remaining===0){$$$internal$$fulfill(promise,this._result)}};$$enumerator$$Enumerator.prototype._makeResult=function(state,i,value){return value};$$enumerator$$Enumerator.prototype._willSettleAt=function(promise,i){var enumerator=this;$$$internal$$subscribe(promise,undefined,function(value){enumerator._settledAt($$$internal$$FULFILLED,i,value)},function(reason){enumerator._settledAt($$$internal$$REJECTED,i,reason)})};var $$promise$all$$default=function all(entries,label){return new $$enumerator$$default(this,entries,true,label).promise};var $$promise$race$$default=function race(entries,label){var Constructor=this;var promise=new Constructor($$$internal$$noop,label);if(!$$utils$$isArray(entries)){$$$internal$$reject(promise,new TypeError("You must pass an array to race."));return promise}var length=entries.length;function onFulfillment(value){$$$internal$$resolve(promise,value)}function onRejection(reason){$$$internal$$reject(promise,reason)}for(var i=0;promise._state===$$$internal$$PENDING&&i<length;i++){$$$internal$$subscribe(Constructor.resolve(entries[i]),undefined,onFulfillment,onRejection)}return promise};var $$promise$resolve$$default=function resolve(object,label){var Constructor=this;if(object&&typeof object==="object"&&object.constructor===Constructor){return object}var promise=new Constructor($$$internal$$noop,label);$$$internal$$resolve(promise,object);return promise};var $$promise$reject$$default=function reject(reason,label){var Constructor=this;var promise=new Constructor($$$internal$$noop,label);$$$internal$$reject(promise,reason);return promise};var $$rsvp$promise$$guidKey="rsvp_"+$$utils$$now()+"-";var $$rsvp$promise$$counter=0;function $$rsvp$promise$$needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function $$rsvp$promise$$needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}var $$rsvp$promise$$default=$$rsvp$promise$$Promise;function $$rsvp$promise$$Promise(resolver,label){this._id=$$rsvp$promise$$counter++;this._label=label;this._state=undefined;this._result=undefined;this._subscribers=[];if($$rsvp$config$$config.instrument){$$instrument$$default("created",this)}if($$$internal$$noop!==resolver){if(!$$utils$$isFunction(resolver)){$$rsvp$promise$$needsResolver()}if(!(this instanceof $$rsvp$promise$$Promise)){$$rsvp$promise$$needsNew()}$$$internal$$initializePromise(this,resolver)}}$$rsvp$promise$$Promise.cast=$$promise$resolve$$default;$$rsvp$promise$$Promise.all=$$promise$all$$default;$$rsvp$promise$$Promise.race=$$promise$race$$default;$$rsvp$promise$$Promise.resolve=$$promise$resolve$$default;$$rsvp$promise$$Promise.reject=$$promise$reject$$default;$$rsvp$promise$$Promise.prototype={constructor:$$rsvp$promise$$Promise,_guidKey:$$rsvp$promise$$guidKey,_onerror:function(reason){$$rsvp$config$$config.trigger("error",reason)},then:function(onFulfillment,onRejection,label){var parent=this;var state=parent._state;if(state===$$$internal$$FULFILLED&&!onFulfillment||state===$$$internal$$REJECTED&&!onRejection){if($$rsvp$config$$config.instrument){$$instrument$$default("chained",this,this)}return this}parent._onerror=null;var child=new this.constructor($$$internal$$noop,label);var result=parent._result;if($$rsvp$config$$config.instrument){$$instrument$$default("chained",parent,child)}if(state){var callback=arguments[state-1];$$rsvp$config$$config.async(function(){$$$internal$$invokeCallback(state,child,callback,result)})}else{$$$internal$$subscribe(parent,child,onFulfillment,onRejection)}return child},"catch":function(onRejection,label){return this.then(null,onRejection,label)},"finally":function(callback,label){var constructor=this.constructor;return this.then(function(value){return constructor.resolve(callback()).then(function(){return value})},function(reason){return constructor.resolve(callback()).then(function(){throw reason})},label)}};function $$rsvp$node$$Result(){this.value=undefined}var $$rsvp$node$$ERROR=new $$rsvp$node$$Result;var $$rsvp$node$$GET_THEN_ERROR=new $$rsvp$node$$Result;function $$rsvp$node$$getThen(obj){try{return obj.then}catch(error){$$rsvp$node$$ERROR.value=error;return $$rsvp$node$$ERROR}}function $$rsvp$node$$tryApply(f,s,a){try{f.apply(s,a)}catch(error){$$rsvp$node$$ERROR.value=error;return $$rsvp$node$$ERROR}}function $$rsvp$node$$makeObject(_,argumentNames){var obj={};var name;var i;var length=_.length;var args=new Array(length);for(var x=0;x<length;x++){args[x]=_[x]}for(i=0;i<argumentNames.length;i++){name=argumentNames[i];obj[name]=args[i+1]}return obj}function $$rsvp$node$$arrayResult(_){var length=_.length;var args=new Array(length-1);for(var i=1;i<length;i++){args[i-1]=_[i]}return args}function $$rsvp$node$$wrapThenable(then,promise){return{then:function(onFulFillment,onRejection){return then.call(promise,onFulFillment,onRejection)}}}var $$rsvp$node$$default=function denodeify(nodeFunc,options){var fn=function(){var self=this;var l=arguments.length;var args=new Array(l+1);var arg;var promiseInput=false;for(var i=0;i<l;++i){arg=arguments[i];if(!promiseInput){promiseInput=$$rsvp$node$$needsPromiseInput(arg);if(promiseInput===$$rsvp$node$$GET_THEN_ERROR){var p=new $$rsvp$promise$$default($$$internal$$noop);$$$internal$$reject(p,$$rsvp$node$$GET_THEN_ERROR.value);return p}else if(promiseInput&&promiseInput!==true){arg=$$rsvp$node$$wrapThenable(promiseInput,arg)}}args[i]=arg}var promise=new $$rsvp$promise$$default($$$internal$$noop);args[l]=function(err,val){if(err)$$$internal$$reject(promise,err);else if(options===undefined)$$$internal$$resolve(promise,val);else if(options===true)$$$internal$$resolve(promise,$$rsvp$node$$arrayResult(arguments));else if($$utils$$isArray(options))$$$internal$$resolve(promise,$$rsvp$node$$makeObject(arguments,options));else $$$internal$$resolve(promise,val)};if(promiseInput){return $$rsvp$node$$handlePromiseInput(promise,args,nodeFunc,self)}else{return $$rsvp$node$$handleValueInput(promise,args,nodeFunc,self)}};fn.__proto__=nodeFunc;return fn};function $$rsvp$node$$handleValueInput(promise,args,nodeFunc,self){var result=$$rsvp$node$$tryApply(nodeFunc,self,args);if(result===$$rsvp$node$$ERROR){$$$internal$$reject(promise,result.value)}return promise}function $$rsvp$node$$handlePromiseInput(promise,args,nodeFunc,self){return $$rsvp$promise$$default.all(args).then(function(args){var result=$$rsvp$node$$tryApply(nodeFunc,self,args);if(result===$$rsvp$node$$ERROR){$$$internal$$reject(promise,result.value)}return promise})}function $$rsvp$node$$needsPromiseInput(arg){if(arg&&typeof arg==="object"){if(arg.constructor===$$rsvp$promise$$default){return true}else{return $$rsvp$node$$getThen(arg)}}else{return false}}var $$rsvp$all$$default=function all(array,label){return $$rsvp$promise$$default.all(array,label)};function $$rsvp$all$settled$$AllSettled(Constructor,entries,label){this._superConstructor(Constructor,entries,false,label)}$$rsvp$all$settled$$AllSettled.prototype=$$utils$$o_create($$enumerator$$default.prototype);$$rsvp$all$settled$$AllSettled.prototype._superConstructor=$$enumerator$$default;$$rsvp$all$settled$$AllSettled.prototype._makeResult=$$enumerator$$makeSettledResult;$$rsvp$all$settled$$AllSettled.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var $$rsvp$all$settled$$default=function allSettled(entries,label){return new $$rsvp$all$settled$$AllSettled($$rsvp$promise$$default,entries,label).promise};var $$rsvp$race$$default=function race(array,label){return $$rsvp$promise$$default.race(array,label)};function $$promise$hash$$PromiseHash(Constructor,object,label){this._superConstructor(Constructor,object,true,label)}var $$promise$hash$$default=$$promise$hash$$PromiseHash;$$promise$hash$$PromiseHash.prototype=$$utils$$o_create($$enumerator$$default.prototype);$$promise$hash$$PromiseHash.prototype._superConstructor=$$enumerator$$default;$$promise$hash$$PromiseHash.prototype._init=function(){this._result={}};$$promise$hash$$PromiseHash.prototype._validateInput=function(input){return input&&typeof input==="object"};$$promise$hash$$PromiseHash.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")};$$promise$hash$$PromiseHash.prototype._enumerate=function(){var promise=this.promise;var input=this._input;var results=[];for(var key in input){if(promise._state===$$$internal$$PENDING&&input.hasOwnProperty(key)){results.push({position:key,entry:input[key]})}}var length=results.length;this._remaining=length;var result;for(var i=0;promise._state===$$$internal$$PENDING&&i<length;i++){result=results[i];this._eachEntry(result.entry,result.position)}};var $$rsvp$hash$$default=function hash(object,label){return new $$promise$hash$$default($$rsvp$promise$$default,object,label).promise};function $$rsvp$hash$settled$$HashSettled(Constructor,object,label){this._superConstructor(Constructor,object,false,label)}$$rsvp$hash$settled$$HashSettled.prototype=$$utils$$o_create($$promise$hash$$default.prototype);$$rsvp$hash$settled$$HashSettled.prototype._superConstructor=$$enumerator$$default;$$rsvp$hash$settled$$HashSettled.prototype._makeResult=$$enumerator$$makeSettledResult;$$rsvp$hash$settled$$HashSettled.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var $$rsvp$hash$settled$$default=function hashSettled(object,label){return new $$rsvp$hash$settled$$HashSettled($$rsvp$promise$$default,object,label).promise};var $$rsvp$rethrow$$default=function rethrow(reason){setTimeout(function(){throw reason});throw reason};var $$rsvp$defer$$default=function defer(label){var deferred={};deferred.promise=new $$rsvp$promise$$default(function(resolve,reject){deferred.resolve=resolve;deferred.reject=reject},label);return deferred};var $$rsvp$map$$default=function map(promises,mapFn,label){return $$rsvp$promise$$default.all(promises,label).then(function(values){if(!$$utils$$isFunction(mapFn)){throw new TypeError("You must pass a function as map's second argument.")}var length=values.length;var results=new Array(length);for(var i=0;i<length;i++){results[i]=mapFn(values[i])}return $$rsvp$promise$$default.all(results,label)})};var $$rsvp$resolve$$default=function resolve(value,label){return $$rsvp$promise$$default.resolve(value,label)};var $$rsvp$reject$$default=function reject(reason,label){return $$rsvp$promise$$default.reject(reason,label)};var $$rsvp$filter$$default=function filter(promises,filterFn,label){return $$rsvp$promise$$default.all(promises,label).then(function(values){if(!$$utils$$isFunction(filterFn)){throw new TypeError("You must pass a function as filter's second argument.")}var length=values.length;var filtered=new Array(length);for(var i=0;i<length;i++){filtered[i]=filterFn(values[i])}return $$rsvp$promise$$default.all(filtered,label).then(function(filtered){var results=new Array(length);var newLength=0;for(var i=0;i<length;i++){if(filtered[i]){results[newLength]=values[i];newLength++}}results.length=newLength;return results})})};var $$rsvp$asap$$len=0;var $$rsvp$asap$$default=function asap(callback,arg){$$rsvp$asap$$queue[$$rsvp$asap$$len]=callback;$$rsvp$asap$$queue[$$rsvp$asap$$len+1]=arg;$$rsvp$asap$$len+=2;if($$rsvp$asap$$len===2){$$rsvp$asap$$scheduleFlush()}};var $$rsvp$asap$$browserGlobal=typeof window!=="undefined"?window:{};var $$rsvp$asap$$BrowserMutationObserver=$$rsvp$asap$$browserGlobal.MutationObserver||$$rsvp$asap$$browserGlobal.WebKitMutationObserver;var $$rsvp$asap$$isWorker=typeof Uint8ClampedArray!=="undefined"&&typeof importScripts!=="undefined"&&typeof MessageChannel!=="undefined";function $$rsvp$asap$$useNextTick(){return function(){process.nextTick($$rsvp$asap$$flush)}}function $$rsvp$asap$$useMutationObserver(){var iterations=0;var observer=new $$rsvp$asap$$BrowserMutationObserver($$rsvp$asap$$flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function $$rsvp$asap$$useMessageChannel(){var channel=new MessageChannel;channel.port1.onmessage=$$rsvp$asap$$flush;return function(){channel.port2.postMessage(0)}}function $$rsvp$asap$$useSetTimeout(){return function(){setTimeout($$rsvp$asap$$flush,1)}}var $$rsvp$asap$$queue=new Array(1e3);function $$rsvp$asap$$flush(){for(var i=0;i<$$rsvp$asap$$len;i+=2){var callback=$$rsvp$asap$$queue[i];var arg=$$rsvp$asap$$queue[i+1];callback(arg);$$rsvp$asap$$queue[i]=undefined;$$rsvp$asap$$queue[i+1]=undefined}$$rsvp$asap$$len=0}var $$rsvp$asap$$scheduleFlush;if(typeof process!=="undefined"&&{}.toString.call(process)==="[object process]"){$$rsvp$asap$$scheduleFlush=$$rsvp$asap$$useNextTick()}else if($$rsvp$asap$$BrowserMutationObserver){$$rsvp$asap$$scheduleFlush=$$rsvp$asap$$useMutationObserver()}else if($$rsvp$asap$$isWorker){$$rsvp$asap$$scheduleFlush=$$rsvp$asap$$useMessageChannel()}else{$$rsvp$asap$$scheduleFlush=$$rsvp$asap$$useSetTimeout()}$$rsvp$config$$config.async=$$rsvp$asap$$default;var $$rsvp$$cast=$$rsvp$resolve$$default;function $$rsvp$$async(callback,arg){$$rsvp$config$$config.async(callback,arg)}function $$rsvp$$on(){$$rsvp$config$$config.on.apply($$rsvp$config$$config,arguments)}function $$rsvp$$off(){$$rsvp$config$$config.off.apply($$rsvp$config$$config,arguments)}if(typeof window!=="undefined"&&typeof window["__PROMISE_INSTRUMENTATION__"]==="object"){var $$rsvp$$callbacks=window["__PROMISE_INSTRUMENTATION__"];$$rsvp$config$$configure("instrument",true);for(var $$rsvp$$eventName in $$rsvp$$callbacks){if($$rsvp$$callbacks.hasOwnProperty($$rsvp$$eventName)){$$rsvp$$on($$rsvp$$eventName,$$rsvp$$callbacks[$$rsvp$$eventName])}}}var rsvp$umd$$RSVP={race:$$rsvp$race$$default,Promise:$$rsvp$promise$$default,allSettled:$$rsvp$all$settled$$default,hash:$$rsvp$hash$$default,hashSettled:$$rsvp$hash$settled$$default,denodeify:$$rsvp$node$$default,on:$$rsvp$$on,off:$$rsvp$$off,map:$$rsvp$map$$default,filter:$$rsvp$filter$$default,resolve:$$rsvp$resolve$$default,reject:$$rsvp$reject$$default,all:$$rsvp$all$$default,rethrow:$$rsvp$rethrow$$default,defer:$$rsvp$defer$$default,EventTarget:$$rsvp$events$$default,configure:$$rsvp$config$$configure,async:$$rsvp$$async};if(typeof define==="function"&&define.amd){define(function(){return rsvp$umd$$RSVP})}else if(typeof module!=="undefined"&&module.exports){module.exports=rsvp$umd$$RSVP}else if(typeof this!=="undefined"){this["RSVP"]=rsvp$umd$$RSVP}}).call(this);(function(){var c=void 0,n=!0,s=null,C=!1,J=["aliceblue,antiquewhite,aqua,aquamarine,azure,beige,bisque,black,blanchedalmond,blue,blueviolet,brown,burlywood,cadetblue,chartreuse,chocolate,coral,cornflowerblue,cornsilk,crimson,cyan,darkblue,darkcyan,darkgoldenrod,darkgray,darkgreen,darkkhaki,darkmagenta,darkolivegreen,darkorange,darkorchid,darkred,darksalmon,darkseagreen,darkslateblue,darkslategray,darkturquoise,darkviolet,deeppink,deepskyblue,dimgray,dodgerblue,firebrick,floralwhite,forestgreen,fuchsia,gainsboro,ghostwhite,gold,goldenrod,gray,green,greenyellow,honeydew,hotpink,indianred,indigo,ivory,khaki,lavender,lavenderblush,lawngreen,lemonchiffon,lightblue,lightcoral,lightcyan,lightgoldenrodyellow,lightgreen,lightgrey,lightpink,lightsalmon,lightseagreen,lightskyblue,lightslategray,lightsteelblue,lightyellow,lime,limegreen,linen,magenta,maroon,mediumaquamarine,mediumblue,mediumorchid,mediumpurple,mediumseagreen,mediumslateblue,mediumspringgreen,mediumturquoise,mediumvioletred,midnightblue,mintcream,mistyrose,moccasin,navajowhite,navy,oldlace,olive,olivedrab,orange,orangered,orchid,palegoldenrod,palegreen,paleturquoise,palevioletred,papayawhip,peachpuff,peru,pink,plum,powderblue,purple,red,rosybrown,royalblue,saddlebrown,salmon,sandybrown,seagreen,seashell,sienna,silver,skyblue,slateblue,slategray,snow,springgreen,steelblue,tan,teal,thistle,tomato,transparent,turquoise,violet,wheat,white,whitesmoke,yellow,yellowgreen".split(","),"all-scroll,col-resize,crosshair,default,e-resize,hand,help,move,n-resize,ne-resize,no-drop,not-allowed,nw-resize,pointer,progress,row-resize,s-resize,se-resize,sw-resize,text,vertical-text,w-resize,wait".split(","),"armenian,decimal,decimal-leading-zero,disc,georgian,lower-alpha,lower-greek,lower-latin,lower-roman,square,upper-alpha,upper-latin,upper-roman".split(","),"100,200,300,400,500,600,700,800,900,bold,bolder,lighter".split(","),"block-level,inline-level,table-caption,table-cell,table-column,table-column-group,table-footer-group,table-header-group,table-row,table-row-group".split(","),"condensed,expanded,extra-condensed,extra-expanded,narrower,semi-condensed,semi-expanded,ultra-condensed,ultra-expanded,wider".split(","),"inherit,inline,inline-block,inline-box,inline-flex,inline-grid,inline-list-item,inline-stack,inline-table,run-in".split(","),"behind,center-left,center-right,far-left,far-right,left-side,leftwards,right-side,rightwards".split(","),"large,larger,small,smaller,x-large,x-small,xx-large,xx-small".split(","),"dashed,dotted,double,groove,outset,ridge,solid".split(","),"ease,ease-in,ease-in-out,ease-out,linear,step-end,step-start".split(","),"at,closest-corner,closest-side,ellipse,farthest-corner,farthest-side".split(","),"baseline,middle,sub,super,text-bottom,text-top".split(","),"caption,icon,menu,message-box,small-caption,status-bar".split(","),"fast,faster,slow,slower,x-fast,x-slow".split(","),["above","below","higher","level","lower"],["cursive","fantasy","monospace","sans-serif","serif"],["loud","silent","soft","x-loud","x-soft"],["no-repeat","repeat-x","repeat-y","round","space"],["blink","line-through","overline","underline"],["block","flex","grid","table"],["high","low","x-high","x-low"],["nowrap","pre","pre-line","pre-wrap"],["absolute","relative","static"],["alternate","alternate-reverse","reverse"],["border-box","content-box","padding-box"],["capitalize","lowercase","uppercase"],["child","female","male"],["=","opacity"],["backwards","forwards"],["bidi-override","embed"],["bottom","top"],["break-all","keep-all"],["clip","ellipsis"],["contain","cover"],["continuous","digits"],["end","start"],["flat","preserve-3d"],["hide","show"],["horizontal","vertical"],["inside","outside"],["italic","oblique"],["left","right"],["ltr","rtl"],["no-content","no-display"],["paused","running"],["suppress","unrestricted"],["thick","thin"],[","],["/"],["all"],["always"],["auto"],["avoid"],["both"],["break-word"],["center"],["circle"],["code"],["collapse"],["contents"],["fixed"],["hidden"],["infinite"],["inset"],["invert"],["justify"],["list-item"],["local"],["medium"],["mix"],["none"],["normal"],["once"],["repeat"],["scroll"],["separate"],["small-caps"],["spell-out"],["to"],["visible"]],L={animation:{cssPropBits:517,cssLitGroup:[J[10],J[24],J[29],J[45],J[48],J[54],J[63],J[71],J[72]],cssFns:["cubic-bezier()","steps()"]},"animation-delay":{cssPropBits:5,cssLitGroup:[J[48]],cssFns:[]},"animation-direction":{cssPropBits:0,cssLitGroup:[J[24],J[48],J[72]],cssFns:[]},"animation-duration":"animation-delay","animation-fill-mode":{cssPropBits:0,cssLitGroup:[J[29],J[48],J[54],J[71]],cssFns:[]},"animation-iteration-count":{cssPropBits:5,cssLitGroup:[J[48],J[63]],cssFns:[]},"animation-name":{cssPropBits:512,cssLitGroup:[J[48],J[71]],cssFns:[]},"animation-play-state":{cssPropBits:0,cssLitGroup:[J[45],J[48]],cssFns:[]},"animation-timing-function":{cssPropBits:0,cssLitGroup:[J[10],J[48]],cssFns:["cubic-bezier()","steps()"]},appearance:{cssPropBits:0,cssLitGroup:[J[71]],cssFns:[]},azimuth:{cssPropBits:5,cssLitGroup:[J[7],J[42],J[56]],cssFns:[]},"backface-visibility":{cssPropBits:0,cssLitGroup:[J[59],J[62],J[80]],cssFns:[]},background:{cssPropBits:23,cssLitGroup:[J[0],J[18],J[25],J[31],J[34],J[42],J[48],J[49],J[52],J[56],J[61],J[68],J[71],J[74],J[75]],cssFns:"image(),linear-gradient(),radial-gradient(),repeating-linear-gradient(),repeating-radial-gradient(),rgb(),rgba()".split(",")},"background-attachment":{cssPropBits:0,cssLitGroup:[J[48],J[61],J[68],J[75]],cssFns:[]},"background-color":{cssPropBits:2,cssLitGroup:[J[0]],cssFns:["rgb()","rgba()"]},"background-image":{cssPropBits:16,cssLitGroup:[J[48],J[71]],cssFns:["image()","linear-gradient()","radial-gradient()","repeating-linear-gradient()","repeating-radial-gradient()"]},"background-position":{cssPropBits:5,cssLitGroup:[J[31],J[42],J[48],J[56]],cssFns:[]},"background-repeat":{cssPropBits:0,cssLitGroup:[J[18],J[48],J[74]],cssFns:[]},"background-size":{cssPropBits:5,cssLitGroup:[J[34],J[48],J[52]],cssFns:[]},border:{cssPropBits:7,cssLitGroup:[J[0],J[9],J[47],J[62],J[64],J[69],J[71]],cssFns:["rgb()","rgba()"]},"border-bottom":"border","border-bottom-color":"background-color","border-bottom-left-radius":{cssPropBits:5,cssFns:[]},"border-bottom-right-radius":"border-bottom-left-radius","border-bottom-style":{cssPropBits:0,cssLitGroup:[J[9],J[62],J[64],J[71]],cssFns:[]},"border-bottom-width":{cssPropBits:5,cssLitGroup:[J[47],J[69]],cssFns:[]},"border-collapse":{cssPropBits:0,cssLitGroup:[J[59],J[76]],cssFns:[]},"border-color":"background-color","border-left":"border","border-left-color":"background-color","border-left-style":"border-bottom-style","border-left-width":"border-bottom-width","border-radius":{cssPropBits:5,cssLitGroup:[J[49]],cssFns:[]},"border-right":"border","border-right-color":"background-color","border-right-style":"border-bottom-style","border-right-width":"border-bottom-width","border-spacing":"border-bottom-left-radius","border-style":"border-bottom-style","border-top":"border","border-top-color":"background-color","border-top-left-radius":"border-bottom-left-radius","border-top-right-radius":"border-bottom-left-radius","border-top-style":"border-bottom-style","border-top-width":"border-bottom-width","border-width":"border-bottom-width",bottom:{cssPropBits:5,cssLitGroup:[J[52]],cssFns:[]},box:{cssPropBits:0,cssLitGroup:[J[60],J[71],J[72]],cssFns:[]},"box-shadow":{cssPropBits:7,cssLitGroup:[J[0],J[48],J[64],J[71]],cssFns:["rgb()","rgba()"]},"box-sizing":{cssPropBits:0,cssLitGroup:[J[25]],cssFns:[]},"caption-side":{cssPropBits:0,cssLitGroup:[J[31]],cssFns:[]},clear:{cssPropBits:0,cssLitGroup:[J[42],J[54],J[71]],cssFns:[]},clip:{cssPropBits:0,cssLitGroup:[J[52]],cssFns:["rect()"]},color:"background-color",content:{cssPropBits:8,cssLitGroup:[J[71],J[72]],cssFns:[]},cue:{cssPropBits:16,cssLitGroup:[J[71]],cssFns:[]},"cue-after":"cue","cue-before":"cue",cursor:{cssPropBits:16,cssLitGroup:[J[1],J[48],J[52]],cssFns:[]},direction:{cssPropBits:0,cssLitGroup:[J[43]],cssFns:[]},display:{cssPropBits:0,cssLitGroup:[J[4],J[6],J[20],J[52],J[67],J[71]],cssFns:[]},"display-extras":{cssPropBits:0,cssLitGroup:[J[67],J[71]],cssFns:[]},"display-inside":{cssPropBits:0,cssLitGroup:[J[20],J[52]],cssFns:[]},"display-outside":{cssPropBits:0,cssLitGroup:[J[4],J[71]],cssFns:[]},elevation:{cssPropBits:5,cssLitGroup:[J[15]],cssFns:[]},"empty-cells":{cssPropBits:0,cssLitGroup:[J[38]],cssFns:[]},filter:{cssPropBits:0,cssFns:["alpha()"]},"float":{cssPropBits:0,cssLitGroup:[J[42],J[71]],cssFns:[]},font:{cssPropBits:73,cssLitGroup:[J[3],J[8],J[13],J[16],J[41],J[48],J[49],J[69],J[72],J[77]],cssFns:[]},"font-family":{cssPropBits:72,cssLitGroup:[J[16],J[48]],cssFns:[]},"font-size":{cssPropBits:1,cssLitGroup:[J[8],J[69]],cssFns:[]},"font-stretch":{cssPropBits:0,cssLitGroup:[J[5],J[72]],cssFns:[]},"font-style":{cssPropBits:0,cssLitGroup:[J[41],J[72]],cssFns:[]},"font-variant":{cssPropBits:0,cssLitGroup:[J[72],J[77]],cssFns:[]},"font-weight":{cssPropBits:0,cssLitGroup:[J[3],J[72]],cssFns:[]},height:"bottom",left:"bottom","letter-spacing":{cssPropBits:5,cssLitGroup:[J[72]],cssFns:[]},"line-height":{cssPropBits:1,cssLitGroup:[J[72]],cssFns:[]},"list-style":{cssPropBits:16,cssLitGroup:[J[2],J[40],J[57],J[71]],cssFns:["image()","linear-gradient()","radial-gradient()","repeating-linear-gradient()","repeating-radial-gradient()"]},"list-style-image":{cssPropBits:16,cssLitGroup:[J[71]],cssFns:["image()","linear-gradient()","radial-gradient()","repeating-linear-gradient()","repeating-radial-gradient()"]},"list-style-position":{cssPropBits:0,cssLitGroup:[J[40]],cssFns:[]},"list-style-type":{cssPropBits:0,cssLitGroup:[J[2],J[57],J[71]],cssFns:[]},margin:"bottom","margin-bottom":"bottom","margin-left":"bottom","margin-right":"bottom","margin-top":"bottom","max-height":{cssPropBits:1,cssLitGroup:[J[52],J[71]],cssFns:[]},"max-width":"max-height","min-height":{cssPropBits:1,cssLitGroup:[J[52]],cssFns:[]},"min-width":"min-height",opacity:{cssPropBits:1,cssFns:[]},outline:{cssPropBits:7,cssLitGroup:[J[0],J[9],J[47],J[62],J[64],J[65],J[69],J[71]],cssFns:["rgb()","rgba()"]},"outline-color":{cssPropBits:2,cssLitGroup:[J[0],J[65]],cssFns:["rgb()","rgba()"]},"outline-style":"border-bottom-style","outline-width":"border-bottom-width",overflow:{cssPropBits:0,cssLitGroup:[J[52],J[62],J[75],J[80]],cssFns:[]},"overflow-wrap":{cssPropBits:0,cssLitGroup:[J[55],J[72]],cssFns:[]},"overflow-x":{cssPropBits:0,cssLitGroup:[J[44],J[52],J[62],J[75],J[80]],cssFns:[]},"overflow-y":"overflow-x",padding:"opacity","padding-bottom":"opacity","padding-left":"opacity","padding-right":"opacity","padding-top":"opacity","page-break-after":{cssPropBits:0,cssLitGroup:[J[42],J[51],J[52],J[53]],cssFns:[]},"page-break-before":"page-break-after","page-break-inside":{cssPropBits:0,cssLitGroup:[J[52],J[53]],cssFns:[]},pause:"border-bottom-left-radius","pause-after":"border-bottom-left-radius","pause-before":"border-bottom-left-radius",perspective:{cssPropBits:5,cssLitGroup:[J[71]],cssFns:[]},"perspective-origin":{cssPropBits:5,cssLitGroup:[J[31],J[42],J[56]],cssFns:[]},pitch:{cssPropBits:5,cssLitGroup:[J[21],J[69]],cssFns:[]},"pitch-range":"border-bottom-left-radius","play-during":{cssPropBits:16,cssLitGroup:[J[52],J[70],J[71],J[74]],cssFns:[]},position:{cssPropBits:0,cssLitGroup:[J[23]],cssFns:[]},quotes:{cssPropBits:8,cssLitGroup:[J[71]],cssFns:[]},resize:{cssPropBits:0,cssLitGroup:[J[39],J[54],J[71]],cssFns:[]},richness:"border-bottom-left-radius",right:"bottom",speak:{cssPropBits:0,cssLitGroup:[J[71],J[72],J[78]],cssFns:[]},"speak-header":{cssPropBits:0,cssLitGroup:[J[51],J[73]],cssFns:[]},"speak-numeral":{cssPropBits:0,cssLitGroup:[J[35]],cssFns:[]},"speak-punctuation":{cssPropBits:0,cssLitGroup:[J[58],J[71]],cssFns:[]},"speech-rate":{cssPropBits:5,cssLitGroup:[J[14],J[69]],cssFns:[]},stress:"border-bottom-left-radius","table-layout":{cssPropBits:0,cssLitGroup:[J[52],J[61]],cssFns:[]},"text-align":{cssPropBits:0,cssLitGroup:[J[42],J[56],J[66]],cssFns:[]},"text-decoration":{cssPropBits:0,cssLitGroup:[J[19],J[71]],cssFns:[]},"text-indent":"border-bottom-left-radius","text-overflow":{cssPropBits:8,cssLitGroup:[J[33]],cssFns:[]},"text-shadow":"box-shadow","text-transform":{cssPropBits:0,cssLitGroup:[J[26],J[71]],cssFns:[]},"text-wrap":{cssPropBits:0,cssLitGroup:[J[46],J[71],J[72]],cssFns:[]},top:"bottom",transform:{cssPropBits:0,cssLitGroup:[J[71]],cssFns:"matrix(),perspective(),rotate(),rotate3d(),rotatex(),rotatey(),rotatez(),scale(),scale3d(),scalex(),scaley(),scalez(),skew(),skewx(),skewy(),translate(),translate3d(),translatex(),translatey(),translatez()".split(",")},"transform-origin":"perspective-origin","transform-style":{cssPropBits:0,cssLitGroup:[J[37]],cssFns:[]},transition:{cssPropBits:1029,cssLitGroup:[J[10],J[48],J[50],J[71]],cssFns:["cubic-bezier()","steps()"]},"transition-delay":"animation-delay","transition-duration":"animation-delay","transition-property":{cssPropBits:1024,cssLitGroup:[J[48],J[50]],cssFns:[]},"transition-timing-function":"animation-timing-function","unicode-bidi":{cssPropBits:0,cssLitGroup:[J[30],J[72]],cssFns:[]},"vertical-align":{cssPropBits:5,cssLitGroup:[J[12],J[31]],cssFns:[]},visibility:"backface-visibility","voice-family":{cssPropBits:8,cssLitGroup:[J[27],J[48]],cssFns:[]},volume:{cssPropBits:1,cssLitGroup:[J[17],J[69]],cssFns:[]},"white-space":{cssPropBits:0,cssLitGroup:[J[22],J[72]],cssFns:[]},width:"min-height","word-break":{cssPropBits:0,cssLitGroup:[J[32],J[72]],cssFns:[]},"word-spacing":"letter-spacing","word-wrap":"overflow-wrap","z-index":"bottom",zoom:"line-height","cubic-bezier()":"animation-delay","steps()":{cssPropBits:5,cssLitGroup:[J[36],J[48]],cssFns:[]},"image()":{cssPropBits:18,cssLitGroup:[J[0],J[48]],cssFns:["rgb()","rgba()"]},"linear-gradient()":{cssPropBits:7,cssLitGroup:[J[0],J[31],J[42],J[48],J[79]],cssFns:["rgb()","rgba()"]},"radial-gradient()":{cssPropBits:7,cssLitGroup:[J[0],J[11],J[31],J[42],J[48],J[56],J[57]],cssFns:["rgb()","rgba()"]},"repeating-linear-gradient()":"linear-gradient()","repeating-radial-gradient()":"radial-gradient()","rgb()":{cssPropBits:1,cssLitGroup:[J[48]],cssFns:[]},"rgba()":"rgb()","rect()":{cssPropBits:5,cssLitGroup:[J[48],J[52]],cssFns:[]},"alpha()":{cssPropBits:1,cssLitGroup:[J[28]],cssFns:[]},"matrix()":"animation-delay","perspective()":"border-bottom-left-radius","rotate()":"border-bottom-left-radius","rotate3d()":"animation-delay","rotatex()":"border-bottom-left-radius","rotatey()":"border-bottom-left-radius","rotatez()":"border-bottom-left-radius","scale()":"animation-delay","scale3d()":"animation-delay","scalex()":"border-bottom-left-radius","scaley()":"border-bottom-left-radius","scalez()":"border-bottom-left-radius","skew()":"animation-delay","skewx()":"border-bottom-left-radius","skewy()":"border-bottom-left-radius","translate()":"animation-delay","translate3d()":"animation-delay","translatex()":"border-bottom-left-radius","translatey()":"border-bottom-left-radius","translatez()":"border-bottom-left-radius"},O;
for(O in L)"string"===typeof L[O]&&Object.hasOwnProperty.call(L,O)&&(L[O]=L[L[O]]);"undefined"!==typeof window&&(window.cssSchema=L);var U,X;(function(){function g(a){var f=parseInt(a.substring(1),16);return 65535<f?(f-=65536,String.fromCharCode(55296+(f>>10),56320+(f&1023))):f==f?String.fromCharCode(f):" ">a[1]?"":a[1]}function w(a,f){return'"'+a.replace(/[\u0000-\u001f\\\"<>]/g,f)+'"'}function M(a){return E[a]||(E[a]="\\"+a.charCodeAt(0).toString(16)+" ")}function x(a){return e[a]||(e[a]=("">a?"%0":"%")+a.charCodeAt(0).toString(16))}var E={"\\":"\\\\"},e={"\\":"%5c"},v=RegExp("\\uFEFF|U[+][0-9A-F?]{1,6}(?:-[0-9A-F]{1,6})?|url[(][\\t\\n\\f ]*(?:\"(?:'|[^'\"\\n\\f\\\\]|\\\\[\\s\\S])*\"|'(?:\"|[^'\"\\n\\f\\\\]|\\\\[\\s\\S])*'|(?:[\\t\\x21\\x23-\\x26\\x28-\\x5b\\x5d-\\x7e]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))*)[\\t\\n\\f ]*[)]|(?!url[(])-?(?:[a-zA-Z_]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))(?:[a-zA-Z0-9_-]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))*[(]|(?:@?-?(?:[a-zA-Z_]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))|#)(?:[a-zA-Z0-9_-]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))*|\"(?:'|[^'\"\\n\\f\\\\]|\\\\[\\s\\S])*\"|'(?:\"|[^'\"\\n\\f\\\\]|\\\\[\\s\\S])*'|[-+]?(?:[0-9]+(?:[.][0-9]+)?|[.][0-9]+)(?:%|-?(?:[a-zA-Z_]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))(?:[a-zA-Z0-9_-]|[\\u0080-\\ud7ff\\ue000-\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]|\\\\(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff]))*)?|<!--|-->|[\\t\\n\\f ]+|/(?:[*][^*]*[*]+(?:[^/][^*]*[*]+)*/|/[^\\n\\f]*)|[~|^$*]=|[^\"'\\\\/]|/(?![/*])","gi"),b=RegExp("\\\\(?:(?:[0-9a-fA-F]{1,6}[\\t\\n\\f ]?|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|[\\ud800-\\udbff][\\udc00-\\udfff])|[\\n\\f])","g"),a=RegExp("^url\\([\\t\\n\\f ]*[\"']?|[\"']?[\\t\\n\\f ]*\\)$","gi");X=function(a){return a.replace(b,g)};U=function(b){for(var b=(""+b).replace(/\r\n?/g,"\n").match(v)||[],f=0,h=" ",d=0,y=b.length;d<y;++d){var l=X(b[d]),V=l.length,g=l.charCodeAt(0),l=34==g||39==g?w(l.substring(1,V-1),M):47==g&&1<V||"\\"==l||"-->"==l||"<!--"==l||"﻿"==l||32>=g?" ":/url\(/i.test(l)?"url("+w(l.replace(a,""),x)+")":l;if(h!=l||" "!=l)b[f++]=h=l}b.length=f;return b}})();"undefined"!==typeof window&&(window.lexCss=U,window.decodeCss=X);var Y=function(){function g(d){d=(""+d).match(k);return!d?s:new e(v(d[1]),v(d[2]),v(d[3]),v(d[4]),v(d[5]),v(d[6]),v(d[7]))}function w(d,a){return"string"==typeof d?encodeURI(d).replace(a,M):s}function M(d){d=d.charCodeAt(0);return"%"+"0123456789ABCDEF".charAt(d>>4&15)+"0123456789ABCDEF".charAt(d&15)}function x(d){if(d===s)return s;for(var d=d.replace(/(^|\/)\.(?:\/|$)/g,"$1").replace(/\/{2,}/g,"/"),a=b,h;(h=d.replace(a,"$1"))!=d;d=h);return d}function E(d,h){var b=d.T(),f=h.K();f?b.ga(h.j):f=h.X();f?b.da(h.n):f=h.Y();f?b.ea(h.k):f=h.$();var g=h.g,k=x(g);if(f)b.ca(h.V()),k=k&&k.replace(a,"");else if(f=!!g){if(47!==k.charCodeAt(0))var k=x(b.g||"").replace(a,""),e=k.lastIndexOf("/")+1,k=x((e?k.substring(0,e):"")+x(g)).replace(a,"")}else k=k&&k.replace(a,""),k!==g&&b.G(k);f?b.G(k):f=h.aa();f?b.O(h.l):f=h.Z();f&&b.fa(h.o);return b}function e(d,a,h,f,b,g,k){this.j=d;this.n=a;this.k=h;this.h=f;this.g=b;this.l=g;this.o=k}function v(d){return"string"==typeof d&&0<d.length?d:s}var b=RegExp(/(\/|^)(?:[^./][^/]*|\.{2,}(?:[^./][^/]*)|\.{3,}[^/]*)\/\.\.(?:\/|$)/),a=/^(?:\.\.\/)*(?:\.\.$)?/;e.prototype.toString=function(){var d=[];s!==this.j&&d.push(this.j,":");s!==this.k&&(d.push("//"),s!==this.n&&d.push(this.n,"@"),d.push(this.k),s!==this.h&&d.push(":",this.h.toString()));s!==this.g&&d.push(this.g);s!==this.l&&d.push("?",this.l);s!==this.o&&d.push("#",this.o);return d.join("")};e.prototype.T=function(){return new e(this.j,this.n,this.k,this.h,this.g,this.l,this.o)};e.prototype.W=function(){return this.j&&decodeURIComponent(this.j).toLowerCase()};e.prototype.ga=function(d){this.j=d?d:s};e.prototype.K=function(){return s!==this.j};e.prototype.da=function(d){this.n=d?d:s};e.prototype.X=function(){return s!==this.n};e.prototype.ea=function(d){this.k=d?d:s;this.G(this.g)};e.prototype.Y=function(){return s!==this.k};e.prototype.V=function(){return this.h&&decodeURIComponent(this.h)};e.prototype.ca=function(d){if(d){d=Number(d);if(d!==(d&65535))throw Error("Bad port number "+d);this.h=""+d}else this.h=s};e.prototype.$=function(){return s!==this.h};e.prototype.U=function(){return this.g&&decodeURIComponent(this.g)};e.prototype.G=function(d){d?(d=""+d,this.g=!this.k||/^\//.test(d)?d:"/"+d):this.g=s};e.prototype.O=function(d){this.l=d?d:s};e.prototype.aa=function(){return s!==this.l};e.prototype.ba=function(d){if("object"===typeof d&&!(d instanceof Array)&&(d instanceof Object||"[object Array]"!==Object.prototype.toString.call(d))){var a=[],h=-1,f;for(f in d){var b=d[f];"string"===typeof b&&(a[++h]=f,a[++h]=b)}d=a}for(var a=[],h="",g=0;g<d.length;)f=d[g++],b=d[g++],a.push(h,encodeURIComponent(f.toString())),h="&",b&&a.push("=",encodeURIComponent(b.toString()));this.l=a.join("")};e.prototype.fa=function(d){this.o=d?d:s};e.prototype.Z=function(){return s!==this.o};var k=/^(?:([^:/?#]+):)?(?:\/\/(?:([^/?#]*)@)?([^/?#:@]*)(?::([0-9]+))?)?([^?#]+)?(?:\?([^#]*))?(?:#(.*))?$/,f=/[#\/\?@]/g,h=/[\#\?]/g;e.parse=g;e.create=function(d,a,b,g,k,Q,N){d=new e(w(d,f),w(a,f),"string"==typeof b?encodeURIComponent(b):s,0<g?g.toString():s,w(k,h),s,"string"==typeof N?encodeURIComponent(N):s);Q&&("string"===typeof Q?d.O(Q.replace(/[^?&=0-9A-Za-z_\-~.%]/g,M)):d.ba(Q));return d};e.N=E;e.ma=x;e.ha={ua:function(d){return/\.html$/.test(g(d).U())?"text/html":"application/javascript"},N:function(d,a){return d?E(g(d),g(a)).toString():""+a}};return e}();"undefined"!==typeof window&&(window.URI=Y);var aa=c,ba=c,da=c,Z=c;(function(){function g(a){return"string"===typeof a?'url("'+a.replace(e,w)+'")':'url("about:blank")'}function w(a){return v[a]}function M(a,d){return a?Y.ha.N(a,d):d}function x(h,d,f){if(!f)return s;var g=(""+h).match(b);return g&&(!g[1]||a.test(g[1]))?f(h,d):s}function E(a){return a.replace(/^-(?:apple|css|epub|khtml|moz|mso?|o|rim|wap|webkit|xv)-(?=[a-z])/,"")}var e=/[\n\f\r\"\'()*<>]/g,v={"\n":"%0a","\f":"%0c","\r":"%0d",'"':"%22","'":"%27","(":"%28",")":"%29","*":"%2a","<":"%3c",">":"%3e"},b=/^(?:([^:/?# ]+):)?/,a=/^(?:https?|mailto)$/i;aa=function(){var a={};return function y(f,b,k,e,N){var f=E(f),u=L[f];if(!u||"object"!==typeof u)b.length=0;else{for(var i=u.cssPropBits,q=i&80,B=i&1536,F=NaN,r=0,o=0;r<b.length;++r){var j=b[r].toLowerCase(),I=j.charCodeAt(0),R,v,P,S,D,w;if(32===I)j="";else if(34===I)j=16===q?k?g(x(M(e,X(b[r].substring(1,j.length-1))),f,k)):"":i&8&&!(q&q-1)?j:"";else if("inherit"!==j){if(D=u.cssLitGroup){var G;if(!(G=u.cssLitMap)){G={};for(var K=D.length;0<=--K;)for(var A=D[K],T=A.length;0<=--T;)G[A[T]]=a;G=u.cssLitMap=G}D=G}else D=a;if(!(w=D,w[E(j)]===a))if(35===I&&/^#(?:[0-9a-f]{3}){1,2}$/.test(j))j=i&2?j:"";else if(48<=I&&57>=I)j=i&1?j:"";else if(R=j.charCodeAt(1),v=j.charCodeAt(2),P=48<=R&&57>=R,S=48<=v&&57>=v,43===I&&(P||46===R&&S))j=i&1?(P?"":"0")+j.substring(1):"";else if(45===I&&(P||46===R&&S))j=i&4?(P?"-":"-0")+j.substring(1):i&1?"0":"";else if(46===I&&P)j=i&1?"0"+j:"";else if('url("'===j.substring(0,5))j=k&&i&16?g(x(M(e,b[r].substring(5,j.length-2)),f,k)):"";else if("("===j.charAt(j.length-1))a:{D=b;G=r;j=1;K=G+1;for(I=D.length;K<I&&j;)A=D[K++],j+=")"===A?-1:/^[^"']*\($/.test(A);if(!j){j=D[G].toLowerCase();I=E(j);D=D.splice(G,K-G,"");G=u.cssFns;K=0;for(A=G.length;K<A;++K)if(G[K].substring(0,I.length)==I){D[0]=D[D.length-1]="";y(G[K],D,k,e);j=j+D.join(" ")+")";break a}}j=""}else j=B&&/^-?[a-z_][\w\-]*$/.test(j)&&!/__$/.test(j)?N&&512===B?b[r]+N:1024===B&&L[j]&&"number"===typeof L[j].oa?j:"":/^\w+$/.test(j)&&64===q&&i&8?F+1===o?(b[F]=b[F].substring(0,b[F].length-1)+" "+j+'"',""):(F=o,'"'+j+'"'):""}j&&(b[o++]=j)}1===o&&'url("about:blank")'===b[0]&&(o=0);b.length=o}}}();var k=RegExp("^(active|after|before|blank|checked|default|disabled|drop|empty|enabled|first|first-child|first-letter|first-line|first-of-type|fullscreen|focus|hover|in-range|indeterminate|invalid|last-child|last-of-type|left|link|only-child|only-of-type|optional|out-of-range|placeholder-shown|read-only|read-write|required|right|root|scope|user-error|valid|visited)$"),f={};f[">"]=f["+"]=f["~"]=f;ba=function(a,d,b){function g(i,r){function o(b,f,g){var y,e,i,l,o,m=n;y="";if(b<f)if(o=a[b],"*"===o)++b,y=o;else if(/^[a-zA-Z]/.test(o)&&(e=x(o.toLowerCase(),[])))"tagName"in e&&(o=e.tagName),++b,y=o;for(l=i=e="";m&&b<f;++b)if(o=a[b],"#"===o.charAt(0))/^#_|__$|[^\w#:\-]/.test(o)?m=C:e+=o+v;else if("."===o)++b<f&&/^[0-9A-Za-z:_\-]+$/.test(o=a[b])&&!/^_|__$/.test(o)?e+="."+o:m=C;else if(b+1<f&&"["===a[b]){++b;var H=a[b++].toLowerCase();o=$.m[y+"::"+H];o!==+o&&(o=$.m["*::"+H]);var W;d.ia?(W=d.ia(y,H),"string"!==typeof W&&(m=C,W=H),m&&o!==+o&&(o=$.d.NONE)):(W=H,o!==+o&&(m=C));var p=H="",ca=C;/^[~^$*|]?=$/.test(a[b])&&(H=a[b++],p=a[b++],/^[0-9A-Za-z:_\-]+$/.test(p)?p='"'+p+'"':"]"===p&&(p='""',--b),/^"([^\"\\]|\\.)*"$/.test(p)||(m=C),(ca="i"===a[b])&&++b);"]"!==a[b]&&(++b,m=C);switch(o){case $.d.CLASSES:case $.d.LOCAL_NAME:case $.d.NONE:break;case $.d.GLOBAL_NAME:case $.d.ID:case $.d.IDREF:("="===H||"~="===H||"$="===H)&&'""'!=p&&!ca?p='"'+p.substring(1,p.length-1)+v+'"':"|="===H||""===H||(m=C);break;case $.d.URI:case $.d.URI_FRAGMENT:""!==H&&(m=C);break;default:m=C}m&&(i+="["+W.replace(/[^\w-]/g,"\\$&")+H+p+(ca?" i]":"]"))}else if(b<f&&":"===a[b])if(o=a[++b],k.test(o))l+=":"+o;else break;else break;b!==f&&(m=C);m&&(b=(y+e).replace(/[^ .*#\w-]/g,"\\$&")+i+l+g)&&j.push(b);return m}" "===a[i]&&++i;r-1!==i&&" "===a[r]&&--r;for(var j=[],l=i,q=n,u=i;q&&u<r;++u){var B=a[u];if(f[B]===f||" "===B)o(l,u,B)?l=u+1:q=C}o(l,r,"")||(q=C);return q?(j.length&&(l=j.join(""),e!==s&&(l="."+e+" "+l),N.push(l)),n):!b||b(a.slice(i,r))}var e=d.na,v=d.L,x=d.Aa,N=[],u=0,i,q=0,B;for(i=0;i<a.length;++i)if(B=a[i],"("==B||"["==B?(++q,n):")"==B||"]"==B?(q&&--q,n):!(" "==a[i]&&(q||f[a[i-1]]===f||f[a[i+1]]===f)))a[u++]=a[i];a.length=u;u=a.length;for(i=q=0;i<u;++i)if(","===a[i]){if(!g(q,i))return s;q=i+1}return!g(q,u)?s:N};(function(){var a=/^\w/,d=RegExp("^(?:(?:(?:(?:only|not) )?(?:all|aural|braille|embossed|handheld|print|projection|screen|speech|tty|tv)|\\( (?:(?:min-|max-)?(?:(?:device-)?(?:aspect-ratio|height|width)|color(?:-index)?|monochrome|orientation|resolution)|grid|hover|luminosity|pointer|scan|script) (?:: -?(?:[a-z]\\w+(?:-\\w+)*|\\d+(?: / \\d+|(?:\\.\\d+)?(?:p[cxt]|[cem]m|in|dpi|dppx|dpcm|%)?)) )?\\))(?: and ?\\( (?:(?:min-|max-)?(?:(?:device-)?(?:aspect-ratio|height|width)|color(?:-index)?|monochrome|orientation|resolution)|grid|hover|luminosity|pointer|scan|script) (?:: -?(?:[a-z]\\w+(?:-\\w+)*|\\d+(?: / \\d+|(?:\\.\\d+)?(?:p[cxt]|[cem]m|in|dpi|dppx|dpcm|%)?)) )?\\))*)(?: , (?:(?:(?:(?:only|not) )?(?:all|aural|braille|embossed|handheld|print|projection|screen|speech|tty|tv)|\\( (?:(?:min-|max-)?(?:(?:device-)?(?:aspect-ratio|height|width)|color(?:-index)?|monochrome|orientation|resolution)|grid|hover|luminosity|pointer|scan|script) (?:: -?(?:[a-z]\\w+(?:-\\w+)*|\\d+(?: / \\d+|(?:\\.\\d+)?(?:p[cxt]|[cem]m|in|dpi|dppx|dpcm|%)?)) )?\\))(?: and ?\\( (?:(?:min-|max-)?(?:(?:device-)?(?:aspect-ratio|height|width)|color(?:-index)?|monochrome|orientation|resolution)|grid|hover|luminosity|pointer|scan|script) (?:: -?(?:[a-z]\\w+(?:-\\w+)*|\\d+(?: / \\d+|(?:\\.\\d+)?(?:p[cxt]|[cem]m|in|dpi|dppx|dpcm|%)?)) )?\\))*))*$","i");Z=function(b){for(var b=b.slice(),f=b.length,g=0,k=0;k<f;++k){var e=b[k];" "!=e&&(b[g++]=e)}b.length=g;b=b.join(" ");return b=!b.length?"":!d.test(b)?"not all":a.test(b)?b:"not all , "+b}})();(function(){function a(b){var d=/^\s*[']([^']*)[']\s*$/,f=/^\s*url\s*[(]["]([^"]*)["][)]\s*$/,g=/^\s*url\s*[(][']([^']*)['][)]\s*$/,h=/^\s*url\s*[(]([^)]*)[)]\s*$/,k;return(k=/^\s*["]([^"]*)["]\s*$/.exec(b))||(k=d.exec(b))||(k=f.exec(b))||(k=g.exec(b))||(k=h.exec(b))?k[1]:s}function b(f,g,k,e,v,w,u){function i(){r=F.length&&F[F.length-1]===s}var q=c,B=u||[0],F=[],r=C;fa(g,{startStylesheet:function(){q=[]},endStylesheet:function(){},startAtrule:function(g,j){if(r)g=s;else if("@media"===g)q.push("@media"," ",Z(j));else if("@keyframes"===g||"@-webkit-keyframes"===g){var i=j[0];1===j.length&&!/__$|[^\w\-]/.test(i)?(q.push(g," ",i+k.L),g="@keyframes"):g=s}else if("@import"===g&&0<j.length)if(g=s,"function"===typeof w){var l=Z(j.slice(1));if("not all"!==l){++B[0];var u=[];q.push(u);var E=x(M(f,a(j[0])),function(a){var f=b(E,a.qa,k,e,v,w,B);--B[0];a=l?{toString:function(){return"@media "+l+" {"+f.result+"}"}}:f.result;u[0]=a;w(a,!!B[0])},v)}}else window.console&&window.console.log("@import "+j.join(" ")+" elided");r=!g;F.push(g)},endAtrule:function(){F.pop();r||q.push(";");i()},startBlock:function(){r||q.push("{")},endBlock:function(){r||(q.push("}"),r=n)},startRuleset:function(a){if(!r){var b=c;"@keyframes"===F[F.length-1]?(b=a.join(" ").match(/^ *(?:from|to|\d+(?:\.\d+)?%) *(?:, *(?:from|to|\d+(?:\.\d+)?%) *)*$/i),r=!b,b&&(b=b[0].replace(/ +/g,""))):(a=ba(a,k),!a||!a.length?r=n:b=a.join(", "));r||q.push(b,"{")}F.push(s)},endRuleset:function(){F.pop();r||q.push("}");i()},declaration:function(a,b){if(!r){var d=C,g=b.length;2<=g&&"!"===b[g-2]&&"important"===b[g-1].toLowerCase()&&(d=n,b.length-=2);aa(a,b,e,f,k.L);b.length&&q.push(a,":",b.join(" "),d?" !important;":";")}}});return{result:{toString:function(){return q.join("")}},va:!!B[0]}}da=function(a,f,g,k){return b(a,f,g,k,c,c).result.toString()}})()})();"undefined"!==typeof window&&(window.sanitizeCssProperty=aa,window.sanitizeCssSelectorList=ba,window.sanitizeStylesheet=da,window.sanitizeMediaQuery=Z);var fa,ga;(function(){function g(b,a,g,f,h){for(var d=a++;a<g&&"{"!==b[a]&&";"!==b[a];)++a;if(a<g&&(h||";"===b[a])){var h=d+1,e=a;h<g&&" "===b[h]&&++h;e>h&&" "===b[e-1]&&--e;f.startAtrule&&f.startAtrule(b[d].toLowerCase(),b.slice(h,e));a="{"===b[a]?w(b,a,g,f):a+1;f.endAtrule&&f.endAtrule()}return a}function w(b,a,k,f){++a;for(f.startBlock&&f.startBlock();a<k;){var h=b[a].charAt(0);if("}"==h){++a;break}a=" "===h||";"===h?a+1:"@"===h?g(b,a,k,f,C):"{"===h?w(b,a,k,f):M(b,a,k,f)}f.endBlock&&f.endBlock();return a}function M(b,a,g,f){var h=a,d=x(b,a,g,n);if(0>d)return d=~d,d===h?d+1:d;var y=b[d];if("{"!==y)return d===h?d+1:d;a=d+1;d>h&&" "===b[d-1]&&--d;for(f.startRuleset&&f.startRuleset(b.slice(h,d));a<g;){y=b[a];if("}"===y){++a;break}a=" "===y?a+1:e(b,a,g,f)}f.endRuleset&&f.endRuleset();return a}function x(b,a,g,f){for(var h,d=[],e=-1;a<g;++a)if(h=b[a].charAt(0),"["===h||"("===h)d[++e]=h;else if("]"===h&&"["===d[e]||")"===h&&"("===d[e])--e;else if("{"===h||"}"===h||";"===h||"@"===h||":"===h&&!f)break;0<=e&&(a=~(a+1));return a}function E(b,a,g){for(;a<g&&";"!==b[a]&&"}"!==b[a];)++a;return a<g&&";"===b[a]?a+1:a}function e(b,a,g,f){var h=b[a++];if(!v.test(h))return E(b,a,g);a<g&&" "===b[a]&&++a;if(a==g||":"!==b[a])return E(b,a,g);++a;a<g&&" "===b[a]&&++a;var d=x(b,a,g,C);if(0>d)d=~d;else{for(var e=[],l=0,w=a;w<d;++w)a=b[w]," "!==a&&(e[l++]=a);if(d<g){do{a=b[d];if(";"===a||"}"===a)break;l=0}while(++d<g);";"===a&&++d}l&&f.declaration&&f.declaration(h.toLowerCase(),e)}return d}fa=function(b,a){var e=U(b);a.startStylesheet&&a.startStylesheet();for(var f=0,h=e.length;f<h;)f=" "===e[f]?f+1:f<h?"@"===e[f].charAt(0)?g(e,f,h,a,n):M(e,f,h,a):f;a.endStylesheet&&a.endStylesheet()};var v=/^-?[a-z]/i;ga=function(b,a){for(var g=U(b),f=0,h=g.length;f<h;)f=" "!==g[f]?e(g,f,h,a):f+1}})();"undefined"!==typeof window&&(window.parseCssStylesheet=fa,window.parseCssDeclarations=ga);var $={d:{NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,HTML:12,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10,MEDIA_QUERY:13}};$.atype=$.d;$.m={"*::class":9,"*::dir":0,"*::draggable":0,"*::hidden":0,"*::id":4,"*::inert":0,"*::itemprop":0,"*::itemref":6,"*::itemscope":0,"*::lang":0,"*::onblur":2,"*::onchange":2,"*::onclick":2,"*::ondblclick":2,"*::onerror":2,"*::onfocus":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::onreset":2,"*::onscroll":2,"*::onselect":2,"*::onsubmit":2,"*::ontouchcancel":2,"*::ontouchend":2,"*::ontouchenter":2,"*::ontouchleave":2,"*::ontouchmove":2,"*::ontouchstart":2,"*::onunload":2,"*::spellcheck":0,"*::style":3,"*::tabindex":0,"*::title":0,"*::translate":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::shape":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::target":10,"audio::controls":0,"audio::loop":0,"audio::mediagroup":5,"audio::muted":0,"audio::preload":0,"audio::src":1,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::type":0,"button::value":0,"canvas::height":0,"canvas::width":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"command::checked":0,"command::command":5,"command::disabled":0,"command::icon":1,"command::label":0,"command::radiogroup":0,"command::type":0,"data::value":0,"del::cite":1,"del::datetime":0,"details::open":0,"dir::compact":0,"div::align":0,"dl::compact":0,"fieldset::disabled":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::novalidate":0,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::inputmode":0,"input::ismap":0,"input::list":5,"input::max":0,"input::maxlength":0,"input::min":0,"input::multiple":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::pattern":0,"input::placeholder":0,"input::readonly":0,"input::required":0,"input::size":0,"input::src":1,"input::step":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"menu::label":0,"menu::type":0,"meter::high":0,"meter::low":0,"meter::max":0,"meter::min":0,"meter::value":0,"ol::compact":0,"ol::reversed":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"output::for":6,"output::name":8,"p::align":0,"pre::width":0,"progress::max":0,"progress::min":0,"progress::value":0,"q::cite":1,"select::autocomplete":0,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::required":0,"select::size":0,"source::type":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::autocomplete":0,"textarea::cols":0,"textarea::disabled":0,"textarea::inputmode":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::placeholder":0,"textarea::readonly":0,"textarea::required":0,"textarea::rows":0,"textarea::wrap":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"track::default":0,"track::kind":0,"track::label":0,"track::srclang":0,"ul::compact":0,"ul::type":0,"video::controls":0,"video::height":0,"video::loop":0,"video::mediagroup":5,"video::muted":0,"video::poster":1,"video::preload":0,"video::src":1,"video::width":0};$.ATTRIBS=$.m;$.c={OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128,VIRTUALIZED:256};$.eflags=$.c;$.f={a:0,abbr:0,acronym:0,address:0,applet:272,area:2,article:0,aside:0,audio:0,b:0,base:274,basefont:274,bdi:0,bdo:0,big:0,blockquote:0,body:305,br:2,button:0,canvas:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,command:2,data:0,datalist:0,dd:1,del:0,details:0,dfn:0,dialog:272,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,figcaption:0,figure:0,font:0,footer:0,form:0,frame:274,frameset:272,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:305,header:0,hgroup:0,hr:2,html:305,i:0,iframe:4,img:2,input:2,ins:0,isindex:274,kbd:0,keygen:274,label:0,legend:0,li:1,link:274,map:0,mark:0,menu:0,meta:274,meter:0,nav:0,nobr:0,noembed:276,noframes:276,noscript:276,object:272,ol:0,optgroup:0,option:1,output:0,p:1,param:274,pre:0,progress:0,q:0,s:0,samp:0,script:84,section:0,select:0,small:0,source:2,span:0,strike:0,strong:0,style:148,sub:0,summary:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,time:0,title:280,tr:1,track:2,tt:0,u:0,ul:0,"var":0,video:0,wbr:2};$.ELEMENTS=$.f;$.Q={a:"HTMLAnchorElement",abbr:"HTMLElement",acronym:"HTMLElement",address:"HTMLElement",applet:"HTMLAppletElement",area:"HTMLAreaElement",article:"HTMLElement",aside:"HTMLElement",audio:"HTMLAudioElement",b:"HTMLElement",base:"HTMLBaseElement",basefont:"HTMLBaseFontElement",bdi:"HTMLElement",bdo:"HTMLElement",big:"HTMLElement",blockquote:"HTMLQuoteElement",body:"HTMLBodyElement",br:"HTMLBRElement",button:"HTMLButtonElement",canvas:"HTMLCanvasElement",caption:"HTMLTableCaptionElement",center:"HTMLElement",cite:"HTMLElement",code:"HTMLElement",col:"HTMLTableColElement",colgroup:"HTMLTableColElement",command:"HTMLCommandElement",data:"HTMLElement",datalist:"HTMLDataListElement",dd:"HTMLElement",del:"HTMLModElement",details:"HTMLDetailsElement",dfn:"HTMLElement",dialog:"HTMLDialogElement",dir:"HTMLDirectoryElement",div:"HTMLDivElement",dl:"HTMLDListElement",dt:"HTMLElement",em:"HTMLElement",fieldset:"HTMLFieldSetElement",figcaption:"HTMLElement",figure:"HTMLElement",font:"HTMLFontElement",footer:"HTMLElement",form:"HTMLFormElement",frame:"HTMLFrameElement",frameset:"HTMLFrameSetElement",h1:"HTMLHeadingElement",h2:"HTMLHeadingElement",h3:"HTMLHeadingElement",h4:"HTMLHeadingElement",h5:"HTMLHeadingElement",h6:"HTMLHeadingElement",head:"HTMLHeadElement",header:"HTMLElement",hgroup:"HTMLElement",hr:"HTMLHRElement",html:"HTMLHtmlElement",i:"HTMLElement",iframe:"HTMLIFrameElement",img:"HTMLImageElement",input:"HTMLInputElement",ins:"HTMLModElement",isindex:"HTMLUnknownElement",kbd:"HTMLElement",keygen:"HTMLKeygenElement",label:"HTMLLabelElement",legend:"HTMLLegendElement",li:"HTMLLIElement",link:"HTMLLinkElement",map:"HTMLMapElement",mark:"HTMLElement",menu:"HTMLMenuElement",meta:"HTMLMetaElement",meter:"HTMLMeterElement",nav:"HTMLElement",nobr:"HTMLElement",noembed:"HTMLElement",noframes:"HTMLElement",noscript:"HTMLElement",object:"HTMLObjectElement",ol:"HTMLOListElement",optgroup:"HTMLOptGroupElement",option:"HTMLOptionElement",output:"HTMLOutputElement",p:"HTMLParagraphElement",param:"HTMLParamElement",pre:"HTMLPreElement",progress:"HTMLProgressElement",q:"HTMLQuoteElement",s:"HTMLElement",samp:"HTMLElement",script:"HTMLScriptElement",section:"HTMLElement",select:"HTMLSelectElement",small:"HTMLElement",source:"HTMLSourceElement",span:"HTMLSpanElement",strike:"HTMLElement",strong:"HTMLElement",style:"HTMLStyleElement",sub:"HTMLElement",summary:"HTMLElement",sup:"HTMLElement",table:"HTMLTableElement",tbody:"HTMLTableSectionElement",td:"HTMLTableDataCellElement",textarea:"HTMLTextAreaElement",tfoot:"HTMLTableSectionElement",th:"HTMLTableHeaderCellElement",thead:"HTMLTableSectionElement",time:"HTMLTimeElement",title:"HTMLTitleElement",tr:"HTMLTableRowElement",track:"HTMLTrackElement",tt:"HTMLElement",u:"HTMLElement",ul:"HTMLUListElement","var":"HTMLElement",video:"HTMLVideoElement",wbr:"HTMLElement"};$.ELEMENT_DOM_INTERFACES=$.Q;$.P={NOT_LOADED:0,SAME_DOCUMENT:1,NEW_DOCUMENT:2};$.ueffects=$.P;$.J={"a::href":2,"area::href":2,"audio::src":1,"blockquote::cite":0,"command::icon":1,"del::cite":0,"form::action":2,"img::src":1,"input::src":1,"ins::cite":0,"q::cite":0,"video::poster":1,"video::src":1};$.URIEFFECTS=$.J;$.M={UNSANDBOXED:2,SANDBOXED:1,DATA:0};$.ltypes=$.M;$.I={"a::href":2,"area::href":2,"audio::src":2,"blockquote::cite":2,"command::icon":1,"del::cite":2,"form::action":2,"img::src":1,"input::src":1,"ins::cite":2,"q::cite":2,"video::poster":1,"video::src":2};$.LOADERTYPES=$.I;"undefined"!==typeof window&&(window.html4=$);var ha=function(g){function w(a){if(i.hasOwnProperty(a))return i[a];var b=a.match(q);return b?String.fromCharCode(parseInt(b[1],10)):(b=a.match(B))?String.fromCharCode(parseInt(b[1],16)):r&&F.test(a)?(r.innerHTML="&"+a+";",b=r.textContent,i[a]=b):"&"+a+";"}function M(a,b){return w(b)}function x(a){return a.replace(j,M)}function E(a){return(""+a).replace(R,"&amp;").replace(P,"&lt;").replace(S,"&gt;").replace(D,"&#34;")}function e(a){return a.replace(ia,"&amp;$1").replace(P,"&lt;").replace(S,"&gt;")}function v(b){var d={z:b.z||b.cdata,A:b.A||b.comment,B:b.B||b.endDoc,t:b.t||b.endTag,e:b.e||b.pcdata,F:b.F||b.rcdata,H:b.H||b.startDoc,w:b.w||b.startTag};return function(b,g){var f;var H=/(<\/|<\!--|<[!?]|[&<>])/g;f=b+"";if(G)f=f.split(H);else{for(var e=[],h=0,j;(j=H.exec(f))!==s;)e.push(f.substring(h,j.index)),e.push(j[0]),h=j.index+j[0].length;e.push(f.substring(h));f=e}a(d,f,0,{r:C,C:C},g)}}function b(b,d,g,f,t){return function(){a(b,d,g,f,t)}}function a(a,d,p,e,t){try{a.H&&0==p&&a.H(t);for(var h,z,j,i=d.length;p<i;){var o=d[p++],l=d[p];switch(o){case"&":I.test(l)?(a.e&&a.e("&"+l,t,A,b(a,d,p,e,t)),p++):a.e&&a.e("&amp;",t,A,b(a,d,p,e,t));break;case"</":if(h=/^([-\w:]+)[^\'\"]*/.exec(l))if(h[0].length===l.length&&">"===d[p+1])p+=2,j=h[1].toLowerCase(),a.t&&a.t(j,t,A,b(a,d,p,e,t));else{var m=d,q=p,r=a,u=t,v=A,y=e,w=f(m,q);w?(r.t&&r.t(w.name,u,v,b(r,m,q,y,u)),p=w.next):p=m.length}else a.e&&a.e("&lt;/",t,A,b(a,d,p,e,t));break;case"<":if(h=/^([-\w:]+)\s*\/?/.exec(l))if(h[0].length===l.length&&">"===d[p+1]){p+=2;j=h[1].toLowerCase();a.w&&a.w(j,[],t,A,b(a,d,p,e,t));var B=g.f[j];B&K&&(p=k(d,{name:j,next:p,c:B},a,t,A,e))}else{var m=d,q=a,r=t,u=A,v=e,x=f(m,p);x?(q.w&&q.w(x.name,x.R,r,u,b(q,m,x.next,v,r)),p=x.c&K?k(m,x,q,r,u,v):x.next):p=m.length}else a.e&&a.e("&lt;",t,A,b(a,d,p,e,t));break;case"<!--":if(!e.C){for(z=p+1;z<i&&!(">"===d[z]&&/--$/.test(d[z-1]));z++);if(z<i){if(a.A){var D=d.slice(p,z).join("");a.A(D.substr(0,D.length-2),t,A,b(a,d,z+1,e,t))}p=z+1}else e.C=n}e.C&&a.e&&a.e("&lt;!--",t,A,b(a,d,p,e,t));break;case"<!":if(/^\w/.test(l)){if(!e.r){for(z=p+1;z<i&&">"!==d[z];z++);z<i?p=z+1:e.r=n}e.r&&a.e&&a.e("&lt;!",t,A,b(a,d,p,e,t))}else a.e&&a.e("&lt;!",t,A,b(a,d,p,e,t));break;case"<?":if(!e.r){for(z=p+1;z<i&&">"!==d[z];z++);z<i?p=z+1:e.r=n}e.r&&a.e&&a.e("&lt;?",t,A,b(a,d,p,e,t));break;case">":a.e&&a.e("&gt;",t,A,b(a,d,p,e,t));break;case"":break;default:a.e&&a.e(o,t,A,b(a,d,p,e,t))}}a.B&&a.B(t)}catch(E){if(E!==A)throw E}}function k(a,d,f,h,t,j){var z=a.length;T.hasOwnProperty(d.name)||(T[d.name]=RegExp("^"+d.name+"(?:[\\s\\/]|$)","i"));for(var i=T[d.name],k=d.next,l=d.next+1;l<z&&!("</"===a[l-1]&&i.test(a[l]));l++);l<z&&(l-=1);z=a.slice(k,l).join("");if(d.c&g.c.CDATA)f.z&&f.z(z,h,t,b(f,a,l,j,h));else if(d.c&g.c.RCDATA)f.F&&f.F(e(z),h,t,b(f,a,l,j,h));else throw Error("bug");return l}function f(a,b){var d=/^([-\w:]+)/.exec(a[b]),f={};f.name=d[1].toLowerCase();f.c=g.f[f.name];for(var e=a[b].substr(d[0].length),h=b+1,j=a.length;h<j&&">"!==a[h];h++)e+=a[h];if(!(j<=h)){for(var l=[];""!==e;)if(d=ja.exec(e))if(d[4]&&!d[5]||d[6]&&!d[7]){for(var d=d[4]||d[6],i=C,e=[e,a[h++]];h<j;h++){if(i){if(">"===a[h])break}else 0<=a[h].indexOf(d)&&(i=n);e.push(a[h])}if(j<=h)break;e=e.join("")}else{var i=d[1].toLowerCase(),k;if(d[2]){k=d[3];var m=k.charCodeAt(0);if(34===m||39===m)k=k.substr(1,k.length-2);k=x(k.replace(o,""))}else k="";l.push(i,k);e=e.substr(d[0].length)}else e=e.replace(/^[\s\S][^a-z\s]*/,"");f.R=l;f.next=h+1;return f}}function h(a){function b(a,d){f||d.push(a)}var d,f;return v({startDoc:function(){d=[];f=C},startTag:function(b,e,h){if(!f&&g.f.hasOwnProperty(b)){var j=g.f[b];if(!(j&g.c.FOLDABLE)){var k=a(b,e);if(k){if("object"!==typeof k)throw Error("tagPolicy did not return object (old API?)");if("attribs"in k)e=k.attribs;else throw Error("tagPolicy gave no attribs");var i;"tagName"in k?(i=k.tagName,k=g.f[i]):(i=b,k=j);if(j&g.c.OPTIONAL_ENDTAG){var l=d[d.length-1];l&&l.D===b&&(l.v!==i||b!==i)&&h.push("</",l.v,">")}j&g.c.EMPTY||d.push({D:b,v:i});h.push("<",i);b=0;for(l=e.length;b<l;b+=2){var m=e[b],o=e[b+1];o!==s&&o!==c&&h.push(" ",m,'="',E(o),'"')}h.push(">");j&g.c.EMPTY&&!(k&g.c.EMPTY)&&h.push("</",i,">")}else f=!(j&g.c.EMPTY)}}},endTag:function(a,b){if(f)f=C;else if(g.f.hasOwnProperty(a)){var e=g.f[a];if(!(e&(g.c.EMPTY|g.c.FOLDABLE))){if(e&g.c.OPTIONAL_ENDTAG)for(e=d.length;0<=--e;){var h=d[e].D;if(h===a)break;if(!(g.f[h]&g.c.OPTIONAL_ENDTAG))return}else for(e=d.length;0<=--e&&d[e].D!==a;);if(!(0>e)){for(h=d.length;--h>e;){var j=d[h].v;g.f[j]&g.c.OPTIONAL_ENDTAG||b.push("</",j,">")}e<d.length&&(a=d[e].v);d.length=e;b.push("</",a,">")}}}},pcdata:b,rcdata:b,cdata:b,endDoc:function(a){for(;d.length;d.length--)a.push("</",d[d.length-1].v,">")}})}function d(a,b,d,f,e){if(!e)return s;try{var g=Y.parse(""+a);if(g&&(!g.K()||ka.test(g.W()))){var h=e(g,b,d,f);return h?h.toString():s}}catch(j){}return s}function y(a,b,d,f,e){d||a(b+" removed",{S:"removed",tagName:b});if(f!==e){var g="changed";f&&!e?g="removed":!f&&e&&(g="added");a(b+"."+d+" "+g,{S:g,tagName:b,la:d,oldValue:f,newValue:e})}}function l(a,b,d){b=b+"::"+d;if(a.hasOwnProperty(b))return a[b];b="*::"+d;if(a.hasOwnProperty(b))return a[b]}function V(a,b,f,e,h){for(var j=0;j<b.length;j+=2){var k=b[j],i=b[j+1],m=i,o=s,q;if((q=a+"::"+k,g.m.hasOwnProperty(q))||(q="*::"+k,g.m.hasOwnProperty(q)))o=g.m[q];if(o!==s)switch(o){case g.d.NONE:break;case g.d.SCRIPT:i=s;h&&y(h,a,k,m,i);break;case g.d.STYLE:if("undefined"===typeof N){i=s;h&&y(h,a,k,m,i);break}var r=[];N(i,{declaration:function(a,b){var e=a.toLowerCase();u(e,b,f?function(a){return d(a,g.P.ja,g.M.ka,{TYPE:"CSS",CSS_PROP:e},f)}:s);b.length&&r.push(e+": "+b.join(" "))}});i=0<r.length?r.join(" ; "):s;
h&&y(h,a,k,m,i);break;case g.d.ID:case g.d.IDREF:case g.d.IDREFS:case g.d.GLOBAL_NAME:case g.d.LOCAL_NAME:case g.d.CLASSES:i=e?e(i):i;h&&y(h,a,k,m,i);break;case g.d.URI:i=d(i,l(g.J,a,k),l(g.I,a,k),{TYPE:"MARKUP",XML_ATTR:k,XML_TAG:a},f);h&&y(h,a,k,m,i);break;case g.d.URI_FRAGMENT:i&&"#"===i.charAt(0)?(i=i.substring(1),i=e?e(i):i,i!==s&&i!==c&&(i="#"+i)):i=s;h&&y(h,a,k,m,i);break;default:i=s,h&&y(h,a,k,m,i)}else i=s,h&&y(h,a,k,m,i);b[j+1]=i}return b}function ea(a,b,d){return function(e,f){if(g.f[e]&g.c.UNSAFE)d&&y(d,e,c,c,c);else return{attribs:V(e,f,a,b,d)}}}function Q(a,b){var d=[];h(b)(a,d);return d.join("")}var N,u;"undefined"!==typeof window&&(N=window.parseCssDeclarations,u=window.sanitizeCssProperty);var i={lt:"<",LT:"<",gt:">",GT:">",amp:"&",AMP:"&",quot:'"',apos:"'",nbsp:" "},q=/^#(\d+)$/,B=/^#x([0-9A-Fa-f]+)$/,F=/^[A-Za-z][A-za-z0-9]+$/,r="undefined"!==typeof window&&window.document?window.document.createElement("textarea"):s,o=/\0/g,j=/&(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/g,I=/^(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/,R=/&/g,ia=/&([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi,P=/[<]/g,S=/>/g,D=/\"/g,ja=/^\s*([-.:\w]+)(?:\s*(=)\s*((")[^"]*("|$)|(')[^']*('|$)|(?=[a-z][-\w]*\s*=)|[^"'\s]*))?/i,G=3==="a,b".split(/(,)/).length,K=g.c.CDATA|g.c.RCDATA,A={},T={},ka=/^(?:https?|mailto)$/i,m={};m.pa=m.escapeAttrib=E;m.ra=m.makeHtmlSanitizer=h;m.sa=m.makeSaxParser=v;m.ta=m.makeTagPolicy=ea;m.wa=m.normalizeRCData=e;m.xa=m.sanitize=function(a,b,d,e){return Q(a,ea(b,d,e))};m.ya=m.sanitizeAttribs=V;m.za=m.sanitizeWithPolicy=Q;m.Ba=m.unescapeEntities=x;return m}($),la=ha.sanitize;"undefined"!==typeof window&&(window.html=ha,window.html_sanitize=la)})();(function(Streak){Streak.$=Streak.jQuery=window.jQuery;Streak._=window._;Streak.moment=window.moment;Streak.jwerty=window.jwerty;Streak.Stripe=window.Stripe;Streak.Bacon=window.Bacon;Streak.RSVP=window.RSVP;Streak.caja={html:window.html,html_sanitize:window.html_sanitize};for(var name in Streak._old_globals){if(!Streak._old_globals.hasOwnProperty(name)){continue}if(Streak._old_globals[name]!==undefined){window[name]=Streak._old_globals[name]}else{delete window[name]}}delete Streak._old_globals})(Streak);(function(){"use strict";var _=Streak._;var _originalAppendChild=Element.prototype.appendChild;var _originalRemoveChild=Element.prototype.removeChild;var CSPBypass=Streak.CSPBypass={appendChild:function(el,parent){var node={tagName:el.tagName,innerHTML:el.innerHTML,attributes:{}};_.each(el.attributes,function(attr){node.attributes[attr.nodeName]=attr.nodeValue});var id="a"+Math.random();node.attributes.id=id;var event=document.createEvent("CustomEvent");event.initCustomEvent("extensionAppendRequest",true,false,node);try{parent.dispatchEvent(event)}catch(e){setTimeout(function(){throw e},1)}var newEl=document.getElementById(id);if(newEl){if(!el.id){newEl.removeAttribute("id")}else{var realId=el.id;el.removeAttribute("id");newEl.id=realId}return newEl}return _originalAppendChild.apply(parent,arguments)}};function shouldUseExtension(el){if(!el){return false}if(["SCRIPT"].indexOf(el.nodeName)!=-1&&(!el.src||el.src.match(/^[a-z-]+:/))){return true}return false}Element.prototype.appendChild=function(el){if(shouldUseExtension(el)){var newEl=CSPBypass.appendChild(el,this);if(newEl!==el){el._streak_real=newEl;if(el.nodeName=="SCRIPT"){el.type="text/dummy"}_originalAppendChild.apply(this,arguments);var events=["load","error"];var redispatch=function(event){setTimeout(el.dispatchEvent.bind(el,event),1)};events.forEach(function(eventName){newEl.addEventListener(eventName,redispatch,true)})}return newEl}return _originalAppendChild.apply(this,arguments)};Element.prototype.removeChild=function(el){if(el&&el._streak_real){try{_originalRemoveChild.apply(this,[el._streak_real])}catch(e){}}return _originalRemoveChild.apply(this,arguments)}})();(function(){"use strict";var _=Streak._;var canUseEval=false;try{canUseEval=new Function("return true;")()}catch(e){}Streak.newFunction=function(code){var args;if(arguments.length>1){args=_.initial(arguments);code=arguments[arguments.length-1]}else{args=[]}if(canUseEval){return new(Function.bind.apply(Function,[null].concat(args).concat([code])))}else{var id="_eval_temp_"+Math.random();Streak[id]={};var argString=args.join(",");var source=""+"try {\n"+" Streak["+JSON.stringify(id)+"].result=(function("+argString+"){"+code+"});\n"+"} catch(e) {\n"+" Streak["+JSON.stringify(id)+"].error = e;\n"+"}\n";var script=document.createElement("script");script.type="text/javascript";script.text=source;document.head.appendChild(script).parentNode.removeChild(script);var response=Streak[id];delete Streak[id];if(_.has(response,"error")){throw response.error}if(!_.has(response,"result")){throw new Error("appended script did not run")}return response.result}};Streak.evalExpression=function(code){return Streak.newFunction("return ("+code+");")()};Streak.runWithFunctionWrapper=function(func){if(canUseEval){return func()}else{var oldFunction=Function;Function=Streak.newFunction;try{return func()}finally{Function=oldFunction}}};var old_template=_.template;_.template=function(text,data,options){if(data){console.warn("Using _.template without precompilation!")}var _this=this,_args=arguments;return Streak.runWithFunctionWrapper(function(){return old_template.apply(_this,_args)})}})();Streak.Stripe.setPublishableKey(Streak.stripePublishableKey);(function(Streak,window){var _=Streak._;var Eventer=function(){this._eventCBs={},this._isReady=false,this._unReady=false,this._readyFuncs=[],this._readyFuncMap={},this._isLoaded=false,this._loadedFuncs=[],this._loadedFuncMap={},this._triggerActive=true};_.extend(Eventer.prototype,{isReady:function(){return this._isReady},unReady:function(){this._isReady=false;this._unReady=true},resetReady:function(){this._isReady=false;this._unReady=false},ready:function(cb,id){if(this._unReady){return}if(this._isReady){cb()}else{if(id){var oldCB=this._readyFuncMap[id];if(oldCB)this._readyFuncs[this._readyFuncs.indexOf(oldCB)]=cb;else this._readyFuncs.push(cb);this._readyFuncMap[id]=cb}else{this._readyFuncs.push(cb)}}},_runReady:function(){this._isReady=true;this._unReady=false;for(var i=0;this._readyFuncs[i];i++){this._readyFuncs[i]()}this._readyFuncs=[]},isLoaded:function(){return this._isLoaded},onLoad:function(cb,id){if(this._isLoaded){cb()}else{if(id){var oldCB=this._loadedFuncMap[id];if(oldCB)this._loadedFuncs[this._loadedFuncs.indexOf(oldCB)]=cb;else this._loadedFuncs.push(cb);this._loadedFuncMap[id]=cb}else{this._loadedFuncs.push(cb)}}},_runLoad:function(){this._isLoaded=true;for(var i=0;this._loadedFuncs[i];i++){this._loadedFuncs[i]()}this._loadedFuncs=[]},bind:function(event,cb){if(!this._eventCBs[event]){this._eventCBs[event]=[]}this._eventCBs[event].push(cb);var self=this;return function(){self.unbind(event,cb)}},unbind:function(event,cb){if(this._eventCBs[event]&&this._eventCBs[event].length>0){this._eventCBs[event].removeVal(cb)}},trigger:function(event){if(event==="ready"){this._runReady()}if(event==="load"){this._runLoad()}if(this._triggerActive){if(this._eventCBs[event]){var args=_.toArray(arguments).slice(1);var cbs=_.clone(this._eventCBs[event]);this._eventCBs[event].length=0;for(var i=0;i<cbs.length;i++){var cb=cbs[i];var shouldAdd=true;if(cb){try{shouldAdd=!cb.apply(this,args)}catch(err){try{var msg="Error in event";msg+="\n event: "+event;Streak.BentoBox.logError(msg,err)}catch(newErr){console.log(err)}}}else{shouldAdd=false}if(shouldAdd){this._eventCBs[event].push(cb)}}}}},toggleTriggerState:function(state){if(state){this._triggerActive=state}else{this._triggerActive=!this._triggerActive}}});Eventer.create=function(obj){if(!obj){obj={}}var eve=new Eventer;_.extend(eve,obj);return eve};Streak.Eventer=Eventer})(Streak,window);(function(Streak){var CSSStyleManipulator={addRule:function(rule){var stylesheets=Streak.document.styleSheets;var insertedRule=null;var stylesheet=null;if(stylesheets.length==0){var head=head=document.head||document.getElementsByTagName("head")[0];var style=document.createElement("style");style.type="text/css";head.appendChild(style);stylesheets=Streak.document.styleSheets}for(var ii=0;ii<stylesheets.length;ii++){try{stylesheet=stylesheets[ii];insertedRule=stylesheet.insertRule(rule,0);break}catch(err){}}return{stylesheet:stylesheet,rule:insertedRule,destroy:function(){stylesheet.removeRule(rule)}}}};Streak.CSSStyleManipulator=CSSStyleManipulator})(Streak);(function(Streak){var delimiter=",";var delimiterCode=",".charCodeAt(0);Streak.csvParser={parse:function(text,f){var o;return this.parseRows(text,function(row,i){if(o)return o(row,i-1);var a=Streak.newFunction("d","return {"+row.map(function(name,i){return JSON.stringify(name)+": d["+i+"]"}).join(",")+"}");o=f?function(row,i){return f(a(row),i)}:a})},parseRows:function(text,f){var EOL={},EOF={},rows=[],N=text.length,I=0,n=0,t,eol;function token(){if(I>=N)return EOF;if(eol)return eol=false,EOL;var j=I;if(text.charCodeAt(j)===34){var i=j;while(i++<N){if(text.charCodeAt(i)===34){if(text.charCodeAt(i+1)!==34)break;++i}}I=i+2;var c=text.charCodeAt(i+1);if(c===13){eol=true;if(text.charCodeAt(i+2)===10)++I}else if(c===10){eol=true}return text.substring(j+1,i).replace(/""/g,'"')}while(I<N){var c=text.charCodeAt(I++),k=1;if(c===10)eol=true;else if(c===13){eol=true;if(text.charCodeAt(I)===10)++I,++k}else if(c!==delimiterCode)continue;return text.substring(j,I-k)}return text.substring(j)}while((t=token())!==EOF){var a=[];while(t!==EOL&&t!==EOF){a.push(t);t=token()}if(f&&!(a=f(a,n++)))continue;rows.push(a)}return rows}}})(Streak);(function(Streak){var self,DomWatcher;function getAnimationCSSString(selector,animationName){return[selector,"{","animation-duration: 0.001s;","-o-animation-duration: 0.001s;","-ms-animation-duration: 0.001s;","-moz-animation-duration: 0.001s;","-webkit-animation-duration: 0.001s;","animation-name:",animationName,";","-o-animation-name:",animationName,";","-ms-animation-name:",animationName,";","-moz-animation-name:",animationName,";","-webkit-animation-name:",animationName,";","}"].join("")}self=DomWatcher={initialized:false,watchedSelectors:{},animationCallbacks:{},initialize:function(){Streak.document.addEventListener("animationStart",DomWatcher.animationStarted,false);Streak.document.addEventListener("MSAnimationStart",DomWatcher.animationStarted,false);Streak.document.addEventListener("webkitAnimationStart",DomWatcher.animationStarted,false)},watchForNewSelector:function(selector,callback){if(!self.initialized){self.initialize();self.initialized=true}if(!self.watchedSelectors[selector]){self.generateNewSelectorWatch(selector)}self.watchedSelectors[selector].callbacks.push(callback)},generateNewSelectorWatch:function(selector){var animationName=("bb"+Date.now()+"."+Math.random()).replace(/\./gi,"");var animationRule=["@-webkit-keyframes ",animationName," {","from { clip: rect(1px, auto, auto, auto); }"," to { clip: rect(0px, auto, auto, auto); }","}"].join("");Streak.CSSStyleManipulator.addRule(animationRule,0);var animationString=getAnimationCSSString(selector,animationName);Streak.CSSStyleManipulator.addRule(animationString,0);var callbacks=[];self.watchedSelectors[selector]={animationName:animationName,callbacks:callbacks};self.animationCallbacks[animationName]=callbacks},notifyWhenSelectorChanged:function(initialSelector,changeSelector,callback){var animationNameBase=("bb"+Date.now()+"."+Math.random()).replace(/\./gi,"");var animationNameInitial=animationNameBase+"_initial";var animationNameChange=animationNameBase+"_change";Streak.CSSStyleManipulator.addRule(["@-webkit-keyframes ",animationNameInitial," {","from { clip: rect(auto, 0px, auto, auto); }"," to { clip: rect(auto, 1px, auto, auto); }","}"].join(""),0);Streak.CSSStyleManipulator.addRule(getAnimationCSSString(initialSelector,animationNameInitial),0);Streak.CSSStyleManipulator.addRule(["@-webkit-keyframes ",animationNameChange," {","from { clip: rect(auto, 1px, auto, auto); }"," to { clip: rect(auto, 0px, auto, auto); }","}"].join(""),0);Streak.CSSStyleManipulator.addRule(getAnimationCSSString(changeSelector,animationNameChange),0);self.animationCallbacks[animationNameInitial]=[callback];self.animationCallbacks[animationNameChange]=[callback]},notifyAttributeChanged:function(element,attribute,callback){if(!window.MutationObserver){return}var observer=new MutationObserver(function(mutations){for(var ii=0;ii<mutations.length;ii++){if(mutations[ii].attributeName===attribute){callback();return}}});observer.observe(element,{attributes:true});return function(){observer.disconnect()}},animationStarted:function(event){var callbacks=self.animationCallbacks[event.animationName];if(callbacks){var callbackLength=callbacks.length;for(var ii=0;ii<callbackLength;ii++){callbacks[ii](event.target)}}}};Streak.DomWatcher=DomWatcher})(Streak);(function(Streak){var stemWordCache={};var vowelsWithY=/^(.*[aeiouy].*)y$/;var sses=/sses$/;var plusHatS=/^(.+?)([^s])s$/;var re_1a=/^(.+?)eed$/;var re2_1a=/^(.+?)(ed|ing)$/;var re_1b=/^(.+?)eed$/;var re2_1b=/^(.+?)(ed|ing)$/;var re_2=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/;var re_3=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/;var re_4=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;var re2_4=/^(.+?)(s|t)(ion)$/;var re_5=/^(.+?)e$/;var re_5b=/ll$/;var fewVowels=/([^aeiouylsz])\1$/;var someVowels=/^([^aeiou][^aeiouy]*)?[aeiouy]/;var moreVowels=/^[^aeiou][^aeiouy]*[aeiouy][^aeiouwxy]$/;var lotsOfVowels=/^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*/;var tonsOfVowels=/^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*[aeiouy][aeiou]*[^aeiou][^aeiouy]*/;var tonsOfVowelsMaybe=/^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*([aeiouy][aeiou]*)?$/;var generate=/.*generate?s?d?(ing)?$/;var general=/.*general(ly)?$/;var generic=/.*generic(ally)?$/;var generous=/.*generous(ly)?$/;var communit=/.*communit(ies)?y?/;var Stemmer=function(){function i(){}function j(){console.log(Array.prototype.slice.call(arguments).join(" "))}var k={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},l={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""};return function(a,m){var orig=a;if(stemWordCache[a]){return stemWordCache[a]}var d,c,g,b,h,e,f=a;e=m?j:i;if(3>a.length)return a;g=a.substr(0,1);"y"==g&&(a=g.toUpperCase()+a.substr(1));b=sses;c=plusHatS;b.test(a)?(a=a.replace(b,"$1$2"),e("1a",b,a)):c.test(a)&&(a=a.replace(c,"$1$2"),e("1a",c,a));b=re_1a;c=re2_1a;b.test(a)?(c=b.exec(a),b=lotsOfVowels,b.test(c[1])&&(b=/.$/,a=a.replace(b,""),e("1b",b,a))):c.test(a)&&(c=c.exec(a),d=c[1],c=someVowels,c.test(d)&&(a=d,e("1b",c,a),c=/(at|bl|iz)$/,h=fewVowels,d=moreVowels,c.test(a)?(a+="e",e("1b",c,a)):h.test(a)?(b=/.$/,a=a.replace(b,""),e("1b",h,a)):d.test(a)&&(a+="e",e("1b",d,a))));b=vowelsWithY;b.test(a)&&(c=b.exec(a),d=c[1],a=d+"i",e("1c",b,a));b=re_2;b.test(a)&&(c=b.exec(a),d=c[1],c=c[2],b=lotsOfVowels,b.test(d)&&(a=d+k[c],e("2",b,a)));b=re_3;b.test(a)&&(c=b.exec(a),d=c[1],c=c[2],b=lotsOfVowels,b.test(d)&&(a=d+l[c],e("3",b,a)));b=re_4;c=re2_4;b.test(a)?(c=b.exec(a),d=c[1],b=tonsOfVowels,b.test(d)&&(a=d,e("4",b,a))):c.test(a)&&(c=c.exec(a),d=c[1]+c[2],c=tonsOfVowels,c.test(d)&&(a=d,e("4",c,a)));b=re_5;if(b.test(a)&&(c=b.exec(a),d=c[1],b=tonsOfVowels,c=tonsOfVowelsMaybe,h=moreVowels,b.test(d)||c.test(d)&&!h.test(d)))a=d,e("5",b,c,h,a);b=re_5b;c=tonsOfVowels;b.test(a)&&c.test(a)&&(b=/.$/,a=a.replace(b,""),e("5",b,c,a));"y"==g&&(a=g.toLowerCase()+a.substr(1));g={skis:"ski",skies:"sky",dying:"die",lying:"lie",tying:"tie",idly:"idl",gently:"gentl",ugly:"ugli",early:"earli",only:"onli",singly:"singl"};g[f]!=={}[f]&&(a=g[f],e("Special Word",a));-1!=="sky news howe atlas cosmos bias          andes inning outing canning herring          earring proceed exceed succeed".indexOf(f)&&(a=f,e("Special Word",a));b=generate;b.test(f)&&(a+="at",e("Overstemmed",a));b=general;b.test(f)&&(a+="al",e("Overstemmed",a));b=generic;b.test(f)&&(a+="ic",e("Overstemmed",a));b=generous;b.test(f)&&(a+="ous",e("Overstemmed",a));b=communit;b.test(f)&&(a+="iti",e("Overstemmed",a));stemWordCache[orig]=a;return a}}();Stemmer.clearWordCache=function(){stemWordCache={}};Streak.Stemmer=Stemmer})(Streak);(function(Streak){var DependencyManagerClass=function(){this._mapOfFinishedFunctionKeys={};this._mapOfFunctionKeysToFunctionQueues={}};Streak._.extend(DependencyManagerClass.prototype,{addFunction:function(functionParameters){if(this._doesAddingThisFunctionCauseACycle(functionParameters)){throw new Error("cycle this",functionParameters)}if(this._shouldRunFunction(functionParameters)){this._runFunction(functionParameters)}else{this._queueFunctionParameters(functionParameters)}},notifyFunctionFinished:function(functionKey){this._mapOfFinishedFunctionKeys[functionKey]=true;this._checkDependentFunctions(functionKey)},_doesAddingThisFunctionCauseACycle:function(functionParameters,currentFunctionKeyGraph){currentFunctionKeyGraph=currentFunctionKeyGraph||[];var functionKey=functionParameters.functionKey;if(!functionKey){return true}var dependentFunctionKeys=functionParameters.dependentFunctionKeys;if(!dependentFunctionKeys){return false}var queuedFunctions=this._mapOfFunctionKeysToFunctionQueues[functionKey];if(!queuedFunctions||queuedFunctions.length===0){return false}if(currentFunctionKeyGraph.indexOf(functionKey)>-1){return true}currentFunctionKeyGraph.push(functionKey);for(var ii=0;ii<queuedFunctions.length;ii++){var queuedFunction=queuedFunctions[ii];if(this._doesAddingThisFunctionCauseACycle(queuedFunction,currentFunctionKeyGraph.slice(0))){return true}}return false},_shouldRunFunction:function(functionParameters){return!this._mapOfFinishedFunctionKeys[functionParameters.functionKey]&&this._haveAllDependentFunctionsFinished(functionParameters)},_haveAllDependentFunctionsFinished:function(functionParameters){var dependentFunctionKeys=functionParameters.dependentFunctionKeys;if(!dependentFunctionKeys){return true}var anyUnfinishedFunctions=false;for(var ii=0;ii<dependentFunctionKeys.length;ii++){anyUnfinishedFunctions=anyUnfinishedFunctions||!this._mapOfFinishedFunctionKeys[dependentFunctionKeys[ii]]}if(anyUnfinishedFunctions){return false}else{return true}},_runFunction:function(functionParameters){if(functionParameters.functionReference){this._runFunctionInNewWay(functionParameters);return}var functionToCall=functionParameters.functionToCall;var functionKey=functionParameters.functionKey;var functionContext=functionParameters.functionContext;var self=this;if(!functionToCall||!functionKey){return}try{var functionNotCompleteTimeout=setTimeout(function(){Streak.BentoBox.logError("function timed out",functionKey)},60*1e3);functionToCall.call(functionContext,function(){clearTimeout(functionNotCompleteTimeout);self._mapOfFinishedFunctionKeys[functionKey]=true;self._checkDependentFunctions(functionKey)})}catch(err){if(functionNotCompleteTimeout){clearTimeout(functionNotCompleteTimeout)}console.error("Dependency Manager. Error in:",functionKey,functionParameters,err.stack);Streak.BentoBox.logError("Dependency Manager, error in run function "+functionKey,err)}},_runFunctionInNewWay:function(functionParameters){var self=this;var functionReference=functionParameters.functionReference;var functionKey=functionParameters.functionKey;var functionContext=functionParameters.functionContext;if(!functionReference||!functionKey){return}try{var promise=functionReference.call(functionContext);if(!promise){this._mapOfFinishedFunctionKeys[functionKey]=true;this._checkDependentFunctions(functionKey);return}var functionNotCompleteTimeout=setTimeout(function(){Streak.BentoBox.logError("function timed out",functionKey)},60*1e3);promise.then(function(){clearTimeout(functionNotCompleteTimeout);self._mapOfFinishedFunctionKeys[functionKey]=true;self._checkDependentFunctions(functionKey)},function(err){clearTimeout(functionNotCompleteTimeout);Streak.BentoBox.logError("Dependency Manager, async error in function "+functionKey,err)})}catch(err){if(functionNotCompleteTimeout){clearTimeout(functionNotCompleteTimeout)}console.error("Dependency Manager. Error in:",functionKey,functionParameters,err.stack);Streak.BentoBox.logError("Dependency Manager, error in run function "+functionKey,err)}},_checkDependentFunctions:function(functionKey){var dependentFunctionParametersQueue=this._mapOfFunctionKeysToFunctionQueues[functionKey];if(!dependentFunctionParametersQueue){return false}for(var ii=0;ii<dependentFunctionParametersQueue.length;ii++){var functionParameters=dependentFunctionParametersQueue[ii];if(this._shouldRunFunction(functionParameters)){this._runFunction(functionParameters)}}},_queueFunctionParameters:function(functionParameters){var dependentFunctionKeys=functionParameters.dependentFunctionKeys;if(!dependentFunctionKeys){return}for(var ii=0;ii<dependentFunctionKeys.length;ii++){var dependentFunctionKey=dependentFunctionKeys[ii];this._addFunctionParametersToRespectiveFunctionQueue(dependentFunctionKey,functionParameters)}},_addFunctionParametersToRespectiveFunctionQueue:function(dependentFunctionKey,functionParameters){var functionParameterQueue=this._mapOfFunctionKeysToFunctionQueues[dependentFunctionKey];if(!functionParameterQueue){functionParameterQueue=[];this._mapOfFunctionKeysToFunctionQueues[dependentFunctionKey]=functionParameterQueue}functionParameterQueue.push(functionParameters)}});Streak.DependencyManager=new DependencyManagerClass})(Streak);(function(Streak){var _=Streak._;ObjectPath={create:function(objString){return new ObjectPath.impl(objString)},impl:function(inObjString){var retObj={},obj=null,objString=inObjString;if(objString){try{obj=JSON.parse(objString)}catch(err){}}if(!obj){obj={}}retObj.get=function(path){var parts=path.split("/");var prop=obj[parts[0]];for(var i=1;i<parts.length;i++){if(!prop){return null}prop=prop[parts[i]]}return prop};retObj.set=function(path,value){var parts=path.split("/");if(parts.length===1){obj[parts[0]]=value}else if(parts.length>1){var oprop=obj[parts[0]];if(!oprop){oprop={}}var prop=oprop;for(var i=1;i<parts.length-1;i++){var newProp=prop[parts[i]];if(!newProp){newProp={};prop[parts[i]]=newProp}prop=newProp}prop[_.last(parts)]=value;obj[parts[0]]=oprop}};retObj.remove=function(path){var parts=path.split("/");var prop=null;for(var i=0;i<parts.length-1;i++){prop=obj[prop[i]];if(!prop){return}}delete prop[parts.length-1]};retObj.toString=function(){return JSON.stringify(obj)};retObj.object=obj;return retObj}};Streak.ObjectPath=ObjectPath})(Streak);(function(Streak){var Date=Streak.Date,RSVP=Streak.RSVP,$=Streak.$,_=Streak._;Streak.Utils={};Date.prototype.getTimezoneOffsetInMilli=function(){return(new Date).getTimezoneOffset()*-60*1e3};Date.prototype.toLocalTime=function(){this.setTime(this.getTime()+this.getTimezoneOffsetInMilli())};Date.prototype.toGMT=function(){this.setTime(this.getTime()-this.getTimezoneOffsetInMilli())};Date.prototype.getGmailFormatted=function(isShort){var dt=this;var now=new Date;var diff=(now.getTime()-dt.getTime())/(1e3*60*60);var dv;if(diff<12){dv=(dt.getHours()==12?"12":dt.getHours()%12)+":"+(dt.getMinutes()>9?dt.getMinutes():"0"+dt.getMinutes())+(isShort?"":" ")+(dt.getHours()>11?isShort?"p":"pm":isShort?"a":"am")}else{var parts=dt.toDateString().split(" ");dv=parts[1]+" "+parts[2]+(diff/24/30>6?" "+dt.getFullYear():"")}return dv};Date.addOutputFormat({token:"tzshort",format:function(d,loc,n,format){var dstring=d.toString();if(dstring.indexOf("(")>-1){var tzParts=d.toString().split("(")[1].split(" ");if(tzParts.length>1){return tzParts.map(function(word){return word.at(0).capitalize()}).join("")}else{return tzParts[0].split(")")[0]}}return""}});Date.addOutputFormat({token:"mmshort",format:function(d,loc,n,format){if(d.getMinutes()===0){return""}else{var s=d.getMinutes();if(s<10){s="0"+s}return":"+s}}});var dateLocale="en";var dateOutputFormats={en:{"export":"{MM}/{dd}/{year} {hh}:{mm}:{ss} {TT} {tzshort}",shortWithWeekday:"{Dow} {MM}/{day}/{yy} {h}:{mm}{tt}",shortDate:"{MM}/{dd}/{yy}",shortFormat:"{MM}/{dd}/{yy} {h}{mmshort}{tt}",longDateTime:"{Weekday} {Month} {ord}, {year} {h}:{mm}{tt}",longWithTimezone:"{Weekday} {Month} {ord}, {year} {h}:{mm}{tt} {tzshort}",inputDateTime:"{Month} {ord}, {year} {h}:{mm}{tt}",inputDate:"{Month} {ord}, {year}",pixelTrack:"{h}:{mm}{tt} on {Month} {ord}, {year}",shortTime:"{12hr}:{mm} {TT}"},other:{"export":"{MM}/{dd}/{year} {hh}:{mm}:{ss} {TT} {tzshort}",shortDate:"{dd}/{MM}/{yy}",shortWithWeekday:"{Dow} {day}/{MM}/{yy} {h}:{mm}{tt}",shortFormat:"{dd}/{MM}/{yy} {h}{mmshort}{tt}",longDateTime:"{Weekday} {Month} {ord}, {year} {h}:{mm}{tt}",longWithTimezone:"{Weekday} {Month} {ord}, {year} {h}:{mm}{tt} {tzshort}",pixelTrack:"{h}:{mm}{tt} on {Month} {ord}, {year}",inputDateTime:"{Month} {ord}, {year} {h}:{mm}{tt}",inputDate:"{Month} {ord}, {year}",shortTime:"{12hr}:{mm} {TT}"}};Date.extend({setFormatLocale:function(locale){dateLocale=locale},customFormat:function(format){return this.format(dateOutputFormats[dateLocale][format])},isBetweenBeginningInclusive:function(d1,d2,buffer){var t=this.getTime();var t1=Date.create(d1).getTime();var t2=Date.create(d2).getTime();var lo=Math.min(t1,t2);var hi=Math.max(t1,t2);buffer=buffer||0;return lo-buffer<=t&&hi+buffer>t},resetTime:function(){this.reset()}});var oldCreate=Date.create;Date.extend({ccreate:function(s){if(s&&s.replace){s=s.replace(/(^|\s)noon($|\s)/,"$112pm$2").replace(/(^|\s)midnight($|\s)/,"$112am$2")}if(s&&s.match&&s.match(/^-?\d+$/)){return oldCreate(parseInt(s,10))}else{return oldCreate(s)}}},false,false);Date.create=function(s){if(s&&s.replace){s=s.replace(/(^|\s)noon($|\s)/,"$112pm$2").replace(/(^|\s)midnight($|\s)/,"$112am$2")}if(s&&s.match&&s.match(/^\d+\/\d+$/)){s=s+"/"+(new Date).getFullYear()}if(s&&s.match&&s.match(/^\w+\s+\d+\s*$/)){return oldCreate(s)}var d=new Date(s);if(!d.getTime()){try{if(s&&s.match&&s.match(/^-?\d+$/)){d=new Date(parseInt(s,10))}}catch(err){}if(!d||!d.getTime()){d=oldCreate(s)}}return d};Streak.Utils.RegExpQuote=function(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")};Array.prototype.remove=function(from,to){if(Streak._.isNotReal(from)&&Streak._.isNotReal(to)){return}var rest=this.slice((to||from)+1||this.length);this.length=from<0?this.length+from:from;return this.push.apply(this,rest)};Array.prototype.removeVal=function(val){var index=this.indexOf(val);if(index>-1)this.remove(index)};Array.prototype.unique=function(idfunc){var hash={};var out=[];for(var i=0,len=this.length;i<len;i++){var id=this[i].toString();if(idfunc){id=idfunc(this[i])}if(!hash[id]){out.push(this[i]);hash[id]=1}}return out};if(typeof String.prototype.capitalize!=="function"){String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}}String.prototype.isValidEmail=function(){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return this.match(re)};if(typeof String.prototype.startsWith!="function"){String.prototype.startsWith=function(str){return this.slice(0,str.length)==str}}if(typeof String.prototype.endsWith!="function"){String.prototype.endsWith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1}}if(typeof String.prototype.stripNonPrintableCharacters!="function"){var stripRegEx=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g;String.prototype.stripNonPrintableCharacters=function(){return this.replace(stripRegEx,"")}}Streak.Utils.removePrefix=function(string,prefix){if(string.startsWith(prefix)){return string.slice(prefix.length)}else{throw new Error("removePrefix can only be called when string.startsWith(prefix)")}};Streak.Utils.removeSuffix=function(string,suffix){if(string.endsWith(suffix)){return string.slice(0,-suffix.length)}else{throw new Error("removeSuffix can only be called when string.endsWith(suffix)")}};String.prototype.sample=function(num){var s="";for(var i=0,l=this.length;i<l;i++){if(i%num===0)s+=this[i]}return s};if(!String.prototype.has){String.prototype.has=function(s){return this.indexOf(s)>-1
}}if(!String.prototype.replaceAmpCodes){String.prototype.replaceAmpCodes=function(){return this.replace(/\&\#(\d+)\;/,function(match,group){return String.fromCharCode(group)})}}function createGrid(rows,columns){var grid=new Array(rows);for(var i=0;i<rows;i++){grid[i]=new Array(columns);for(var j=0;j<columns;j++){grid[i][j]=0}}return grid}String.prototype.intersectionLength=function(bString,noSpace){if(!this||!bString){return 0}var a=this.toLowerCase();var b=bString.toLowerCase();if(noSpace){a=a.replace(/\s/gim,"");b=b.replace(/\s/gim,"")}var grid=createGrid(this.length,b.length);var lcs=0;for(var i=0;i<a.length;i++){for(var j=0;j<b.length;j++){if(grid[i]&&grid[i].length>0){if(a[i]===b[j]){if(i===0||j===0){grid[i][j]=1}else{grid[i][j]=grid[i-1][j-1]+1}if(lcs<grid[i][j]){lcs=grid[i][j]}}else{grid[i][j]=0}}}}return lcs};String.prototype.intersectionRatio=function(b){if(!b){b=""}if(this.length+b.length===0){return 0}var length=this.intersectionLength(b);return length/(this.length+b.length)};if(!String.prototype.removeWhitespace){String.prototype.removeWhitespace=function(){return this.replace(/\s/gi,"").replace(/\xAO/gi,"")}}Streak.Utils.Operators={"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"^":function(a,b){return a^b},"&":function(a,b){return a&b},"|":function(a,b){return a|b},"<<":function(a,b){return a<<b},">>":function(a,b){return a>>b},">>>":function(a,b){return a>>>b},"~":function(a){return~a},"!":function(a){return!a},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"<":function(a,b){return a<b},">":function(a,b){return a>b},"<=":function(a,b){return a<=b},">=":function(a,b){return a>=b},"==":function(a,b){return a==b},"!=":function(a,b){return a!=b},"===":function(a,b){return a===b},"!==":function(a,b){return a!==b},"in":function(a,b){return a in b},contains:function(a,b){return _.contains(a,b)},"?":function(a,b,c){return a?b:c}};Streak.Utils.randomString=function(length){var s="";for(var ii=0;ii<length;ii++){s+=String.fromCharCode(Math.round((90-65)*Math.random())+65)}return s};Streak.searchObject=function(element,query,maxDepth,caseInsensitive,exactMatch){var _=Streak._;var retVal=[];var initialNode={el:element,path:"",depth:0};var nodeList=[initialNode];if(caseInsensitive){query=query.toLowerCase()}while(nodeList.length>0){var node=nodeList.pop();if(node.depth<=maxDepth){try{var keys=Object.keys(node.el);if(keys.length>0){for(var i=0;i<keys.length;i++){var key=keys[i];var newNode={el:node.el[key],path:node.path+"/"+key,depth:node.depth+1};nodeList.push(newNode)}}}catch(err){var toFind=node.el+"";if(caseInsensitive){toFind=toFind.toLowerCase()}if(exactMatch){if(toFind===query){retVal.push(node)}}else{if(toFind.indexOf(query)>-1){retVal.push(node)}}}}}return retVal};Streak.calculateLevinshtein=function(source,target,hashName){var row,col,ops;if(!source){source=[]}if(!target){target=[]}var grid=createGrid(source.length+1,target.length+1);for(row=0;row<grid.length;row++){ops=[];if(row>0){ops=grid[row-1][0].ops.concat({opCode:"delete",i:row,j:0})}grid[row][0]={num:row,ops:ops}}for(col=0;col<grid[0].length;col++){ops=[];if(col>0){ops=grid[0][col-1].ops.concat({opCode:"insert",i:0,j:col})}grid[0][col]={num:col,ops:ops}}for(i=1;i<source.length+1;i++){for(var j=1;j<target.length+1;j++){var sourceVal=hashName?source[i-1][hashName]():source[i-1];var targetVal=hashName?target[j-1][hashName]():target[j-1];if(sourceVal===targetVal){grid[i][j]=grid[i-1][j-1]}else{var deletion=grid[i-1][j].num+1;var insertion=grid[i][j-1].num+1;var substitution=grid[i-1][j-1].num+1;if(deletion<insertion&&deletion<substitution){grid[i][j]={num:deletion,ops:grid[i-1][j].ops.concat({opCode:"delete",i:i,j:j})}}else if(insertion<substitution){grid[i][j]={num:insertion,ops:grid[i][j-1].ops.concat({opCode:"insert",i:i,j:j})}}else{grid[i][j]={num:substitution,ops:grid[i-1][j-1].ops.concat({opCode:"sub",i:i,j:j})}}}}}return grid};Streak.calculateFastLevinshteinWithEqualsFunc=function(source,target,equalsFunc){var ops=[],i;var sourceIndex=0;var targetIndex=0;var deleteChainLength=function(){if(equalsFunc(source[sourceIndex+1],target[targetIndex])){return 1}else{return-1}};var insertChainLength=function(){if(equalsFunc(source[sourceIndex],target[targetIndex+1])){return 1}else{return-1}};for(sourceIndex=0;sourceIndex<source.length;){if(targetIndex>=target.length){break}if(equalsFunc(source[sourceIndex],target[targetIndex])){targetIndex++;sourceIndex++}else{var deleteChain=deleteChainLength();if(deleteChain>0){for(i=0;i<deleteChain;i++){ops.push({opCode:"delete",i:sourceIndex,j:targetIndex});sourceIndex++}}else{var insertChain=insertChainLength();if(insertChain>0){for(i=0;i<insertChain;i++){ops.push({opCode:"insert",i:sourceIndex,j:targetIndex});targetIndex++}}else{ops.push({opCode:"sub",i:sourceIndex,j:targetIndex});targetIndex++;sourceIndex++}}}}for(;targetIndex<target.length;targetIndex++){ops.push({opCode:"insert",i:sourceIndex,j:targetIndex})}for(;sourceIndex<source.length;sourceIndex++){ops.push({opCode:"delete",i:sourceIndex,j:Math.min(targetIndex,target.length-1)})}return ops};Streak.calculateSift3=function(s1,s2){if(s1===null||s1.length===0){if(s2===null||s2.length===0){return 0}else{return s2.length}}if(s2===null||s2.length===0){return s1.length}var c=0;var offset1=0;var offset2=0;var lcs=0;var maxOffset=5;while(c+offset1<s1.length&&c+offset2<s2.length){if(s1[c+offset1]==s2[c+offset2]){lcs++}else{offset1=offset2=0;for(var i=0;i<maxOffset;i++){if(c+i<s1.length&&s1[c+i]==s2[c]){offset1=i;break}if(c+i<s2.length&&s1[c]==s2[c+i]){offset2=i;break}}}c++}return(s1.length+s2.length)/2-lcs};Streak.calculateFastLevinshteinFinal=function(source,target){return Streak.calculateFastLevinshtein(source,target).length};Streak.calculateFastLevinshtein=function(source,target){return Streak.calculateFastLevinshteinWithEqualsFunc(source,target,function(a,b){return a===b})};Streak.genericEquals=function(a,b){var attr;if(a===undefined||b===undefined&&a!=b){return a==b}var seen={};for(attr in a){if(!b.hasOwnProperty(attr)||a[attr]!==b[attr]){return false}}for(attr in b){if(!a.hasOwnProperty(attr)){return false}}return true};Streak.cleanupEmailSubject=function(subject){var res=subject||"";res=res.trim();if(res.substring(0,3).match(/re:/i)){res=res.substring(3)}else if(res.substring(0,4).match(/fwd:/i)){res=res.substring(4)}res=res.replace(/[ ]{2,}/g," ");res=res.trim();if(res.length>90){res=res.substring(0,87)+"..."}return res.toLowerCase()};Streak.Utils.stripHTMLFromString=function(html){return html.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi,"").replace(/(\s)\s+/gim,"$1")};if(!JSON.compare){JSON.compare=function(obj,otherObj){try{return JSON.stringify(obj)===JSON.stringify(otherObj)}catch(err){return false}}}if(!JSON.isEqual){JSON.isEqual=function(obj,otherObj){return JSON.compare(obj,otherObj)}}if(!JSON.parseCompare){JSON.parseCompare=function(obj,otherObj){try{return JSON.compare(JSON.parse(obj),JSON.parse(otherObj))}catch(err){return false}}}if(!JSON.deepClone){JSON.deepClone=function(obj){if(obj){return JSON.parse(JSON.stringify(obj))}return obj}}Streak.createEl=function(type,inner){var d=document.createElement(type);if(inner){d.innerHTML=inner}return d};window.isNumber=function(input){return input-0==input&&input.length>0};Streak.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};Streak.Utils.signedNumber=function(n){return n>0?"+"+n:n};Streak.Utils.fileSizeFormat=function(bytes){var units=["B","KB","MB","GB","TB","PB","EB","ZB","YB"];var i=0,size=bytes;while(size>=1024){size/=1024;++i}return(+size).toFixed(1)+" "+units[i]};Streak.Utils.reverseComparisonFn=function(compareFn){return _.compose(function(x){return-x},compareFn)};Streak.Utils.makeComparisonByFn=function(compareBy){var iterator;if(_.isFunction(compareBy)){iterator=compareBy}else{iterator=function(o){return o[compareBy]}}return function(a,b){var vA=iterator(a)||0,vB=iterator(b)||0;if(vA==vB){return 0}else{return vA<vB?-1:1}}};Streak.Utils.combineComparisonFns=function(comparisonFns){return _.reduceRight(comparisonFns,function(fnA,fnB){return function(a,b){var resultB=fnB(a,b);if(resultB){return resultB}else{return fnA(a,b)}}},function(a,b){return 0})};if(Streak.$){Streak.Utils.decodeHTMLEntities=function(html){html=html.replace(/</g,"&lt;").replace(/>/g,"&gt;");return $("<div/>").html(html).text()}}else{Streak.Utils.decodeHTMLEntities=require("entities").decodeHTML}Streak.Utils.parseTagAttributes=function(attrString){var attrs={};var attrNameMatch;while(attrNameMatch=attrString.match(/^\s*([^<>\s=]+)\s*/)){attrString=attrString.slice(attrNameMatch[0].length);var attrName=attrNameMatch[1];if(attrString[0]!="="){attrs[attrName]=""}else{var valueMatch=attrString.match(/^=\s*"([^"]*)"/)||attrString.match(/^=\s*'([^']*)'/)||attrString.match(/^=\s*(\S+)/);if(!valueMatch){throw new Error("Could not parse value")}attrString=attrString.slice(valueMatch[0].length);var value=Streak.Utils.decodeHTMLEntities(valueMatch[1]);attrs[attrName]=value}}if(attrString.trim().length){throw new Error("Could not parse entire attributes string")}return attrs};Streak.Utils.writeTagAttributes=function(attrs){var attrString=" ";_.each(attrs,function(value,name){if(name.match(/[\s<>='"]/)){throw new Error("Invalid symbol in attribute name: "+name)}attrString+=_.escape(name)+'="'+_.escape(value)+'" '});return attrString};Streak.Utils.wait=function(time){return new Streak.RSVP.Promise(function(resolve,reject){setTimeout(resolve,time)})};Streak.Utils.waitFor=function(condition,timeout,steptime){return new Streak.RSVP.Promise(function(resolve,reject){if(!timeout){timeout=60*1e3}if(!steptime){steptime=250}var waited=0;var timeoutError=new Error("waitFor timeout");function step(){try{if(condition()){resolve()}else{if(waited>=timeout){reject(timeoutError)}else{waited+=steptime;setTimeout(step,steptime)}}}catch(e){reject(e)}}setTimeout(step,1)})};Streak.Utils.timeout=function(promise,time){return new RSVP.Promise(function(resolve,reject){var timer=setTimeout(reject,time,new Error("Timed out"));promise.then(function(result){clearTimeout(timer);resolve(result)},function(err){clearTimeout(timer);reject(err)})})};Streak.Utils.getStackTrace=function(){var err=new Error("Stack saver");if(typeof err.stack!=="string")return err.stack;return err.stack.replace(/^([^\n]*\n){2}/,"")};Streak.Utils.escapeAngleBrackets=function(string){if(string&&string.replace){return string.replace(/</g,"&lt;").replace(/>/g,"&gt;")}return string};Streak.Utils.decodeGmailURLSearchString=function(urlSearchTerm){urlSearchTerm=(urlSearchTerm||"").replace(/\+/gim," ");urlSearchTerm=decodeURIComponent(urlSearchTerm);return urlSearchTerm};Streak.Utils.loadScript=function(url){var script=document.createElement("script");script.type="text/javascript";var promise=new Streak.RSVP.Promise(function(resolve,reject){script.addEventListener("error",function(event){reject(event.error||new Error(event.message||"Load failure",event.filename,event.lineno,event.column))},false);script.addEventListener("load",_.defer.bind(_,resolve),false)});script.src=url;document.head.appendChild(script);return promise};Streak.Utils.isDeepEquals=function(item1,item2){if(Streak._.isArray(item1)&&Streak._.isArray(item2)){for(var ii=0;ii<item1.length;ii++){if(!Streak.Utils.isDeepEquals(item1[ii],item2[ii])){return false}}return true}else if(Streak._.isObject(item1)&&Streak._.isObject(item2)){for(var property in item1){if(!Streak.Utils.isDeepEquals(item1[property],item2[property])){return false}}return true}else{return item1==item2}return true}})(Streak);Streak.Utils.stringScore=function(string,word,fuzziness){if(string==word)return 1;if(word=="")return 0;var runningScore=0,charScore,finalScore,lString=string.toLowerCase(),strLength=string.length,lWord=word.toLowerCase(),wordLength=word.length,idxOf,startAt=0,fuzzies=1,fuzzyFactor;if(fuzziness)fuzzyFactor=1-fuzziness;if(fuzziness){for(var i=0;i<wordLength;++i){idxOf=lString.indexOf(lWord[i],startAt);if(-1===idxOf){fuzzies+=fuzzyFactor;continue}else if(startAt===idxOf){charScore=.7}else{charScore=.1;if(string[idxOf-1]===" ")charScore+=.8}if(string[idxOf]===word[i])charScore+=.1;runningScore+=charScore;startAt=idxOf+1}}else{for(var i=0;i<wordLength;++i){idxOf=lString.indexOf(lWord[i],startAt);if(-1===idxOf){return 0}else if(startAt===idxOf){charScore=.7}else{charScore=.1;if(string[idxOf-1]===" ")charScore+=.8}if(string[idxOf]===word[i])charScore+=.1;runningScore+=charScore;startAt=idxOf+1}}finalScore=.5*(runningScore/strLength+runningScore/wordLength)/fuzzies;if(lWord[0]===lString[0]&&finalScore<.85){finalScore+=.15}return finalScore};(function(window){var StateMachine={VERSION:"2.0.0",create:function(cfg,target){var name;var initial=typeof cfg.initial=="string"?{state:cfg.initial}:cfg.initial;var fsm=target||cfg.target||{};var events=cfg.events||[];var callbacks=cfg.callbacks||{};var map={};var add=function(e){var from=e.from instanceof Array?e.from:[e.from];map[e.name]=map[e.name]||{};for(var n=0;n<from.length;n++)map[e.name][from[n]]=e.to};if(initial){initial.event=initial.event||"startup";add({name:initial.event,from:"none",to:initial.state})}for(var n=0;n<events.length;n++)add(events[n]);for(name in map){if(map.hasOwnProperty(name))fsm[name]=StateMachine.buildEvent(name,map[name])}for(name in callbacks){if(callbacks.hasOwnProperty(name))fsm[name]=callbacks[name]}fsm.current="none";fsm.is=function(state){return this.current==state};fsm.can=function(event){return!!map[event][this.current]&&!this.transition};fsm.cannot=function(event){return!this.can(event)};if(initial&&!initial.defer)fsm[initial.event]();return fsm},beforeEvent:function(name,from,to,args){var func=this["onbefore"+name];if(func)return func.apply(this,[name,from,to].concat(args))},afterEvent:function(name,from,to,args){var func=this["onafter"+name]||this["on"+name];if(func)return func.apply(this,[name,from,to].concat(args))},leaveState:function(name,from,to,args){var func=this["onleave"+from];if(func)return func.apply(this,[name,from,to].concat(args))},enterState:function(name,from,to,args){var func=this["onenter"+to]||this["on"+to];if(func)return func.apply(this,[name,from,to].concat(args))},changeState:function(name,from,to,args){var func=this["onchangestate"];if(func)return func.apply(this,[name,from,to].concat(args))},buildEvent:function(name,map){return function(){if(this.transition){console.log("event "+name+" innapropriate because previous transition did not complete");return}if(this.cannot(name)){console.log("event "+name+" innapropriate in current state "+this.current);return}var from=this.current;var to=map[from];var args=Array.prototype.slice.call(arguments);if(false===StateMachine.beforeEvent.call(this,name,from,to,args))return;var self=this;this.transition=function(){self.transition=null;self.current=to;StateMachine.enterState.call(self,name,from,to,args);StateMachine.changeState.call(self,name,from,to,args);StateMachine.afterEvent.call(self,name,from,to,args)};if(false!==StateMachine.leaveState.call(this,name,from,to,args)){if(this.transition)this.transition()}}}};window.Streak.StateMachine=StateMachine})(window);(function(Streak){var B64={alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",urlSafeAlphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",lookup:null,ie:/MSIE /.test(navigator.userAgent),ieo:/MSIE [67]/.test(navigator.userAgent),encode:function(s){var buffer=B64.toUtf8(s),position=-1,len=buffer.length,nan0,nan1,nan2,enc=[,,,];if(B64.ie){var result=[];while(++position<len){nan0=buffer[position];nan1=buffer[++position];enc[0]=nan0>>2;enc[1]=(nan0&3)<<4|nan1>>4;if(isNaN(nan1))enc[2]=enc[3]=64;else{nan2=buffer[++position];enc[2]=(nan1&15)<<2|nan2>>6;enc[3]=isNaN(nan2)?64:nan2&63}result.push(B64.alphabet.charAt(enc[0]),B64.alphabet.charAt(enc[1]),B64.alphabet.charAt(enc[2]),B64.alphabet.charAt(enc[3]))}return result.join("")}else{var result="";while(++position<len){nan0=buffer[position];nan1=buffer[++position];enc[0]=nan0>>2;enc[1]=(nan0&3)<<4|nan1>>4;if(isNaN(nan1))enc[2]=enc[3]=64;else{nan2=buffer[++position];enc[2]=(nan1&15)<<2|nan2>>6;enc[3]=isNaN(nan2)?64:nan2&63}result+=B64.alphabet[enc[0]]+B64.alphabet[enc[1]]+B64.alphabet[enc[2]]+B64.alphabet[enc[3]]}return result}},decode:function(s){if(s.length%4)throw new Error("InvalidCharacterError: 'B64.decode' failed: The string to be decoded is not correctly encoded.");var buffer=B64.fromUtf8(s),position=0,len=buffer.length;if(B64.ieo){var result=[];while(position<len){if(buffer[position]<128)result.push(String.fromCharCode(buffer[position++]));else if(buffer[position]>191&&buffer[position]<224)result.push(String.fromCharCode((buffer[position++]&31)<<6|buffer[position++]&63));else result.push(String.fromCharCode((buffer[position++]&15)<<12|(buffer[position++]&63)<<6|buffer[position++]&63))}return result.join("")}else{var result="";while(position<len){if(buffer[position]<128)result+=String.fromCharCode(buffer[position++]);else if(buffer[position]>191&&buffer[position]<224)result+=String.fromCharCode((buffer[position++]&31)<<6|buffer[position++]&63);else result+=String.fromCharCode((buffer[position++]&15)<<12|(buffer[position++]&63)<<6|buffer[position++]&63)}return result}},toUtf8:function(s){var position=-1,len=s.length,chr,buffer=[];if(/^[\x00-\x7f]*$/.test(s))while(++position<len)buffer.push(s.charCodeAt(position));else while(++position<len){chr=s.charCodeAt(position);if(chr<128)buffer.push(chr);else if(chr<2048)buffer.push(chr>>6|192,chr&63|128);else buffer.push(chr>>12|224,chr>>6&63|128,chr&63|128)}return buffer},fromUtf8:function(s){var position=-1,len,buffer=[],enc=[,,,];var alphabet=B64.alphabet;var lookup="lookup";if(s.indexOf("-")>-1||s.indexOf("_")>-1){alphabet=B64.urlSafeAlphabet;lookup="urlSafeLookup"}if(!B64[lookup]){len=B64.alphabet.length;B64[lookup]={};while(++position<len)B64[lookup][alphabet.charAt(position)]=position;position=-1}len=s.length;while(++position<len){enc[0]=B64[lookup][s.charAt(position)];enc[1]=B64[lookup][s.charAt(++position)];buffer.push(enc[0]<<2|enc[1]>>4);enc[2]=B64[lookup][s.charAt(++position)];if(enc[2]==64)break;buffer.push((enc[1]&15)<<4|enc[2]>>2);enc[3]=B64[lookup][s.charAt(++position)];if(enc[3]==64)break;buffer.push((enc[2]&3)<<6|enc[3])}return buffer}};Streak.B64=B64})(Streak);(function(Streak){var _=Streak._;var PROMISE_STATE={FULFILLED:"FULFILLED",REJECTED:"REJECTED",PENDING:"PENDING",CANCELLED:"CANCELLED"};var Promise=function(callback){this._successCallbacks=[];this._failureCallbacks=[];this._doneCallbacks=[];this._state=PROMISE_STATE.PENDING;this._result=undefined;this._creationStack=Streak.Utils.getStackTrace();callback(this._resolve.bind(this),this._reject.bind(this))};Streak._.extend(Promise.prototype,{_resolve:function(result){if(this._state===PROMISE_STATE.PENDING){this._state=PROMISE_STATE.FULFILLED;this._result=result;var _this=this;setTimeout(function(){_this._notify(_this._successCallbacks,true);_this._notify(_this._doneCallbacks);_this._clearCallbacks()},0)}},_reject:function(result){if(this._state===PROMISE_STATE.PENDING){this._state=PROMISE_STATE.REJECTED;this._result=result;var _this=this;setTimeout(function(){_this._notify(_this._failureCallbacks,true);_this._notify(_this._doneCallbacks);_this._clearCallbacks()},0)}},_notify:function(callbackArray,passResult){if(!callbackArray){return}for(var ii=0;ii<callbackArray.length;ii++){var callback=callbackArray[ii];if(passResult)callback(this._result);else callback()}},_clearCallbacks:function(){delete this._successCallbacks;delete this._failureCallbacks;delete this._doneCallbacks},_callCallback:function(callback,result){if(this._state===PROMISE_STATE.CANCELLED){return}callback(result)},then:function(successCallback,failureCallback){if(this._state===PROMISE_STATE.PENDING){if(successCallback){this._successCallbacks.push(successCallback)}if(failureCallback){this._failureCallbacks.push(failureCallback)}}else if(this._state===PROMISE_STATE.FULFILLED){if(successCallback){setTimeout(this._callCallback.bind(this),0,successCallback,this._result)}}else if(this._state===PROMISE_STATE.REJECTED){if(failureCallback){setTimeout(this._callCallback.bind(this),0,failureCallback,this._result)}}},done:function(callback){if(!callback){return}if(this._state===PROMISE_STATE.PENDING){this._doneCallbacks.push(callback)}else if(this._state!==PROMISE_STATE.CANCELLED){setTimeout(callback,0)}},cancel:function(){this._state=PROMISE_STATE.CANCELLED;this._clearCallbacks()}});Promise.thenResolve=function(value){return new Promise(function(resolve,reject){resolve(value)})};Promise.thenReject=function(value){return new Promise(function(resolve,reject){reject(value)})};Promise.defer=function(){var deferred={};deferred.promise=new Promise(function(resolve,reject){deferred.resolve=resolve;deferred.reject=reject});return deferred};Streak.Promise=Promise})(Streak);(function(Streak){var Date=Streak.Date;var _cache={};Streak.DateString={format:function(dateTime,format){if(!dateTime){return""}if(!_cache[dateTime+"_"+format]){_cache[dateTime+"_"+format]=Date.create(dateTime).customFormat(format)}return _cache[dateTime+"_"+format]},prettyDate:function(dateTime){if(!dateTime){return""}if(!_cache[dateTime+"_"+"prettyDate"]){var date=Date.create(dateTime);if(date){_cache[dateTime+"_"+"prettyDate"]=date.prettyDate(true)}}return _cache[dateTime+"_"+"prettyDate"]},prettyDateTime:function(dateTime){if(!dateTime){return""}if(!_cache[dateTime+"_"+"prettyDateTime"]){var date=Date.create(dateTime);if(date){_cache[dateTime+"_"+"prettyDateTime"]=date.prettyDate()}}return _cache[dateTime+"_"+"prettyDateTime"]}}})(Streak);(function(Streak){var _=Streak._;var StreakClass=function(){};_.extend(StreakClass.prototype,{mixin:function(superclass){var mixinFunctions=_.rest(arguments);for(var i=0;i<mixinFunctions.length;i++){var mixinFunction=mixinFunctions[i];var mixin=mixinFunction(superclass);mixin.superclass=superclass;superclass=this.subclass(mixin)}return superclass},subclass:function(parameters){var superclass=parameters.superclass;if(parameters._memberVariables){parameters.memberVariables=parameters._memberVariables;delete parameters._memberVariables}var memberVariables=parameters.memberVariables||[];this._validateMemberVariables(memberVariables);var subclassConstructor=function(){superclass.apply(this,arguments)};subclassConstructor.name=parameters.className;subclassConstructor.prototype=Object.create(superclass.prototype);_.extend(subclassConstructor.prototype,this._extractSubclassProperties(parameters));if(memberVariables.length){subclassConstructor.prototype._streak__memberVariables=memberVariables}return subclassConstructor},_validateMemberVariables:function(memberVariables){for(var i=0;i<memberVariables.length;i++){var memberVariable=memberVariables[i];if(memberVariable.name===undefined){throw new Error("name is a required parameter to memberVariables")}if(memberVariable.destroy===undefined){throw new Error("destroy is a required parameter to memberVariables")}for(var property in memberVariable){if(["name","destroy","get","set","defaultValue"].indexOf(property)==-1){throw new Error(property+" is not a valid parameter to memberVariables")}}}},_extractSubclassProperties:function(parameters){var subclassProperties=_.omit(parameters,"superclass","memberVariables");this._createGettersAndSetters(subclassProperties,parameters);return subclassProperties},_createGettersAndSetters:function(subclassProperties,parameters){var self=this;var memberVariables=parameters.memberVariables;if(memberVariables){for(var i=0;i<memberVariables.length;i++){var memberVariable=memberVariables[i];var name=memberVariable.name;if(memberVariable.get){this._makeGetterFunction(subclassProperties,name)}if(memberVariable.set){this._makeSetterFunction(subclassProperties,name)}}}},_makeGetterFunction:function(subclassProperties,name){var getter=this._getterName(name);if(subclassProperties[getter]){return}subclassProperties[getter]=function(){return this[name]}},_getterName:function(variableName){return"get"+variableName.charAt(1).toUpperCase()+variableName.slice(2)},_makeSetterFunction:function(subclassProperties,name){var setter=this._setterName(name);if(subclassProperties[setter]){return}subclassProperties[setter]=function(value){this[name]=value}},_setterName:function(variableName){return"set"+variableName.charAt(1).toUpperCase()+variableName.slice(2)}});Streak.Class=new StreakClass})(Streak);(function(Streak){var _=Streak._;var StreakObject=function(){this._nullifyMemberVariables();this._initializeDefaultValues();this._initialize.apply(this,_.toArray(arguments))};_.extend(StreakObject.prototype,{memberVariables:[],_nullifyMemberVariables:function(doDestroy){var object=this;var proto;while(proto=Object.getPrototypeOf(object)){object=proto;if(object._streak__memberVariables){for(var i=0;i<object._streak__memberVariables.length;i++){var memberVariable=object._streak__memberVariables[i];this._nullifyMemberVariable(memberVariable.name,doDestroy&&memberVariable.destroy)}}}},_nullifyMemberVariable:function(memberVariableName,doDestroy){if(!doDestroy){this[memberVariableName]=null;return}var value=this[memberVariableName];if(!value){return}if(_.isArray(value)){for(var c=0;c<value.length;c++){if(!value[c]){continue}if(value[c].destroy){value[c].destroy()}if(value[c].remove){value[c].remove()}}value.length=0}else if(value.destroy){value.destroy()}else if(value.remove){value.remove()}else if(_.isObject(value)){for(var key in value){if(value[key]){if(value[key].destroy){value[key].destroy()}else if(value[key].remove){try{value[key].remove()}catch(err){}}}}}else if(_.isFunction(value)){value()}},_initializeDefaultValues:function(){var object=this;var proto;while(proto=Object.getPrototypeOf(object)){object=proto;if(object._streak__memberVariables){for(var i=0;i<object._streak__memberVariables.length;i++){var memberVariable=object._streak__memberVariables[i];if(memberVariable.defaultValue!==undefined){this[memberVariable.name]=_.clone(memberVariable.defaultValue)}}}}},_initialize:function(){},destroy:function(){this._nullifyMemberVariables(true)}});Streak.Object=StreakObject})(Streak);(function(Streak){var Library=Streak.Class.subclass({superclass:Streak.Object,set:function(path,object){var parts=path.split(".");var previousObject=null;var currentObject=Streak;for(var ii=0;ii<parts.length-1;ii++){previousObject=currentObject;currentObject=currentObject[parts[ii]];if(!currentObject){currentObject={};previousObject[parts[ii]]=currentObject}}currentObject[parts[parts.length-1]]=object},get:function(path){var parts=path.split(".");var currentObject=Streak;for(var ii=0;ii<parts.length;ii++){currentObject=currentObject[parts[ii]];if(!currentObject){return null}}return currentObject},getInstance:function(path){var func=this.get(path);var args=Array.prototype.slice.call(arguments,1);var factory=func.bind.apply(func,[null].concat(args));return new factory}});Streak.Library=new Library})(Streak);(function(Streak){var _=Streak._;var NotificationCenter=function(){this._subscriptions=[];this._activeTransactionIds=[];this._transactionEventMap={};this._notificationBus=new Streak.Bacon.Bus};Streak._.extend(NotificationCenter.prototype,{subscribe:function(subscription){if(!subscription.observer){throw new Error("subscription needs observer")}if(subscription.eventName){subscription.filterParameters=subscription.filterParameters||{};subscription.filterParameters.eventName=subscription.eventName}this._subscriptions.push(subscription)},unsubscribe:function(unsubscribeOptions){this._subscriptions=_.filter(this._subscriptions,function(subscription){return!_.isObjectASuperset(unsubscribeOptions,subscription)})},postNotification:function(notification,transactionId){if(!notification.eventName){throw new Error("notification needs eventName")}if(transactionId){notification.transactionId=transactionId}if(this._isInTransaction(transactionId)){this._addToTransactionEvents(notification,transactionId);return}this._notifyRelevantSubscriptions(notification);this._notificationBus.push(notification)},areThereSubscribers:function(notification){for(var ii=0;ii<this._subscriptions.length;ii++){var subscription=this._subscriptions[ii];if(_.isObjectASuperset(subscription.filterParameters,notification)){return true}}return false},startTransaction:function(transactionId){this._activeTransactionIds.push(transactionId)},endTransaction:function(transactionId,suppressEvents){this._activeTransactionIds.removeVal(transactionId);if(suppressEvents){this._discardTransactionEvents(transactionId)}this._callTransactionBlockedNotifications(transactionId)},getNotificationStream:function(){return this._notificationBus},_notifyRelevantSubscriptions:function(notification){if(!notification){return}var oldSubscriptions=_.clone(this._subscriptions);var subscriptionsToRemove=[];for(var ii=0;ii<oldSubscriptions.length;ii++){var subscription=oldSubscriptions[ii];if(_.isObjectASuperset(subscription.filterParameters,notification)){try{this._notifySubscription(subscription,notification)}catch(err){Streak.BentoBox.logError("Error with notification",err)}if(subscription.unsubscribeImmediately){subscriptionsToRemove.push(subscription)}}}for(var ii=0;ii<subscriptionsToRemove.length;ii++){this._subscriptions.removeVal(subscriptionsToRemove[ii])}},_isInTransaction:function(transactionId){if(!transactionId){return false}return this._activeTransactionIds.indexOf(transactionId)>-1},_addToTransactionEvents:function(notification,transactionId){if(!this._transactionEventMap[transactionId]){this._transactionEventMap[transactionId]=[]}this._transactionEventMap[transactionId].push(notification)},_discardTransactionEvents:function(transactionId){delete this._transactionEventMap[transactionId]},_callTransactionBlockedNotifications:function(transactionId){var transactionEvents=this._transactionEventMap[transactionId];if(!transactionEvents){delete this._transactionEventMap[transactionId];return}for(var ii=0;ii<transactionEvents.length;ii++){this.postNotification(transactionEvents[ii])}delete this._transactionEventMap[transactionId]},_notifySubscription:function(subscription,notification){if(subscription.functionToCall){subscription.functionToCall.call(subscription.observer,notification);return}subscription.observer.notify(notification)}});Streak.NotificationCenter=new NotificationCenter})(Streak);(function(Streak){var _=Streak._;var ViewControllerBase=function(){this._delegates=[]};_.extend(ViewControllerBase.prototype,{addDelegate:function(delegate){this._delegates.push(delegate)},removeAllDelegates:function(){this._delegates=[]},_callDelegateFunction:function(functionName){var args=_.rest(_.toArray(arguments));for(var ii=0;ii<this._delegates.length;ii++){if(this._delegates[ii][functionName]){this._delegates[ii][functionName].apply(this._delegates[ii],args)}}},destroy:function(){this._delegates.length=0}});Streak.ViewControllerBase=ViewControllerBase})(Streak);(function($){var renderLimit=100;$.fn.autoComplete=function(val){return this.each(function(){var self=this;var input=$(this);var shadowInput=$(document.createElement("div"));shadowInput[0].setAttribute("class","shadowInput");var shadowInputInner=$(document.createElement("div"));shadowInputInner[0].setAttribute("class","shadowInputInner");var list=[];var potentials=[];var suggestions=$(document.createElement("ul"));suggestions[0].setAttribute("class","SK AX bbAutocompleteList");var renderTimeout=null;var selectedClass="J-N-JT";var savedText;var text;input.after(shadowInput);this.setAutoCompleteList=function(aList){list=aList||[];suggestions.empty();shadowInputInner[0].innerHTML="";suggestions.detach()};this.onscroll=function(){if(suggestions.is(":FastVisible")){setScrollPosition()}};input.bind({keydown:function(e){if(e.which===16){return}if(!text){text=""}if(Streak.jwerty.is("right",e)){if(isCaretAtEnd()&&suggestions.is(":FastVisible")&&suggestions.find("li."+selectedClass).length===0){var current=getValue();
var top=getFirstItemData().value;if(current!==top){setValue(getFirstItemData().value);input.caret().goToEnd();e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();savedText=getValue()}return}}else if(Streak.jwerty.is("up",e)){if(suggestions.is(":FastVisible")){keyEvent("prev",e)}}else if(Streak.jwerty.is("down",e)){if(suggestions.is(":FastVisible")){keyEvent("next",e)}else{savedText=getValue();showSuggestions()}}else if(Streak.jwerty.is("tab",e)||Streak.jwerty.is("shift+tab",e)){}else if(Streak.jwerty.is("escape",e)){if(suggestions.is(":FastVisible")){setValue(savedText);hideSuggestions();e.preventDefault();e.stopPropagation()}else{input.trigger("escapePressed")}}else if(Streak.jwerty.is("backspace/delete",e)){}},input:function(e){text=getValue();savedText=text;if(text.length===0){hideSuggestions()}else{renderSuggestion(text.length)}},keyup:function(e){if(Streak.jwerty.is("escape/shift/enter/ctrl/cmd/alt/meta",e)){setListPosition();return}if(Streak.jwerty.is("up/down",e)){if(suggestions.is(":FastVisible")){e.preventDefault();e.stopPropagation();return}else if(Streak.jwerty.is("down",e)){showSuggestions()}}},click:function(e){if(!suggestions.is(":FastVisible")){showSuggestions()}},focus:function(e){input.after(shadowInput)},detach:function(e){hideSuggestions()}});input[0].addEventListener("keydown",function(e){if(e.which===13&&!e.ctrlKey&&!e.metaKey){e.stopImmediatePropagation();e.stopPropagation();e.preventDefault();input.focus();input.caret().goToEnd();hideSuggestions();input.trigger("enterPressed")}},true);function showSuggestions(){text=getValue();var potentials=getPotentials(getValue());if(potentials.length>0){renderSuggestionList(potentials);setListPosition();setScrollPosition()}}function renderSuggestion(length){clearTimeout(renderTimeout);renderTimeout=setTimeout(function(){potentials=getPotentials(text);if(potentials.length===0){hideSuggestions();return}renderSuggestionList(potentials);updateShadowSelection();setListPosition()},100);setListPosition()}function getPotentials(text){var normalizedText=text.toLowerCase().removeWhitespace();return list.filter(function(item){return item.normalized.indexOf(normalizedText)===0&&item.normalized.length>0})}function isCaretAtEnd(){return input.caret().start>=getValue().length}function renderSuggestionList(potentials){suggestions.empty();suggestions[0].style.display="";for(var ii=0;ii<Math.min(potentials.length,renderLimit);ii++){var li=renderListItem(potentials[ii]);if(ii===0){li.addClass("firstItem")}else if(ii===potentials.length-1){li.addClass("lastItem")}suggestions.append(li)}shadowInput.after(suggestions)}function setListPosition(){var height=input.parent().height()+1;var top=parseFloat(shadowInput.css("top"));var left=parseFloat(shadowInput.css("left"));height-=top;suggestions[0].style.top=height+"px";suggestions[0].style.width=input.parent().width()-6-left+"px";shadowInput[0].style.height=height-1+"px"}function setScrollPosition(){var newTop=input[0].scrollTop;shadowInputInner[0].style.top=-1*newTop+"px"}function updateShadowSelection(){shadowInputInner.text(getFirstItemData().value);shadowInput.show()}function hideSuggestions(){suggestions.empty();suggestions.detach();shadowInputInner.empty()}function renderListItem(item){var li=$(document.createElement("li"));li.addClass("J-N");li[0].innerHTML=item.display.escapeHTML();$(li).data("data",item);li[0].setAttribute("title",item.display);li.captureClick(function(e){select();input.trigger("delayedSave")}).hover(function(e){$(this).addClass(selectedClass)},function(e){$(this).removeClass(selectedClass)});return li}function getItemIndex(lis,li){for(var i=0;i<lis.length;i++){if(lis[i]===li[0]){return i}}return-1}function keyEvent(action,event){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();var next;if(suggestions.find("li."+selectedClass).length>0){var sel=suggestions.find("li."+selectedClass);var lis=suggestions.find("li");var currIndex=getItemIndex(lis,sel);var nextIndex=-1;var nextIndex=action=="next"?currIndex+1:currIndex-1;sel.removeClass(selectedClass);if(nextIndex===-1||nextIndex>suggestions.find("li").length-1){setValue(savedText);shadowInput.show();input.caret().goToEnd()}else{next=$(lis[nextIndex]);next.addClass(selectedClass)}}else{if(action==="next"){suggestions.find("li.firstItem").addClass(selectedClass)}else{suggestions.find("li.lastItem").addClass(selectedClass)}next=suggestions.find("li."+selectedClass)}if(next){shadowInputInner[0].innerHTML="";setValue(next.data("data").value);input.caret().goToEnd();next.scrollintoview({duration:50})}setListPosition()}function getFirstItemData(){var firstItem=suggestions.find("li.firstItem");return firstItem.data("data")}function select(){suggestions.hide();shadowInput.hide();var selected=suggestions.find("li."+selectedClass);var d=selected.data("data");setValue(d.value);input.caret().goToEnd();input.trigger("autoCompleteSet")}function getValue(){return input.plainText()}function setValue(newVal){if(!newVal){newVal=""}input.text(newVal)}})}})(Streak.jQuery);(function($){$.fn.autoGrowInput=function(o){return this.each(function(){var input=$(this),check=function(adjustment){adjustment=Streak._.isNumber(adjustment)?adjustment:0;input.attr("size",Math.max(input.val().length+adjustment,1))};check(-2);$(this).bind("keyup keydown blur update change input",check)})}})(Streak.jQuery);(function($){var cachedData=[];var cachedQueries=[];var queryCache=[];var queryRank={};var selectedClass="Jd-Je";var CONSTANTS={maxListItems:25};$.fn.AutoSuggest=function(config){var defaults={data:null,wrapperCss:{},minChars:1,dataFunc:$.noop,convertFunc:$.noop,stringDataFunc:$.noop,selectFunc:$.noop,compareFunc:function(query,dataItem){},noResultsFoundText:null,loadingResultsText:null,getExcludedIDsFunc:$.noop,idProperty:"email",onlyValidEmailAddress:false,isRightAligned:true};var currentDataInList=[];var options={};$.extend(options,defaults,config);return this.each(function(){var self=this;var input=$(this);var parent=input.parent();var suggestions=$('<div class="ah aiv aJS ausu-suggestionsBox"></div>');var overflow=$('<div class="overflowContainer"></div>');var loadingHTML=$('<div class="ausu-loadingIndicator" style="">Loading More...</div>');var existingListUL=$('<ul class="existingList"></ul>');var list=$("<ul></ul>");var timer;var searchVal=input.plainText();var renderedExistingIDs=[];mergeExisting(cachedData);overflow.appendTo(suggestions);loadingHTML.appendTo(suggestions);existingListUL.appendTo(overflow);list.appendTo(overflow);input.after(suggestions);hideLoading();input.autoGrowInput();input.on("keydown",function(event){if(event.which===40||event.which===38){if(Streak.jwerty.is("down",event)){if(searchVal.length===0&&!existingListUL.is(":FastVisible")){list.empty();renderExistingList();return false}else if(searchVal.length>0&&!suggestions.is(":FastVisible")){renderExistingList(searchVal);cacheSuggest(searchVal);addIndexClasses();event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false}}if(suggestions.is(":FastVisible(noCompute)")){if(event.which===40){keyEvent("next");event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false}else{keyEvent("prev");event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false}}}switch(event.which){case 9:if(event.shiftKey){input.trigger("shiftTabPressed")}else{if(suggestions.find("li."+selectedClass).filter(":FastVisible").length>0||input.plainText().length>0){select();event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false}input.trigger("tabPressed")}event.preventDefault();break;case 13:if(suggestions.find("li."+selectedClass).filter(":FastVisible").length>0||input.plainText().length>0){select()}else{input.trigger("enterPressed");event.preventDefault();event.stopPropagation()}return false;break;case 27:event.preventDefault();event.stopPropagation();if(suggestions.is(":FastVisible")){suggestions.hide()}else{input.trigger("escapePressed")}break}});input[0].addEventListener("keyup",function(e){if(event.keyCode==13){return false}else if(e.which===8&&input.plainText().length===0){searchVal="";suggestions.hide();hideLoading()}else{inputChanged(input.plainText())}});input.on("bbSelect",function(event){if(input.plainText()){if(input.plainText().isValidEmail()){select()}}});input.on("bbUnselect",function(event){suggestions.find("li."+selectedClass).removeClass(selectedClass)});input.on("bbFocus",function(event){suggestions.hide();list.empty()});input.on("click",function(event){if(searchVal.length===0&&!existingListUL.is(":FastVisible")){list.empty();renderExistingList()}else if(searchVal.length>0&&!suggestions.is(":FastVisible")){renderExistingList(searchVal);cacheSuggest(searchVal);addIndexClasses()}});var suggestTimer=null;function showLoading(){showSuggestions();suggestions.addClass("ausu-loading")}function hideLoading(){suggestions.removeClass("ausu-loading")}function inputChanged(newVal){newVal=(newVal||"").toLowerCase();mostRecentQuery=newVal;if(searchVal!==newVal){searchVal=newVal;clearTimeout(timer);showLoading();renderExistingList(searchVal);var isCacheExact=cacheSuggest(newVal);timer=setTimeout(function(){suggest(newVal)},isCacheExact?2e3:200)}}function suggest(dataInput){if(dataInput!==searchVal||dataInput<=options.minChars){hideLoading();return}if(Streak._.isNotReal(queryRank[dataInput])){queryRank[dataInput]=0}queryRank[dataInput]++;options.dataFunc(dataInput,function(data){if(dataInput!==searchVal){return}if(data){updateCache(dataInput,data);renderList(dataInput,queryCache[cachedQueries.indexOf(dataInput)])}else{if(suggestions.find("li").length===0){suggestions.hide()}}hideLoading()})}function updateCache(query,data){if(Streak._.isNotReal(data)||data.length===0){return}var index=cachedQueries.indexOf(query);if(index>-1){queryCache[index]=Streak._.uniqMerge(data.concat(queryCache[index]),function(contact){return contact.email})}else{index=cachedQueries.length;cachedQueries.push(query);queryCache[index]=data}mergeCache(data)}function mergeCache(data){cachedData=cachedData.concat(data);cachedData=Streak._.uniqMerge(cachedData,function(contact){return contact[options.idProperty]});mergeExisting(data)}function mergeExisting(data){var existingList=input.data("existingList");if(existingList&&existingList.length>0){for(var ii=0;ii<existingList.length;ii++){for(var jj=0;jj<data.length;jj++){if(existingList[ii].value[options.idProperty]===data[jj][options.idProperty]){Streak._.extend(existingList[ii].value,data[jj])}}}}}function cacheSuggest(dataInput){var cachedList;if(dataInput!==mostRecentQuery){return}var isExactMatch=false;var cacheIndex=cachedQueries[dataInput];if(cacheIndex>-1){isExactMatch=true;cachedList=queryCache[cacheIndex]}else{var tempQuery=dataInput;for(var ii=1;ii<dataInput.length;ii++){var filteredCache=getFilteredCachedList(tempQuery);if(filteredCache.length>0){var index=cachedQueries.indexOf(filteredCache[0]);cachedList=queryCache[index];break}else{tempQuery=tempQuery.substring(0,tempQuery.length-1)}}}var filtered;if(cachedList){filtered=Streak._.filter(cachedList,function(contact){return options.compareFunc(dataInput,contact)})}if(filtered&&filtered.length>0){showSuggestions();renderList(dataInput,filtered)}else{list.empty()}return isExactMatch}function getFilteredCachedList(dataInput){return Streak._(cachedQueries).chain().filter(function(query){return query.toLowerCase().indexOf(dataInput.toLowerCase())===0}).sortBy(function(query){return-1*queryRank[query]}).sortBy(function(query){return query.length}).value()}function renderExistingList(query){var existingList=input.data("existingList");if(existingList&&existingList.length>0){renderedExistingIDs.length=0;existingListUL.empty();var excludedIds=options.getExcludedIDsFunc();var filteredExisting=existingList.filter(function(item){return options.compareFunc(query||"",item.value)&&excludedIds.indexOf(getIDValue(item.value))===-1});if(filteredExisting.length>0){for(var i=0;i<filteredExisting.length;i++){var li=renderListItem(query,filteredExisting[i].value);existingListUL.append(li);renderedExistingIDs.push(getIDValue(filteredExisting[i].value))}existingListUL.show()}else{existingListUL.hide()}showSuggestions()}addIndexClasses()}var imageRenderTimer;var imageRenderList=[];function renderList(query,data){imageRenderList.length=0;if(imageRenderTimer){imageRenderTimer.stop()}suggestions.show();list.empty();if(data&&data.length>0){list.find(".ausu-no-results").remove();var excludedIds=options.getExcludedIDsFunc()||[];var listLength=Math.min(data.length,CONSTANTS.maxListItems);for(var i=0;i<listLength;i++){if(excludedIds.indexOf(getIDValue(data[i]))>-1||renderedExistingIDs.indexOf(getIDValue(data[i]))>-1){continue}var imageUrl=data[i].imageUrl;data[i].imageUrl=null;var li=renderListItem(query,data[i]);list.append(li);imageRenderList.push({li:li,imageUrl:imageUrl})}imageRenderTimer=Streak._.repeatEvery(function(){if(imageRenderList.length>0){var next=imageRenderList.pop();next.li.find(".ak")[0].style.backgroundImage="url("+next.imageUrl+")"}else{imageRenderTimer.stop()}},300)}if(renderedExistingIDs.length===0&&list.find("li").length===0){list.html('<li class="ausu-no-results">'+options.noResultsFoundText+"</li>")}resetPosition();addIndexClasses()}function addIndexClasses(){suggestions.find(".firstItem").removeClass("firstItem");suggestions.find(".lastItem").removeClass("lastItem");if(existingListUL.find("li").length>0){existingListUL.find("li:first").addClass("firstItem");if(list.find("li.personPickerSuggestion").length===0){existingListUL.find("list:last").addClass("lastItem")}else{list.find("li.personPickerSuggestion:last").addClass("lastItem")}}else if(list.find("li.personPickerSuggestion").length>0){list.find("li:first").addClass("firstItem");list.find("li:last").addClass("lastItem")}suggestions.find("."+selectedClass).removeClass(selectedClass);suggestions.find(".firstItem").addClass(selectedClass)}function showSuggestions(){suggestions.show();resetPosition()}function resetPosition(){suggestions[0].style.top="";suggestions[0].style.left="";suggestions.containByScreen(input,{isRightAligned:options.isRightAligned})}function renderListItem(query,item){var li=options.convertFunc(query,item);$(li).data("data",item);li[0].addEventListener("mousedown",function(e){select(e);e.preventDefault()},true);li.hover(function(e){suggestions.find("li."+selectedClass).removeClass(selectedClass);$(this).addClass(selectedClass)},function(e){$(this).removeClass(selectedClass)});return li}function getItemIndex(lis,li){for(var i=0;i<lis.length;i++){if(lis[i]===li[0]){return i}}return-1}function keyEvent(action){if(suggestions.find("li").length<2){return}if(suggestions.find("li."+selectedClass).length>0){var sel=suggestions.find("li."+selectedClass);var lis=suggestions.find("li.personPickerSuggestion");var currIndex=getItemIndex(lis,sel);var nextIndex=-1;var nextIndex=action=="next"?currIndex+1:currIndex-1;if(nextIndex===-1){next=$(lis[lis.length-1])}else if(nextIndex>suggestions.find("li").length-1){next=$(lis[0])}else{next=$(lis[nextIndex])}next.addClass(selectedClass);sel.removeClass(selectedClass);next.scrollintoview({duration:50})}else{if(action==="next"){suggestions.find("li.firstItem").addClass(selectedClass)}else{suggestions.find("li.lastItem").addClass(selectedClass)}}}function select(){var useSuggestion=suggestions.is(":FastVisible")&&suggestions.find("li."+selectedClass).length>0;searchVal="";var selected=suggestions.find("li."+selectedClass);var d=selected.data("data");if(!useSuggestion){d=options.stringDataFunc(input.plainText())}input.plainText("");input.focus();if(d.email||!options.onlyValidEmailAddress){options.selectFunc(d)}mostRecentQuery=null;list.empty();suggestions.hide()}function getIDValue(data){if(options.onlyValidEmailAddress){return data[options.idProperty]}else{return data[options.idProperty]||data.displayName}}})}})(Streak.jQuery);(function($,window){"$:nomunge";var undefined,aps=Array.prototype.slice,decode=decodeURIComponent,jq_param=$.param,jq_param_sorted,jq_param_fragment,jq_deparam,jq_deparam_fragment,jq_bbq=$.bbq=$.bbq||{},jq_bbq_pushState,jq_bbq_getState,jq_elemUrlAttr,special=$.event.special,str_hashchange="hashchange",str_querystring="querystring",str_fragment="fragment",str_elemUrlAttr="elemUrlAttr",str_href="href",str_src="src",re_params_querystring=/^.*\?|#.*$/g,re_params_fragment,re_fragment,re_no_escape,ajax_crawlable,fragment_prefix,elemUrlAttr_cache={};function is_string(arg){return typeof arg==="string"}function curry(func){var args=aps.call(arguments,1);return function(){return func.apply(this,args.concat(aps.call(arguments)))}}function get_fragment(url){return url.replace(re_fragment,"$2")}function get_querystring(url){return url.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function jq_param_sub(is_fragment,get_func,url,params,merge_mode){var result,qs,matches,url_params,hash;if(params!==undefined){matches=url.match(is_fragment?re_fragment:/^([^#?]*)\??([^#]*)(#?.*)/);hash=matches[3]||"";if(merge_mode===2&&is_string(params)){qs=params.replace(is_fragment?re_params_fragment:re_params_querystring,"")}else{url_params=jq_deparam(matches[2]);params=is_string(params)?jq_deparam[is_fragment?str_fragment:str_querystring](params):params;qs=merge_mode===2?params:merge_mode===1?$.extend({},params,url_params):$.extend({},url_params,params);qs=jq_param_sorted(qs);if(is_fragment){qs=qs.replace(re_no_escape,decode)}}result=matches[1]+(is_fragment?fragment_prefix:qs||!matches[1]?"?":"")+qs+hash}else{result=get_func(url!==undefined?url:location.href)}return result}jq_param[str_querystring]=curry(jq_param_sub,0,get_querystring);jq_param[str_fragment]=jq_param_fragment=curry(jq_param_sub,1,get_fragment);jq_param.sorted=jq_param_sorted=function(a,traditional){var arr=[],obj={};$.each(jq_param(a,traditional).split("&"),function(i,v){var key=v.replace(/(?:%5B|=).*$/,""),key_obj=obj[key];if(!key_obj){key_obj=obj[key]=[];arr.push(key)}key_obj.push(v)});return $.map(arr.sort(),function(v){return obj[v]}).join("&")};jq_param_fragment.noEscape=function(chars){chars=chars||"";var arr=$.map(chars.split(""),encodeURIComponent);re_no_escape=new RegExp(arr.join("|"),"g")};jq_param_fragment.noEscape(",/");jq_param_fragment.ajaxCrawlable=function(state){if(state!==undefined){if(state){re_params_fragment=/^.*(?:#!|#)/;re_fragment=/^([^#]*)(?:#!|#)?(.*)$/;fragment_prefix="#!"}else{re_params_fragment=/^.*#/;re_fragment=/^([^#]*)#?(.*)$/;fragment_prefix="#"}ajax_crawlable=!!state}return ajax_crawlable};jq_param_fragment.ajaxCrawlable(0);$.deparam=jq_deparam=function(params,coerce){var obj={},coerce_types={"true":!0,"false":!1,"null":null};$.each(params.replace(/\+/g," ").split("&"),function(j,v){var param=v.split("="),key=decode(param[0]),val,cur=obj,i=0,keys=key.split("]["),keys_last=keys.length-1;if(/\[/.test(keys[0])&&/\]$/.test(keys[keys_last])){keys[keys_last]=keys[keys_last].replace(/\]$/,"");keys=keys.shift().split("[").concat(keys);keys_last=keys.length-1}else{keys_last=0}if(param.length===2){val=decode(param[1]);if(coerce){val=val&&!isNaN(val)?+val:val==="undefined"?undefined:coerce_types[val]!==undefined?coerce_types[val]:val}if(keys_last){for(;i<=keys_last;i++){key=keys[i]===""?cur.length:keys[i];cur=cur[key]=i<keys_last?cur[key]||(keys[i+1]&&isNaN(keys[i+1])?{}:[]):val}}else{if($.isArray(obj[key])){obj[key].push(val)}else if(obj[key]!==undefined){obj[key]=[obj[key],val]}else{obj[key]=val}}}else if(key){obj[key]=coerce?undefined:""}});return obj};function jq_deparam_sub(is_fragment,url_or_params,coerce){if(url_or_params===undefined||typeof url_or_params==="boolean"){coerce=url_or_params;url_or_params=jq_param[is_fragment?str_fragment:str_querystring]()}else{url_or_params=is_string(url_or_params)?url_or_params.replace(is_fragment?re_params_fragment:re_params_querystring,""):url_or_params}return jq_deparam(url_or_params,coerce)}jq_deparam[str_querystring]=curry(jq_deparam_sub,0);jq_deparam[str_fragment]=jq_deparam_fragment=curry(jq_deparam_sub,1);$[str_elemUrlAttr]||($[str_elemUrlAttr]=function(obj){return $.extend(elemUrlAttr_cache,obj)})({a:str_href,base:str_href,iframe:str_src,img:str_src,input:str_src,form:"action",link:str_href,script:str_src});jq_elemUrlAttr=$[str_elemUrlAttr];function jq_fn_sub(mode,force_attr,params,merge_mode){if(!is_string(params)&&typeof params!=="object"){merge_mode=params;params=force_attr;force_attr=undefined}return this.each(function(){var that=$(this),attr=force_attr||jq_elemUrlAttr()[(this.nodeName||"").toLowerCase()]||"",url=attr&&that.attr(attr)||"";that.attr(attr,jq_param[mode](url,params,merge_mode))})}$.fn[str_querystring]=curry(jq_fn_sub,str_querystring);$.fn[str_fragment]=curry(jq_fn_sub,str_fragment);jq_bbq.pushState=jq_bbq_pushState=function(params,merge_mode){if(is_string(params)&&/^#/.test(params)&&merge_mode===undefined){merge_mode=2}var has_args=params!==undefined,url=jq_param_fragment(location.href,has_args?params:{},has_args?merge_mode:2);location.href=url};jq_bbq.getState=jq_bbq_getState=function(key,coerce){return key===undefined||typeof key==="boolean"?jq_deparam_fragment(key):jq_deparam_fragment(coerce)[key]};jq_bbq.removeState=function(arr){var state={};if(arr!==undefined){state=jq_bbq_getState();$.each($.isArray(arr)?arr:arguments,function(i,v){delete state[v]})}jq_bbq_pushState(state,2)};special[str_hashchange]=$.extend(special[str_hashchange],{add:function(handleObj){var old_handler;function new_handler(e){var hash=e[str_fragment]=jq_param_fragment();e.getState=function(key,coerce){return key===undefined||typeof key==="boolean"?jq_deparam(hash,key):jq_deparam(hash,coerce)[key]};old_handler.apply(this,arguments)}if($.isFunction(handleObj)){old_handler=handleObj;return new_handler}else{old_handler=handleObj.handler;handleObj.handler=new_handler}}})})(Streak.jQuery,this);(function($){$.fn.extend({bodyCloseAndStop:function(theOptions){var defaults={closeFunction:null,stop:null,body:null,useCapture:true,stopOnSelf:true};var opts={};$.extend(opts,defaults,theOptions);var validElements=this.filter(function(){if($(this).data("bodyCloseAndStop")){return false}return true});if(validElements.length===0){return}var callbackFunction=function(e){if(_shouldIgnoreClick){return}var filterElements;if(opts.stopOnSelf){filterElements=$(validElements).add(opts.stop)}else{filterElements=$(opts.stop)}if(opts.closeFunction&&(opts.stop===null||$(e.target).parents().add(e.target).filter(filterElements).length===0)){opts.closeFunction(e)}};$(validElements).data("bodyCloseAndStop",{useCapture:opts.useCapture,callbackFunction:callbackFunction,body:opts.body});if(!opts.useCapture){$(opts.body).on("click",callbackFunction)}else{$(opts.body).each(function(){this.addEventListener("click",callbackFunction,true)})}$(opts.body).on("bodyCloseAndStop",callbackFunction)},unbindBodyCloseAndStop:function(){return this.each(function(){var args=$(this).data("bodyCloseAndStop");if(!args){return}if(!args.useCapture){$(args.body).off("click",args.callbackFunction)}else{$(args.body).each(function(){this.removeEventListener("click",args.callbackFunction,true)})}$(args.body).off("bodyCloseAndStop",args.callbackFunction);$(this).removeData("bodyCloseAndStop")})}});$(document.body).on("ignoreMouseClick",function(){_shouldIgnoreClick=true});$(document.body).on("click",function(){_shouldIgnoreClick=false});var _shouldIgnoreClick=false})(Streak.jQuery);(function($){$.fn.extend({captureClick:function(inCB){var cb=inCB;return this.each(function(){var self=$(this);this.addEventListener("click",function(e){if(cb){cb(e)}e.stopPropagation();return false},true)})}})})(Streak.jQuery);(function(Streak){var $=Streak.jQuery;var cleaner=document.createElement("div");$.domCleanString=function(s){cleaner.innerHTML=s;return cleaner.innerText};$.cleanString=function(s){return $.cleanText(s)};$.fn.cleanText=function(){return $.cleanText(this.html())};$.cleanText=function(s,replaceNewlines,lineEnding){if(!s){return""}if(!lineEnding){lineEnding="\n"}var sPrime=s.replace(/<br\s*\/?>|<div>/gim,lineEnding).replace("&nbsp;"," ");if(replaceNewlines){sPrime=sPrime.replace(/\n/gim," ")}sPrime=sPrime.replaceAmpCodes();return sPrime.trim()};$.fn.plainText=function(text){if(text||text===""){this.setPlainText(text)}else{var innerText="";if(this.is("textarea")||this.is("input")){innerText=this.val()}else{innerText=this[0].innerText}return innerText.trim("\n")}};var charEncodings={"	":"&nbsp;&nbsp;&nbsp;&nbsp;","  ":"&nbsp; ","&":"&amp;",'"':"&quot;","'":"&#x27;","<":"&lt;",">":"&gt;","\n":"<br />","\r":"<br />"};var space=/[\t ]/;var noWidthSpace="&#8203;";$.fn.setPlainText=function(text){if(this.is("textarea")||this.is("input")){this.val(text)}else{this[0].innerHTML=$.getTextHTML(text)}};$.getTextHTML=function(text){text=(text||"")+"";text=text.replace(/\r\n/g,"\n");var html="";var lastChar="";for(var i=0;i<text.length;i++){var c=text[i];var charCode=text.charCodeAt(i);if(space.test(c)&&!space.test(lastChar)&&space.test(text[i+1]||"")){html+=noWidthSpace}html+=c in charEncodings?charEncodings[c]:charCode>127?"&#"+charCode+";":c;lastChar=c}return html}})(Streak);(function($){var StateMachine=Streak.StateMachine;var isMoving=false,currentCol=null,originalWidth=0,originalX=0,dragThreshold=4;var stateMachine=null;var eventsBound=false;function bindEvents(){if(eventsBound){return}stateMachine=new StateMachine.create({initial:"start",events:[{name:"mousedown",from:["start"],to:"possibleDrag"},{name:"mouseup",from:["possibleDrag","start"],to:"start"},{name:"dragStart",from:["possibleDrag"],to:"drag"},{name:"mouseup",from:["drag"],to:"drop"},{name:"reset",from:["possibleDrag","drag","drop","start"],to:"start"}],callbacks:{onstart:function(event,from,to){Streak.Gmail.elements.body.css({"-webkit-user-select":""})},ondragStart:function(){currentEl.trigger("bbDragStart")},ondrag:function(event,from,to){Streak.Gmail.elements.body.css({"-webkit-user-select":"none"});currentEl.trigger("bbDrag")},ondrop:function(event,from,to){currentEl.trigger("bbDrop");stateMachine.reset()}}});Streak.Gmail.elements.body.mousemove(function(e){var pixelsMoved=e.clientX-originalX;if(stateMachine.is("possibleDrag")){if(document.activeElement.type!=="text"&&Math.abs(pixelsMoved)>dragThreshold){stateMachine.dragStart()}}else if(stateMachine.is("drag")){var newWidth=Math.min(Math.max(originalWidth+pixelsMoved,45),2e3);currentEl.css({minWidth:newWidth,width:newWidth,maxWidth:newWidth});currentEl.trigger("bbDrag")}});Streak.Gmail.elements.body.mouseup(function(e){stateMachine.mouseup()});Streak.BentoBox.Keyboard.bindChord("escape",function(e){stateMachine.reset()});eventsBound=true}$.fn.colResizable=function(opts){var defaults={onResize:$.noop,doneResize:$.noop};var options=$.extend(defaults,opts);return this.each(function(){var td=$(this),grip=$(document.createElement("div"));grip.addClass("colResize");td.append(grip);grip.on("mousedown.colResizable",function(e){bindEvents();stateMachine.reset();stateMachine.mousedown();originalX=e.clientX;currentEl=td;originalWidth=td.width();e.preventDefault();e.stopPropagation();grip.trigger("ignoreMouseClick")});td.on({"bbDragStart.colResizable":function(e){grip.trigger("hold")},"bbDrag.colResizable":function(e){options.onResize(td.width())},"bbDrop.colResizable":function(e){grip.trigger("unhold");options.doneResize()}});grip[0].addEventListener("click",function cancelEvent(e){e.preventDefault();e.stopImmediatePropagation()},true);grip.easyHoverClass("bbActive")})}})(Streak.jQuery);(function($){var StateMachine=Streak.StateMachine;var currentEl=null,newIndex=null,isAfter=false,currentSet=null,originalX=null,widthMap=[],body=null;var grip=null;var overGrip=null;var CONSTANTS={DRAG_THRESHOLD:4};$.fn.columnReorder=function(opts){var headerSet=this;var defaults={body:null,doneReorder:$.noop};var options=$.extend(defaults,opts);resetGrip();this.each(function(currentIndex){var td=$(this);td.on({mouseenter:function(e){if(!stateMachine||stateMachine.is("start")){grip.fastShow();overGrip.fastShow();td.prepend(grip);td.prepend(overGrip);currentEl=td}},mouseleave:function(e){if(!stateMachine||stateMachine.is("start")){grip.detach();overGrip.detach()}},"streakReorderDragStart.columnReorder":function(e){proxy.css({width:currentEl.width(),left:td.offset().left,top:0});currentSet=headerSet;body=options.body;currentEl=td;body.prepend(proxy)},"streakReorderDrag.columnReorder":function(e){},"streakReorderDrop.columnReorder":function(e){proxy.detach();insert.detach();options.doneReorder(currentIndex,newIndex,isAfter)}})})};var stateMachine=null;var eventsBound=false;function bindEvents(){if(eventsBound){return}stateMachine=new StateMachine.create({initial:"start",events:[{name:"mousedown",from:["start"],to:"possibleDrag"},{name:"mouseup",from:["possibleDrag","start"],to:"start"},{name:"dragStart",from:["possibleDrag"],to:"drag"},{name:"mouseup",from:["drag"],to:"drop"},{name:"reset",from:["possibleDrag","drag","drop","start"],to:"start"}],callbacks:{onstart:function(event,from,to){Streak.Gmail.elements.body.css({"-webkit-user-select":""})},ondragStart:function(){currentEl.trigger("streakReorderDragStart");setupWidthMap()},ondrag:function(event,from,to){Streak.Gmail.elements.body.css({"-webkit-user-select":"none"});currentEl.trigger("streakReorderDrag")},ondrop:function(event,from,to){currentEl.trigger("streakReorderDrop");stateMachine.reset()}}});Streak.Gmail.elements.body.mousemove(function(e){var pixelsMoved=e.clientX-originalX;if(stateMachine.is("possibleDrag")){if(document.activeElement.type!=="text"&&Math.abs(pixelsMoved)>CONSTANTS.DRAG_THRESHOLD){stateMachine.dragStart()}}else if(stateMachine.is("drag")){renderDrag(pixelsMoved)}});Streak.Gmail.elements.body.mouseup(function(e){stateMachine.mouseup()});eventsBound=true}function resetGrip(){grip=$('<div class="streak__reorderGrip"><div></div><div></div></div>');overGrip=$('<div class="streak__reorderGripOver"></div>');overGrip.on("mousedown.columnReorder",function(e){bindEvents();stateMachine.reset();stateMachine.mousedown();originalX=e.clientX;e.preventDefault();e.stopPropagation()})}var proxy=$(document.createElement("div"));proxy.addClass("streak__reorderProxy");var insert=$(document.createElement("div"));insert.addClass("streak__reorderInsert");function setupWidthMap(){widthMap.length=0;currentSet.each(function(el){var offset=$(this).offset();var width=$(this).width();widthMap.push({left:offset.left,right:offset.left+width,width:width,el:$(this)})})}function renderDrag(pixelsMoved){isAfter=false;var x=Math.min(Math.max(originalX+pixelsMoved,widthMap[0].left),widthMap[widthMap.length-1].left);proxy.offset({left:x});insert.detach();for(var ii=0;ii<widthMap.length;ii++){if(widthMap[ii].left<=x&&widthMap[ii].right>=x){newIndex=ii;if(x>(widthMap[ii].left+widthMap[ii].right)/2){isAfter=true;insert.css({left:widthMap[ii].el.position().left+widthMap[ii].width})}else{insert.css({left:widthMap[ii].el.position().left-5})}body.prepend(insert);break}}}})(Streak.jQuery);(function($){var _=Streak._;var CONSTANTS={BUFFER:10};$.fn.getBoundingBox=function(useOuterWidth){var el=$(this[0]);var offset=el.offset();var bb=[{x:offset.left,y:offset.top},{x:offset.left+(useOuterWidth?el.outerWidth():el.width()),y:offset.top+el.outerHeight()}];bb.width=useOuterWidth?el.outerWidth():el.width();bb.height=el.outerHeight();return bb};var opsChecker=function(theOps){var ops=theOps;return{can:function(checkOps){var ret=false;if($.isArray(checkOps)){ret=false;for(var i=0;i<checkOps.length;i++){if(ops.indexOf(checkOps[i])>-1){ret=true;break}}}else{ret=ops.indexOf(checkOps)>-1}return ret}}};var BoundingBoxContainer=function(theContainerBB,theContainedBB,theAnchorPoint){var containerBB=theContainerBB;var containedBB=theContainedBB;var anchorPoint=theAnchorPoint;return{containDimension:function(axis,dimension,anchorCheck,coord){coord=coord===1?1:0;var checkCoord=(coord+1)%2;var adjuster=1;if(coord===1){adjuster=-1}var ops=[];if(containedBB[coord][axis]*adjuster<containerBB[coord][axis]*adjuster){ops.push(axis+"|"+coord+"="+containerBB[coord][axis]);
if(containedBB[checkCoord][axis]*adjuster>containerBB[checkCoord][axis]*adjuster){ops.push(axis+"|"+checkCoord+"="+containerBB[checkCoord][axis])}else{if(anchorPoint.indexOf(anchorCheck)>-1){ops.push(axis+"|"+checkCoord+"="+containedBB[checkCoord][axis])}else{if((containerBB[coord][axis]+containedBB[dimension]*adjuster)*adjuster>containerBB[checkCoord][axis]*adjuster){ops.push(axis+"|"+checkCoord+"="+containerBB[checkCoord][axis])}}}}return ops}}};$.fn.containElement=function(theContained,theAnchorPoint){var container=$(this[0]);var contained=$(theContained);var anchorPoint=theAnchorPoint||"";var containerBB=container.getBoundingBox();var containedBB=contained.getBoundingBox();var offset=contained.offset();var css={};var ops=[];var boundingBoxContainer=new BoundingBoxContainer(containerBB,containedBB,anchorPoint);ops=ops.concat(boundingBoxContainer.containDimension("x","width","right",0));ops=ops.concat(boundingBoxContainer.containDimension("x","width","left",1));ops=ops.concat(boundingBoxContainer.containDimension("y","height","bottom",0));ops=ops.concat(boundingBoxContainer.containDimension("y","height","top",1));if(ops.length===0){}else{var shrinkWidth=false;var shrinkHeight=false;ops.sort();for(var i=0;i<ops.length;i++){var op=ops[i];if(!op){continue}var opParts=op.split("=");var value=parseInt(opParts[1]);var axis=opParts[0].split("|")[0];var coord=opParts[0].split("|")[1];if(axis==="x"){if(coord==="0"){offset.left=value;shrinkWidth=true}else{if(shrinkWidth){css.width=value-offset.left+"px"}else{offset.left=offset.left-(containedBB[0].x-value)}}}else{if(coord==="0"){shrinkHeight=true;offset.top=value}else{if(shrinkHeight){css.height=value-offset.top+"px"}else{offset.top=offset.top-(containedBB[1].y-value)}}}}}contained.offset(offset);contained.css(css)};$.fn.containByScreen=function(anchorPoint,options){if(this.first().css("position")!=="fixed"){return}options=options||{};var elementOffset=this.offset();var elementSizeBox={width:this.outerWidth(),height:this.outerHeight()};var anchorOffset=anchorPoint.offset();var anchorSizeBox={width:anchorPoint.outerWidth(),height:anchorPoint.outerHeight()};var screenBoundingBox=[{x:0,y:0},{x:window.innerWidth,y:window.innerHeight}];var elementBoundingBox=[{x:elementOffset.left,y:elementOffset.top},{x:elementOffset.left+elementSizeBox.width,y:elementOffset.top+elementSizeBox.top}];var newTop,newLeft,newBottom,newRight;if(options.isBottomAligned){newBottom=document.body.clientHeight-anchorOffset.top;elementOffset.top=newBottom-elementSizeBox.height}else{newTop=anchorOffset.top;if(!options.isTopAligned){newTop+=anchorSizeBox.height}elementOffset.top=newTop}if(options.isAligned){}else if(options.isRightAligned){newRight=document.body.clientWidth-anchorOffset.left-anchorSizeBox.width;elementOffset.left=newRight-elementSizeBox.width}else{newLeft=anchorOffset.left;elementOffset.left=newLeft}var trialBoundingBox;if(elementOffset.top+elementSizeBox.height>screenBoundingBox[1].y){trialBoundingBox=_.clone(elementBoundingBox);if(options.isAligned){trialBoundingBox[0].y=anchorOffset.top+anchorSizeBox.height-elementSizeBox.height}else{trialBoundingBox[0].y=anchorOffset.top-elementSizeBox.height}trialBoundingBox[1].y=trialBoundingBox[0].y+elementSizeBox.height;if(isYBounded(screenBoundingBox,trialBoundingBox)){newTop=trialBoundingBox[0].y}}else if(elementOffset.top<0){trialBoundingBox=_.clone(elementBoundingBox);if(options.isAligned){trialBoundingBox[0].y=anchorOffset.top}else{trialBoundingBox[0].y=anchorOffset.top+anchorSizeBox.height}trialBoundingBox[1].y=trialBoundingBox[0].y+elementSizeBox.height;if(isYBounded(screenBoundingBox,trialBoundingBox)){newTop=trialBoundingbox[0].y}}if(_.isNotReal(newTop)&&options.forceFit){if(elementOffset.top<0){newTop=0}else if(elementOffset.top+elementSizeBox.height>screenBoundingBox[1].y){newTop=screenBoundingBox[1].y-elementSizeBox.height}}if(elementOffset.left+elementSizeBox.width>screenBoundingBox[1].x){trialBoundingBox=_.clone(elementBoundingBox);if(options.isAligned){trialBoundingBox[0].x=anchorOffset.left-elementSizeBox.width}else{trialBoundingBox[0].x=anchorOffset.left-elementSizeBox.width+anchorSizeBox.width}trialBoundingBox[1].x=trialBoundingBox[0].x+elementSizeBox.width;if(isXBounded(screenBoundingBox,trialBoundingBox)){newLeft=trialBoundingBox[0].x}}else if(elementOffset.left<0){trialBoundingBox=_.clone(elementBoundingBox);if(options.isAligned){trialBoundingBox[0].x=anchorOffset.left+anchorSizeBox.width+elementSizeBox.width}else{trialBoundingBox[0].x=anchorOffset.left}trialBoundingBox[1].x=trialBoundingBox[0].x+elementSizeBox.width;if(isXBounded(screenBoundingBox,trialBoundingBox)){newLeft=trialBoundingBox[0].x}}if(_.isReal(newBottom)){this[0].style.bottom=newBottom+"px";this[0].style.top=""}else if(_.isReal(newTop)){this[0].style.top=newTop+"px";this[0].style.bottom=""}if(_.isReal(newRight)){this[0].style.right=newRight+"px";this[0].style.left=""}else if(newLeft){this[0].style.left=newLeft+"px";this[0].style.right=""}};$.fn.containRelativeElement=function(contained,leftAdjustment,topAdjustment){leftAdjustment=leftAdjustment||0;topAdjustment=topAdjustment||0;var offset=contained.offset();var containedBB=contained.getBoundingBox();var containerBB=this.getBoundingBox();if(containedBB[1].y>containerBB[1].y){offset.top=offset.top-containedBB.height-topAdjustment*2}if(containedBB[1].x>containerBB[1].x){offset.left-=containedBB[1].x-containerBB[1].x}var containerOffset=this.offset();offset.left+=leftAdjustment;offset.top+=topAdjustment;offset.left=Math.max(offset.left,0);offset.top=Math.max(offset.top,0);contained.css(offset)};function isYBounded(containerBB,containedBB){if(containerBB[0].y-CONSTANTS.BUFFER>containedBB[0].y){return false}if(containerBB[1].y+CONSTANTS.BUFFER<containedBB[1].y){return false}return true}function isXBounded(containerBB,containedBB){if(containerBB[0].x-CONSTANTS.BUFFER>containedBB[0].x){return false}if(containerBB[1].x+CONSTANTS.BUFFER<containedBB[1].x){return false}return true}})(Streak.jQuery);(function($){var getComputedStyle=document.defaultView&&document.defaultView.getComputedStyle,rupper=/([A-Z])/g,rdashAlpha=/-([a-z])/gi,fcamelCase=function(all,letter){return letter.toUpperCase()},getStyle=function(elem){if(getComputedStyle){return getComputedStyle(elem,null)}else if(elem.currentStyle){return elem.currentStyle}},rfloat=/float/i,rnumpx=/^-?\d+(?:px)?$/i,rnum=/^-?\d/;$.curStyles=function(el,styles){if(!el){return null}var currentS=getStyle(el),oldName,val,style=el.style,results={},i=0,left,rsLeft,camelCase,name;for(;i<styles.length;i++){name=styles[i];oldName=name.replace(rdashAlpha,fcamelCase);if(rfloat.test(name)){name=jQuery.support.cssFloat?"float":"styleFloat";oldName="cssFloat"}if(getComputedStyle){name=name.replace(rupper,"-$1").toLowerCase();val=currentS.getPropertyValue(name);if(name==="opacity"&&val===""){val="1"}results[oldName]=val}else{camelCase=name.replace(rdashAlpha,fcamelCase);results[oldName]=currentS[name]||currentS[camelCase];if(!rnumpx.test(results[oldName])&&rnum.test(results[oldName])){left=style.left;rsLeft=el.runtimeStyle.left;el.runtimeStyle.left=el.currentStyle.left;style.left=camelCase==="fontSize"?"1em":results[oldName]||0;results[oldName]=style.pixelLeft+"px";style.left=left;el.runtimeStyle.left=rsLeft}}}return results};$.fn.curStyles=function(){return $.curStyles(this[0],$.makeArray(arguments))}})(Streak.jQuery);(function($){$.expr[":"].Contains=function(a,i,m){return(a.textContent||a.innerText||"").toLowerCase().indexOf(m[3].toLowerCase())>=0};$.expr[":"].FastVisible=function(a,i,m){if(a.style.display==="none"){return false}var parents=$(a).parents();if(parents.length===0){return false}var body=false;for(var index=0;index<parents.length;index++){if(parents[index].style.display==="none"){return false}if(parents[index].tagName.toLowerCase()==="body"){body=true}}if(!body){return false}if(m==="compute"){return a.offsetHeight>0||a.offsetWidth>0}return true};$.expr[":"].DisplayVisible=function(a,i,m){var $a=$(a);if(a.style.display==="none"){return false}if($a.parents("body").length===0){return false}if($a.parents(":DisplayNone").length>0){return false}return true};$.expr[":"].NotDisplayNone=function(a,i,m){return a.style.display!=="none"};$.expr[":"].DisplayNone=function(a,i,m){return a.style.display==="none"};$.expr[":"].scroll=function(a,i,m){var $a=$(a);var styles=$a.curStyles("overflow","overflowX","overflowY");return/(auto|scroll)/.test(styles.overflow+styles.overflowX+styles.overflowY)};$.expr[":"].inBody=function(a,i,m){var check=a;while(true){if(!check){return false}else if(check.tagName&&check.tagName.toLowerCase()==="body"){return true}else{check=check.parentNode}}};$.fn._find=$.fn.find;$.fn.find=function(selector){return $(this.findReturnRaw(selector))};$.fn.findReturnRaw=function(selector){if(this.length===0){return $("")}else{var list=[];for(var i=0;i<this.length;i++){var newList=[];if(selector.indexOf(":")>-1||!this[i].querySelectorAll){return this._find(selector)}else{try{newList=this[i].querySelectorAll(selector)}catch(err){return this._find(selector)}}if(newList.length>0){for(var j=0;j<newList.length;j++){list.push(newList[j])}}}return list}};$.fn.outerHTML=function(){return this[0].outerHTML};$.fn.fastShow=function(displaySettings){displaySettings=displaySettings!=null?displaySettings:"block";for(var ii=0;ii<this.length;ii++){this[ii].style.display=displaySettings}return this};$.fn.fastHide=function(){for(var ii=0;ii<this.length;ii++){this[ii].style.display="none"}return this};$.fn.fastOnClick=function(callback,onCapture){for(var ii=0;ii<this.length;ii++){this[ii].addEventListener("click",callback,onCapture)}};$.fn.customBind=function(eventName,callback){for(var ii=0;ii<this.length;ii++){this[ii].addEventListener(eventName,callback)}};$.fn.customTrigger=function(eventName){var event=document.createEvent("Event");event.initEvent(eventName,true,true);for(var ii=0;ii<this.length;ii++){this[0].dispatchEvent(event)}};$.removeClassFromRaw=function(element,className){if(!className||!element){return this}var classesToRemove=className;if(!Array.isArray(className)){classesToRemove=className.split(" ")}var classes=element.getAttribute("class")||"";var existingClasses=classes.split(" ");var newClasses=[];for(var jj=0;jj<existingClasses.length;jj++){if(classesToRemove.indexOf(existingClasses[jj])===-1){newClasses.push(existingClasses[jj])}}element.setAttribute("class",newClasses.join(" "))};$.fastAddClassToRaw=function(element,className){var classes=element.getAttribute("class");element.setAttribute("class",classes+" "+className)};$.fn.smallHide=function(){this.css({height:1,width:1,visibility:"hidden",overflow:"hidden"});return this};$.fn.smallShow=function(){this.css({height:"",width:"",visibility:"",overflow:""});return this};$.fn.filterOutInvisible=function(){var retElements=[];for(var ii=0;ii<this.length;ii++){var element=this[ii];if(element.style.display==="none"){continue}var parents=$(element).fastParents();if(parents.length===0){continue}var body=false;for(var index=0;index<parents.length;index++){if(!parents[index].style){break}if(parents[index].style.display==="none"){break}if(parents[index].tagName.toLowerCase()==="body"){body=true}}if(!body){continue}retElements.push(element)}return $(retElements)};$.fn.isVisible=function(){return this.filterOutInvisible().length>0};$.fn.fastParents=function(){var parents=[];if(this.length===0){return $(parents)}var node=this[0];for(var ii=0;ii<1e4;ii++){var node=node.parentNode;if(!node){break}if(node.nodeName==="#document"){break}parents.push(node)}return $(parents)};$.fn.isInBody=function(){var parents=this.fastParents();for(var ii=0;ii<parents.length;ii++){if(parents[ii].nodeName.toLowerCase()==="body"){return true}}return false};$.fn.isAncestor=function(potentialChild){var child=potentialChild;if(child.length){child=child[0]}for(var nodeIndex=0;nodeIndex<this.length;nodeIndex++){var node=child;for(var ii=0;ii<1e4;ii++){if(node===this[nodeIndex]){return true}var node=node.parentNode;if(!node){break}if(node.nodeName==="#document"){break}}}return false};$.fn.__oldVal=$.fn.val;$.fn.val=function(value){var returnValue="";var originalArguments=arguments;this.each(function(index){if(this.nodeName==="DIV"&&this.getAttribute("contenteditable")==="true"){if(originalArguments.length===1){this.innerHTML=value}else if(index===0){returnValue=this.innerHTML}}else{if(originalArguments.length>0){$(this).__oldVal(value)}else if(index===0){returnValue=$(this).__oldVal()}}});return returnValue}})(Streak.jQuery);(function($){$.fn.extend({delayedSave:function(opts){var defaults={saveFunction:null,delay:1e3,enter:false,enterCutoff:false,dontPropagate:false,saveOnBlur:true,keyEvent:"keydown"};var options={};$.extend(options,defaults,opts);return this.each(function(){var o=options,timer,self=$(this),enterTriggered=false,pending=false,content=self.val()||self.html(),callsave=function(isEnter,isPending){clearTimeout(timer);if(content!=(self.val()||self.html())||isEnter){content=self.val()||self.html();if(o.saveFunction){o.saveFunction.call(self,isEnter,isPending)}}};self.focus(function(e){content=self.val()||self.html()});if(options.saveOnBlur){self.bind("blur",function(e){var isEnter=enterTriggered;var isPending=pending;enterTriggered=false;pending=false;if((self.val()||self.html())!=content||isEnter){callsave(isEnter,isPending)}})}self.on("keydown",function(e){if(o.enter&&e.which===13){enterTriggered=true;self.blur()}if(o.dontPropagate){e.stopPropagation()}});if(o.delay){self.on("input",function(e){clearTimeout(timer);timer=setTimeout(function(){pending=true;callsave(e.which===13);pending=false},o.delay);if(o.dontPropagate){e.stopPropagation()}})}else{self.on("input",function(e){callsave();if(o.dontPropagate){e.stopPropagation()}})}self.bind("delayedSave",function(){callsave(false)})})}})})(Streak.jQuery);(function($){$.fn.extend({easyHoverClass:function(hoverClass,namespace,noBlur,applyEl){var theHoverClass=hoverClass;return this.each(function(){var self=$(this),hold=false,isOver=false,disabled=false;var hoverApplyEl=applyEl||self;var eventNamespace=namespace?".namespace":"";self.on("mouseenter"+eventNamespace,function(e){if(disabled){return}hoverApplyEl.addClass(theHoverClass);isOver=true});self.on("mouseleave"+eventNamespace,function(e){isOver=false;if(!hold){hoverApplyEl.removeClass(theHoverClass)}});self.focus(function(e){hold=true;hoverApplyEl.addClass(theHoverClass)});if(!noBlur){self.blur(function(e){hold=false;hoverApplyEl.removeClass(theHoverClass)})}self.bind({hold:function(){hoverApplyEl.addClass(theHoverClass);hold=true},unhold:function(){if(!isOver)hoverApplyEl.removeClass(theHoverClass);hold=false},disabled:function(){disabled=true},enabled:function(){disabled=false}})})},superEasyHoverClass:function(hoverClass){for(var ii=0;ii<this.length;ii++){var el=this[ii];el.addEventListener("mouseover",function(e){$(this).addClass(hoverClass)});el.addEventListener("mouseout",function(e){$(this).removeClass(hoverClass)})}}})})(Streak.jQuery);(function($){$.fn.extend({easyTab:function(o){var defaults={prev:-1,next:-1,delay:null,namespace:null};var options={};$.extend(options,defaults,o);options.namespace=options.namespace||"easyTab";return this.each(function(){var self=$(this);var go=function(isPrev){if((isPrev?options.prev:options.next)===-1){return true}self.blur();if(options.delay){setTimeout(function(){goNow(isPrev)},50)}else{goNow(isPrev)}};var goNow=function(isPrev){if(isPrev){if(options.prev){if(options.prev.is(":visible")){options.prev.focus()}else{setTimeout(function(){options.prev.trigger("shiftTabPressed")},10)}}}else{if(options.next){if(options.next.is(":visible")){options.next.focus()}else{setTimeout(function(){options.next.trigger("tabPressed")},10)}}}};self.bind("keydown."+options.namespace,function(e){if(e.which==9){if(e.shiftKey){if(go(true)){return}}else{if(go()){return}}e.stopPropagation();e.preventDefault()}});self.bind("tabPressed."+options.namespace,function(e){go()});self.bind("shiftTabPressed."+options.namespace,function(e){go(true)})})}});$.tabChain=function(arr,delay,namespace){if(arr&&arr.length>0){for(var i=0;i<arr.length;i++){var prev=(i-1)%arr.length;var next=(i+1)%arr.length;if(prev<0){prev=arr.length+prev}if(arr[i]&&arr[i]!==-1){arr[i].easyTab({prev:arr[prev],next:arr[next],delay:delay,namespace:namespace})}}}}})(Streak.jQuery);(function(Streak,len,createRange,duplicate){var $=Streak.jQuery;$.fn.caret=function(options,opt2){var doc=Streak.document;var start,end,t=this[0];if(typeof options==="object"&&typeof options.start==="number"&&typeof options.end==="number"){start=options.start;end=options.end}else if(typeof options==="number"&&typeof opt2==="number"){start=options;end=opt2}else if(typeof options==="string"){if((start=t.value.indexOf(options))>-1)end=start+options[len];else start=null}else if(Object.prototype.toString.call(options)==="[object RegExp]"){var re=options.exec(t.value);if(re!==null){start=re.index;end=start+re[0][len]}}if(typeof start!="undefined"){this[0].selectionStart=start;this[0].selectionEnd=end;this[0].focus();return this}else{var s=t.selectionStart,e=t.selectionEnd;if(t.tagName==="INPUT"){var te=t.value.substring(s,e);return{start:s,end:e,text:te,replace:function(st){return t.value.substring(0,s)+st+t.value.substring(e,t.value[len])},goToEnd:function(){if(t.setSelectionRange){var len=$(t).val().length*2;t.setSelectionRange(len,len)}else{$(t).val($(t).val())}}}}var startOffset=0;try{startOffset=doc.getSelection().getRangeAt().startOffset}catch(err){}var endOffset;try{endOffset=doc.getSelection().getRangeAt().endOffset}catch(err){}return{start:startOffset,end:endOffset,goToEnd:function(){var sel,range;if(doc.createRange){range=doc.createRange();range.selectNodeContents(t);range.collapse(false);sel=doc.getSelection();sel.removeAllRanges();sel.addRange(range)}}}}};$.fn.insertHTMLAtCaret=function(text){this.focus();if(this.is("textarea")){var ta=this[0];var oldStart=ta.selectionStart;if(ta.selectionStart<ta.selectionEnd){ta.value=ta.value.substring(0,ta.selectionStart)+ta.value.substring(ta.selectionEnd)}ta.value=ta.value.substring(0,oldStart)+text+ta.value.substring(oldStart);ta.selectionStart=oldStart+text.length;ta.selectionEnd=oldStart+text.length}else{var sel,range,textNode;var editable=null;if(this[0].getSelection){editable=this[0]}else if(this[0].ownerDocument&&this[0].ownerDocument.getSelection){editable=this[0].ownerDocument}if(editable){sel=editable.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var el=document.createElement("div");el.innerHTML=text;var frag=document.createDocumentFragment(),firstNode=el.firstChild,node,lastNode;while(node=el.firstChild){lastNode=frag.appendChild(node)}range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range)}return firstNode}}}};$.fn.insertTextAtCaret=function(text){this.focus();if(this.is("textarea")){var ta=this[0];var oldStart=ta.selectionStart;if(ta.selectionStart<ta.selectionEnd){ta.value=ta.value.substring(0,ta.selectionStart)+ta.value.substring(ta.selectionEnd)}ta.value=ta.value.substring(0,oldStart)+text+ta.value.substring(oldStart);ta.selectionStart=oldStart+text.length;ta.selectionEnd=oldStart+text.length}else{var sel,range,textNode;var editable=null;if(this[0].getSelection){editable=this[0]}else if(this[0].ownerDocument&&this[0].ownerDocument.getSelection){editable=this[0].ownerDocument}if(editable){sel=editable.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var node=document.createTextNode(text);range.insertNode(node);range=range.cloneRange();range.setStartAfter(node);range.collapse(true);sel.removeAllRanges();sel.addRange(range)}}}};$.fn.deleteText=function(numberOfCharacters){this.focus();if(this.is("textarea")){var ta=this[0];var oldStart=ta.selectionStart;var begVal=ta.value.substring(0,ta.selectionStart-numberOfCharacters+1);var endVal=ta.value.substring(ta.selectionStart);ta.value=begVal+endVal;ta.selectionStart=oldStart-numberOfCharacters+1;ta.selectionEnd=ta.selectionStart}else{var sel,range;var editor=null;if(this[0].getSelection){editor=this[0]}else if(this[0].ownerDocument){editor=this[0].ownerDocument}if(editor.getSelection){sel=editor.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.setStart(range.startContainer,range.startOffset-numberOfCharacters);range.deleteContents()}}}};$.fn.insertTextAtNodeAndPosition=function(text,node,position){if(this.is("textarea")){var ta=this[0];var oldStart=ta.selectionStart;if(ta.selectionStart<ta.selectionEnd){ta.value=ta.value.substring(0,ta.selectionStart)+ta.value.substring(ta.selectionEnd)}ta.value=ta.value.substring(0,oldStart)+text+ta.value.substring(oldStart);ta.selectionStart=oldStart+text.length;ta.selectionEnd=oldStart+text.length}else{var sel,range,textNode;var editable=null;if(this[0].getSelection){editable=this[0]}else if(this[0].ownerDocument&&this[0].ownerDocument.getSelection){editable=this[0].ownerDocument}if(editable){sel=editable.getSelection();if(node&&_.isReal(position)){range=sel.getRangeAt().cloneRange();sel.removeAllRanges();range.selectNode(node);range.collapse(position===0);sel.addRange(range);sel.setPosition(position)}if(!range){range=sel.getRangeAt(0);range.deleteContents()}var el=document.createElement("div");el.innerHTML=text;var frag=document.createDocumentFragment(),firstNode=el.firstChild,node,lastNode;while(node=el.firstChild){lastNode=frag.appendChild(node)}range.insertNode(frag);if(lastNode){setTimeout(function(){range=document.createRange();range.selectNodeContents(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range)},10)}return firstNode}}};$.fn.getCursorNodeAndPosition=function(){var sel=this[0].ownerDocument.getSelection();var node=sel.focusNode?sel.focusNode:null;var position=node?sel.getRangeAt().startOffset:null;return{node:node,position:position}};$.fn.selectContents=function(){var sel=this[0].ownerDocument.getSelection();var range=this[0].ownerDocument.createRange();range.selectNodeContents(this[0]);sel.removeAllRanges();sel.addRange(range)}})(Streak,"length","createRange","duplicate");(function($){$.fn.MultipleAutoSuggest=function(config){var defaults={data:null,wrapperCss:{},minChars:2,dataFunc:function(query,cb){},stringDataFunc:$.noop,convertFunc:function(query,data){},compareFunc:function(query,dataItem){},selectFunc:function(data){},removeFunc:function(data){},doneFunc:function(list){},listChangeFunc:function(list){},clickStop:null,clickBody:null,noResultsFoundText:null,immediateDone:false,idProperty:"email",suggestionTemplate:null,existingList:[],onlyValidEmailAddress:false};var options={};$.extend(options,defaults,config);return this.each(function(){var self=this;var input=$(this);var parent=input.parent();parent.addClass("parent");parent.css(options.wrapperCss);parent.after('<div style="clear:both;"></div>');var dataList=[];var ids=[];var hasFocus=false;var blurTimeout=null;var internalSelectFunction=options.selectFunc;options.selectFunc=select;options.getExcludedIDsFunc=function(){return ids};input.AutoSuggest(options);if(options.data){$.each(options.data,function(i,v){addSelection(v)})}input.bind("setPeopleList",function(e){parent.parent().find(".autoChosen").remove();dataList=[];ids=[];var peopleList=input.data("peopleList")||[];$.each(peopleList,function(i,v){addSelection(v)})});input[0].addEventListener("keydown",function(event){switch(event.which){case 27:hasFocus=false;break;case 8:if(!input.val()){parent.parent().find(".vR:last .vM").trigger("click");input.trigger("bbFocus");input.trigger("bbUnselect")}break}},true);input.focus(function(){hasFocus=true;clearTimeout(blurTimeout)});input.bind("enterPressed shiftTabPressed tabPressed",function(e){offFocus()});input.blur(function(){hasFocus=false;clearTimeout(blurTimeout);blurTimeout=setTimeout(function(){if(!hasFocus){offFocus()}},150)});function select(selectedItem){internalSelectFunction(selectedItem);addSelection(selectedItem);input.trigger("bbFocus")}function addSelection(data){var sel=$(Streak.Template.underscore("lib/jqueryplugins/multipleautosuggest")({name:data.fullName||data.email,email:data.email}));var close=sel.find(".vM");close.click(function(e){input.focus();dataList.removeVal(data);ids.removeVal(getIDValue(data));sel.remove();if(options.removeFunc){options.removeFunc(data)}if(options.listChangeFunc){options.listChangeFunc(dataList)}e.preventDefault();return false});parent.before(sel);dataList.push(data);ids.push(getIDValue(data));if(options.listChangeFunc){options.listChangeFunc(dataList)}return sel}function getIDValue(data){if(options.onlyValidEmailAddress){return data[options.idProperty]}else{return data[options.idProperty]||data.displayName}}function offFocus(){if(hasFocus){hasFocus=false}if(options.doneFunc){options.doneFunc(dataList)}}})}})(Streak.jQuery);(function($){var Date=Streak.Date;$.fn.pickdate=function(opts){if(this.length>1){throw new Error("dont call pick date with more than one element")}if(this.length===0){return null}return new pickdate(this,opts)};function pickdate(element,options){var init_clone_val;this.element=$(element);this.options={};$.extend(this.options,{pickerClass:"streak__pickDate",days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],dayShort:2,monthShort:3,startDay:0,timePicker:false,timePickerOnly:false,yearPicker:true,militaryTime:false,yearsPerPage:20,format:"m-d-Y",allowEmpty:false,inputOutputFormat:"U",animationDuration:400,useFadeInOut:true,startView:"month",positionOffset:{x:0,y:0},useFixedPosition:true,minDate:null,maxDate:null,debug:false,appendTo:document.body,body:document.body,isPersistent:false,setInput:true,autoClose:true,onShow:$.noop,onClose:$.noop,onSelect:$.noop,onClear:$.noop},options);this.formatMinMaxDates();if(this.options.timePickerOnly){this.options.timePicker=true;this.options.startView="time"}if(init_clone_val===this.element.val()){init_clone_val=this.format(new Date(this.unformat(init_clone_val,this.options.inputOutputFormat)),this.options.format)}else if(!options.allowEmpty){init_clone_val=this.format(new Date,this.options.format)}else{init_clone_val=""}this.display=this.element.css("display");var self=this;this.element.bind({keydown:$.proxy(function(e){if(e.which==27){if(this.element.data("time")){this.choice=this.dateToObject(Date.ccreate(this.element.data("time")));this.select(this.choice)}else{this.element.val("");this.close(null,true)}}else if(e.which==13){if(this.element.val().length>0){var d=Date.ccreate(this.element.val());if(d.isValid()){this.choice=this.dateToObject(d);this.select(this.choice,true)}else{this.element.val("");if($.isFunction(this.options.onClear)){this.options.onClear()}this.close(null,true,true)}}else{if($.isFunction(this.options.onClear)){this.options.onClear()}this.close(null,true,true)}e.preventDefault();e.stopPropagation()}else if(e.which===9){self.close(null,true)}},this),keyup:$.proxy(function(e){var d=Date.ccreate(this.element.val());if(!d.isValid()){d=Date.ccreate(this.element.val(),Streak.BentoBox.Locale.getCurrent())}if(d.isValid()){this.choice=this.dateToObject(d);this.render(null,d)}},this)});if(this.options.isPersistent){this.showCalendar()}else{this.element.bind({onfocus:$.proxy(function(e){this.showCalendar()},this),onblur:$.proxy(function(e){this.close(null,true,false)},this)})}}pickdate.prototype={showCalendar:function(){var original=this.element;var visual_input=original;var init_visual_date=original.data("time");var d=visual_input.offset();if(init_visual_date){init_visual_date=Date.ccreate(init_visual_date)}else{init_visual_date=new Date;if(this.options.maxDate&&init_visual_date.valueOf()>this.options.maxDate.valueOf()){init_visual_date=new Date(this.options.maxDate.valueOf())}if(this.options.minDate&&init_visual_date.valueOf()<this.options.minDate.valueOf()){init_visual_date=new Date(this.options.minDate.valueOf())}}this.input=original;this.visual=visual_input;if(!this.options.isPersistent){this.show({left:d.left+this.options.positionOffset.x,top:d.top+this.visual.outerHeight()+this.options.positionOffset.y},init_visual_date)}else{this.show({left:0,top:0},init_visual_date)}},dateToObject:function(d){return{year:d.getFullYear(),month:d.getMonth(),day:d.getDate(),hours:d.getHours(),minutes:d.getMinutes(),seconds:d.getSeconds()}},dateFromObject:function(values){var d=new Date,v;d.setDate(1);$.each(["year","month","day","hours","minutes","seconds"],$.proxy(function(index,value){v=values[value];if(!(v||v===0))return;switch(value){case"day":d.setDate(v);break;case"month":d.setMonth(v);break;case"year":d.setFullYear(v);break;case"hours":d.setHours(v);break;case"minutes":d.setMinutes(v);break;case"seconds":d.setSeconds(v);break}},this));return d},show:function(position,timestamp){this.formatMinMaxDates();if(timestamp){this.working_date=Date.ccreate(timestamp)}else{this.working_date=Date.ccreate()}this.today=Date.ccreate();this.choice=this.dateToObject(this.working_date);this.mode=this.options.startView=="time"&&!this.options.timePicker?"month":this.options.startView;this.render();if($.isFunction(this.options.onShow))this.options.onShow()},render:function(use_fx,aDate){if(!this.picker){this.constructPicker()}else{var o=this.oldContents;this.oldContents=this.newContents;this.newContents=o;this.newContents.empty()}if(aDate)this.working_date=aDate;var startDate=new Date(this.working_date.getTime());this.limit={right:false,left:false};switch(this.mode){case"decades":this.renderDecades();break;case"year":this.renderYear();break;case"time":this.renderTime();this.limit={right:true,left:true};break;default:this.renderMonth()}this.picker.find(".previous").toggleClass("disabled",this.limit.left);this.picker.find(".next").toggleClass("disabled",this.limit.right);this.picker.find(".title").css("cursor",this.allowZoomOut()?"pointer":"default");this.working_date=startDate;if(this.options.useFadeInOut){this.picker.fadeIn(this.options.animationDuration)}if(use_fx){this.fx(use_fx)}else{this.oldContents.hide();this.newContents.css({left:"0px"}).show()}if(this.options.useFixedPosition){this.picker.containByScreen(this.options.appendTo)}},fx:function(effects){if(effects=="right"){this.oldContents.css("left",0).show();this.newContents.css("left",this.bodyWidth).show();this.slider.css("left",-this.bodyWidth)}else if(effects=="left"){this.oldContents.css("left",this.bodyWidth).show();this.newContents.css("left",0).show();this.slider.css("left",0)}else if(effects=="fade"){this.slider.css("left",0);this.oldContents.css("left",0).fadeOut(this.options.animationDuration>>1);this.newContents.css("left",0).hide().fadeIn(this.options.animationDuration)}},constructPicker:function(){var self=this;$(this.options.appendTo).append(this.picker=$('<div class="'+this.options.pickerClass+'" tabindex="-1"/>'));if(this.options.useFadeInOut){this.picker.hide()}if(this.options.isPersistent)this.picker.css({position:"relative"});var h,title_cont,b;this.picker.append(h=$('<div class="header"/>'));h.append(title_cont=$('<div class="title"/>').captureClick($.proxy(this.zoomOut,this)));h.append($('<div class="previous">&larr;</div>').captureClick(function(){setTimeout(function(){self.previous()},20)}));h.append($('<div class="next">&rarr;</div>').captureClick(function(){setTimeout(function(){self.next()},20)}));h.append($('<div class="closeButton">x</div>').captureClick($.proxy(this.close,this)));title_cont.append($('<span class="titleText"/>'));this.picker.append(b=$('<div class="body"/>'));this.bodyHeight=193;this.bodyWidth=208;b.append(this.slider=$('<div style="position:absolute;top:0;left:0;width:'+2*this.bodyWidth+"px;height:"+2*this.bodyHeight+'px" />'));this.slider.append(this.oldContents=$('<div style="position:absolute;top:0;left:'+this.bodyWidth+"px;width:"+this.bodyWidth+"px;height:"+this.bodyHeight+'px" />'));
this.slider.append(this.newContents=$('<div style="position:absolute;top:0;left:0;width:'+this.bodyWidth+"px;height:"+this.bodyHeight+'px" />'));if(this.options.autoClose){this.picker.bodyCloseAndStop({body:$(this.options.body),stop:$(this.options.appendTo)[0],closeFunction:function(){self.close(null,true)}})}if(this.options.useFixedPosition){this.picker[0].style.position="fixed"}},renderDecades:function(){while(this.working_date.getFullYear()%this.options.yearsPerPage>0){this.working_date.setFullYear(this.working_date.getFullYear()-1)}this.renderTitle(this.working_date.getFullYear()+"-"+(this.working_date.getFullYear()+this.options.yearsPerPage-1));var i,y,e,available=false,container;this.newContents.append(container=$('<div class="years"/>'));if(this.options.minDate&&this.working_date.getFullYear()<=this.options.minDate.getFullYear()){this.limit.left=true}for(i=0;i<this.options.yearsPerPage;i++){y=this.working_date.getFullYear();container.append(e=$('<div class="year year'+i+(y==this.today.getFullYear()?" today":"")+(y==this.choice.year?" selected":"")+'">'+y+"</>"));if(this.limited("year")){e.addClass("unavailable");if(available){this.limit.right=true}else{this.limit.left=true}}else{available=true;e.click({year:y},$.proxy(function(event){this.working_date.setFullYear(event.data.year);this.mode="year";this.render("fade")},this))}this.working_date.setFullYear(this.working_date.getFullYear()+1)}if(!available||this.options.maxDate&&this.working_date.getFullYear()>=this.options.maxDate.getFullYear()){this.limit.right=true}},renderYear:function(){var month=this.today.getMonth(),this_year=this.working_date.getFullYear()==this.today.getFullYear(),selected_year=this.working_date.getFullYear()==this.choice.year,available=false,container,i,e;this.renderTitle(this.working_date.getFullYear());this.working_date.setMonth(0);this.newContents.append(container=$('<div class="months"/>'));for(i=0;i<=11;i++){container.append(e=$('<div class="month month'+(i+1)+(i==month&&this_year?" today":"")+(i==this.choice.month&&selected_year?" selected":"")+'">'+(this.options.monthShort?this.options.months[i].substring(0,this.options.monthShort):this.options.months[i])+"</div>"));if(this.limited("month")){e.addClass("unavailable");if(available){this.limit.right=true}else{this.limit.left=true}}else{available=true;e.click({month:i},$.proxy(function(event){this.working_date.setDate(1);this.working_date.setMonth(event.data.month);this.mode="month";this.render("fade")},this))}this.working_date.setMonth(i)}if(!available)this.limit.right=true},renderTime:function(){var container;this.newContents.append(container=$('<div class="time"/>'));if(this.options.timePickerOnly){this.renderTitle("Select a time")}else{this.renderTitle(this.format(this.working_date,"j M, Y"))}container.append($('<input type="text" class="hour"'+(this.options.militaryTime?' style="left:30px"':"")+' maxlength="2" value="'+this.leadZero(this.options.militaryTime?this.working_date.getHours():this.working_date.getHours()>12?this.working_date.getHours()-12:this.working_date.getHours())+'"/>'));container.append($('<input type="text" class="minutes"'+(this.options.militaryTime?' style="left:110px"':"")+' maxlength="2" value="'+this.leadZero(this.working_date.getMinutes())+'"/>'));container.append($('<div class="separator"'+(this.options.militaryTime?' style="left:91px"':"")+">:</div>"));if(!this.options.militaryTime){container.append($('<select class="ampn">'+'<option value="PM">PM</option>'+'<option value="AM">AM</option>'+"</select>"))}container.append($('<input type="submit" value="OK" class="ok"/>').click($.proxy(function(event){event.stopPropagation();this.select($.extend(this.dateToObject(this.working_date),{hours:parseInt(this.picker.find(".hour").val(),10)+(!this.options.militaryTime&&this.picker.find(".ampm").val()=="PM"?12:0),minutes:parseInt(this.picker.find(".minutes").val(),10)}))},this)))},renderMonth:function(){if(!this.today){this.today=Date.create()}var month=this.working_date.getMonth(),container=$('<div class="days"/>'),titles=$('<div class="titles"/>'),available=false,t=this.today.toDateString(),currentChoice=this.dateFromObject(this.choice).toDateString(),d,i,classes,e,weekContainer;this.renderTitle(this.options.months[month]+" "+this.working_date.getFullYear());this.working_date.setDate(1);for(i=0;i<1e3;i++){if(this.working_date.getDay()===this.options.startDay){break}this.working_date.setDate(this.working_date.getDate()-1)}this.newContents.append(container.append(titles));for(d=this.options.startDay;d<this.options.startDay+7;d++){titles.append($('<div class="title day day'+d%7+'">'+this.options.days[d%7].substring(0,this.options.dayShort)+"</div>"))}for(i=0;i<42;i++){classes=["day","day"+this.working_date.getDay()];if(this.working_date.toDateString()==t)classes.push("today");if(this.working_date.toDateString()==currentChoice)classes.push("selected");if(this.working_date.getMonth()!=month)classes.push("otherMonth");if(i%7===0){container.append(weekContainer=$('<div class="week week'+Math.floor(i/7)+'"/>'))}weekContainer.append(e=$('<div class="'+classes.join(" ")+'">'+this.working_date.getDate()+"</div>"));if(this.limited("date")){e.addClass("unavailable");if(available){this.limit.right=true}else if(this.working_date.getMonth()==month){this.limit.left=true}}else{available=true;e.click({day:this.working_date.getDate(),month:this.working_date.getMonth(),year:this.working_date.getFullYear()},$.proxy(function(event){if(this.options.timePicker){this.working_date.setDate(event.data.day);this.working_date.setMonth(event.data.month);this.mode="time";this.render("fade")}else{event.stopPropagation();this.select(event.data)}},this))}this.working_date.setDate(this.working_date.getDate()+1)}if(!available)this.limit.right=true},renderTitle:function(text){if(this.allowZoomOut()){this.picker.find(".title").removeClass("disabled")}else{this.picker.find(".title").addClass("disabled")}this.picker.find(".titleText").text(text)},limited:function(type){var cs=!!this.options.minDate,ce=!!this.options.maxDate;if(!(cs&&ce))return false;switch(type){case"year":return cs&&this.working_date.getFullYear()<this.options.minDate.getFullYear()||ce&&this.working_date.getFullYear()>this.options.maxDate.getFullYear();case"month":var ms=parseInt(""+this.working_date.getFullYear()+this.leadZero(this.working_date.getMonth()),10);return cs&&ms<parseInt(""+this.options.minDate.getFullYear()+this.leadZero(this.options.minDate.getMonth()),10)||ce&&ms>parseInt(""+this.options.maxDate.getFullYear()+this.leadZero(this.options.maxDate.getMonth()),10);case"date":return cs&&this.working_date<this.options.minDate||ce&&this.working_date>this.options.maxDate}},allowZoomOut:function(){if(this.mode=="time"&&this.options.timePickerOnly)return false;if(this.mode=="decades")return false;return!(this.mode=="year"&&!this.options.yearPicker)},zoomOut:function(){if(!this.allowZoomOut())return;switch(this.mode){case"year":this.mode="decades";break;case"time":this.mode="month";break;default:this.mode="year"}this.render("fade")},previous:function(){switch(this.mode){case"decades":this.working_date.setFullYear(this.working_date.getFullYear()-this.options.yearsPerPage);break;case"year":this.working_date.setFullYear(this.working_date.getFullYear()-1);break;case"month":this.working_date.setMonth(this.working_date.getMonth()-1)}if(this.mode!="time"){this.render("left")}},next:function(){switch(this.mode){case"decades":this.working_date.setFullYear(this.working_date.getFullYear()+this.options.yearsPerPage);break;case"year":this.working_date.setFullYear(this.working_date.getFullYear()+1);break;case"month":this.working_date.setMonth(this.working_date.getMonth()+1)}if(this.mode!="time"){this.render("right")}},hideCalendar:function(){this.close(null,true)},close:function(e,force,isEnter){var self=this;if(!this.picker||this.closing||this.options.isPersistent)return;if(force||e&&e.target!==this.picker&&this.picker.has(e.target).size()===0&&e.target!==this.visual){if(this.options.useFadeInOut){this.closing=true;this.picker.fadeOut(this.options.animationDuration>>1,function(){self.destroy(isEnter)})}else{this.destroy(isEnter)}}},destroy:function(isEnter){this.picker.remove();this.picker=null;this.closing=false;if($.isFunction(this.options.onClose)){this.options.onClose(isEnter)}},select:function(values,isEnter){this.working_date=this.dateFromObject($.extend(this.choice,values));if(!this.options.timePicker){var dDate=new Date(this.working_date.getFullYear(),this.working_date.getMonth(),this.working_date.getDate(),12,0,0);dDate.toLocalTime();this.working_date.setTime(dDate.getTime())}if(this.options.setInput&&this.input){this.input.val(this.format(this.working_date,this.options.inputOutputFormat))}if(this.visual){this.visual.val(this.format(this.working_date,this.options.format))}if($.isFunction(this.options.onSelect))this.options.onSelect(this.working_date);this.close(null,true,isEnter)},formatMinMaxDates:function(){if(this.options.maxDate&&this.options.maxDate.format){this.options.maxDate=this.unformat(this.options.maxDate.date,this.options.maxDate.format);this.options.maxDate.setHours(23);this.options.maxDate.setMinutes(59);this.options.maxDate.setSeconds(59)}},leadZero:function(v){return v<10?"0"+v:v},format:function(t,format){var f="",h=t.getHours(),m=t.getMonth();for(var i=0;i<format.length;i++){switch(format.charAt(i)){case"\\":i++;f+=format.charAt(i);break;case"y":f+=(100+t.getYear()+"").substring(1);break;case"Y":f+=t.getFullYear();break;case"m":f+=this.leadZero(m+1);break;case"n":f+=m+1;break;case"M":f+=this.options.months[m].substring(0,this.options.monthShort);break;case"F":f+=this.options.months[m];break;case"d":f+=this.leadZero(t.getDate());break;case"j":f+=t.getDate();break;case"D":f+=this.options.days[t.getDay()].substring(0,this.options.dayShort);break;case"l":f+=this.options.days[t.getDay()];break;case"G":f+=h;break;case"H":f+=this.leadZero(h);break;case"g":f+=h%12?h%12:12;break;case"h":f+=this.leadZero(h%12?h%12:12);break;case"a":f+=h>11?"pm":"am";break;case"A":f+=h>11?"PM":"AM";break;case"i":f+=this.leadZero(t.getMinutes());break;case"s":f+=this.leadZero(t.getSeconds());break;case"U":f+=Math.floor(t.valueOf()/1e3);break;default:f+=format.charAt(i)}}return f},unformat:function(t,format){var d=new Date,a={},c,m,v;t=t.toString();for(var i=0;i<format.length;i++){c=format.charAt(i);switch(c){case"\\":r=null;i++;break;case"y":r="[0-9]{2}";break;case"Y":r="[0-9]{4}";break;case"m":r="0[1-9]|1[012]";break;case"n":r="[1-9]|1[012]";break;case"M":r="[A-Za-z]{"+this.options.monthShort+"}";break;case"F":r="[A-Za-z]+";break;case"d":r="0[1-9]|[12][0-9]|3[01]";break;case"j":r="[1-9]|[12][0-9]|3[01]";break;case"D":r="[A-Za-z]{"+this.options.dayShort+"}";break;case"l":r="[A-Za-z]+";break;case"G":case"H":case"g":case"h":r="[0-9]{1,2}";break;case"a":r="(am|pm)";break;case"A":r="(AM|PM)";break;case"i":case"s":r="[012345][0-9]";break;case"U":r="-?[0-9]+$";break;default:r=null}if(r){m=t.match("^"+r);if(m){a[c]=m[0];t=t.substring(a[c].length)}else{if(this.options.debug)alert("Fatal Error in will_pickdate\n\nUnexpected format at: '"+t+"' expected format character '"+c+"' (pattern '"+r+"')");return d}}else{t=t.substring(1)}}for(c in a){v=a[c];switch(c){case"y":d.setFullYear(v<30?2e3+parseInt(v,10):1900+parseInt(v,10));break;case"Y":d.setFullYear(v);break;case"m":case"n":d.setMonth(v-1);break;case"M":v=this.options.months.filter(function(index){return this.substring(0,this.options.monthShort)==v})[0];case"F":d.setMonth(options.months.indexOf(v));break;case"d":case"j":d.setDate(v);break;case"G":case"H":d.setHours(v);break;case"g":case"h":if(a["a"]=="pm"||a["A"]=="PM"){d.setHours(v==12?0:parseInt(v,10)+12)}else{d.setHours(v)}break;case"i":d.setMinutes(v);break;case"s":d.setSeconds(v);break;case"U":d=new Date(parseInt(v,10)*1e3)}}return d}}})(Streak.jQuery);(function(Streak){var $=Streak.jQuery,Date=Streak.Date;function prettyDate(time,justDate){var date=new Date(time),diff=((new Date).getTime()-date.getTime())/1e3,day_diff=Math.floor(diff/86400),year_diff=Math.abs((new Date).getYear()-date.getYear());if(isNaN(day_diff)||(day_diff<0||day_diff>=31)&&!justDate)return"";if(justDate){var parts=date.toDateString().split(" ");return year_diff===0&&parts[1]+" "+parts[2]||parts[1]+" "+parts[2]+" "+parts[3]}else{return day_diff===0&&(diff<60&&"just now"||diff<120&&"1 minute ago"||diff<3600&&Math.floor(diff/60)+" minutes ago"||diff<7200&&"1 hour ago"||diff<86400&&Math.floor(diff/3600)+" hours ago")||day_diff==1&&"Yesterday"||day_diff<7&&day_diff+" days ago"||day_diff<31&&Math.ceil(day_diff/7)+" weeks ago"}}$.fn.prettyDate=function(justDate){return this.each(function(){var date=prettyDate(this.title,justDate);if(date)Streak.jQuery(this).text(date)})};Date.prototype.prettyDate=function(justDate){return prettyDate(this,justDate)}})(Streak);(function(Streak){var $=Streak.jQuery;$.fn.selectAllOnClick=function(){return this.each(function(){$(this).click(function(e){var sel=Streak.document.getSelection();sel.removeAllRanges();sel.selectAllChildren(this)}.bind(this))})}})(Streak);(function($){var converter={vertical:{x:false,y:true},horizontal:{x:true,y:false},both:{x:true,y:true},x:{x:true,y:false},y:{x:false,y:true}};var settings={duration:"fast",direction:"both",toTop:false};var rootrx=/^(?:html)$/i;var borders=function(domElement,styles){styles=styles||(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(domElement,null):domElement.currentStyle);var px=document.defaultView&&document.defaultView.getComputedStyle?true:false;var b={top:parseFloat(px?styles.borderTopWidth:$.css(domElement,"borderTopWidth"))||0,left:parseFloat(px?styles.borderLeftWidth:$.css(domElement,"borderLeftWidth"))||0,bottom:parseFloat(px?styles.borderBottomWidth:$.css(domElement,"borderBottomWidth"))||0,right:parseFloat(px?styles.borderRightWidth:$.css(domElement,"borderRightWidth"))||0};return{top:b.top,left:b.left,bottom:b.bottom,right:b.right,vertical:b.top+b.bottom,horizontal:b.left+b.right}};var dimensions=function($element){var win=$(window);var isRoot=rootrx.test($element[0].nodeName);return{border:isRoot?{top:0,left:0,bottom:0,right:0}:borders($element[0]),scroll:{top:(isRoot?win:$element).scrollTop(),left:(isRoot?win:$element).scrollLeft()},scrollbar:{right:isRoot?0:$element.innerWidth()-$element[0].clientWidth,bottom:isRoot?0:$element.innerHeight()-$element[0].clientHeight},rect:function(){var r=$element[0].getBoundingClientRect();return{top:isRoot?0:r.top,left:isRoot?0:r.left,bottom:isRoot?$element[0].clientHeight:r.bottom,right:isRoot?$element[0].clientWidth:r.right,height:$element[0].clientHeight}}()}};$.fn.extend({scrollintoview:function(options){options=$.extend({},settings,options);options.direction=converter[typeof options.direction==="string"&&options.direction.toLowerCase()]||converter.both;var dirStr="";if(options.direction.x===true)dirStr="horizontal";if(options.direction.y===true)dirStr=dirStr?"both":"vertical";var el=this.eq(0);if(!el.isVisible()){if($.isFunction(options.complete)){options.complete()}return}var scroller=options.scroller||el.closest(":scrollable("+dirStr+")");if(scroller.length>0){scroller=scroller.eq(0);var animOptions={};var dim={s:dimensions(scroller)};var rel={};if(options.rectangle){options.rectangle.left+=dim.s.rect.left;options.rectangle.right+=dim.s.rect.left;dim.e={rect:options.rectangle};var relBottom=options.rectangle.bottom-dim.s.scroll.top;if(options.rectangle.top<dim.s.scroll.top||options.toTop){animOptions.scrollTop=options.rectangle.top}else if(relBottom>dim.s.rect.height){animOptions.scrollTop=dim.s.scroll.top+(relBottom-dim.s.rect.height)}}else{dim.e=dimensions(el);rel.top=dim.e.rect.top-(dim.s.rect.top+dim.s.border.top);rel.bottom=dim.s.rect.bottom-dim.s.border.bottom-dim.s.scrollbar.bottom-dim.e.rect.bottom;if(options.direction.y===true){if(rel.top<0){animOptions.scrollTop=dim.s.scroll.top+rel.top}else if(rel.top>0&&rel.bottom<0||options.toTop){animOptions.scrollTop=dim.s.scroll.top+Math.min(rel.top,-rel.bottom)+(options.toTop?dim.s.rect.bottom-dim.s.rect.top+(dim.e.rect.top-dim.e.rect.bottom):0)}}}rel.left=dim.e.rect.left-(dim.s.rect.left+dim.s.border.left);rel.right=dim.s.rect.right-dim.s.border.right-dim.s.scrollbar.right-dim.e.rect.right;if(options.direction.x===true){if(rel.left<0){animOptions.scrollLeft=dim.s.scroll.left+rel.left}else if(rel.left>0&&rel.right<0){animOptions.scrollLeft=dim.s.scroll.left+Math.min(rel.left,-rel.right)}}if(!$.isEmptyObject(animOptions)){if(rootrx.test(scroller[0].nodeName)){scroller=$("html,body")}scroller.animate(animOptions,options.duration).eq(0).queue(function(next){$.isFunction(options.complete)&&options.complete.call(scroller[0]);next()})}else{$.isFunction(options.complete)&&options.complete.call(scroller[0])}}return this}});var scrollValue={auto:true,scroll:true,visible:false,hidden:false};$.extend($.expr[":"],{scrollable:function(element,index,meta,stack){var direction=converter[typeof meta[3]==="string"&&meta[3].toLowerCase()]||converter.both;var styles=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(element,null):element.currentStyle;var overflow={x:scrollValue[styles.overflowX.toLowerCase()]||false,y:scrollValue[styles.overflowY.toLowerCase()]||false,isRoot:rootrx.test(element.nodeName)};if(!overflow.x&&!overflow.y&&!overflow.isRoot){return false}var size={height:{scroll:element.scrollHeight,client:element.clientHeight},width:{scroll:element.scrollWidth,client:element.clientWidth},scrollableX:function(){return(overflow.x||overflow.isRoot)&&this.width.scroll>this.width.client},scrollableY:function(){return(overflow.y||overflow.isRoot)&&this.height.scroll>this.height.client}};return direction.y&&size.scrollableY()||direction.x&&size.scrollableX()}})})(Streak.jQuery);(function($){var w=[];$.modal=function(data,options){return $.modal.impl.init(data,options)};var allModalsBlocked=false;$.modal.block=function(){allModalsBlocked=true};$.modal.unblock=function(){allModalsBlocked=false};$.modal.close=function(){$.modal.impl.close()};$.modal.focus=function(pos){$.modal.impl.focus(pos)};$.modal.setContainerDimensions=function(){$.modal.impl.setContainerDimensions()};$.modal.setPosition=function(){$.modal.impl.setPosition()};$.modal.update=function(height,width){$.modal.impl.update(height,width)};$.fn.modal=function(options){return $.modal.impl.init(this,options)};$.modal.defaults={appendTo:"body",focus:true,opacity:50,overlayId:"simplemodal-overlay",overlayCss:{},containerId:"simplemodal-container",containerCss:{},dataId:"simplemodal-data",dataCss:{},minHeight:null,minWidth:null,maxHeight:null,maxWidth:null,autoResize:false,autoPosition:true,zIndex:1e3,close:true,closeHTML:'<a class="modalCloseImg" title="Close"></a>',closeClass:"simplemodal-close",escClose:true,overlayClose:false,position:null,persist:false,modal:true,onOpen:null,onShow:null,onClose:null};$.modal.impl={d:{},dStack:[],currentData:null,currentOptions:null,overlayStack:[],init:function(data,options){if(allModalsBlocked&&!options.force){return}var s=this;if(s.d.data){s.close(!options.dontStack)}s.currentData=data;s.currentOptions=options;s.o=$.extend({},$.modal.defaults,options);s.zIndex=s.o.zIndex;s.occb=false;if(typeof data==="object"){data=data instanceof $?data:$(data);s.d.placeholder=false;if(data.parent().parent().size()>0){data.before($("<span></span>").attr("id","simplemodal-placeholder").css({display:"none"}));s.d.placeholder=true;s.display=data.css("display");if(!s.o.persist){s.d.orig=data.clone(true)}}}else if(typeof data==="string"||typeof data==="number"){data=$("<div></div>").html(data)}else{alert("SimpleModal Error: Unsupported data type: "+typeof data);return s}s.create(data);data=null;s.open();if($.isFunction(s.o.onShow)){s.o.onShow.apply(s,[s.d])}return s},create:function(data){var s=this;w=s.getDimensions();s.d.overlay=$("<div></div>").attr("id",s.o.overlayId).addClass("simplemodal-overlay").css($.extend(s.o.overlayCss,{display:"none",opacity:s.o.opacity/100,position:"fixed",zIndex:s.o.zIndex+1})).appendTo(s.o.appendTo);s.d.container=$("<div></div>").attr("id",s.o.containerId).addClass("simplemodal-container").css({display:"none",position:"fixed",zIndex:s.o.zIndex+2}).append(s.o.close&&s.o.closeHTML?$(s.o.closeHTML).addClass(s.o.closeClass):"").appendTo(s.o.appendTo);s.d.wrap=$("<div></div>").attr("tabIndex",-1).addClass("simplemodal-wrap").appendTo(s.d.container);s.d.innerWrap=$("<div></div>").addClass("simplemodal-innerWrap").appendTo(s.d.wrap);s.d.data=data.attr("id",data.attr("id")||s.o.dataId).addClass("simplemodal-data").css($.extend(s.o.dataCss,{display:"none"})).appendTo(s.o.appendTo);data=null;s.d.data.appendTo(s.d.innerWrap)},bindEvents:function(){var s=this;$("."+s.o.closeClass).bind("click.simplemodal",function(e){e.preventDefault();s.close()});if(s.o.modal&&s.o.close&&s.o.overlayClose){s.d.overlay.bind("click.simplemodal",function(e){e.preventDefault();s.close()})}$(document).bind("keydown.simplemodal",function(e){if(s.o.modal&&e.keyCode===9){s.watchTab(e)}else if(s.o.close&&s.o.escClose&&e.keyCode===27){e.preventDefault();s.close()}})},unbindEvents:function(){$("."+this.o.closeClass).unbind("click.simplemodal");$(document).unbind("keydown.simplemodal");$(window).unbind("resize.simplemodal");this.d.overlay.unbind("click.simplemodal")},focus:function(pos){var s=this,p=pos&&$.inArray(pos,["first","last"])!==-1?pos:"first";var input=$(":input:enabled:FastVisible(noCompute):"+p,s.d.wrap);setTimeout(function(){input.length>0?input.focus():s.d.wrap.focus()},10)},getDimensions:function(){var el=$(window);var h=el.height();return[h,el.width()]},getVal:function(v,d){return v?typeof v==="number"?v:v==="auto"?0:v.indexOf("%")>0?parseInt(v.replace(/%/,""))/100*(d==="h"?w[0]:w[1]):parseInt(v.replace(/px/,"")):null},update:function(height,width){var s=this;if(!s.d.data){return false}s.d.origHeight=s.getVal(height,"h");s.d.origWidth=s.getVal(width,"w");s.d.data.hide();height&&s.d.container.css("height",height);width&&s.d.container.css("width",width);s.setContainerDimensions();s.d.data.show();s.o.focus&&s.focus();s.unbindEvents();s.bindEvents()},setContainerDimensions:function(){var s=this;var ch=s.d.origHeight?s.d.origHeight:s.getVal(s.d.container.css("height"),"h"),cw=s.d.origWidth?s.d.origWidth:s.getVal(s.d.container.css("width"),"w"),dh=s.d.data.outerHeight(true),dw=s.d.data.outerWidth(true);s.d.origHeight=s.d.origHeight||ch;s.d.origWidth=s.d.origWidth||cw;var mxoh=s.o.maxHeight?s.getVal(s.o.maxHeight,"h"):null,mxow=s.o.maxWidth?s.getVal(s.o.maxWidth,"w"):null,mh=mxoh&&mxoh<w[0]?mxoh:w[0],mw=mxow&&mxow<w[1]?mxow:w[1];var moh=s.o.minHeight?s.getVal(s.o.minHeight,"h"):"auto";if(!ch){if(!dh){ch=moh}else{if(dh>mh){ch=mh}else if(s.o.minHeight&&moh!=="auto"&&dh<moh){ch=moh}else{ch=dh}}}else{ch=s.o.autoResize&&ch>mh?mh:ch<moh?moh:ch}var mow=s.o.minWidth?s.getVal(s.o.minWidth,"w"):"auto";if(!cw){if(!dw){cw=mow}else{if(dw>mw){cw=mw}else if(s.o.minWidth&&mow!=="auto"&&dw<mow){cw=mow}else{cw=dw}}}else{cw=s.o.autoResize&&cw>mw?mw:cw<mow?mow:cw}s.d.container.css({height:ch,width:cw});s.d.wrap.css({overflow:dh>ch||dw>cw?"auto":"visible"});s.o.autoPosition&&s.setPosition()},setPosition:function(){var s=this,top,left,hc=w[0]/2-s.d.container.outerHeight(true)/2,vc=w[1]/2-s.d.container.outerWidth(true)/2;if(s.o.position&&Object.prototype.toString.call(s.o.position)==="[object Array]"){top=s.o.position[0]||hc;left=s.o.position[1]||vc}else{top=hc;left=vc}s.d.container.css({left:left,top:top})},watchTab:function(e){var s=this;if($(e.target).parents(".simplemodal-container").length>0){s.inputs=$(":input:enabled:FastVisible(noCompute):first, :input:enabled:FastVisible(noCompute):last",s.d.data[0]);if(!e.shiftKey&&e.target===s.inputs[s.inputs.length-1]||e.shiftKey&&e.target===s.inputs[0]||s.inputs.length===0){e.preventDefault();var pos=e.shiftKey?"last":"first";s.focus(pos)}}else{e.preventDefault();s.focus()}},open:function(){var s=this;s.d.iframe&&s.d.iframe.show();if($.isFunction(s.o.onOpen)){s.o.onOpen.apply(s,[s.d])}else{s.d.overlay.show();s.d.container.show();s.d.data.show()}s.o.focus&&s.focus();s.bindEvents()},close:function(isStacked){var s=this;if(!s.d.data){return false}s.unbindEvents();if(s.d.placeholder){var ph=$("#simplemodal-placeholder");if(s.o.persist){ph.replaceWith(s.d.data.removeClass("simplemodal-data").css("display",s.display))}else{s.d.data.hide().detach();ph.replaceWith(s.d.orig)}}else{s.d.data.hide().detach()}s.d.container.hide().remove();s.d.iframe&&s.d.iframe.hide().remove();var overlay=s.d.overlay;if(isStacked){s.d={};s.dStack.push({data:s.currentData,options:s.currentOptions})}else{if($.isFunction(s.o.onClose)){if(s.o.onClose.apply(s,[s.d])){return}}s.d={};if(s.dStack.length>0){var d=s.dStack.pop();s.init(d.data,d.options)}}overlay.hide().remove()}}})(Streak.jQuery);(function($){$.fn.bbmodal=function(options){var defaults={focus:false,overlayCss:{backgroundColor:"white",opacity:"0.75"},overlayClose:true,escClose:true,persist:true};var o=$.extend({},defaults,options);var self=this;return this.each(function(){self.modal(o)})}})(Streak.jQuery);(function(Streak){var $=Streak.jQuery;$.fn.simulateKeyboardPress=function(code){var el=$(this[0]);var pos=el.offset();var document=Streak.document;var evt=document.createEvent("KeyboardEvent");evt.initKeyboardEvent("keydown",true,true,null,false,false,false,false,code,code);el[0].dispatchEvent(evt);evt=document.createEvent("KeyboardEvent");evt.initKeyboardEvent("keypress",true,true,null,false,false,false,false,code,code);el[0].dispatchEvent(evt);evt=document.createEvent("KeyboardEvent");evt.initKeyboardEvent("keyup",true,true,null,false,false,false,false,code,code);el[0].dispatchEvent(evt)}})(Streak);(function(Streak){var $=Streak.jQuery;$.fn.simulateRawClick=function(){var document=Streak.document;return this.each(function(){var el=$(this);var pos=el.offset();var evt=document.createEvent("MouseEvents");evt.initMouseEvent("mousedown",true,true,window,0,pos.left,pos.top,0,0,false,false,false,false,0,null);el[0].dispatchEvent(evt);evt=document.createEvent("MouseEvents");evt.initMouseEvent("mouseup",true,true,window,0,pos.left,pos.top,0,0,false,false,false,false,0,null);el[0].dispatchEvent(evt);evt=document.createEvent("MouseEvents");evt.initMouseEvent("click",true,true,window,0,pos.left,pos.top,0,0,false,false,false,false,0,null);el[0].dispatchEvent(evt)})};$.fn.simulateHover=function(){var document=Streak.document;return this.each(function(){var el=$(this);var pos=el.offset();var evt=document.createEvent("MouseEvents");evt.initMouseEvent("mouseover",true,true,window,0,pos.left,pos.top,0,0,false,false,false,false,0,null);el[0].dispatchEvent(evt)})}})(Streak);(function(Streak){var $=Streak.jQuery;$(function(){var calculator={primaryStyles:["fontFamily","fontSize","fontWeight","fontVariant","fontStyle","paddingLeft","paddingTop","paddingBottom","paddingRight","marginLeft","marginTop","marginBottom","marginRight","borderLeftColor","borderTopColor","borderBottomColor","borderRightColor","borderLeftStyle","borderTopStyle","borderBottomStyle","borderRightStyle","borderLeftWidth","borderTopWidth","borderBottomWidth","borderRightWidth","line-height","outline"],specificStyle:{"word-wrap":"break-word","overflow-x":"hidden","overflow-y":"auto"},simulator:function(doc){if($(doc.body).find("#streak_textarea_simulator").length===0){$('<div id="streak_textarea_simulator"/>').css({position:"absolute",top:0,left:0,visibility:"hidden"}).appendTo(doc.body)}return $(doc.body).find("#streak_textarea_simulator")},toHtml:function(text){return $.getTextHTML(text)},getCaretPosition:function(){var cal=calculator,self=this,element=self[0],elementOffset=self.offset(),document=element.ownerDocument;cal.simulator(document).empty();$.each(cal.primaryStyles,function(index,styleName){self.cloneStyle(cal.simulator(document),styleName,document)});cal.simulator(document).css($.extend({width:self.width(),height:self.height()},cal.specificStyle));var value=self.val(),cursorPosition=self.getCursorPosition();var beforeText=value.substring(0,cursorPosition),afterText=value.substring(cursorPosition);var before=$('<span class="before"/ style="display:inline-block;">').html(cal.toHtml(beforeText)),focus=$('<span class="focus">&nbsp;</span>'),after=$('<span class="after"/>').html(cal.toHtml(afterText));before.append(focus);cal.simulator(document).append(before).append(after);var focusOffset=focus.offset(),simulatorOffset=cal.simulator(document).offset();elementOffset=self.offset();offset={top:focusOffset.top-simulatorOffset.top-element.scrollTop+parseInt(self.getComputedStyle("fontSize",document),10)+elementOffset.top,left:focus[0].offsetLeft-cal.simulator(document)[0].offsetLeft-element.scrollLeft+elementOffset.left};cal.simulator(document).empty();return offset}};$.fn.extend({getComputedStyle:function(styleName,document){if(this.length===0)return;var thiz=this[0];var result=this.css(styleName);result=result||document.defaultView.getComputedStyle(thiz,null)[styleName];return result},cloneStyle:function(target,styleName,document){var styleVal=this.getComputedStyle(styleName,document);if(!!styleVal){$(target).css(styleName,styleVal)}},cloneAllStyle:function(target,style,document){var thiz=this[0];for(var styleName in thiz.style){var val=thiz.style[styleName];typeof val==="string"||typeof val==="number"?this.cloneStyle(target,styleName,document):NaN}},getCursorPosition:function(document){var thiz=this[0],result=0;if("selectionStart"in thiz){result=thiz.selectionStart}else if("selection"in document){var range=document.selection.createRange();var bodyRange=document.body.createTextRange();bodyRange.moveToElementText(thiz);for(;bodyRange.compareEndPoints("StartToStart",range)<0;result++)bodyRange.moveStart("character",1);for(var i=0;i<=result;i++){if(thiz.value.charAt(i)=="\n")result++}var enterCount=thiz.value.split("\n").length-1;result-=enterCount;return result}return result},getCaretPosition:calculator.getCaretPosition})})})(Streak);(function(Streak){var _=Streak._;var ReadyListener=function(){};_.extend(ReadyListener.prototype,{readyObjects:[],waitingForReady:0,inRegisterMode:true,reset:function(){this.readyObjects.length=0;this.waitingForReady=0;this.inRegisterMode=true;this.resetReady()},register:function(readyObject){var self=this;this.readyObjects.push(readyObject);this.waitingForReady+=1;readyObject.ready(function(){self.waitingForReady-=1;if(self.waitingForReady<1&&!self.inRegisterMode){self.waitingForReady=0;self.trigger("ready")}})},doneRegistering:function(){this.inRegisterMode=false;if(this.waitingForReady===0){this.trigger("ready")}}});ReadyListener.create=function(){return Streak.Eventer.create(new ReadyListener)};Streak.ReadyListener=ReadyListener})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;$.fn.trackable=function(eventName,prop){return this.each(function(){var self=$(this);self.on("click",function(e){Streak.BentoBox.Tracker.trackStreakActive(prop,{eventName:eventName})})})}})(Streak);(function(Streak){var $,cardFromNumber,cardFromType,cards,defaultFormat,formatBackCardNumber,formatBackExpiry,formatCardNumber,formatExpiry,formatForwardExpiry,formatForwardSlash,hasTextSelected,luhnCheck,reFormatCardNumber,restrictCVC,restrictCardNumber,restrictExpiry,restrictNumeric,setCardType,__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},_this=this;$=Streak.$;$.payment={};$.payment.fn={};$.fn.payment=function(){var args,method;method=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return $.payment.fn[method].apply(this,args)};defaultFormat=/(\d{1,4})/g;cards=[{type:"maestro",pattern:/^(5018|5020|5038|6304|6759|676[1-3])/,format:defaultFormat,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:true},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:defaultFormat,length:[14],cvcLength:[3],luhn:true},{type:"laser",pattern:/^(6706|6771|6709)/,format:defaultFormat,length:[16,17,18,19],cvcLength:[3],luhn:true},{type:"jcb",pattern:/^35/,format:defaultFormat,length:[16],cvcLength:[3],luhn:true},{type:"unionpay",pattern:/^62/,format:defaultFormat,length:[16,17,18,19],cvcLength:[3],luhn:false},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:defaultFormat,length:[16],cvcLength:[3],luhn:true},{type:"mastercard",pattern:/^5[1-5]/,format:defaultFormat,length:[16],cvcLength:[3],luhn:true},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:true},{type:"visa",pattern:/^4/,format:defaultFormat,length:[13,14,15,16],cvcLength:[3],luhn:true}];
cardFromNumber=function(num){var card,_i,_len;num=(num+"").replace(/\D/g,"");for(_i=0,_len=cards.length;_i<_len;_i++){card=cards[_i];if(card.pattern.test(num)){return card}}};cardFromType=function(type){var card,_i,_len;for(_i=0,_len=cards.length;_i<_len;_i++){card=cards[_i];if(card.type===type){return card}}};luhnCheck=function(num){var digit,digits,odd,sum,_i,_len;odd=true;sum=0;digits=(num+"").split("").reverse();for(_i=0,_len=digits.length;_i<_len;_i++){digit=digits[_i];digit=parseInt(digit,10);if(odd=!odd){digit*=2}if(digit>9){digit-=9}sum+=digit}return sum%10===0};hasTextSelected=function($target){var _ref;if($target.prop("selectionStart")!=null&&$target.prop("selectionStart")!==$target.prop("selectionEnd")){return true}if(typeof document!=="undefined"&&document!==null?(_ref=document.selection)!=null?typeof _ref.createRange==="function"?_ref.createRange().text:void 0:void 0:void 0){return true}return false};reFormatCardNumber=function(e){var _this=this;return setTimeout(function(){var $target,value;$target=$(e.currentTarget);value=$target.val();value=$.payment.formatCardNumber(value);return $target.val(value)})};formatCardNumber=function(e){var $target,card,digit,length,re,upperLength,value;digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}$target=$(e.currentTarget);value=$target.val();card=cardFromNumber(value+digit);length=(value.replace(/\D/g,"")+digit).length;upperLength=16;if(card){upperLength=card.length[card.length.length-1]}if(length>=upperLength){return}if($target.prop("selectionStart")!=null&&$target.prop("selectionStart")!==value.length){return}if(card&&card.type==="amex"){re=/^(\d{4}|\d{4}\s\d{6})$/}else{re=/(?:^|\s)(\d{4})$/}if(re.test(value)){e.preventDefault();return $target.val(value+" "+digit)}else if(re.test(value+digit)){e.preventDefault();return $target.val(value+digit+" ")}};formatBackCardNumber=function(e){var $target,value;$target=$(e.currentTarget);value=$target.val();if(e.meta){return}if(e.which!==8){return}if($target.prop("selectionStart")!=null&&$target.prop("selectionStart")!==value.length){return}if(/\d\s$/.test(value)){e.preventDefault();return $target.val(value.replace(/\d\s$/,""))}else if(/\s\d?$/.test(value)){e.preventDefault();return $target.val(value.replace(/\s\d?$/,""))}};formatExpiry=function(e){var $target,digit,val;digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}$target=$(e.currentTarget);val=$target.val()+digit;if(/^\d$/.test(val)&&(val!=="0"&&val!=="1")){e.preventDefault();return $target.val("0"+val+" / ")}else if(/^\d\d$/.test(val)){e.preventDefault();return $target.val(""+val+" / ")}};formatForwardExpiry=function(e){var $target,digit,val;digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}$target=$(e.currentTarget);val=$target.val();if(/^\d\d$/.test(val)){return $target.val(""+val+" / ")}};formatForwardSlash=function(e){var $target,slash,val;slash=String.fromCharCode(e.which);if(slash!=="/"){return}$target=$(e.currentTarget);val=$target.val();if(/^\d$/.test(val)&&val!=="0"){return $target.val("0"+val+" / ")}};formatBackExpiry=function(e){var $target,value;if(e.meta){return}$target=$(e.currentTarget);value=$target.val();if(e.which!==8){return}if($target.prop("selectionStart")!=null&&$target.prop("selectionStart")!==value.length){return}if(/\d(\s|\/)+$/.test(value)){e.preventDefault();return $target.val(value.replace(/\d(\s|\/)*$/,""))}else if(/\s\/\s?\d?$/.test(value)){e.preventDefault();return $target.val(value.replace(/\s\/\s?\d?$/,""))}};restrictNumeric=function(e){var input;if(e.metaKey||e.ctrlKey){return true}if(e.which===32){return false}if(e.which===0){return true}if(e.which<33){return true}input=String.fromCharCode(e.which);return!!/[\d\s]/.test(input)};restrictCardNumber=function(e){var $target,card,digit,value;$target=$(e.currentTarget);digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}if(hasTextSelected($target)){return}value=($target.val()+digit).replace(/\D/g,"");card=cardFromNumber(value);if(card){return value.length<=card.length[card.length.length-1]}else{return value.length<=16}};restrictExpiry=function(e){var $target,digit,value;$target=$(e.currentTarget);digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}if(hasTextSelected($target)){return}value=$target.val()+digit;value=value.replace(/\D/g,"");if(value.length>6){return false}};restrictCVC=function(e){var $target,digit,val;$target=$(e.currentTarget);digit=String.fromCharCode(e.which);if(!/^\d+$/.test(digit)){return}val=$target.val()+digit;return val.length<=4};setCardType=function(e){var $target,allTypes,card,cardType,val;$target=$(e.currentTarget);val=$target.val();cardType=$.payment.cardType(val)||"unknown";if(!$target.hasClass(cardType)){allTypes=function(){var _i,_len,_results;_results=[];for(_i=0,_len=cards.length;_i<_len;_i++){card=cards[_i];_results.push(card.type)}return _results}();$target.removeClass("unknown");$target.removeClass(allTypes.join(" "));$target.addClass(cardType);$target.toggleClass("identified",cardType!=="unknown");return $target.trigger("payment.cardType",cardType)}};$.payment.fn.formatCardCVC=function(){this.payment("restrictNumeric");this.on("keypress",restrictCVC);return this};$.payment.fn.formatCardExpiry=function(){this.payment("restrictNumeric");this.on("keypress",restrictExpiry);this.on("keypress",formatExpiry);this.on("keypress",formatForwardSlash);this.on("keypress",formatForwardExpiry);this.on("keydown",formatBackExpiry);return this};$.payment.fn.formatCardNumber=function(){this.payment("restrictNumeric");this.on("keypress",restrictCardNumber);this.on("keypress",formatCardNumber);this.on("keydown",formatBackCardNumber);this.on("keyup",setCardType);this.on("paste",reFormatCardNumber);return this};$.payment.fn.restrictNumeric=function(){this.on("keypress",restrictNumeric);return this};$.payment.fn.cardExpiryVal=function(){return $.payment.cardExpiryVal($(this).val())};$.payment.cardExpiryVal=function(value){var month,prefix,year,_ref;value=value.replace(/\s/g,"");_ref=value.split("/",2),month=_ref[0],year=_ref[1];if((year!=null?year.length:void 0)===2&&/^\d+$/.test(year)){prefix=(new Date).getFullYear();prefix=prefix.toString().slice(0,2);year=prefix+year}month=parseInt(month,10);year=parseInt(year,10);return{month:month,year:year}};$.payment.validateCardNumber=function(num){var card,_ref;num=(num+"").replace(/\s+|-/g,"");if(!/^\d+$/.test(num)){return false}card=cardFromNumber(num);if(!card){return false}return(_ref=num.length,__indexOf.call(card.length,_ref)>=0)&&(card.luhn===false||luhnCheck(num))};$.payment.validateCardExpiry=function(month,year){var currentTime,expiry,prefix,_ref;if(month&&typeof month==="object"&&"month"in month){_ref=month,month=_ref.month,year=_ref.year}if(!(month&&year)){return false}month=$.trim(month);year=$.trim(year);if(!/^\d+$/.test(month)){return false}if(!/^\d+$/.test(year)){return false}if(!(parseInt(month,10)<=12)){return false}if(year.length===2){prefix=(new Date).getFullYear();prefix=prefix.toString().slice(0,2);year=prefix+year}expiry=new Date(year,month);currentTime=new Date;expiry.setMonth(expiry.getMonth()-1);expiry.setMonth(expiry.getMonth()+1,1);return expiry>currentTime};$.payment.validateCardCVC=function(cvc,type){var _ref,_ref1;cvc=$.trim(cvc);if(!/^\d+$/.test(cvc)){return false}if(type){return _ref=cvc.length,__indexOf.call((_ref1=cardFromType(type))!=null?_ref1.cvcLength:void 0,_ref)>=0}else{return cvc.length>=3&&cvc.length<=4}};$.payment.cardType=function(num){var _ref;if(!num){return null}return((_ref=cardFromNumber(num))!=null?_ref.type:void 0)||null};$.payment.formatCardNumber=function(num){var card,groups,upperLength,_ref;card=cardFromNumber(num);if(!card){return num}upperLength=card.length[card.length.length-1];num=num.replace(/\D/g,"");num=num.slice(0,+upperLength+1||9e9);if(card.format.global){return(_ref=num.match(card.format))!=null?_ref.join(" "):void 0}else{groups=card.format.exec(num);if(groups!=null){groups.shift()}return groups!=null?groups.join(" "):void 0}}})(Streak);(function(Streak){var _=Streak._;_.mixin({groupByMultiple:function(list,iterator){var objs=_.toArray(arguments).slice(2);_.each(list,function(item){_.wrap(iterator,function(func){var res=func(item);for(var i=0,l=objs.length;i<l;i++){if(!objs[i][res[i]])objs[i][res[i]]=[];objs[i][res[i]].push(item)}})})},isDefined:function(arg){return!_.isUndefined(arg)},isNotNull:function(arg){return!_.isNull(arg)},isReal:function(arg){return!_.isNotReal(arg)},toBoolean:function(arg){return!!arg},isReachable:function(base,_string){var list=_string.split(".");var listLength=list.length;var returnValue={value:null,failedStep:null};var currBase=base;for(var ii=0;ii<listLength;ii++){var currEntry=list[ii];if(_.isReal(currBase[currEntry])){returnValue.value=currBase[currEntry]}else{return{value:null,failedStep:currEntry}}currBase=currBase[currEntry]}return returnValue},isNotReal:function(arg){return arg==null},isNumeric:function(n){return n!==""&&n!==null&&!isNaN(n)},groupByPlus:function(obj,iterator){var result={};_.each(obj,function(value,index){var keys=iterator(value,index);if(_.isArray(keys)){_.each(keys,function(key){(result[key]||(result[key]=[])).push(value)})}else{(result[keys]||(result[keys]=[])).push(value)}});return result},includePlus:function(obj,target,tester){if(!tester||obj==null)return _.include(obj,target);var found=false;_.any(obj,function(value){if(found=tester(value,target))return true});return found},intersectionPlus:function(array,other,tester){return _.filter(array,function(value){return _.any(other,function(otherValue){return tester(value,otherValue)})})},differencePlus:function(array,other,tester){return _.filter(array,function(value){return _.all(other,function(otherValue){return!tester(value,otherValue)})})},unionPlus:function(array,other,tester){array=array||[];other=other||[];var arrayItemIndexesRemaining=[];for(var ii=0;ii<array.length;ii++){arrayItemIndexesRemaining.push(ii)}var newArray=[];for(var ii=0;ii<other.length;ii++){var otherItem=other[ii];for(var jj=0;jj<arrayItemIndexesRemaining.length;jj++){var item=array[arrayItemIndexesRemaining[jj]];if(tester(otherItem,item)){arrayItemIndexesRemaining.removeVal(jj);break}}newArray.push(otherItem)}for(var ii=0;ii<arrayItemIndexesRemaining.length;ii++){newArray.push(array[arrayItemIndexesRemaining[ii]])}return newArray},withoutPlus:function(array,element,tester){return _.differencePlus(array,[element],tester)},indexTheory:function(array,obj,comparator){array.push(obj);array.sort(comparator);var index=array.indexOf(obj);array.removeVal(obj);return index},pluckPlus:function(array,iterator){return _.map(array,function(val){return iterator.call(array,val)})},isArrayDifferent:function(array,other){if(array.length!=other.length){return true}for(var i=0;i<array.length;i++){if(array[i]!=other[i]){return true}}return false},isArrayDifferentSet:function(array,other){if(!array&&other){return true}if(!other&&array){return true}if(array.length!==other.length){return true}for(var ii=0;ii<array.length;ii++){if(other.indexOf(array[ii])===-1){return true}}return false},sortedPluck:function(array,options){var grouped=_(array).chain().filter(function(val){return _.isReal(val)}).pluckPlus(function(val){return options.pluck(val)}).flatten().map(function(val){if(options.map)return options.map(val);else return val}).filter(function(val){if(options.filter)return options.filter(val);else return val}).groupBy(function(val){return val}).value();return _(grouped).chain().keys().sortBy(function(key){return this[key].length},grouped).value()},filter:function(array,iterator){var arr=[];_.each(array,function(val){if(iterator(val))arr.push(val)});return arr},onceAfter:function(number,func){var once=_.once(func);return _.after(number,once)},chainedApply:function(array,func,params,doneFunc,errFunc){var chain=function(item){func.apply(null,[item].concat(params).concat([function(){if(array.length>0){chain(array.pop())}else{if(doneFunc){doneFunc()}}}]).concat([function(){if(errFunc){errFunc(array.length)}}]))};chain(array.pop())},chainedCallbacks:function(callbackArray,doneFunction){var call=function(){if(callbackArray.length===0){if(doneFunction){doneFunction()}}else{var func=callbackArray.pop();func(call)}};call()},firstIfPresent:function(arrays){return _.chain(arrays).map(_.first).compact().value()},restIfPresent:function(arrays){return _.flatten(_.map(arrays,_.rest))},firstFromLast:function(arr,numLastElements){var l=arr.length;return arr.slice(0,l-numLastElements)},repeatEvery:function(func,delay,delayedStart){var interval;var active=true;var delayedRun=function(){interval=setTimeout(function(){if(active){func();delayedRun()}},delay)};if(!delayedStart){setTimeout(func,1)}delayedRun();return{stop:function(){active=false;clearTimeout(interval)},start:function(){if(!active){active=true;if(!delayedStart){func()}delayedRun()}},isActive:function(){return active},destroy:function(){active=false;clearTimeout(interval)},func:func}},checkAndThenRun:function(checkFunction,runFunction,delay,finalDelay){var timer=_.repeatEvery(function(){if(checkFunction()){timer.stop();runFunction()}},delay);if(finalDelay){setTimeout(function(){if(timer.isActive()){timer.stop();runFunction()}},finalDelay)}return timer},delayed:function(delayedFunction,delay){var timer=null;return function(){clearTimeout(timer);var args=_.toArray(arguments);timer=setTimeout(_.bind(function(){delayedFunction.apply(this,args)},this),delay)}},uniqMerge:function(array,uniqFunc,mergeFunc){var _map={};var _newArray=[];if(_.isNotReal(mergeFunc)){mergeFunc=function(a,b){return _.extend({},a,b)}}for(var ii=0;ii<array.length;ii++){var uniqVal=uniqFunc(array[ii]);if(_.isNotReal(_map[uniqVal])){_newArray.push(array[ii]);_map[uniqVal]=array[ii].length-1}else{_newArray[_map[uniqVal]]=mergeFunc(array[ii],_newArray[_map[uniqVal]])}}return _newArray},indexOfPlus:function(array,iterator){if(_.isNotReal(array)||!_.isArray(array)||array.length===0){return-1}for(var ii=0;ii<array.length;ii++){if(iterator(array[ii])){return ii}}return-1},normalizeString:function(s,stripWhitespace){var div=document.createElement("div");div.innerHTML=s;var ret=div.textContent;if(stripWhitespace){ret=ret.replace(/\s/gi,"").replace(/\xAO/gi,"")}ret.toLowerCase();return ret},mutate:function(operation,array){if(!array){return}var args=_.toArray(arguments);var newArray=_[operation].apply(null,args.splice(1));array.length=0;for(var ii=0;ii<newArray.length;ii++){array.push(newArray[ii])}},appendToArray:function(firstArray,secondArray){secondArray.forEach(function(v){firstArray.push(v)})},sortNumerical:function(array){return array.sort(function(a,b){return b-a})},doArraysIntersect:function(firstArray,secondArray){if(!firstArray||firstArray.length===0||!secondArray||secondArray.length===0){return false}for(var ii=0;ii<firstArray.length;ii++){var element=firstArray[ii];if(secondArray.indexOf(element)>-1){return true}}return false},isObjectASuperset:function(smallerObject,biggerObject){if(!smallerObject){return true}for(var property in smallerObject){if(smallerObject[property]!==biggerObject[property]){return false}}return true}})})(Streak);(function(Streak){"use strict";var self=this;self.URL=self.URL||self.webkitURL;self.requestFileSystem=self.requestFileSystem||self.webkitRequestFileSystem;self.resolveLocalFileSystemURL=self.resolveLocalFileSystemURL||self.webkitResolveLocalFileSystemURL;navigator.temporaryStorage=navigator.temporaryStorage||navigator.webkitTemporaryStorage;navigator.persistentStorage=navigator.persistentStorage||navigator.webkitPersistentStorage;self.BlobBuilder=self.BlobBuilder||self.MozBlobBuilder||self.WebKitBlobBuilder;var Util={toArray:function(list){return Array.prototype.slice.call(list||[],0)},strToDataURL:function(str,contentType,opt_isBinary){var isBinary=opt_isBinary!=undefined?opt_isBinary:true;if(isBinary){return"data:"+contentType+";base64,"+self.btoa(str)}else{return"data:"+contentType+","+str}},strToObjectURL:function(binStr,opt_contentType){var ui8a=new Uint8Array(binStr.length);for(var i=0;i<ui8a.length;++i){ui8a[i]=binStr.charCodeAt(i)}var blob=new Blob([ui8a],opt_contentType?{type:opt_contentType}:{});return self.URL.createObjectURL(blob)},fileToObjectURL:function(blob){return self.URL.createObjectURL(blob)},fileToArrayBuffer:function(blob,callback,opt_errorCallback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)};reader.onerror=function(e){if(opt_errorCallback){opt_errorCallback(e)}};reader.readAsArrayBuffer(blob)},dataURLToBlob:function(dataURL){var BASE64_MARKER=";base64,";if(dataURL.indexOf(BASE64_MARKER)==-1){var parts=dataURL.split(",");var contentType=parts[0].split(":")[1];var raw=parts[1];return new Blob([raw],{type:contentType})}var parts=dataURL.split(BASE64_MARKER);var contentType=parts[0].split(":")[1];var raw=window.atob(parts[1]);var rawLength=raw.length;var uInt8Array=new Uint8Array(rawLength);for(var i=0;i<rawLength;++i){uInt8Array[i]=raw.charCodeAt(i)}return new Blob([uInt8Array],{type:contentType})},arrayBufferToBlob:function(buffer,opt_contentType){var uInt8Array=new Uint8Array(buffer);return new Blob([uInt8Array],opt_contentType?{type:opt_contentType}:{})},arrayBufferToBinaryString:function(buffer,callback,opt_errorCallback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)};reader.onerror=function(e){if(opt_errorCallback){opt_errorCallback(e)}};var uInt8Array=new Uint8Array(buffer);reader.readAsBinaryString(new Blob([uInt8Array]))},arrayToBinaryString:function(bytes){if(typeof bytes!=typeof[]){return null}var i=bytes.length;var bstr=new Array(i);while(i--){bstr[i]=String.fromCharCode(bytes[i])}return bstr.join("")},getFileExtension:function(filename){var idx=filename.lastIndexOf(".");return idx!=-1?filename.substring(idx):""}};var MyFileError=function(obj){this.prototype=FileError.prototype;this.code=obj.code;this.name=obj.name};var Filer=new function(){var FS_INIT_ERROR_MSG="Filesystem has not been initialized.";var NOT_IMPLEMENTED_MSG="Not implemented.";var NOT_A_DIRECTORY="Path was not a directory.";var INCORRECT_ARGS="These method arguments are not supported.";var FS_URL_SCHEME="filesystem:";var DEFAULT_FS_SIZE=1024*1024;var fs_=null;var cwd_=null;var isOpen_=false;var isFsURL_=function(path){return path.indexOf(FS_URL_SCHEME)==0};var pathToFsURL_=function(path){if(!isFsURL_(path)){if(path[0]=="/"){path=fs_.root.toURL()+path.substring(1)}else if(path.indexOf("./")==0||path.indexOf("../")==0){if(path=="../"&&cwd_!=fs_.root){path=cwd_.toURL()+"/"+path}else{path=cwd_.toURL()+path}}else{path=cwd_.toURL()+"/"+path}}return path};var getEntry_=function(callback,var_args){var srcStr=arguments[1];var destStr=arguments[2];var onError=function(e){if(e.code==FileError.NOT_FOUND_ERR){if(destStr){throw new Error('"'+srcStr+'" or "'+destStr+'" does not exist.')}else{throw new Error('"'+srcStr+'" does not exist.')}}else{throw new Error("Problem getting Entry for one or more paths.")}};var src=pathToFsURL_(srcStr);if(arguments.length==3){var dest=pathToFsURL_(destStr);self.resolveLocalFileSystemURL(src,function(srcEntry){self.resolveLocalFileSystemURL(dest,function(destEntry){callback(srcEntry,destEntry)},onError)},onError)}else{self.resolveLocalFileSystemURL(src,callback,onError)}};var copyOrMove_=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler,opt_deleteOrig){var self=this;if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}if(typeof src!=typeof dest){throw new Error(INCORRECT_ARGS)}var newName=opt_newName||null;var deleteOrig=opt_deleteOrig!=undefined?opt_deleteOrig:false;if((src.isFile||dest.isDirectory)&&dest.isDirectory){if(deleteOrig){src.moveTo(dest,newName,opt_successCallback,opt_errorHandler)}else{src.copyTo(dest,newName,opt_successCallback,opt_errorHandler)}}else{getEntry_(function(srcEntry,destDir){if(!destDir.isDirectory){var e=new Error('Oops! "'+destDir.name+" is not a directory!");if(opt_errorHandler){opt_errorHandler(e)}else{throw e}return}if(deleteOrig){srcEntry.moveTo(destDir,newName,opt_successCallback,opt_errorHandler)}else{srcEntry.copyTo(destDir,newName,opt_successCallback,opt_errorHandler)}},src,dest)}};function Filer(fs){fs_=fs||null;if(fs_){cwd_=fs_.root;isOpen_=true}}Filer.DEFAULT_FS_SIZE=DEFAULT_FS_SIZE;Filer.version="0.4.3";Filer.prototype={get fs(){return fs_},get isOpen(){return isOpen_},get cwd(){return cwd_}};Filer.prototype.pathToFilesystemURL=function(path){return pathToFsURL_(path)};Filer.prototype.init=function(opt_initObj,opt_successCallback,opt_errorHandler){if(!self.requestFileSystem){throw new MyFileError({code:FileError.BROWSER_NOT_SUPPORTED,name:"BROWSER_NOT_SUPPORTED"})}var initObj=opt_initObj?opt_initObj:{};var size=initObj.size||DEFAULT_FS_SIZE;this.type=self.TEMPORARY;if("persistent"in initObj&&initObj.persistent){this.type=self.PERSISTENT}var init=function(fs){this.size=size;fs_=fs;cwd_=fs_.root;isOpen_=true;opt_successCallback&&opt_successCallback(fs)};if(this.type==self.PERSISTENT&&!!navigator.persistentStorage){navigator.persistentStorage.requestQuota(size,function(grantedBytes){self.requestFileSystem(this.type,grantedBytes,init.bind(this),opt_errorHandler)}.bind(this),opt_errorHandler)}else{self.requestFileSystem(this.type,size,init.bind(this),opt_errorHandler)}};Filer.prototype.ls=function(dirEntryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}var callback=function(dirEntry){cwd_=dirEntry;var entries_=[];var reader=cwd_.createReader();var readEntries=function(){reader.readEntries(function(results){if(!results.length){entries_.sort(function(a,b){return a.name<b.name?-1:b.name<a.name?1:0});successCallback(entries_)}else{entries_=entries_.concat(Util.toArray(results));readEntries()}},opt_errorHandler)};readEntries()};if(dirEntryOrPath.isDirectory){callback(dirEntryOrPath)}else if(isFsURL_(dirEntryOrPath)){getEntry_(callback,dirEntryOrPath)}else{cwd_.getDirectory(dirEntryOrPath,{},callback,opt_errorHandler)}};Filer.prototype.mkdir=function(path,opt_exclusive,opt_successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}var exclusive=opt_exclusive!=null?opt_exclusive:false;var folderParts=path.split("/");var createDir=function(rootDir,folders){if(folders[0]=="."||folders[0]==""){folders=folders.slice(1)}rootDir.getDirectory(folders[0],{create:true,exclusive:exclusive},function(dirEntry){if(dirEntry.isDirectory){if(folders.length&&folderParts.length!=1){createDir(dirEntry,folders.slice(1))}else{if(opt_successCallback)opt_successCallback(dirEntry)}}else{var e=new Error(path+" is not a directory");if(opt_errorHandler){opt_errorHandler(e)}else{throw e}}},function(e){if(e.code==FileError.INVALID_MODIFICATION_ERR){e.message="'"+path+"' already exists";if(opt_errorHandler){opt_errorHandler(e)}else{throw e}}})};createDir(cwd_,folderParts)};Filer.prototype.open=function(entryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}if(entryOrPath.isFile){entryOrPath.file(successCallback,opt_errorHandler)}else{getEntry_(function(fileEntry){fileEntry.file(successCallback,opt_errorHandler)},pathToFsURL_(entryOrPath))}};Filer.prototype.create=function(path,opt_exclusive,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}var exclusive=opt_exclusive!=null?opt_exclusive:true;cwd_.getFile(path,{create:true,exclusive:exclusive},successCallback,function(e){if(e.code==FileError.INVALID_MODIFICATION_ERR){e.message="'"+path+"' already exists"}if(opt_errorHandler){opt_errorHandler(e)}else{throw e}})};Filer.prototype.mv=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler){copyOrMove_.bind(this,src,dest,opt_newName,opt_successCallback,opt_errorHandler,true)()};Filer.prototype.rm=function(entryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}var removeIt=function(entry){if(entry.isFile){entry.remove(successCallback,opt_errorHandler)}else if(entry.isDirectory){entry.removeRecursively(successCallback,opt_errorHandler)}};if(entryOrPath.isFile||entryOrPath.isDirectory){removeIt(entryOrPath)}else{getEntry_(removeIt,entryOrPath)}};Filer.prototype.cd=function(dirEntryOrPath,opt_successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}if(dirEntryOrPath.isDirectory){cwd_=dirEntryOrPath;opt_successCallback&&opt_successCallback(cwd_)}else{var dirEntryOrPath=pathToFsURL_(dirEntryOrPath);getEntry_(function(dirEntry){if(dirEntry.isDirectory){cwd_=dirEntry;opt_successCallback&&opt_successCallback(cwd_)}else{var e=new Error(NOT_A_DIRECTORY);if(opt_errorHandler){opt_errorHandler(e)}else{throw e}}},dirEntryOrPath)}};Filer.prototype.cp=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler){copyOrMove_.bind(this,src,dest,opt_newName,opt_successCallback,opt_errorHandler)()};Filer.prototype.write=function(entryOrPath,dataObj,opt_successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG)}var writeFile_=function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onerror=opt_errorHandler;if(dataObj.append){fileWriter.onwriteend=function(e){if(opt_successCallback)opt_successCallback(fileEntry,this)};fileWriter.seek(fileWriter.length)}else{var truncated=false;fileWriter.onwriteend=function(e){if(!truncated){truncated=true;this.truncate(this.position);return}if(opt_successCallback)opt_successCallback(fileEntry,this)}}if(dataObj.data.__proto__==ArrayBuffer.prototype){dataObj.data=new Uint8Array(dataObj.data)}var blob=new Blob([dataObj.data],dataObj.type?{type:dataObj.type}:{});fileWriter.write(blob)},opt_errorHandler)};if(entryOrPath.isFile){writeFile_(entryOrPath)}else if(isFsURL_(entryOrPath)){getEntry_(writeFile_,entryOrPath)}else{cwd_.getFile(entryOrPath,{create:true,exclusive:false},writeFile_,opt_errorHandler)}};Filer.prototype.df=function(successCallback,opt_errorHandler){var queryCallback=function(byteUsed,byteCap){successCallback(byteUsed,byteCap-byteUsed,byteCap)};if(!(navigator.temporaryStorage.queryUsageAndQuota&&navigator.persistentStorage.queryUsageAndQuota)){throw new Error(NOT_IMPLEMENTED_MSG)}if(self.TEMPORARY==this.type){navigator.temporaryStorage.queryUsageAndQuota(queryCallback,opt_errorHandler)}else if(self.PERSISTENT==this.type){navigator.persistentStorage.queryUsageAndQuota(queryCallback,opt_errorHandler)}};return Filer};Streak.Filer=Filer}).call(this,Streak);(function(Streak){var _=Streak._;var CONSTANTS={API_PREFIX:"/api/v1/"};var APIRequester={request:function(method,url,bodyData,queryParameters,extraOptions){var server;if(extraOptions&&extraOptions.serverOverride){server=extraOptions.serverOverride;delete extraOptions.serverOverride}else{server=Streak.server}if(!queryParameters){queryParameters={}}if(!extraOptions||!extraOptions.isAnonymous){if(Streak.ai){queryParameters.ai=true;queryParameters.email=Streak.ai}else{queryParameters.email=Streak.userEmail;if(Streak.originalEmail){queryParameters.originalEmail=Streak.originalEmail}}}return new Streak.Request(method,server,CONSTANTS.API_PREFIX+url,_.extend({useStreakHeaders:!extraOptions||!extraOptions.isAnonymous,bodyData:bodyData,queryParameters:queryParameters},extraOptions||{}))},get:function(url,queryParameters,extraOptions){return this.request("GET",url,null,queryParameters,extraOptions)},post:function(url,bodyData,queryParameters,extraOptions){return this.request("POST",url,bodyData,queryParameters,extraOptions)},put:function(url,bodyData,queryParameters,extraOptions){return this.request("PUT",url,bodyData,queryParameters,extraOptions)},"delete":function(url,queryParameters,extraOptions){return this.request("DELETE",url,null,queryParameters,extraOptions)},error:_.throttle(function(message){return this.put("webclient/errors",null,{error:message},{neverLogError:true,responseType:"text"})},1500),_resetVersionError:function(){Streak.Request._resetVersionError(Streak.server)}};Streak.APIRequester=APIRequester})(Streak);(function(Streak){var _=Streak._,Bacon=Streak.Bacon,Library=Streak.Library,BB=Streak.BentoBox;var Request=Streak.Class.subclass({className:"Request",superclass:Streak.Object,_memberVariables:[{name:"_xhr",destroy:false,get:true},{name:"_method",destroy:false},{name:"_server",destroy:false},{name:"_path",destroy:false},{name:"_url",destroy:false},{name:"_options",destroy:false},{name:"_responseType",destroy:false},{name:"_attempts",destroy:false,defaultValue:1},{name:"_currentBackoff",destroy:false},{name:"_retryTimeout",destroy:false},{name:"_eventStream",destroy:false},{name:"_simplePromise",destroy:false},{name:"_deferred",destroy:false}],_initialize:function(method,server,path,options){Streak.Object.prototype._initialize.call(this);var self=this;this._currentBackoff=Request._retryTime;this._method=method;this._server=server;this._path=path;this._options=options||{};this._responseType=this._options.responseType||"json";this._retry=this._options.retry!==false;this._deferred=Streak.RSVP.defer();if(_.has(Request._serverVersionErrors,Streak.server)||_.has(Request._serverVersionErrors,server)){this._deferred.promise.catch(function(){});this._deferred.reject(new Error("Request has been torn down after minimum version error"));return}if(this._options.neverLogError){this._deferred.promise.catch(function(){})}this._constructURL();this._startRequest()},_setQueryParameter:function(parameter,value){if(!this._options.queryParameters){this._options.queryParameters={}}this._options.queryParameters[parameter]=value},_constructURL:function(){this._url=this._server+this._path;if(this._options.queryParameters){var encodedQueryParameters=this._urlEncode(this._options.queryParameters);if(this._url.indexOf("?")===-1){this._url+="?"+encodedQueryParameters}else{this._url+="&"+encodedQueryParameters}}},_startRequest:function(){var self=this;this._xhr=new XMLHttpRequest;if(!this._options.isAnonymous){this._xhr.withCredentials=true}if(this._responseType!="json"){this._xhr.responseType=this._responseType}this._xhr.onreadystatechange=this._handleXhrStateChange.bind(this);this._xhr.open(this._method,this._url,true);if(this._options.contentType){this._xhr.setRequestHeader("Content-type",this._options.contentType)}else{this._xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded")}if(this._options.useStreakHeaders){this._xhr.setRequestHeader("X-Streak-Web-Client","true");this._xhr.setRequestHeader("X-Streak-Web-Client-Version",Streak.clientVersion);this._xhr.setRequestHeader("X-Streak-Web-Extension-Version",Streak.extVersion);this._xhr.setRequestHeader("X-Streak-Web-Retry-Count",this._attempts-1)}_.each(this._options.headers,function(value,name){self._xhr.setRequestHeader(name,value)});var encodedBodyData;if(this._options.bodyData){encodedBodyData=this._urlEncode(this._options.bodyData)}this._xhr.send(encodedBodyData)},_handleXhrStateChange:function(){if(this._xhr.readyState!==4){return}if(this._isRequestASuccess()){this._handleSuccessfulRequest()}else{this._handleFailedRequest()}},_isRequestASuccess:function(){return this._xhr.status>=200&&this._xhr.status<=299},_handleSuccessfulRequest:function(){var response;if(this._responseType=="json"){var type=this._xhr.getResponseHeader("content-type");if(!type||!type.match("application/json")){console.warn("Resource interpreted as JSON but transferred with MIME type "+type+":",this._url)}try{response=JSON.parse(this._xhr.responseText)}catch(err){err.details={url:this._url};this._deferred.reject(err);return}}else{response=this._xhr.response}this._deferred.resolve({xhr:this._xhr,response:response})},_handleFailedRequest:function(){if(!this._hasExhaustedAttempts()&&_.contains([0,500],this._xhr.status)){this._retryRequest()}else{this._failRequest()}},_hasExhaustedAttempts:function(){return!this._retry||this._attempts>=Request._retryAttempts},_retryRequest:function(){this._attempts++;this._currentBackoff=Math.min(this._currentBackoff*Request._retryGrowthFactor,Request._retryTimeMax);this._retryTimeout=setTimeout(this._startRequest.bind(this),this._currentBackoff)},_failRequest:function(){var response=null;var type=this._xhr.getResponseHeader("content-type");
var shouldBeJSON=!!(type&&type.match("application/json"));try{response=JSON.parse(this._xhr.responseText);if(!shouldBeJSON){console.warn("Resource interpreted as JSON but transferred with MIME type "+type+":",this._url)}}catch(err){try{response=JSON.parse(this._xhr.response);if(!shouldBeJSON){console.warn("Resource interpreted as JSON but transferred with MIME type "+type+":",this._url)}}catch(err2){response=this._xhr.response;if(shouldBeJSON){console.warn("Resource interpreted as text but transferred with MIME type "+type+":",this._url)}}}if(this._isOldClientVersion(response)){Streak.BentoBox.trigger("newClientVersion");Request._serverVersionErrors[this._server]=true;this._deferred.promise.catch(function(){})}if(this._isOldExtensionVersion(response)){Streak.BentoBox.trigger("newExtVersion");Request._serverVersionErrors[this._server]=true;this._deferred.promise.catch(function(){})}if(_.contains([0,500,503],this._xhr.status)&&!this._options.neverLogError){this._logError()}var error=new Error("Bad response from server");error.response=response;error.xhr=this._xhr;error.details={status:this._xhr.status,url:this._url,response:response};this._deferred.reject(error)},_logError:function(){if(!this._xhr){return}var d,s=this._xhr.response;var msg;if(this._xhr.status===500){msg="500 error from server"}else if(this._xhr.status===0){msg="Crap, status "+this._xhr.status}else{msg="Error from server";if(s){try{d=JSON.parse(s)}catch(err){d=s;msg+="\n failed to json parse response"}}if(d&&d.error){msg=d.error}msg+="\n status: "+this._xhr.status}msg+="\n url: "+this._url;msg+="\n options: "+JSON.stringify(this._options);msg+="\n response: "+s;Streak.BentoBox.logError(msg)},_isOldClientVersion:function(parsedResponse){if(!parsedResponse){return false}return parsedResponse.error==="clientVersionNotSupported"},_isOldExtensionVersion:function(parsedResponse){if(!parsedResponse){return false}return parsedResponse.error==="extVersionNotSupported"},_urlEncode:function(data){if(_.isString(data)){return data}var dstring="";if(data){for(var m in data){var val=data[m];if(_.isArray(val)){val=JSON.stringify(val)}dstring+="&"+encodeURIComponent(m)+"="+encodeURIComponent(val)}}return dstring.substring(1)},getEventStream:function(){if(!this._eventStream){var promise=this.getPromise();var abortablePromise={then:promise.then.bind(promise),abort:this.abort.bind(this)};this._eventStream=Bacon.fromPromise(abortablePromise,true)}return this._eventStream},getPromise:function(){if(!this._simplePromise){this._simplePromise=this._deferred.promise.then(function(result){return result.response})}return this._simplePromise},getExtendedPromise:function(){return this._deferred.promise},abort:function(){return this.cancel()},cancel:function(){this.destroy()},destroy:function(){if(!this._xhr){return}clearTimeout(this._retryTimeout);this._xhr.onreadystatechange=null;this._xhr.abort();this._deferred.reject(new Error("Canceled"));Streak.Object.prototype.destroy.call(this)}});Request._retryTime=2*1e3;Request._retryGrowthFactor=1.5;Request._retryTimeMax=32*1e3;Request._retryAttempts=5;Request._serverVersionErrors={};Request._resetVersionError=function(server){delete Request._serverVersionErrors[server]};Library.set("Request",Request)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,APIRequester=Streak.APIRequester;Streak.Locale={supported:["en"],initial:"en",map:null,init:function(){var self=this;Date.prototype.setFormatLocale(this.getGmail()==="en"?"en":"other");return APIRequester.get("resources/locales/"+this.getCurrent(),null,{serverOverride:Streak.combinedServer||Streak.server,isAnonymous:true}).getPromise().then(function(res){self.map=res},function(){Streak.BentoBox.logError("language file wasn't loaded")})},getGmail:function(){return GLOBALS[4].split(".")[1]},getCurrent:function(){if(localStorage["bb_locale"]){return localStorage["bb_locale"]}return this.getGmail()},getClone:function(){return Streak.$.extend(true,{},this)},override:function(fileName,cb){var self=this;new Streak.Request("GET",Streak.server,fileName,{isAnonymous:true}).getPromise().then(function(res){_.extend(self.map,res);if(cb){cb()}},cb)},setMode:function(mode){var self=this;mode="__"+mode;var changes=[];Streak._.each(self.map,function(value,key){var positionOfModeInkey=key.indexOf(mode);if(positionOfModeInkey>0){var baseKey=key.substring(0,positionOfModeInkey);changes.push({baseKey:baseKey,value:self.map[key]})}});var changeLength=changes.length;for(var ii=0;ii<changeLength;ii++){var change=changes[ii];self.map[change.baseKey]=change.value}},setCurrent:function(locale){if(locale===this.getGmail()){localStorage.removeItem("bb_locale")}else{localStorage["bb_locale"]=locale}},getStrings:function(keys,hash){self=this;return _.map(keys,function(key){return self.getString(key,hash)})},getString:function(key,hash,pluralNumbers){var value=this.map[key]||key;if(hash){var texts=value.split(/<[^>]+>/);var keys=value.match(/<[^>]+>/g);var outText=null;if(keys&&keys.length>0){keys=keys.map(function(a){return a.substring(1,a.length-1)});var output=[];for(var i=0;i<keys.length;i++){output.push(texts[i]);output.push(_.isReal(hash[keys[i]])?hash[keys[i]]:"<"+keys[i]+">")}output.push(texts[texts.length-1]);outText=output.join("")}else{outText=value}if(!hash.pluralize&&pluralNumbers){hash.pluralize=pluralNumbers}if(!_.isArray(hash.pluralize)){hash.pluralize=[hash.pluralize]}var pli=0;outText=outText.replace(/\[(?:(\w+)@)?(.*?)\]/g,function(fullMatch,reference,match,offset,fullString){var parts=match.split("|");var num;if(reference)num=hash[reference];else num=hash.pluralize[pli++];if(num===undefined)return fullMatch;var partResult="";for(var i=0;i<parts.length;i++){var part=parts[i];var innerParts=part.split(":");if(innerParts.length==1){partResult=innerParts[0]}else if(innerParts.length==2){var numSpec=innerParts[0];if(numSpec.match(/^\d+$/)){if(parseInt(numSpec)==num){partResult=innerParts[1];break}}else{Streak.BentoBox.logError("Locale entry: Expected number",null,{key:key,value:value,locale:this.getCurrent()})}}else{Streak.BentoBox.logError("Locale entry: Too many colons",null,{key:key,value:value,locale:this.getCurrent()})}}return partResult});return outText}else{return value}},localize:function(s){var self=this;s=s.replace(/<%%\s*(.+?)\s*%>/g,function(match,code){return self.getString(code)});s=s.replace(/<%html\s*(.+?)\s*\(\s*\{\s*\n?\s*((?:[^\s'.{}:]+\s*:\s*'''.+?''',?\s*\n?\s*)+)\}\s*\)\s*%>/gm,function(match,code,args){var dict={};args.replace(/([^\s'.{}:]+)\s*:\s*'''(.+?)''',?/gm,function(match,name,result){dict[name]=result;return match});return self.getString(code,dict)});return s},convertLocaleCodeToName:function(code){return this.map["supportedLocales"][code]}};Streak.DependencyManager.addFunction({functionKey:"localeLoaded",functionReference:Streak.Locale.init,functionContext:Streak.Locale,dependentFunctionKeys:["bentoBoxServerSet"]})})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._;var Template={_underscoreTemplates:{},underscore:function(id){if(!_.has(this._underscoreTemplates,id)){throw new Error("Template not found with id "+id)}return this._underscoreTemplates[id]}};Streak.Template=Template})(Streak);(function(){var _=Streak._;Streak.Template._underscoreTemplates["core/gmail/gmailLeftNav/link"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="streak__leftNavLink">\n  <div class="TO">\n    <div class="TN aY7xie aik">\n      <div class="TH J-J5-Ji"></div>\n      <div class="aio aip">\n        <span class="nU "><a href="#" target="_top" class="J-Ke n0">'+__e(text)+"</a></span>\n      </div>\n    </div>\n  </div>\n</div>\n"}return __p};Streak.Template._underscoreTemplates["core/gmail/labelActionTag"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<table cellpadding="0" class="cf hX">\n  <tbody>\n    <tr class="hR">\n      <td class="hU hM" style="background-color: '+__e(backgroundColor)+"; color: "+__e(textColor)+';">\n        <div class="hN" title="'+__e(labelHelpText)+'" role="button">\n          '+__e(labelText)+'\n        </div>\n      </td>\n      <td class="hV hM bb_labelActionTag" style="background-color: '+__e(backgroundColor)+"; color: "+__e(textColor)+';">\n        <span class="hO" title="'+__e(xHelpText)+'" role="button">x</span>\n      </td>\n    </tr>\n  </tbody>\n</table>\n'}return __p};Streak.Template._underscoreTemplates["core/gmail/labelTag"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="at" style="background-color: '+__e(groupcolor)+"; border-color: "+__e(groupcolor)+';">\n  <div class="au" style="border-color:'+__e(groupcolor)+'">\n    <div class="av" style="color: '+__e(textcolor)+'">\n      '+__e(text)+"\n    </div>\n  </div>\n</div>\n"}return __p};Streak.Template._underscoreTemplates["core/models/pipeline/systemSummary"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+='<div class="boxSummary">';__p+='<span class="boxSummaryIcon boxSummaryEmail"></span>'+((__t=gmailThreadCount)==null?"":__t)+'<span class="boxSummaryIcon boxSummaryFile"></span>'+((__t=fileCount)==null?"":__t)+'<span class="boxSummaryIcon boxSummaryComment"></span>'+((__t=commentCount)==null?"":__t)+'<span class="boxSummaryIcon boxSummaryReminder"></span>'+((__t=reminderCount)==null?"":__t)+"</div>\n"}return __p};Streak.Template._underscoreTemplates["core/models/pipeline/systemSummaryText"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="Thread Count: "+((__t=gmailThreadCount)==null?"":__t)+", File Count: "+((__t=fileCount)==null?"":__t)+", Comment Count: "+((__t=commentCount)==null?"":__t)+", Reminder Count: "+((__t=reminderCount)==null?"":__t)+"\n"}return __p};Streak.Template._underscoreTemplates["lib/jqueryplugins/multipleautosuggest"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="vR autoChosen">\n  <span class="vN Y7BVp" email="'+__e(email)+'">\n    <div class="vT">'+__e(name)+'</div><div class="vM"></div>\n  </span>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/leftLink/linkItem"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="TO linkItemInner">\n	<div class="TN aY7xie aik" style="margin-left: 12px">\n		<div class="TH aih J-J5-Ji expando" role="link" tabindex="0"></div>\n		<div class="aio aip">\n			<span class="nU n1 name"> '+__e(name)+' </span>\n		</div>\n		<div class="nL aig menuButtonAnchor">\n			<div class="pM menuButton" style="color: '+__e(textcolor)+"; background-color: "+__e(backgroundcolor)+"; border-color: "+__e(backgroundcolor)+'" tabindex="0" role="button">\n				<div class="p6" style="background-color: '+__e(backgroundcolor)+'">\n					<div class="p8">▼</div>\n				</div>\n			</div>\n		</div>\n	</div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/button"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="f1 streakSettingsButton"><a href="#settingsStreak" class="f0" role="tab" hidefocus="false">Streak Settings</a></div>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/comboButton"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="J-J5-Ji alH J-JN-M-I streakSettingsComboButton" role="button" style="-webkit-user-select: none;" >\n  <div class="J-J5-Ji J-JN-M-I-Jm streakSettingsComboButtonText">'+__e(text)+'</div>\n  <div class="J-J5-Ji J-JN-M-I-JG streakSettingDownArrow">&nbsp;</div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/parentButton"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<span class="alM">\n  <span class="streakSettingsParentButton">'+__e(name)+'&nbsp;</span>\n  <span class="alA">▼</span>\n</span>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/section"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="streakSettingsSection">\n  <div class="rc">'+__e(sectionTitle)+'</div>\n  <div class="streakSettingsSectionBody"></div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/setting"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="streakSettingsSetting">\n  <div class="streakSettingParentSetting">\n    <div class="streakSettingsSettingLeft">\n      <div class="streakSettingsSettingTitle">\n        '+__e(settingTitle)+'\n      </div>\n    </div>\n    <div class="streakSettingsSettingRight">\n      <div class="streakSettingsSettingWidget">\n      </div>\n    </div>\n  </div>\n\n  <div class="streakSettingChildSetting">\n    <div class="streakSettingsSettingLeft">\n      <div class="streakSettingsSubsettingList">\n      </div>\n    </div>\n\n    <div class="streakSettingsSettingRight">\n      <div class="streakSettingsSubsettingWidgets">\n      </div>\n    </div>\n  </div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/subsettingTitle"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="streakSettingsSubsettingTitle">\n  '+__e(subsettingTitle)+"\n</div>\n"}return __p};Streak.Template._underscoreTemplates["modules/streakSettingsView/subtitle"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<br />\n<span class="rb" style="margin-left:0px">'+__e(text)+"</span>\n"}return __p};Streak.Template._underscoreTemplates["modules/threadView/credentialsError"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+='<div class="streak__threadView_errorAccount">\n  Please have\n  ';_.each(emails,function(email,i){__p+='\n    <a href="mailto:'+__e(email)+'">'+__e(email)+"</a>";if(i!=emails.length-1&&emails.length>2){__p+=", "}if(i==emails.length-2){__p+=" or "}});__p+="\n  log in to Streak and access to the thread will be fixed automatically.\n</div>\n"}return __p};Streak.Template._underscoreTemplates["modules/threadView/email"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="h7">\n	<div class="Bk">\n		<div class="G3 G2">\n			<div class="adn ads">\n				<div class="aju">\n					<img src="'+__e(imageSrc)+'" class="ajn" jid="'+__e(email)+'" />\n				</div>\n				<div class="gs">\n					<div class="gE gt">\n						<table>\n							<tbody>\n								<tr class="acZ">\n									<td class="gF gK">\n										<span email="'+__e(email)+'" class="gD">'+__e(name)+'</span>\n										<span class="go">'+__e(email)+'</span>\n									</td>\n									<td class="gH">\n										<div class="gK">\n											<span class="g3" title="'+__e(datetime)+'" alt="'+__e(datetime)+'">'+__e(gmailDate)+'</span>\n										</div>\n									</td>\n								</tr>\n								<tr class="acZ">\n									<td colspan="2">\n										<div class="iw ajw">\n											<span class="hb">\n												to '+((__t=emailListHTML)==null?"":__t)+'\n											</span>\n										</div>\n									</td>\n								</tr>\n							</tbody>\n						</table>\n					</div>\n					<div class="ii gt adP streak__email_body"></div>\n				</div>\n			</div>\n		</div>\n	</div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["modules/threadView/emailName"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<span email="'+__e(email)+'">'+__e(name)+"</span>\n"}return __p};Streak.Template._underscoreTemplates["modules/threadView/threadView"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<div class="streak__threadView" style="height: 100%; min-width: 700px;">\n	<div class="streak__main_thread_content">\n		<div class="loadingThreads">\n			<img aria-hidden="true" src="//ssl.gstatic.com/ui/v1/activityindicator/loading_bg_f5.gif">\n		</div>\n		<div class="if threadViewThreads">\n			<h1 class="ha subject"></h1>\n			<div class="hx emails"></div>\n		</div>\n		<div class="streak__threadView_error">\n		</div>\n	</div>\n	<div class="streak__thread_sidebar" id="streakSidebar">\n		<div class="boxInfo"></div>\n	</div>\n</div>\n'}return __p};Streak.Template._underscoreTemplates["widgets/feedList/boxObject"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+='<a href="#" class="streak__newsfeed_box" data-key="'+__e(key)+'">'+__e(name)+"</a>\n"}return __p};Streak.Template._underscoreTemplates["widgets/feedList/feedListRow"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+='	<div class="bb_feeditem_meta">\n		<img src="'+__e(userImageUrl)+'" class="bb_feedpic">\n	</div>\n\n	<div class="bb_feeddate" data-tooltip="'+__e(completeDatetime)+'">'+__e(datetime)+'</div>\n\n	<div class="bb_feeditem_content">\n		<div class="bb_feedtext">\n			'+((__t=storyHtml)==null?"":__t)+"\n		</div>\n\n		";if(detail){__p+='\n		<div class="bb_feeddetail">'+__e(detail)+"</div>\n		"}__p+="\n\n		";if(comment){__p+='\n		<div class="comment">\n			<div class="bb_pip"></div>\n			<div class="bb_feedcomment">\n				<div class="bb_feedcomment_text">'+__e(comment)+'</div>\n				<div class="bb_comment_fade"></div>\n			</div>\n		</div>\n		'}__p+="\n	</div>\n\n	";if(objects&&objects.length){__p+='\n	<div class="bb_feedobjects">\n		';_.each(objects,function(objectHtml){__p+='\n		<div class="bb_feedobject">'+((__t=objectHtml)==null?"":__t)+"</div>\n		"});__p+="\n	</div>\n	"}__p+="\n"}return __p}})();(function(Streak,window){var $=Streak.jQuery,_=Streak._,Request=Streak.Request;var HTML={_cachedTemplates:{},loaded:null,init:function(){var self=this;return new Request("GET",Streak.combinedServer||Streak.server,Streak.getCombined("html",false),{responseType:"text",isAnonymous:true}).getPromise().then(function(res){self.loaded=$(document.createElement("div"));self.loaded[0].innerHTML=res})},get:function(id,isElement){if(!isElement&&_.has(this._cachedTemplates,id)){return this._cachedTemplates[id]}var d=this.loaded.find("#"+id);if(d.length===0){throw new Error("can't find "+id)}var s=Streak.Locale.localize(d[0].innerHTML.unescapeHTML()).trim();if(isElement){return $($.parseHTML(s))}else{return this._cachedTemplates[id]=_.template(s)}},getString:function(id){var d=this.loaded.find("#"+id);if(d.length===0){console.log("can't find "+id);return id}else{return Streak.Locale.localize(d[0].innerHTML.unescapeHTML()).trim()}},getStringWithSelector:function(selector){var d=this.loaded.find(selector);if(d.length===0){return""}return Streak.Locale.localize(d[0].innerHTML.unescapeHTML()).trim()},getElementWithSelector:function(selector){var string=this.getStringWithSelector(selector);return $($.parseHTML(string))},getElement:function(id){return this.get(id,true)}};Streak.DependencyManager.addFunction({functionKey:"htmlLoaded",functionReference:HTML.init,functionContext:HTML,dependentFunctionKeys:["localeLoaded"]});Streak.HTML=HTML})(Streak,window);(function(){"use strict";var _=Streak._||require("lodash");var RSVP=Streak.RSVP||require("rsvp");var deparam=Streak.$?Streak.$.deparam.bind(Streak.$):require("querystring").parse;function logError(error,label){if(Streak.BentoBox&&Streak.BentoBox.logError){Streak.BentoBox.logError("XHRProxy warning"||label,error)}else{setTimeout(function(){throw error},1)}}function transformEvent(oldTarget,newTarget,event){var newEvent={};_.each(event,function(value,name){newEvent[name]=value===oldTarget?newTarget:value});return newEvent}function wrapEventListener(oldTarget,newTarget,listener){return function(event){return listener.call(newTarget,transformEvent(oldTarget,newTarget,event))}}function findApplicableWrappers(wrappers,connection){return _.filter(wrappers,function(wrapper){try{return wrapper.isRelevantTo(connection)}catch(e){logError(e)}})}function XHRProxyFactory(XHR,wrappers){return XHRProxy.bind(null,XHR,wrappers)}function XHRProxy(XHR,wrappers){this._wrappers=wrappers;this._listeners={};this._boundListeners={};var extraArgs=_.rest(arguments,2);if(XHR.bind&&XHR.bind.apply){this._realxhr=new(XHR.bind.apply(XHR,[null].concat(extraArgs)))}else{this._realxhr=new XHR}var self=this;function runRscListeners(event){if(self.onreadystatechange){try{wrapEventListener(self._realxhr,self,self.onreadystatechange).call(self,event)}catch(e){logError(e,"XMLHttpRequest event listener error")}}_.each(self._boundListeners.readystatechange,function(boundListener){try{boundListener(event)}catch(e){logError(e,"XMLHttpRequest event listener error")}})}function finalRsc(event){self.readyState=4;var supportsResponseText=!self._realxhr.responseType||self._realxhr.responseType=="text";if(supportsResponseText){_.each(self._activeWrappers,function(wrapper){if(wrapper.finalResponseTextLogger){try{wrapper.finalResponseTextLogger(self._connection,self.responseText)}catch(e){logError(e)}}})}runRscListeners(event);_.each(self._activeWrappers,function(wrapper){if(wrapper.afterListeners){try{wrapper.afterListeners(self._connection)}catch(e){logError(e)}}})}this._realxhr.addEventListener("readystatechange",function(event){if(!self._connection){return}if(self._realxhr.readyState>=2){self._connection.status=self._realxhr.status}var supportsResponseText=!self._realxhr.responseType||self._realxhr.responseType=="text";if(self._realxhr.readyState==4){if(supportsResponseText){Object.defineProperty(self._connection,"originalResponseText",{enumerable:true,writable:false,configurable:false,value:self._realxhr.responseText});_.each(self._activeWrappers,function(wrapper){if(wrapper.originalResponseTextLogger){try{wrapper.originalResponseTextLogger(self._connection,self._connection.originalResponseText)}catch(e){logError(e)}}});if(self._activeResponseTextChanger){var finish=_.once(finalRsc.bind(null,event));var connection=self._connection;new RSVP.Promise(function(resolve,reject){resolve(self._activeResponseTextChanger(self._connection,self._connection.originalResponseText))}).then(function(modifiedResponseText){if(connection===self._connection){Object.defineProperty(self._connection,"modifiedResponseText",{enumerable:true,writable:false,configurable:false,value:modifiedResponseText});self.responseText=modifiedResponseText;finish()}},function(err){logError(err);if(connection===self._connection){self.responseText=self._realxhr.responseText;finish()}}).catch(logError);return}self.responseText=self._realxhr.responseText}else{self.responseText=null}finalRsc(event)}else{if(self._realxhr.readyState>=3&&supportsResponseText){if(self._activeResponseTextChanger){self.responseText=""}else{self.responseText=self._realxhr.responseText}}else{self.responseText=null}self.readyState=self._realxhr.readyState;runRscListeners(event)}},false);["dispatchEvent","abort","getAllResponseHeaders","getResponseHeader","overrideMimeType","setRequestHeader","responseType","responseXML","status","statusText","timeout","ontimeout","upload","withCredentials","UNSENT","OPENED","HEADERS_RECEIVED","LOADING","DONE"].forEach(function(prop){Object.defineProperty(self,prop,{enumerable:true,configurable:false,get:function(){if(typeof self._realxhr[prop]=="function"){return self._realxhr[prop].bind(self._realxhr)}return self._realxhr[prop]},set:function(v){if(typeof v=="function"){v=wrapEventListener(this._realxhr,this,v)}self._realxhr[prop]=v}})});Object.defineProperty(self,"response",{enumerable:true,configurable:false,get:function(){if(!this._realxhr.responseType||this._realxhr.responseType=="text"){return this.responseText}else{return this._realxhr.response}}});self.readyState=self._realxhr.readyState}XHRProxy.prototype.addEventListener=function(name,listener){if(!this._listeners[name]){this._listeners[name]=[];this._boundListeners[name]=[]}if(!_.contains(this._listeners[name],listener)){var boundListener=wrapEventListener(this._realxhr,this,listener);this._listeners[name].push(listener);this._boundListeners[name].push(boundListener);if(name!="readystatechange"){this._realxhr.addEventListener(name,boundListener,false)}}};XHRProxy.prototype.removeEventListener=function(name,listener){if(!this._listeners[name]){return}var i=this._listeners[name].indexOf(listener);if(i==-1){return}this._listeners[name].splice(i,1);var boundListener=this._boundListeners[name].splice(i,1)[0];if(name!="readystatechange"){this._realxhr.removeEventListener(name,boundListener,false)}};XHRProxy.prototype.open=function(method,url){this._connection={method:method,url:url,params:deparam(url.split("?")[1]||"")};this._activeWrappers=findApplicableWrappers(this._wrappers,this._connection);var wrappersWithResponseTextChangers=_.filter(this._activeWrappers,function(wrapper){return!!wrapper.responseTextChanger});if(wrappersWithResponseTextChangers.length>1){logError(new Error("can't have multiple active wrappers with response changers"))}this._activeResponseTextChanger=wrappersWithResponseTextChangers[0]&&wrappersWithResponseTextChangers[0].responseTextChanger.bind(wrappersWithResponseTextChangers[0]);return this._realxhr.open.apply(this._realxhr,arguments)};XHRProxy.prototype.send=function(body){var self=this;Object.defineProperty(this._connection,"originalSendBody",{enumerable:true,writable:false,configurable:false,value:body});this._connection.responseType=this._realxhr.responseType||"text";_.each(self._activeWrappers,function(wrapper){if(wrapper.originalSendBodyLogger){try{wrapper.originalSendBodyLogger(self._connection,body)}catch(e){logError(e)}}});return this._realxhr.send.apply(this._realxhr,arguments)};Streak.XHRProxyFactory=XHRProxyFactory})();!function(e,t){"use strict";function n(){var t=arguments;e.BentoBox&&e.BentoBox.logError?e.BentoBox.logError.apply(e.BentoBox,t):setTimeout(function(){e.BentoBox.logError.apply(e.BentoBox,t)},1)}var i=e.jQuery,s=e._,r=e.Date,a=e.Utils,o=e.Template,h=e.Eventer,c=t.MutationObserver||t.WebKitMutationObserver||t.MozMutationObserver,l=function(e){u.debug&&console.log(e)},u=new h;s.extend(u,{Constants:{Compose:"compose",Inbox:"inbox",SectionQuery:"section_query",All:"all",Important:"imp",Conversation:"conversation",Contacts:"contacts",Contact:"contact",Sent:"sent",Starred:"starred",Drafts:"drafts",Label:"label",Search:"search",AdvancedSearch:"advanced-search",Trash:"trash",Spam:"spam",Apps:"apps",Box:"box",Pipeline:"pipeline",NewPipeline:"newpipeline",Pipelines:"pipelines",PipelineReports:"pipelinereports",GmailThread:"thread",Circle:"circle",Settings:"settings",ListViews:[],BentoBoxViews:[],DeepLinkLoading:"loading",Paywall:"upgrade",PaidAccount:"account"},debug:!1,elements:{},hash:{parts:null,query:null},view:null,lastView:"",wasLastViewConversation:!1,currentVisibleModal:"",label:null,conversation:null,timer:null,dontLoad:!1,hashChangeLastID:1,rowThreadIconIndex:0,cachedVerticalList:null,emailBodyModifierCallback:null,elementsInComposeArea:[],ajaxInterceptorSources:[],eventStreamBus:null,gmonkey:null,init:function(t){var n=this;l("Initializing Gmailr API"),this.xhrWatcher.init(this),this.eventStreamBus=new e.Bacon.Bus,n.Constants.ListViews=[n.Constants.Inbox,n.Constants.SectionQuery,n.Constants.Important,n.Constants.All,n.Constants.Sent,n.Constants.Starred,n.Constants.Drafts,n.Constants.Label,n.Constants.Search,n.Constants.AdvancedSearch,n.Constants.Spam,n.Constants.Trash,n.Constants.Apps,n.Constants.Circle],n.Constants.ContactViews=[n.Constants.Contacts,n.Constants.Contact],n.Constants.BentoBoxViews=[n.Constants.Pipeline,n.Constants.Box,n.Constants.NewPipeline,n.Constants.Pipelines,n.Constants.GmailThread,n.Constants.PipelineReports,n.Constants.DeepLinkLoading,n.Constants.Paywall,n.Constants.PaidAccount],n.delayed_loader=setInterval(function(){n.bootstrap(),n.isReadyToLoad&&"undefined"!=typeof gmonkey?(clearInterval(n.delayed_loader),n.parse(),n.loadGmonkey(function(){t&&t(),n.trigger("load"),e.NotificationCenter.postNotification({eventName:"gmailLoaded",sender:this}),n.trigger("ready")})):n.dontLoad&&clearInterval(n.delayed_loader)},1e3),-1===n.Constants.ContactViews.indexOf(location.hash.substring(1).split("/")[0].toLowerCase())&&setTimeout(function(){if(!n.isReadyToLoad&&!n.dontLoad){var t="something wrong with Gmail";e.BentoBox.logError(t)}},24e4)},teardown:function(){this.unReady(),clearInterval(this.timer)},reup:function(){this.trigger("ready"),this.setupGmailTimer()},destroy:function(){this.unbindWatchers(),this.xhrWatcher.destroy()},$:function(e){return this.elements.body.find(e)},insertCss:function(e){var t=i('<link rel="stylesheet" type="text/css">');t.attr("href",e),this.elements.canvas.find("head").first().append(t)},_currentNotice:null,_initNotices:s.once(function(){function e(){n._removeNotice(),n._renderNotice()}function t(){n._renderNotice(),n._currentNotice||n._postNoticesClearedNotification()}this.elements.notice.streakMessage=this.elements.notice.googleMessage.clone().addClass("streak__noticeMessage").insertAfter(this.elements.notice.googleMessage);var n=this;if(c){var i={childList:!0},s=new c(function(n){n.forEach(function(n){"childList"===n.type&&(n.addedNodes.length?e():t())})});s.observe(this.elements.notice.googleMessage[0],i)}else this.elements.notice.googleMessage.on("DOMNodeInserted DOMCharacterDataModified",e),this.elements.notice.googleMessage.on("DOMNodeRemoved",t)}),_postNoticesClearedNotification:function(){var e={eventName:"gmail.noticesCleared",noticeSpawned:!1};return this._postNotification(e),e.noticeSpawned},newNotice:function(t){this._initNotices(),this._removeNotice();var n=this;return this._currentNotice={html:t,isVisible:function(){return this===n._currentNotice},destroy:function(){this.isVisible()&&n._hideNotice()}},this._currentNotice._endJob=e.Promise.defer(),this._currentNotice.endPromise=this._currentNotice._endJob.promise,this._renderNotice(),this._currentNotice},_renderNotice:function(){this._currentNotice?(this.elements.notice.css({visibility:"visible",top:""}),this.elements.notice.googleMessage.css("display","none"),this.elements.notice.streakMessage.html(this._currentNotice.html).css("display","")):(this.elements.notice.css(this.elements.notice.googleMessage.html().trim().length>0?{visibility:"visible"}:{visibility:"hidden"}),this.elements.notice.googleMessage.css("display",""),this.elements.notice.streakMessage.empty().css("display","none"))},_hideNotice:function(){this._removeNotice(),this._postNoticesClearedNotification()||this._renderNotice()},_removeNotice:function(){this._currentNotice&&this._currentNotice._endJob.resolve(),this._currentNotice=null},showNotice:function(t,n,i){console.warn("Gmail.showNotice is deprecated! Use Streak.BentoBox.ButterBarManager instead."),e.BentoBox.ButterBarManager.showMessage({message:t,time:n,priority:i})},hideNotice:function(){this._initNotices(),this._hideNotice()},observe:function(e,t,n,i){n&&(t.uniq=n),t.uniq||(t.uniq=""+(new r).getTime()+Math.random()),i||(i=100),t.priority||(t.priority=i),this.ob_queues[e]||(this.ob_queues[e]=[]);var a=s.indexOfPlus(this.ob_queues[e],function(e){return e.uniq===n});return a>-1?this.ob_queues[e][a]=t:this.ob_queues[e].push(t),this.ob_queues[e]=s.sortBy(this.ob_queues[e],function(e){return e.priority}),t.uniq},unobserve:function(e,t){this.ob_queues[e]=s.filter(this.ob_queues[e],function(e){return e.uniq!=t})},getEventStream:function(){return this.eventStreamBus},bootstrap:function(){var t=document.getElementById("loading"),n=document.getElementById("canvas_frame");if(t&&"none"===t.style.display&&(n=n?n.contentDocument:document),n&&document.getElementsByTagName("body").length>0){this.elements.canvas=i(n),this.elements.body=this.elements.canvas.find("body").first();var s=this.$("div[role=main]");this.elements.main=s.closest(".ar4"),s&&s.length>0&&this.elements.main&&this.elements.main.length>0?(this.isReadyToLoad=!0,e.document=n):location.search.indexOf("view=cm")>-1&&(this.dontLoad=!0)}},loadGmonkey:function(e){var t=this;gmonkey.load("2.0",function(n){t.gmonkey=n,e()})},bindWatchers:function(e){var n=this;i(t).bind("hashchange.gmail",function(e){n.waitingToLoad||(n.hashChangeLastID+=1,n.detectViewChange(e,1,n.hashChangeLastID))
}),this.getCurrentMain(!0),this.setupGmailTimer(),this.detectListToggle(),this.setupAnimationWatcher(),this.detectDensitySetting(),this.detectPreviewPaneChange(),this.detectToolbarChanges(),this.detectEmailMenu(),this.detectMoreMenu(),this.detectChatMessages(),this.detectThreadLoaded(),this.detectConversationMessageStateChange(),this.detectNewInboxEmail(),this.setupCacheBusters(),this.setupComposeHolderResizeEvents(),e&&e()},unbindWatchers:function(){i(t).unbind(".gmail"),this.pauseTimer(),e.document.removeEventListener("animationstart",this.animationWatcher.watchFunc),e.document.removeEventListener("MSAnimationStart",this.animationWatcher.watchFunc),e.document.removeEventListener("webkitAnimationStart",this.animationWatcher.watchFunc)},parse:function(){this.elements.topbar=this.$("div#gb");this.elements.topbar.find(".gbvg");this.elements.topbar.leftLinks=this.elements.topbar.find("ol.gbtc:first"),this.elements.topbar.rightLinks=this.elements.topbar.find("ol.gbtc:last"),this.elements.notice=this.$("div.nn:nth-child(2) .b8"),this.elements.notice.googleMessage=this.elements.notice.find(".vh"),this.elements.logo=this.$("div.nn:first"),this.elements.search=this.$("div.nn:nth-child(2) table[role=search]"),this.elements.leftbar=this.$("div.oy8Mbf div[role=navigation]").parents("div.oy8Mbf"),this.elements.leftbar.links=this.elements.leftbar.find("div[role=navigation] [title]:first").parents(".n3"),this.elements.main=this.$("div[role=main]:first").closest(".ar4"),this.elements.mainParent=this.$("div[role=main]:first").parent(),this.elements.toolbarGroup=this.$(".aeH"),this.elements.viewGroup=this.$(".aeF > .nH")},setEmailBodyModifierCallback:function(e){this.emailBodyModifierCallback=e},xhrWatcher:{_originalXHR:null,_initialized:!1,init:function(){if(!this._initialized){this._initialized=!0;var t=top.document.getElementById("js_frame").contentDocument.defaultView;this._originalXHR=this._originalXHR||t.XMLHttpRequest;var n=[],s=e.XHRProxyFactory(this._originalXHR,n);t.XMLHttpRequest=s,n.push({isRelevantTo:function(e){return e.params.search&&"tl"==e.params.view},originalSendBodyLogger:function(e){u.executeObQueues("search",e.params.q)},afterListeners:function(e){if(200==e.status){var t=e.originalResponseText;u.executeObQueues("ajaxListRefresh",{search:e.params.search,viewData:t}),u._postNotification({eventName:"gmail.newThreadListResponse",searchTerm:e.params.search,response:t})}}}),n.push({isRelevantTo:function(e){return"sd"==e.params.act},afterListeners:function(t){if(200==t.status)try{var n=t.originalResponseText,i=u.ThreadResponseProcessor.deserialize(n),s=e.searchObject(i,"a",100,!0,!0)[0].path;s=s.split("/").slice(1,-1);for(var r=i,a=0;a<s.length;a++)r=r[s[a]];var o=r[3][0];u.executeObQueues("draftSaved",n,o)}catch(h){e.BentoBox.logError("draft saving error",h)}}}),n.push({isRelevantTo:function(e){return"sm"==e.params.act},originalSendBodyLogger:function(e,t){u.executeObQueues("compose",i.deparam(t))},afterListeners:function(t){if(200===t.status)try{var n=t.originalResponseText;u._postNotification({eventName:"gmail.emailSent",sender:u,requestParameters:i.deparam(t.originalSendBody),response:n}),u.executeObQueues("emailSent",{request:i.deparam(t.originalSendBody),response:n})}catch(s){e.BentoBox.logError("emailSent processing error",s)}}}),n.push({isRelevantTo:function(e){return"dr"==e.params.act},originalSendBodyLogger:function(e,t){u.executeObQueues("emailDiscarded",i.deparam(t).m)}}),n.push({isRelevantTo:function(e){return u.GmailThreadListViewRegister&&u.GmailThreadListViewRegister.isRequestRelevant(e.params)?(e._ajaxInterceptor=u.GmailThreadListViewRegister.getAjaxInterceptor(e.params),!0):!1},responseTextChanger:function(e,t){return e._ajaxInterceptor.getNewResponseText(e,t)}})}},destroy:function(){this._initialized=!1;var e=top.document.getElementById("js_frame").contentDocument.defaultView;e.XMLHttpRequest=this._originalXHR}},setupTimer:function(e){clearTimeout(this.timer),delete this.timer,this.timer=setTimeout(this.timerFunction,e||500)},timerFunction:function(e){var t=u;t.view=t.getLiveView(),t.isGmailView()&&t.getCurrentMain(!0),t.executeObQueues("gmailTimer"),t.setupTimer(e)},setupGmailTimer:function(e){var t=this;this.pauseTimer(),t.timerFunction(e)},pauseTimer:function(){clearTimeout(this.timer),delete this.timer},resumeTimer:function(){this.setupGmailTimer()},addTimerObserver:function(e,t,n){var i=e;t&&(i=s.throttle(function(){e()},t)),this.observe("gmailTimer",function(){i()},n)},setupCacheBusters:function(){var e=this;u.observe("viewChanged",function(){e.cachedVerticalList=null}),u.observe("newInboxEmails",function(){e.cachedVerticalList=null})},detectListToggle:function(){var e=this;u.observe("viewChanged",function(){if(e.isListView())for(var t=e.getCurrentMain().find("h3.Wr"),n=0;n<t.length;n++){var s=i(t[n]);s.data("toggleTracked")||(s.click(function(){var t=i(this).closest(".ae4"),n=!1;t.find(".Cp").children().length>0&&(n=!0),e.executeObQueues("listToggle",n)}),s.data("toggleTracked",!0))}})},detectPreviewPaneChange:function(){var e=this;this.currentPreviewPaneSettings=this.getFreshPreviewPaneSettings();var t=s.throttle(function(){e.isListView()&&e.getFreshPreviewPaneSettings()},500);u.observe("gmailTimer",function(){t()}),u.observe("viewChanged",function(){if(e.isListView()&&e.isHorizontalSplitPreviewPane()&&0===e.getCurrentMain().find(".age").filterOutInvisible().filter(":first").height()){var t=e.getLeftbarLinks().find(".ain").filter(":not(.pipeline)");if(t.length>0){var n=t.siblings();i(n[0]).find(".nU").click(),t.find(".nU").click()}}})},detectDensitySetting:function(){function e(){var e=parseInt(i(".TO .TN").css("padding-top"),10);return e>=6?"comfortable":e>=3?"cozy":"compact"}var t=this,n=null,r=function(){var s=e();n!=s&&(n&&i(document.body).removeClass("streak_gmail_density_"+n),n=s,i(document.body).addClass("streak_gmail_density_"+n),t.executeObQueues("gmailDisplayDensityChange",n))},a=new c(r),o={characterData:!0,childList:!0};s.each(document.styleSheets,function(e){"STYLE"==e.ownerNode.tagName&&a.observe(e.ownerNode,o)}),r()},detectToolbarChanges:function(){var e=this;if(c){var t={childList:!0},n={attributes:!0,attributeFilter:["style"]},i=new c(function(t){t.forEach(function(e){e.addedNodes&&s.each(e.addedNodes,function(e){i.observe(e,n)})}),e.executeObQueues("toolbarUpdate")});this.elements.toolbarGroup.add(this.elements.viewGroup).each(function(){i.observe(this,t)}).children().each(function(){i.observe(this,n)})}},getEmailMenu:function(){return i("#\\3a 2 td > div.nH.if > div.nH.aHU div.b7.J-M[aria-haspopup=true]")},_getEmailForActiveMenu:function(){return i(".T-I[role=button][aria-expanded=true]").parents(".Bk").first()},closeActiveEmailMenu:function(){i(".T-I[role=button][aria-expanded=true]").simulateRawClick()},getMessageIdFromElement:function(e){var t;return i(e).find(".adP").each(function(){return t=s.find(i(this).attr("class").split(/\s+/),function(e){return"m"==e[0]}),t?(t=t.slice(1),!1):void 0}),t},gotoCurrentThreadFolder:function(){document.location.hash=document.location.hash.replace(/\/[^\/]+$/,"")},expandAllEmailsInThread:function(){var e=i(".ade .hk .T-I[role=button] .gx");return e.simulateRawClick(),a.waitFor(function(){return i(".Bk:visible").length==i(".Bk:visible .adP").length},3e4)},collapseAllEmailsInThread:function(){var e=i(".ade .hk .T-I[role=button] .gq");return e.simulateRawClick(),a.wait(1)},detectEmailMenu:function(){function e(){s.disconnect(),t=n.getEmailMenu(),t.each(function(){s.observe(this,i)})}if(c){var t,n=this,i={attributes:!0,attributeFilter:["style","class"]},s=new c(function(){if(t.is(":visible")){var e=n._getEmailForActiveMenu();e.length&&n.executeObQueues("emailMenuOpen",t,e)}});this.observe("viewChanged",e),this.observe("conversationThreadLoadedEvent",e),e()}},detectMoreMenu:function(){function e(){i.disconnect(),t.getCurrentMoreButton().each(function(){i.observe(this,n)})}if(c){var t=this,n={attributes:!0,attributeFilter:["aria-expanded"]},i=new c(function(){var e=t._getCurrentMoreButtonMenu().filter(":visible");e.length&&t.executeObQueues("moreMenuOpen",e)});this.observe("viewChanged",e),e()}},detectChatMessages:function(){var t=this;e.DomWatcher.watchForNewSelector(".dw .km",function(e){t.executeObQueues("newChatMessage",i(e))})},detectThreadLoaded:function(){var t=this;e.DomWatcher.watchForNewSelector(".Bu .nH.if",function(e){if(t.isPreviewPane()||t.isInConversation())t.executeObQueues("conversationThreadLoadedEvent",i(e)),t._notifyConversationLoaded(i(e));else var n=t.observe("viewChanged",function(){t.unobserve("viewChanged",n),t.executeObQueues("conversationThreadLoadedEvent",i(e)),t._notifyConversationLoaded(i(e))},null,200)})},detectConversationMessageStateChange:function(){var t=this,n=s.delayed(function(){t.executeObQueues("conversationMessageStateChanged")},100);e.DomWatcher.watchForNewSelector("[role=main] .h7 > div",n),e.DomWatcher.watchForNewSelector("[role=main] .kv > div",n)},detectNewInboxEmail:function(){var t=this,n=[],r=s.delayed(function(){t.executeObQueues("newInboxEmails");var e=n;"vertical"===t.getPreviewPaneSettings()&&(e=t.getThreadDOMRows()),t._postNotification({eventName:"gmail.newThreadDOMRows",sender:t,threadDOMRows:e}),n=[]},10);e.DomWatcher.watchForNewSelector(".ae4 .Cp tr.zA [role=checkbox]",function(e){if(r(),"vertical"!==t.getPreviewPaneSettings()){var s=t.convertHTMLRowToObject(i(e).parents("tr"));t.executeObQueues("newInboxEmail",s),t._postNotification({eventName:"gmail.newThreadDOMRow",threadDOMRow:s,sender:t}),n.push(s)}})},setupAnimationWatcher:function(){var t=this;this.animationWatcher=e.Eventer.create({watchFunc:function(e){t.animationWatcher.trigger(e.animationName,e)}}),e.document.addEventListener("animationstart",this.animationWatcher.watchFunc,!1),e.document.addEventListener("MSAnimationStart",this.animationWatcher.watchFunc,!1),e.document.addEventListener("webkitAnimationStart",this.animationWatcher.watchFunc,!1)},addAnimationWatcher:function(e,t){if(s.isString(e)&&(e=[e]),e&&e.length>0)for(var n=0;n<e.length;n++)this.animationWatcher.bind(e[n],t)},ob_queues:{archive:[],"delete":[],spam:[],reply:[],compose:[],viewChanged:[],ajaxListRefresh:[],search:[]},pageREGEX:/p\d+/,getLiveView:function(){return this.view=this.getStoredView(this.hash.parts),this.view},getStoredView:function(e){return e&&e.length>0?e[0]:this.Constants.Inbox},checkAndTriggerInitialConversationView:function(){var e=i(".Bu .nH.if");e.length>0&&(this.executeObQueues("conversationThreadLoadedEvent",e),this._notifyConversationLoaded(e))},_notifyConversationLoaded:function(e){this._postNotification({eventName:"gmail.conversationThreadLoaded",sender:this,conversationElement:e})},waitingToLoad:!1,urlChangeChecker:null,setURL:function(t,n){this.waitingToLoad=!0;var i=this.currentMain,r=this;this.urlChangeChecker&&this.urlChangeChecker.destroy(),this.urlChangeChecker=s.repeatEvery(function(){e.BentoBox.UI.isBentoBoxView()&&e.BentoBox.UI.getCanvas().siblings().show();var s=r.getCurrentMain(!0);e.BentoBox.UI.isBentoBoxView()&&e.BentoBox.UI.getCanvas().siblings().hide(),i[0]!==s[0]&&(r.waitingToLoad=!1,r.urlChangeChecker.destroy(),r.urlChangeChecker=null,r.hashChangeLastID+=1,r.detectViewChange({fragment:t},1,r.hashChangeLastID),n&&n())},300,!0),location.hash="#"+t},detectViewChange:function(t,n,i){if(!this.waitingToLoad&&(n||(n=1),i||(i=1),i===this.hashChangeLastID)){var r=this,a=this.getCurrentMain(!0);if(a){this.view=null;{this.hash.partsString}if(this.hash.parts=[],this.hash.query=null,this.hash.partsString="",t.fragment){var o=t.fragment,h=o.indexOf("?");h>-1&&(this.hash.query=o.substring(h+1),o=o.substring(0,h));var c=o.split("/");if(this.hash.parts=c,this.hash.partsString=o,this.conversation=null,this.view=c[0],this.label=(this.view==this.Constants.Label||this.view==this.Constants.Search||this.view==this.Constants.Apps)&&c.length>1?c[1]:null,this.isCompose())this.view===this.Constants.Drafts&&c.length>1&&(this.conversation=s.last(c));else if(this.isInConversation())this.conversation=s.last(c);else if(this.isInContacts());else{var l=s.last(c);if(l&&16===l.length&&30>n)return this.isGmailView()&&e.BentoBox.UI.setGmailView(),void setTimeout(function(){r.detectViewChange(t,n+1,i)},300);this.conversation=null}}r.view||(r.view=r.Constants.Inbox),this.isListView()&&(this.rowThreadIconIndex=this.getCurrentMain().find("[gh=tl]").filter(":first").find("table colgroup col.yg").filter(":first").index()),r.executeObQueues("viewChanged",r.conversation?r.Constants.Conversation:r.view)}}},validateAndCorrectURLHash:function(){if(!this.hash.parts||!this.isURLHashValid()){this.hash.parts=[],this.hash.query=null,this.hash.partsString="";var e=location.hash.substring(1),t=e.indexOf("?");t>-1&&(this.hash.query=e.substring(t+1),e=e.substring(0,t));var n=e.split("/");this.hash.parts=n,this.hash.partsString=e}},isURLHashValid:function(){var e=location.hash;if(e.length>0){var t=e.indexOf("?");t>-1&&(e=e.substring(t))}return this.hash.partsString===e},isInConversation:function(){this.validateAndCorrectURLHash(),this.getCurrentMain(!0);var e=this.hash.parts;return e.length>1&&16===s.last(e).length||1===e.length&&e[0]===this.Constants.Sent?this.getCurrentMain().find(".gA.gt").filterOutInvisible().length>0&&this.getConversationSubjectHeader().length>0:!1},isInboxView:function(){return this.view===this.Constants.Inbox&&this.isListView()},isInSentConversation:function(){return this.isInConversation()&&1===this.hash.parts.length},isMaybeConversation:function(){return this.getCurrentMain().find(".gA.gt").filterOutInvisible().length>0&&this.getConversationSubjectHeader().length>0},isInContacts:function(){return this.view===this.Constants.Contacts||this.view===this.Constants.Contact},getConversationSubjectHeader:function(){return this.getCurrentMain().find(".ha")},getConversation:function(){return this.getCurrentMain().find(".if")},getConversationMessageBodies:function(){return this.getConversation().find(".adP")},executeObQueues:function(t){if(this.isReady()){var i=this,r=Array.prototype.slice.call(arguments,1);if(i.ob_queues[t]){for(var a=[],o=s.clone(i.ob_queues[t]),h=u.event,c=u.event={},l=0;l<o.length;l++)try{var d=o[l].apply(i,r);d&&(d.then(null,n.bind(null,"async error in gmail observer queue")),a.push(d))}catch(g){e.BentoBox.logError("error in gmail observer queue",g)}u.event=h,e.RSVP.allSettled(a).then(function(){i.trigger("finishedExecuting_"+t,c)})}this.eventStreamBus.push({eventName:t,arguments:r})}},_postNotification:function(t){this.isReady()&&e.NotificationCenter.postNotification(t)},getConversationId:function(){return this.hash.parts&&this.hash.parts.length>0?s.last(this.hash.parts):null},getCurrentMain:function(e){var t=this,n=function(){if(t.elements.main||(t.elements.main=t.$("div[role=main]:first").closest(".ar4")),t.elements.mainParent||(t.elements.mainParent=t.$("div[role=main]:first").parent()),t.elements.mainParent.length>0)for(var e=t.elements.mainParent[0].children,n=0;n<e.length;n++){var s=e[n];if("main"===s.getAttribute("role")&&"none"!==s.style.display)return i(s)}return i(document.createElement("div"))};return(e||!this.currentMain)&&(this.currentMain=n()),this.currentMain},Settings:{getEndingMenuMarker:function(){return u.getCurrentMainContainer().find(".aeH .f2 .fY .dJ").first()},getContentBodyBlockContainer:function(){return u.getCurrentMainContainer().find(".AO .nH.f2.hCyPr")},getContentBodyBlock:function(){return u.getCurrentMainContainer().find(".AO .nH.f2.hCyPr>.nH")},getStreakSettings:function(){return u.getCurrentMainContainer().find(".AO .nH.f2.hCyPr>.streakSettings")},getSettingTabs:function(){return u.getCurrentMainContainer().find(".nH.fY>.fZ")}},getGearButton:function(){return u.getCurrentMainContainer().find(".aos").parent().filter("[role=button]").filterOutInvisible()},getGearButtonMenu:function(){return i("[role=menu]").filter(":FastVisible")},getSettingsMenuItem:function(){var e=this.getGearButtonMenu();return e.find(".aMS")},getCurrentMainContainer:function(){return this.elements.main},getCurrentMoreButton:function(){var e=i(u.$("div[gh=tm]")[0]);return e=e.find("[gh=mtb] div[role=button]"),e=e.filterOutInvisible(),e=e.filter(":not(.Bq)"),e=e.filter(":last")},_getCurrentMoreButtonMenu:function(){return e.$("div.J-M.aX0.aYO.jQjAxd")},isIconButtonModeActive:function(){return 0==i(".G-Ni > .T-I[role=button]:visible").eq(1).text().trim().length},getRightSide:function(){return this.getCurrentMain().find("table.Bs .Bu").filter(":last")},getLeftBar:function(){if(!this.elements.leftbar||!this.elements.leftbar.isVisible()){var e=this.$("div.oy8Mbf div[role=navigation]");e=e.filter(":FastVisible(noCompute)"),this.elements.leftbar=e.parents("div.oy8Mbf")}return this.elements.leftbar},getLeftbarLinks:function(){if(!this.getLeftBar().links||!this.getLeftBar().links.isVisible()){var e=this.getLeftBar().find("div[role=navigation] [title]");this.getLeftBar().links=i(e[0]).parents(".n3")}return this.getLeftBar().links},getInboxLink:function(){var e=this.getLeftbarLinks().find(".aim a[href*=#inbox]");return e.length>0?e.closest(".aim"):void 0},getSentMailLink:function(){var e=this.getLeftBar().find(".aim a[href*=#sent]");return e.length>0?e.closest(".aim"):void 0},getComposeButton:function(){return this.$("[gh=cm]")},isConversationViewDisabled:function(){return this.gmonkey.isConversationViewDisabled()},isListView:function(){return this.isPreviewPane()?this.Constants.ListViews.indexOf(this.view)>-1&&i("[gh=tl]").isVisible():this.Constants.ListViews.indexOf(this.view)>-1&&!this.isConversation()&&!this.isCompose()},isConversation:function(){return this.isInConversation()},isConversationVisible:function(){return this.isPreviewPane()?!!this.getPreviewedRow():this.isConversation()},isGmailView:function(){return s.values(this.Constants.ListViews).indexOf(this.view)>-1},isContacts:function(){return this.view==this.Constants.Contacts},isSearch:function(){return(this.view==this.Constants.Search||this.view==this.Constants.Apps)&&!this.isConversation()},isCompose:function(){return this.view==this.Constants.Compose||this.view==this.Constants.Drafts&&0===this.getCurrentMoreButton().length},isDrafts:function(){return this.view==this.Constants.Drafts},getMainList:function(){for(var e=this.getCurrentMain().find("[gh=tl]"),t=0;t<e.length;t++){var n=i(e[t]).parents("[role=main]").length;if(1===n)return i(e[t])}return null},getListRows:function(e){for(var t=[],n=e.find("tr.zA"),s=0;s<n.length;s++)t.push(this.convertHTMLRowToObject(i(n[s]),s));return t},convertHTMLRowToObject:function(e,t){var n={type:this.getPreviewPaneSettings(),node:e,rowIndex:t,rowNode:e,getList:function(){return list},checked:e.find("input[type=checkbox]:checked, div[role=checkbox][aria-checked=true]").length>0};n.subjectLink=n.rowNode.find("[role=link]"),n.checkbox=n.rowNode.find("input[type=checkbox], div[role=checkbox]").parent(),"horizontal"===n.type&&(n.checked=n.checked||n.rowNode.hasClass("aps"),n.previewed=n.rowNode.hasClass("aps")),e.find("td.apU").length>0&&(n.starHolder=e.find("td.apU")),n.labelContainer=n.rowNode.find(".xT"),n.attachmentsContainer=n.rowNode.find(".yf"),n.date=n.rowNode.find("td:last");try{n.isUnread=n.subjectLink.find(".y6 span").filter(":first")[0].innerHTML.indexOf("<b>")>-1}catch(i){}return n},getVerticalListRows:function(e){var t=[],n=[],s=e.find("tr.zA"),r=0,a=function(){if(n.length>0){var s={type:"vertical",node:n,rowIndex:r++,rowNode:n[0],getList:function(){return e}};s.previewed=s.rowNode.hasClass("aps"),s.checked=s.previewed||s.rowNode.find("input[type=checkbox]:checked, div[role=checkbox][aria-checked=true]").length>0;for(var a=0;a<n.length;a++){var o=n[a],h=i(o);h.find(".apu").length>0&&(s.labelContainer=h.find(".apu")),h.find("[role=link]").length>0&&(s.subjectLink=h.find("[role=link]")),h.find("td.apU").length>0&&(s.starHolder=h.find("td.apU"))}s.isUnread=s.subjectLink.find(".y6 span").filter(":first")[0].innerHTML.indexOf("<b>")>-1,s.date=s.rowNode.find(".apt"),t.push(s),n=[]}};if(this.cachedVerticalList)for(var o=0;o<this.cachedVerticalList.length;o++){var h=this.cachedVerticalList[o].rowNode;this.cachedVerticalList[o].previewed=h.hasClass("aps"),this.cachedVerticalList[o].checked=this.cachedVerticalList[o].previewed||h.find("input[type=checkbox]:checked, div[role=checkbox][aria-checked=true]").length>0,this.cachedVerticalList[o].type="vertical"}else{for(var c=0;c<s.length;c++){var l=i(s[c]);l.find("[role=checkbox]").length>0&&a(),n.push(l)}a(),this.cachedVerticalList=t}return this.cachedVerticalList},getActiveHexGmailThreadIdList:function(e){var t,n;if(this.isListView())if(this.isPreviewPane()){var i=this.getPreviewedRow();if(i){if(n=this.getHexGmailThreadIdFromGmonkeyThread())return[e.getThreadIdForMessageId(n)];t=[i]}else t=this.getSelectedThreadRows()}else if(this.isMaybeConversation()){if(n=this.getHexGmailThreadIdFromGmonkeyThread())return[e.getThreadIdForMessageId(n)]}else t=this.getSelectedThreadRows();else{if(this.isConversationVisible()||this.isInConversation()){var s=this.getConversationId();return"sent"===s?this.getHexGmailThreadIdListFromSentConversation():[s]}if(this.isMaybeConversation()&&(n=this.getHexGmailThreadIdFromGmonkeyThread()))return[e.getThreadIdForMessageId(n)]}return this.isListView()?e.getHexGmailThreadIdList(t):[]},getHexGmailThreadIdListFromSentConversation:function(){var t=this.getHexGmailThreadIdFromGmonkeyThread();return t?[t]:[e.BentoBox.Services.Threads.SentEmailsMetaDataManager.getLastSentThreadMetaData().hexGmailThreadId]},getHexGmailThreadIdFromGmonkeyThread:function(){var e=this.gmonkey.getCurrentThread();return e?e.getThreadId():null},getThreadDOMRows:function(){return this.getVisibleThreadRows()},getVisibleThreadRows:function(e){var t=this.getCurrentMain(e).find("[gh=tl]");if(0===t.length)return[];if(this.isListView()){for(var n=[],s=0;s<t.length;s++){var r=i(t[s]);n=n.concat(t[s].getAttribute("class").has("aia")?r.find(".nn").length>0?this.getVerticalListRows(r):this.getListRows(r,"horizontal"):this.getListRows(r))}return n}return[]},getCheckboxesForCheckedRows:function(){return this.getCurrentMain().find("[gh=tl] .aDM .x7 td.aid")},getSelectedThreadRows:function(){return this.getVisibleThreadRows().filter(function(e){return e.checked})},getPreviewedThreadDOMRow:function(){return this.getPreviewedRow()},getPreviewedRow:function(){var e=this.getVisibleThreadRows().filter(function(e){return e.previewed});return e.length>0?e[0]:void 0},getActiveViewLink:function(){return this.getLeftbarLinks().find(".nZ")},getToolbarButtons:function(){var e=this.getCurrentMainContainer().find("[role=navigation] div[role=button]");return e.filterOutInvisible()},getListToolbarContainer:function(){return this.$("[gh=tm]")},getSendButton:function(){return i(this.getToolbarButtons()[0])},getSaveButton:function(){return i(this.getToolbarButtons()[1])},getDiscardButton:function(){return i(this.getToolbarButtons()[2])},getArchiveButton:function(){return this.$("div[gh=tm]").find("div[gh=mtb] div[role=button]").filter("[act=7]")},getDeleteButton:function(){return this.$("div[gh=tm]").find("div[gh=mtb] div[role=button]").filter("[act=10]")},getMoveAndLabelDropdownButtons:function(){return this.$("div[gh=tm]").find("div[gh=mtb] div:not(.G-as3):not(.streak__gmailIconArrowButtonType)[role=button]").filter(".ns, .mw")},getDiscardDraftsButton:function(){return i(this.$("div[gh=tm]").find("div[gh=mtb] div[role=button]")[1])},getGooglePlusNameContainer:function(){return i("#gbsfw").parent().parent().children("div").first()},getProfilePictureLink:function(){return i("[guidedhelpid=gbacsw]")},getProfilePictureLinkContainer:function(){return this.getProfilePictureLink().parent().parent()},getThemeLoaded:function(){try{var e=JSON.stringify(GLOBALS),t=e.indexOf("sx_skcs");if(t>-1){var n=e.substring(t-2,e.indexOf("]",t)+1);return JSON.parse(n)[1]}}catch(i){}return"unknown"},getEnabledLabs:function(){try{var e=s.filter(GLOBALS[17][6][1],function(e){return e[0].indexOf("lab")>-1&&"1"==e[1]?!0:void 0});return s.pluckPlus(e,function(e){return e[0]})}catch(t){}return""},isOldUI:function(){try{var e=JSON.stringify(GLOBALS),t=e.indexOf("sx_sd");if(t>-1){var n=e.substring(t-2,e.indexOf("]",t)+1);return"classic"==JSON.parse(n)[1]}}catch(i){}return!1},isGooglePlusEnabled:function(){return this.$("#gbi4i").length>0},getPreviewPaneSettings:function(){return this.currentPreviewPaneSettings},getFreshPreviewPaneSettings:function(){var e="classic";return this.getPreviewPaneLoaded()&&(this.isVerticalSplitPreviewPane()?e="vertical":this.isHorizontalSplitPreviewPane()&&(e="horizontal")),this.currentPreviewPaneSettings!=e&&(this.currentPreviewPaneSettings=e,this.executeObQueues("previewPaneChanged",e)),e},getPreviewPaneLoaded:function(){var e=this.getMainList();return e?e[0].getAttribute("class").has("aia"):!1},getSearchContainer:function(){return this.elements.searchContainer||(this.elements.searchContainer=this.$("[gh=sb]")),this.elements.searchContainer},getSearchInput:function(){return this.elements.search.input||(this.elements.search.input=this.$("[gh=sb] input"),this.elements.search.input>1&&(this.elements.search.input=this.elements.search.input.filter("#gbqfq"))),this.elements.search.input},getSearchButton:function(){return this.getSearchContainer().closest("form").find("button")},getSearchAutoComplete:function(){return this.elements.search.autoComplete=this.$(".U5"),this.elements.search.autoComplete&&0!==this.elements.search.autoComplete.length||(this.elements.search.autoComplete=this.$(".gstl_0.gssb_c, #gbw .gscs_a")),this.elements.search.autoComplete},getKeyboardHelp:function(){return this.$(".wa")},getReplyButtons:function(e){for(var t=e.find("[role=navigation]"),n=[],s=[],r=[],a=0;a<t.length;a++){var o=i(t[a]).find("div[role=button]");n.push(o.filter(".nS")),s.push(o.filter(".nQ")),r.push(o.filter(".lX"))}return{send:n,save:s,discard:r}},getEditableArea:function(e){var t=e.find("iframe.editable"),n=t.length>0?i(t[0].contentDocument).find("body.editable"):null,s=(t.length>0?t[0].contentWindow:null,u.getCurrentMain());t=s.find("form .At textarea");var r=t.length>0?i(t[0]):null;return r&&r.isVisible()?r:n?n:void 0},getCurrentOpenEmailMessages:function(){for(var e=this.getCurrentMain().find(".Bk"),t=[],n=0;n<e.length;n++){var s=i(e[n]).parent();s.hasClass("h7")&&t.push(s)}return i(t)},isPreviewPane:function(){return"classic"!==this.currentPreviewPaneSettings},isPreviewPaneConversation:function(){return this.isPreviewPane()&&this.isListView()},isVerticalSplitPreviewPane:function(){return this.getPreviewPaneLoaded()?this.getMainList().find(".nn").length>0:!1},isHorizontalSplitPreviewPane:function(){return this.getPreviewPaneLoaded()?0===this.getMainList().find(".nn").length:!1},isTabbedInbox:function(){return i(".aKh").length>0},setupComposeHolderResizeEvents:function(){function n(){for(var e=0;e<s.elementsInComposeArea.length;e++){var t=s.elementsInComposeArea[e];t.show();var n=t.offset();n.left<5&&t.hide()}}var s=this;i(t).resize(function(){for(var e=i(document).height()+"px",t=[],n=0;n<s.elementsInComposeArea.length;n++){var r=s.elementsInComposeArea[n];r.find(".streak__inComposeArea").length>0&&(r[0].style.height=e,t.push(r))}s.elementsInComposeArea=t}),e.NotificationCenter.subscribe({eventName:"newComposeWindow",functionToCall:n,observer:this}),e.NotificationCenter.subscribe({eventName:"composeWindowRemoved",functionToCall:n,observer:this})},addToComposeArea:function(e,t){var n=i(".dw .no > div.nn:first").parent(),s=i(document.createElement("div"));s[0].style.width=t+"px",s[0].style.height=n.parent().height()+"px",s[0].setAttribute("class","nH nn streak__composeItemWrapper");var r=i(document.createElement("div"));return r[0].setAttribute("class","Hd no"),s.append(r),r.append(e),e.addClass("streak__inComposeArea"),n.prepend(s),this.elementsInComposeArea.push(s),s},getComposeWindowContainerElement:function(){return i(".dw .no > div.nn:first").parent()},removeFromComposeArea:function(e){this.elementsInComposeArea.removeVal(e),e.detach()},readdToComposeArea:function(e){i(".dw .no > div.nn:first").before(e),this.elementsInComposeArea.push(e)},hideComposeLayer:function(){i(".dw").hide(),i(".Wk").hide()},unhideComposeLayer:function(){i(".dw").show(),i(".Wk").show()},triggerListRefresh:function(){this.$("[gh=mtb] [act=20]").simulateRawClick()},widgets:{getDeleteIcon:function(){var e=i(document.createElement("div"));return e.addClass("ar9 G8oNDd tk3N6e-I-J3 J-J5-Ji"),e[0].setAttribute("style","vertical-align: middle; padding-top:2px; width: 16px;"),e},getSettingsIcon:function(){var e=i(document.createElement("div"));return e.addClass("aos"),e},getLabelTag:function(e,t,n){var s=i("<div/>");return s.addClass("ar as"),s.html(o.underscore("core/gmail/labelTag")({text:e,groupcolor:t,textcolor:n})),s},getCheckbox:function(e,t,n){var s=i("<div/>").addClass("gmailCheckbox").attr("tabindex",0),r=i("<div/>").addClass("oZ-jc T-Jo J-J5-Ji"),a=i("<div/>").addClass("T-Jo-auh");return s.append(r),r.append(a),e&&e.length>0&&s.append(i("<span/>").text(e)),r.easyHoverClass("T-Jo-JW"),t&&(r.addClass("T-Jo-Jp"),s.prop("checked",!0)),n||(s.mousedown(function(e){e.preventDefault()}),s.click(function(e){e.stopPropagation(),r.toggleClass("T-Jo-Jp"),s.prop("checked",r.hasClass("T-Jo-Jp")),s.trigger("change")}),s.keydown(function(e){(13===e.which||32===e.which)&&(e.stopPropagation(),e.preventDefault(),r.toggleClass("T-Jo-Jp"),s.prop("checked",r.hasClass("T-Jo-Jp")),s.trigger("change"))})),s.setChecked=function(e){var e=e?!0:!1;return r.toggleClass("T-Jo-Jp",e),s.prop("checked",r.hasClass("T-Jo-Jp"))},s.isChecked=function(){return s.prop("checked")===!0},s},getLabelActionTag:function(e){var t={backgroundColor:"rgb(221, 221, 221)",textColor:"rgb(102, 102, 102)",labelText:null,labelHelpText:null,labelCallback:i.noop,xHelpText:null,xCallback:i.noop},n={};i.extend(n,t,e);var s=i("<span/>");return s.addClass("J-J5-Ji"),s.html(o.underscore("core/gmail/labelActionTag")(n)),s.find(".bb_labelActionTag").hover(function(){i(this);i(this).css({backgroundColor:n.textColor,color:n.backgroundColor})},function(){i(this);i(this).css({backgroundColor:n.backgroundColor,color:n.textColor})}),s.reset=function(){s.find(".hM").css({backgroundColor:n.backgroundColor,color:n.textColor})},s.find(".hU").click(n.labelCallback),s.find(".hV").click(n.xCallback),s},getInlineNotice:function(e,t){var n=i('<div class="ya yb"></div>');return n[0].innerHTML=e,s.isArray(t)&&s.each(t,function(e){var t=i('<span class="x8" role="link"></span>');t[0].innerHTML=e.text,t.click(function(t){e.callback&&(e.callback(t),t.stopPropagation())}),n.append(t)}),n}}}),e.DependencyManager.addFunction({functionKey:"gmailLoaded",functionToCall:u.init,functionContext:u}),e.DependencyManager.addFunction({functionKey:"gmail.bindWatchers",functionToCall:u.bindWatchers,functionContext:u,dependentFunctionKeys:["gmailLoaded"]}),e.Gmail=u}(Streak,window);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager;var RFCMessageIdExtractor=Streak.Class.subclass({className:"RFCMessageIdExtractor",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getRFCMessageIdForThread:function(hexGmailThreadId,callback){Gmail.GmailRequester.get({view:"om",th:hexGmailThreadId}).getPromise().then(function(response){var messageId;try{messageId=_extractRFCMessageId(response)}catch(err){}if(messageId){callback(messageId);return}Streak.BentoBox.logError("extracting messageId\n"+response);callback()},function(){Streak.BentoBox.logError("rfc message id request failed");callback()})}});function _extractRFCMessageId(response){if(!response){return}var parts=response.split(/\r|\n/);if(parts.length===1){return}var messageParts=_.filter(parts,function(part){return part.match(/^\s*Message-ID:\s*\</i)});if(messageParts.length!==1){return}var lineParts=messageParts[0].split(":");if(lineParts.length<2){return}return lineParts[1].trim()
}Gmail.RFCMessageIdExtractor=new RFCMessageIdExtractor})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Gmail=Streak.Gmail;var GmailComposeWindowMasterController=function(){this._composeWindows=[];this._composeWindowContainer=null;this._numberOfContainerChildren=null;this._attachmentMap={};this._potentiallyDiscardedOrSentComposeWindows=[];this._detectNewComposeWindows();this._detectChangeInComposeWindows();this._detectDraftSaving();this._detectEmailSent();this._detectThreadSent();this._detectEmailDiscarded();this._detectMinimizedWindows();this._detectAttachmentAdded();this._detectSentEmailMetaDataRetrieved()};GmailComposeWindowMasterController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(GmailComposeWindowMasterController.prototype,{getComposeWindows:function(){return this._composeWindows},_detectNewComposeWindows:function(){var self=this;Gmail.addAnimationWatcher("streakComposeNodeInserted",function(event){if(event.target&&event.target.querySelectorAll(".gU.Up").length===0){return}self._processNewComposeWindow($(event.target))})},_processNewComposeWindow:function(composeWindowJQueryElement){if(this._haveWeAlreadySeenThisComposeWindow(composeWindowJQueryElement)){return}if(this._composeWindowContainer===null){this._getContainerAndMarkPermanentChildren(composeWindowJQueryElement)}composeWindowJQueryElement.addClass("streakGmailCompose");var composeWindowController=new Gmail.GmailComposeWindowViewController;composeWindowController.setJQueryNode(composeWindowJQueryElement);this._composeWindows.push(composeWindowController);this._numberOfContainerChildren=this._composeWindowContainer.children().length;var readyChecker=_.repeatEvery(function(){if(composeWindowController.isReady()){readyChecker.stop();Streak.NotificationCenter.postNotification({eventName:"newComposeWindow",composeWindowController:composeWindowController,sender:this})}},150,false)},_getContainerAndMarkPermanentChildren:function(composeWindowJQueryElement){this._composeWindowContainer=composeWindowJQueryElement.closest(".no").parent().parent();this._composeWindowContainer.children().addClass("streakGmailComposeChildren")},_haveWeAlreadySeenThisComposeWindow:function(composeWindowJQueryElement){for(var ii=0;ii<this._composeWindows.length;ii++){if(this._composeWindows[ii].getElement()[0]===composeWindowJQueryElement[0]){return true}}return false},_detectChangeInComposeWindows:function(){var self=this;Gmail.addAnimationWatcher(["streakComposeTriggerEven","streakComposeTriggerOdd"],function(){if(self._composeWindowContainer.children().length<self._numberOfContainerChildren){self._findAndHandleRemovedComposeWindows()}})},_findAndHandleRemovedComposeWindows:function(){if(!this._composeWindowContainer){return}var existingWindows=this._composeWindows.slice(0);this._composeWindows.length=0;var composeWindowRemoved=false;for(var i=0;i<existingWindows.length;i++){var composeWindowController=existingWindows[i];if(composeWindowController.isAttachedToBody()){this._composeWindows.push(composeWindowController)}else{this._addToPotentiallyDiscardedOrSentComposeWindows(composeWindowController);composeWindowRemoved=true}}if(composeWindowRemoved){Streak.NotificationCenter.postNotification({eventName:"composeWindowRemoved",sender:this})}this._numberOfContainerChildren=this._composeWindowContainer.children().length},_addToPotentiallyDiscardedOrSentComposeWindows:function(composeWindowController){composeWindowController.notify("potentiallyDiscardedOrSent");this._potentiallyDiscardedOrSentComposeWindows.push(composeWindowController);if(this._potentiallyDiscardedOrSentComposeWindows.length>5){var composeWindowController=this._potentiallyDiscardedOrSentComposeWindows.shift();if(composeWindowController&&composeWindowController.destroy){composeWindowController.destroy()}}},_detectDraftSaving:function(){var self=this;Gmail.observe("draftSaved",function(response,draftId){self._findComposeWindowWithDraftIdAndNotify(draftId,"draftSaved")})},_detectEmailSent:function(){var self=this;Gmail.observe("compose",function(emailObject){self._findComposeWindowWithDraftIdAndNotify(emailObject.draft,"emailSent")})},_detectThreadSent:function(){Streak.NotificationCenter.subscribe({eventName:"hexGmailThreadIdForSentEmailFound",observer:this,functionToCall:this._findSentComposeWindowAndNotify})},_detectEmailDiscarded:function(){var self=this;Gmail.observe("emailDiscarded",function(draftId){self._findDiscardedComposeWindowAndNotify(draftId)})},_findComposeWindowWithDraftIdAndNotify:function(draftId,eventName){var composeWindowList=this._composeWindows;for(var ii=0;ii<composeWindowList.length;ii++){if(composeWindowList[ii].getDraftId()===draftId){Streak.NotificationCenter.postNotification({eventName:eventName,composeid:composeWindowList[ii].getComposeid(),sender:this});break}}},_findDiscardedComposeWindowAndNotify:function(draftId){var discardedComposeid=null;var composeWindowControllerToDestroy=null;var composeWindowController;for(var ii=0;ii<this._potentiallyDiscardedOrSentComposeWindows.length;ii++){composeWindowController=this._potentiallyDiscardedOrSentComposeWindows[ii];if(composeWindowController.getDraftId()===draftId){discardedComposeid=composeWindowController.getComposeid();this._potentiallyDiscardedOrSentComposeWindows.removeVal(composeWindowController);composeWindowControllerToDestroy=composeWindowController;break}}if(!discardedComposeid){for(var ii=0;ii<this._composeWindows.length;ii++){composeWindowController=this._composeWindows[ii];if(composeWindowController.getDraftId()===draftId){discardedComposeid=composeWindowController.getComposeid();this._composeWindows.removeVal(composeWindowController);composeWindowControllerToDestroy=composeWindowController;break}}}if(discardedComposeid){Streak.NotificationCenter.postNotification({eventName:"emailDiscarded",composeid:discardedComposeid,sender:this})}if(composeWindowControllerToDestroy){composeWindowControllerToDestroy.destroy()}},_findSentComposeWindowAndNotify:function(notification){var sentComposeWindowController=this._getPotentiallySentComposeWindowController(notification.composeid);if(sentComposeWindowController){sentComposeWindowController.sentEmailThreadMetaDataFound(notification.threadMetaData)}},_detectMinimizedWindows:function(){var minimizedComposeWindows=[];var self=this;Gmail.addTimerObserver(function(){self._findAndHandleRemovedComposeWindows();for(var ii=0;ii<self._composeWindows.length;ii++){var composeWindowController=self._composeWindows[ii];if(composeWindowController.isMinimized()){if(minimizedComposeWindows.indexOf(composeWindowController.getComposeid())===-1){minimizedComposeWindows.push(composeWindowController.getComposeid());composeWindowController.notifyMinimized()}}else{if(minimizedComposeWindows.indexOf(composeWindowController.getComposeid())>-1){minimizedComposeWindows.removeVal(composeWindowController.getComposeid());composeWindowController.notifyRestored()}}}},500)},_detectAttachmentAdded:function(){var self=this;Gmail.addTimerObserver(function(){var oldAttachmentMap=_.clone(self._attachmentMap);for(var ii=0;ii<self._composeWindows.length;ii++){var composeId=self._composeWindows[ii].getComposeid();var numberOfAttachments=self._composeWindows[ii].getAttachmentDOMElements().length;self._attachmentMap[composeId]=numberOfAttachments;if(oldAttachmentMap[composeId]<numberOfAttachments){Streak.NotificationCenter.postNotification({eventName:"newAttachmentAdded",composeId:composeId,sender:this});self._composeWindows[ii].notify("newAttachmentAdded")}}},500)},_detectSentEmailMetaDataRetrieved:function(){Streak.NotificationCenter.subscribe({eventName:"allMetaDataRetrievedForCompose",observer:this,functionToCall:this._destroySentCompose})},_destroySentCompose:function(notification){var sentComposeWindowController=this._getPotentiallySentComposeWindowController(notification.composeid);if(sentComposeWindowController){sentComposeWindowController.destroy()}},_getPotentiallySentComposeWindowController:function(composeid){var sentComposeWindowController=null;var composeWindowController;for(var ii=0;ii<this._potentiallyDiscardedOrSentComposeWindows.length;ii++){composeWindowController=this._potentiallyDiscardedOrSentComposeWindows[ii];if(composeWindowController.getComposeid()===composeid){sentComposeWindowController=composeWindowController;break}}if(!sentComposeWindowController){for(var ii=0;ii<this._composeWindows.length;ii++){composeWindowController=this._composeWindows[ii];if(composeWindowController.getComposeid()===composeid){sentComposeWindowController=composeWindowController;break}}}return sentComposeWindowController}});Streak.DependencyManager.addFunction({functionKey:"gmailComposeWindowMasterControllerInitialized",functionReference:function(){Gmail.GmailComposeWindowMasterController=new GmailComposeWindowMasterController},dependentFunctionKeys:["gmailLoaded","localeLoaded"]})})(Streak);(function(Streak){var _=Streak._,$=Streak.jQuery,jwerty=Streak.jwerty,Gmail=Streak.Gmail;var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;var MAX_TOOLBAR_BUTTONS_BEFORE_OVERFLOW=4;var GmailComposeWindowViewController=function(){Streak.ViewControllerBase.call(this);this._jQueryNode=null;this._container=null;this._storedDraftId=null;this._composeid=null;this._viewControllers=[];this._unbinders=[];this._toolbarBeforeFormattingViewControllers=[];this._sendButtonAreaViewControllers=[];this._tabUnbinders=[];this._eventListeners=[];this._internalSidebar=null;this._externalSidebar=null;this._externalSidebarCSSRule=null;this._externalSidebarViewController=null;this._additionalAreas={};this._characterSequenceController=null;this._setupTimeout=null;this._lastSubjectPosition=null;this._elementOfLastFocus=null;this._activeModules=[];this._moduleStorage={}};GmailComposeWindowViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(GmailComposeWindowViewController.prototype,{setJQueryNode:function(jQueryNode){this._jQueryNode=jQueryNode;this._container=jQueryNode.closest(".no").parent();this._setComposeid();this._bindToComposeEvents();this._setupKeyboardEvents();this._bindToEmailContentChanges()}});_.extend(GmailComposeWindowViewController.prototype,{isReady:function(){return this.getEditor().length>0&&this.getSendButton().length>0},getMinimizeButton:function(){return $(this._jQueryNode.find(".Hm > img")[0])},getPopOutButton:function(){return $(this._jQueryNode.find(".Hm > img")[1])},getCloseButton:function(){return $(this._jQueryNode.find(".Hm > img")[2])},getEditor:function(){if(!this._jQueryNode){return}return this._jQueryNode.find(".Ap [g_editable=true]")},getComposeBodyHTML:function(){var editor=this.getEditor();if(!editor||editor.length===0){return""}var bodyHTML=editor[0].innerHTML;if(bodyHTML.indexOf('"gmail_extra')>-1){bodyHTML=bodyHTML.replace(/\r|\n/,"").replace(/<div class\=\"gmail_extra\">.*/gim,"<div>")}return bodyHTML},getSelectedBodyText:function(){this.getEditor().focus();var text="";if(window.getSelection){text=window.getSelection().toString()}else if(document.selection&&document.selection.type!="Control"){text=document.selection.createRange().text}return text},getSubjectInput:function(){return this._jQueryNode.find("input[name=subjectbox]")},getThreadMetaData:function(){var threadMetaData={};threadMetaData.threadGmailId=this.getDraftId();threadMetaData.subject=this.getSubject();threadMetaData.timeString="";threadMetaData.emailString="";threadMetaData.names=[];threadMetaData.emailAddresses=[];var addresses=this.getToContacts();for(var i=0;i<addresses.length;i++){var address=addresses[i];threadMetaData.emailAddresses.push(address.emailAddress);if(address.name){threadMetaData.names.push(address.name)}else{threadMetaData.names.push(null)}}return threadMetaData},getSubject:function(){return this.getSubjectInput().val()},getHiddenDraftValue:function(){return this._getFormFieldValue("uet")},getSendButton:function(){return this._jQueryNode.find(".IZ").find(".Up > div > [role=button]")},getDiscardButton:function(){return this._jQueryNode.find(".gU.az5 .oh")},getContactRows:function(){return this._jQueryNode.find(".GS tr")},getToEmailAddresses:function(){return _.map(this.getToContacts(),function(contact){return contact.emailAddress})},getToContacts:function(){var people=[];var spans=this._jQueryNode.find("span.vN[email]");for(var i=0;i<spans.length;i++){var obj={emailAddress:spans[i].getAttribute("email")};if(spans[i].innerText!==obj.emailAddress){obj.name=spans[i].innerText}people.push(obj)}return people},getCCContacts:function(){var contactRows=this.getContactRows();var ccRow=$(contactRows[1]);return this._extractPeopleContacts(ccRow)},getBCCContacts:function(){var contactRows=this.getContactRows();var bccRow=$(contactRows[2]);return this._extractPeopleContacts(bccRow)},_extractPeopleContacts:function(container){var people=[];var peopleSpans=this._jQueryNode.find("span.vN[email]");for(var i=0;i<peopleSpans.length;i++){var obj={emailAddress:peopleSpans[i].getAttribute("email")};if(peopleSpans[i].innerText!==obj.emailAddress){obj.name=peopleSpans[i].innerText}people.push(obj)}return people},getFromAddress:function(){var contactRows=this._jQueryNode.find(".GS tr");var fromRow=$(contactRows[3]);var span=fromRow.find("span");if(span.length===0){return Streak.BentoBox.getUser().getEmail()}var emailAddresses=Streak.Utils.extractEmailAddresses(span.text());if(emailAddresses.length===0){return Streak.BentoBox.getUser().getEmail()}return emailAddresses[0]},getElement:function(){return this._jQueryNode},isAttachedToBody:function(){return this._jQueryNode.is(":inBody")},getDraftId:function(){var draftId=this._getFormFieldValue("draft");if(!draftId||draftId==="undefined"){draftId=this._storedDraftId}return draftId},getComposeid:function(){return this._composeid},getAddressesContainer:function(){return this._jQueryNode.find(".fX")},getExtraRecipientsContainer:function(){return this._jQueryNode.find(".aA6 > span > span, .ow > span > span").first()},getAttachmentDOMElements:function(){return this._jQueryNode.find(".dL")},getStatusTextArea:function(){return this._jQueryNode.find(".aWQ")},hasAttachments:function(){return this.getAttachmentDOMElements().length>0},isMinimized:function(){return this._jQueryNode.children().filter("[style*=none]:not(.streak__compose_externalSidebar_wrapper)").length>0},getInsertLinkButton:function(){return this._jQueryNode.find(".e5.aaA.aMZ")}});_.extend(GmailComposeWindowViewController.prototype,{minimize:function(){this.getMinimizeButton().simulateRawClick()},restore:function(){this.getMinimizeButton().simulateRawClick()},popOut:function(){this.getPopOutButton().simulateRawClick()},close:function(){this.getCloseButton().simulateRawClick()},send:function(){this.getSendButton().simulateRawClick()},discard:function(){this.getDiscardButton().simulateRawClick()},clearAttachments:function(){this.getAttachmentDOMElements().find("[role=button], [role=link]").simulateRawClick()},destroy:function(){clearTimeout(this._setupTimeout);for(var ii=0;ii<this._viewControllers.length;ii++){this._viewControllers[ii].destroy()}for(var ii=0;ii<this._unbinders.length;ii++){if(_.isFunction(this._unbinders[ii])){this._unbinders[ii]()}}for(var ii=0;ii<this._tabUnbinders.length;ii++){if(_.isFunction(this._tabUnbinders[ii])){this._tabUnbinders[ii]()}}this._viewControllers.length=0;this._sendButtonAreaViewControllers.length=0;this._toolbarBeforeFormattingViewControllers.length=0;this._unbinders.length=0;this._tabUnbinders.length=0;if(this._characterSequenceController){this._characterSequenceController.destroy();this._characterSequenceController=null}if(this._additionalAreas){for(var key in this._additionalAreas){var area=this._additionalAreas[key];if(area){area.remove()}this._additionalAreas[key]=null}this._additionalAreas=null}for(var ii=0;ii<this._eventListeners.length;ii++){this._removeEventListener(this._eventListeners[ii])}if(this._toolbarOverflowButton){this._toolbarOverflowButton.destroy()}this._jQueryNode=null;this._container=null;Streak.NotificationCenter.unsubscribe({observer:this});Streak.ViewControllerBase.prototype.destroy.call(this)},hide:function(){this._jQueryNode.hide()},unhide:function(){this._jQueryNode.show()},isDestroyed:function(){return this._jQueryNode===null}});_.extend(GmailComposeWindowViewController.prototype,{addViewControllers:function(viewControllers){_.mutate("union",this._viewControllers,viewControllers);_.mutate("union",this._delegates,viewControllers);if(!this.isReady()){var self=this;clearTimeout(this._setupTimeout);this._setupTimeout=setTimeout(function(){self.addViewControllers([])},100);return}for(var ii=0;ii<viewControllers.length;ii++){viewControllers[ii].initialize(this)}this._callDelegateFunction("allModificationsInitialized");var formattingAreaOffsetLeft=this._getFormattingAreaOffsetLeft();for(var ii=0;ii<viewControllers.length;ii++){this._processModifierViewController(viewControllers[ii]);this._processListenerViewController(viewControllers[ii])}this._updateInsertMoreAreaLeft(formattingAreaOffsetLeft)},addViewControllersAfterReady:function(viewControllers){_.mutate("union",this._viewControllers,viewControllers);_.mutate("union",this._delegates,viewControllers);for(var ii=0;ii<viewControllers.length;ii++){viewControllers[ii].initialize(this)}this._callDelegateFunction("allModificationsInitialized");var formattingAreaOffsetLeft=this._getFormattingAreaOffsetLeft();for(var ii=0;ii<viewControllers.length;ii++){this._processModifierViewController(viewControllers[ii]);this._processListenerViewController(viewControllers[ii])}this._updateInsertMoreAreaLeft(formattingAreaOffsetLeft)},_processModifierViewController:function(modifierViewController){if(!modifierViewController){return}if(!modifierViewController.shouldProcessModification||!modifierViewController.shouldProcessModification()){return}modifierViewController.aboutToProcessModification();switch(modifierViewController.getModificationType()){case"ADD_ELEMENT":this._handleAddElementModifier(modifierViewController);modifierViewController.justAdded();break}},_handleAddElementModifier:function(modifierViewController){switch(modifierViewController.getModificationArea()){case"BOTTOM_TOOLBAR":this._addElementToBottomToolbar(modifierViewController);break;case"BOTTOM":this._addElementToBottom(modifierViewController);break;case"INTERNAL_SIDEBAR":this._addInternalSidebar(modifierViewController);break;case"EXTRA_RECIPIENTS":this._addElementToExtraRecipients(modifierViewController);break;case"RECIPIENTS_OVERLAY":this._addElementAsRecipientsOverlay(modifierViewController);break;case"NEW_RECIPIENT_ROW":this._addElementAsNewRecipientRow(modifierViewController);break;case"EXTERNAL_SIDEBAR":this._addExternalSidebar(modifierViewController);break}},reloadModification:function(modifierViewController){if(!modifierViewController){return}var formattingAreaOffsetLeft=this._getFormattingAreaOffsetLeft();this._undoModification(modifierViewController);this._processModifierViewController(modifierViewController);this._updateInsertMoreAreaLeft(formattingAreaOffsetLeft)},_undoModification:function(modifierViewController){switch(modifierViewController.getModificationType()){case"ADD_ELEMENT":this._handleUndoAddElement(modifierViewController);break}},_handleUndoAddElement:function(modifierViewController){switch(modifierViewController.getModificationArea()){case"BOTTOM":this._detachElementFromBottom(modifierViewController);break;case"BOTTOM_TOOLBAR":this._detachElementFromBottomToolbar(modifierViewController);break;case"INTERNAL_SIDEBAR":this._removeInternalSidebar(modifierViewController);break;case"EXTERNAL_SIDEBAR":this._removeExternalSidebar(modifierViewController);break;case"EXTRA_RECIPIENTS":this._detachElementFromExtraRecipients(modifierViewController);break;case"RECIPIENTS_OVERLAY":this._detachElementAsRecipientsOverlay(modifierViewController);break;case"NEW_RECIPIENT_ROW":this._detachElementAsNewRecipientRow(modifierViewController);break}},_addElementToSendButtonArea:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}this.getSendButton().after(element);this._sendButtonAreaViewControllers.push(modifierViewController)},_addElementToBottom:function(modifierViewController){var element=modifierViewController.getModificationElement();if(element.parents().filter(this._getToolbarArea()[0]).length>0){return}this._getToolbarArea().append(element);if(!modifierViewController.shouldModificationAdjustHeight||!modifierViewController.shouldModificationAdjustHeight()){return}var elementHeight=element.height();var toolbarHeight=this._getToolbarArea().height();this._getToolbarArea().height(toolbarHeight+elementHeight);element.height(elementHeight)},_detachElementFromBottom:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}if(!element.is(":inBody")){return}if(modifierViewController.shouldModificationAdjustHeight&&modifierViewController.shouldModificationAdjustHeight()){var elementHeight=element.height();var toolbarHeight=this._getToolbarArea().height();this._getToolbarArea().height(toolbarHeight-elementHeight)}element.detach()},_addElementToBottomToolbar:function(modifierViewController){switch(modifierViewController.getModificationPlacement()){case"BEFORE_FORMATTING":this._addElementToBottomToolbarBeforeFormatting(modifierViewController);break;case"SEND_BUTTON":this._addElementToSendButtonArea(modifierViewController);break;case"STATUS_AREA":this._addElementToStatusArea(modifierViewController);break}this._resetBottomToolbarTabOrder()},_detachElementFromBottomToolbar:function(modifierViewController){if(modifierViewController.getModificationPlacement()==="STATUS_AREA"){this._detachElementFromStatusArea(modifierViewController);return}var element=modifierViewController.getModificationElement();if(!element){return}var wasInBody=element.is(":inBody");var formattingAreaOffsetLeft=wasInBody&&this._getFormattingAreaOffsetLeft();element.detach();if(wasInBody){this._updateInsertMoreAreaLeft(formattingAreaOffsetLeft);this._toolbarBeforeFormattingViewControllers.removeVal(modifierViewController);this._resetBottomToolbarTabOrder()}},_addElementToExtraRecipients:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}var receipientContainer=this.getExtraRecipientsContainer();receipientContainer.prepend(element)},_detachElementFromExtraRecipients:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}element.detach()},_addInternalSidebar:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}this._addPadding();this._jQueryNode.find(".I5").append(element);var borderColor=this._jQueryNode.find(".aoD").css("border-bottom-color");element.css({borderLeft:"1px solid "+borderColor,borderBottom:"1px solid "+borderColor});this._internalSidebar=modifierViewController;this._resetBottomToolbarTabOrder();this._internalSidebar.getFirstTabFocusElement().focus()},_removeInternalSidebar:function(){if(!this._internalSidebar){return}this._internalSidebar.getModificationElement().remove();this._internalSidebar=null;this._removePadding()},_addExternalSidebar:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}this._externalSidebar=$(document.createElement("div"));this._externalSidebar.addClass("streak__compose_externalSidebar_wrapper");var header=$(document.createElement("div"));header.addClass("streak__compose_externalSidebar_header");this._externalSidebar.append(header);var body=$(document.createElement("div"));body.addClass("streak__compose_externalSidebar_body");this._externalSidebar.append(body);var footer=$(document.createElement("div"));footer.addClass("streak__compose_externalSidebar_footer aDh");this._externalSidebar.append(footer);header.append(modifierViewController.getModificationTitle());body.append(element);this._jQueryNode.append(this._externalSidebar);this._externalSidebarCSSRule=Streak.CSSStyleManipulator.addRule(".aSs > div { width: 50% !important; margin-left: 30%; }",0);if(modifierViewController.getWidth){var width=modifierViewController.getWidth();this._externalSidebar.width(width);this._externalSidebar.css("left",-1*(width+1))}this._externalSidebarViewController=modifierViewController},_removeExternalSidebar:function(modifierViewController){if(!this._externalSidebar||this._externalSidebarViewController!==modifierViewController){return}this._externalSidebar.remove();this._externalSidebarCSSRule.stylesheet.removeRule(this._externalSidebarCSSRule.rule)},_addElementAsRecipientsOverlay:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}this._jQueryNode.find("form > div").first().css({height:modifierViewController.getModificationHeight()});this._jQueryNode.find(".aoD.hl").css({height:modifierViewController.getModificationHeight()});this._jQueryNode.find(".nH .aaZ").append(element)},_detachElementAsRecipientsOverlay:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}this._jQueryNode.find("form > div").first().css("height","");this._jQueryNode.find(".aoD.hl").css("height","");element.detach()},_addElementAsNewRecipientRow:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}var row=$(document.createElement("tr"));var labelTD=$(document.createElement("td"));var contentTD=$(document.createElement("td"));row.append(labelTD);row.append(contentTD);row.addClass("streak__recipientRow");contentTD.append(element);this.getAddressesContainer().find("tbody").append(row)},_detachElementAsNewRecipientRow:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}var row=element.closest("row.streak__recipientRow");element.detach();row.remove()},_resetBottomToolbarTabOrder:function(){var self=this;_.each(this._tabUnbinders,function(tabUnbinder){tabUnbinder()});this._tabUnbinders.length=0;var toolbarBeforeFormattingViewControllers=_.chain(this._toolbarBeforeFormattingViewControllers).filter(function(modifierViewController){return modifierViewController.shouldModifyTabOrder&&modifierViewController.shouldModifyTabOrder()}).sortBy(function(modifierViewController){return modifierViewController.getModificationPriority()}).value();var tabOrderViewControllers=this._sendButtonAreaViewControllers.concat(toolbarBeforeFormattingViewControllers);if(tabOrderViewControllers.length===0){return}_.each(tabOrderViewControllers,function(tabOrderViewController){tabOrderViewController.getModificationElement().attr("tabindex",0)});var firstElement=tabOrderViewControllers[0].getModificationElement();var lastElement=_.last(tabOrderViewControllers).getModificationElement();var sendButton=this.getSendButton();var firstGmailToolbarButton=self._jQueryNode.find(".ZGHj2e.gU [tabindex]").first();function focusAfterStreakButtons(event){if(self._internalSidebar){self._internalSidebar.getFirstTabFocusElement().focus();event.preventDefault();event.stopPropagation()}else if(firstGmailToolbarButton.length){firstGmailToolbarButton.focus();event.preventDefault();event.stopPropagation()}}this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:lastElement,chord:"tab",useCapture:true,noBubble:true,cb:focusAfterStreakButtons}));this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:firstGmailToolbarButton,chord:"shift+tab",useCapture:true,noBubble:true,cb:function(event){if(lastElement.is(":visible")){lastElement.focus();event.preventDefault();event.stopPropagation()}else if(self._toolbarOverflowButton){self._toolbarOverflowButton.getElement().focus();event.preventDefault();event.stopPropagation()}else{throw new Error("should not happen")}}}));var lastSendButtonAreaVC=_.last(self._sendButtonAreaViewControllers);var lastSendButtonAreaButton=lastSendButtonAreaVC&&lastSendButtonAreaVC.getModificationElement();var buttonAfterSendButton=self._sendButtonAreaViewControllers[0]?self._sendButtonAreaViewControllers[0].getModificationElement():this._toolbarOverflowButton?this._toolbarOverflowButton.getElement():firstElement;this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:sendButton,chord:"tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){buttonAfterSendButton.focus();e.preventDefault();e.stopPropagation()}}));this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:buttonAfterSendButton,chord:"shift+tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){sendButton.focus();e.preventDefault();e.stopPropagation()}}));if(this._toolbarOverflowButton&&lastSendButtonAreaButton){this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:lastSendButtonAreaButton,chord:"tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){self._toolbarOverflowButton.getElement().focus();e.preventDefault();e.stopPropagation()}}));this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:this._toolbarOverflowButton.getElement(),chord:"shift+tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){lastSendButtonAreaButton.focus();e.preventDefault();e.stopPropagation()}}))}if(this._toolbarOverflowButton){var firstTBFButton=toolbarBeforeFormattingViewControllers[0].getModificationElement();this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:this._toolbarOverflowButton.getElement(),chord:"tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){if(firstTBFButton.is(":visible")){firstTBFButton.focus();e.preventDefault();e.stopPropagation()}else{focusAfterStreakButtons(e)}}}));this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:firstTBFButton,chord:"shift+tab",noBubble:true,noDefault:true,useCapture:true,cb:function(e){self._toolbarOverflowButton.getElement().focus();e.preventDefault();e.stopPropagation()}}))}if(this._internalSidebar){var focusElement=this._internalSidebar.getLastTabFocusElement();this._tabUnbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:focusElement,chord:"tab",useCapture:true,noBubble:true,cb:function(e){sendButton.focus();e.preventDefault();e.stopPropagation()}}))}},addTextAtCurrentCursorPosition:function(htmlText,plainText){if(!this._elementOfLastFocus){this._elementOfLastFocus="EDITOR"}if(this._elementOfLastFocus==="EDITOR"){this.getEditor().insertHTMLAtCaret(htmlText)}else if(this._elementOfLastFocus==="SUBJECT"){var position=0;if(_.isReal(this._lastSubjectPosition)){position=this._lastSubjectPosition}var subject=this.getSubject();subject=subject.insert(plainText||htmlText,this._lastSubjectPosition);this.setSubject(subject)}this._callDelegateFunction("emailBodyChanged",this.getComposeBodyHTML());this._callDelegateFunction("subjectChanged",this.getSubject())},replaceLastNCharacters:function(numberOfCharacters,replacementText){this.getEditor().deleteText(numberOfCharacters);this.addTextAtCurrentCursorPosition(replacementText)},addElementAtCursorPosition:function(element){Gmail.elements.body.append(element);var caretPosition=this._getCaretPosition();var fontSize=this.getEditor().css("font-size");var topAdjustment=parseInt(fontSize,10)*1.5;element.css({top:caretPosition.top+topAdjustment,left:caretPosition.left,position:"fixed"});this.getEditor().containRelativeElement(element,0,topAdjustment)},notify:function(notificationEventName){this._callDelegateFunction.apply(this,[notificationEventName].concat(_.toArray(arguments).slice(1)))},notifyMinimized:function(){if(this._externalSidebar){this._externalSidebar.hide()}},notifyRestored:function(){if(this._externalSidebar){this._externalSidebar.show()}},setModuleActive:function(moduleName){if(this._activeModules.indexOf(moduleName)>-1){return}this._activeModules.push(moduleName);this.notify("activeModulesChanged",this._activeModules)},setModuleInactive:function(moduleName){if(this._activeModules.indexOf(moduleName)===-1){return
}this._activeModules.removeVal(moduleName);this.notify("activeModulesChanged",this._activeModules)},getActiveModules:function(){return this._activeModules},setModuleStorageValue:function(key,value){this._moduleStorage[key]=value;this.notify("moduleStorageValueChanged",key,value)},getModuleStorageValue:function(key){return this._moduleStorage[key]}});_.extend(GmailComposeWindowViewController.prototype,{setToAddresses:function(addresses){if(typeof addresses==="string"){addresses=[addresses]}this._jQueryNode.find(".vO").html(addresses.join(","))},setSubject:function(newSubject){this.getSubjectInput().val(newSubject);this._getFormField("subjectbox").val(newSubject);this._callDelegateFunction("subjectChanged",this.getSubject())},setEmailBody:function(html){this._getFormField("body").val(html);this.getEditor()[0].innerHTML=html},removeSelectorFromBody:function(selector){this.getEditor().find(selector).remove()},addHTMLToBodyBeforeQuotedText:function(html){if(this._isThereQuotedText()){this._addHTMLBeforeQuotedText(html)}else{this.addHTMLAtEndOfBody(html)}},addHTMLAtEndOfBody:function(html){var bodyText=this.getComposeBodyHTML();bodyText+=html;this.setEmailBody(bodyText)},disableEditing:function(){this.getEditor().attr("contenteditable",false);this.getSubjectInput().attr("disabled",true)},enableEditing:function(){this.getEditor().attr("contenteditable",true);this.getSubjectInput().removeAttr("disabled")},focusSubject:function(){this.getSubjectInput().focus()},_addHTMLBeforeQuotedText:function(html){this.getEditor().find(".gmail_extra").first().before(html)},_isThereQuotedText:function(){return this.getEditor().find(".gmail_extra").length>0}});_.extend(GmailComposeWindowViewController.prototype,{_getFormField:function(fieldName){if(!this._jQueryNode){return null}return this._jQueryNode.find("input[type=hidden][name="+fieldName+"]")},_getFormFieldValue:function(fieldName){var fieldElement=this._getFormField(fieldName);if(fieldElement===null){return null}if(fieldElement.length===0){return""}else if(fieldElement.length===1){return fieldElement.val()}else{var ret=[];for(var i=0;i<fieldElement.length;i++){ret.push($(fieldElement[i]).val())}return ret}},_getFormattingArea:function(){return this._jQueryNode.find(".oc")},_getInsertMoreArea:function(){return this._jQueryNode.find(".eq")},_getToolbarArea:function(){return this._jQueryNode.find(".aDh:not(.streak__compose_externalSidebar_footer)")},_setComposeid:function(){this._composeid=this._getFormFieldValue("composeid")},_getFormattingAreaOffsetLeft:function(){var formattingArea=this._getFormattingArea();if(!formattingArea){return 0}var offset=formattingArea.offset();if(!offset){return 0}return offset.left},_getCaretPosition:function(){var storedRange=this._getCurrentEditorSelectionRange();var node=$(this.getEditor().insertHTMLAtCaret("<span>&nbsp;</span>"));var offset=node.offset();node.remove();this.getEditor().focus();this.getEditor()[0].ownerDocument.getSelection().removeAllRanges();this.getEditor()[0].ownerDocument.getSelection().addRange(storedRange);return offset},_getCurrentEditorSelectionRange:function(){return this.getEditor()[0].ownerDocument.getSelection().getRangeAt(0).cloneRange()}});_.extend(GmailComposeWindowViewController.prototype,{_bindToComposeEvents:function(){this._bindToDraftSaving();this._bindToSendButton();this._bindToDiscardButton();this._bindToEmailSent();this._bindToCloseButton()},_bindToDraftSaving:function(){Streak.NotificationCenter.subscribe({eventName:"draftSaved",filterParameters:{composeid:this.getComposeid()},functionToCall:this._draftSaved,observer:this})},_draftSaved:function(){this._storedDraftId=this.getDraftId();this._callDelegateFunction("draftSaved");this._callDelegateFunction("emailBodyChanged",this.getComposeBodyHTML(),{fromDraftSaving:true})},_bindToSendButton:function(){var self=this;var sendButton=this.getSendButton();if(sendButton.length===0){return}this._addEventListener(sendButton[0],"mousedown",function(e){self._handlePresend(e)},true);this._addEventListener(this._jQueryNode[0],"keydown",function(e){if(e.srcElement!==sendButton[0]){return}if(Streak.jwerty.is("space/enter",e)){self._handlePresend(e)}},true);this._unbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:this._jQueryNode,chord:"ctrl+enter/cmd+enter",useCapture:true,cb:function(e){self._handlePresend(e)}}))},_handlePresend:function(event){this._callDelegateFunction("emailBodyChanged",this.getComposeBodyHTML());var shouldNotSend=false;for(var ii=0;ii<this._viewControllers.length;ii++){if(this._viewControllers[ii]&&this._viewControllers[ii].shouldNotSend){shouldNotSend=shouldNotSend||this._viewControllers[ii].shouldNotSend()}}if(shouldNotSend){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();this._callDelegateFunction("sendCancelled");Streak.BentoBox.Tracker.trackGmail({eventName:"sending rejected"})}else{this._callDelegateFunction("aboutToSend");Streak.BentoBox.Tracker.trackGmail({eventName:"email sending"})}},_bindToEmailSent:function(){Streak.NotificationCenter.subscribe({eventName:"emailSent",filterParameters:{composeid:this.getComposeid()},functionToCall:this._handleEmailSent,observer:this})},_handleEmailSent:function(){this._callDelegateFunction("emailSent")},sentEmailThreadMetaDataFound:function(threadMetaData){this._callDelegateFunction("sentEmailThreadMetaDataFound",threadMetaData)},_bindToDiscard:function(){Streak.NotificationCenter.subscribe({eventName:"emailDiscarded",filterParameters:{composeid:this.getComposeid()},functionToCall:this._handleEmailDiscarded,observer:this})},_handleEmailDiscarded:function(){this._callDelegateFunction("discarded")},_bindToDiscardButton:function(){var self=this;var discardButton=this.getDiscardButton();this._addEventListener(discardButton[0],"mousedown",function(e){self._handlePrediscard(e)},true);this._addEventListener(this._jQueryNode[0],"keydown",function(e){if(e.srcElement!==discardButton[0]){return}if(Streak.jwerty.is("space/enter",e)){self._handlePrediscard(e)}},true)},_handlePrediscard:function(event){var shouldNotDiscard=false;for(var ii=0;ii<this._viewControllers.length;ii++){if(this._viewControllers[ii]&&this._viewControllers[ii].shouldNotDiscard){shouldNotDiscard=shouldNotDiscard||this._viewControllers[ii].shouldNotDiscard()}}if(shouldNotDiscard){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();this._callDelegateFunction("discardCancelled")}else{this._callDelegateFunction("aboutToDiscard")}},_bindToCloseButton:function(){var self=this;this._addEventListener(this.getCloseButton()[0],"mousedown",function(e){self._callDelegateFunction("composeClose")});this._addEventListener(this._jQueryNode[0],"keydown",function(e){if(Streak.jwerty.is("escape",e)){self._callDelegateFunction("composeClose")}})},_addEventListener:function(element,event,handler,capture){if(!element){return}element.addEventListener(event,handler,capture);this._eventListeners.push([element,event,handler,capture])},_removeEventListener:function(eventListenerParameters){eventListenerParameters[0].removeEventListener(eventListenerParameters[1],eventListenerParameters[2],eventListenerParameters[3])}});_.extend(GmailComposeWindowViewController.prototype,{_processListenerViewController:function(viewController){switch(viewController.getListenerType()){case"CHARACTER_SEQUENCE":this._addCharacterSequenceViewController(viewController);break;case"CHORD":this._addChordListenerViewController(viewController);break}},_addCharacterSequenceViewController:function(viewController){this._characterSequenceController.addDataSource(viewController.getCharacterSequenceListener())},_setupKeyboardEvents:function(){this._bindKeyPressEvents();this._setupCharacterSequenceController()},_bindKeyPressEvents:function(){var self=this;if(this.getEditor().length===0){setTimeout(function(){self._bindKeyPressEvents()},100);return}this._addEventListener(this.getEditor()[0],"keydown",function(e){self._callDelegateFunction("keydown",e)},true);this._addEventListener(this.getEditor()[0],"keypress",function(e){self._callDelegateFunction("keypress",e)},true);this._addEventListener(this.getEditor()[0],"keyup",function(e){self._callDelegateFunction("keyup",e)},true);this._addEventListener(this.getEditor()[0],"blur",function(e){setTimeout(function(){if(self.getEditor()&&!self.getEditor().is(":focus")){self._callDelegateFunction("editorBlur")}},100)},true);this._addEventListener(this._jQueryNode[0],"keydown",function(e){if(Streak.jwerty.is("escape",e)){self._callDelegateFunction("escapePressed",e)}self._callDelegateFunction("composeKeydown",e)},true)},_setupCharacterSequenceController:function(){this._characterSequenceController=new Streak.BentoBox.Controllers.CharacterSequenceController;this.addDelegate(this._characterSequenceController)},_addChordListenerViewController:function(listenerViewController){var self=this;var chord=listenerViewController.getListenerChord();this._unbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:this.getEditor(),chord:chord,noBubble:true,noDefault:true,useCapture:true,cb:function(e){if(self._toolbarOverflowButton){self._toolbarOverflowButton.on()}listenerViewController.callListenerCallback()}}))},_bindToEmailContentChanges:function(){var self=this;if(this.getEditor().length===0){setTimeout(function(){self._bindToEmailContentChanges()},100);return}this._addEventListener(this.getSubjectInput()[0],"input",function(e){self._lastSubjectPosition=self.getSubjectInput()[0].selectionEnd;self._callDelegateFunction("subjectChanged",self.getSubject())});var emailBodyChanged=_.debounce(function(){self._callDelegateFunction("emailBodyChanged",self.getComposeBodyHTML())},300,false);this._addEventListener(this.getEditor()[0],"input",emailBodyChanged);this._addEventListener(this.getSubjectInput()[0],"focus",function(e){self._elementOfLastFocus="SUBJECT"});this._addEventListener(this.getEditor()[0],"focus",function(e){self._elementOfLastFocus="EDITOR"});this._bindToAddressChanges()},_bindToAddressChanges:function(){if(!MutationObserver){return}var self=this;var options={childList:true,subtree:true};var observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.addedNodes.length===0&&mutation.removedNodes.length===0){return}for(var ii=0;ii<mutation.addedNodes.length;ii++){var node=mutation.addedNodes[ii];if(node.className==="vR"){self._callDelegateFunction("addressesChanged");return}}for(var ii=0;ii<mutation.removedNodes.length;ii++){var node=mutation.removedNodes[ii];if(node.className==="vR"){self._callDelegateFunction("addressesChanged");return}}})});observer.observe(this.getAddressesContainer()[0],options)}});_.extend(GmailComposeWindowViewController.prototype,{_addPadding:function(){this._jQueryNode.find("form").css("padding-right","200px");this._jQueryNode.find(".GQ").css("padding-right","200px")},_removePadding:function(){this._jQueryNode.find("form").css("padding-right","");this._jQueryNode.find(".GQ").css("padding-right","")},_addElementToBottomToolbarBeforeFormatting:function(modifierViewController){var priority=modifierViewController.getModificationPriority();var element=modifierViewController.getModificationElement();if(!this._additionalAreas.toolbarBeforeFormatting){this._additionalAreas.toolbarBeforeFormatting=this._addAdditionalToolbarArea("beforeFormatting")}var afterElement=null;var largestModificationPriority=-1;var currentModificationPriority;for(var ii=0;ii<this._toolbarBeforeFormattingViewControllers.length;ii++){currentModificationPriority=this._toolbarBeforeFormattingViewControllers[ii].getModificationPriority();if(priority>currentModificationPriority&&currentModificationPriority>largestModificationPriority){afterElement=this._toolbarBeforeFormattingViewControllers[ii].getModificationElement();largestModificationPriority=currentModificationPriority}}if(!afterElement){this._additionalAreas.toolbarBeforeFormatting.prepend(element)}else{afterElement.after(element)}this._additionalToolbarAreaSizeCheck();this._toolbarBeforeFormattingViewControllers.push(modifierViewController)},_addAdditionalToolbarArea:function(placement){var td=$(document.createElement("td"));td[0].setAttribute("class","streakArea gU");this._getFormattingArea().before(td);var separator=document.createElement("td");separator.setAttribute("class","streakComposeSeparator gU");separator.innerHTML='<div class="Uz"></div>';td.after(separator);td.closest("table").find("colgroup col").first().after('<col class="streakAreaColumn"></col><col class="streakComposeSeparatorColumn"></col>');return $("<div/>").appendTo(td)},_additionalToolbarAreaSizeCheck:function(){if(!this._toolbarOverflowButton&&this._additionalAreas.toolbarBeforeFormatting.children().length>MAX_TOOLBAR_BUTTONS_BEFORE_OVERFLOW){var self=this;var $tbf=this._additionalAreas.toolbarBeforeFormatting;this._toolbarOverflowButton=Streak.BentoBox.Widgets.Buttons.ButtonFactory.createToggleButton({type:"GmailIcon",color:"icon",iconClass:"streakOverflowIcon",isBottomAligned:true,isFixedPosition:true,onFunction:function(){$tbf.show();$tbf.find("[tabindex]").first().focus()},offFunction:function(){$tbf.hide()}});this._toolbarOverflowButton.addClass("streakComposeOverflowButton");this._toolbarOverflowButton.setTooltip(Streak.BentoBox.Locale.getString("streak_tools"));this._toolbarOverflowButton.getElement().attr("tabindex",0);$tbf.addClass("streakToolbarOverflow").addClass("streakArea").before(this._toolbarOverflowButton.getElement()).appendTo($tbf.closest("table.aoP").find(".Ur").first()).hide()}},openComposeToolbarOverflow:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){if(self._toolbarOverflowButton){self._toolbarOverflowButton.on()}resolve()})},_updateInsertMoreAreaLeft:function(oldFormattingAreaOffsetLeft){var newFormattingAreaOffsetLeft=this._getFormattingAreaOffsetLeft();var insertMoreAreaLeft=parseInt(this._getInsertMoreArea().css("left"),10);var diff=newFormattingAreaOffsetLeft-oldFormattingAreaOffsetLeft;this._getInsertMoreArea().css("left",insertMoreAreaLeft+diff+"px")},_addElementToStatusArea:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}var statusTextArea=this.getStatusTextArea();statusTextArea.find(".aWR").hide();statusTextArea.find(".wM").css("display","block");var statusText=$('<span class="oG streak__statusText"><span class="streak__statusText_separator">| </span></span>');statusText.append(element);statusTextArea.prepend(statusText);statusTextArea.find(".streak__statusText_separator").hide();this._additionalAreas.statusText=statusText},_detachElementFromStatusArea:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}element.detach();this._additionalAreas.statusText.remove();this._additionalAreas.statusText=null;var statusTextArea=this.getStatusTextArea();statusTextArea.find(".aWR").show();statusTextArea.find(".wM").css("display","")}});Streak.Gmail.GmailComposeWindowViewController=GmailComposeWindowViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailComposeWindowRequester=function(){this._currentCallback=null};_.extend(GmailComposeWindowRequester.prototype,{requestNewComposeWindow:function(callback){this._currentCallback=callback;this._setupComposeListener();this._openNewCompose()},_setupComposeListener:function(){NotificationCenter.subscribe({eventName:"newComposeWindow",functionToCall:this._newComposeWindow,observer:this,unsubscribeImmediately:true})},_openNewCompose:function(){Gmail.getComposeButton().simulateRawClick()},_newComposeWindow:function(functionParameters){if(this._currentCallback){this._currentCallback(functionParameters.composeWindowController)}}});Streak.DependencyManager.addFunction({functionKey:"gmailComposeWindowRequesterInitialized",functionToCall:function(callback){Gmail.GmailComposeWindowRequester=new GmailComposeWindowRequester;if(callback){callback()}},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailComposeManager=function(){this._dataSources=[];this._pendingComposeWindows=[];this._readyToLoad=false;this._setupListener()};_.extend(GmailComposeManager.prototype,{_setupListener:function(){NotificationCenter.subscribe({eventName:"newComposeWindow",functionToCall:this._newComposeWindow,observer:this})},_newComposeWindow:function(notificationParameters){if(!this._readyToLoad){this._pendingComposeWindows.push(notificationParameters);return}var composeWindowController=notificationParameters.composeWindowController;var viewControllers=_.chain(this._dataSources).map(function(dataSource){return dataSource.getViewControllers()}).flatten().compact().value();composeWindowController.addViewControllers(viewControllers)},markReadyToLoad:function(){this._readyToLoad=true;for(var ii=0;ii<this._pendingComposeWindows.length;ii++){this._newComposeWindow(this._pendingComposeWindows[ii])}this._pendingComposeWindows.length=0},registerModifierModule:function(options){if(this._dataSources.indexOf(options)>-1){return}this._dataSources.push(options);var composeWindows=Gmail.GmailComposeWindowMasterController.getComposeWindows();if(composeWindows.length===0){return}var viewControllers=options.getViewControllers();if(!viewControllers||viewControllers.length===0){return}for(var ii=0;ii<composeWindows.length;ii++){if(composeWindows[ii].isReady()){composeWindows[ii].addViewControllers(viewControllers)}else{composeWindows[ii].addViewControllersAfterReady(viewControllers)}}}});Gmail.GmailComposeManager=new GmailComposeManager;Streak.DependencyManager.addFunction({functionKey:"gmailComposeManager.markReadyToLoad",functionReference:Gmail.GmailComposeManager.markReadyToLoad,functionContext:Gmail.GmailComposeManager,dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailEmailBodyManipulator=Streak.Class.subclass({className:"GmailEmailBodyManipulator",superclass:Streak.Object,_memberVariables:[{name:"_manipulations",destroy:true,defaultValue:[]}],registerManipulation:function(manipulation){this._manipulations.push(manipulation);if(!Gmail.isReady()){return}if(Gmail.isConversationVisible()){this._processEmailBodyManipulation(manipulation)}},_initialize:function(){Streak.Object.prototype._initialize.call(this);this._bindToEvents()},_bindToEvents:function(){var self=this;Gmail.observe("conversationThreadLoadedEvent",function(){self._processEmailBodies()});Gmail.observe("conversationMessageStateChanged",function(){self._processEmailBodies()})},_processEmailBodies:function(){var bodies=Gmail.getConversationMessageBodies();for(var ii=0;ii<this._manipulations.length;ii++){this._manipulations[ii].applyBodyManipulation(bodies)}},_processEmailBodyManipulation:function(manipulation){var bodies=Gmail.getConversationMessageBodies();manipulation.applyBodyManipulation(bodies)}});Library.set("Gmail.GmailEmailBodyManipulator",new GmailEmailBodyManipulator)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailEmailBodyManipulation=Streak.Class.subclass({className:"GmailEmailBodyManipulation",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getType:function(){throw new Error("must implement getType")},isElementRelevant:function(element,parsedIdentifier){throw new Error("must implement isElementRelevant")},informRelevantElementFound:function(element,parsedIdentifier){},activate:function(element,parsedIdentifier){}});Library.set("Gmail.GmailEmailBodyManipulation",GmailEmailBodyManipulation)})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Gmail=Streak.Gmail;var GmailReplyAreaMasterController=function(){this._replyAreas=[];this._numberOfReplyAreas=0;this._detectNewReplyAreas();this._detectReplyAreasClosed();this._detectViewChanged()};GmailReplyAreaMasterController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(GmailReplyAreaMasterController.prototype,{_detectNewReplyAreas:function(){var self=this;Gmail.addAnimationWatcher("streakReplyOpen",function(event){self._processNewReplyArea($(event.target))})},_processNewReplyArea:function(replyAreaJQueryElement){if(this._haveWeAlreadySeenThisArea(replyAreaJQueryElement)){return}replyAreaJQueryElement.addClass("streakReplyArea");var replyAreaController=new Gmail.GmailReplyAreaViewController;replyAreaController.setJQueryNode(replyAreaJQueryElement);this._replyAreas.push(replyAreaController);this._numberOfReplyAreas=Gmail.getCurrentMain().find("div.adB").length;Streak.NotificationCenter.postNotification({eventName:"newReplyArea",replyAreaController:replyAreaController,sender:this})},_haveWeAlreadySeenThisArea:function(replyAreaJQueryElement){for(var ii=0;ii<this._replyAreas.length;ii++){if(this._replyAreas[ii].getElement()[0]===replyAreaJQueryElement[0]){return true}}return false},_detectReplyAreasClosed:function(){var self=this;Gmail.addAnimationWatcher("streakReplyClosed",function(event){var newFoundNumber=Gmail.getCurrentMain().find("div.adB").length;if(newFoundNumber===self._numberOfReplyAreas){return}var lostElement=event.target;var currentReplyAreas=self._replyAreas.slice(0);self._replyAreas.length=0;for(var ii=0;ii<currentReplyAreas.length;ii++){if(currentReplyAreas[ii].getElement()[0]===lostElement){currentReplyAreas[ii].destroy();break}else{self._replyAreas.push(currentReplyAreas[ii])}}self._numberOfReplyAreas=newFoundNumber})},_detectViewChanged:function(){for(var ii=0;ii<this._replyAreas.length;ii++){this._replyAreas[ii].destroy()}this._replyAreas.length=0}});Streak.DependencyManager.addFunction({functionKey:"gmailReplyAreaMasterControllerInitialized",functionToCall:function(callback){Gmail.GmailReplyAreaMasterController=new GmailReplyAreaMasterController;if(callback){callback()}},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailReplyAreaViewController=Streak.Class.subclass({className:"GmailReplyAreaViewController",superclass:Gmail.GmailComposeWindowViewController,setJQueryNode:function(jQueryNode){this._jQueryNode=jQueryNode;this._setComposeid();this._bindToComposeEvents();this._setupKeyboardEvents();this._bindToEmailContentChanges();this._bindToStatusChanges()},setSubject:function(){},addTextAtCurrentCursorPosition:function(text){this.getEditor().insertHTMLAtCaret(text);this._callDelegateFunction("emailBodyChanged",this.getComposeBodyHTML())},getSendAndArchiveButton:function(){var siblings=this.getSendButton().siblings();if(siblings.length===0){return}return siblings.first().find("[role=button]")},_bindToSendButton:function(){Gmail.GmailComposeWindowViewController.prototype._bindToSendButton.call(this);var self=this;var sendButton=this.getSendAndArchiveButton();if(!sendButton||sendButton.length===0){return}this._addEventListener(sendButton[0],"mousedown",function(e){self._handlePresend(e)},true);this._addEventListener(this._jQueryNode[0],"keydown",function(e){if(e.srcElement!==sendButton[0]){return}if(Streak.jwerty.is("space/enter",e)){self._handlePresend(e)}},true);this._unbinders.push(Streak.BentoBox.Keyboard.bindChordToEl({el:this._jQueryNode,chord:"ctrl+enter/cmd+enter",useCapture:true,cb:function(e){self._handlePresend(e)}}))},_addElementToBottom:function(modifierViewController){Gmail.GmailComposeWindowViewController.prototype._addElementToBottom.call(this,modifierViewController);var element=modifierViewController.getModificationElement();if(!modifierViewController.shouldModificationAdjustHeight||!modifierViewController.shouldModificationAdjustHeight()){return}this._getToolbarArea().closest("td.HE")[0].style.paddingTop="40px";this._getToolbarArea().closest("td.HE")[0].style.paddingBottom="40px"},_detachElementFromBottom:function(modifierViewController){var element=modifierViewController.getModificationElement();if(!element){return}if(!element.is(":inBody")){return}if(modifierViewController.shouldModificationAdjustHeight&&modifierViewController.shouldModificationAdjustHeight()){this._getToolbarArea().closest("td.HE")[0].style.paddingTop="";this._getToolbarArea().closest("td.HE")[0].style.paddingBottom=""}Gmail.GmailComposeWindowViewController.prototype._detachElementFromBottom.call(this,modifierViewController)},_bindToStatusChanges:function(){var self=this;var extraAttachmentsArea=this._jQueryNode.find(".wM");if(extraAttachmentsArea.length>0){this._unbinders.push(Streak.DomWatcher.notifyAttributeChanged(extraAttachmentsArea[0],"class",function(){if(self._jQueryNode.find(".wM").length){self._extraAttachmentsHide()}else{self._extraAttachmentsShow()}}))}var savingTextContainer=this._jQueryNode.find('.aWQ .oG[id^=":"]');if(savingTextContainer.length>0){this._unbinders.push(Streak.DomWatcher.notifyAttributeChanged(savingTextContainer[0],"class",function(){if(self._jQueryNode.find('.aWQ .oG.aOy[id^=":"]').length){self._savingTextShow()}else{self._savingTextHide()}}))}},_extraAttachmentsShow:function(){if(!this._additionalAreas.statusText){return}this._additionalAreas.statusText.hide()},_extraAttachmentsHide:function(){if(!this._additionalAreas.statusText){return}var self=this;setTimeout(function(){self._additionalAreas.statusText.show()},100)},_savingTextShow:function(){if(!this._additionalAreas.statusText){return}this._additionalAreas.statusText.find(".streak__statusText_separator").show()},_savingTextHide:function(){if(!this._additionalAreas.statusText){return}this._additionalAreas.statusText.find(".streak__statusText_separator").hide()},isReply:function(){return true}});Library.set("Gmail.GmailReplyAreaViewController",GmailReplyAreaViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailReplyManager=function(){this._dataSources=[];this._pendingReplyAreas=[];this._readyToLoad=false;this._setupListener()};_.extend(GmailReplyManager.prototype,{_setupListener:function(){NotificationCenter.subscribe({eventName:"newReplyArea",functionToCall:this._newReplyArea,observer:this})},_newReplyArea:function(notificationParameters){if(!this._readyToLoad){this._pendingReplyAreas.push(notificationParameters);return}var replyAreaController=notificationParameters.replyAreaController;var viewControllers=_.chain(this._dataSources).map(function(dataSource){return dataSource.getViewControllers()}).flatten().compact().value();replyAreaController.addViewControllers(viewControllers)},markReadyToLoad:function(callback){this._readyToLoad=true;for(var ii=0;ii<this._pendingReplyAreas.length;ii++){this._newReplyArea(this._pendingReplyAreas[ii])}this._pendingReplyAreas.length=0;if(callback){callback()}},registerModifierModule:function(options){if(this._dataSources.indexOf(options)>-1){return}this._dataSources.push(options)}});Gmail.GmailReplyManager=new GmailReplyManager;Streak.DependencyManager.addFunction({functionKey:"gmailReplyManager.markReadyToLoad",functionToCall:Gmail.GmailReplyManager.markReadyToLoad,functionContext:Gmail.GmailReplyManager,dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailThreadListViewProvider=Streak.Class.subclass({className:"GmailThreadListViewProvider",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getRelevantRequestParameters:function(){throw new Error("must implement getRelevantRequestParameters")},start:function(pageNumber){throw new Error("temporary error test")},getCrapFormatThreads:function(connection,responseText){return new Streak.RSVP.Promise(function(resolve,reject){throw new Error("must implement getCrapFormatThreads")})},isCustomList:function(){return true}});Library.set("Gmail.GmailThreadListViewProvider",GmailThreadListViewProvider)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Streak.Object;var GmailThreadListViewRegister=Streak.Class.subclass({className:"GmailThreadListViewRegister",superclass:superclass,_memberVariables:[{name:"_providers",destroy:true,defaultValue:[]}],_initialize:function(){superclass.prototype._initialize.call(this)},registerProvider:function(gmailThreadListViewProvider){var urlParameters=this._getUrlParameters(gmailThreadListViewProvider);this._providers.push({urlParameters:urlParameters,gmailThreadListViewProvider:gmailThreadListViewProvider})},isRequestRelevant:function(urlParameters){return!!this._getMatchingProvider(urlParameters)},getAjaxInterceptor:function(urlParameters){var matchingProvider=this._getMatchingProvider(urlParameters);if(!matchingProvider){return}return new Gmail.GmailThreadListViewAjaxInterceptor(new matchingProvider.gmailThreadListViewProvider)},isCustomThreadListView:function(){return Gmail.getMainList()&&(Gmail.getMainList().find("[streakthreadid]").length>0||Gmail.getMainList().find("[streakhiderow]").length>0)},_getUrlParameters:function(gmailThreadListViewProvider){var urlParameters=gmailThreadListViewProvider.prototype.getRelevantRequestParameters();if(!urlParameters){throw new Error("thread list view provider did not give url parameters")}return urlParameters},_getMatchingProvider:function(urlParameters){var matchingProvider=null;var matchingParameters=null;for(var ii=0;ii<this._providers.length;ii++){var currentProvider=this._providers[ii];var currentUrlParameters=currentProvider.urlParameters;if(this._doUrlParametersMatch(currentUrlParameters,urlParameters)){if(this._areParametersMoreSpecific(matchingParameters,currentUrlParameters)){matchingProvider=currentProvider;matchingParameters=currentUrlParameters}}}return matchingProvider},_doUrlParametersMatch:function(providerUrlParameters,urlParameters){for(var key in providerUrlParameters){if(providerUrlParameters[key]!==urlParameters[key]){return false}}return true},_areParametersMoreSpecific:function(originalParameters,overridingParameters){if(!originalParameters){return true}return Object.keys(originalParameters).length<Object.keys(overridingParameters).length}});Streak.Gmail.GmailThreadListViewRegister=new GmailThreadListViewRegister})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Streak.Object;var GmailThreadListViewAjaxInterceptor=Streak.Class.subclass({className:"GmailThreadListViewAjaxInterceptor",superclass:superclass,_memberVariables:[{name:"_gmailThreadListViewProvider",destroy:true}],_initialize:function(gmailThreadListViewProvider,pageNumber){superclass.prototype._initialize.call(this);this._gmailThreadListViewProvider=gmailThreadListViewProvider;
this._gmailThreadListViewProvider.start(pageNumber)},getNewResponseText:function(connection,responseText){var self=this;return this._gmailThreadListViewProvider.getCrapFormatThreads(connection,responseText).catch(function(err){Streak.BentoBox.logError("thread list view provider error",err);return null}).then(function(crapFormatThreads){NotificationCenter.postNotification({eventName:"gmailThreadListGettingThreads",sender:self,isCustomList:self._gmailThreadListViewProvider.isCustomList()});if(crapFormatThreads){return Gmail.ThreadResponseProcessor.replaceThreadsInResponse(responseText,crapFormatThreads)}else{return responseText}}).catch(function(err){Streak.BentoBox.logError("thread list replacement error",err);return responseText})}});Library.set("Gmail.GmailThreadListViewAjaxInterceptor",GmailThreadListViewAjaxInterceptor)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailThreadListViewPolisher=Streak.Class.subclass({className:"GmailThreadListViewPolisher",superclass:Streak.Object,_memberVariables:[{name:"_shouldRenderEmpty",destroy:true},{name:"_emptyElement",destroy:true},{name:"_isGettingThreads",destroy:false,defaultValue:false},{name:"_cssRuleHidingTable",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._createEmptyElement();Gmail.observe("newInboxEmails",this._handleNewInboxEmails.bind(this));Gmail.observe("viewChanged",this._handleViewChanged.bind(this));NotificationCenter.subscribe({eventName:"newThreadDOMRow",functionToCall:this._handleNewThreadDOMRow,observer:this});NotificationCenter.subscribe({eventName:"gmailThreadListGettingThreads",functionToCall:this._handleGettingThreads,observer:this});NotificationCenter.subscribe({eventName:"gmailThreadListGotThreads",functionToCall:this._handleGotThreads,observer:this})},_createEmptyElement:function(){this._emptyElement=$('<div class="ae4 UI streak__recentViews_emptyMessage" gh="tl"><div class="Cp"></div><div><table cellpadding="0" class="cf TB"><colgroup><col class="Cm"><col class="TE"><col></colgroup><tbody><tr class="TD"><td class="TC" colspan="3" style="text-align:center">There are no conversations here.</td></tr></tbody></table></div></div>')},_handleNewThreadDOMRow:function(notification){if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()){return}if(!notification.threadDOMRow){return}if(notification.threadDOMRow.rowNode.find("[streakhiderow]").length>0){notification.threadDOMRow.rowNode.hide()}},_handleNewInboxEmails:function(){if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()){this._showThreadTable();return}this._hideFakeRows();if(this._cssRuleHidingTable){this._cssRuleHidingTable.destroy()}this._cssRuleHidingTable=null;this._isGettingThreads=false;if(this._hasEmptyResults()){this._showEmptyMessage()}else{this._hideEmptyMessage()}},_handleViewChanged:function(){if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()){this._showThreadTable();return}this._hideThreadTable();this._hideFakeRows();this._removeDocsSection();this._removeListNumbersAndPaging();this._removeTrashSection();this._hideMailText();if(this._hasEmptyResults()){this._showEmptyMessage()}else{this._hideEmptyMessage()}this._showThreadTable()},_handleGettingThreads:function(notification){if(!notification.isCustomList){this._isGettingThreads=false;return}this._isGettingThreads=true},_handleGotThreads:function(notification){var isGettingThreads=this._isGettingThreads;this._isGettingThreads=false;if(!notification.isCustomList){this._showThreadTable();return}if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()&&!isGettingThreads){this._showThreadTable();return}this._hideThreadTable(isGettingThreads)},_hideThreadTable:function(isGettingThreads){if(!this._cssRuleHidingTable&&(this._isGettingThreads||isGettingThreads)){this._cssRuleHidingTable=Streak.CSSStyleManipulator.addRule("[role=main] [gh=tl] table {visibility: hidden;}")}},_showThreadTable:function(){if(this._cssRuleHidingTable){this._cssRuleHidingTable.destroy();this._cssRuleHidingTable=null}},_hideFakeRows:function(){if(Gmail.isVerticalSplitPreviewPane()){this._hidePreviewPaneRows()}else{Gmail.getMainList().find("[streakhiderow]").parents("tr").hide()}},_hidePreviewPaneRows:function(){var markerRows=Gmail.getMainList().find("[streakhiderow]").parents("tr");for(var ii=0;ii<markerRows.length;ii++){var markerRow=$(markerRows[ii]);markerRow.hide();markerRow.next().hide();markerRow.next().next().hide()}},_removeDocsSection:function(){Gmail.getMainList().nextAll().remove()},_removeListNumbersAndPaging:function(){Gmail.getCurrentMainContainer().find(".Cr").filterOutInvisible().remove()},_removeTrashSection:function(){Gmail.getMainList().children(".Cp").nextAll().remove()},_hideToolbarButtons:function(){Gmail.$("[gh=mtb]").hide()},_hideMailText:function(){Gmail.$(".Wc").hide()},_hasEmptyResults:function(){return Gmail.getMainList().find("[streakhiderow]").parents("tr").length===Gmail.getMainList().find("tr").length},_showEmptyMessage:function(){Gmail.getListToolbarContainer().removeClass("Qj");Gmail.getMainList().after(this._emptyElement)},_hideEmptyMessage:function(){this._emptyElement.detach()}});Library.set("Gmail.GmailThreadListViewPolisher",new GmailThreadListViewPolisher)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailThreadListViewRefresher=Streak.Class.subclass({className:"GmailThreadListViewRefresher",superclass:Streak.Object,_memberVariables:[{name:"_state",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._bindToEvents()},_bindToEvents:function(){NotificationCenter.subscribe({eventName:"gmailThreadListViewClicked",functionToCall:this._viewClicked,observer:this});NotificationCenter.subscribe({eventName:"gmailThreadListGettingThreads",functionToCall:this._gettingThreads,observer:this});Gmail.observe("viewChanged",this._viewChanged.bind(this))},_viewClicked:function(notification){this._state="viewClicked";if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()){return}if(location.hash.indexOf(notification.url)===-1){return}Gmail.triggerListRefresh();NotificationCenter.postNotification({eventName:"gmailThreadListViewRefreshing",sender:this})},_gettingThreads:function(){this._state=null},_viewChanged:function(){if(!Gmail.GmailThreadListViewRegister.isCustomThreadListView()){return}if(this._state!=="viewClicked"){return}Gmail.triggerListRefresh();NotificationCenter.postNotification({eventName:"gmailThreadListViewRefreshing",sender:this})}});Library.set("Gmail.GmailThreadListViewRefresher",new GmailThreadListViewRefresher)})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var GmailConversationGeometryModel=function(options){this._messageBlocks=[];this._generateBlockArray()};GmailConversationGeometryModel.BLOCK_TYPES={COLLAPSED:"COLLAPSED",CONDENSED:"CONDENSED",EXPANDED:"EXPANDED"};_.extend(GmailConversationGeometryModel.prototype,{_generateBlockArray:function(){var rowEls=this._getRowEls();if(rowEls.length===0){return}this._containerTop=rowEls[0].closest("td").offset().top;var condensedArray=[];for(var ii=0;ii<rowEls.length+1;ii++){var rowEl=rowEls[ii];if(rowEl){if(rowEl.is(CONSTANTS.BLOCK_DIV_CLASSES.CONDENSED)){condensedArray.push(rowEl)}else{if(condensedArray.length>0){this._messageBlocks.push(this._generateRowInfo(condensedArray,GmailConversationGeometryModel.BLOCK_TYPES.CONDENSED));condensedArray.length=0}if(rowEl.is(CONSTANTS.BLOCK_DIV_CLASSES.COLLAPSED)){this._messageBlocks.push(this._generateRowInfo(rowEl,GmailConversationGeometryModel.BLOCK_TYPES.COLLAPSED))}else if(rowEl.is(CONSTANTS.BLOCK_DIV_CLASSES.EXPANDED)){this._messageBlocks.push(this._generateRowInfo(rowEl,GmailConversationGeometryModel.BLOCK_TYPES.EXPANDED))}}}else{if(condensedArray.length>0){this._messageBlocks.push(this._generateRowInfo(condensedArray,GmailConversationGeometryModel.BLOCK_TYPES.CONDENSED))}}}},_getRowEls:function(){var innerBlockDivs=Gmail.getCurrentMain().find(".Bk");var parentBlocks=[];for(var ii=0;ii<innerBlockDivs.length;ii++){parentBlocks.push($(innerBlockDivs[ii]).parent())}return parentBlocks},_generateRowInfo:function(rowEl,type){var self=this;var block={};block.el=rowEl;block.type=type;if(type===GmailConversationGeometryModel.BLOCK_TYPES.CONDENSED){block.geometry=self._calculateCondensedRowGeometry(rowEl)}else{block.geometry=self._calculateRowGeometry(rowEl);block.sender=self._extractSender(rowEl);block.body=self._extractMessageBody(rowEl)}return block},_calculateRowGeometry:function(rowEl){var geometry={};geometry.width=rowEl.width();geometry.height=rowEl.find(".ads").filterOutInvisible().outerHeight();geometry.top=rowEl.offset().top-this._containerTop;geometry.left=rowEl.offset().left;geometry.middle=geometry.top+geometry.height/2;geometry.bottom=geometry.top+geometry.height;return geometry},_calculateCondensedRowGeometry:function(rowEls){var geometry={};var firstEl=rowEls[0];var lastEl=_.last(rowEls);geometry.top=firstEl.offset().top-this._containerTop;geometry.bottom=lastEl.offset().top+lastEl.outerHeight()-this._containerTop;geometry.left=firstEl.offset().left;geometry.width=firstEl.width();geometry.height=geometry.bottom-geometry.top;geometry.middle=geometry.top+geometry.height/2;return geometry},_extractSender:function(rowEl){var self=this;var senderEl=rowEl.find(".gF.gK span");var email=senderEl.attr("email");var name=senderEl.attr("name");return{email:email.toLowerCase(),name:name}},_extractMessageBody:function(rowEl){return rowEl.find(".adP")},getMessageBlocks:function(){return this._messageBlocks},dsfsfdsfs13212fs:function(){}});var CONSTANTS={BLOCK_DIV_CLASSES:{COLLAPSED:".kv",CONDENSED:".kx, .kQ",EXPANDED:".h7"}};Gmail.GmailConversationGeometryModel=GmailConversationGeometryModel})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var GmailConversationWatchController=function(){var self=this;if(!self.initialized){self.initialized=true;self._delegates=[];self._convoStateChangeBindId=Math.random();Gmail.observe("conversationMessageStateChanged",function(){self._callDelegatesForGmailMessagesChange()},self._convoStateChangeBindId)}};_.extend(GmailConversationWatchController.prototype,{addDelegate:function(delegate){this._delegates.push(delegate)},processConversation:function(){this._callDelegatesForGmailMessagesChange()},_callDelegatesForGmailMessagesChange:function(){var self=this;var gmailMessagesModel=new Gmail.GmailConversationGeometryModel;_.each(self._delegates,function(delegate){if(_.isReal(delegate.gmailThreadRowsChanged)){delegate.gmailThreadRowsChanged(gmailMessagesModel)}})},destroy:function(){Gmail.unobserve("conversationMessageStateChanged",this._convoStateChangeBindId);this._delegates.length=0;this._delegates=null}});Gmail.GmailConversationWatchController=GmailConversationWatchController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Template=Streak.Template,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CONSTANTS={SETTINGS_PATH:"leftLink/labelToggleState/",TRACKED_KEY:"label:all before:5000/01/01",URL_KEY:"label%3Aall+before%3A5000%2F01%2F01",SEARCH_URL:"label%3Aall+before%3A5000%2F01%2F01",SEARCH_REPLACEMENT:"is:recentlyviewed",GMAIL_SELECTED_CLASS:"ain",GMAIL_SELECTED_INNER_CLASS:"nZ aiq",GMAIL_HOVER_CLASS:"NQ",EXPANDO_POINT_DOWN_CLASS:"aih",EXPANDO_POINT_RIGHT_CLASS:"aii",EXPANDO_HOVER_CLASS:"aij",MANIPULATIONS:{LINK_MANIPULATION:"LINK_MANIPULATION"}};var labelToFunctionMap={sent:"getSentMailLink",inbox:"getInboxLink"};var GmailLeftNavManipulator=Streak.Class.subclass({className:"GmailLeftNavManipulator",superclass:Streak.Object,_memberVariables:[{name:"_manipulations",destroy:true,defaultValue:[]},{name:"_labelToLinkMap",destroy:true,defaultValue:{}},{name:"_labelToToggleButtonMap",destroy:true,defaultValue:{}},{name:"_linkTemplate",destroy:true},{name:"_expandoTemplate",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._linkTemplate=Template.underscore("core/gmail/gmailLeftNav/link");this._expandoTemplateString='<div class="TH J-J5-Ji expando streak__leftNav_expando aih" role="link" tabindex="0"></div>';Gmail.observe("viewChanged",_.bind(this._handleViewChanged,this))},addNewLink:function(linkManipulation){var relativeLabel=linkManipulation.getNavRelativeLabel();if(!this._isLabelValid(relativeLabel)){return}var link=this._createNewLink(linkManipulation);var relativeLabelLink=this._getLabelLink(relativeLabel);var location=linkManipulation.getNavRelativeLocation();this._addNewLinkToNav(link,relativeLabelLink,relativeLabel,location,linkManipulation.shouldPrepend);this._manipulations.push({manipulation:linkManipulation,type:CONSTANTS.MANIPULATIONS.LINK_MANIPULATION,link:link,relativeLabel:relativeLabel,relativeLabelLink:relativeLabelLink,location:location})},_handleViewChanged:function(){for(var ii=0;ii<this._manipulations.length;ii++){var manipulationWrapper=this._manipulations[ii];if(manipulationWrapper.type!==CONSTANTS.MANIPULATIONS.LINK_MANIPULATION){continue}var link=manipulationWrapper.link;if(this._isCurrentUrlIsRelevantToManipulation(manipulationWrapper)){link.addClass(CONSTANTS.GMAIL_SELECTED_CLASS);link.find(".TO").addClass(CONSTANTS.GMAIL_SELECTED_INNER_CLASS)}else{link.removeClass(CONSTANTS.GMAIL_SELECTED_CLASS);link.find(".TO").removeClass(CONSTANTS.GMAIL_SELECTED_INNER_CLASS)}}},_isCurrentUrlIsRelevantToManipulation:function(manipulationWrapper){if(!manipulationWrapper.manipulation.getUrl||!manipulationWrapper.manipulation.getUrl()){return false}return location.hash.indexOf(manipulationWrapper.manipulation.getUrl())>-1},_isLabelValid:function(label){var link=Gmail[labelToFunctionMap[label]]();if(!link||link.length===0){return false}return true},_createNewLink:function(linkManipulation){var self=this;var link=$(this._linkTemplate({text:linkManipulation.getNavLinkName()}));link[0].addEventListener("click",function(e){e.preventDefault();e.stopPropagation();Streak.NotificationCenter.postNotification({eventName:"gmailThreadListViewClicked",sender:self,url:linkManipulation.getUrl()});Gmail.setURL(linkManipulation.getUrl());if(linkManipulation.linkClickedFunction){linkManipulation.linkClickedFunction()}},true);if(linkManipulation.getClass){link.addClass(linkManipulation.getClass())}link.find(".TO").easyHoverClass(CONSTANTS.GMAIL_HOVER_CLASS);return link},_addNewLinkToNav:function(link,relativeLabelLink,relativeLabel,location,shouldPrepend){relativeLabelLink.addClass("streak__leftNav_gmailLink");switch(location){case"BEFORE":relativeLabelLink.prepend(link);link.addClass("streak__leftNavLink_mainList");break;case"AFTER":relativeLabelLink.append(link);link.addClass("streak__leftNavLink_mainList");break;case"NESTED":this._nestNewLink(link,relativeLabelLink,relativeLabel,shouldPrepend);this._updateNestedLabelVisibility(relativeLabelLink,relativeLabel);break}},_getLabelLink:function(relativeLabel){if(!this._labelToLinkMap[relativeLabel]){this._labelToLinkMap[relativeLabel]=Gmail[labelToFunctionMap[relativeLabel]]()}return this._labelToLinkMap[relativeLabel]},_nestNewLink:function(link,relativeLabelLink,relativeLabel,shouldPrepend){if(!this._labelToToggleButtonMap[relativeLabel]){this._setupLabelWithToggleButton(relativeLabelLink,relativeLabel);relativeLabelLink.addClass("streak__leftNav_"+relativeLabel+"Nested")}if(shouldPrepend&&relativeLabelLink.find(".streak__leftNavLink_nested").length>0){relativeLabelLink.find(".streak__leftNavLink_nested").first().before(link)}else{if(relativeLabelLink.find(".streak__leftNavLink_nested").length>0){relativeLabelLink.find(".streak__leftNavLink_nested").last().after(link)}else{relativeLabelLink.append(link)}}link.addClass("streak__leftNavLink_nested")},_setupLabelWithToggleButton:function(relativeLabelLink,relativeLabel){var expando=$(this._expandoTemplateString);expando.addClass("streak__leftNav_"+relativeLabel+"Expando");var self=this;expando[0].addEventListener("click",function(e){self._toggleLinkVisibilityStatus(relativeLabelLink,expando,relativeLabel);e.preventDefault();e.stopPropagation()},true);expando.easyHoverClass(CONSTANTS.EXPANDO_HOVER_CLASS);relativeLabelLink.find("> .TO > .TN").prepend(expando);this._labelToToggleButtonMap[relativeLabel]=expando},_toggleLinkVisibilityStatus:function(relativeLabelLink,expando,relativeLabel){var currentStatus=this._getCurrentExpandoStatus(relativeLabel);var newStatus=!currentStatus;Streak.BentoBox.LocalSettings.set(CONSTANTS.SETTINGS_PATH+relativeLabel,newStatus);Streak.BentoBox.LocalSettings.save();this._updateNestedLabelVisibility(relativeLabelLink,relativeLabel)},_getCurrentExpandoStatus:function(relativeLabel){return Streak.BentoBox.LocalSettings.get(CONSTANTS.SETTINGS_PATH+relativeLabel)},_updateNestedLabelVisibility:function(relativeLabelLink,relativeLabel){var status=this._getCurrentExpandoStatus(relativeLabel);var expando=this._labelToToggleButtonMap[relativeLabel];if(status===true){expando.addClass(CONSTANTS.EXPANDO_POINT_DOWN_CLASS);expando.removeClass(CONSTANTS.EXPANDO_POINT_RIGHT_CLASS);relativeLabelLink.find(".streak__leftNavLink_nested").show()}else{expando.removeClass(CONSTANTS.EXPANDO_POINT_DOWN_CLASS);expando.addClass(CONSTANTS.EXPANDO_POINT_RIGHT_CLASS);relativeLabelLink.find(".streak__leftNavLink_nested").hide()}}});Library.set("Gmail.GmailLeftNavManipulator",new GmailLeftNavManipulator)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailLeftNavManipulation=Streak.Class.subclass({className:"GmailLeftNavManipulation",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getUrl:function(){throw new Error("must define getUrl")},getNavRelativeLabel:function(){throw new Error("must define getNavRelativeLabel")},getNavRelativeLocation:function(){throw new Error("must define getNavRelativeLocation")},getNavLinkName:function(){throw new Error("must define getNavLinkName")},getClass:function(){},linkClickedFunction:function(){}});Library.set("Gmail.GmailLeftNavManipulation",GmailLeftNavManipulation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailSearchBarContentReplacer=Streak.Class.subclass({className:"GmailSearchBarContentReplacer",superclass:Streak.Object,_memberVariables:[{name:"_manipulations",destroy:true,defaultValue:[]}],_initialize:function(){Streak.Object.prototype._initialize.call(this);Gmail.observe("viewChanged",this._handleViewChanged.bind(this));this._bindToSearchEntry()},addManipulation:function(manipulation){this._manipulations.push(manipulation)},_handleViewChanged:function(){var searchInput=Gmail.getSearchInput();var searchValue=searchInput.val();if(searchValue){searchValue=this._applyDisplayManipulations(searchValue);searchInput.val(searchValue)}},_applyDisplayManipulations:function(searchValue){for(var ii=0;ii<this._manipulations.length;ii++){var manipulation=this._manipulations[ii];searchValue=manipulation.applyDisplayManipulation(searchValue)}return searchValue},_bindToSearchEntry:function(){var searchButton=Gmail.getSearchButton();if(!searchButton||searchButton.length===0){return}var self=this;var searchInput=Gmail.getSearchInput();searchButton[0].addEventListener("mousedown",function(e){self._applyValueManipulations()},true);searchButton[0].addEventListener("keydown",function(e){if(!Streak.jwerty.is("space/enter",e)){return}self._applyValueManipulations()},true);searchInput[0].addEventListener("keydown",function(e){if(!Streak.jwerty.is("enter",e)){return}self._applyValueManipulations()},true)},_applyValueManipulations:function(){var searchInput=Gmail.getSearchInput();var searchValue=searchInput.val();for(var ii=0;ii<this._manipulations.length;ii++){var manipulation=this._manipulations[ii];searchValue=manipulation.applyValueManipulation(searchValue)}searchInput.val(searchValue)}});Streak.DependencyManager.addFunction({functionKey:"gmailSearchBarContentReplacerInitialized",functionReference:function(){Library.set("Gmail.GmailSearchBarContentReplacer",new GmailSearchBarContentReplacer)},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager;var ThreadResponseProcessor=Streak.Class.subclass({className:"ThreadResponseProcessor",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},extractThreads:function(crapFormatThreadString){var crapFormatThreads=this.deserialize(crapFormatThreadString);return _extractThreadArraysFromResponseArray(crapFormatThreads)},extractMessageIdFromSentEmail:function(responseString){var emailSentArray=this.deserialize(responseString);var messageIdArrayMarker="a";var messageIdArray=_searchArray(emailSentArray,messageIdArrayMarker,_isValidMessageIdMarkerArray);if(!messageIdArray){return null}return messageIdArray[3][0]},extractHexGmailThreadIdFromMessageIdSearch:function(responseString){if(!responseString){return null}var threadResponseArray=this.deserialize(responseString);var threadIdArrayMarker="cs";var threadIdArray=_searchArray(threadResponseArray,threadIdArrayMarker,_isValidEncodedThreadIdMarkerArray);if(!threadIdArray){return}return threadIdArray[1]},rewriteSingleQuotes:function(s){var i=0,result="";while(true){var m=s.substr(i).match(/['"]/);if(!m){result+=s.substr(i);break}result+=s.substr(i,m.index)+'"';i+=m.index+1;if(m[0]=='"'){m=s.substr(i).match(/^([^"\\]|\\.)*"/);if(!m){throw new Error("Unclosed double quote")}result+=s.substr(i,m[0].length);i+=m[0].length}else{m=s.substr(i).match(/^([^'\\]|\\.)*'/);if(!m){throw new Error("Unclosed single quote")}var part=s.substr(i,m[0].length-1).replace(/"/g,'\\"');result+=part+'"';i+=m[0].length}}return result},deserialize:function(threadResponseString){var VIEW_DATA=threadResponseString.substring(threadResponseString.indexOf("["),threadResponseString.lastIndexOf("]")+1);VIEW_DATA=VIEW_DATA.replace(/[\r\n\t]/g,"");VIEW_DATA=this.rewriteSingleQuotes(VIEW_DATA);var in_string=false;VIEW_DATA=VIEW_DATA.replace(/(^|")([^"\\]|\\.)*/g,function(match){if(!in_string){match=match.replace(/\]\d+\[/g,"],[").replace(/,\s*(?=,|\])/g,",null").replace(/\[\s*(?=,)/g,"[null")}in_string=!in_string;return match});VIEW_DATA="["+VIEW_DATA+"]";var vData;try{vData=JSON.parse(VIEW_DATA)}catch(err){throw new Error("deserialization error")}return vData},serialize:function(threadResponseArray,dontIncludeNumbers){if(!threadResponseArray){return""}var response=")]}'\n\n";for(var ii=0;ii<threadResponseArray.length;ii++){var arraySection=threadResponseArray[ii];var arraySectionString=this.serializeArray(arraySection);if(dontIncludeNumbers){response+=arraySectionString;continue}var length=arraySectionString.length+1;response+=length+"\n"+arraySectionString}if(dontIncludeNumbers){var lines=response.split(/\r|\n/);var firstLines=_.initial(lines,3);var lastLines=_.last(lines,3);response=firstLines.join("\n");response+="\n"+lastLines[0]+lastLines[1].replace(/\"/g,"'")}return response},serializeArray:function(array){var isThread=_isThreadArray(array);var response="[";for(var ii=0;ii<array.length;ii++){var item=array[ii];var addition="";if(_.isArray(item)){addition=this.serializeArray(item)}else if(item==null){addition=""}else{addition=JSON.stringify(item);addition=addition.replace(/\</gim,"\\u003c").replace(/\=/gim,"\\u003d").replace(/\>/gim,"\\u003e").replace(/\&/gim,"\\u0026")}if(ii>0){response+=","}response+=addition}response+="]\n";return response},replaceThreadsInResponse:function(originalResponse,threads){var doesResponseUseFormatWithSectionNumbers=_doesResponseUseFormatWithSectionNumbers(originalResponse);var originalResponseArray=this.deserialize(originalResponse);var modifiedResponseArray=_newReplaceThreads(originalResponseArray,threads);var modifiedResponse=this.serialize(modifiedResponseArray,!doesResponseUseFormatWithSectionNumbers);return modifiedResponse},test:function(threadResponseString){var array=this.deserialize(threadResponseString);return this.serialize(array)}});function _newReplaceThreads(originalResponseArray,replacementThreads){var threadsUsed=0;var originalThreads=_extractThreadArraysFromResponseArray(originalResponseArray);var replacementThreadIds={};for(var ii=0;ii<replacementThreads.length;ii++){replacementThreadIds[replacementThreads[ii][0]]=true}var originalThreadToReuse;for(var ii=0;ii<originalThreads.length;ii++){if(!replacementThreadIds[originalThreads[ii][0]]){originalThreadToReuse=_.clone(originalThreads[ii]);originalThreadToReuse[7]=originalThreadToReuse[7].replace("<span",'<span streakhiderow="true"');originalThreadToReuse[7]=originalThreadToReuse[7].replace("<font",'<font streakhiderow="true"');break}}for(var ii=0;ii<originalThreads.length;ii++){var originalThread=originalThreads[ii];if(threadsUsed>=replacementThreads.length){for(var jj=0;jj<originalThreadToReuse.length;jj++){originalThread[jj]=originalThreadToReuse[jj]}continue}var replacementThread=replacementThreads[threadsUsed];for(var jj=0;jj<replacementThread.length;jj++){originalThread[jj]=replacementThread[jj]}threadsUsed++}return originalResponseArray}function _extractThreadArraysFromResponseArray(threadResponseArray){var threads=[];for(var ii=0;ii<threadResponseArray.length;ii++){var arrayElement=threadResponseArray[ii];if(_isThreadArray(arrayElement)){threads.push(arrayElement)}else if(_.isArray(arrayElement)){var newThreadArray=_extractThreadArraysFromResponseArray(arrayElement);if(_.isReal(newThreadArray)){threads=threads.concat(newThreadArray)}}}if(threads.length>0){return threads}}function _isThreadArray(array){return _.isArray(array)&&array.length>=30&&array[0].length===16&&array[1].length===16&&array[2].length===16}function _doesResponseUseFormatWithSectionNumbers(responseString){var lines=responseString.split(/\n|\r/);return!!lines[2].match(/^\d/)}function _searchArray(responseArray,marker,markerArrayValidator){var pathArray=Streak.searchObject(responseArray,marker,100,false,true);if(!pathArray){return}for(var ii=0;pathArray.length;ii++){var pathToMarkerArray=_extractPathToMarkerArray(pathArray[ii]);var markerArray=_getArrayValueFromPath(responseArray,pathToMarkerArray);if(markerArrayValidator(markerArray)){return markerArray}}}function _extractPathToMarkerArray(pathObject){var pathToA=_.rest(pathObject.path.split("/"));return _.initial(pathToA)}function _isValidMessageIdMarkerArray(markerArray){return markerArray.length>3&&_.isArray(markerArray[3])&&markerArray[3].length>0}function _isValidEncodedThreadIdMarkerArray(markerArray){return markerArray.length>20}function _getArrayValueFromPath(responseArray,path){var currentArray=responseArray;for(var ii=0;ii<path.length;ii++){var currentIndex=path[ii];currentArray=currentArray[currentIndex]}return currentArray}Gmail.ThreadResponseProcessor=new ThreadResponseProcessor})(Streak);(function(Streak,window){var _=Streak._;var GmailRequester={flags:{},getSentMail:function(cb,errCb){this.get({view:"tl",start:"0",num:"100",rt:"c",search:"sent"}).getPromise().then(cb,errCb)},getThread:function(encodedThreadId,successCallback,errorCallback){var opts={view:"cv",th:encodedThreadId,rt:"c",pcd:"1",mb:"0",search:"inbox"};this.get(opts).getPromise().then(successCallback,errorCallback)},get:function(params){if(!params){params={}}params.ik=GLOBALS[9];return new Streak.Request("GET",location.origin,location.pathname,{queryParameters:params,responseType:"text"})},getCurrentList:function(successCallback,errorCallback){this.getList(location.hash.substring(1).split("?")[0],Streak.Gmail.getVisibleThreadRows().length).getPromise().then(successCallback,errorCallback)},getList:function(list,num){var parts=list.split("/");if(!num){num=100}var lastPart=_.last(parts);var start=0;if(lastPart.match(/p\d+/)){var currentPage=parseInt(lastPart.replace(/p/,""),10);start=(currentPage-1)*num}var opts={ui:2,view:"tl",start:start,num:num,rt:"c",pcd:"1",mb:"0"};function processAdvancedSearchParameters(prefix){var searchParts=parts[1].split("&");for(var i=0;i<searchParts.length;i++){var subParts=searchParts[i].split("=");opts[prefix+"_"+subParts[0]]=decodeURIComponent(subParts[1])}}if(parts.length>0){if(parts[0]==="label"){opts.search="cat";opts.cat=Streak.Utils.decodeGmailURLSearchString(parts[1])}else if(parts[0]==="search"){opts.search="query";opts.q=Streak.Utils.decodeGmailURLSearchString(parts[1]);opts.qs="true"}else if(parts[0]==="advanced-search"){processAdvancedSearchParameters("as");opts.search="adv"}else if(parts[0]==="create-filter"){processAdvancedSearchParameters("cf1");opts.search="cf"}else{opts.search=parts[0];opts.apps=parts[0];if(parts.length>1){opts.q=Streak.Utils.decodeGmailURLSearchString(parts[1])}}}return this.post(opts)},post:function(params,cb,errCb,id){if(!params){params={}}params.ik=GLOBALS[9];return new Streak.Request("POST",location.origin,location.pathname,{bodyData:params,responseType:"text"})},getContactDetails:function(email){var params={ac:false,cr:true,ct:true,emls:email,ev:true,f:"g2",gp:false,hl:"en",id:"personal",out:"js",type:4};return new Streak.Request("GET",location.origin,"/mail/c/u/0/data/contactstore",{queryParameters:params,responseType:"text"}).getPromise().then(function(res){var cleaned=res.first(res.lastIndexOf("}")).substring(res.indexOf("{"));var parts=cleaned.match(/,\\"(\D+?\s?\w*?)\\"/gim);var resObj={email:email};if(parts&&parts.length>3){resObj.fullName=parts[0].replace(/,\\\"(.*?)\\.*/gim,"$1");resObj.familyName=parts[1].replace(/,\\\"(.*?)\\.*/gim,"$1");resObj.givenName=parts[2].replace(/,\\\"(.*?)\\.*/gim,"$1")}return resObj})}};Streak.Gmail.GmailRequester=GmailRequester})(Streak,window);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,RSVP=Streak.RSVP,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailThreadRequester={getGmailThreadsForRFCMessageIds:function(rfcMessageIds){var messageGroups=_divideMessageIdsIntoGroups(rfcMessageIds||[]);return RSVP.all(_.map(messageGroups,function(group){return _makeGmailSearchRequestForMessageGroup(group)})).then(function(resultGroups){return _flattenThreadResponses(resultGroups)})}};var CONSTANTS={GROUP_SIZE:10};function _divideMessageIdsIntoGroups(rfcMessageIds){var groups=[];var currentGroup;for(var ii=0;ii<rfcMessageIds.length;ii++){if(ii%CONSTANTS.GROUP_SIZE===0){if(currentGroup){groups.push(currentGroup)}currentGroup=[]}currentGroup.push(rfcMessageIds[ii])}if(currentGroup&&currentGroup.length){groups.push(currentGroup)}return groups}function _makeGmailSearchRequestForMessageGroup(messageGroup){var searchString=_createSearchString(messageGroup);return Gmail.GmailRequester.getList(searchString).getPromise().then(function(response){try{var threadArray=Gmail.ThreadResponseProcessor.deserialize(response);return _extractThreads(threadArray)}catch(err){throw new Error(err)
}})}function _createSearchString(rfcMessageIds){var searchString=_.map(rfcMessageIds,function(id){return"rfc822msgid:"+id}).join(" OR ");return"apps/"+encodeURIComponent(searchString)}function _extractThreads(threadArray){if(!_.isArray(threadArray)){return[]}if(threadArray[0]==="tb"){return threadArray[2]}return _.flatten(_.map(_.compact(threadArray),_extractThreads),true)}function _flattenThreadResponses(responses){return _.compact(_.flatten(responses,true))}Gmail.GmailThreadRequester=GmailThreadRequester})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Bacon=Streak.Bacon,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var eventStream=Gmail.getEventStream();Gmail.getSearchEventStream=function(){if(!Gmail.searchEventStream){Gmail.searchEventStream=eventStream.filter(function(event){return event.eventName==="search"}).map(".arguments.0").filter(function(searchTerm){return searchTerm&&searchTerm.indexOf("label:all")===-1})}return Gmail.searchEventStream}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var OperationLimiterRules={};OperationLimiterRules.TYPES={ENTITY_GROUP_WRITE:"ENTITY_GROUP_WRITE",ENTITY_GROUP_READ:"ENTITY_GROUP_READ",BOX_MOVE_PIPELINE:"BOX_MOVE_PIPELINE"};OperationLimiterRules.RULES={};OperationLimiterRules.RULES[OperationLimiterRules.TYPES.ENTITY_GROUP_WRITE]={TIME_BETWEEN_REQUESTS:1*1e3};OperationLimiterRules.RULES[OperationLimiterRules.TYPES.ENTITY_GROUP_READ]=null;OperationLimiterRules.RULES[OperationLimiterRules.TYPES.BOX_MOVE_PIPELINE]={TIME_BETWEEN_REQUESTS:2*1e3};Library.set("Operations.OperationLimiterRules",OperationLimiterRules)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var OperationQueue=Streak.Class.subclass({className:"OperationQueue",superclass:Streak.Object,_memberVariables:[{name:"_operationQueue",destroy:true,defaultValue:[]},{name:"_operationMetaDataMap",destroy:true,defaultValue:{}},{name:"_debug_isLogging",destroy:true,set:true,defaultValue:false},{name:"_debug_dontStartOperationsAutomatically",destroy:true,set:true,defaultValue:false},{name:"_mapOfOperationLimiterTagsAndTypesToStats",destroy:true,defaultValue:{}},{name:"_pendingOperationsCheckTimeout",destroy:true},{name:"_operationCount",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._operationCount=0},addOperation:function(operation,operationStatusChangeHandler,operationProgressId){if(!(operation instanceof Streak.Operations.Operation)){throw new Error("must pass in an operation")}if(operationStatusChangeHandler&&!(operationStatusChangeHandler instanceof Streak.Operations.OperationStatusChangeHandler)){throw new Error("operationStatusChangeHandler is not valid")}if(this._debug_isLogging){console.debug("add operation: ",operation)}operationProgressId=operationProgressId||Streak.guid();this._addOperationToQueue(operation,operationStatusChangeHandler,operationProgressId);if(this._debug_dontStartOperationsAutomatically){return}this._runOperationIfPossible(operation);return operationProgressId},addMultipleOperations:function(operations,operationStatusChangeHandler){var operationProgressId=Streak.guid();for(var ii=0;ii<operations.length;ii++){this._addOperationToQueue(operations[ii],operationStatusChangeHandler,operationProgressId)}if(this._debug_dontStartOperationsAutomatically){return}for(var ii=0;ii<operations.length;ii++){this._runOperationIfPossible(operations[ii])}return operationProgressId},getOperationProgressId:function(operation){return this._operationMetaDataMap[operation.getId()].operationProgressId},_addOperationToQueue:function(operation,operationStatusChangeHandler,operationProgressId){operation.setState(Streak.Operations.Operation.STATES.NOT_STARTED);this._operationMetaDataMap[operation.getId()]={timestamp:Date.now(),operationCount:this._operationCount,operationStatusChangeHandler:operationStatusChangeHandler,operationProgressId:operationProgressId};this._operationQueue.push(operation);this._operationCount++},_debug_runNextOperation:function(){var operations=this._queryOperationQueue({states:[Streak.Operations.Operation.STATES.NOT_STARTED]});if(operations.length===0){return}this._runOperationIfPossible(operations[0])},_runOperationIfPossible:function(operation){if(this._areOperationDependenciesSatisfied(operation)){this._changeOperationState(operation,Streak.Operations.Operation.STATES.PENDING);this._runPendingOperations()}},_areOperationDependenciesSatisfied:function(operation){var dependentOnTags=operation.getDependentOnTags();if(!dependentOnTags||dependentOnTags.length===0){return true}var operations=this._queryOperationQueue({states:[Streak.Operations.Operation.STATES.NOT_STARTED,Streak.Operations.Operation.STATES.PENDING,Streak.Operations.Operation.STATES.RUNNING],containsTags:dependentOnTags,beforeOperation:operation});return operations.length===0},_runPendingOperations:function(){clearTimeout(this._pendingOperationsCheckTimeout);var pendingOperations=this._queryOperationQueue({states:[Streak.Operations.Operation.STATES.PENDING]});var operationsUnableToRun=[];for(var ii=0;ii<pendingOperations.length;ii++){var operation=pendingOperations[ii];if(this._isOperationNotBlockedOnRateLimit(operation)){this._startOperation(operation)}else{operationsUnableToRun.push(operation)}}if(operationsUnableToRun.length===0){return}var soonestTime=this._getSoonestPendingOperationTime(operationsUnableToRun);this._scheduleRunPendingOperations(soonestTime)},_isOperationNotBlockedOnRateLimit:function(operation){var limiterTagsAndTypes=operation.getLimiterTagsAndTypes();if(!limiterTagsAndTypes||limiterTagsAndTypes.length===0){return true}var ableToRun=true;for(var ii=0;ii<limiterTagsAndTypes.length;ii++){ableToRun=ableToRun&&!this._isLimiterTagAndTypeBlocking(limiterTagsAndTypes[ii])}return ableToRun},_isLimiterTagAndTypeBlocking:function(limiterTagAndType){if(!this._mapOfOperationLimiterTagsAndTypesToStats[limiterTagAndType.type]){return false}var tagToStatsMap=this._mapOfOperationLimiterTagsAndTypesToStats[limiterTagAndType.type];if(!tagToStatsMap[limiterTagAndType.tag]){return false}var limiterStats=tagToStatsMap[limiterTagAndType.tag];if(this._isOperationRunningFor(limiterStats)){return true}var rule=Streak.Operations.OperationLimiterRules.RULES[limiterTagAndType.type];return this._doesOperationFailRule(limiterStats.lastOperationStartTime,limiterStats.lastOperationEndTime,rule)},_isOperationRunningFor:function(limiterStats){if(!limiterStats.lastOperationStartTime){return false}if(!limiterStats.lastOperationEndTime){return true}return limiterStats.lastOperationStartTime>limiterStats.lastOperationEndTime},_doesOperationFailRule:function(lastOperationStartTime,lastOperationEndTime,rule){if(!rule||!rule.TIME_BETWEEN_REQUESTS){return false}var timeBetweenRequest=rule.TIME_BETWEEN_REQUESTS;var timeBetweenLastRequestAndNow=Date.now()-lastOperationEndTime;return timeBetweenLastRequestAndNow<rule.TIME_BETWEEN_REQUESTS},_startOperation:function(operation){this._updateMapOfOperationLimiterTagsAndTypes(operation,"lastOperationStartTime");this._changeOperationState(operation,Streak.Operations.Operation.STATES.RUNNING);try{operation.doOperation(this._operationSucceeded.bind(this,operation),this._operationFailed.bind(this,operation))}catch(err){this._operationFailed(operation);Streak.BentoBox.logError("Error doing operation",err)}},_updateMapOfOperationLimiterTagsAndTypes:function(operation,statToUpdate){var limiterTagsAndTypes=operation.getLimiterTagsAndTypes();if(!limiterTagsAndTypes||limiterTagsAndTypes.length===0){return}for(var ii=0;ii<limiterTagsAndTypes.length;ii++){var tagAndType=limiterTagsAndTypes[ii];if(!this._mapOfOperationLimiterTagsAndTypesToStats[tagAndType.type]){this._mapOfOperationLimiterTagsAndTypesToStats[tagAndType.type]={}}var tagToStatsMap=this._mapOfOperationLimiterTagsAndTypesToStats[tagAndType.type];if(!tagToStatsMap[tagAndType.tag]){tagToStatsMap[tagAndType.tag]={}}tagToStatsMap[tagAndType.tag][statToUpdate]=Date.now()}},_getSoonestPendingOperationTime:function(pendingOperations){if(!pendingOperations||pendingOperations.length===0){return}var soonestTime=Infinity;for(var ii=0;ii<pendingOperations.length;ii++){var operationSoonestTime=this._getSoonestRateLimitedTimeToRun(pendingOperations[ii]);if(soonestTime>operationSoonestTime){soonestTime=operationSoonestTime}}},_scheduleRunPendingOperations:function(time){this._pendingOperationsCheckTimeout=setTimeout(this._runPendingOperations.bind(this),time)},_getSoonestRateLimitedTimeToRun:function(operation){var limiterTagsAndTypes=operation.getLimiterTagsAndTypes();if(!limiterTagsAndTypes||limiterTagsAndTypes.length===0){return 0}var miniumTimeBetweenRequests=Infinity;for(var ii=0;ii<limiterTagsAndTypes.length;ii++){var limiterTagAndType=limiterTagsAndTypes[ii];var rule=Streak.Operations.OperationLimiterRules.RULES[limiterTagAndType.type];if(!rule.TIME_BETWEEN_REQUESTS){continue}if(rule.TIME_BETWEEN_REQUESTS<miniumTimeBetweenRequests){miniumTimeBetweenRequests=rule.TIME_BETWEEN_REQUESTS}}return miniumTimeBetweenRequests},_operationSucceeded:function(operation){this._changeOperationState(operation,Streak.Operations.Operation.STATES.SUCCEEDED);this._finalizeOperation(operation)},_operationFailed:function(operation){this._changeOperationState(operation,Streak.Operations.Operation.STATES.FAILED);this._finalizeOperation(operation)},_changeOperationState:function(operation,state){if(this._debug_isLogging){console.debug("change operation state. state:",state,"operation:",operation)}operation.setState(state);if(this._operationMetaDataMap[operation.getId()].operationStatusChangeHandler){try{this._operationMetaDataMap[operation.getId()].operationStatusChangeHandler.operationStateChanged(operation)}catch(err){Streak.BentoBox.logError("Error changing operation state",err)}}},_finalizeOperation:function(operation){this._updateMapOfOperationLimiterTagsAndTypes(operation,"lastOperationEndTime");this._sendNotificationOfOperationCompletion(operation);this._checkAndRunOperationsDependentOn(operation);this._pruneOperationQueue()},_checkAndRunOperationsDependentOn:function(operation){var tags=operation.getTags();if(!tags||tags.length===0){return}var operations=this._queryOperationQueue({states:[Streak.Operations.Operation.STATES.NOT_STARTED],containsDependentOnTags:tags});var self=this;_.chain(operations).filter(function(operation){return self._areOperationDependenciesSatisfied(operation)}).each(function(operation){self._changeOperationState(operation,Streak.Operations.Operation.STATES.PENDING)});this._runPendingOperations()},queryOperationQueue:function(options){return this._queryOperationQueue(options)},_queryOperationQueue:function(options){var afterTimestamp=options.afterTimestamp||-Infinity;var beforeTimestamp=options.beforeTimestamp||Infinity;var afterOperationCount=-Infinity;var beforeOperationCount=Infinity;if(options.afterOperation){afterOperationCount=this._operationMetaDataMap[options.afterOperation.getId()].operationCount}if(options.beforeOperation){beforeOperationCount=this._operationMetaDataMap[options.beforeOperation.getId()].operationCount}var returnValue=[];for(var ii=0;ii<this._operationQueue.length;ii++){var operation=this._operationQueue[ii];if(!operation){continue}var operationMetaData=this._operationMetaDataMap[operation.getId()];if(!operationMetaData){continue}var timestamp=operationMetaData.timestamp;if(timestamp<=afterTimestamp||timestamp>=beforeTimestamp){continue}var operationCount=operationMetaData.operationCount;if(operationCount<=afterOperationCount||operationCount>=beforeOperationCount){continue}if(options.states&&options.states.length>0){if(options.states.indexOf(operation.getState())===-1){continue}}if(options.notStates&&options.notStates.length>0){if(options.notStates.indexOf(operation.getState())!==-1){continue}}if(options.containsTags&&options.containsTags.length>0){if(!_.doArraysIntersect(operation.getTags(),options.containsTags)){continue}}if(options.containsDependentOnTags&&options.containsDependentOnTags.length>0){if(!_.doArraysIntersect(operation.getDependentOnTags(),options.containsDependentOnTags)){continue}}if(options.operationProgressId&&this._operationMetaDataMap[operation.getId()].operationProgressId!==options.operationProgressId){continue}if(options.notOperationId&&options.notOperationId===operation.getId()){continue}returnValue.push(operation)}return returnValue},_pruneOperationQueue:function(){if(this._operationQueue.length<20){return}var newStartIndex=0;var progressIdMap={};for(var ii=0;ii<this._operationQueue.length;ii++){var operation=this._operationQueue[ii];if(operation.getState()!==Streak.Operations.Operation.STATES.SUCCEEDED&&operation.getState()!==Streak.Operations.Operation.STATES.FAILED){return}}for(var ii=0;ii<this._operationQueue.length;ii++){try{this._operationQueue[ii].destroy()}catch(err){}}this._operationMetaDataMap={};this._operationQueue=[]},_sendNotificationOfOperationCompletion:function(operation){var operationProgressId=this._operationMetaDataMap[operation.getId()].operationProgressId;var operations=this._queryOperationQueue({operationProgressId:operationProgressId});var operationProgressStats=this._calculateOperationProgressStats(operations);NotificationCenter.postNotification({eventName:"operationProgressUpdate",operation:operation,operationProgressId:operationProgressId,operationProgressStats:operationProgressStats,operationIsComplete:operationProgressStats.total===operationProgressStats.succeeded+operationProgressStats.failed,operationHasErrors:operationProgressStats.failed>0,sender:this})},_calculateOperationProgressStats:function(operations){var stats={total:0,succeeded:0,failed:0};for(var ii=0;ii<operations.length;ii++){var operation=operations[ii];var state=operation.getState();switch(state){case Streak.Operations.Operation.STATES.SUCCEEDED:stats.succeeded+=1;break;case Streak.Operations.Operation.STATES.FAILED:stats.failed+=1;break}stats.total+=1}stats.isFinished=stats.total===stats.succeeded+stats.failed;return stats}});var operationQueue=new OperationQueue;Library.set("Operations.OperationQueue",OperationQueue);Library.set("Operations.OperationQueue.Singleton",operationQueue)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var Operation=Streak.Class.subclass({className:"Operation",superclass:Streak.Object,_memberVariables:[{name:"_id",destroy:true,get:true},{name:"_state",destroy:true,get:true,set:true},{name:"_isCanceled",destroy:true,defaultValue:false},{name:"_tags",destroy:true,get:true,set:true},{name:"_dependentOnTags",destroy:true,get:true,set:true},{name:"_limiterTagsAndTypes",destroy:true,get:true},{name:"_followUpOperation",destroy:false,get:true,set:true}],_initialize:function(options){Streak.Object.prototype._initialize.call(this);this._id=Streak.guid();if(options){this._tags=options.tags;this._dependentOnTags=options.dependentOnTags}},doOperation:function(callback,failureCallback){if(this._isCanceled){failureCallback();return}throw new Error("must define doOperation")},cancel:function(){this._isCanceled=true}});Operation.STATES={NOT_STARTED:"NOT_STARTED",PENDING:"PENDING",RUNNING:"RUNNING",SUCCEEDED:"SUCCEEDED",FAILED:"FAILED"};Library.set("Operations.Operation",Operation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CallbackOperation=Streak.Class.subclass({className:"CallbackOperation",superclass:Streak.Operations.Operation,_memberVariables:[{name:"_callback",destroy:true}],_initialize:function(options){Streak.Operations.Operation.prototype._initialize.call(this,options);this._callback=options.callback},doOperation:function(successCallback,failureCallback){try{this._callback();successCallback()}catch(err){failureCallback()}}});Library.set("Operations.CallbackOperation",CallbackOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var MAX_BACKOFF=32e3;var AjaxRequestOperation=Streak.Class.subclass({className:"AjaxRequestOperation",superclass:Streak.Operations.Operation,_memberVariables:[{name:"_successCallback",destroy:false},{name:"_failureCallback",destroy:false},{name:"_method",destroy:true,set:true,get:true},{name:"_params",destroy:true,set:true,get:true},{name:"_response",destroy:false,get:true},{name:"_xhr",destroy:false,get:true},{name:"_currentBackoff",destroy:true,defaultValue:400}],_initialize:function(options){Streak.Operations.Operation.prototype._initialize.call(this,options);if(options){this._params=options.params||{};this._method=options.method;if(options.url){this._params.url=options.url}}},doOperation:function(successCallback,failureCallback){this._successCallback=successCallback;this._failureCallback=failureCallback;this._executeAjaxRequest()},_executeAjaxRequest:function(){var parameters=this.getParams();var path=parameters.url;delete parameters.url;APIRequester[this.getMethod().toLowerCase()](path,parameters).getPromise().then(this._handleSuccess.bind(this),this._handleError.bind(this))},_handleSuccess:function(response){this._response=response;this._successCallback(this);delete this._successCallback;delete this._failureCallback},_handleError:function(err){var response=err&&err.response;var xhr=err&&err.xhr;switch(xhr&&xhr.status){case 0:case 500:this._backoffAndExecuteAjaxRequest();return}this._response=response;this._xhr=xhr;this._failureCallback(this);delete this._successCallback;delete this._failureCallback},_backoffAndExecuteAjaxRequest:function(){this._currentBackoff=Math.min(this._currentBackoff*2,MAX_BACKOFF);setTimeout(this._executeAjaxRequest.bind(this),this._currentBackoff)}});Library.set("Operations.AjaxRequestOperation",AjaxRequestOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var CONSTANTS={LIMIT:1e3,BRANCH_FACTOR:3};var ListFanoutAjaxRequestOperation=Streak.Class.subclass({className:"ListFanoutAjaxRequestOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_requestStage",destroy:true},{name:"_requestResults",destroy:true}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._requestResults=[]},_executeAjaxRequest:function(){this._requestStage=-1;this._requestNextStage()},_requestNextStage:function(){this._requestStage+=1;var startIndex=this._getResultStartIndex();var endIndex=this._getResultEndIndex();this._requestStage.length=endIndex+1;for(var page=startIndex;page<=endIndex;page++){this._requestListPage(page)}},_getResultStartIndex:function(){var total=0;for(var ii=0;ii<this._requestStage;ii++){total+=Math.pow(CONSTANTS.BRANCH_FACTOR,ii)}return total},_getResultEndIndex:function(){var total=0;for(var ii=0;ii<this._requestStage+1;ii++){total+=Math.pow(CONSTANTS.BRANCH_FACTOR,ii)}return total-1},_requestListPage:function(page){var self=this;var params={limit:CONSTANTS.LIMIT,page:page};params.limit=CONSTANTS.LIMIT;params.page=page;if(this.getParams()){_.extend(params,this.getParams())}var path=params.url;delete params.url;APIRequester[this.getMethod().toLowerCase()](path,params).getPromise().then(function(res){if(res&&res.error){self._requestResults[page]=-1}else{self._requestResults[page]=res}self._verifyResponses()},function(){self._requestResults[page]=-1;self._verifyResponses()})},_verifyResponses:function(){var startIndex=this._getResultStartIndex();var endIndex=this._getResultEndIndex();var hasError=false;var hasEntryLessThanLimit=false;var hasEmptyResultEntry=false;for(var ii=startIndex;ii<=endIndex;ii++){var resultEntry=this._requestResults[ii];if(_.isNotReal(resultEntry)){hasEmptyResultEntry=true;break}if(resultEntry===-1){hasError=true;break}if(resultEntry.length<CONSTANTS.LIMIT){hasEntryLessThanLimit=true}}if(hasEmptyResultEntry){return}if(hasError){this._error();return}if(!hasEntryLessThanLimit){this._requestNextStage();return}this._consolidateResults()},_consolidateResults:function(){var result=[];for(var ii=0;ii<this._requestResults.length;ii++){result=result.concat(this._requestResults[ii])}this._handleSuccess(result)},_error:function(){this._failureCallback(this)}});Library.set("Operations.ListFanoutAjaxRequestOperation",ListFanoutAjaxRequestOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CollectionRequestOperation=Streak.Class.subclass({className:"CollectionRequestOperation",superclass:Streak.Operations.ListFanoutAjaxRequestOperation,_memberVariables:[{name:"_collection",destroy:false,get:true}],_initialize:function(options){Streak.Operations.ListFanoutAjaxRequestOperation.prototype._initialize.call(this,options);this._collection=options.collection},getTags:function(){return this._collection.getRequestTags("REFRESH")},getDependentOnTags:function(){return this._collection.getRequestDependentOnTags("REFRESH")}});Library.set("Operations.CollectionRequestOperation",CollectionRequestOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CollectionRefreshOperation=Streak.Class.subclass({className:"CollectionRefreshOperation",superclass:Streak.Operations.CollectionRequestOperation,_memberVariables:[],_initialize:function(options){Streak.Operations.CollectionRequestOperation.prototype._initialize.call(this,options)},getMethod:function(){return"GET"},getParams:function(){var params={url:this._collection.getApiURL()};if(this._collection.refreshParameters){_.extend(params,this._collection.refreshParameters)}return params}});Library.set("Operations.CollectionRefreshOperation",CollectionRefreshOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ModelRequestOperation=Streak.Class.subclass({className:"ModelRequestOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_model",destroy:false,get:true}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._model=options.model;this._tags=this._getTags();this._dependentOnTags=this._getDependentOnTags();this._limiterTagsAndTypes=this._getLimiterTagsAndTypes()},_getTags:function(){var baseTags=this._tags||[];return baseTags.concat(this._model.getRequestTags(this._getRequestType()))},_getDependentOnTags:function(){var baseTags=this._dependentOnTags||[];return baseTags.concat(this._model.getRequestDependentOnTags(this._getRequestType()))},_getLimiterTagsAndTypes:function(){return this._model.getRequestLimiterTagsAndTypes(this._getRequestType())},_getRequestObject:function(){var serverObject={};_.extend(serverObject,this._model.getWrappedObject());if(!this._model.getExtraRequestParameters||!this._model.getExtraRequestParameters(this._getRequestType())){return serverObject}var extraParameters=this._model.getExtraRequestParameters(this._getRequestType());var returnObject={};_.extend(returnObject,extraParameters,serverObject);return returnObject},_handleError:function(err){var response=err&&err.response;var xhr=err&&err.xhr;switch(xhr&&xhr.status){case 0:case 500:this._backoffAndExecuteAjaxRequest();return}this._response=response;this._xhr=xhr;this._broadcastErrorNotification();this._failureCallback(this)},_broadcastErrorNotification:function(){switch(this._xhr&&this._xhr.status){case 401:Streak.NotificationCenter.postNotification({eventName:"unauthorizedRequest",sender:this});break;case 409:Streak.NotificationCenter.postNotification({eventName:"409Conflict",model:this._model,response:this._response,sender:this});break}}});Library.set("Operations.ModelRequestOperation",ModelRequestOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ModelRefreshOperation=Streak.Class.subclass({className:"ModelRefreshOperation",superclass:Streak.Operations.ModelRequestOperation,_memberVariables:[],_initialize:function(options){Streak.Operations.ModelRequestOperation.prototype._initialize.call(this,options)},getMethod:function(){return"GET"},getParams:function(){var requestObject=this._getRequestObject();return{url:_.template(this._model.apiURLs.get)(requestObject)}},_getRequestType:function(){return"REFRESH"}});Library.set("Operations.ModelRefreshOperation",ModelRefreshOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ModelDeleteOperation=Streak.Class.subclass({className:"ModelDeleteOperation",superclass:Streak.Operations.ModelRequestOperation,_memberVariables:[],_initialize:function(options){Streak.Operations.ModelRequestOperation.prototype._initialize.call(this,options)},doOperation:function(successCallback,failureCallback){if(this._model.isSavedOnServer()){Streak.Operations.ModelRequestOperation.prototype.doOperation.apply(this,[successCallback,failureCallback]);return}this._successCallback=successCallback;this._failureCallback=failureCallback;setTimeout(successCallback,1,this)},getMethod:function(){return"DELETE"},getParams:function(){var requestObject=this._getRequestObject();return{url:_.template(this._model.apiURLs["delete"])(requestObject)}},_getRequestType:function(){return"DELETE"}});Library.set("Operations.ModelDeleteOperation",ModelDeleteOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ModelSaveOperation=Streak.Class.subclass({className:"ModelSaveOperation",superclass:Streak.Operations.ModelRequestOperation,_memberVariables:[{name:"_editOperations",destroy:false,set:true,get:true}],_initialize:function(options){this._editOperations=options.editOperations;Streak.Operations.ModelRequestOperation.prototype._initialize.call(this,options)},getMethod:function(){if(this._needsToBeCreated()){return"PUT"}return"POST"},getParams:function(){if(this._needsToBeCreated()){return this._getCreateParams()}return this._getUpdateParams()},_getTags:function(){var baseTags=this._tags||[];return baseTags.concat(this._model.getRequestTags(this._getRequestType(),this._editOperations,this.getId()))},_getLimiterTagsAndTypes:function(){return this._model.getRequestLimiterTagsAndTypes(this._getRequestType(),this._editOperations,this.getId())},_getRequestType:function(){return this.getMethod()==="PUT"?"CREATE":"UPDATE"},_getRequestObject:function(){var requestObject=Streak.Operations.ModelRequestOperation.prototype._getRequestObject.call(this);if(this._editOperations){for(var ii=0;ii<this._editOperations.length;ii++){var edit=this._editOperations[ii];if(edit.operationId===this.getId()){requestObject[edit.property]=edit.value}}}return requestObject},_needsToBeCreated:function(){return!this._model.isSavedOnServer()},_getCreateParams:function(){var requestObject=this._getRequestObject();var params={url:_.template(this._model.apiURLs.create)(requestObject)};var createProperties=this._model.createProperties;for(var ii=0;ii<createProperties.length;ii++){var property=createProperties[ii];if(typeof requestObject[property]!="undefined"){params[property]=requestObject[property]}}return params},_getUpdateParams:function(){var requestObject=this._getRequestObject();var updateParams={url:_.template(this._model.apiURLs.update,requestObject),json:JSON.stringify(requestObject)};var extraUpdateParameters=this._model.getExtraUpdateParameters();_.extend(updateParams,extraUpdateParameters);return updateParams}});Library.set("Operations.ModelSaveOperation",ModelSaveOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var OperationStatusChangeHandler=Streak.Class.subclass({className:"OperationStatusChangeHandler",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},operationStateChanged:function(operation){if(operation.getState()===Streak.Operations.Operation.STATES.SUCCEEDED){this._operationSucceeded(operation);return}if(operation.getState()===Streak.Operations.Operation.STATES.FAILED){this._operationFailed(operation);return}},_operationSucceeded:function(operation){throw new Error("must implement _operationSucceeded function")},_operationFailed:function(operation){throw new Error("must implement _operationFailed function")}});Library.set("Operations.OperationStatusChangeHandler",OperationStatusChangeHandler)})(Streak);(function(Streak,window){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,HTML=Streak.HTML,Eventer=Streak.Eventer;Messenger.storeData("clientVersion",Streak.clientVersion);var cssFile=Streak.getCombined("css",true);var scriptDomain="mailfoogae.appspot.com";var scriptId="pnnfemgpilpdaojpnkjdgfgbnnjojfik";Streak.DependencyManager.notifyFunctionFinished("bentoBoxServerSet");var BentoBox=new Eventer;_.extend(BentoBox,{currentTime:null,Controllers:{},Services:{},Models:{},Modules:{},Widgets:{},isError:false,maxGetUserAttempts:2,Constants:{SERVER:null,EMAIL_BLACK_LIST:["gmail.com","facebook.com","aol.com","yahoo.com","hotmail.com","att.net","googlemail.com"],COLOR_LIST:["RGB(99,99,48)","IndianRed","Salmon","CornflowerBlue","DodgerBlue","LightSlateGray","LightSteelBlue","RGB(90,105,134)","RGB(235,112,0)","RGB(179,109,0)","RGB(171,139,0)"]},user:null,userSettings:null,userEmail:null,_isReady:false,_readyFuncs:[],_isLoggedOutReady:false,_loggedOutReadyFuncs:[],_isLoaded:false,_isDataInitialized:false,_loadedFuncs:[],_isDisconnected:false,_isTornDown:false,init:function(callback){this.userEmail=Streak.userEmail;var self=this;this.bind("criticalError",function(){self.criticalError()});this.bind("newClientVersion",function(){self.newClientVersion()});this.bind("newExtVersion",function(){self.newExtVersion()});this.bind("noThirdPartyCookie",function(){self.noThirdPartyCookie()
});Streak.NotificationCenter.subscribe({eventName:"unauthorizedRequest",functionToCall:this.unauthorizedRequest,observer:this});Streak.NotificationCenter.subscribe({eventName:"reauthorized",functionToCall:this.reauthorized,observer:this});if(callback){callback()}},unauthorizedRequest:function(){if(this._isDisconnected){return}this._isDisconnected=true;this.teardown();this.Modules.TopNav.gotLoggedOut()},reauthorized:function(){this._isDisconnected=false;this.reup()},isLoggedIn:function(){return this.getUser()&&this.getUser().get("isOauthComplete")},criticalError:function(){if(this._isDisconnected){return}this._isDisconnected=true;if(this._isReady){this.teardown();this.establishConnection()}else{this.teardown()}},newClientVersion:function(){this.teardown();this.Modules.TopNav.showClientUpdateNeeded();this.Modules.TopNav.openMenu()},newExtVersion:function(){this.teardown();this.Modules.TopNav.showExtensionUpdateNeeded();this.Modules.TopNav.openMenu()},establishConnection:function(attempt,delay){var self=this;if(!attempt){attempt=1}if(attempt===1){this.ButterBarManager.showError("Error communicating with Streak servers, retrying now...",{messageKey:"bentoBoxCommunicationError"})}this.connectionTest(function(){self._isDisconnected=false;self.ButterBarManager.hideMessage("bentoBoxCommunicationError");self.reup()},function(){attempt+=1;if(!delay){delay=2e3}else{delay=Math.min(delay*2,6e4)}self.ButterBarManager.showError("Streak: retrying in "+delay/1e3+" seconds",{messageKey:"bentoBoxCommunicationError"});setTimeout(function(){self.establishConnection(attempt,delay)},delay)})},connectionTest:function(pass,fail){var self=this;APIRequester.get("users/me").then(function(res){if(res&&res.isOauthComplete){pass()}else{self.reset()}},function(res){if(res&&res.error==="user not logged in"){self.reset()}else{fail()}})},reset:function(){this.ButterBarManager.hideMessage("messageKey");this.reup();this.trigger("logged_out")},teardown:function(){var self=this;if(self._isTornDown){return}self._isTornDown=true;delete Streak.DependencyManager._mapOfFinishedFunctionKeys["teardown"];Streak.DependencyManager.addFunction({functionKey:"teardown",functionToCall:function(callback){self.UI.teardown();for(var module in self.Modules){if(self.Modules[module].teardown){self.Modules[module].teardown()}}Streak.NotificationCenter.postNotification({eventName:"streak.teardown"});self.Modules.TopNav.haltExecution();Gmail.teardown();if(callback){callback()}},dependentFunctionKeys:["topNavInitialized","gmailLoaded","htmlLoaded","localeLoaded"]})},reup:function(){var self=this;if(!self._isTornDown){return}self._isTornDown=false;for(var module in self.Modules){if(self.Modules[module].reup){try{self.Modules[module].reup()}catch(err){self.logError("Reupping bad for: "+module,err)}}}Streak.NotificationCenter.postNotification({eventName:"streak.reup"});Gmail.reup();Gmail.detectViewChange({fragment:location.hash.substring(1)});self.trigger("reup")},isTornDown:function(){return this._isTornDown},destroy:function(){this.teardown();this.Modules.TopNav.destroy();Gmail.destroy();this.UI.destroy();undoErrorWrap()},addCSSFile:function(callback){Gmail.insertCss(cssFile);if(callback){callback()}},triggerFirstGmailViewChange:function(callback){this._isReady=true;Gmail.checkAndTriggerInitialConversationView();Gmail.detectViewChange({fragment:location.hash.substring(1)});if(callback){callback()}Streak.NotificationCenter.postNotification({eventName:"bentoBoxIsReady"})},setUser:function(user){this.user=this.Models.User.create(user)},getUser:function(){return this.user},isExperimentEnabled:function(experimentName){return this.EnabledFeaturesController.isFeatureEnabled(experimentName)},isFeatureEnabled:function(key){return this.EnabledFeaturesController.isFeatureEnabled(key)},getUserSettings:function(){return this.userSettings},logError:function(message,err,extraMessage){if(!message&&!err){console.error("logError() called with no arguments.");return}message=message||"No message given.";if(err){if(err.alreadyLogged){return}err.alreadyLogged=true;if(err.message){message+="\n message: "+err.message}else{try{message+="\n error: "+JSON.stringify(err)}catch(_jsonErr){message+="\n error: "+err}}if(err.stack){message+="\n stack: "+err.stack}if(err.details){var details=err.details;if(typeof details=="object"){try{details=JSON.stringify(details)}catch(e){}}message+="\n details: "+details}}else{message+="\n stack:\n"+Streak.Utils.getStackTrace()}if(extraMessage){if(typeof extraMessage=="object"){try{extraMessage=JSON.stringify(extraMessage)}catch(e){}}message+="\n extra: "+extraMessage}if(this.userEmail){message+="\n user: "+this.userEmail}message+="\n clientVersion: "+Streak.clientVersion;message+="\n extVersion: "+Streak.extVersion;message+="\n url: "+location.toString();message+="\n operationQueue length: "+Streak.Operations.OperationQueue.Singleton._operationQueue.length;message+="\n subscription length:"+Streak.NotificationCenter._subscriptions.length;console.debug(message);APIRequester.error(message).getPromise().catch(function(err){console.error("Error reporting error:",err)})},installErrorReporter:function(win,label){"use strict";win.addEventListener("error",function errorReporter(event){try{var message=event.message;var url=event.filename;var line=event.lineno;var column=event.colno;var error=event.error;if(!isErrorBlacklisted(message,url,line)){if(BentoBox.isErrorOurs(error)||BentoBox.isUrlOurs(url)||BentoBox.isUrlOurs(message)){var extra="Caught by window.onerror"+"\n  Original Error Object Present: "+!!error+"\n  Location: "+url+":"+line+(column!=null?":"+column:"");if(label){extra+="\n  Window label: "+label}BentoBox.logError(message,error,extra)}}}catch(e){console.error("Error reporting error!",e)}},false)},isUrlOurs:function(url){return typeof url=="string"&&(url.indexOf(scriptDomain)>-1||url.indexOf(scriptId)>-1)},isErrorOurs:function(error,ignoreLastStackLine){if(!error){return false}var stack=error.stack;if(typeof stack=="string"&&ignoreLastStackLine){stack=stack.trim().replace(/\n[^\n]*$/,"")}return this.isUrlOurs(error.message)||this.isUrlOurs(error.fileName)||this.isUrlOurs(stack)}});Streak.userEmail=GLOBALS[10];if(!Streak.userEmail||!Streak.userEmail.isValidEmail()){Messenger.storeData("useremail","broken.noemail@streak.com");return}else{try{var candidates=Streak.searchObject(GLOBALS,Streak.userEmail,100,true,true);if(candidates.length>0){for(var i=0;i<candidates.length;i++){if(candidates[i].el.toLowerCase()===Streak.userEmail&&candidates[i].el!==Streak.userEmail){Streak.originalEmail=candidates[i].el;break}}}}catch(err){}Messenger.storeData("useremail",Streak.userEmail)}var getErrorWrapped=function(func){return function(){try{func.apply(this,arguments)}catch(err){if(err.stack){if(BentoBox.isErrorOurs(err,true)){var msg="";if(err.name){msg+=err.name+": "}if(err.message){msg+=err.message}if(msg.length===0){msg="event listener error"}BentoBox.logError(msg,err)}else{err.alreadyLogged=true}}throw err}}};var wrappedFunctions=[];var errorWrap=function(object,oldFunctionName,functionArgIndex){var streakFunctionName="_streak"+oldFunctionName;wrappedFunctions.push({object:object,originalFunctionName:oldFunctionName,streakFunctionName:streakFunctionName});object[streakFunctionName]=object[oldFunctionName];object[oldFunctionName]=function(){var args=_.toArray(arguments);var func=args[functionArgIndex];if(func&&func.apply){args[functionArgIndex]=getErrorWrapped.call(this,func).bind(this)}return this[streakFunctionName].apply(this,args)}};var undoErrorWrap=function(){for(var i=0;i<wrappedFunctions.length;i++){var obj=wrappedFunctions[i].object;var original=wrappedFunctions[i].originalFunctionName;var streakFunctionName=wrappedFunctions[i].streakFunctionName;obj[original]=obj[streakFunctionName];delete obj[streakFunctionName]}};BentoBox.installErrorReporter(window);try{var js_frame=top.document.getElementById("js_frame");if(js_frame){BentoBox.installErrorReporter(js_frame.contentWindow,"js_frame")}}catch(e){BentoBox.logError("Failed to install error reporter on js_frame",e)}if(navigator.userAgent.toLowerCase().indexOf("chrome")==-1){errorWrap(window,"setTimeout",0)}Streak.RSVP.on("error",function(reason){BentoBox.logError("possibly uncaught error in promise",reason)});function isErrorBlacklisted(message,url,line){if(message=="Script error."&&!line){return true}if(message=='Uncaught SecurityError: Blocked a frame with origin "https://mail.google.com" from accessing a cross-origin frame.'){return true}return false}Streak.BentoBox=BentoBox;BentoBox.Locale=Streak.Locale;Streak.logError=Streak.BentoBox.logError;Streak.DependencyManager.addFunction({functionKey:"bentoBoxInitialized",functionToCall:BentoBox.init,functionContext:BentoBox});Streak.DependencyManager.addFunction({functionKey:"bentoBox.addCSSFile",functionToCall:BentoBox.addCSSFile,functionContext:BentoBox,dependentFunctionKeys:["gmailLoaded"]});Streak.DependencyManager.addFunction({functionKey:"bentoBox.triggerFirstGmailViewChange",functionToCall:BentoBox.triggerFirstGmailViewChange,functionContext:BentoBox,dependentFunctionKeys:["leftLinkInitialized","labelIndicatorsInitialized","pixelTrackerSidebarMasterControllerInitialized","snippetsComposeMasterControllerInitialized","userSettingsInitialized","enabledFeaturesControllerInitialized","data.pipelines.initialized","data.boxes.initialized"]})})(Streak,window);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Operations=Streak.Operations,OperationQueue=Streak.Operations.OperationQueue.Singleton;var ModelOperationManager=Streak.Class.subclass({className:"ModelOperationManager",superclass:Operations.OperationStatusChangeHandler,_memberVariables:[],_initialize:function(){Operations.OperationStatusChangeHandler.prototype._initialize.call(this)},refresh:function(model){var operation=this._createRefreshOperation(model);var operationStatusChangeHandler=this;return OperationQueue.addOperation(operation,operationStatusChangeHandler)},_createRefreshOperation:function(model){return new Streak.Operations.ModelRefreshOperation({model:model})},del:function(model){var operation=this._createDeleteOperation(model);var operationProgressId=Streak.Operations.OperationQueue.Singleton.addOperation(operation,this);this._showDeletingMessage(operationProgressId,model);return operationProgressId},deleteAll:function(models){var operations=[];for(var ii=0;ii<models.length;ii++){var operation=this._createDeleteOperation(models[ii]);operations.push(operation)}var operationProgressId=OperationQueue.addMultipleOperations(operations,this);return operationProgressId},_createDeleteOperation:function(model){return new Streak.Operations.ModelDeleteOperation({model:model})},save:function(model,editOperations,noSavingMessage){var operation=this._createSaveModelOperation(model,editOperations);this._markEditOperations(editOperations,operation);var operationProgressId=OperationQueue.addOperation(operation,this);if(!noSavingMessage){this._showSavingMessage(operationProgressId,{operation:operation,model:model,editOperations:editOperations})}return operationProgressId},saveAll:function(models,editOperationsArray,noSavingMessage){var operations=[];for(var ii=0;ii<models.length;ii++){var operation=this._createSaveModelOperation(models[ii],editOperationsArray[ii]);this._markEditOperations(editOperationsArray[ii],operation);operations.push(operation)}var operationProgressId=OperationQueue.addMultipleOperations(operations,this);if(!noSavingMessage){this._showSavingMessage(operationProgressId)}return operationProgressId},dependentSaveAll:function(models,editOperationsArray){var operations=[];var dependentTagGuid=Streak.guid();for(var ii=0;ii<models.length;ii++){var operation=this._createSaveModelOperation(models[ii],editOperationsArray[ii]);operation.getTags().push(dependentTagGuid);operation.getDependentOnTags().push(dependentTagGuid);this._markEditOperations(editOperationsArray[ii],operation);operations.push(operation)}var operationProgressId=OperationQueue.addMultipleOperations(operations,this);return operationProgressId},_createSaveModelOperation:function(model,editOperations){var operation=new Streak.Operations.ModelSaveOperation({model:model,editOperations:editOperations});return operation},_operationSucceeded:function(operation){if(operation.getMethod()==="DELETE"){return}this.updateModel(operation.getModel(),operation.getResponse(),operation.getId())},_operationFailed:function(operation){operation.getModel().clearEditOperationsWithOperationId(operation.getId(),{isUndo:true});operation.getModel().postNotification("change");var models=operation.getModel().getModelsAffectedByServerResponse();for(var ii=0;ii<models.length;ii++){this._notifyModelRequestsComplete(models[ii],true,operation)}},updateModel:function(model,response,operationId,dontNotify){var models=model.getModelsAffectedByServerResponse(response);for(var ii=0;ii<models.length;ii++){this._mergeResponseServerObjectWithModel(models[ii],response,operationId);if(!dontNotify){this._notifyModelRequestsComplete(models[ii])}}},_markEditOperations:function(editOperations,operation){if(!editOperations){return}for(var ii=0;ii<editOperations.length;ii++){var editOperation=editOperations[ii];if(!editOperation.operationId){editOperation.operationId=operation.getId()}}},_mergeResponseServerObjectWithModel:function(model,response,operationId){var modelResponse=model.getResponseObjectAffectingModel(response);if(modelResponse){if(!model.isResponseMoreRecent(modelResponse)){return}model.updateWrappedObjectAndClearEditOperations(modelResponse,operationId)}var collectionProperties=model.getCollectionProperties();if(!collectionProperties||collectionProperties.length===0){return}for(var ii=0;ii<collectionProperties.length;ii++){this._modifyPropertyCollection(collectionProperties[ii],model,response)}},_modifyPropertyCollection:function(property,model,response){var collection=model.getPropertyCollection(property);var collectionResponse=model.getResponseForCollection(property,response);Streak.Operations.CollectionOperationManager.Singleton.updateCollectionWithResponse(collection,collectionResponse)},_notifyModelRequestsComplete:function(model,isError,operation){var pendingOperations=OperationQueue.queryOperationQueue({states:[Streak.Operations.Operation.STATES.NOT_STARTED,Streak.Operations.Operation.STATES.PENDING,Streak.Operations.Operation.STATES.WORKING],containsTags:[model.getModelTag()]});if(pendingOperations&&pendingOperations.length>0){return}if(model.requestsCompleted){var error=null;if(isError){error=new Error("Model request error");error.response=operation.getResponse();error.details={response:error.response,status:operation.getXhr().status,method:operation.getMethod(),entityType:model.entityType}}model.requestsCompleted(isError,error)}},_showSavingMessage:function(operationProgressId,options){if(options&&options.model&&options.editOperations){if(!options.model.shouldShowSavingMessage(options.editOperations)){return}}var method=null;if(options&&options.operation){method=options.operation.getMethod()}BB.ButterBarManager.showSaving({operationProgressId:operationProgressId,showConfirmation:method!=="PUT"})},_showDeletingMessage:function(operationProgressId,model){BB.ButterBarManager.showMessage(BB.Locale.getString("deleting"),{operationProgressId:operationProgressId})}});Library.set("Operations.ModelOperationManager",ModelOperationManager);Library.set("Operations.ModelOperationManager.Singleton",new ModelOperationManager)})(Streak);(function(Streak,window){"use strict";var _=Streak._,NotificationCenter=Streak.NotificationCenter;var Collection=Streak.iframe.contentWindow.Array;_.extend(Collection.prototype,{init:function(options){this._apiURL=options.apiURL;this._keyToModelMap={};this._idToModelMap={};this._id=Streak.guid();this.createModelFromRawJSON=options.createModelFromRawJSON;this._isInTransaction=false;this._hasLoaded=false;this._afterLoadDeferred=Streak.Promise.defer();this._requestTags=options.requestTags;this._requestDependentOnTags=options.requestDependentOnTags;this._refreshRequeueOperationTags=options.refreshRequeueOperationTags;this._modelKeyPropertyName=options.modelKeyPropertyName;this._isSorted=false;this._sortParameter=null;this._bindToModelEvents()},getId:function(){return this._id},getApiURL:function(){return this._apiURL},add:function(model){if(this._keyToModelMap[model.key()]){return}this.push(model);this._isSorted=false;if(model.key()){this._keyToModelMap[model.key()]=model}this._idToModelMap[model.getId()]=model;this._postNotification("add",{model:model});this._postNotification("change",{model:model});this._postCollectionChangeNotification()},remove:function(model){this._removeFromArray(model);if(!this._idToModelMap[model.getId()]){return}delete this._keyToModelMap[model.key()];delete this._idToModelMap[model.getId()];model.postNotification("removedFromCollection");this._postNotification("remove",{model:model});this._postNotification("change");this._postCollectionChangeNotification()},refresh:function(callback){var progressId=Streak.Operations.CollectionOperationManager.Singleton.refresh(this);Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:progressId,operationIsComplete:true},unsubscribeImmediately:true,functionToCall:function(){this._hasLoaded=true;this._afterLoadDeferred.resolve();if(callback){callback.apply(this,arguments)}},observer:this});return progressId},getByKey:function(key){return this._keyToModelMap[key]},getRequestTags:function(requestType){return this._requestTags},getRequestDependentOnTags:function(requestType){return this._requestDependentOnTags},getRefreshRequeueOperationTags:function(){return this._refreshRequeueOperationTags},startTransaction:function(){this._isInTransaction=true;NotificationCenter.startTransaction(this.getId())},endTransaction:function(suppressEvents){this._isInTransaction=false;NotificationCenter.endTransaction(this.getId(),suppressEvents)},getHasLoaded:function(){return this._hasLoaded},afterLoad:function(){return this._afterLoadDeferred.promise},watch:function(event,cb,observer){if(!event){return}if(!cb){return}return NotificationCenter.subscribe({eventName:event,filterParameters:{sender:this},functionToCall:cb,observer:observer})},postNotification:function(event,eventProperties){this._postNotification(event,eventProperties)},sortByParameter:function(parameter){if(this._isSorted&&this._sortParameter===parameter){return}this.sort(function(a,b){var valA=a.get(parameter);var valB=b.get(parameter);if(valA!==valB){if(valA>valB||valA===void 0)return 1;if(valA<valB||valB===void 0)return-1}return 0});this._isSorted=true;this._sortParameter=parameter},sort:function(){this._isSorted=false;Array.prototype.sort.apply(this,_.toArray(arguments))},_postCollectionChangeNotification:_.debounce(function(){this._postNotification("collectionChange")},50),_postNotification:function(event,eventProperties){if(!event){return}var eventName=event;var notification={collectionId:this.getId(),collection:this,sender:this};var transactionId;if(this._isInTransaction){transactionId=this.getId()}if(eventProperties){_.extend(notification,eventProperties)}notification.eventName=eventName;NotificationCenter.postNotification(notification,transactionId)},_bindToModelEvents:function(){var self=this;NotificationCenter.subscribe({functionToCall:this._modelEvent,observer:this})},_modelEvent:function(notification){if(notification.collection){return}if(!this._idToModelMap[notification.modelId]&&!this._idToModelMap[notification.parentModelId]){return}switch(notification.eventName){case"keyChanged":this._modelKeyChanged(notification);break;case"delete":this._modelDeleted(notification);break}var newNotification={};_.extend(newNotification,notification);newNotification.sender=this;if(newNotification.parentModelId&&this._idToModelMap[newNotification.parentModelId]){newNotification.model=this._idToModelMap[newNotification.parentModelId];newNotification.modelId=newNotification.model.getId();delete newNotification.parentModelId;delete newNotification.parentModel}this._postNotification(notification.eventName,newNotification)},_modelKeyChanged:function(notification){var oldKey=notification.oldKey;if(oldKey){delete this._keyToModelMap[oldKey]}if(notification.newKey){this._keyToModelMap[notification.newKey]=notification.model}},_modelDeleted:function(notification){this.remove(notification.model)},_removeRegionFromArray:function(from,to){var rest=this.slice((to||from)+1||this.length);this.length=from<0?this.length+from:from;return this.push.apply(this,rest)},_removeFromArray:function(val){var index=this.indexOf(val);if(index>-1){this._removeRegionFromArray(index);return true}return false}});Collection.refreshAll=function(collections){return Streak.Operations.CollectionOperationManager.Singleton.refreshAll(collections)};Streak.Collection=Collection})(Streak,window);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Operations=Streak.Operations,OperationQueue=Streak.Operations.OperationQueue.Singleton;var CollectionOperationManager=Streak.Class.subclass({className:"CollectionOperationManager",superclass:Operations.OperationStatusChangeHandler,_memberVariables:[],_initialize:function(){Streak.Operations.OperationStatusChangeHandler.prototype._initialize.call(this)},refresh:function(collection){var currentRefreshOperation=this._getRefreshOperationForCollectionRefresh(collection);if(currentRefreshOperation){return OperationQueue.getOperationProgressId(currentRefreshOperation)}var operation=this._createRefreshOperation(collection);var operationStatusChangeHandler=this;return OperationQueue.addOperation(operation,operationStatusChangeHandler)},refreshAll:function(collections){var operations=_.map(collections,this._createRefreshOperation);var operationStatusChangeHandler=this;return OperationQueue.addMultipleOperations(operations,operationStatusChangeHandler)},_getRefreshOperationForCollectionRefresh:function(collection){var refreshTags=collection.getRequestTags("REFRESH");var operations=OperationQueue.queryOperationQueue({notStates:[Streak.Operations.Operation.STATES.SUCCEEDED,Streak.Operations.Operation.STATES.FAILED],containsTags:refreshTags});if(operations.length>0){return operations[0]}return null},_createRefreshOperation:function(collection){return new Operations.CollectionRefreshOperation({collection:collection})},_operationSucceeded:function(operation){var collection=operation.getCollection();if(this._shouldRequeueOperation(operation)){OperationQueue.addOperation(new Operations.CollectionRefreshOperation({collection:collection}),this);return}this.updateCollectionWithResponse(collection,operation.getResponse());if(operation instanceof Operations.CollectionRefreshOperation){collection.postNotification("collectionRefreshed")}},_operationFailed:function(operation){},_shouldRequeueOperation:function(operation){var collection=operation.getCollection();var requeueOperationTags=collection.getRefreshRequeueOperationTags();var requeueOperations=OperationQueue.queryOperationQueue({notStates:[Operations.Operation.STATES.FAILED],containsTags:requeueOperationTags,afterOperation:operation});return requeueOperations.length>0},updateCollectionWithResponse:function(collection,response,noRemoval){collection.startTransaction();var removed=[];var responseItems=response||[];var keyProperty=collection._modelKeyPropertyName;var usedKeys={};for(var ii=0;ii<responseItems.length;ii++){var item=responseItems[ii];var model=collection.getByKey(item[keyProperty]);if(!model){model=collection.createModelFromRawJSON(item);collection.add(model);_.each(model.getCollectionProperties(),function(collectionProperty){Operations.ModelOperationManager.Singleton._modifyPropertyCollection(collectionProperty,model,item)})}else{Operations.ModelOperationManager.Singleton.updateModel(model,item,null,true)}if(!noRemoval){usedKeys[model.key()]=true}}if(!noRemoval){for(var ii=0;ii<collection.length;ii++){if(!collection[ii].key()){continue}if(!usedKeys[collection[ii].key()]){removed.push(collection[ii])}}for(var ii=0;ii<removed.length;ii++){collection.remove(removed[ii],true)}}collection.endTransaction()}});Library.set("Operations.CollectionOperationManager",CollectionOperationManager);Library.set("Operations.CollectionOperationManager.Singleton",new CollectionOperationManager)})(Streak);(function(Streak,window){"use strict";var _=Streak._,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,ModelOperationManager=Streak.Operations.ModelOperationManager.Singleton;var Model=function(wrappedObject){Streak.Object.call(this);wrappedObject=wrappedObject||{};this._guid=Streak.guid();this._setupWrappedObject(wrappedObject);this._isInTransaction=false;this._eventStream=null;this._setupEventStream()};Model.prototype=Object.create(Streak.Object.prototype);_.extend(Model.prototype,{getWrappedObject:function(){return getWrappedObject(this._index)},updateWrappedObjectAndClearEditOperations:function(wrappedObject,operationId){this.startTransaction();var currentObject=this.getLatestObject()||{};setWrappedObject(this._index,wrappedObject);if(operationId){this.clearEditOperationsWithOperationId(operationId)}wrappedObject=this.getLatestObject()||{};this._notifyChangeInWrappedObjects(currentObject,wrappedObject);this.endTransaction()},clearEditOperationsWithOperationId:function(operationId,extraOptions){var editOperations=this.getEditOperations();var newEditOperations=[];var undoneEditOperationIndices=[];var propertyLastEditOperationIndexMap={};for(var ii=0;ii<editOperations.length;ii++){if(editOperations[ii].operationId===operationId){undoneEditOperationIndices.push(ii)}else{newEditOperations.push(editOperations[ii])}propertyLastEditOperationIndexMap[editOperations[ii].property]=ii}this.setEditOperations(newEditOperations);if(!extraOptions||!extraOptions.isUndo){return}for(var ii=0;ii<undoneEditOperationIndices.length;ii++){var undoneEditOperationIndex=undoneEditOperationIndices[ii];var undoneEditOperation=editOperations[undoneEditOperationIndex];var property=undoneEditOperation.property;if(propertyLastEditOperationIndexMap[property]===undoneEditOperationIndex){this._sendOutChangeNotifications(property,undoneEditOperation.value,undoneEditOperation.previousValue)}}},setWrappedObject:function(wrappedObject){var currentObject=this.getLatestObject()||{};setWrappedObject(this._index,wrappedObject);wrappedObject=this.getLatestObject()||{};this._notifyChangeInWrappedObjects(currentObject,wrappedObject)},_notifyChangeInWrappedObjects:function(currentObject,wrappedObject){if(currentObject[this.keyName]!==wrappedObject[this.keyName]){this._postNotification({eventName:"keyChanged",oldKey:currentObject[this.keyName],newKey:wrappedObject[this.keyName]})}if(currentObject[this.nameProperty]!==wrappedObject[this.nameProperty]){setDisplayName(this._index,wrappedObject[this.nameProperty])}if(Streak.Utils.isDeepEquals(currentObject,wrappedObject)){return}for(var property in wrappedObject){var previousValue=currentObject[property];var newValue=wrappedObject[property];if(!Streak.Utils.isDeepEquals(previousValue,newValue)){this._sendOutChangeNotifications(property,previousValue,newValue)}}},getLatestObject:function(){var wrappedObject=JSON.deepClone(this.getWrappedObject()||{});var editOperations=this.getEditOperations()||[];for(var ii=0;ii<editOperations.length;ii++){wrappedObject[editOperations[ii].property]=editOperations[ii].value}return wrappedObject},getId:function(){return this._guid},getModelTag:function(){return this.tagEntityName+"_"+this.tagEntityName+"Key_"+this.key()},getRequestTags:function(requestType){if(this.syncParent){return this.syncParent.getRequestTags(requestType)}var tags=[this.tagEntityName,this.tagEntityName+"_"+this.tagEntityName+"ClientId"+this.getId()];if(requestType){tags.push(this.tagEntityName+"_"+requestType.toLowerCase())}switch(requestType){case"CREATE":tags.push(this.tagEntityName+"_"+this.tagEntityName+"ClientId"+this.getId());break;default:tags.push(this.tagEntityName+"_"+this.tagEntityName+"Key_"+this.key());if(requestType){tags.push(this.tagEntityName+"_"+requestType.toLowerCase()+"_"+this.tagEntityName+"Key_"+this.key())}break}return tags},getRequestDependentOnTags:function(requestType){if(this.syncParent){return this.syncParent.getRequestDependentOnTags(requestType)}var tags=[this.tagEntityName+"_"+this.tagEntityName+"ClientId"+this.getId()];switch(requestType){case"CREATE":tags.push(this.tagEntityName+"_"+this.tagEntityName+"ClientId"+this.getId());break;default:if(this.syncParent){tags=tags.concat(this.syncParent.getRequestDependentOnTags(requestType))}tags.push(this.tagEntityName+"_"+this.tagEntityName+"Key_"+this.key());if(requestType){tags.push(this.tagEntityName+"_"+requestType.toLowerCase()+"_"+this.tagEntityName+"Key_"+this.key())}break}return tags},getRequestLimiterTagsAndTypes:function(requestType){if(this.syncParent){return this.syncParent.getRequestLimiterTagsAndTypes(requestType)}return null},getExtraRequestParameters:function(requestType){return null},getExtraUpdateParameters:function(){return null},set:function(property,value){var previousValue=this.get(property);getEditOperations(this._index).push({property:property,previousValue:previousValue,value:value});if(this.nameProperty===property){setDisplayName(this._index,value)}this._sendOutChangeNotifications(property,previousValue,value)},get:function(property){var editOperations=getEditOperations(this._index);var wrappedObject=getWrappedObject(this._index)||{};var propValue=wrappedObject[property];for(var ii=0;ii<editOperations.length;ii++){if(editOperations[ii].property===property){propValue=editOperations[ii].value}}return _.isReal(propValue)?propValue:""},getEditOperations:function(){return getEditOperations(this._index)},setEditOperations:function(editOperations){setEditOperations(this._index,editOperations)},watch:function(event,callback,observer,property){if(!event){return}if(!callback){return}var filterParameters={sender:this};if(_.isString(property)){filterParameters.property=property}NotificationCenter.subscribe({eventName:event,filterParameters:filterParameters,functionToCall:callback,observer:observer})},startTransaction:function(){this._isInTransaction=true;NotificationCenter.startTransaction(this.getId())},endTransaction:function(){this._isInTransaction=false;NotificationCenter.endTransaction(this.getId())},postNotification:function(notification){if(_.isString(notification)){notification={eventName:notification}}else{notification.eventName=notification.eventName}this._postNotification(notification)},save:function(cb,errCb,noButterBarMessage){if(cb||errCb){getPendingCallbacks(this._index).push({cb:cb,errCb:errCb})}var progressId=ModelOperationManager.save(this,getEditOperations(this._index),noButterBarMessage);this._postNotification({eventName:"save"});return progressId},del:function(cb,errCb){getPendingCallbacks(this._index).push({cb:cb,errCb:errCb});var progressId=ModelOperationManager.del(this);this._postNotification({eventName:"delete"});return progressId},remove:function(){this._postNotification({eventName:"delete"})},refresh:function(cb){getPendingCallbacks(this._index).push({cb:cb,errCb:cb});ModelOperationManager.refresh(this)},isSavedOnServer:function(){return this.key().length>0&&this.key().indexOf("__new__")===-1},link:function(){return this.typeName+"/"+this.key()},key:function(){return this.get(this.keyName)},displayName:function(){return this.displayNameHTML()},displayNameHTML:function(){var displayName=getDisplayName(this._index);if(_.isNotReal(displayName)){setDisplayName(this._index,this.get(this.nameProperty));displayName=getDisplayName(this._index)
}return displayName},displayNameText:function(){return this.get(this.nameProperty)},createPatch:function(){return new Streak.ModelPatch(this)},getModelsAffectedByServerResponse:function(){return[this]},getResponseObjectAffectingModel:function(response){return response},isResponseMoreRecent:function(response){if(response.lastUpdatedTimestamp&&this.get("lastUpdatedTimestamp")){if(response.lastUpdatedTimestamp<=this.get("lastUpdatedTimestamp")){return false}}return true},getCollectionProperties:function(){},getPropertyCollection:function(property){},getResponseForCollection:function(response,property){},shouldShowSavingMessage:function(editOperations){return true},_setupWrappedObject:function(wrappedObject){this._index=_generateModelIndex();setWrappedObject(this._index,wrappedObject)},sendOutChangeNotifications:function(property,previousValue,newValue){this._sendOutChangeNotifications(property,previousValue,newValue)},_sendOutChangeNotifications:function(property,previousValue,newValue){this._postNotification({eventName:"change",property:property,previousValue:previousValue,newValue:newValue});this._postNotification({eventName:"set",property:property,previousValue:previousValue,newValue:newValue});if(property===this.keyName){this._postNotification({eventName:"keyChanged",oldKey:previousValue,newKey:newValue})}},_postNotification:function(notification){_.extend(notification,{model:this,modelId:this.getId(),sender:this});if(this.syncParent){notification.parentModel=this.syncParent;notification.parentModelId=this.syncParent.getId()}var transactionId;if(this._isInTransaction){transactionId=this.getId()}NotificationCenter.postNotification(notification,transactionId)},_setupEventStream:function(){var modelId=this._guid;this._eventStream=NotificationCenter.getNotificationStream().filter(function(notification){return notification.modelId===modelId||notification.parentModelId===modelId})},getEventStream:function(){return this._eventStream},requestsCompleted:function(isError,error){var callbacks=_.clone(getPendingCallbacks(this._index));getPendingCallbacks(this._index).length=0;error||(error=new Error("Unknown error"));var suppressError=false;for(var i=0;i<callbacks.length;i++){if(isError){if(_.isFunction(callbacks[i].errCb)){suppressError=suppressError||callbacks[i].errCb(error)}}else if(_.isFunction(callbacks[i].cb)){callbacks[i].cb()}}this._postNotification({eventName:"requestsCompleted"})},destroy:function(){setWrappedObject(this._index,null);setEditOperations(this._index,null);setPendingCallbacks(this._index,null);setDisplayName(this._index,null)}});Model.saveAll=function(models){var editOperationsArray=_.map(models,function(model){var editOperations=getEditOperations(model._index);return editOperations});return Streak.Operations.ModelOperationManager.Singleton.saveAll(models,editOperationsArray)};Model.dependentSaveAll=function(models){var editOperationsArray=_.map(models,function(model){var editOperations=getEditOperations(model._index);return editOperations});return Streak.Operations.ModelOperationManager.Singleton.dependentSaveAll(models,editOperationsArray)};Model.deleteAll=function(models){for(var ii=0;ii<models.length;ii++){models[ii].postNotification("delete")}return Streak.Operations.ModelOperationManager.Singleton.deleteAll(models)};var _numberOfModels=0;function _generateModelIndex(){_numberOfModels+=1;return _numberOfModels}var _wrappedObjectPropertyArray=[];function setWrappedObject(index,value){_wrappedObjectPropertyArray[index]=value}function getWrappedObject(index){return _wrappedObjectPropertyArray[index]}var _editOperationsPropertyArray=[];function setEditOperations(index,value){_editOperationsPropertyArray[index]=value}function getEditOperations(index){if(!_editOperationsPropertyArray[index]){_editOperationsPropertyArray[index]=[]}return _editOperationsPropertyArray[index]}var _pendingCallbacksPropertyArray=[];function setPendingCallbacks(index,value){_pendingCallbacksPropertyArray[index]=value}function getPendingCallbacks(index){if(!_pendingCallbacksPropertyArray[index]){_pendingCallbacksPropertyArray[index]=[]}return _pendingCallbacksPropertyArray[index]}var _displayNamePropertyArray=[];function setDisplayName(index,value){value=value||"";_displayNamePropertyArray[index]=Streak.Utils.escapeAngleBrackets(value)}function getDisplayName(index){return _displayNamePropertyArray[index]}Streak.Model=Model})(Streak,window);(function(Streak){var _=Streak._,NotificationCenter=Streak.NotificationCenter;var superclass=Streak.Object;var ModelPatch=Streak.Class.subclass({className:"ModelPatch",superclass:superclass,_memberVariables:[{name:"_model",destroy:false},{name:"_patch",destroy:true}],_initialize:function(model){superclass.prototype._initialize.call(this);this._model=model;this._patch={}},destroy:function(){NotificationCenter.unsubscribe({sender:this});NotificationCenter.unsubscribe({observer:this});superclass.prototype.destroy.call(this)},get:function(name){this._assertUncommitted();if(!this._patch){if(!this._model){return""}else{return this._model.get(name)}}if(this._patch[name]===void 0){return this._model.get(name)}else{return this._patch[name]}},set:function(property,value){this._assertUncommitted();if(value===void 0){throw new Error("Cannot set a value to 'undefined' using ModelPatch.set.")}var previousValue=this.get(property);this._patch[property]=value;this._sendOutChangeNotifications(property,previousValue,value)},commit:function(){this._assertUncommitted();for(var name in this._patch){if(this._patch.hasOwnProperty(name)){this._model.set(name,this._patch[name])}}NotificationCenter.postNotification({eventName:"ModelPatch.commit",sender:this});var model=this._model;this.destroy();return model},_assertUncommitted:function(){if(this._model===void 0){throw new Error("Cannot use a patch after it has been committed")}},_postNotification:function(notification){_.extend(notification,{model:this._model,modelId:this._model.getId(),sender:this});if(this.syncParent){notification.parentModel=this._model.syncParent;notification.parentModelId=this._model.syncParent.getId()}var transactionId;if(this._isInTransaction){transactionId=this.getId()}NotificationCenter.postNotification(notification,transactionId)},watch:Streak.Model.prototype.watch,_sendOutChangeNotifications:Streak.Model.prototype._sendOutChangeNotifications});Streak.ModelPatch=ModelPatch})(Streak);(function(Streak){var Date=Streak.Date,_=Streak._,BB=Streak.BentoBox,RSVP=Streak.RSVP,APIRequester=Streak.APIRequester;var UserStateController=function(){};Streak._.extend(UserStateController.prototype,{init:function(){var self=this;this._checkActiveAI();return this._initializeUserInformation().then(function(){if(BB.isLoggedIn()){Streak.NotificationCenter.postNotification({eventName:"reauthorized"})}})},userLoggedIn:function(rawUserObject){BB.setUser(rawUserObject);if(BB.getUser().get("isOauthComplete")||Streak.ai){Streak.DependencyManager.notifyFunctionFinished("userLoggedIn")}},ai:function(userEmail){sessionStorage.streak_ai=userEmail;location.reload()},_checkActiveAI:function(){if(!sessionStorage.streak_ai){return}Streak.ai=sessionStorage.streak_ai;delete sessionStorage.streak_ai;Streak.DependencyManager.addFunction({functionKey:"disableStreakSettings",functionReference:function(){BB.UserSettings.active=false},dependentFunctionKeys:["userSettingsInitialized"]})},_initializeUserInformation:function(){var work=[this._getUserInfo(),this._loadStreakCheck()];return Streak.RSVP.all(work).then(function(){})},_getInstallAppId:function(){return Streak.Utils.timeout(new Streak.RSVP.Promise(function(resolve,reject){Messenger.sendMessage("installAppIdRequest",null,"installAppIdResponse",function(response){resolve(response.value)})}),800)},_loadStreakCheck:function(){var self=this;return new RSVP.Promise(function(resolve,reject){var installAppIdCheck=self._getInstallAppId().then(function(installAppId){if(_.contains(["DocSend","addDocSend"],installAppId)){if(BB.LocalSettings.get("activeApps/docsend")==null){BB.LocalSettings.set("activeApps/docsend",true)}}if(installAppId&&installAppId!="DocSend"){if(BB.LocalSettings.get("activeApps/streak")==null){BB.LocalSettings.set("activeApps/streak",true)}}},function(err){console.error("installAppId check failed",err)});var docsendSettingPromise=installAppIdCheck;docsendSettingPromise.then(function(){if(BB.LocalSettings.get("activeApps/docsend")){Streak.DependencyManager.notifyFunctionFinished("docsendEnabled")}});var streakAppSettingPromise;if(BB.LocalSettings.get("activeApps/streak")){streakAppSettingPromise=RSVP.resolve(null)}else{streakAppSettingPromise=installAppIdCheck.then(function(){if(!BB.LocalSettings.get("activeApps")){BB.LocalSettings.set("activeApps/streak",true)}})}resolve(streakAppSettingPromise)}).then(function(){if(BB.LocalSettings.get("activeApps/streak")){return self._tryToGetUserFromServer()}else{Streak.DependencyManager.notifyFunctionFinished("noCRM")}})},_getUserInfo:function(){return APIRequester.get("users/me/info").getPromise().then(function(userInfo){Streak.debugTrackUser=Streak.debugTrackUser||userInfo;if(Streak.debugTrackUser&&Streak.debugTrackUser.isUserFirstCall){BB.Tracker.trackStreakPassive({eventName:"firstTimeUserSeen"})}})},_tryToGetUserFromServer:function(){var self=this;return APIRequester.get("users/me").getPromise().then(function(serverResponse){self._handleSuccessfulResponse(serverResponse)},function(err){if(err.xhr&&err.xhr.status===401){return self._userNotLoggedIn()}else{self._logGetUserError(err.response,err.xhr)}})},_handleSuccessfulResponse:function(serverResponse){if(this._isUserLoggedIn(serverResponse)){this.userLoggedIn(serverResponse);return}return this._userNotLoggedIn()},_userNotLoggedIn:function(){return this._checkThirdPartyCookiesEnabled()},_isUserLoggedIn:function(serverResponse){return serverResponse&&!serverResponse.error&&serverResponse.userKey&&serverResponse.isOauthComplete||Streak.ai},_checkThirdPartyCookiesEnabled:function(){var self=this;return this._setThirdPartyCookie().then(function(setCookieResponse,xhr){return self._checkCookieWasSet(setCookieResponse,xhr)})},_setThirdPartyCookie:function(){return APIRequester.put("webclient/cookies",null,{cookieName:"randomCookie"}).getPromise().catch(this._logCookieError.bind(this))},_isCookieResponseValid:function(setCookieResponse){return!!setCookieResponse},_checkCookieWasSet:function(setCookieResponse,xhr){var self=this;if(!self._isCookieResponseValid(setCookieResponse)){self._logCookieError(null,xhr);return false}var checkCookieRequestParameters=this._constructCookieRequestParameters(setCookieResponse);return APIRequester.get("webclient/cookies",checkCookieRequestParameters).getPromise().then(this._validateCheckCookieResponse.bind(this),this._logCookieError.bind(this))},_constructCookieRequestParameters:function(setCookieResponse){var checkCookieRequestParameters={cookieName:"randomCookie"};for(var value in setCookieResponse){checkCookieRequestParameters[value]=setCookieResponse[value]}return checkCookieRequestParameters},_validateCheckCookieResponse:function(checkCookieResponse){if(this._isCheckCookieResponseValid(checkCookieResponse)){Streak.DependencyManager.notifyFunctionFinished("userLoggedOut")}else{this._thirdPartyCookiesDisabled()}},_isCheckCookieResponseValid:function(checkCookieResponse){return checkCookieResponse&&checkCookieResponse.success},_thirdPartyCookiesDisabled:function(){BB.Modules.TopNav.showThirdPartyCookiesDisabled()},_logGetUserError:function(serverResponse){var msg="Server threw an error getting user";msg+="\n attempt: 5";if(serverResponse&&serverResponse.error){msg+="\nServer msg: "+serverResponse.error}BB.logError(msg);BB.trigger("criticalError");BB.isError=true},_logCookieError:function(err,xhr){xhr||(xhr=err.xhr);var msg="Error in determining 3rd party cookies";if(xhr){msg+="\n status: "+xhr.status;msg+="\n response: "+JSON.stringify(xhr)}else{msg+="\n xhr param missing"}BB.logError(msg,err);BB.isError=true;BB.trigger("criticalError")}});BB.UserStateController=new UserStateController;Streak.DependencyManager.addFunction({functionKey:"userStateInitialized",functionReference:BB.UserStateController.init,functionContext:BB.UserStateController,dependentFunctionKeys:["topNavInitialized","localSettingsInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var INSTALL_APP_ID_TO_FEATURE_MAP={BumpLater:["bumpLater"]};var EnabledFeaturesController=Streak.Class.subclass({className:"EnabledFeaturesController",superclass:Streak.Object,_memberVariables:[{name:"_currentPlans",destroy:false},{name:"_experiments",destroy:false},{name:"_installAppIdFeatures",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setup:function(){this._experiments=BB.getUser().get("experiments");if(BB.getUser().get("installAppId")){this._installAppIdFeatures=INSTALL_APP_ID_TO_FEATURE_MAP[BB.getUser().get("installAppId")]}return this._getUserPlan()},_getUserPlan:function(){var self=this;this._currentPlans=BB.Data.getParticipatingPlans();var promise=new Streak.Promise(function(resolve,reject){self._currentPlans.refresh(resolve)});return promise},isFeatureEnabled:function(key){return this._isExperimentEnabled(key)||this._isFeatureInPlan(key)||this._isFeatureInInstallAppId(key)},_isExperimentEnabled:function(experimentName){if(!this._experiments){return false}if(!this._experiments[experimentName]){return false}return this._experiments[experimentName].inExperiment},_isFeatureInPlan:function(key){if(!this._currentPlans||this._currentPlans.length===0){return false}for(var ii=0;ii<this._currentPlans.length;ii++){var features=this._currentPlans[ii].get("features");if(!features){continue}if(features.indexOf(key)>-1){return true}}return false},_isFeatureInInstallAppId:function(key){if(!this._installAppIdFeatures){return}return this._installAppIdFeatures.indexOf(key)>-1}});Streak.DependencyManager.addFunction({functionKey:"enabledFeaturesControllerInitialized",functionReference:function(){var enabledFeaturesController=new EnabledFeaturesController;var promise=enabledFeaturesController.setup();Library.set("BentoBox.EnabledFeaturesController",enabledFeaturesController);return promise},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var fieldCollectionMap={};var stageCollectionMap={};var Pipeline=function(data){Model.call(this,data);this._unsavedView=null;this._uiSettingsObject=null;var self=this;this.watch("set",function(){self._uiSettingsObject=null},this,"uiSettings");this._checkSystemColumnsForCaseIdAndFix()};Pipeline.prototype=Object.create(Model.prototype);_.extend(Pipeline.prototype,{keyName:"pipelineKey",nameProperty:"name",entityType:"Workflow",typeName:"pipeline",createProperties:["name","stageNames","fieldNames","fieldTypes"],apiURLs:{get:"pipelines/<%= pipelineKey %>",update:"pipelines/<%= pipelineKey %>",create:"pipelines","delete":"pipelines/<%= pipelineKey %>"},tagEntityName:"pipeline",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["pipeline_create_noKey","pipelineCollection_noKey"]);break;case"DELETE":return baseTags.concat(["pipeline_delete_noKey","pipelineCollection_noKey"]);break}return baseTags},getRequestDependentOnTags:function(requestType){var baseTags=Model.prototype.getRequestDependentOnTags.call(this,requestType);if(requestType==="DELETE"){baseTags=baseTags.concat(["boxCollection_pipelineKey_"+this.key()])}return baseTags},getResponseObjectAffectingModel:function(response){return response},getCollectionProperties:function(){return["stages","fields"]},getPropertyCollection:function(property){switch(property){case"stages":return this._getStagesCollection();break;case"fields":return this._getFieldsCollection();break}},getResponseForCollection:function(property,response){switch(property){case"stages":return this._getResponseForStageCollection(response);break;case"fields":return this._getResponseForFieldCollection(response);break}},_getStagesCollection:function(){if(!stageCollectionMap[this.getId()]){stageCollectionMap[this.getId()]=BB.Models.Stage.createCollection(this.key())}return stageCollectionMap[this.getId()]},_getFieldsCollection:function(){if(!fieldCollectionMap[this.getId()]){fieldCollectionMap[this.getId()]=BB.Models.PipelineField.createCollection(this)}return fieldCollectionMap[this.getId()]},_getResponseForStageCollection:function(response){var responseArray=[];if(!response.stageOrder){return responseArray}for(var ii=0;ii<response.stageOrder.length;ii++){var stageObject=response.stages[response.stageOrder[ii]];stageObject.pipelineKey=this.key();responseArray.push(stageObject)}return responseArray},_getResponseForFieldCollection:function(response){return response.fields||[]},addStage:function(stageName,callback){var stageModel=BB.Models.Stage.create({name:stageName,pipelineKey:this.key()},this);this.getStages().add(stageModel);var operationProgressId=stageModel.save(callback);Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationIsComplete:true,operationProgressId:operationProgressId},observer:this,unsubscribeImmediately:true,functionToCall:function(){var stageKeys=_.map(this.getStages(),function(stage){return stage.key()});this.set("stageOrder",stageKeys);callback()}})},setStageOrder:function(stageKeys){this.set("stageOrder",stageKeys);var stages=this.getStages();var stageKeyMap={};for(var ii=0;ii<stages.length;ii++){stageKeyMap[stages[ii].key()]=stages[ii]}stages.length=0;for(var ii=0;ii<stageKeys.length;ii++){var stage=stageKeyMap[stageKeys[ii]];if(stage){stages.push(stage)}}},addField:function(field,cb){this.getFields().add(field);var self=this;field.save(function(){self.postNotification({eventName:"fieldAdded",fieldKey:field.key()});cb()})},removeField:function(fieldKey,cb){var field=this.getField(fieldKey);if(field){field.del(cb)}else if(cb){cb()}},getFields:function(){return this._getFieldsCollection()},getField:function(fieldKey){return fieldCollectionMap[this.getId()].getByKey(fieldKey)},getFieldByName:function(fieldName){if(!fieldName){return null}var fields=this._getFieldsCollection();for(var ii=0;ii<fields.length;ii++){if(fields[ii].displayNameText().toLowerCase()===fieldName.toLowerCase()){return fields[ii]}}return null},getStage:function(stageKey){return stageCollectionMap[this.getId()].getByKey(stageKey)},getStageByName:function(stageName){return _.find(this.getStages(),function(stage){return stage.displayName()===stageName})},getStageNamesText:function(){return _.map(this.getStages(),function(stage){return stage.displayNameText()})},getStages:function(){return this._getStagesCollection()},getStageIndex:function(stageKey){return this.get("stageOrder").indexOf(stageKey)},getStagesAsListText:function(){return _.map(this.getStages(),function(stage){return{text:stage.displayNameText(),value:stage.key()}})},addSystemColumn:function(column,uniqueKey,callback,dontSave){var currentSystemColumns=this.getSystemColumns();var ukey=uniqueKey||Date.now()+Math.random()+"";currentSystemColumns.push({property:column.property,uniqueKey:ukey});this.setUISettings("systemColumns",currentSystemColumns,callback,dontSave);return ukey},removeSystemColumn:function(removedColumn){var currentSystemColumns=this.getSystemColumns();var systemColumns=_.filter(currentSystemColumns,function(column){return column.uniqueKey!==removedColumn.uniqueKey});this.setUISettings("systemColumns",systemColumns)},getFilterableSystemColumns:function(){return _.filter(this.getUniqueSystemColumns(),function(systemColumn){return Pipeline.isPropertyFilterable(systemColumn.property)})},getGroupableSystemColumns:function(){return _.filter(this.getUniqueSystemColumns(),function(systemColumn){return Pipeline.isPropertyGroupable(systemColumn.property)})},getUniqueSystemColumns:function(){return _.uniq(this.getActiveSystemColumns(),function(systemColumn){return systemColumn.property})},getSystemColumnByProperty:function(property){var targetColumn;_.each(this.getSystemColumns(),function(column){if(column.property===property){targetColumn=column}});return targetColumn},getSystemColumn:function(propertyOrUniqueKey){return _.find(this.getActiveSystemColumns(),function(column){return propertyOrUniqueKey===column.uniqueKey||propertyOrUniqueKey===column.property})},isDefaultProperty:function(property){return Pipeline.isDefaultProperty(property)},getSystemColumns:function(){var systemColumns=this.getUISettingsByPath("systemColumns");if(_.isUndefined(systemColumns)){systemColumns=[]}var columns=_.map(systemColumns,function(column){var systemProperty=Pipeline.getSystemProperty(column.property);if(systemProperty){return _.extend({},systemProperty,column)}else{return null}});return _.compact(columns)},getActiveSystemColumns:function(){var systemColumns=this.getSystemColumns();var defaultColumns=Pipeline.getDefaultSystemProperties();return defaultColumns.concat(systemColumns)},getAllSystemColumns:function(){var systemColumns=this.getActiveSystemColumns();var defaultColumns=Pipeline.getAllSystemProperties();var combined=systemColumns.concat(defaultColumns);return _.uniq(combined,false,"property")},doesEmailAddressHaveAccess:function(email){var emails=[];if(this.get("aclEntries")&&this.get("aclEntries").length>0){emails=_.map(this.get("aclEntries"),function(aclEntry){return aclEntry.email})}if(emails.indexOf(email)>-1){return true}if(this.get("orgWide")){var emailDomain=email.split("@")[1].split(".")[0];var orgDomain=this.get("organization").organizationId||"";if(emailDomain.toLowerCase()===orgDomain.toLowerCase()){return true}}return false},getUISettingsByPath:function(keyPath){if(!this._uiSettingsObject){this._uiSettingsObject=Streak.ObjectPath.create(this.get("uiSettings"))}return this._uiSettingsObject.get(keyPath)},setUISettings:function(keyPath,value,cb,dontSave){if(!this._uiSettingsObject){this._uiSettingsObject=Streak.ObjectPath.create(this.get("uiSettings"))}this._uiSettingsObject.set(keyPath,value);this.set("uiSettings",this._uiSettingsObject.toString());if(!dontSave){this.save(cb,null,true)}},isHidden:function(){return BB.UserSettings.get("pipeline/"+this.key()+"/uiSettings/leftLink")},setHidden:function(val){BB.UserSettings.set("pipeline/"+this.key()+"/uiSettings/leftLink",val);BB.UserSettings.save();this.postNotification("uiSettingChanged")},setColor:function(color){BB.UserSettings.set("pipeline/"+this.key()+"/uiSettings/indicator/color",color);BB.UserSettings.save(true)},getColor:function(){var color=BB.UserSettings.get("pipeline/"+this.key()+"/uiSettings/indicator/color");if(!color){color={backgroundColor:"rgb(194, 194, 194)",textColor:"rgb(255, 255, 255)"}}return color},isDefaultColor:function(){return!BB.UserSettings.get("pipeline/"+this.key()+"/uiSettings/indicator/color")},getSavedViews:function(){return this.getUISettingsByPath("savedViews/list")||[]},getSavedView:function(viewKey){if(this._unsavedView){if(this._unsavedView.viewKey===viewKey){return this._unsavedView}}return _.find(this.getSavedViews(),function(savedView){return savedView.viewKey===viewKey})},addSavedView:function(viewName,settings){var savedView={name:viewName,viewKey:Date.now()+"."+Math.random(),settings:settings};var savedViews=this.getSavedViews();savedViews.push(savedView);this.setUISettings("savedViews/list",savedViews);this.postNotification("savedViewsChanged");return savedView},updateSavedView:function(savedView,dontSave){if(this._unsavedView&&this._unsavedView.viewKey===savedView.viewKey){_.extend(this._unsavedView,savedView);this.postNotification("savedViewsChanged");return}var savedViews=this.getSavedViews();for(var ii=0;ii<savedViews.length;ii++){if(savedViews[ii].viewKey===savedView.viewKey){_.extend(savedViews[ii],savedView);break}}this.setUISettings("savedViews/list",savedViews,null,dontSave);this.postNotification("savedViewsChanged");this.postNotification({eventName:"savedViewChanged",viewKey:savedView.viewKey})},setUnsavedView:function(settings){this._unsavedView={name:"("+BB.Locale.getString("unsaved_view")+")",viewKey:Streak.guid(),settings:settings,isUnsaved:true};this.postNotification("savedViewsChanged");return this._unsavedView},clearUnsavedView:function(){this._unsavedView=null;this.postNotification("savedViewsChanged")},getUnsavedView:function(){return this._unsavedView},doesHaveUnsavedView:function(){return!!this._unsavedView},getCollaborationStatus:function(){if(BB.isFeatureEnabled("unlimitedCollaborators")){return"OK"}if(!this.get("firstInvalidTimestamp")&&!this.get("validSinceTimestamp")){return"OK"}else if(this.get("validSinceTimestamp")){return"OK"}else if(this.get("firstInvalidTimestamp")){var now=new Streak.Date;var endOfWarningPeriod=this.get("endOfWarningPeriod");if(now<=endOfWarningPeriod){return"WARNING"}else{return"LOCKDOWN"}}},getNumberOfDaysUntilLockdown:function(){var now=new Streak.Date;var endOfWarningPeriod=this.get("endOfWarningPeriod");var exactDaysRemaining=(endOfWarningPeriod-now)/1e3/60/60/24;return Math.ceil(exactDaysRemaining)},getIsEditable:function(){return this.getCollaborationStatus()!=="LOCKDOWN"},_checkSystemColumnsForCaseIdAndFix:function(){var columnsChanged=false;var systemColumns=this.getUISettingsByPath("systemColumns");if(!systemColumns){return}for(var ii=0;ii<systemColumns.length;ii++){var column=systemColumns[ii];if(column&&column.property==="caseId"){column.property="boxId";columnsChanged=true}}if(columnsChanged){this.setUISettings("systemColumns",systemColumns,null,true)}},isSharingRestrictedToOrg:function(callback){if(this.get("sharingRestrictedToOrg")){callback(true);return}},didBillingAdminRestrictSharingToOrg:function(){return Streak.APIRequester.get("users/"+this.get("creatorKey")+"/billingadmin").getPromise().then(function(response){return response&&response.billingAdminSettings&&response.billingAdminSettings.externalSharingRestrictionOnTeamsPipelines},function(){return false})},getAllAssignedToValues:function(){var boxes=BB.Data.getPipelineBoxes(this.key());return _(boxes).chain().map(function(box){return box.getAssignedToSharingEntries()}).flatten().filter(function(value){return _.isReal(value)&&_.isReal(value.displayName)}).map(function(value){var ret={value:value,display:value.displayName,normalized:null};return ret}).sortBy(function(ret){return ret.display.toLowerCase()}).uniq(false,function(ret){return ret.value.email}).value()}});Pipeline.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"pipelineKey",apiURL:"pipelines?includeCollaborators=true",requestTags:["pipelineCollection_noKey"],requestDependentOnTags:["pipelineCollection_noKey"],refreshRequeueOperationTags:["pipeline_create_noKey","pipeline_delete_noKey"],createModelFromRawJSON:Pipeline.create});return c};Pipeline.create=function(data){return new Pipeline(data)};BB.Models.Pipeline=Pipeline})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Template=Streak.Template,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var Pipeline=BB.Models.Pipeline;var systemProperties=[{name:"system_name",property:"name",type:"TEXT",filterAndGroupType:"TEXT",sortType:"TEXT",summaryType:"NONE",isEditable:true,isDefault:true,isGroupable:false,isFilterable:true},{name:"system_stage",property:"stageKey",type:"SIMPLE_DROPDOWN",filterAndGroupType:"STAGE",sortType:"TEXT",summaryType:"NONE",isEditable:true,isDefault:true,isGroupable:true,isFilterable:true,sortFunction:function(box){return box.getPipeline().getStageIndex(box.get("stageKey"))},textValueFunction:function(box){return box.getStage().displayNameText()},filterValueFunction:function(box){return this.textValueFunction(box)}},{name:"system_notes",property:"notes",type:"TEXT_INPUT",filterAndGroupType:"TEXT",sortType:"TEXT",summaryType:"BASIC",isEditable:true,isDefault:true,isGroupable:false,isFilterable:true,textValueFunction:function(box){return box.get("notes")}},{name:"system_id",property:"boxId",type:"NUMBER",filterAndGroupType:"NUMBER",sortType:"NUMBER",summaryType:"BASIC",group:"ID",isGroupable:false,isFilterable:true},{name:"system_created",property:"creationTimestamp",type:"DATE",filterAndGroupType:"DATE",sortType:"DATE",summaryType:"DATE",group:"DATE",isGroupable:true,isFilterable:true},{name:"system_updated",property:"lastUpdatedTimestamp",type:"DATE",filterAndGroupType:"DATE",sortType:"DATE",summaryType:"DATE",group:"DATE",isGroupable:true,isFilterable:true},{name:"system_last_stage_change",property:"lastStageChangeTimestamp",type:"DATE",filterAndGroupType:"DATE",sortType:"DATE",summaryType:"DATE",group:"DATE",isGroupable:true,isFilterable:true},{name:"system_followers",property:"followerCount",type:"NUMBER",filterAndGroupType:"NUMBER",sortType:"NUMBER",summaryType:"BASIC",group:"COUNT",isGroupable:true,isFilterable:true},{name:"system_comments",property:"commentCount",type:"NUMBER",filterAndGroupType:"NUMBER",sortType:"NUMBER",summaryType:"BASIC",group:"COUNT",isGroupable:true,isFilterable:true},{name:"system_reminder_count",property:"reminderCount",type:"NUMBER",group:"COUNT",filterAndGroupType:"NUMBER",summaryType:"BASIC",sortType:"NUMBER",isGroupable:true,isFilterable:true},{name:"system_file_count",property:"fileCount",type:"NUMBER",group:"COUNT",filterAndGroupType:"NUMBER",summaryType:"BASIC",sortType:"NUMBER",isGroupable:true,isFilterable:true},{name:"system_last_email",property:"lastEmailUpdatedTimestamp",type:"DATE",group:"DATE",filterAndGroupType:"DATE",summaryType:"DATE",sortType:"DATE",isGroupable:true,isFilterable:true},{name:"system_next_reminder",property:"soonestReminderTimestamp",type:"DATE",group:"DATE",filterAndGroupType:"DATE",summaryType:"DATE",sortType:"DATE",isGroupable:true,isFilterable:true},{name:"system_thread_count",property:"gmailThreadCount",type:"NUMBER",filterAndGroupType:"NUMBER",sortType:"NUMBER",summaryType:"BASIC",group:"COUNT",isGroupable:true,isFilterable:true},{name:"system_email_addresses",property:"emailAddresses",type:"COMPUTED",filterAndGroupType:"TEXT",sortType:"TEXT",summaryType:"LIST",isEditable:false,isGroupable:false,isFilterable:true,group:"A_COUNT",computeFunction:function(box){var retVal="";var val=_.without(box.get("emailAddresses")||[],BB.userEmail);for(var ii=0;ii<val.length;ii++){retVal+='<span class="people" email="'+val[ii]+'">'+val[ii]+(ii===val.length-1?"":",")+"</span>"}return retVal},sortFunction:function(box){return _.without(box.get("emailAddresses")||[],BB.userEmail).join(",")},groupByFunction:function(box){return _.without(box.get("emailAddresses")||[],BB.userEmail)},textValueFunction:function(box){return _.without(box.get("emailAddresses")||[],BB.userEmail).join(",")}},{name:"system_assigned_to",property:"assignedToSharingEntries",type:"COMPUTED",filterAndGroupType:"PERSON",sortType:"PERSON",summaryType:"LIST",isEditable:true,isGroupable:true,isFilterable:true,group:"A_ASSIGNED",computeFunction:function(box){var retVal="";var val=box.get("assignedToSharingEntries");_.each(val,function(contact){if(!contact.displayName){contact.displayName=contact.fullName||contact.email||""}var emailString="";if(contact.email){emailString='email="'+contact.email+'"'}var iUrl=contact.imageUrl?contact.imageUrl:contact.image;iUrl=iUrl?iUrl.unescapeHTML():Streak.server+Streak.combinedPath+"images/unknownContact.png";var cEl='<img class="people" height="23" width="23" src="'+iUrl+'" title="'+contact.displayName+'">';cEl+='<span class="people" '+emailString+">"+contact.displayName+"</span>";retVal+=cEl});return retVal},sortFunction:function(box){var val=box.get("assignedToSharingEntries");return _(val).chain().map(function(contact){if(contact.displayName){return contact.displayName
}return contact.email}).sortBy(function(contactString){return contactString}).join(", ").value()},groupByFunction:function(box){var val=box.get("assignedToSharingEntries");if(val&&val.length>0){return _.pluck(val,"email")}return null},textValueFunction:function(box){var list=box.get("assignedToSharingEntries");var retList=[];if(list&&list.length>0){_.each(list,function(contact){if(contact.fullName){retList.push(contact.fullName+" <"+contact.email+">")}else{retList.push(contact.email)}})}return retList.join(", ")}},{name:"system_summary",property:"summaryCount",type:"COMPUTED",sortType:"NUMBER",summaryType:"NONE",group:"A_COUNT",isGroupable:false,isFilterable:false,computeFunction:function(box){return Template.underscore("core/models/pipeline/systemSummary")({fileCount:box.getProcessedHTMLValue("fileCount"),reminderCount:box.getProcessedHTMLValue("reminderCount"),gmailThreadCount:box.getProcessedHTMLValue("gmailThreadCount"),commentCount:box.getProcessedHTMLValue("commentCount")})},sortFunction:function(box){return[parseFloat(box.getSortValue("gmailThreadCount")),parseFloat(box.getSortValue("fileCount")),parseFloat(box.getSortValue("commentCount")),parseFloat(box.getSortValue("reminderCount"))]},textValueFunction:function(box){return Template.underscore("core/models/pipeline/systemSummaryText")({fileCount:box.getProcessedHTMLValue("fileCount"),reminderCount:box.getProcessedHTMLValue("reminderCount"),gmailThreadCount:box.getProcessedHTMLValue("gmailThreadCount"),commentCount:box.getProcessedHTMLValue("commentCount")}).trim()}},{name:"system_freshness",property:"freshness",type:"COMPUTED",group:"A_COUNT",isGroupable:true,isFilterable:true,filterAndGroupType:"NUMBER",sortType:"NUMBER",summaryType:"BASIC",computeFunction:function(box){var roundedValue=this._getRoundedValue(box);var returnStringArray=['<div class="__streak__FreshnessIndicator">'];for(var ii=0;ii<5;ii++){returnStringArray.push("<span");if(ii<roundedValue){returnStringArray.push(' class="__streak__FreshnessIndicatorFresh"')}returnStringArray.push("></span>")}returnStringArray.push("</div>");return returnStringArray.join("")},sortFunction:function(box){return box.get("freshness")},groupByFunction:function(box){return this.textValueFunction(box)},filterValueFunction:function(box){return this.textValueFunction(box)},textValueFunction:function(box){return this._getRoundedValue(box)+""},_getRoundedValue:function(box){var val=box.get("freshness");try{val=parseFloat(val);return Math.round(val*5)}catch(err){}return 0}}];var getSystemProperty=function(property){for(var i=0;i<systemProperties.length;i++){if(property===systemProperties[i].property){return systemProperties[i]}}return null};Pipeline.systemProperties=systemProperties;_.extend(Pipeline,{getDefaultSystemProperties:function(){var props=[];_.each(systemProperties,function(prop){if(prop.isDefault){_translateSystemProperty(prop);props.push(prop)}});return props},getExtraSystemProperties:function(){var props=[];_.each(systemProperties,function(prop){if(!prop.isDefault&&!prop.isLinkedProperty){_translateSystemProperty(prop);props.push(prop)}});return props},getLinkedBoxProperties:function(){var props=[];_.each(systemProperties,function(prop){if(prop.isLinkedProperty){_translateSystemProperty(prop);props.push(prop)}});return props},getAllSystemProperties:function(){return Pipeline.getDefaultSystemProperties().concat(Pipeline.getExtraSystemProperties()).concat(Pipeline.getLinkedBoxProperties())},getFilterableSystemProperties:function(){var props=[];_.each(systemProperties,function(prop){if(prop.isFilterable){_translateSystemProperty(prop);props.push(prop)}});return props},getGroupableSystemProperties:function(){var props=[];_.each(systemProperties,function(prop){if(prop.isGroupable){_translateSystemProperty(prop);props.push(prop)}});return props},isDefaultProperty:function(property){var systemProperty=getSystemProperty(property);if(_.isNull(systemProperty)||_.isUndefined(systemProperty)){return false}return!!systemProperty.isDefault},getSystemProperty:function(property){var systemProperty=getSystemProperty(property);if(systemProperty){_translateSystemProperty(systemProperty);return systemProperty}return null},getSystemPropertyByName:function(propertyName){if(!propertyName){return null}var systemProperties=Pipeline.getAllSystemProperties();for(var i=0;i<systemProperties.length;i++){if(propertyName.toLowerCase()===systemProperties[i].name.toLowerCase()){return systemProperties[i]}}return null},getPropertyName:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.name}return property},getPropertyType:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.type}return null},getPropertyFilterAndGroupType:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.filterAndGroupType}return null},getPropertySortType:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.sortType}return null},isPropertyEditable:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.isEditable}return false},isPropertyGroupable:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.isGroupable}return false},isPropertyFilterable:function(property){var systemProperty=this.getSystemProperty(property);if(systemProperty){return systemProperty.isFilterable}return false}});function _translateSystemProperty(systemProperty){if(!systemProperty.title){systemProperty.title=BB.Locale.getString(systemProperty.name);systemProperty.name=BB.Locale.getString(systemProperty.name)}}})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;BB.Models.Pipeline.Templates={get:function(path){var pathParts=path.split("/");if(pathParts.length>1){var group=this.definitions[pathParts[0]];if(group){var template=group.templates[pathParts[1]];if(!template.translated){template.friendlyName=BB.Locale.getString(template.friendlyName);for(var i=0;i<template.stageNames.length;i++){template.stageNames[i]=BB.Locale.getString(template.stageNames[i])}for(var i=0;i<template.fields.length;i++){template.fields[i].name=BB.Locale.getString(template.fields[i].name)}template.translated=true}return template}}},getAll:function(){},definitions:{business:{name:"pipeline_template_group_business",templates:{sales:{friendlyName:"pipeline_template_sales_name",stageNames:["pipeline_template_stage_lead","pipeline_template_stage_prospect","pipeline_template_stage_needs","pipeline_template_stage_presentation","pipeline_template_stage_objections","pipeline_template_stage_negotiation","pipeline_template_stage_closed_won","pipeline_template_stage_closed_lost"],fields:[{name:"pipeline_template_field_amount",type:"TEXT_INPUT"}],systemProperties:["assignedToSharingEntries"]},hiring:{friendlyName:"pipeline_template_hiring_name",stageNames:["pipeline_template_stage_resume","pipeline_template_stage_phone","pipeline_template_stage_interview","pipeline_template_stage_negotiation","pipeline_template_stage_hired","pipeline_template_stage_passed","pipeline_template_stage_rejected"],fields:[{name:"pipeline_template_field_position",type:"TEXT_INPUT"},{name:"pipeline_template_field_start_date",type:"DATE"}],systemProperties:["assignedToSharingEntries"]},support:{friendlyName:"pipeline_template_support_name",stageNames:["pipeline_template_stage_new","pipeline_template_stage_assigned","pipeline_template_stage_working","pipeline_template_stage_resolved"],fields:[{name:"pipeline_template_field_priority",type:"TEXT_INPUT"}],systemProperties:["assignedToSharingEntries"]},productDevelopment:{friendlyName:"pipeline_template_product_development_name",stageNames:["pipeline_template_stage_idea","pipeline_template_stage_spec","pipeline_template_stage_working","pipeline_template_stage_launched"],fields:[{name:"pipeline_template_field_priority",type:"TEXT_INPUT"},{name:"pipeline_template_field_due_date",type:"DATE"}],systemProperties:["assignedToSharingEntries"]},bugTracking:{friendlyName:"pipeline_template_bug_tracking_name",stageNames:["pipeline_template_stage_reported","pipeline_template_stage_reproducible","pipeline_template_stage_working","pipeline_template_stage_launched"],fields:[{name:"pipeline_template_field_priority",type:"TEXT_INPUT"},{name:"pipeline_template_field_due_date",type:"DATE"}],systemProperties:["assignedToSharingEntries"]},dealflow:{friendlyName:"pipeline_template_dealflow_name",stageNames:["pipeline_template_stage_lead","pipeline_template_stage_pitched","pipeline_template_stage_term_sheet","pipeline_template_stage_signed","pipeline_template_stage_passed"],fields:[{name:"pipeline_template_field_amount",type:"TEXT_INPUT"},{name:"pipeline_template_field_valuation",type:"TEXT_INPUT"}],systemProperties:["assignedToSharingEntries"]},fundraising:{friendlyName:"pipeline_template_fundraising_name",stageNames:["pipeline_template_stage_lead","pipeline_template_stage_pitched","pipeline_template_stage_term_sheet","pipeline_template_stage_signed","pipeline_template_stage_money"],fields:[{name:"pipeline_template_field_amount",type:"TEXT_INPUT"},{name:"pipeline_template_field_valuation",type:"TEXT_INPUT"},{name:"pipeline_template_field_lead",type:"PERSON"}],systemProperties:["assignedToSharingEntries"]}}},personal:{name:"pipeline_template_group_personal",templates:{todo:{friendlyName:"pipeline_template_todo_name",stageNames:["pipeline_template_stage_todo","pipeline_template_stage_working","pipeline_template_stage_done"],fields:[{name:"pipeline_template_field_priority",type:"TEXT_INPUT"}]},jobHunting:{friendlyName:"pipeline_template_job_hunting_name",stageNames:["pipeline_template_stage_applied","pipeline_template_stage_interview","pipeline_template_stage_negotiation","pipeline_template_stage_signed","pipeline_template_stage_passed","pipeline_template_stage_rejected"],fields:[{name:"pipeline_template_field_salary",type:"TEXT_INPUT"},{name:"pipeline_template_field_start_date",type:"DATE"}]},apartmentHunting:{friendlyName:"pipeline_template_apartment_hunting_name",stageNames:["pipeline_template_stage_interested","pipeline_template_stage_viewing","pipeline_template_stage_applied","pipeline_template_stage_negotiation","pipeline_template_stage_signed","pipeline_template_stage_passed"],fields:[{name:"pipeline_template_field_rent",type:"TEXT_INPUT"},{name:"pipeline_template_field_start_date",type:"DATE"},{name:"pipeline_template_field_landlord",type:"PERSON"}]},lending:{friendlyName:"pipeline_template_lending_name",stageNames:["pipeline_template_stage_lent","pipeline_template_stage_notified","pipeline_template_stage_paid_back"],fields:[{name:"pipeline_template_field_amount",type:"TEXT_INPUT"}]},tripPlanning:{friendlyName:"pipeline_template_trip_name",stageNames:["pipeline_template_stage_options","pipeline_template_stage_researched","pipeline_template_stage_booking","pipeline_template_stage_booked","pipeline_template_stage_paid"],fields:[{name:"pipeline_template_field_amount",type:"TEXT_INPUT"}]}}},custom:{name:"pipeline_template_group_custom",templates:{blank:{friendlyName:"pipeline_template_blank_name",stageNames:["pipeline_template_stage_default"],fields:[]}}}}}})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,BB=Streak.BentoBox;var PipelineField=function(data,syncParent){Model.call(this,data);this.pipeline=syncParent;this.syncParent=syncParent};PipelineField.prototype=Object.create(Model.prototype);_.extend(PipelineField.prototype,{keyName:"key",entityType:"Field",createProperties:["name","type","pipelineKey"],modifyProperties:["key","pipelineKey"],nameProperty:"name",apiURLs:{create:"pipelines/<%= pipelineKey %>/fields",update:"pipelines/<%= pipelineKey %>/fields/<%= key %>","delete":"pipelines/<%= pipelineKey %>/fields/<%= key %>"},tagEntityName:"pipelineField",getExtraRequestParameters:function(){return{pipelineKey:this.pipeline.key()}},getResponseObjectAffectingModel:function(response){if(response.fields){for(var ii=0;ii<response.fields.length;ii++){if(response.fields[ii].key===this.key()){return response.fields[ii]}}}return response}});PipelineField.create=function(data,syncParent){return BB.Models.BoxField.createPipelineFieldModel(data,syncParent)};PipelineField.createCollection=function(pipeline){var c=new Streak.Collection;c.init({modelKeyPropertyName:"key",createModelFromRawJSON:function(data){return BB.Models.BoxField.createPipelineFieldModel(data,pipeline)}});return c};BB.Models.PipelineField=PipelineField})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineFormulaField=Streak.Class.subclass({className:"PipelineFormulaField",superclass:BB.Models.PipelineField,_memberVariables:[{name:"_formulaObject",destroy:false}],_initialize:function(){BB.Models.PipelineField.prototype._initialize.call(this)},getFormula:function(){return this.get("defaultValue")},getRelevantFormula:function(scope,stageKey,box){this._formulaObject=null;if(scope==="BOX"){var boxFieldValue=box.getFieldValue(this.key());if(!boxFieldValue){return""}if(boxFieldValue.formula){return boxFieldValue.formula}return""}var formulaObject=this._getFormulaObject();if(scope==="STAGE"){if(formulaObject[stageKey]){return formulaObject[stageKey]}return""}if(scope==="ALL"){if(formulaObject["ALL"]){return formulaObject["ALL"]}return""}},doesFormulaSectionExistForBox:function(box){var boxFieldValue=box.getFieldValue(this.key());if(!boxFieldValue){return false}if(boxFieldValue.formula){return true}return false},doesFormulaSectionExistForStage:function(stageKey){return _.isReal(this._getFormulaObject()[stageKey])},setAndSaveFormulaSection:function(scope,stageKey,box,value){switch(scope){case"ALL":this._setAndSaveColumnLevelFormula(box,stageKey,value);break;case"STAGE":this._setAndSaveStageLevelFormula(box,stageKey,value);break;case"BOX":this._setAndSaveBoxLevelFormula(box,value);break}},_setAndSaveColumnLevelFormula:function(box,stageKey,value){var boxSaveOperation;if(this.doesFormulaSectionExistForBox(box)){var boxSaveOperationId=this._setAndSaveBoxLevelFormula(box,"");this._addSetPendingWatcher(box,boxSaveOperationId)}var fieldFormulaObject=this._getFormulaObject();delete fieldFormulaObject[stageKey];fieldFormulaObject["ALL"]=value;this.set("defaultValue",this._processFormulaObjectBackIntoFormulaString(fieldFormulaObject));this.save()},_setAndSaveStageLevelFormula:function(box,stageKey,value){if(this.doesFormulaSectionExistForBox(box)){this._setAndSaveBoxLevelFormula(box,"")}var fieldFormulaObject=this._getFormulaObject();fieldFormulaObject[stageKey]=value;this.set("defaultValue",this._processFormulaObjectBackIntoFormulaString(fieldFormulaObject));this.save()},_setAndSaveBoxLevelFormula:function(box,value){var boxFieldModel=box.getFieldModel(this.key());var currentFieldValue=box.getFieldValue(this.key());if(!currentFieldValue){currentFieldValue={}}currentFieldValue.formula=PipelineFormulaField.serverfyColumnFunctions(value,this.pipeline);boxFieldModel.set("value",currentFieldValue);return boxFieldModel.save()},_addSetPendingWatcher:function(box,boxSaveOperationId){var fieldKey=this.key();Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:boxSaveOperationId,operationIsComplete:true},unsubscribeImmediately:true,functionToCall:function(){box.markFieldCalculating(fieldKey)},observer:this})},_getFormulaObject:function(){if(!this._formulaObject){this._formulaObject=this._processFormulaIntoFormulaObject(this.get("defaultValue"))}return this._formulaObject},_processFormulaObjectBackIntoFormulaString:function(formulaObject){var formula="";keys=_.keys(formulaObject);if(!keys||keys.length===0){return formula}for(var ii=0;ii<keys.length;ii++){var group=keys[ii];if(group==="ALL"){continue}if(ii>0){formula+="else "}formula+='if(col("stageKey")==="'+keys[ii]+'"){ //STREAK_START_SECTION '+keys[ii]+" \n";formula+=PipelineFormulaField.serverfyColumnFunctions(formulaObject[keys[ii]],this.pipeline)+"\n";formula+="} //STREAK_END_SECTION\n"}if(formulaObject["ALL"]){if(keys.length>1){formula+="else{ //STREAK_START_SECTION ALL \n";formula+=PipelineFormulaField.serverfyColumnFunctions(formulaObject["ALL"],this.pipeline)+"\n";formula+="} //STREAK_END_SECTION\n"}else{formula=PipelineFormulaField.serverfyColumnFunctions(formulaObject["ALL"],this.pipeline)}}return formula},_processFormulaIntoFormulaObject:function(formulaString){var formulaObject={};if(!formulaString){return formulaObject}var lines=formulaString.split(/\r|\n/);var currentSectionLines=[];var currentGroup=null;var currentLine=null;var self=this;var sm=createStateMachine({ongroupSectionFound:function(){currentSectionLines=[];currentGroup=extractGroupFromLine(currentLine)},onendGroupFound:function(){formulaObject[currentGroup]=PipelineFormulaField.prettifyColumnFunctions(currentSectionLines.join("\n"),self.pipeline);currentSectionLines=null}});for(var ii=0;ii<lines.length;ii++){currentLine=lines[ii].trim();if(isLineStartOfSection(currentLine)){sm.groupSectionFound()}else if(isLineEndOfSection(currentLine)){sm.endGroupFound()}else if(currentSectionLines){currentSectionLines.push(currentLine)}}if(currentSectionLines&&!formulaObject["ALL"]){formulaObject["ALL"]=PipelineFormulaField.prettifyColumnFunctions(currentSectionLines.join("\n"),this.pipeline)}return formulaObject}});PipelineFormulaField.serverfyColumnFunctions=function(formulaSection,pipeline){if(!formulaSection){return formulaSection}return formulaSection.replace(/\$(\'|\")(.+?)(\'|\")/gi,function(fullMatchedTag,firstQuote,columnKey){var newColumnKey=columnKey;if(columnKey.toLowerCase()===BB.Locale.getString("stage").toLowerCase()){newColumnKey="stageName"}else if(columnKey.toLowerCase()===BB.Locale.getString("all_linked_boxes").toLowerCase()){newColumnKey="linkedBoxKeys"}else{var field=pipeline.getFieldByName(columnKey);if(field){newColumnKey=field.key()}var propertyDefinition=BB.Models.Pipeline.getSystemPropertyByName(columnKey);if(propertyDefinition){newColumnKey=propertyDefinition.property}}return"col("+firstQuote+newColumnKey+firstQuote+")"})};PipelineFormulaField.prettifyColumnFunctions=function(formulaSection,pipeline){if(!formulaSection){return formulaSection}return formulaSection.replace(/col\((\'|\")(.+?)(\'|\")\)/gi,function(fullMatchedTag,firstQuote,columnKey){var newColumnKey=columnKey;if(columnKey.toLowerCase()==="linkedboxkeys"){newColumnKey=BB.Locale.getString("all_linked_boxes")}else if(columnKey.toLowerCase()==="stagename"){newColumnKey=BB.Locale.getString("stage")}else{var field=pipeline.getField(columnKey);if(field){newColumnKey=field.displayNameText()}var propertyDefinition=BB.Models.Pipeline.getSystemProperty(columnKey);if(propertyDefinition){newColumnKey=propertyDefinition.name}}return"$"+firstQuote+newColumnKey+firstQuote})};function createStateMachine(callbacks){return Streak.StateMachine.create({initial:"start",events:[{name:"groupSectionFound",from:["start"],to:"inGroupSection"},{name:"endGroupFound",from:["inGroupSection"],to:"start"}],callbacks:callbacks})}function isLineStartOfSection(line){return line.indexOf("{ //STREAK_START_SECTION")>-1}function isLineEndOfSection(line){return line.indexOf("} //STREAK_END_SECTION")===0}function extractGroupFromLine(line){return line.replace(/.*?\/\/STREAK_START_SECTION (.*?)\s*$/,"$1")}function getStatusValuesOfBoxesForSection(boxes,section,fieldKey){return _.chain(boxes).filter(function(box){return section==="ALL"||box.get("stageKey")===section}).map(function(box){var value=box.getFieldValue(fieldKey);if(!value){return value}switch(value.calculationStatus){case"SUCCESS":case"NOT_ATTEMPTED":return value.calculationStatus;break;default:return"ERROR"}}).value()}function isFormulaSectionEmpty(formulaObject,section){var sectionFormula=formulaObject[section];return!sectionFormula}function checkAllStatus(statusValues,status){return _.all(statusValues,function(statusValue){return statusValue===status})}function checkAnyStatus(statusValues,status){return _.any(statusValues,function(statusValue){return statusValue===status})}Library.set("BentoBox.Models.PipelineFormulaField",PipelineFormulaField)})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,BB=Streak.BentoBox;var PipelineDropdownField=function(data,syncParent){BB.Models.PipelineField.apply(this,[data,syncParent])};PipelineDropdownField.prototype=Object.create(BB.Models.PipelineField.prototype);_.extend(PipelineDropdownField.prototype,{_propertyName:"dropdownSettings",getOptions:function(){return _(this.get(this._propertyName).items).chain().filter(function(item){return!!item.key}).sortBy(function(item){return item.name}).value()},getOption:function(key){if(!key){return null}var options=this.getOptions();for(var ii=0;ii<options.length;ii++){if(options[ii].key===key){return options[ii]}}return{name:key}},getOptionByName:function(optionName){var options=this.getOptions();for(var ii=0;ii<options.length;ii++){if(options[ii].name===optionName){return options[ii]}}return null},addOption:function(optionName){var settings=_.clone(this.get(this._propertyName));settings.items.push({name:optionName});this.set(this._propertyName,settings)},addOptionAndSet:function(optionName,boxField){this.addOption(optionName);BB.Models.PipelineColumnAddOptionOperationManager.addOptionSetOnBox(this,optionName,boxField)}});BB.Models.PipelineDropdownField=PipelineDropdownField})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,BB=Streak.BentoBox;var PipelineTagField=function(data,syncParent){BB.Models.PipelineField.apply(this,[data,syncParent])};PipelineTagField.prototype=Object.create(BB.Models.PipelineField.prototype);_.extend(PipelineTagField.prototype,{_propertyName:"tagSettings",getOptions:function(){return _(this.get(this._propertyName).tags).chain().filter(function(item){return!!item.key}).sortBy(function(item){return item.tag.toLowerCase()}).value()},getOption:function(key){if(!key){return null}var options=this.getOptions();for(var ii=0;ii<options.length;ii++){if(options[ii].key===key){return options[ii]}}return{tag:key}},getOptionByName:function(optionName){var options=this.getOptions();for(var ii=0;ii<options.length;ii++){if(options[ii].tag===optionName){return options[ii]}}return null},updateTags:function(newTagsToBeCreated,newTagKeySet,boxField){if(newTagsToBeCreated.length===0){var currentTagKeys=boxField.get("value");if(!_.isArrayDifferentSet(newTagKeySet,currentTagKeys)){return}boxField.set("value",newTagKeySet);boxField.save();return}if(_.isArrayDifferentSet(newTagKeySet,currentTagKeys)){BB.Models.PipelineColumnAddTagOperationManager.createTagsAndUpdateBoxField(newTagsToBeCreated,this,newTagKeySet,boxField)}else{this._saveNewTags(newTagsToBeCreated)}},_saveNewTags:function(newTagsToBeCreated){var newTagSettings=_.clone(this.get("tagSettings"));newTagSettings.tags=_.chain(newTagsToBeCreated).map(function(tagName){return{tag:tagName}}).concat(newTagSettings.tags).value();this.set("tagSettings",newTagSettings);this.save()}});BB.Models.PipelineTagField=PipelineTagField})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var Pipeline=BB.Models.Pipeline;var PipelineLinkedBoxesProperty=Streak.Class.subclass({superclass:Streak.Object,_initialize:function(){this._setupBinding();return this},_setupBinding:function(){var self=this;var pipelines=BB.Data.getAllPipelines();_.each(pipelines,function(pipeline){self._generateSystemPropertyDefinition(pipeline)});pipelines.watch("add",function(notification){if(notification.model&&notification.model.key()){self._generateSystemPropertyDefinition(notification.model)}},this);NotificationCenter.subscribe({eventName:"set",filterParameters:{sender:pipelines,property:"key"},functionToCall:function(notification){if(notification.model&&notification.model.key()){self._generateSystemPropertyDefinition(notification.model)}},observer:this});self._generateSystemPropertyDefinition()},_generateSystemPropertyDefinition:function(pipeline){var baseDefinition=_.clone(linkedBoxSystemPropertyDefinition);if(pipeline){baseDefinition.title=pipeline.displayName();baseDefinition.property="linkedBoxes."+pipeline.key()}else{baseDefinition.title=BB.Locale.getString("all_linked_boxes");baseDefinition.property="linkedBoxes"}baseDefinition.name=baseDefinition.title;Pipeline.systemProperties.push(baseDefinition)}});var linkedBoxSystemPropertyDefinition={type:"COMPUTED",sortType:"TEXT",filterAndGroupType:"TEXT",summaryType:"LIST",isEditable:true,isGroupable:true,isFilterable:true,isLinkedProperty:true,group:"Z_LINKED_BOXES",computeFunction:function(box){var linkedBoxes=_getLinkedBoxesForPipeline(box,this);var number=linkedBoxes.length;if(number===0){return""}var retString=[];retString.push('<span class="streak__linkedBoxes_wrapper');if(number>1){retString.push(" streak__linkedBoxes_wrapper_moreThanOne")}retString.push('">');retString.push('<span class="streak__linkedBoxes_names">');for(var ii=0;ii<linkedBoxes.length;ii++){retString.push('<span class="streak__linkedBoxes_name">');if(ii>0){retString.push(", ")}retString.push(linkedBoxes[ii].displayName());retString.push("</span>")}retString.push("</span>");if(number>1){retString.push('<span class="streak__linkedBoxes_numberOfBoxes">');retString.push("("+number+")");retString.push("</span>")}retString.push("</span>");return retString.join("")},textValueFunction:function(box){var boxes=_getLinkedBoxesForPipeline(box,this);return _.map(boxes,function(box){return box.displayName()}).join(", ")},filterValueFunction:function(box){var boxes=_getLinkedBoxesForPipeline(box,this);return _.map(boxes,function(box){return box.displayName()}).join(" ")},groupByFunction:function(box){var boxes=_getLinkedBoxesForPipeline(box,this);return _.map(boxes,function(box){return box.displayName()})},sortFunction:function(box){var boxes=_getLinkedBoxesForPipeline(box,this);return _.map(boxes,function(box){return box.displayName()}).join(" ")}};function _getLinkedBoxesForPipeline(box,definition){var parts=definition.property.split(".");var pipelineKey;if(parts.length>1){pipelineKey=definition.property.split(".")[1]}var boxKeys=box.get("linkedBoxKeys");return _.chain(boxKeys).map(function(boxKey){return BB.Data.getBox(boxKey)}).filter(function(linkedBox){return linkedBox&&(!pipelineKey||linkedBox.getPipeline().key()===pipelineKey)}).sort(function(box){return box.displayName()}).value()}Pipeline.getLinkedBoxSystemColumn=function(pipeline){if(pipeline){return Pipeline.getSystemProperty("linkedBoxes."+pipeline.key())}return Pipeline.getSystemProperty("linkedBoxes")};Streak.DependencyManager.addFunction({functionKey:"pipelineLinkedBoxesPropertyInitialized",functionToCall:function(callback){Streak.Library.set("BentoBox.Models.Pipeline.PipelineLinkedBoxesProperty",new PipelineLinkedBoxesProperty);if(callback){callback()}},dependentFunctionKeys:["data.pipelines.collectionCreated","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Operations=Streak.Operations,OperationQueue=Streak.Operations.OperationQueue.Singleton;var PipelineColumnAddOptionOperationManager=Streak.Class.subclass({className:"PipelineColumnAddOptionOperationManager",superclass:Operations.ModelOperationManager,_memberVariables:[],_initialize:function(){Streak.Operations.ModelOperationManager.prototype._initialize.call(this)},addOptionSetOnBox:function(pipelineField,optionName,boxField){var dependentTagGuid=Streak.guid();var pipelineFieldEditOperations=pipelineField.getEditOperations();var pipelineFieldSaveOperation=this._createSaveModelOperation(pipelineField,pipelineFieldEditOperations);pipelineFieldSaveOperation.optionName=optionName;this._markEditOperations(pipelineFieldEditOperations,pipelineFieldSaveOperation);pipelineFieldSaveOperation.getTags().push(dependentTagGuid);pipelineFieldSaveOperation.getDependentOnTags().push(dependentTagGuid);var boxFieldEditOperations=boxField.getEditOperations();var previousValue=boxField.get("value");boxFieldEditOperations.push({property:"value",waitingForKey:true,value:optionName,placeHolder:optionName});boxField.sendOutChangeNotifications("value",previousValue,optionName);var boxFieldSaveOperation=this._createSaveModelOperation(boxField,boxFieldEditOperations);this._markEditOperations(boxFieldEditOperations,boxFieldSaveOperation);boxFieldSaveOperation.getTags().push(dependentTagGuid);boxFieldSaveOperation.getDependentOnTags().push(dependentTagGuid);pipelineFieldSaveOperation.setFollowUpOperation(boxFieldSaveOperation);var operationProgressId=OperationQueue.addMultipleOperations([pipelineFieldSaveOperation,boxFieldSaveOperation],this);BB.ButterBarManager.showMessage({message:BB.Locale.getString("adding_option"),operationProgressId:operationProgressId})},_operationSucceeded:function(operation){if(!operation.getFollowUpOperation()){Operations.ModelOperationManager.prototype._operationSucceeded.call(this,operation);return}this.updateModel(operation.getModel(),operation.getResponse(),operation.getId());var option=operation.getModel().getOptionByName(operation.optionName);if(!option){operation.getFollowUpOperation().cancel();return}var boxFieldSaveOperation=operation.getFollowUpOperation();var editOperations=boxFieldSaveOperation.getEditOperations();for(var ii=0;ii<editOperations.length;ii++){var editOperation=editOperations[ii];if(editOperation.operationId===boxFieldSaveOperation.getId()&&editOperation.waitingForKey){editOperation.value=option.key}}Operations.ModelOperationManager.prototype._operationSucceeded.call(this,operation)},_operationFailed:function(operation){if(!operation.getFollowUpOperation()){Operations.ModelOperationManager.prototype._operationFailed.call(this,operation);return}operation.getFollowUpOperation().cancel();Operations.ModelOperationManager.prototype._operationFailed.call(this,operation)}});Library.set("BentoBox.Models.PipelineColumnAddOptionOperationManager",new PipelineColumnAddOptionOperationManager)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Operations=Streak.Operations,OperationQueue=Streak.Operations.OperationQueue.Singleton;var PipelineColumnAddTagOperationManager=Streak.Class.subclass({className:"PipelineColumnAddTagOperationManager",superclass:Operations.ModelOperationManager,_memberVariables:[],_initialize:function(){Streak.Operations.ModelOperationManager.prototype._initialize.call(this)},createTagsAndUpdateBoxField:function(newTagsToBeCreated,pipelineField,newTagKeySet,boxField){var dependentTagGuid=Streak.guid();var newTagSettings=_.clone(pipelineField.get("tagSettings"));newTagSettings.tags=_.chain(newTagsToBeCreated).map(function(tagName){return{tag:tagName}}).concat(newTagSettings.tags).value();pipelineField.set("tagSettings",newTagSettings);var pipelineFieldEditOperations=pipelineField.getEditOperations();var pipelineFieldSaveOperation=this._createSaveModelOperation(pipelineField,pipelineFieldEditOperations);pipelineFieldSaveOperation.newTagsToBeCreated=newTagsToBeCreated;this._markEditOperations(pipelineFieldEditOperations,pipelineFieldSaveOperation);pipelineFieldSaveOperation.getTags().push(dependentTagGuid);pipelineFieldSaveOperation.getDependentOnTags().push(dependentTagGuid);
var boxFieldEditOperations=boxField.getEditOperations();var previousValue=boxField.get("value");boxFieldEditOperations.push({property:"value",waitingForKey:true,value:newTagKeySet});boxField.sendOutChangeNotifications("value",previousValue,newTagKeySet);var boxFieldSaveOperation=this._createSaveModelOperation(boxField,boxFieldEditOperations);this._markEditOperations(boxFieldEditOperations,boxFieldSaveOperation);boxFieldSaveOperation.getTags().push(dependentTagGuid);boxFieldSaveOperation.getDependentOnTags().push(dependentTagGuid);pipelineFieldSaveOperation.setFollowUpOperation(boxFieldSaveOperation);var operationProgressId=OperationQueue.addMultipleOperations([pipelineFieldSaveOperation,boxFieldSaveOperation],this);this._showSavingMessage(operationProgressId)},_operationSucceeded:function(operation){if(!operation.getFollowUpOperation()){Operations.ModelOperationManager.prototype._operationSucceeded.call(this,operation);return}this.updateModel(operation.getModel(),operation.getResponse(),operation.getId());var createdTags=_.map(operation.newTagsToBeCreated,operation.getModel().getOptionByName.bind(operation.getModel()));var createdTagsMap={};for(var ii=0;ii<createdTags.length;ii++){createdTagsMap[createdTags[ii].tag]=createdTags[ii].key}var boxFieldSaveOperation=operation.getFollowUpOperation();var editOperations=boxFieldSaveOperation.getEditOperations();for(var ii=0;ii<editOperations.length;ii++){var editOperation=editOperations[ii];if(editOperation.operationId===boxFieldSaveOperation.getId()&&editOperation.waitingForKey){var editValue=editOperation.value;for(var jj=0;jj<editValue.length;jj++){var tagKey=createdTagsMap[editValue[jj]];if(tagKey){editValue[jj]=tagKey}}}}Operations.ModelOperationManager.prototype._operationSucceeded.call(this,operation)},_operationFailed:function(operation){if(!operation.getFollowUpOperation()){Operations.ModelOperationManager.prototype._operationFailed.call(this,operation);return}operation.getFollowUpOperation().cancel();Operations.ModelOperationManager.prototype._operationFailed.call(this,operation)}});Library.set("BentoBox.Models.PipelineColumnAddTagOperationManager",new PipelineColumnAddTagOperationManager)})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var Stage=function(data,syncParent){Model.call(this,data);this.syncParent=syncParent};Stage.prototype=Object.create(Model.prototype);_.extend(Stage.prototype,{keyName:"key",entityType:"Stage",createProperties:["name","pipelineKey"],modifyProperties:["key","pipelineKey"],nameProperty:"name",tagEntityName:"stage",apiURLs:{get:"pipelines/<%= pipelineKey %>/stages/<%= key %>",update:"pipelines/<%= pipelineKey %>/stages/<%= key %>","delete":"pipelines/<%= pipelineKey %>/stages/<%= key %>",create:"pipelines/<%= pipelineKey %>/stages"},getExtraRequestParameters:function(){return{pipelineKey:this.syncParent.key()}},getResponseObjectAffectingModel:function(response){if(response.stages){return response.stages[this.key()]}return response}});Stage.create=function(data,syncParent){return new Stage(data,syncParent)};Stage.createCollection=function(pipelineKey){var c=new Streak.Collection;var pipeline=BB.Data.getPipeline(pipelineKey);c.init({modelKeyPropertyName:"key",createModelFromRawJSON:function(data){return Stage.create(data,pipeline)}});return c};BB.Models.Stage=Stage})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Pipeline=BB.Models.Pipeline;var allEventCallbacks=[];var fieldMap={};var Box=function(data){Model.call(this,data)};Box.prototype=Object.create(Model.prototype);_.extend(Box.prototype,{keyName:"boxKey",nameProperty:"name",entityType:"Case",typeName:"box",createProperties:["pipelineKey","name","stageKey"],apiURLs:{get:"boxes/<%= boxKey %>",update:"boxes/<%= boxKey %>",create:"pipelines/<%= pipelineKey %>/boxes","delete":"boxes/<%= boxKey %>"},tagEntityName:"box",getRequestTags:function(requestType,editOperations,operationId){editOperations=editOperations||[];var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["box_create_pipelineKey_"+this.get("pipelineKey"),"boxCollection_pipelineKey_"+this.get("pipelineKey")]);break;case"DELETE":return baseTags.concat(["box_delete_pipelineKey_"+this.get("pipelineKey"),"boxCollection_pipelineKey_"+this.get("pipelineKey")]);break}return baseTags},getModelsAffectedByServerResponse:function(){var modelArray=[this];if(this._getFieldModels()){modelArray=modelArray.concat(this._getFieldModels())}return modelArray},getRequestLimiterTagsAndTypes:function(requestType,editOperations,operationId){switch(requestType){case"CREATE":case"DELETE":return[{tag:this.getPipeline().get("orgKey"),type:Streak.Operations.OperationLimiterRules.TYPES.ENTITY_GROUP_WRITE}];break;case"UPDATE":var typesAndTags=[{tag:this.getPipeline().get("orgKey"),type:Streak.Operations.OperationLimiterRules.TYPES.ENTITY_GROUP_WRITE}];return typesAndTags;break}},getResponseObjectAffectingModel:function(response){return response},isResponseMoreRecent:function(response){var baseCheck=Streak.Model.prototype.isResponseMoreRecent.call(this,response);if(baseCheck){return baseCheck}var newFields=response.fields;if(!newFields){return baseCheck}for(var key in newFields){var newFieldValue=newFields[key];var oldFieldValue=this.getFieldValue(key);if(!oldFieldValue){return true}if(!newFieldValue){return true}if(newFieldValue.lastCalculatedTimestamp&&oldFieldValue.lastCalculatedTimestamp){if(newFieldValue.lastCalculatedTimestamp>oldFieldValue.lastCalculatedTimestamp){return true}}if(newFieldValue.calculationStatus&&newFieldValue.calculationStatus!==oldFieldValue.calculationStatus&&oldFieldValue.calculationStatus==="NOT_ATTEMPTED"){return true}}return false},getThreads:function(){return Streak.BentoBox.Data.getGmailThreadCollectionForBox(this.key())},getFieldSortValue:function(fieldKey){return BB.Models.BoxField.getSortValue(this,fieldKey)},getFieldFilterValue:function(fieldKey,filterType){return BB.Models.BoxField.getFilterValue(this,fieldKey,filterType)},getFieldGroupByValue:function(fieldKey){return BB.Models.BoxField.getGroupByValue(this,fieldKey)},getFieldSearchValue:function(fieldKey){return BB.Models.BoxField.getSearchValue(this,fieldKey)},getFieldTextValue:function(fieldKey){return BB.Models.BoxField.getTextValue(this,fieldKey)},getFieldDisplayTextValue:function(fieldKey){return BB.Models.BoxField.getDisplayTextValue(this,fieldKey)},getFieldValue:function(fieldKey){var field=this._getFieldModel(fieldKey);if(field){return field.get("value")}var fields=this.get("fields");if(!fields){return""}else{return fields[fieldKey]}},getFieldModel:function(fieldKey){var field=this._getFieldModel(fieldKey);if(!field){field=this._generateFieldModel(fieldKey)}return field},getFieldModels:function(){var array=[];var fields=this.getPipeline().getFields();if(fields){for(var i=0;i<fields.length;i++){array.push(this.getFieldModel(fields[i].key()))}}return array},addLinkedBox:function(box){var linkedBoxesLimiter=BB.Services.LinkedBoxesLimiter;if(linkedBoxesLimiter.isLocked()){linkedBoxesLimiter.showGateway()}else{var boxKeyArray=_.clone(this.get("linkedBoxKeys")||[]);boxKeyArray.push(box.key());boxKeyArray=_.uniq(boxKeyArray);this.set("linkedBoxKeys",boxKeyArray);boxKeyArray=box.get("linkedBoxKeys")||[];boxKeyArray.push(this.key());box.set("linkedBoxKeys",boxKeyArray);Streak.Model.saveAll([this,box]);linkedBoxesLimiter.incrementUsage()}},removeLinkedBox:function(box){var boxKeyArray=_.clone(this.get("linkedBoxKeys")||[]);boxKeyArray.removeVal(box.key());this.set("linkedBoxKeys",boxKeyArray);boxKeyArray=box.get("linkedBoxKeys")||[];boxKeyArray.removeVal(this.key());box.set("linkedBoxKeys",boxKeyArray);Streak.Model.saveAll([this,box])},_generateFieldModel:function(fieldKey){var value=this.getFieldValue(fieldKey);var field=BB.Models.BoxField.create({key:fieldKey,boxKey:this.key(),value:value,type:this.getPipeline().getField(fieldKey).get("type")},this);this._addFieldModelToMap(field);return field},_getFieldModel:function(fieldKey){if(!this._getFieldModels()){return null}return _.find(this._getFieldModels(),function(field){return field.key()===fieldKey})},_addFieldModelToMap:function(field){if(!fieldMap[this.getId()]){fieldMap[this.getId()]=[]}fieldMap[this.getId()].push(field)},_getFieldModels:function(){if(!fieldMap[this.getId()]){return null}return fieldMap[this.getId()]},clearFields:function(){this.getWrappedObject().fields={};delete fieldMap[this.getId()]},getStage:function(){var pipeline=this.getPipeline();if(pipeline){return pipeline.getStage(this.get("stageKey"))}return null},getStageName:function(){return this.getStage().displayNameHTML()},getAssignedToSharingEntries:function(){return this.get("assignedToSharingEntries")},getIsEditable:function(){return this.getPipeline().getIsEditable()},getPipeline:function(){return BB.Data.getPipeline(this.get("pipelineKey"))},markFieldCalculating:function(fieldKey){var fieldModel=this._getFieldModel(fieldKey);if(fieldModel){var fieldValue=fieldModel.get("value");fieldValue.calculationStatus="NOT_ATTEMPTED";if(fieldValue.lastCalculatedTimestamp){fieldValue.lastCalculatedTimestamp++}return}var fields=this.get("fields")||{};var field=fields[fieldKey];if(!field){fields[fieldKey]={};field=fields[fieldKey]}field.calculationStatus="NOT_ATTEMPTED";if(field.lastCalculatedTimestamp){field.lastCalculatedTimestamp++}}});Box.create=function(data){return new Box(data)};Box.createCollection=function(pipelineKey,initializedCallback){var c=new Collection;c.init({modelKeyPropertyName:"boxKey",apiURL:pipelineKey?"pipelines/"+pipelineKey+"/boxes":"/boxes",requestTags:["boxCollection_pipelineKey_"+pipelineKey],requestDependentOnTags:["boxCollection_pipelineKey_"+pipelineKey],refreshRequeueOperationTags:["box_create_pipelineKey_"+pipelineKey,"box_delete_pipelineKey_"+pipelineKey,"box_move_pipelineKey_"+pipelineKey],createModelFromRawJSON:Box.create});return c};BB.Models.Box=Box})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Pipeline=BB.Models.Pipeline;_.extend(BB.Models.Box.prototype,{getProcessedHTMLValue:function(property){if(property==="stageKey"){return this.getStageName()}var type=Pipeline.getPropertyType(property);var val=this.get(property);switch(type){case"DATE":return _.escape(Streak.DateString.prettyDate(val));break;case"NUMBER":if(!val){val=0}return _.escape(val+"");break;case"COMPUTED":var systemProperty=Pipeline.getSystemProperty(property);return systemProperty.computeFunction(this);break;default:return _.escape(val+"")}},getSortValue:function(property){var type=Pipeline.getPropertyType(property);var val=this.get(property);var systemProperty=Pipeline.getSystemProperty(property);if(systemProperty.sortFunction){return systemProperty.sortFunction.call(systemProperty,this)}switch(type){case"DATE":return parseInt(val);break;case"NUMBER":if(!val){val=0}return parseFloat(val);break;default:if(val&&val.trim){return val.trim()}return val}},getGroupByValue:function(property){var type=Pipeline.getPropertyType(property);var val=this.get(property);var ret=[];if(property==="stageKey"){if(this.getStage()){ret.push(this.get(property))}}else{switch(type){case"COMPUTED":var systemProperty=Pipeline.getSystemProperty(property);ret=systemProperty.groupByFunction.call(systemProperty,this);break;case"DATE":ret.push(val);break;default:ret.push(this.getProcessedHTMLValue(property))}}if(!ret||ret.length===0){ret=["no_value"]}return ret},getTextValue:function(property){var systemProperty=Pipeline.getSystemProperty(property);if(!systemProperty){return""}if(systemProperty.type==="DATE"){var val=this.get(property);return Streak.DateString.format(val,"export")}else if(systemProperty.textValueFunction){return systemProperty.textValueFunction.call(systemProperty,this)}else{return this.getProcessedHTMLValue(property)}},getSearchValue:function(property){var systemProperty=Pipeline.getSystemProperty(property);if(!systemProperty){return""}if(systemProperty.type==="DATE"){return Streak.DateString.prettyDate(this.get(property))}else if(systemProperty.textValueFunction){return systemProperty.textValueFunction.call(systemProperty,this)}else{return this.getProcessedHTMLValue(property)}},getDisplayTextValue:function(property){var systemProperty=Pipeline.getSystemProperty(property);if(!systemProperty){return""}if(systemProperty.type==="DATE"){var val=this.get(property);var dateText=Streak.DateString.prettyDate(val);return dateText||""}else if(systemProperty.textValueFunction){return systemProperty.textValueFunction.call(systemProperty,this)}else{return""+this.get(property)}},getFilterValue:function(property){var systemProperty=Pipeline.getSystemProperty(property);if(!systemProperty){return""}if(systemProperty.filterValueFunction){return systemProperty.filterValueFunction.call(systemProperty,this)}else{return this.get(property)}}})})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,BB=Streak.BentoBox;var BoxField=function(data,syncParent){Model.call(this,data);this.syncParent=syncParent;this._sortValue=null;this.setSortValue()};BoxField.prototype=Object.create(Model.prototype);_.extend(BoxField.prototype,{keyName:"key",entityType:"Field",createProperties:["boxKey"],modifyProperties:["key","boxKey"],nameProperty:"value",set:function(property,value){Model.prototype.set.apply(this,[property,value]);this.clearSortValue()},apiURLs:{update:"boxes/<%= boxKey %>/fields/<%= key %>"},tagEntityName:"boxField",getExtraRequestParameters:function(requestType){return{boxKey:this.syncParent.key()}},getExtraUpdateParameters:function(){if(BB.isFeatureEnabled("formulaFields")){return{returnCase:true}}},getModelsAffectedByServerResponse:function(response){if(response.fields){return this.syncParent.getModelsAffectedByServerResponse()}return[this]},getResponseObjectAffectingModel:function(response){if(!response.fields){return response}return{key:this.key(),value:response.fields[this.key()]}},isResponseMoreRecent:function(response){var currentValue=this.get("value");if(!currentValue){return true}if(!currentValue.lastCalculatedTimestamp){return true}var responseValue=response.value;if(responseValue&&responseValue.lastCalculatedTimestamp){if(responseValue.lastCalculatedTimestamp>currentValue.lastCalculatedTimestamp){return true}}return Streak.Model.prototype.isResponseMoreRecent.call(this,responseValue)},setWrappedObject:function(wrappedObject){Model.prototype.setWrappedObject.call(this,wrappedObject);this.clearSortValue()},getIsEditable:function(){return this.syncParent.getIsEditable()},getSortValue:function(){if(!this._sortValue){this.setSortValue()}return this._sortValue},setSortValue:function(){this._sortValue=BoxField.getSortValue(this.syncParent,this.key())},clearSortValue:function(){this._sortValue=null},_getType:function(){return this.syncParent.getPipeline().getField(this.key()).get("type")}});BoxField.create=function(data,syncParent){return new BoxField(data,syncParent)};BB.Models.BoxField=BoxField})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,BB=Streak.BentoBox;var BoxField=BB.Models.BoxField;BoxField.copyFieldOptions=function(fromPipeline,newPipeline){var fromFields=fromPipeline.getFields();var newFields=newPipeline.getFields();for(var ii=0;ii<fromFields.length;ii++){var fromField=fromFields[ii];var newField=newFields[ii];switch(fromField.get("type")){case"DROPDOWN":var fromDropdownSettings=fromField.get("dropdownSettings");var newDropdownSettings={items:_.chain(fromDropdownSettings.items).pluck("name").uniq().map(function(name){return{name:name}}).value()};newField.set("dropdownSettings",newDropdownSettings);newField.save();break;case"TAG":var fromTagSettings=fromField.get("tagSettings");var newTagSettings={tags:_.chain(fromTagSettings.tags).pluck("tag").uniq().map(function(tagName){return{tag:tagName}}).value()};newField.set("tagSettings",newTagSettings);newField.save();break}}};BoxField.getCustomColumnTypes=function(){var columns=[{name:BB.Locale.getString("column_type_free"),type:"TEXT_INPUT"},{name:BB.Locale.getString("column_type_person"),type:"PERSON"},{name:BB.Locale.getString("column_type_date"),type:"DATE"},{name:BB.Locale.getString("column_type_checkbox"),type:"CHECKBOX"},{name:BB.Locale.getString("column_type_dropdown"),type:"DROPDOWN"},{name:BB.Locale.getString("column_type_tag"),type:"TAG"},{name:BB.Locale.getString("column_type_formula"),type:"FORMULA"}];return columns};BoxField.getColumnEditStatusTransformOptions=function(pipeline,fieldKey){var field=pipeline.getField(fieldKey);var type=field.get("type");var transformOptions={isEditable:true,isActionable:false,isRenameable:true};switch(type){case"CHECKBOX":transformOptions.isEditable=false;transformOptions.isActionable=true;transformOptions.isCheckbox=true;break}return transformOptions};BoxField.getFilterType=function(pipeline,fieldKey){var fieldModel=pipeline.getField(fieldKey);if(fieldModel.get("type")!=="FORMULA"){return fieldModel.get("type")}var boxes=BB.Data.getPipelineBoxes(pipeline.key());var filterType=null;for(var ii=0;ii<boxes.length;ii++){var value=boxes[ii].getFieldValue(fieldKey);if(!value){continue}if(value.calculationStatus!=="SUCCESS"){continue}if(!value.calculationValueType){continue}if(!filterType){filterType=value.calculationValueType;continue}if(filterType!==value.calculationValueType){filterType="MIXED"}}if(!filterType){return"BASIC_TEXT"}if(filterType.indexOf("List")>-1||filterType.indexOf("Map")>-1){return"BASIC_TEXT"}switch(filterType){case"java.lang.Double":case"java.lang.Integer":case"java.lang.Long":return"NUMBER";break;case"java.lang.Boolean":return"BOOLEAN";break;case"java.util.Date":return"DATE";break;case"java.lang.String":return"BASIC_TEXT";break;default:return"BASIC_TEXT";break}};BoxField.getFilterOperations=function(type,currentOperation){switch(type){case"BASIC_TEXT":return[{name:BB.Locale.getString("filter_contains"),value:"contains"},{name:BB.Locale.getString("filter_not_contains"),value:"notContains"}];break;case"TEXT":case"TEXT_INPUT":return[{name:BB.Locale.getString("filter_contains"),value:"contains"},{name:BB.Locale.getString("filter_not_contains"),value:"notContains"},"__separator",{name:BB.Locale.getString("filter_equals"),value:"eq"},{name:BB.Locale.getString("filter_not_equals"),value:"ne"},{name:BB.Locale.getString("filter_greater_than"),value:"gt"},{name:BB.Locale.getString("filter_less_than"),value:"lt"},"__separator",{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"}];break;case"STAGE":var list=[{name:BB.Locale.getString("filter_is_any"),value:"isAny"},{name:BB.Locale.getString("filter_is_not_any"),value:"isNotAny"}];if(currentOperation==="eq"){list.push("__separator");list.push({name:BB.Locale.getString("filter_equals"),value:"eq"})}if(currentOperation==="ne"){list.push("__separator");list.push({name:BB.Locale.getString("filter_not_equals"),value:"ne"})}if(currentOperation==="contains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_contains"),value:"contains"})}if(currentOperation==="notContains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_not_contains"),value:"notContains"})}return list;break;case"NUMBER":return[{name:BB.Locale.getString("filter_equals"),value:"eq"},{name:BB.Locale.getString("filter_not_equals"),value:"ne"},{name:BB.Locale.getString("filter_greater_than"),value:"gt"},{name:BB.Locale.getString("filter_less_than"),value:"lt"},"__separator",{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"}];break;case"DATE":return[{name:BB.Locale.getString("date_filter_before"),value:"before"},{name:BB.Locale.getString("date_filter_after"),value:"after"},{name:BB.Locale.getString("date_filter_range"),value:"on"},"__separator",{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"}];break;case"PERSON":var list=[{name:BB.Locale.getString("filter_is_any"),value:"isAny"},{name:BB.Locale.getString("filter_is_not_any"),value:"isNotAny"},{name:BB.Locale.getString("filter_is_exactly"),value:"isExactly"}];if(currentOperation==="includes"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_includes"),value:"includes"})}if(currentOperation==="doesNotInclude"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_not_includes"),value:"doesNotInclude"})}if(currentOperation==="isOnly"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_only"),value:"isOnly"})}list=list.concat(["__separator",{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"},"__separator",{name:BB.Locale.getString("filter_contains"),value:"contains"},{name:BB.Locale.getString("filter_not_contains"),value:"notContains"}]);return list;break;case"TAG":var list=[{name:BB.Locale.getString("filter_is_any"),value:"isAny"},{name:BB.Locale.getString("filter_is_not_any"),value:"isNotAny"},{name:BB.Locale.getString("filter_is_exactly"),value:"isExactly"}];if(currentOperation==="includes"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_includes"),value:"includes"})}if(currentOperation==="doesNotInclude"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_not_includes"),value:"doesNotInclude"})}if(currentOperation==="isOnly"){list.push("__separator");list.push({name:BB.Locale.getString("people_filter_only"),value:"isOnly"})}if(currentOperation==="contains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_contains"),value:"contains"})}if(currentOperation==="notContains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_not_contains"),value:"notContains"})}list.push("__separator");list=list.concat([{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"}]);return list;break;case"CHECKBOX":return[{name:BB.Locale.getString("filter_is_checked"),value:"isChecked"},{name:BB.Locale.getString("filter_is_unchecked"),value:"isUnchecked"}];break;case"DROPDOWN":var list=[{name:BB.Locale.getString("filter_is_any"),value:"isAny"},{name:BB.Locale.getString("filter_is_not_any"),value:"isNotAny"}];if(currentOperation==="contains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_contains"),value:"contains"})}if(currentOperation==="notContains"){list.push("__separator");list.push({name:BB.Locale.getString("filter_not_contains"),value:"notContains"})}if(currentOperation==="eq"){list.push("__separator");list.push({name:BB.Locale.getString("filter_equals"),value:"eq"})}if(currentOperation==="ne"){list.push("__separator");list.push({name:BB.Locale.getString("filter_not_equals"),value:"ne"})}list=list.concat(["__separator",{name:BB.Locale.getString("filter_is_set"),value:"isSet"},{name:BB.Locale.getString("filter_not_set"),value:"notSet"}]);return list;break;case"BOOLEAN":return[{name:BB.Locale.getString("filter_is_true"),value:"isTrue"},{name:BB.Locale.getString("filter_is_false"),value:"isFalse"}];break}};BoxField.getFilterTextValues=function(type,operation,pipeline,fieldKey){switch(type){case"STAGE":return _.map(pipeline.getStages(),function(stage){return{name:stage.displayNameText(),displayText:stage.displayNameText(),value:stage.key()}});break;case"DATE":switch(operation){case"on":return[{name:BB.Locale.getString("date_filter_value_today"),value:"today"},{name:BB.Locale.getString("date_filter_value_yesterday"),value:"yesterday"},{name:BB.Locale.getString("date_filter_value_tomorrow"),value:"tomorrow"},"__separator",{name:BB.Locale.getString("date_filter_value_this_week"),value:"this week"},{name:BB.Locale.getString("date_filter_value_this_month"),value:"this month"},{name:BB.Locale.getString("date_filter_value_this_year"),value:"this year"},"__separator",{name:BB.Locale.getString("date_filter_value_last_week"),value:"last week"},{name:BB.Locale.getString("date_filter_value_last_month"),value:"last month"},{name:BB.Locale.getString("date_filter_value_last_year"),value:"last year"},"__separator",{name:BB.Locale.getString("date_filter_value_next_week"),value:"next week"},{name:BB.Locale.getString("date_filter_value_next_month"),value:"next month"},{name:BB.Locale.getString("date_filter_value_next_year"),value:"next year"}];break;default:return[{name:BB.Locale.getString("date_filter_specific"),value:"__specific"},{name:BB.Locale.getString("date_filter_specific_range"),value:"__specific_range"},"__separator",{name:BB.Locale.getString("date_filter_value_today"),value:"today"},{name:BB.Locale.getString("date_filter_value_yesterday"),value:"yesterday"},{name:BB.Locale.getString("date_filter_value_tomorrow"),value:"tomorrow"},"__separator",{name:BB.Locale.getString("date_filter_value_last_days_ago",{number:7}),value:"last 7 days"},{name:BB.Locale.getString("date_filter_value_last_days_ago",{number:30}),value:"last 30 days"},{name:BB.Locale.getString("date_filter_value_last_days_ago",{number:90}),value:"last 90 days"},{name:BB.Locale.getString("date_filter_value_last_days_ago",{number:180}),value:"last 180 days"},{name:BB.Locale.getString("date_filter_value_last_days_ago",{number:365}),value:"last 365 days"},"__separator",{name:BB.Locale.getString("date_filter_value_days_from_now",{number:7}),value:"next 7 days"},{name:BB.Locale.getString("date_filter_value_days_from_now",{number:30}),value:"next 30 days"},{name:BB.Locale.getString("date_filter_value_days_from_now",{number:90}),value:"next 90 days"},{name:BB.Locale.getString("date_filter_value_days_from_now",{number:180}),value:"next 180 days"},{name:BB.Locale.getString("date_filter_value_days_from_now",{number:365}),value:"next 365 days"}];break}break;case"PERSON":var list=[{name:"Me",displayText:"Me",value:"me"}];var existingList=BoxField.getExistingTextValuesInBoxes(pipeline,fieldKey);if(existingList.length>0){list.push("__separator");list=list.concat(existingList)}return list;break;case"DROPDOWN":if(!fieldKey){return[]}var dropdownFieldModel=pipeline.getField(fieldKey);return _.map(dropdownFieldModel.getOptions(),function(option){return{name:option.name,value:option.key,displayText:option.name}});break;case"TAG":if(!fieldKey){return[]}var tagFieldModel=pipeline.getField(fieldKey);return _.chain(tagFieldModel.getOptions()).filter(function(option){return!!option.key}).sortBy(function(option){return option.tag}).map(function(option){return{name:option.tag,value:option.key,displayText:option.tag}}).value();break}};BoxField.getFilterValue=function(box,fieldKey,filterType){var fieldType=box.getPipeline().getField(fieldKey).get("type");if(fieldType==="FORMULA"){var valueObject=box.getFieldValue(fieldKey);switch(filterType){case"DATE":if(valueObject){if(valueObject.calculationStatus==="SUCCESS"&&valueObject.calculationValueType==="java.util.Date"){var date=Date.create(valueObject.calculationValue);if(date.isValid()){return valueObject.calculationValue}}}return null;break;case"BOOLEAN":if(valueObject){if(valueObject.calculationStatus==="SUCCESS"&&valueObject.calculationValueType==="java.lang.Boolean"){return valueObject.calculationValue}}return null;break;default:return _getFormulaValueText(valueObject);break}}else{return box.getFieldValue(fieldKey)}};BoxField.getAssignedToFilterTextValues=function(pipeline){var list=[{name:"Me",displayText:"Me",value:"me"}];var boxes=BB.Data.getPipelineBoxes(pipeline.key());boxes.sortByParameter("lastUpdatedTimestamp");var existingList=_(boxes).chain().last(100).map(function(box){return box.get("assignedToSharingEntries")}).flatten().filter(function(value){return _.isReal(value)&&_.isReal(value.displayName)}).map(function(value){return ret={value:value,display:value.displayName,displayText:value.displayName}}).sortBy(function(ret){return ret.display.toLowerCase()}).uniq(false,function(ret){return ret.value.email}).value();if(existingList.length>0){list.push("__separator");list=list.concat(existingList)}return list};BoxField.getSidebarInputWidget=function(box,pipelineField,containerElement,trackingContext){var options={model:box.getFieldModel(pipelineField.key()),property:"value",border:"always",trackingContext:trackingContext,parent:containerElement};switch(pipelineField.get("type")){case"TEXT_INPUT":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.readHTML=true;return BB.Widgets.SidebarTextarea.create(options);break;case"DATE":return new BB.Widgets.SmartTextCalendarViewController(options);break;case"PERSON":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.includeNames=true;options.imgHeight=23;options.imgWidth=23;return BB.Widgets.PeoplePicker.create(options);break;case"CHECKBOX":return new BB.Widgets.SmartCheckboxViewController(options);break;case"FORMULA":return new BB.Widgets.FormulaValueLabel(options);break;case"DROPDOWN":options.optionSource=pipelineField;return new BB.Widgets.SmartTextDropdownViewController(options);break;case"TAG":options.optionSource=pipelineField;options.alwaysShowBorder=true;return new BB.Widgets.SmartTagsViewController(options);break}};BoxField.getBoxViewInputWidget=function(box,pipelineField,containerElement,trackingContext){var options={model:box.getFieldModel(pipelineField.key()),property:"value",border:"hover",trackingContext:trackingContext,parent:containerElement};switch(pipelineField.get("type")){case"TEXT_INPUT":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.readHTML=true;return BB.Widgets.SidebarTextarea.create(options);break;case"DATE":return new BB.Widgets.SmartTextCalendarViewController(options);break;case"PERSON":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.includeNames=true;options.imgHeight=20;options.imgWidth=20;return BB.Widgets.PeoplePicker.create(options);break;case"CHECKBOX":return new BB.Widgets.SmartCheckboxViewController(options);break;case"FORMULA":return new BB.Widgets.FormulaValueLabel(options);break;case"DROPDOWN":options.optionSource=pipelineField;return new BB.Widgets.SmartTextDropdownViewController(options);break;case"TAG":options.optionSource=pipelineField;return new BB.Widgets.SmartTagsViewController(options);break}};BoxField.getSpreadsheetInputOptions=function(box,fieldKey,coord,tableModel,pipelineSpreadsheetViewController){var pipeline=box.getPipeline();var pipelineField=pipeline.getField(fieldKey);var options={model:box.getFieldModel(fieldKey),property:"value",type:pipelineField.get("type")};switch(options.type){case"TEXT_INPUT":case"PERSON":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());break;case"DROPDOWN":options.optionSource=pipelineField;break;case"FORMULA":options.model=pipeline.getField(fieldKey);options.property="defaultValue";options.pipeline=pipeline;options.stageKey=box.get("stageKey");options.box=box;options.tableModel=tableModel;options.spreadsheetRedrawFunction=pipelineSpreadsheetViewController.redrawContentRows.bind(pipelineSpreadsheetViewController);options.coord=[0,coord[1]];options.coord[0]=tableModel.getGroupRowIndex(tableModel._getClosestGroupID(coord[0]));break;case"TAG":options.optionSource=pipelineField;break}return options};BoxField.getMailMergeInputWidget=function(box,fieldKey){var options={model:box.getFieldModel(fieldKey),property:"value",border:"always",trackingContext:{widgetContext:"mailMerge"}};var pipelineField=box.getPipeline().getField(fieldKey);switch(pipelineField.get("type")){case"TEXT_INPUT":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.readHTML=false;
options.border="alwaysGmail";return BB.Widgets.SidebarTextarea.create(options);break;case"DATE":return new BB.Widgets.SmartTextCalendarViewController(options);break;case"PERSON":options.existingList=BoxField.getExistingTextValuesInBoxes(box.getPipeline(),pipelineField.key());options.includeNames=true;options.imgHeight=23;options.imgWidth=23;return BB.Widgets.PeoplePicker.create(options);break;case"CHECKBOX":return new BB.Widgets.SmartCheckboxViewController(options);break;case"DROPDOWN":options.optionSource=pipelineField;return new BB.Widgets.SmartTextDropdownViewController(options);break;case"TAG":options.optionSource=pipelineField;return new BB.Widgets.SmartTagsViewController(options);break;case"FORMULA":return new BB.Widgets.FormulaValueLabel(options);break}};BoxField.getExistingTextValuesInBoxes=function(pipeline,fieldKey){var boxes=BB.Data.getPipelineBoxes(pipeline.key());var type=pipeline.getField(fieldKey).get("type");if(type==="DATE"||type==="CHECKBOX"||type==="FORMULA"){return[]}if(type==="DROPDOWN"){return _.map(pipeline.getField(fieldKey).getOptions(),function(option){return{value:option.key,display:option.name,displayText:option.name,normalized:option.name.toLowerCase().removeWhitespace()}})}else if(type==="TAG"){return _.map(pipeline.getField(fieldKey).getOptions(),function(option){return{value:option.key,displayText:option.tag}})}boxes.sortByParameter("lastUpdatedTimestamp");return _(boxes).chain().last(500).map(function(box){return box.getFieldValue(fieldKey)}).flatten().filter(function(value){if(type==="PERSON"){return _.isReal(value)&&_.isReal(value.displayName)}return value}).map(function(value){var ret={value:value,display:null,normalized:null};switch(type){case"TEXT_INPUT":ret.display=ret.value.replace(/\n/gim," ");ret.normalized=ret.display.toLowerCase().removeWhitespace();break;case"DATE":ret.display=ret.value;break;case"PERSON":case"ASSIGNED_TO":ret.display=ret.value.displayName;ret.displayText=ret.display;break}return ret}).sortBy(function(ret){return ret.display.toLowerCase()}).uniq(false,function(ret){if(type==="ASSIGNED_TO"){return ret.value.email}else if(type==="PERSON"){return ret.value.email||ret.display}return ret.value.trim().toLowerCase()}).value()};BoxField.getSortValue=function(box,fieldKey){var value=box.getFieldValue(fieldKey);var type=box.getPipeline().getField(fieldKey).get("type");switch(type){case"TEXT_INPUT":case"DATE":if(value&&value.trim){value=value.trim()}break;case"PERSON":try{var list=value;var arr=[];for(var i=0;i<list.length;i++){arr.push(list[i].displayName)}arr.sort();value=arr.join(",")}catch(err){value=""}break;case"CHECKBOX":value=value?1:0;break;case"DROPDOWN":if(value){var field=box.getPipeline().getField(fieldKey);value=field.getOption(value).name}else{value=""}break;case"TAG":if(value){var field=box.getPipeline().getField(fieldKey);value=_getTagHTML(field,value)}else{value=""}break;case"FORMULA":if(!value){return""}if(value.calculationStatus==="SUCCESS"){if(_.isReal(value.calculationValue)){return _getFormulaValueText(value)}}else if(value.calculationValue==="NOT_ATTEMPTED"){return BB.Locale.getString("formula_calculating")}else{return BB.Locale.getString("formula_error")}return"";break}return value};BoxField.getGroupByValue=function(box,fieldKey,granularity){var field=box.getPipeline().getField(fieldKey);if(!field){BB.logError("Could not find field",null,{fieldKey:fieldKey});return null}var type=field.get("type");var value=box.getFieldValue(fieldKey);switch(type){case"DATE":return value?[_getDateByBucket(value,granularity)]:["no_value"];break;case"TEXT_INPUT":return value?[value]:[""];break;case"PERSON":return value&&value.length?_.pluck(value,"displayName"):[""];break;case"CHECKBOX":return value?["Checked"]:["Unchecked"];break;case"FORMULA":if(!value){return["no_value"]}if(value.calculationStatus==="SUCCESS"){if(_.isReal(value.calculationValue)){return[_getFormulaValueText(value)]}}else if(value.calculationStatus==="NOT_ATTEMPTED"){return[BB.Locale.getString("formula_calculating")]}else{return[BB.Locale.getString("formula_error")]}return["no_value"];break;case"DROPDOWN":if(value){var option=field.getOption(value);value=option.name||value;return[value]}else{return[BB.Locale.getString("no_value")]}break;case"TAG":if(value&&value.length>0){var field=box.getPipeline().getField(fieldKey);return _.chain(value).map(field.getOption.bind(field)).pluck("tag").value()}else{return[""]}break}};BoxField.getGroupByDisplayTextValue=function(value,pipeline,fieldKey,granularity){var field=pipeline.getField(fieldKey);switch(field.get("type")){case"DATE":var d=Date.create(value);if(d.isValid()){return _getPrettyDateBucketName(d,granularity)}break;case"TEXT_INPUT":case"PERSON":case"FORMULA":case"CHECKBOX":case"DROPDOWN":case"TAG":if(value){return value}break}return BB.Locale.getString("no_value")};BoxField.getTextValue=function(box,fieldKey){var value=box.getFieldValue(fieldKey);var type=box.getPipeline().getField(fieldKey).get("type");switch(type){case"TEXT_INPUT":value=value?value:"";break;case"DATE":value=Streak.DateString.format(value,"export");break;case"PERSON":try{var list=value;var arr=[];for(var i=0;i<list.length;i++){if(list[i].email===list[i].displayName){arr.push(list[i].email)}else{var newVal=list[i].displayName;if(list[i].email){newVal+=" <"+list[i].email+">"}arr.push(newVal)}}value=arr.join(",")}catch(err){value=""}break;case"CHECKBOX":if(value){value="Checked"}else{value="Unchecked"}break;case"DROPDOWN":if(value){var field=box.getPipeline().getField(fieldKey);value=field.getOption(value).name}else{value=""}break;case"FORMULA":if(!value){return""}if(value&&value.calculationStatus==="SUCCESS"){if(_.isReal(value.calculationValue)){return _getFormulaValueText(value)}}else if(value.calculationValue==="NOT_ATTEMPTED"){return BB.Locale.getString("formula_calculating")}else{return BB.Locale.getString("formula_error")}return"";break;case"TAG":if(value){var field=box.getPipeline().getField(fieldKey);return _getTagHTML(field,value)}else{value=""}break}return value};BoxField.getSearchValue=function(box,fieldKey){var type=box.getPipeline().getField(fieldKey).get("type");if(type==="DATE"){return Streak.DateString.prettyDate(box.getFieldValue(fieldKey))}return BoxField.getTextValue(box,fieldKey)};BoxField.getDisplayTextValue=function(box,fieldKey){var value=box.getFieldValue(fieldKey);var type=box.getPipeline().getField(fieldKey).get("type");switch(type){case"TEXT_INPUT":break;case"DATE":value=Streak.DateString.prettyDate(value);break;case"PERSON":try{var list=value;var arr=[];for(var i=0;i<list.length;i++){if(list[i].email===list[i].displayName){arr.push(list[i].email)}else{var newVal=list[i].displayName;if(list[i].email){newVal+=" <"+list[i].email+">"}arr.push(newVal)}}value=arr.join(",")}catch(err){value=""}break;case"CHECKBOX":value=value?"Checked":"Unchecked";break;case"DROPDOWN":if(value){var field=box.getPipeline().getField(fieldKey);value=field.getOption(value).name}else{value=""}break;case"FORMULA":if(!value){return""}if(value.calculationStatus==="SUCCESS"){if(_.isReal(value.calculationValue)){return _getFormulaValueText(value)}}else if(value.calculationValue==="NOT_ATTEMPTED"){return BB.Locale.getString("formula_calculating")}else{return BB.Locale.getString("formula_error")}return"";break;case"TAG":if(value){var field=box.getPipeline().getField(fieldKey);return _getTagHTML(field,value)}else{value=""}break}if(_.isReal(value)){return value}return""};BoxField.getHTMLValue=function(box,fieldKey){var field=box.getPipeline().getField(fieldKey);if(!field){BB.logError("Could not find field",null,{fieldKey:fieldKey});return""}var type=field.get("type");var value=box.getFieldValue(fieldKey);switch(type){case"TEXT_INPUT":value=value?_.escape(value):"";break;case"DATE":value=Streak.DateString.prettyDate(value);break;case"PERSON":try{value=_getPersonHTML(value)}catch(err){BB.logError("error parsing people object",err,value);value=""}break;case"CHECKBOX":value=_getCheckboxHTML(value);break;case"FORMULA":value=_getFormulaHTML(value,box,fieldKey);break;case"DROPDOWN":if(value){var field=box.getPipeline().getField(fieldKey);var option=field.getOption(value);value=option.name||value}else{value=""}value=_.escape(value);break;case"TAG":if(value){var field=box.getPipeline().getField(fieldKey);return _getTagHTML(field,value)}else{value=""}break}return value};BoxField.createPipelineFieldModel=function(data,pipeline){switch(data.type){case"DROPDOWN":return new BB.Models.PipelineDropdownField(data,pipeline);break;case"FORMULA":return new BB.Models.PipelineFormulaField(data,pipeline);case"TAG":return new BB.Models.PipelineTagField(data,pipeline);break;default:return new BB.Models.PipelineField(data,pipeline)}};function _getPersonHTML(value){if(!value){return""}var retVal="";_.each(value,function(contact){contact=BB.Contacts.updateContact(contact);if(!contact.displayName){contact.displayName=contact.fullName||contact.email||""}var emailString="";if(contact.email){emailString='email="'+_.escape(contact.email)+'"'}var iUrl=contact.imageUrl||contact.image||Streak.server+Streak.combinedPath+"images/unknownContact.png";var cEl='<img class="people" height="23" width="23" src="'+_.escape(iUrl)+'" title="'+_.escape(contact.displayName)+'">';cEl+='<span class="people" '+emailString+">"+_.escape(contact.displayName)+"</span>";retVal+=cEl});return retVal}function _getCheckboxHTML(value){var returnValue='<div class="oZ-jc T-Jo J-J5-Ji ';if(value){returnValue+="T-Jo-Jp"}returnValue+='"">';returnValue+='<div class="T-Jo-auh"></div>';returnValue+="</div>";return returnValue}function _getFormulaHTML(value,box,fieldKey){if(!value){return""}if(!value.calculationStatus){return""}switch(value.calculationStatus){case"SUCCESS":if(_.isReal(value.calculationValue)){return BoxField.getFormulaHTMLForType(value)}else{return""}break;case"NOT_ATTEMPTED":return'<span class="streak__spreadsheet_cornerTriangle streak__spreadsheet_cornerTriangle_yellow"></span>'+'<div class="streak__spreadsheet_formulaErrorMessage">'+BB.Locale.getString("formula_calculating")+"</div>";default:var errorString=BB.Locale.getString("formula_error_"+value.calculationStatus.toLowerCase());if(value.errorDetails){errorString+=": \n\n"+value.errorDetails}return'<span class="streak__spreadsheet_cornerTriangle streak__spreadsheet_cornerTriangle_red"></span>'+'<div class="streak__spreadsheet_formulaErrorMessage" data-tooltip="'+_.escape(errorString)+'">'+BB.Locale.getString("formula_error")+"</div>"}}BoxField.getFormulaHTMLForType=function(valueObject){try{var result=_.escape(_getFormulaValueText(valueObject));if(valueObject.formula){return'<span class="streak__spreadsheet_cornerTriangle streak__spreadsheet_cornerTriangle_blue"></span>'+result}else{return result}}catch(e){BB.logError("failed to render formula HTML",e);return'<span class="streak__spreadsheet_cornerTriangle streak__spreadsheet_cornerTriangle_red"></span>Error'}};function _getFormulaValueText(valueObject){var value=valueObject.calculationValue;switch(valueObject.calculationValueType){case"java.lang.Double":case"java.lang.String":case"java.lang.Boolean":case"java.lang.Integer":case"java.lang.Long":break;case"java.util.Date":var date=Streak.Date.create(value);if(date&&date.isValid()){value=date.prettyDate(true)}break;case"java.util.List<java.lang.Double>":case"java.util.List<java.lang.String>":case"java.util.List<java.lang.Boolean>":case"java.util.List<java.lang.Integer>":case"java.util.List<java.lang.Long>":value=value.join(", ");break;case"java.util.List<java.util.Date>":value=_.map(value,function(aValue){var date=Streak.Date.create(aValue);if(date&&date.isValid()){return date.prettyDate(true)}return aValue}).join(", ");break;case"java.util.Map<java.lang.String,java.lang.Double>":case"java.util.Map<java.lang.String,java.lang.String>":case"java.util.Map<java.lang.String,java.lang.Boolean>":case"java.util.Map<java.lang.String,java.lang.Integer>":case"java.util.Map<java.lang.String,java.lang.Long>":var tempValue=[];for(var key in value){tempValue.push(key+"="+value[key])}value=tempValue.join(", ");break;case"java.util.Map<java.lang.String,java.util.Date>":var tempValue=[];for(var key in value){var aValue=value[key];var date=Streak.Date.create(aValue);if(date&&date.isValid()){tempValue.push(key+"="+date.prettyDate(true))}else{tempValue.push(key+"="+aValue)}}value=tempValue.join(", ");break}if(typeof value=="object"){value=JSON.stringify(value)}else{value=""+value}return value}function _getTagHTML(field,value){return _.chain(value).map(field.getOption.bind(field)).pluck("tag").map(_.escape).value().join(", ")}function _getDateByBucket(dateValue,granularity){return Streak.moment(dateValue).startOf(granularity).toDate()}function _getPrettyDateBucketName(dateObject,granularity){var moment=Streak.moment(dateObject);switch(granularity){case"DAY":case"WEEK":return dateObject.prettyDate(true);break;case"MONTH":return moment.format("MMMM YYYY");break;case"QUARTER":return"Q"+moment.format("Q YYYY");break;case"YEAR":return moment.format("YYYY");break;default:return dateObject.prettyDate(true)}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxOperationManager=Streak.Class.subclass({className:"BoxOperationManager",superclass:Streak.Operations.ModelOperationManager,_memberVariables:[],_initialize:function(){Streak.Operations.ModelOperationManager.prototype._initialize.call(this)},moveBoxes:function(boxes,oldPipelineKey,newPipelineKey){var operations=[];for(var ii=0;ii<boxes.length;ii++){var operation=this._createMoveBoxOperation(boxes[ii],newPipelineKey);operations.push(operation)}var operationProgressId=Streak.Operations.OperationQueue.Singleton.addMultipleOperations(operations,this);BB.ButterBarManager.showMessage(BB.Locale.getString("starting_to_move_boxes",{total:boxes.length},[boxes.length]),{priority:-2});this._setupOperationProgressHandler(operationProgressId,oldPipelineKey,newPipelineKey);return operationProgressId},getBoxesInBatch:function(boxKeys,pipelineKey){var getBoxesInBatchOperation=new BB.Models.BatchBoxGetOperation(boxKeys,pipelineKey);Streak.Operations.OperationQueue.Singleton.addOperation(getBoxesInBatchOperation,this)},_operationSucceeded:function(operation){if(operation instanceof BB.Models.BatchBoxGetOperation){this._handleBatchBoxGetOperation(operation);return}Streak.Operations.ModelOperationManager.prototype._operationSucceeded.call(this,operation)},_operationFailed:function(operation){if(operation instanceof BB.Models.BatchBoxGetOperation){return}Streak.Operations.ModelOperationManager.prototype._operationFailed.call(this,operation)},_createMoveBoxOperation:function(box,newPipelineKey){var operation=new BB.Models.MoveBoxOperation({model:box,newPipelineKey:newPipelineKey});return operation},_setupOperationProgressHandler:function(operationProgressId,oldPipelineKey,newPipelineKey){var newBoxCollection=BB.Data.getPipelineBoxes(newPipelineKey);var oldBoxCollection=BB.Data.getPipelineBoxes(oldPipelineKey);BB.ButterBarManager.showProgress({initial:false,progressSuccess:"moved_boxes_status_update",progressSuccessCallback:function(notification){notification.operation.getModel().postNotification("delete");newBoxCollection.add(notification.operation.getModel())},progressError:function(notification,strParameters){strParameters.box=_.escape(notification.operation.getModel().displayName());return BB.Locale.getString("moved_boxes_error_update",strParameters)},completeSuccess:undefined,completeError:"moved_boxes_error",operationProgressId:operationProgressId})},_handleBatchBoxGetOperation:function(operation){Streak.Operations.CollectionOperationManager.Singleton.updateCollectionWithResponse(BB.Data.getPipelineBoxes(operation.getPipelineKey()),operation.getResponse(),true);BB.Data.getPipelineBoxes(operation.getPipelineKey()).postNotification("collectionBatchUpdated")}});Library.set("BentoBox.Models.BoxOperationManager",new BoxOperationManager)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MoveBoxOperation=Streak.Class.subclass({className:"MoveBoxOperation",superclass:Streak.Operations.ModelSaveOperation,_memberVariables:[{name:"_oldPipelineKey",destroy:false},{name:"_newPipelineKey",destroy:false}],_initialize:function(options){this._newPipelineKey=options.newPipelineKey;this._oldPipelineKey=options.model.get("pipelineKey");Streak.Operations.ModelSaveOperation.prototype._initialize.call(this,options)},_getTags:function(){var baseTags=Streak.Operations.ModelSaveOperation.prototype._getTags.call(this);baseTags=baseTags.concat(["boxCollection_pipelineKey_"+this._newPipelineKey,"boxCollection_pipelineKey_"+this._oldPipelineKey,"box_move_pipelineKey_"+this._newPipelineKey,"box_move_pipelineKey_"+this._oldPipelineKey]);return baseTags},_getLimiterTagsAndTypes:function(){var tagsAndTypes=Streak.Operations.ModelSaveOperation.prototype._getLimiterTagsAndTypes.call(this);tagsAndTypes=tagsAndTypes.concat([{tag:BB.Data.getPipeline(this._newPipelineKey).get("orgKey"),type:Streak.Operations.OperationLimiterRules.TYPES.BOX_MOVE_PIPELINE},{tag:BB.Data.getPipeline(this._oldPipelineKey).get("orgKey"),type:Streak.Operations.OperationLimiterRules.TYPES.ENTITY_GROUP_WRITE},{tag:BB.Data.getPipeline(this._newPipelineKey).get("orgKey"),type:Streak.Operations.OperationLimiterRules.TYPES.BOX_MOVE_PIPELINE}]);return tagsAndTypes},getMethod:function(){return"POST"},getParams:function(){return this._getUpdateParams()},_getRequestObject:function(){var requestObject=Streak.Operations.ModelRequestOperation.prototype._getRequestObject.call(this);requestObject.pipelineKey=this._newPipelineKey;return requestObject}});Library.set("BentoBox.Models.MoveBoxOperation",MoveBoxOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BatchBoxGetOperation=Streak.Class.subclass({className:"BatchBoxGetOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_boxKeys",destroy:false},{name:"_pipelineKey",destroy:false,get:true}],_initialize:function(boxKeys,pipelineKey){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this);this._boxKeys=boxKeys;this._pipelineKey=pipelineKey},getMethod:function(){return"POST"},_executeAjaxRequest:function(){var path="pipelines/"+this._pipelineKey+"/boxes/batch";var bodyData=JSON.stringify(this._boxKeys);Streak.APIRequester.post(path,bodyData,null,{contentType:"application/json"}).getPromise().then(this._handleSuccess.bind(this),this._handleError.bind(this))}});Library.set("BentoBox.Models.BatchBoxGetOperation",BatchBoxGetOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,Model=Streak.Model,Collection=Streak.Collection,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLater=function(data){Model.call(this,data)};BumpLater.prototype=Object.create(Model.prototype);_.extend(BumpLater.prototype,{keyName:"bumpLaterKey",entityType:"BumpLater",typeName:"bumpLater",createProperties:["gmailThreadId","bumpDate","subject","rfcMessageId","onlyBumpIfNoResponse"],apiURLs:{get:"bumplaters/<%= bumpLaterKey %>",update:"bumplaters/<%= bumpLaterKey %>",create:"bumplaters","delete":"bumplaters/<%= bumpLaterKey %>"},tagEntityName:"bumpLater",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["bumpLater_create_noKey","bumpLaterCollection_noKey"]);break;case"DELETE":return baseTags.concat(["bumpLater_delete_noKey","bumpLaterCollection_noKey"]);break}return baseTags},getBumpDateObject:function(){if(!this.get("bumpDate")){return null}return Date.create(this.get("bumpDate"))},isActive:function(){return this.getBumpDateObject().isFuture()}});BumpLater.create=function(data){return new BumpLater(data)};BumpLater.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"bumpLaterKey",apiURL:"bumplaters",requestTags:["bumpLaterCollection_noKey"],requestDependentOnTags:["bumpLaterCollection_noKey"],refreshRequeueOperationTags:["bumpLaterCollection_delete_noKey","bumpLaterCollection_create_noKey"],createModelFromRawJSON:BumpLater.create});c.getActiveBumpLater=function(){var activeBumpLater;var activeBumpDate;for(var ii=0;ii<this.length;ii++){var bumpLater=this[ii];var bumpDate=bumpLater.getBumpDateObject();if(!bumpDate||bumpLater.get("status")!=="SCHEDULED"&&bumpLater.get("status")){continue}if(!activeBumpLater||activeBumpDate.isAfter(bumpDate)){activeBumpLater=bumpLater;activeBumpDate=bumpDate}}return activeBumpLater};return c};Library.set("BentoBox.Models.BumpLater",BumpLater)})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var ImportJob=function(data){Model.call(this,data)};ImportJob.prototype=Object.create(Model.prototype);_.extend(ImportJob.prototype,{keyName:"importJobKey",entityType:"ImportJob",typeName:"ImportJob",createProperties:["pipelineKey"],apiURLs:{get:"importjobs/<%= importJobKey %>",update:"importjobs/<%= importJobKey %>",create:"pipelines/<%= pipelineKey %>/importjobs","delete":"importjobs/<%= importJobKey %>"},tagEntityName:"importJob",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["importJob_create_pipelineKey_"+this.get("pipelineKey"),"importJobCollection"+this.get("pipelineKey")]);break;case"DELETE":return baseTags.concat(["importJob_delete_pipelineKey"+this.get("pipelineKey"),"importJobCollection"+this.get("pipelineKey")]);break}return baseTags},shouldShowSavingMessage:function(editOperations){return false}});ImportJob.create=function(data){return new ImportJob(data)};ImportJob.createCollection=function(pipelineKey){var c=new Collection;c.init({modelKeyPropertyName:"importJobKey",apiURL:"pipelines/"+pipelineKey+"/importjobs",refreshParameters:{statusList:["UPLOADED","VERIFIED","PROCESSING","INVALID_FILE","ERROR_IMPORTING"]},requestTags:["importJobCollection_pipelineKey_"+pipelineKey],requestDependentOnTags:["importJobCollection_pipelineKey_"+pipelineKey],refreshRequeueOperationTags:["importJob_create_pipelineKey_"+pipelineKey,"importJob_delete_pipelineKey"+pipelineKey],createModelFromRawJSON:ImportJob.create});return c};BB.Models.ImportJob=ImportJob})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var GmailThread=function(data){Model.call(this,data)};GmailThread.prototype=Object.create(Model.prototype);_.extend(GmailThread.prototype,{keyName:"gmailThreadKey",entityType:"GmailThread",typeName:"thread",createProperties:["boxKey","json"],apiURLs:{get:"threadinfo/<%= hexGmailThreadId %>/threads",create:"boxes/<%= boxKey %>/threads",update:"threads/<%= gmailThreadKey %>","delete":"threads/<%= gmailThreadKey %>"},getExtraRequestParameters:function(requestType){if(requestType==="CREATE"){return{json:JSON.stringify(BB.Services.Threads.ThreadStorer.getThreadMetaData(this.get("hexGmailThreadId")))}}},tagEntityName:"gmailThread",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["gmailThread_create_boxKey_"+this.get("boxKey"),"gmailThreadCollection_boxKey_"+this.get("boxKey"),"gmailThread_create_hexGmailThreadId_"+this.get("hexGmailThreadId"),"gmailThread_hexGmailThreadId_"+this.get("hexGmailThreadId")]);break;case"DELETE":return baseTags.concat(["gmailThread_delete_boxKey_"+this.get("boxKey"),"gmailThreadCollection_boxKey_"+this.get("boxKey"),"gmailThread_delete_hexGmailThreadId_"+this.get("threadGmailId"),"gmailThread_hexGmailThreadId_"+this.get("threadGmailId")]);break}return baseTags},getRequestDependentOnTags:function(requestType){var baseTags=Model.prototype.getRequestDependentOnTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["gmailThread_create_boxKey_"+this.get("boxKey"),"gmailThreadCollection_boxKey_"+this.get("boxKey"),"gmailThread_create_hexGmailThreadId_"+this.get("hexGmailThreadId"),"gmailThread_delete_hexGmailThreadId_"+this.get("hexGmailThreadId"),"gmailThread_hexGmailThreadId_"+this.get("hexGmailThreadId")]);break;case"DELETE":return baseTags.concat(["gmailThread_delete_boxKey_"+this.get("boxKey"),"gmailThreadCollection_boxKey_"+this.get("boxKey"),"gmailThread_create_hexGmailThreadId_"+this.get("threadGmailId"),"gmailThread_delete_hexGmailThreadId_"+this.get("threadGmailId"),"gmailThread_hexGmailThreadId_"+this.get("threadGmailId")]);break}},getRequestLimiterTagsAndTypes:function(requestType){if(!this.get("boxKey")){return[]}var box=BB.Data.getBox(this.get("boxKey"));return box.getRequestLimiterTagsAndTypes(requestType)},getResponseObjectAffectingModel:function(response){if(_.isArray(response)){return response[0]}return response}});GmailThread.create=function(data){return new GmailThread(data)};GmailThread.createCollection=function(boxKey){var c=new Collection;c.init({modelKeyPropertyName:"gmailThreadKey",apiURL:"boxes/"+boxKey+"/threads",requestTags:["gmailThreadCollection_boxKey_"+boxKey],requestDependentOnTags:["gmailThreadCollection_boxKey_"+boxKey],refreshRequeueOperationTags:["gmailThread_create_boxKey_"+boxKey,"gmailThread_delete_boxKey_"+boxKey],createModelFromRawJSON:GmailThread.create});return c};BB.Models.GmailThread=GmailThread})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Gmail=Streak.Gmail;var SendLater=function(data){Model.call(this,data);this._numberOfReplies=0};SendLater.prototype=Object.create(Model.prototype);_.extend(SendLater.prototype,{keyName:"sendLaterKey",entityType:"SendLater",typeName:"sendLater",createProperties:["gmailDraftId","sendDate","subject","sendLaterType"],apiURLs:{get:"sendlaters/<%= sendLaterKey %>",update:"sendlaters/<%= sendLaterKey %>",create:"sendlaters","delete":"sendlaters/<%= sendLaterKey %>"},tagEntityName:"sendLater",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["sendLater_create_noKey","sendLaterCollection_noKey"]);break;case"DELETE":return baseTags.concat(["sendLater_delete_noKey","sendLaterCollection_noKey"]);break}return baseTags},link:function(){return Gmail.Constants.Drafts+"/"+this.get("gmailDraftId")},incrementNumberOfReplies:function(){this._numberOfReplies+=1},decrementNumberOfReplies:function(){this._numberOfReplies-=1;if(this._numberOfReplies===0){this.del()}},isScheduled:function(){return this.get("sendDate")&&(this.get("status")==="SCHEDULED"||!this.get("status"))}});SendLater.create=function(data){return new SendLater(data)};SendLater.createCollection=function(caseKey){var c=new Collection;c.init({modelKeyPropertyName:"sendLaterKey",apiURL:"sendlaters",refreshParameters:{sendLaterStatusList:JSON.stringify(["SCHEDULED","ERROR_ON_SEND"])},requestTags:["sendLaterCollection_noKey"],requestDependentOnTags:["sendLaterCollection_noKey"],refreshRequeueOperationTags:["sendLaterCollection_delete_noKey","sendLaterCollection_create_noKey"],createModelFromRawJSON:SendLater.create});c.getSendLaterForHexGmailThreadId=function(hexGmailThreadId){for(var ii=0;ii<this.length;ii++){var sendLater=this[ii];if(sendLater.get("gmailDraftId")===hexGmailThreadId){return sendLater}}return null};return c};BB.Models.SendLater=SendLater})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var Reminder=function(data){Model.call(this,data)};Reminder.prototype=Object.create(Model.prototype);_.extend(Reminder.prototype,{keyName:"reminderKey",entityType:"Reminder",createProperties:["remindDate","boxKey","workflowKey","message","remindFollowers"],apiURLs:{get:"reminders/<%= reminderKey %>",update:"reminders/<%= reminderKey %>",create:"boxes/<%= boxKey %>/reminders","delete":"reminders/<%= reminderKey %>"},tagEntityName:"reminder",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["reminder_create_boxKey_"+this.get("boxKey"),"reminderCollection_boxKey_"+this.get("boxKey")]);break;case"DELETE":return baseTags.concat(["reminder_delete_boxKey_"+this.get("boxKey"),"reminderCollection_boxKey_"+this.get("boxKey")]);break}return baseTags}});Reminder.create=function(data){return new Reminder(data)};Reminder.createCollection=function(boxKey){var c=new Collection;c.init({modelKeyPropertyName:"reminderKey",apiURL:"boxes/"+boxKey+"/reminders",requestTags:["reminderCollection_boxKey_"+boxKey],requestDependentOnTags:["reminderCollection_boxKey_"+boxKey],refreshRequeueOperationTags:["reminder_create_boxKey_"+boxKey,"reminder_delete_boxKey_"+boxKey],createModelFromRawJSON:Reminder.create});return c};BB.Models.Reminder=Reminder})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var Snippet=function(data){Model.call(this,data)};Snippet.prototype=Object.create(Model.prototype);_.extend(Snippet.prototype,{keyName:"snippetKey",entityType:"Snippet",typeName:"snippet",createProperties:["snippetName","snippetText","subject"],requiredCreate:["snippetName","snippetText"],nameProperty:"snippetName",apiURLs:{get:"snippets/<%= snippetKey %>",update:"snippets/<%= snippetKey %>",create:"snippets","delete":"snippets/<%= snippetKey %>"},tagEntityName:"snippet",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["snippet_create_noKey","snippetCollection_noKey"]);break;case"DELETE":return baseTags.concat(["snippet_delete_noKey","snippetCollection_noKey"]);break}return baseTags},getText:function(){var text=this.get("snippetText");if(text&&text.value){text=text.value}if(this.get("snippetType")==="TEXT"){text=Streak.$.getTextHTML(text)}return text},preSaveFunction:function(serverObject){if(!serverObject.snippetText){return false}if(!serverObject.snippetName){return false}serverObject.partOfPipeline=!!serverObject.pipelineKey;return true}});Snippet.create=function(data){return new Snippet(data)};Snippet.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"snippetKey",apiURL:"snippets",requestTags:["snippetCollection_noKey"],requestDependentOnTags:["snippetCollection_noKey"],refreshRequeueOperationTags:["snippetCollection_delete_noKey","snippetCollection_create_noKey"],createModelFromRawJSON:Snippet.create});return c};BB.Models.Snippet=Snippet})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var File=function(data){Model.call(this,data)};File.prototype=Object.create(Model.prototype);_.extend(File.prototype,{keyName:"fileKey",entityType:"File",typeName:"File",nameProperty:"fileName",apiURLs:{get:"files/<%= fileKey %>","delete":"files/<%= fileKey %>"},link:function(){if(this.get("fileType")==="DRIVE"){return this.get("driveUrl")}else{var url=Streak.server+"/api/v1/files/"+this.get("fileKey")+"/redirect";if(Streak.ai){url+="?ai=true&email="+encodeURIComponent(Streak.ai)}else{url+="?email="+encodeURIComponent(Streak.userEmail)+"&clientVersion="+encodeURIComponent(Streak.clientVersion)
}return url}},tagEntityName:"file",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["file_create_boxKey_"+this.get("boxKey"),"fileCollection_boxKey_"+this.get("boxKey")]);break;case"DELETE":return baseTags.concat(["file_delete_boxKey_"+this.get("boxKey"),"fileCollection_boxKey_"+this.get("boxKey")]);break}return baseTags}});File.create=function(data){return new File(data)};File.createCollection=function(boxKey){var c=new Collection;c.init({modelKeyPropertyName:"fileKey",apiURL:"boxes/"+boxKey+"/files",requestTags:["fileCollection_boxKey_"+boxKey],requestDependentOnTags:["fileCollection_boxKey_"+boxKey],refreshRequeueOperationTags:["file_create_boxKey_"+boxKey,"file_delete_boxKey_"+boxKey],createModelFromRawJSON:File.create});return c};BB.Models.File=File})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var User=function(data){Model.call(this,data);this.streakSettings=null;this._isGoogleAppsUser=BB.Constants.EMAIL_BLACK_LIST.indexOf(this.getDomain().toLowerCase())===-1};User.prototype=Object.create(Model.prototype);_.extend(User.prototype,{entityType:"User",keyName:"userKey",nameProperty:"displayName",apiURLs:{get:"users/me",update:"users/<%= userKey %>"},tagEntityName:"user",getHeadsUpSections:function(){return BB.UserSettings.getSetting("headsUp/sections")||[]},saveHeadsUpSections:function(headsUpSections){var sectionsToSave=headsUpSections||BB.UserSettings.getSetting("headsUp/sections");BB.UserSettings.setSetting("headsUp/sections",sectionsToSave);BB.UserSettings.saveSettings()},getEmail:function(){return this.get("email").toLowerCase()},getDomain:function(){return this.get("email").split("@")[1]},isGoogleAppsUser:function(){return this._isGoogleAppsUser},isExternalSharingRestricted:function(){return!!this.get("externalSharingRestrictionOnTeamsPipelines")},setIsExternalSharingRestricted:function(value){this.set("externalSharingRestrictionOnTeamsPipelines",value)},isSecurityReportEnabled:function(){return this.get("securityReportOnTeamsPipelines")},setIsSecurityReportEnabled:function(value){this.set("securityReportOnTeamsPipelines",value)},isAutomaticInvoiceEmailEnabled:function(){return this.get("automaticallySendInvoiceEmails")},setAutomaticInvoiceEmailEnabled:function(value){this.set("automaticallySendInvoiceEmails",value)}});User.create=function(data){return new User(data)};BB.Models.User=User})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var UserUISettings=function(data){Model.call(this,data)};UserUISettings.prototype=Object.create(Model.prototype);_.extend(UserUISettings.prototype,{keyName:"userUISettingsKey",entityType:"userUISettings",typeName:"userUISettings",apiURLs:{get:"users/me/uisettings",update:"users/me/uisettings/<%= userUISettingsKey %>"},tagEntityName:"userUiSettings",shouldShowSavingMessage:function(editOperations){return false}});UserUISettings.create=function(data){return new UserUISettings(data)};BB.Models.UserUISettings=UserUISettings})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var StreakSettings=function(data){Model.call(this,data)};StreakSettings.prototype=Object.create(Model.prototype);_.extend(StreakSettings.prototype,{entityType:"StreakSettings",keyName:"streakSettingsKey",apiURLs:{get:"users/me/settings",update:"users/me/settings/<%= streakSettingsKey %>"},tagEntityName:"streakSettings",setValueByKey:function(pageKey,sectionKey,settingKey,propertyKey,newValue){var pages=this.get("pages");var page=_.find(pages,function(_page){return _page.key===pageKey});var section=_.find(page.sections,function(_section){return _section.key===sectionKey});var setting;_.each(section.settings,function(s){if(s.key===settingKey){s[propertyKey]=newValue}else{_.each(s.subsettings,function(subsetting){if(subsetting.key===settingKey){subsetting[propertyKey]=newValue}})}});this.set("pages",pages)},setSelectedValues:function(pageKey,sectionKey,settingKey,newValue){this.setValueByKey(pageKey,sectionKey,settingKey,"selectedValues",newValue);BB.Tracker.trackStreakActive({widgetContext:"streakSettigns"},{settingKey:settingKey},{eventName:"setSelectedValues"});this.save()},setSettingValue:function(settingName,value){var setting=this.getSetting(settingName);setting.selectedValues=value;this.save()},getPages:function(){return this.get("pages")},forceRefresh:function(){try{this.refresh()}catch(e){}},getSetting:function(settingName){var _setting;var pages=this.get("pages");_.each(pages,function(page){_.each(page.sections,function(section){_.each(section.settings,function(setting){if(setting.displayName===settingName){_setting=setting}else{_.each(setting.subsettings,function(subsetting){if(subsetting.displayName===settingName){_setting=subsetting}})}})})});return _setting},settingIsEnabled:function(settingName){var setting=this.getSetting(settingName);if(_.isDefined(setting)){var settingSelectedValues=setting.selectedValues;if(_.contains(setting.selectedValues,"default")){settingSelectedValues=setting.defaultValues}if(_.contains(settingSelectedValues,"enabled")){return true}}return false}});StreakSettings.create=function(data){return new StreakSettings(data)};BB.Models.StreakSettings=StreakSettings})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Locale=BB.Locale;var EmailFilter=function(data){Model.call(this,data)};EmailFilter.prototype=Object.create(Model.prototype);_.extend(EmailFilter.prototype,{keyName:"key",nameProperty:"value",createProperties:["type","value","boxKey"],apiURLs:{get:"emailfilters/<%= key %>","delete":"emailfilters/<%= key %>",create:"emailfilters"},tagEntityName:"emailFilter",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["emailFilter_create_boxKey_"+this.get("boxKey"),"emailFilterCollection_boxKey_"+this.get("boxKey")]);break;case"DELETE":return baseTags.concat(["emailFilter_delete_boxKey_"+this.get("boxKey"),"emailFilterCollection_boxKey_"+this.get("boxKey")]);break}return baseTags},matches:function(emailAddress){var type=this.get("type"),value=this.get("value");if(type==="EMAIL_ADDRESS_FILTER"){return value===emailAddress}else if(type==="DOMAIN_FILTER"){return emailAddress.endsWith(value)}else{return false}},filterDisplayHtml:function(){var type=this.get("type"),value=this.get("value");if(type==="EMAIL_ADDRESS_FILTER"){return Locale.getString("email_suggestion_creation_one_email",{email:_.escape(value)})}else if(type==="DOMAIN_FILTER"){return Locale.getString("email_suggestion_creation_one_domain",{domain:_.escape(value)})}else{return"Error."}}});EmailFilter.create=function(data){return new EmailFilter(data)};EmailFilter.createCollection=function(boxKey){var c=new Collection;c.init({modelKeyPropertyName:"key",apiURL:"boxes/"+boxKey+"/emailfilters",requestTags:["emailFilterCollection_refresh_boxKey_"+boxKey],requestDependentOnTags:["emailFilterCollection_refresh_boxKey_"+boxKey],refreshRequeueOperationTags:["emailFilter_create_boxKey_"+boxKey,"emailFilter_delete_boxKey_"+boxKey],createModelFromRawJSON:EmailFilter.create});return c};BB.Models.EmailFilter=EmailFilter})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var EmailFilterBlacklist=function(data){Model.call(this,data)};EmailFilterBlacklist.prototype=Object.create(Model.prototype);_.extend(EmailFilterBlacklist.prototype,{keyName:"key",nameProperty:"blacklistEmail",createProperties:["blacklistEmail"],apiURLs:{get:"emailfilterpromoblacklists/<%= key %>","delete":"emailfilterpromoblacklists/<%= key %>",create:"emailfilterpromoblacklists",update:"emailfilterpromoblacklists/<%= key %>"},tagEntityName:"emailFilterBlacklist",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["emailFilterBlacklist_create_noKey","emailFilterBlacklistCollection_noKey"]);break;case"DELETE":return baseTags.concat(["emailFilterBlacklist_delete_noKey","emailFilterBlacklistCollection_noKey"]);break}return baseTags},matches:function(emailAddress){return this.get("blacklistEmail")===emailAddress}});EmailFilterBlacklist.create=function(data){return new EmailFilterBlacklist(data)};EmailFilterBlacklist.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"key",apiURL:"emailfilterpromoblacklists",requestTags:["emailFilterBlacklistCollection_noKey"],requestDependentOnTags:["emailFilterBlacklistCollection_noKey"],refreshRequeueOperationTags:["emailFilterBlacklist_create_noKey","emailFilterBlacklist_delete_noKey"],createModelFromRawJSON:EmailFilterBlacklist.create});return c};BB.Models.EmailFilterBlacklist=EmailFilterBlacklist})(Streak);(function(Streak){var _=Streak._,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Locale=BB.Locale;var Plan=function(data){Model.call(this,data)};var CONSTANTS={HIDDEN_FEATURES:["unlimitedPixelTracking"]};Plan.prototype=Object.create(Model.prototype);_.extend(Plan.prototype,{keyName:"key",nameProperty:"name",createProperties:["billingPeriodType","billingUnitType","restrictionType","upgradeType","name","price","features","defaultDiscountPercentage","defaultTrialPeriodDays","creationTimestamp","lastUpdatedTimestamp","restrictionMaxUsers","autoUpgradeToPlanId"],apiURLs:{get:"plans/<%= key %>","delete":"plans/<%= key %>",create:"plans"},tagEntityName:"plan",getDescriptionFeatures:function(){var features=this.get("features");var description_features=_.difference(features,CONSTANTS.HIDDEN_FEATURES);return description_features},getSummaryFeatures:function(){var features=this.get("features");features=_.difference(features,CONSTANTS.HIDDEN_FEATURES);var summary_features=_.chain(features).map(function(feature){return Locale.getString("feature_summary_"+feature)}).reject(function(localizedString){return localizedString.indexOf("feature_summary_")!=-1}).value();return summary_features},getLocalizedName:function(){var localizedPlanNameKey="plan_name_"+this.get("planId");var localizedPlanName=Locale.getString(localizedPlanNameKey);if(localizedPlanName===localizedPlanNameKey){localizedPlanName=this.get("name")}return localizedPlanName},getLearnMoreText:function(){var learnMoreKey="plan_learn_more_"+this.get("planId");var learnMoreString=Locale.getString(learnMoreKey);var learnMoreText=learnMoreString!=learnMoreKey?learnMoreString:"";return learnMoreText},getCollaboratorLimit:function(){if(this.get("hasAllowedCollaboratorLimit")){return this.get("collaboratorLimit")}else{return null}},getPlanId:function(){return this.get("planId")}});Plan.create=function(data){return new Plan(data)};Plan.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"key",apiURL:"plans",requestTags:["planCollection_noKey"],requestDependentOnTags:["planCollection_noKey"],refreshRequeueOperationTags:["planCollection_delete_noKey","planCollection_create_noKey"],createModelFromRawJSON:Plan.create});return c};Plan.getParticipatingPlans=function(options){options=options||{};var c=new Collection;var userKey=options.userKey?options.userKey:"me";c.init({modelKeyPropertyName:"key",apiURL:"users/"+userKey+"/plans",requestTags:["planCollection_noKey"],requestDependentOnTags:["planCollection_noKey"],refreshRequeueOperationTags:["planCollection_delete_noKey","planCollection_create_noKey"],createModelFromRawJSON:Plan.create});return c};BB.Models.Plan=Plan})(Streak);(function(Streak){var _=Streak._,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var PlanInstance=function(data){Model.call(this,data)};PlanInstance.prototype=Object.create(Model.prototype);_.extend(PlanInstance.prototype,{keyName:"key",nameProperty:"name",createProperties:["userEmailList","planId","enrollmentType","trialPeriodDays","enrollmentType","discountPercentage"],apiURLs:{get:"planinstances/<%= key %>",update:"planinstances/<%= key %>",create:"users/me/planinstances"},isActive:function(){return this.get("state")==="ACTIVE"},activate:function(){this.set("state","ACTIVE");var self=this;return new Streak.RSVP.Promise(function(resolve,reject){self.save(resolve,reject)})},getPlanId:function(){if(this.get("plan")){return this.get("plan").planId}return undefined}});PlanInstance.create=function(data){return new PlanInstance(data)};PlanInstance.getBillingPlanInstances=function(options){options=options||{};var userKey=options.userKey?options.userKey:"me";var c=new Collection;c.init({modelKeyPropertyName:"key",apiURL:"users/"+userKey+"/planinstances",requestTags:["planInstanceCollection_noKey"],requestDependentOnTags:["planInstanceCollection_noKey"],refreshRequeueOperationTags:["planInstanceCollection_create_noKey","planInstanceCollection_delete_noKey"],createModelFromRawJSON:PlanInstance.create});return c};BB.Models.PlanInstance=PlanInstance})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;var self=InboxManipulator={CONSTANTS:{COLUMN_NAMES:["CHECKBOX","STAR","PEOPLE","IMPORTANCE","SUBJECT","ATTACHMENTS","DATE","LABELS"],TABLE_MANIPULATION_TYPES:["COLUMN_WIDTH"],ROW_MANIPULATION_TYPES:["PREPEND_ELEMENT","APPEND_ELEMENT","REMOVE_ELEMENT","REPLACE_CONTENT"]},_columnNameColGroupMap:{CHECKBOX:"Ci",STAR:"y5",PEOPLE:"yY",IMPORTANCE:"yF",SUBJECT:"null",ATTACHMENTS:"yg",DATE:"xX"},_columnNameRowObjectMap:{STAR:"starHolder",LABELS:"labelContainer",SUBJECT:"subjectLink",ATTACHMENTS:"attachmentsContainer",DATE:"date"},_dataSources:[],init:function(){Streak.NotificationCenter.subscribe({eventName:"gmail.newThreadDOMRows",observer:this,functionToCall:this.refreshAll});Streak.NotificationCenter.subscribe({eventName:"gmail.newThreadDOMRow",observer:this,functionToCall:this.handleNewThreadDOMRow});Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"boxKey"},functionToCall:this.refreshAll});Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"sendLater"},functionToCall:this.refreshAll});Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"trackedThread"},functionToCall:_.debounce(this.refreshAll.bind(this),100)});Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"bumpLaterCollection"},functionToCall:_.debounce(this.refreshAll.bind(this),100)})},refreshAll:_.debounce(function(isSecond){if(!Gmail.isListView()){return}if(isSecond!==null){self._getAndApplyTableManipulations()}var threadDOMRows=Gmail.getThreadDOMRows();var hexGmailThreadIdList=BB.Services.Threads.HexGmailThreadIdExtractor.getHexGmailThreadIdList(threadDOMRows);var anyThatAreNull=_.any(hexGmailThreadIdList,function(hexGmailThreadId){return!hexGmailThreadId});if(anyThatAreNull&&isSecond!==true){self._getThreadResponseForCurrentList();return}Gmail.getCurrentMain().find(".streak__inboxManipulatorElement").remove();for(var ii=0;ii<threadDOMRows.length;ii++){if(hexGmailThreadIdList[ii]){self._refreshRow(hexGmailThreadIdList[ii],threadDOMRows[ii])}}},20),handleNewThreadDOMRow:function(notification){this.refreshRow(notification.threadDOMRow)},refreshRow:function(threadDOMRow){var hexGmailThreadId=BB.Services.Threads.HexGmailThreadIdExtractor.getHexGmailThreadIdList([threadDOMRow]);if(!hexGmailThreadId){return}if(threadDOMRow.node){for(var ii=0;ii<threadDOMRow.node.length;ii++){$(threadDOMRow.node).find(".streak__inboxManipulatorElement").remove()}}this._refreshRow(hexGmailThreadId,threadDOMRow)},addDataSource:function(dataSource){self._dataSources.push(dataSource);self._dataSources=_.sortBy(self._dataSources,function(dataSource){return dataSource.priority});if(dataSource.getGlobalManipulation&&dataSource.getGlobalManipulation()){self._applyGlobalManipulation(dataSource.getGlobalManipulation())}self.refreshAll()},_getThreadResponseForCurrentList:function(){Gmail.GmailRequester.getCurrentList(function(crapFormatThreadResponse){var threads=Gmail.ThreadResponseProcessor.extractThreads(crapFormatThreadResponse);Streak.BentoBox.Services.Threads.ThreadMetaDataCreator.processCrapFormatThreads(threads);self.refreshAll(true)},function(){self.refreshAll(true);return true})},_applyGlobalManipulation:function(globalManipulation){if(!globalManipulation){return}switch(globalManipulation.type){case"CSS_CHANGE":self._applyCSSManipulation(globalManipulation.columnName,globalManipulation.cssRule);break}},_applyCSSManipulation:function(columnName,cssRule){var selector="[gh=tl] colgroup col."+self._columnNameColGroupMap[columnName];Streak.CSSStyleManipulator.addRule(selector+"{ "+cssRule+";}",0)},_getAndApplyTableManipulations:function(){for(var ii=0;ii<self._dataSources.length;ii++){if(self._dataSources[ii]&&self._dataSources[ii].getTableManipulation){self._applyTableManipulation(self._dataSources[ii].getTableManipulation())}}},_applyTableManipulation:function(tableManipulation){if(!tableManipulation){return}switch(tableManipulation.type){case"COLUMN_WIDTH":self._changeColumnWidth(tableManipulation.columnName,tableManipulation.width);break}},_changeColumnWidth:function(columnName,width){var colGroup=self._getColGroup(columnName);colGroup.css("width",width+"px")},_getColGroup:function(columnName){return Gmail.getCurrentMain().find("[gh=tl] colgroup col."+self._columnNameColGroupMap[columnName])},_refreshRow:function(hexGmailThreadId,threadDOMRow){var manipulations=self._getRowManipulations(hexGmailThreadId,threadDOMRow);self._applyRowManipulations(threadDOMRow,manipulations)},_getRowManipulations:function(hexGmailThreadId,threadDOMRow){var manipulations=[];for(var ii=0;ii<self._dataSources.length;ii++){try{if(hexGmailThreadId){manipulations.push(self._dataSources[ii].getRowManipulation(hexGmailThreadId,threadDOMRow))}}catch(err){BB.logError("get row manipulation fail",err)}}return manipulations},_applyRowManipulations:function(threadDOMRow,manipulations){if(!manipulations){return}for(var ii=0;ii<manipulations.length;ii++){try{self._applyOneOrMoreRowManipulations(threadDOMRow,manipulations[ii])}catch(err){BB.logError("row manipulation fail",err)}}},_applyOneOrMoreRowManipulations:function(threadDOMRow,manipulation){if(!manipulation){return}if(_.isArray(manipulation)){for(var ii=0;ii<manipulation.length;ii++){this._applyRowManipulation(threadDOMRow,manipulation[ii])}}else{this._applyRowManipulation(threadDOMRow,manipulation)}},_applyRowManipulation:function(threadDOMRow,manipulation){manipulation.setThreadDOMRow(threadDOMRow);switch(manipulation.getManipulationType()){case"PREPEND_ELEMENT":self._insertElementIntoRow(threadDOMRow,manipulation.getColumnName(),manipulation.getElement(),"prepend");break;case"APPEND_ELEMENT":self._insertElementIntoRow(threadDOMRow,manipulation.getColumnName(),manipulation.getElement(),"append");break;case"REMOVE_ELEMENT":self._removeElement(threadDOMRow,manipulation.getColumnName(),manipulation.getSelector());break;case"REPLACE_CONTENT":self._replaceContent(threadDOMRow,manipulation.getColumnName(),manipulation.getElement());break}},_insertElementIntoRow:function(threadDOMRow,columnName,element,attachMethod){if(!element){return}if(columnName==="ATTACHMENTS"){self._expandAttachmentsIfNeeded(threadDOMRow)}var columnElement=threadDOMRow[self._columnNameRowObjectMap[columnName]];if(columnElement&&columnElement[attachMethod]){for(var ii=0;ii<element.length;ii++){$(element[ii]).addClass("streak__inboxManipulatorElement");threadDOMRow[self._columnNameRowObjectMap[columnName]][attachMethod](element[ii])}}},_removeElement:function(threadDOMRow,columnName,selector){threadDOMRow[self._columnNameRowObjectMap[columnName]].find(selector).remove()},_replaceContent:function(threadDOMRow,columnName,element){element.addClass("streak__inboxManipulatorElement");threadDOMRow[self._columnNameRowObjectMap[columnName]].html(element)},_expandAttachmentsIfNeeded:function(threadDOMRow){if(threadDOMRow.type==="vertical"){return}if(!self._rowHasAttachment(threadDOMRow)){return}self._changeColumnWidth("ATTACHMENTS",50)},_rowHasAttachment:function(threadDOMRow){return threadDOMRow.rowNode.find("td.yf img").length>0||threadDOMRow.rowNode.find("td.yf span").length>0}};Streak.DependencyManager.addFunction({functionKey:"inboxManipulatorInitialized",functionReference:InboxManipulator.init,functionContext:InboxManipulator,dependentFunctionKeys:["gmailLoaded"]});Streak.NotificationCenter.subscribe({eventName:"streak.teardown",functionToCall:function(){InboxManipulator.refreshAll()},observer:InboxManipulator});Streak.NotificationCenter.subscribe({eventName:"streak.reup",functionToCall:function(){InboxManipulator.refreshAll()},observer:InboxManipulator});Streak.Gmail.InboxManipulator=InboxManipulator})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var InboxRowManipulationBase=Streak.Class.subclass({className:"InboxRowManipulationBase",superclass:Streak.Object,_memberVariables:[{name:"_threadDOMRow",destroy:false,set:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getManipulationType:function(){throw new Error("must define get manipulation types")},getColumnName:function(){throw new Error("must define get column name")},getElement:function(){throw new Error("must define get element")}});Gmail.InboxManipulator.InboxRowManipulationBase=InboxRowManipulationBase})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Bacon=Streak.Bacon,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var InboxSectionManager=Streak.Class.subclass({className:"InboxSectionManager",superclass:Streak.Object,_memberVariables:[{name:"_sections",destroy:true,defaultValue:[]}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._initBindings()},addSection:function(section){this._sections.push(section);if(Gmail.isListView()){this._processSection(section)}},_initBindings:function(){var self=this;Gmail.getEventStream().filter(function(event){return event.eventName==="viewChanged"}).onValue(function(){if(Gmail.isListView()){self._processSections()}else{self._removeSections()}})},_processSections:function(){for(var ii=0;ii<this._sections.length;ii++){this._processSection(this._sections[ii])}},_processSection:function(section){if(this._isSectionRelevant(section)){this._injectSection(section)}else{this._removeSection(section)}},_isSectionRelevant:function(section){if(Gmail.hash.parts.length<2){return section.isViewRelevant(Gmail.view)}var lastPart=_.last(Gmail.hash.parts);if(lastPart.match(/^p\d+$/)){var currentPage=parseInt(lastPart.replace(/p/,""),10);if(currentPage>1){return false}}return section.isViewRelevant(Gmail.view)},_injectSection:function(section){var element=section.getElement();var main=Gmail.getCurrentMain();if(!main.isVisible()){return}main.before(element);return;main.find("[gh=tl]").filter(":first").before(element);main.find(".aAD").filter(":first").removeClass("aAD");main.find(".Wg").filter(":first").addClass("aAD")},_removeSections:function(){for(var ii=0;ii<this._sections.length;ii++){this._removeSection(this._sections[ii])}},_removeSection:function(section){section.removeElement()}});Library.set("Gmail.InboxSectionManager",new InboxSectionManager)})(Streak);Streak.UI={};(function(Streak){var _=Streak._;var superclass=Streak.Object;Streak.UI.Delegator=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_delegates",destroy:false},{name:"_delegate",destroy:false,set:true},{name:"_eventStream",destroy:false,get:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._delegates=[];this._eventStream=new Streak.Bacon.Bus},addDelegate:function(delegate){if(this._delegates.indexOf(delegate)===-1){this._delegates.push(delegate)}},removeDelegate:function(delegate){var index=this._delegates.indexOf(delegate);if(index>-1){this._delegates.splice(index,1)}},removeAllDelegates:function(){this._delegates.length=0},_callDelegateFunction:function(functionName){var args=_.rest(_.toArray(arguments));if(this._delegate&&this._delegate[functionName]){this._delegate[functionName].apply(this._delegate,args)}if(!this._delegates){return}var delegates=_.clone(this._delegates);for(var i=0;i<delegates.length;i++){if(delegates[i][functionName]){try{delegates[i][functionName].apply(delegates[i],args)}catch(err){Streak.BentoBox.logError("error in delegator",err)}}}},_callDelegateFunctionOnDelegate:function(functionName,delegate){var args=_.rest(_.toArray(arguments),2);if(delegate&&delegate[functionName]){delegate[functionName].apply(delegate,args)}},destroy:function(){if(this._eventStream){this._eventStream.end()}Streak.Object.prototype.destroy.call(this)}})})(Streak);(function(Streak){var UI=Streak.UI;UI.DataSourceDelegateMixin=function(superclass){return{memberVariables:[{name:"_dataSource",destroy:false}],setDataSource:function(dataSource){this._removeCurrentDataSource();this._dataSource=dataSource;dataSource.addDelegate(this)},_removeCurrentDataSource:function(){if(this._dataSource!==null){this._dataSource.removeDelegate(this);this._dataSource=null}},handleDataUpdated:function(dataSource){},destroy:function(){this._removeCurrentDataSource();superclass.prototype.destroy.call(this)}}}})(Streak);(function(Streak){var $=Streak.$;var superclass=Streak.UI.Delegator;Streak.UI.View=Streak.Class.subclass({className:"View",superclass:superclass,memberVariables:[{name:"_element",destroy:true,get:true},{name:"_eventStream",destroy:true,get:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupElement();this._eventStream=new Streak.Bacon.Bus},_setupElement:function(){this._element=$(document.createElement("div"))},addSubView:function(subView){this._element.append(subView.getElement())},prependSubView:function(subView){this._element.prepend(subView.getElement())},setSubview:function(subview){this._element.html(subview.getElement())},setText:function(text){this._element.text(text)},setHTML:function(html){this._element[0].innerHTML=html},addClass:function(className){this._element.addClass(className)},removeClass:function(className){this._element.removeClass(className)},empty:function(){this._element[0].innerHTML=""}})})(Streak);(function(Streak){var UI=Streak.UI;var superclass=UI.Delegator;UI.ViewController=Streak.Class.subclass({className:"ViewController",superclass:superclass,memberVariables:[{name:"_view",destroy:true,get:true},{name:"_viewEventStreamUnplugger",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupView();this._devAssociateElement();if(this._view&&this._view.setDelegate){this._view.setDelegate(this)}if(this._view&&this._view.getEventStream&&this._view.getEventStream()){this._viewEventStreamUnplugger=this._eventStream.plug(this._view.getEventStream())}},_setupView:function(){this._view=new UI.View},_devAssociateElement:function(){if(Streak.isDev){try{var el=this._view&&this._view.getElement&&this._view.getElement();if(el){var debug=Streak.$(el).data("debug")||{};debug.viewController=this;Streak.$(el).data("debug",debug)}}catch(e){Streak.BentoBox.logError("Could not associate element in view controller",e)}}},setView:function(view){if(this._view){this._view.destroy()}this._view=view;this._devAssociateElement()}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.ViewController;UI.CollectionViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_viewControllers",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._viewControllers=[]},addViewController:function(viewController){this._viewControllers.push(viewController);this._view.addSubView(viewController.getView())}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.ViewController;UI.HorizontalCollectionViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_viewControllers",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._viewControllers=[];this._view.addClass("__streak_horizontal_layout")},addViewController:function(viewController){this._viewControllers.push(viewController);this._view.addSubView(viewController.getView())}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.ViewController;UI.SplitRowsCollectionViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_numberOfColumnsInRow",destroy:false},{name:"_numberOfRows",destroy:false},{name:"_verticalViewControllers",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._numberOfColumnsInRow={};this._numberOfRows=0;this._verticalViewControllers=[]},addRow:function(){this._numberOfRows+=1;var horizontalViewController=new UI.HorizontalCollectionViewController;this._verticalViewControllers.push(horizontalViewController);this._view.addSubView(horizontalViewController.getView());return this._numberOfRows-1},getLastRow:function(){return this._numberOfRows-1},addViewControllerToRow:function(viewController,row){this._numberOfColumnsInRow[row]=(this._numberOfColumnsInRow[row]||0)+1;var rowController=this._verticalViewControllers[row];rowController.addViewController(viewController);return this._numberOfColumnsInRow[row]-1}})})(Streak);(function(Streak){var UI=Streak.UI;var superclass=UI.View;UI.ChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_data",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupChart()},_setupChart:function(){},setData:function(data){this._data=data;this._drawChart()},_drawChart:function(){},windowResized:function(){this._drawChart()}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.ChartView;UI.GoogleChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_googleChartClass",destroy:false},{name:"_chart",destroy:false},{name:"_googleFormattedData",destroy:false},{name:"_chartOptions",destroy:false,get:true}],setGoogleChartClass:function(googleChartClass){this._googleChartClass=googleChartClass;this._chart=new this._googleChartClass(this.getChartContainerElement());this._chartOptions={}},getChartContainerElement:function(){return this._element[0]},setChartOptions:function(options){_.extend(this._chartOptions,this._chartOptions,options)},setData:function(data){if(data){if(_.isArray(data)){this._googleFormattedData=google.visualization.arrayToDataTable(data)}else{this._googleFormattedData=data}}else{this._googleFormattedData=null}superclass.prototype.setData.call(this,data)},setVAxisLabel:function(label){if(!this._chartOptions.vAxis){this._chartOptions.vAxis={}}this._chartOptions.vAxis.title=label},setSeriesOptions:function(seriesOptions){this._chartOptions.series=seriesOptions},_drawChart:function(){if(this._googleFormattedData){this._chart.draw(this._googleFormattedData,this.getChartOptions())}}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.GoogleChartView;UI.BarChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_legendWidth",destroy:false,get:true}],_initialize:function(){superclass.prototype._initialize.call(this);this.setGoogleChartClass(google.visualization.BarChart);this._chartOptions={hAxis:{viewWindow:{},gridlines:{},minorGridlines:{},titleTextStyle:{},textStyle:{}},chartArea:{},legend:{}}},setIsStacked:function(isStacked){this._chartOptions.isStacked=isStacked
},setLegendWidth:function(legendWidth){this._legendWidth=legendWidth},_computeWidth:function(){if(this._legendWidth){this.setChartWidthPercentage((this._element.width()-this._legendWidth)*100/this._element.width())}},setSeriesColors:function(colors){this._chartOptions.series=_.map(colors,function(color){return{color:color}})},setHeight:function(height){this._chartOptions.height=height},setChartHeightPercentage:function(percentage){if(percentage){this._chartOptions.chartArea.height=percentage+"%"}else{this._chartOptions.chartArea.height=null}},setChartWidthPercentage:function(percentage){if(percentage){this._chartOptions.chartArea.width=percentage+"%"}else{this._chartOptions.chartArea.width=null}},setMinimum:function(minimum){this._chartOptions.hAxis.minValue=minimum;this._chartOptions.hAxis.viewWindow.min=minimum},setTitle:function(title){this._chartOptions.title=title},showHAxis:function(show){if(show){delete this._chartOptions.hAxis.baselineColor;delete this._chartOptions.hAxis.titleTextStyle.color;delete this._chartOptions.hAxis.textStyle.color}else{this._chartOptions.hAxis.baselineColor="transparent";this._chartOptions.hAxis.titleTextStyle.color="transparent";this._chartOptions.hAxis.textStyle.color="transparent"}},showHGridlines:function(show){if(show){delete this._chartOptions.hAxis.minorGridlines.color;delete this._chartOptions.hAxis.gridlines.color}else{this._chartOptions.hAxis.minorGridlines.color="transparent";this._chartOptions.hAxis.gridlines.color="transparent"}},showLegend:function(show){if(show){delete this._chartOptions.legend.position}else{this._chartOptions.legend.position="none"}},getChartOptions:function(){this._computeWidth();return superclass.prototype.getChartOptions.call(this)}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=UI.GoogleChartView;UI.TimelineChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_chartOptions",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this.setGoogleChartClass(google.visualization.Timeline);this._chartOptions={}}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.GoogleChartView;UI.RingChartView=Streak.Class.subclass({superclass:superclass,_memberVariables:[{name:"_googleRingChartContainer",destroy:true},{name:"_centerLabelElementContainer",destroy:true},{name:"_centerLabelValue",set:true,get:true,destroy:true},{name:"_centerLabelUnit",set:true,get:true,destroy:true},{name:"_centerLabelValueElement",destroy:true},{name:"_centerLabelUnitElement",destroy:true}],_initialize:function(options){superclass.prototype._initialize.call(this,options);this.setGoogleChartClass(google.visualization.PieChart,this._googleRingChartContainer)},_setupElement:function(){superclass.prototype._setupElement.call(this);this._element=HTML.getElement("streak__ringChart");this._googleRingChartContainer=this._element.find(".streak__googleRingChartContainer");this._centerLabelValueElement=this._element.find(".streak__ringChartCenterLabelValue");this._centerLabelUnitElement=this._element.find(".streak__ringChartCenterLabelUnit");this._centerLabelElementContainer=this._element.find(".streak__ringChartCenterLabelContainer")},getChartContainerElement:function(){return this._googleRingChartContainer[0]},_drawChart:function(){superclass.prototype._drawChart.apply(this,arguments);var boundingBox=this._chart.getChartLayoutInterface().getChartAreaBoundingBox();var legendBoundingBox=this._chart.getChartLayoutInterface().getBoundingBox("legend");this._centerLabelElementContainer[0].style.top=boundingBox.top+"px";this._centerLabelElementContainer[0].style.left=boundingBox.left+"px";this._centerLabelElementContainer[0].style.height=boundingBox.height+"px";if(legendBoundingBox){this._centerLabelElementContainer[0].style.width=legendBoundingBox.left-boundingBox.left-18+"px"}else{this._centerLabelElementContainer[0].style.width=boundingBox.width+"px"}if(this.getCenterLabelValue()&&this.getCenterLabelUnit()){this._centerLabelValueElement.html(this.getCenterLabelValue());this._centerLabelUnitElement.html(this.getCenterLabelUnit())}else if(this.getCenterLabelValue()){this._centerLabelValueElement.html(this.getCenterLabelValue())}}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI;var superclass=Streak.Class.mixin(UI.ViewController,UI.DataSourceDelegateMixin);UI.ChartViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_data",destroy:false}],setDataSource:function(dataSource){superclass.prototype.setDataSource.call(this,dataSource);this._retrieveData()},_retrieveData:function(){this._data=this._dataSource.getChartData();if(this._view.setData){this._view.setData(this._data)}},handleDataUpdated:function(dataSource){this._retrieveData()},windowResized:function(){this._view.windowResized()}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,UI=Streak.UI;var ChartFactory=Streak.Class.subclass({superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},createChart:function(options){var chart=this["_create"+options.type.camelize()](options);delete options.type;chart.setChartOptions(options);return chart},_createLineChart:function(options){var chart=new UI.GoogleChartView;chart.setGoogleChartClass(google.visualization.LineChart);return chart},_createRingChart:function(options){var chart=new UI.RingChartView;if(!options.pieHole){options.pieHole=.5}return chart},_createBarChart:function(options){var chart=new UI.BarChartView;return chart},_createColumnChart:function(){var chart=new UI.GoogleChartView;chart.setGoogleChartClass(google.visualization.ColumnChart);return chart}});Library.set("UI.ChartFactory",new ChartFactory)})(Streak);if(!window.streakpanel){window.streakpanel=[]}(function(streakpanel){var ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,windowConsole=window.console,navigator=window.navigator,document=window.document,userAgent=navigator.userAgent;var eventQueue=new PersistentQueue("eventQueue"),eventTimer=null;var PRIMARY_INSTANCE_NAME="streakpanel",SET_QUEUE_KEY="__mps",SET_ONCE_QUEUE_KEY="__mpso",ADD_QUEUE_KEY="__mpa",APPEND_QUEUE_KEY="__mpap",SET_ACTION="$set",SET_ONCE_ACTION="$set_once",ADD_ACTION="$add",APPEND_ACTION="$append",PEOPLE_DISTINCT_ID_KEY="$people_distinct_id",ALIAS_ID_KEY="__alias",RESERVED_PROPERTIES=[SET_QUEUE_KEY,SET_ONCE_QUEUE_KEY,ADD_QUEUE_KEY,APPEND_QUEUE_KEY,PEOPLE_DISTINCT_ID_KEY,ALIAS_ID_KEY];var SNIPPET_VERSION=streakpanel&&streakpanel["__SV"]||1.2,THROTTLE_MILLISECONDS=streakpanel&&streakpanel["__THROTTLE"]||120*1e3,USE_XHR=true,ENQUEUE_REQUESTS=!USE_XHR&&userAgent.indexOf("MSIE")==-1;var _={},DEBUG=false,DEFAULT_CONFIG={api_host:Streak.server,cross_subdomain_cookie:true,cookie_name:"",loaded:function(){},store_google:true,save_referrer:true,test:false,verbose:false,img:false,track_pageview:false,debug:false,track_links_timeout:300,cookie_expiration:365*10,upgrade:false,disable_cookie:false,secure_cookie:false,ip:true},DOM_LOADED=false;(function(){var nativeForEach=ArrayProto.forEach,nativeIndexOf=ArrayProto.indexOf,nativeIsArray=Array.isArray,breaker={};var each=_.each=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker)return}}else{for(var key in obj){if(hasOwnProperty.call(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return}}}};_.extend=function(obj){each(slice.call(arguments,1),function(source){for(var prop in source){if(source[prop]!==void 0)obj[prop]=source[prop]}});return obj};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isFunction=function(f){try{return/^\s*\bfunction\b/.test(f)}catch(x){return false}};_.isArguments=function(obj){return!!(obj&&hasOwnProperty.call(obj,"callee"))};_.toArray=function(iterable){if(!iterable)return[];if(iterable.toArray)return iterable.toArray();if(_.isArray(iterable))return slice.call(iterable);if(_.isArguments(iterable))return slice.call(iterable);return _.values(iterable)};_.values=function(obj){var results=[];if(obj==null)return results;each(obj,function(value){results[results.length]=value});return results};_.identity=function(value){return value};_.include=function(obj,target){var found=false;if(obj==null)return found;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;each(obj,function(value){if(found||(found=value===target)){return breaker}});return found};_.includes=function(str,needle){return str.indexOf(needle)!==-1}})();_.inherit=function(subclass,superclass){subclass.prototype=new superclass;subclass.prototype.constructor=subclass;subclass.superclass=superclass.prototype;return subclass};_.isObject=function(obj){return obj===Object(obj)&&!_.isArray(obj)};_.isEmptyObject=function(obj){if(_.isObject(obj)){for(var key in obj){if(hasOwnProperty.call(obj,key)){return false}}return true}return false};_.isUndefined=function(obj){return obj===void 0};_.isString=function(obj){return toString.call(obj)=="[object String]"};_.isDate=function(obj){return toString.call(obj)=="[object Date]"};_.isNumber=function(obj){return toString.call(obj)=="[object Number]"};_.encodeDates=function(obj){_.each(obj,function(v,k){if(_.isDate(v)){obj[k]=_.formatDate(v)}else if(_.isObject(v)){obj[k]=_.encodeDates(v)}});return obj};_.formatDate=function(d){function pad(n){return n<10?"0"+n:n}return d.getUTCFullYear()+"-"+pad(d.getUTCMonth()+1)+"-"+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+":"+pad(d.getUTCMinutes())+":"+pad(d.getUTCSeconds())};_.strip_empty_properties=function(p){var ret={};_.each(p,function(v,k){if(_.isString(v)&&v.length>0){ret[k]=v}});return ret};_.bind=function(func,context){var args=slice.call(arguments,2);return function(){return func.apply(context,args.concat(slice.call(arguments)))}};_.truncate=function(obj,length){var ret;if(typeof obj==="string"){ret=obj.slice(0,length)}else if(_.isArray(obj)){ret=[];_.each(obj,function(val){ret.push(_.truncate(val,length))})}else if(_.isObject(obj)){ret={};_.each(obj,function(val,key){ret[key]=_.truncate(val,length)})}else{ret=obj}return ret};_.JSONEncode=function(){return function(mixed_val){var indent;var value=mixed_val;var i;var quote=function(string){var escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;var meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'};var str=function(key,holder){var gap="";var indent="    ";var i=0;var k="";var v="";var length=0;var mind=gap;var partial=[];var value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}for(k in value){if(hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}v=partial.length===0?"{}":gap?"{"+partial.join(",")+""+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}};return str("",{"":value})}}();_.JSONDecode=function(){var at,ch,escapee={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"},text,error=function(m){throw{name:"SyntaxError",message:m,at:at,text:text}},next=function(c){if(c&&c!==ch){error("Expected '"+c+"' instead of '"+ch+"'")}ch=text.charAt(at);at+=1;return ch},number=function(){var number,string="";if(ch==="-"){string="-";next("-")}while(ch>="0"&&ch<="9"){string+=ch;next()}if(ch==="."){string+=".";while(next()&&ch>="0"&&ch<="9"){string+=ch}}if(ch==="e"||ch==="E"){string+=ch;next();if(ch==="-"||ch==="+"){string+=ch;next()}while(ch>="0"&&ch<="9"){string+=ch;next()}}number=+string;if(!isFinite(number)){error("Bad number")}else{return number}},string=function(){var hex,i,string="",uffff;if(ch==='"'){while(next()){if(ch==='"'){next();return string}if(ch==="\\"){next();if(ch==="u"){uffff=0;for(i=0;i<4;i+=1){hex=parseInt(next(),16);if(!isFinite(hex)){break}uffff=uffff*16+hex}string+=String.fromCharCode(uffff)}else if(typeof escapee[ch]==="string"){string+=escapee[ch]}else{break}}else{string+=ch}}}error("Bad string")},white=function(){while(ch&&ch<=" "){next()}},word=function(){switch(ch){case"t":next("t");next("r");next("u");next("e");return true;case"f":next("f");next("a");next("l");next("s");next("e");return false;case"n":next("n");next("u");next("l");next("l");return null}error("Unexpected '"+ch+"'")},value,array=function(){var array=[];if(ch==="["){next("[");white();if(ch==="]"){next("]");return array}while(ch){array.push(value());white();if(ch==="]"){next("]");return array}next(",");white()}}error("Bad array")},object=function(){var key,object={};if(ch==="{"){next("{");white();if(ch==="}"){next("}");return object}while(ch){key=string();white();next(":");if(Object.hasOwnProperty.call(object,key)){error('Duplicate key "'+key+'"')}object[key]=value();white();if(ch==="}"){next("}");return object}next(",");white()}}error("Bad object")};value=function(){white();switch(ch){case"{":return object();case"[":return array();case'"':return string();case"-":return number();default:return ch>="0"&&ch<="9"?number():word()}};return function(source){var result;text=source;at=0;ch=" ";result=value();white();if(ch){error("Syntax error")}return result}}();_.base64Encode=function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc="",tmp_arr=[];if(!data){return data}data=_.utf8Encode(data);do{o1=data.charCodeAt(i++);o2=data.charCodeAt(i++);o3=data.charCodeAt(i++);bits=o1<<16|o2<<8|o3;h1=bits>>18&63;h2=bits>>12&63;h3=bits>>6&63;h4=bits&63;tmp_arr[ac++]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4)}while(i<data.length);enc=tmp_arr.join("");switch(data.length%3){case 1:enc=enc.slice(0,-2)+"==";break;case 2:enc=enc.slice(0,-1)+"=";break}return enc};_.utf8Encode=function(string){string=(string+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");var utftext="",start,end;var stringl=0,n;start=end=0;stringl=string.length;for(n=0;n<stringl;n++){var c1=string.charCodeAt(n);var enc=null;if(c1<128){end++}else if(c1>127&&c1<2048){enc=String.fromCharCode(c1>>6|192,c1&63|128)}else{enc=String.fromCharCode(c1>>12|224,c1>>6&63|128,c1&63|128)}if(enc!==null){if(end>start){utftext+=string.substring(start,end)}utftext+=enc;start=end=n+1}}if(end>start){utftext+=string.substring(start,string.length)}return utftext};_.UUID=function(){var T=function(){var d=1*new Date,i=0;while(d==1*new Date){i++}return d.toString(16)+i.toString(16)};var R=function(){return Math.random().toString(16).replace(".","")};var UA=function(n){var ua=userAgent,i,ch,buffer=[],ret=0;function xor(result,byte_array){var j,tmp=0;for(j=0;j<byte_array.length;j++){tmp|=buffer[j]<<j*8}return result^tmp}for(i=0;i<ua.length;i++){ch=ua.charCodeAt(i);buffer.unshift(ch&255);if(buffer.length>=4){ret=xor(ret,buffer);buffer=[]}}if(buffer.length>0){ret=xor(ret,buffer)}return ret.toString(16)};return function(){var se=(screen.height*screen.width).toString(16);return T()+"-"+R()+"-"+UA()+"-"+se+"-"+T()}}();_.isBlockedUA=function(){var a=userAgent;if(/(google web preview|baiduspider|yandexbot)/i.test(a)){return true}return false};_.HTTPBuildQuery=function(formdata,arg_separator){var key,use_val,use_key,tmp_arr=[];if(typeof arg_separator==="undefined"){arg_separator="&"}_.each(formdata,function(val,key){use_val=encodeURIComponent(val.toString());use_key=encodeURIComponent(key);tmp_arr[tmp_arr.length]=use_key+"="+use_val});return tmp_arr.join(arg_separator)};_.getQueryParam=function(url,param){param=param.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+param+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(url);if(results===null||results&&typeof results[1]!=="string"&&results[1].length){return""}else{return decodeURIComponent(results[1]).replace(/\+/g," ")}};_.cookie={get:function(name){var nameEQ=name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return decodeURIComponent(c.substring(nameEQ.length,c.length))}return null},parse:function(name){var cookie;try{cookie=_.JSONDecode(_.cookie.get(name))||{}}catch(err){}return cookie},set:function(name,value,days,cross_subdomain,is_secure){var cdomain="",expires="",secure="";if(cross_subdomain){var matches=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i),domain=matches?matches[0]:"";cdomain=domain?"; domain=."+domain:""}if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);expires="; expires="+date.toGMTString()}if(is_secure){secure="; secure"}document.cookie=name+"="+encodeURIComponent(value)+expires+"; path=/"+cdomain+secure},remove:function(name,cross_subdomain){_.cookie.set(name,"",-1,cross_subdomain)}};_.register_event=function(){var register_event=function(element,type,handler,oldSchool){if(!element){console.error("No valid element provided to register_event");return}if(element.addEventListener&&!oldSchool){element.addEventListener(type,handler,false)}else{var ontype="on"+type;var old_handler=element[ontype];element[ontype]=makeHandler(element,handler,old_handler)}};function makeHandler(element,new_handler,old_handlers){var handler=function(event){event=event||fixEvent(window.event);if(!event){return undefined}var ret=true;var old_result,new_result;if(_.isFunction(old_handlers)){old_result=old_handlers(event)}new_result=new_handler.call(element,event);if(false===old_result||false===new_result){ret=false}return ret};return handler}function fixEvent(event){if(event){event.preventDefault=fixEvent.preventDefault;event.stopPropagation=fixEvent.stopPropagation}return event}fixEvent.preventDefault=function(){this.returnValue=false};fixEvent.stopPropagation=function(){this.cancelBubble=true};return register_event}();_.dom_query=function(){function getAllChildren(e){return e.all?e.all:e.getElementsByTagName("*")}var bad_whitespace=/[\t\r\n]/g;function hasClass(elem,selector){var className=" "+selector+" ";return(" "+elem.className+" ").replace(bad_whitespace," ").indexOf(className)>=0}function getElementsBySelector(selector){if(!document.getElementsByTagName){return new Array}var tokens=selector.split(" ");var token;var currentContext=new Array(document);for(var i=0;i<tokens.length;i++){token=tokens[i].replace(/^\s+/,"").replace(/\s+$/,"");if(token.indexOf("#")>-1){var bits=token.split("#");var tagName=bits[0];var id=bits[1];var element=document.getElementById(id);if(!element||tagName&&element.nodeName.toLowerCase()!=tagName){return new Array}currentContext=new Array(element);continue}if(token.indexOf(".")>-1){var bits=token.split(".");var tagName=bits[0];var className=bits[1];if(!tagName){tagName="*"}var found=new Array;var foundCount=0;for(var h=0;h<currentContext.length;h++){var elements;if(tagName=="*"){elements=getAllChildren(currentContext[h])}else{elements=currentContext[h].getElementsByTagName(tagName)}for(var j=0;j<elements.length;j++){found[foundCount++]=elements[j]}}currentContext=new Array;var currentContextIndex=0;for(var k=0;k<found.length;k++){if(found[k].className&&_.isString(found[k].className)&&hasClass(found[k],className)){currentContext[currentContextIndex++]=found[k]}}continue}if(token.match(/^(\w*)\[(\w+)([=~\|\^\$\*]?)=?"?([^\]"]*)"?\]$/)){var tagName=RegExp.$1;var attrName=RegExp.$2;var attrOperator=RegExp.$3;var attrValue=RegExp.$4;if(!tagName){tagName="*"}var found=new Array;var foundCount=0;for(var h=0;h<currentContext.length;h++){var elements;if(tagName=="*"){elements=getAllChildren(currentContext[h])}else{elements=currentContext[h].getElementsByTagName(tagName)}for(var j=0;j<elements.length;j++){found[foundCount++]=elements[j]}}currentContext=new Array;var currentContextIndex=0;var checkFunction;switch(attrOperator){case"=":checkFunction=function(e){return e.getAttribute(attrName)==attrValue};break;case"~":checkFunction=function(e){return e.getAttribute(attrName).match(new RegExp("\\b"+attrValue+"\\b"))};break;case"|":checkFunction=function(e){return e.getAttribute(attrName).match(new RegExp("^"+attrValue+"-?"))};break;case"^":checkFunction=function(e){return e.getAttribute(attrName).indexOf(attrValue)==0};break;case"$":checkFunction=function(e){return e.getAttribute(attrName).lastIndexOf(attrValue)==e.getAttribute(attrName).length-attrValue.length};break;case"*":checkFunction=function(e){return e.getAttribute(attrName).indexOf(attrValue)>-1};break;default:checkFunction=function(e){return e.getAttribute(attrName)}}currentContext=new Array;currentContextIndex=0;for(var k=0;k<found.length;k++){if(checkFunction(found[k])){currentContext[currentContextIndex++]=found[k]}}continue}tagName=token;var found=new Array;var foundCount=0;for(var h=0;h<currentContext.length;h++){var elements=currentContext[h].getElementsByTagName(tagName);for(var j=0;j<elements.length;j++){found[foundCount++]=elements[j]}}currentContext=found}return currentContext}return getElementsBySelector}();_.info={campaignParams:function(){var campaign_keywords="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),kw="",params={};_.each(campaign_keywords,function(kwkey){kw=_.getQueryParam(document.URL,kwkey);if(kw.length){params[kwkey]=kw}});return params},searchEngine:function(referrer){if(referrer.search("https?://(.*)google.([^/?]*)")===0){return"google"}else if(referrer.search("https?://(.*)bing.com")===0){return"bing"}else if(referrer.search("https?://(.*)yahoo.com")===0){return"yahoo"}else if(referrer.search("https?://(.*)duckduckgo.com")===0){return"duckduckgo"}else{return null}},searchInfo:function(referrer){var search=_.info.searchEngine(referrer),param=search!="yahoo"?"q":"p",ret={};if(search!==null){ret["searchEngine"]=search;var keyword=_.getQueryParam(referrer,param);if(keyword.length){ret["searchEngineKeyword"]=keyword}}return ret},browser:function(){var ua=userAgent,vend=navigator.vendor||"";if(window.opera){if(_.includes(ua,"Mini")){return"Opera Mini"}return"Opera"}else if(/(BlackBerry|PlayBook|BB10)/i.test(ua)){return"BlackBerry"}else if(_.includes(ua,"Chrome")){return"Chrome"}else if(_.includes(vend,"Apple")){if(_.includes(ua,"Mobile")){return"Mobile Safari"}return"Safari"}else if(_.includes(ua,"Android")){return"Android Mobile"}else if(_.includes(ua,"Konqueror")){return"Konqueror"}else if(_.includes(ua,"Firefox")){return"Firefox"}else if(_.includes(ua,"MSIE")){return"Internet Explorer"}else if(_.includes(ua,"Gecko")){return"Mozilla"}else{return""}},os:function(){var a=userAgent;if(/Windows/i.test(a)){if(/Phone/.test(a)){return"Windows Mobile"}return"Windows"}else if(/(iPhone|iPad|iPod)/.test(a)){return"iOS"}else if(/Android/.test(a)){return"Android"}else if(/(BlackBerry|PlayBook|BB10)/i.test(a)){return"BlackBerry"}else if(/Mac/i.test(a)){return"Mac OS X"}else if(/Linux/.test(a)){return"Linux"}else{return""}},device:function(){var a=userAgent;if(/iPhone/.test(a)){return"iPhone"}else if(/iPad/.test(a)){return"iPad"}else if(/iPod/.test(a)){return"iPod Touch"}else if(/(BlackBerry|PlayBook|BB10)/i.test(a)){return"BlackBerry"}else if(/Windows Phone/i.test(a)){return"Windows Phone"}else if(/Android/.test(a)){return"Android"}else{return""}},referringDomain:function(referrer){var split=referrer.split("/");if(split.length>=3){return split[2]}return""},properties:function(){return _.strip_empty_properties({os:_.info.os(),browser:_.info.browser(),referrer:document.referrer,referringDomain:_.info.referringDomain(document.referrer),device:_.info.device()})},people_properties:function(){return _.strip_empty_properties({$os:_.info.os(),$browser:_.info.browser()})},pageviewInfo:function(page){return _.strip_empty_properties({mp_page:page,mp_referrer:document.referrer,mp_browser:_.info.browser(),mp_platform:_.info.os()})}};var console={log:function(){if(DEBUG&&!_.isUndefined(windowConsole)&&windowConsole){try{windowConsole.log.apply(windowConsole,arguments)}catch(err){_.each(arguments,function(arg){windowConsole.log(arg)})}}},error:function(){if(DEBUG&&!_.isUndefined(windowConsole)&&windowConsole){var args=["Streakpanel error:"].concat(_.toArray(arguments));try{windowConsole.error.apply(windowConsole,args)}catch(err){_.each(args,function(arg){windowConsole.error(arg)})}}},critical:function(){if(!_.isUndefined(windowConsole)&&windowConsole){var args=["Streakpanel error:"].concat(_.toArray(arguments));try{windowConsole.error.apply(windowConsole,args)}catch(err){_.each(args,function(arg){windowConsole.error(arg)})}}}};var DomTracker=function(){};DomTracker.prototype.create_properties=function(){};DomTracker.prototype.event_handler=function(){};DomTracker.prototype.after_track_handler=function(){};DomTracker.prototype.init=function(streakpanel_instance){this.mp=streakpanel_instance;return this};DomTracker.prototype.track=function(query,event_name,properties,user_callback){var that=this,elements=_.dom_query(query);if(elements.length==0){console.error("The DOM query ("+query+") returned 0 elements");return}_.each(elements,function(element){_.register_event(element,this.override_event,function(e){var options={},props=that.create_properties(properties,this),timeout=that.mp.get_config("track_links_timeout");that.event_handler(e,this,options);window.setTimeout(that.track_callback(user_callback,props,options,true),timeout);that.mp.track(event_name,props,that.track_callback(user_callback,props,options))})},this);return true};DomTracker.prototype.track_callback=function(user_callback,props,options,timeout_occured){timeout_occured=timeout_occured||false;var that=this;return function(){if(options.callback_fired){return}options.callback_fired=true;if(user_callback&&user_callback(timeout_occured,props)===false){return}that.after_track_handler(props,options,timeout_occured)}};DomTracker.prototype.create_properties=function(properties,element){var props;if(typeof properties==="function"){props=properties(element)}else{props=_.extend({},properties)}return props};var LinkTracker=function(){this.override_event="click"};_.inherit(LinkTracker,DomTracker);LinkTracker.prototype.create_properties=function(properties,element){var props=LinkTracker.superclass.create_properties.apply(this,arguments);if(element.href){props["url"]=element.href}return props};LinkTracker.prototype.event_handler=function(evt,element,options){options.new_tab=evt.which===2||evt.metaKey||element.target==="_blank";options.href=element.href;if(!options.new_tab){evt.preventDefault()}};LinkTracker.prototype.after_track_handler=function(props,options,timeout_occured){if(options.new_tab){return}setTimeout(function(){window.location=options.href},0)};var FormTracker=function(){this.override_event="submit"};_.inherit(FormTracker,DomTracker);FormTracker.prototype.event_handler=function(evt,element,options){options.element=element;evt.preventDefault()};FormTracker.prototype.after_track_handler=function(props,options,timeout_occured){setTimeout(function(){options.element.submit()},0)};var StreakpanelCookie=function(config){this["props"]={};this.campaign_params_saved=false;if(config["cookie_name"]){this.name="mp_"+config["cookie_name"]}else{this.name="mp_"+config["token"]+"_streakpanel"}this.load();this.update_config(config);this.upgrade(config);this.save()};StreakpanelCookie.prototype.properties=function(){var p={};_.each(this["props"],function(v,k){if(!_.include(RESERVED_PROPERTIES,k)){p[k]=v}});return p};StreakpanelCookie.prototype.load=function(){if(this.disabled){return}var cookie=_.cookie.parse(this.name);if(cookie){this["props"]=_.extend({},cookie)}};StreakpanelCookie.prototype.upgrade=function(config){var should_upgrade=config["upgrade"],old_cookie_name,old_cookie;if(should_upgrade){old_cookie_name="mp_super_properties";if(typeof should_upgrade==="string"){old_cookie_name=should_upgrade}old_cookie=_.cookie.parse(old_cookie_name);_.cookie.remove(old_cookie_name);_.cookie.remove(old_cookie_name,true);if(old_cookie){this["props"]=_.extend(this["props"],old_cookie["all"],old_cookie["events"])}}if(!config["cookie_name"]&&config["name"]!=="streakpanel"){old_cookie_name="mp_"+config["token"]+"_"+config["name"];old_cookie=_.cookie.parse(old_cookie_name);if(old_cookie){_.cookie.remove(old_cookie_name);_.cookie.remove(old_cookie_name,true);this.register_once(old_cookie)}}};StreakpanelCookie.prototype.save=function(){if(this.disabled){return}_.cookie.set(this.name,_.JSONEncode(this["props"]),this.expire_days,this.cross_subdomain,this.secure)};StreakpanelCookie.prototype.remove=function(){_.cookie.remove(this.name,false);_.cookie.remove(this.name,true)};StreakpanelCookie.prototype.clear=function(){this.remove();this["props"]={}};StreakpanelCookie.prototype.register_once=function(props,default_value,days){if(_.isObject(props)){if(typeof default_value==="undefined"){default_value="None"}this.expire_days=typeof days==="undefined"?this.default_expiry:days;_.each(props,function(val,prop){if(!this["props"][prop]||this["props"][prop]===default_value){this["props"][prop]=val}},this);this.save();return true}return false};StreakpanelCookie.prototype.register=function(props,days){if(_.isObject(props)){this.expire_days=typeof days==="undefined"?this.default_expiry:days;_.extend(this["props"],props);this.save();return true}return false};StreakpanelCookie.prototype.unregister=function(prop){if(prop in this["props"]){delete this["props"][prop];this.save()}};StreakpanelCookie.prototype.update_campaign_params=function(){if(!this.campaign_params_saved){this.register_once(_.info.campaignParams());this.campaign_params_saved=true}};StreakpanelCookie.prototype.update_search_keyword=function(referrer){this.register(_.info.searchInfo(referrer))};StreakpanelCookie.prototype.update_referrer_info=function(referrer){this.register_once({referrer:referrer||"$direct",referringDomain:_.info.referringDomain(referrer)||"$direct"},"")};StreakpanelCookie.prototype.get_referrer_info=function(){return _.strip_empty_properties({referrer:this["props"]["initial_referrer"],referringDomain:this["props"]["referringDomain"]})};StreakpanelCookie.prototype.safe_merge=function(props){_.each(this["props"],function(val,prop){if(!(prop in props)){props[prop]=val}});return props};StreakpanelCookie.prototype.update_config=function(config){this.default_expiry=this.expire_days=config["cookie_expiration"];this.set_disabled(config["disable_cookie"]);this.set_cross_subdomain(config["cross_subdomain_cookie"]);this.set_secure(config["secure_cookie"])};StreakpanelCookie.prototype.set_disabled=function(disabled){this.disabled=disabled;if(this.disabled){this.remove()}};StreakpanelCookie.prototype.set_cross_subdomain=function(cross_subdomain){if(cross_subdomain!==this.cross_subdomain){this.cross_subdomain=cross_subdomain;this.remove();this.save()}};StreakpanelCookie.prototype.get_cross_subdomain=function(){return this.cross_subdomain};StreakpanelCookie.prototype.set_secure=function(secure){if(secure!==this.secure){this.secure=secure?true:false;this.remove();this.save()}};StreakpanelCookie.prototype._add_to_people_queue=function(queue,data){var q_key=this._get_queue_key(queue),q_data=data[queue],set_q=this._get_or_create_queue(SET_ACTION),set_once_q=this._get_or_create_queue(SET_ONCE_ACTION),add_q=this._get_or_create_queue(ADD_ACTION),append_q=this._get_or_create_queue(APPEND_ACTION,[]);
if(q_key===SET_QUEUE_KEY){_.extend(set_q,q_data);this._pop_from_people_queue(ADD_ACTION,q_data)}else if(q_key===SET_ONCE_QUEUE_KEY){_.each(q_data,function(v,k){if(!(k in set_once_q)){set_once_q[k]=v}})}else if(q_key===ADD_QUEUE_KEY){_.each(q_data,function(v,k){if(k in set_q){set_q[k]+=v}else{if(!(k in add_q)){add_q[k]=0}add_q[k]+=v}},this)}else if(q_key===APPEND_QUEUE_KEY){append_q.push(q_data)}console.log("MIXPANEL PEOPLE REQUEST (QUEUED, PENDING IDENTIFY):");console.log(data);this.save()};StreakpanelCookie.prototype._pop_from_people_queue=function(queue,data){var q=this._get_queue(queue);if(!_.isUndefined(q)){_.each(data,function(v,k){delete q[k]},this);this.save()}};StreakpanelCookie.prototype._get_queue_key=function(queue){if(queue===SET_ACTION){return SET_QUEUE_KEY}else if(queue===SET_ONCE_ACTION){return SET_ONCE_QUEUE_KEY}else if(queue===ADD_ACTION){return ADD_QUEUE_KEY}else if(queue===APPEND_ACTION){return APPEND_QUEUE_KEY}else{console.error("Invalid queue:",queue)}};StreakpanelCookie.prototype._get_queue=function(queue){return this["props"][this._get_queue_key(queue)]};StreakpanelCookie.prototype._get_or_create_queue=function(queue,default_val){var key=this._get_queue_key(queue),default_val=_.isUndefined(default_val)?{}:default_val;return this["props"][key]||(this["props"][key]=default_val)};var create_mplib=function(token,config,name){var instance,target=name===PRIMARY_INSTANCE_NAME?streakpanel:streakpanel[name];if(target&&!_.isArray(target)){console.error("You have already initialized "+name);return}instance=new StreakpanelLib;instance._init(token,config,name);instance["people"]=new StreakpanelPeople;instance["people"]._init(instance);DEBUG=DEBUG||instance.get_config("debug");if(!_.isUndefined(target)){instance._execute_array.call(instance["people"],target["people"]);instance._execute_array(target)}return instance};function PersistentQueue(id){if(typeof id!="string"){throw new Error("PersistentQueue requires a string id")}this._fallbackQueue=[];this._sid="streak__persistentqueue_"+id}PersistentQueue.prototype._getSavedQueue=function(){var queue=JSON.parse(localStorage.getItem(this._sid));if(queue==null){queue=[]}return queue};PersistentQueue.prototype._putSavedQueue=function(queue){localStorage.setItem(this._sid,JSON.stringify(queue))};PersistentQueue.prototype._clearSavedQueue=function(){localStorage.removeItem(this._sid)};PersistentQueue.prototype.add=function(val){var success=false;if(window.localStorage){try{var queue=this._getSavedQueue();queue.push(val);this._putSavedQueue(queue);success=true}catch(e){}}if(!success){this._fallbackQueue.push(val)}};PersistentQueue.prototype.remove=function(){var ret=undefined;if(window.localStorage){try{var queue=this._getSavedQueue();var tmpRet=queue.shift();this._putSavedQueue(queue);ret=tmpRet}catch(e){}}if(ret===undefined){ret=this._fallbackQueue.shift()}return ret};PersistentQueue.prototype.removeAll=function(){var ret=undefined;if(window.localStorage){try{var queue=this._getSavedQueue();this._clearSavedQueue();ret=queue}catch(e){}}if(ret===undefined){ret=[]}ret=ret.concat(this._fallbackQueue);this._fallbackQueue=[];return ret};PersistentQueue.prototype.peekAll=function(){var ret=undefined;if(window.localStorage){try{var ret=this._getSavedQueue()}catch(e){}}if(ret===undefined){ret=[]}ret=ret.concat(this._fallbackQueue);return ret};PersistentQueue.prototype.clear=function(){if(window.localStorage){try{this._clearSavedQueue()}catch(e){}}this._fallbackQueue.length=0};var StreakpanelLib=function(){};StreakpanelLib.prototype.init=function(token,config,name){if(typeof name==="undefined"){console.error("You must name your new library: init(token, config, name)");return}if(name===PRIMARY_INSTANCE_NAME){console.error("You must initialize the main streakpanel object right after you include the Streakpanel js snippet");return}var instance=create_mplib(token,config,name);streakpanel[name]=instance;instance._loaded();return instance};StreakpanelLib.prototype._init=function(token,config,name){this["__loaded"]=true;this["config"]={};this.set_config(_.extend({},DEFAULT_CONFIG,config,{name:name,token:token,callback_fn:(name===PRIMARY_INSTANCE_NAME?name:PRIMARY_INSTANCE_NAME+"."+name)+"._jsc"}));this["_jsc"]=function(){};this.__dom_loaded_queue=[];this.__request_queue=[];this.__disabled_events=[];this._flags={disable_all_events:false,identify_called:false};this["cookie"]=new StreakpanelCookie(this["config"])};StreakpanelLib.prototype._loaded=function(){this.get_config("loaded")(this);if(this.get_config("track_pageview")){this.track_pageview()}};StreakpanelLib.prototype._dom_loaded=function(){_.each(this.__dom_loaded_queue,function(item){this._track_dom.apply(this,item)},this);_.each(this.__request_queue,function(item){this._send_request.apply(this,item)},this);delete this.__dom_loaded_queue;delete this.__request_queue};StreakpanelLib.prototype._track_dom=function(DomClass,args){if(this.get_config("img")){console.error("You can't use DOM tracking functions with img = true.");return false}if(!DOM_LOADED){this.__dom_loaded_queue.push([DomClass,args]);return false}var dt=(new DomClass).init(this);return dt.track.apply(dt,args)};StreakpanelLib.prototype._prepare_callback=function(callback,data){if(_.isUndefined(callback)){return null}if(USE_XHR){var callback_function=function(response){callback(response,data)};return callback_function}else{var jsc=this["_jsc"],randomized_cb=""+Math.floor(Math.random()*1e8),callback_string=this.get_config("callback_fn")+'["'+randomized_cb+'"]';jsc[randomized_cb]=function(response){delete jsc[randomized_cb];callback(response,data)};return callback_string}};StreakpanelLib.prototype._send_request=function(url,data,callback){if(ENQUEUE_REQUESTS){this.__request_queue.push(arguments);return}var verbose_mode=this.get_config("verbose");if(this.get_config("test")){data["test"]=1}if(verbose_mode){data["verbose"]=1}if(this.get_config("img")){data["img"]=1}if(callback&&!USE_XHR){data["callback"]=callback}var queryString=_.HTTPBuildQuery(data);if("img"in data){var img=document.createElement("img");img.src=url;document.body.appendChild(img)}else if(USE_XHR){var req=new XMLHttpRequest;req.open("POST",url,true);req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");req.withCredentials=true;req.onreadystatechange=function(e){if(req.readyState===4){if(req.status===200){if(callback){if(verbose_mode){callback(_.JSONDecode(req.responseText))}else{callback(Number(req.responseText))}}}else{var error="Bad HTTP status: "+req.status+" "+req.statusText;console.error(error);if(callback){if(verbose_mode){callback({status:0,error:error})}else{callback(0)}}}}};req.send(queryString)}else{var script=document.createElement("script");script.type="text/javascript";script.async=true;script.defer=true;script.src=url;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(script,s)}};StreakpanelLib.prototype._execute_array=function(array){var fn_name,alias_calls=[],other_calls=[],tracking_calls=[];_.each(array,function(item){if(item){fn_name=item[0];if(typeof item==="function"){item.call(this)}else if(_.isArray(item)&&fn_name==="alias"){alias_calls.push(item)}else if(_.isArray(item)&&fn_name.indexOf("track")!=-1&&typeof this[fn_name]==="function"){tracking_calls.push(item)}else{other_calls.push(item)}}},this);var execute=function(calls,context){_.each(calls,function(item){this[item[0]].apply(this,item.slice(1))},context)};execute(alias_calls,this);execute(other_calls,this);execute(tracking_calls,this)};StreakpanelLib.prototype.push=function(item){this._execute_array([item])};StreakpanelLib.prototype.disable=function(events){if(typeof events==="undefined"){this._flags.disable_all_events=true}else{this.__disabled_events=this.__disabled_events.concat(events)}};StreakpanelLib.prototype.track=function(event_name,properties,callback){if(typeof event_name==="undefined"){console.error("No event name provided to streakpanel.track");return}if(_.isBlockedUA()||this._flags.disable_all_events||_.include(this.__disabled_events,event_name)){if(typeof callback!=="undefined"){callback(0)}return}properties=properties||{};this["cookie"].update_search_keyword(document.referrer);if(this.get_config("store_google")){this["cookie"].update_campaign_params()}if(this.get_config("save_referrer")){this["cookie"].update_referrer_info(document.referrer)}properties=_.extend({},{timestamp:(new Date).getTime()*1e3,screenWidth:screen.width,screenHeight:screen.height,windowWidth:window.innerWidth,windowHeight:window.innerHeight},_.info.properties(),this["cookie"].properties(),properties);var data={event:event_name,properties:properties};eventQueue.add(data);this.send_batched_requests_throttled();return data};StreakpanelLib.prototype.send_batched_requests=function(){var events=eventQueue.removeAll();if(events.length==0){return}var request={data:events,clientRequestTimestamp:(new Date).getTime()*1e3};var json_data=_.JSONEncode(request);this._send_request(this.get_config("api_host")+"/eventtracking/track",{json:json_data},null)};StreakpanelLib.prototype.send_batched_requests_throttled=function(){if(eventTimer){clearTimeout(eventTimer)}eventTimer=setTimeout(_.bind(this.send_batched_requests,this),THROTTLE_MILLISECONDS)};StreakpanelLib.prototype.track_pageview=function(page){if(typeof page==="undefined"){page=document.location.href}this.track("mp_page_view",_.info.pageviewInfo(page))};StreakpanelLib.prototype.track_links=function(){return this._track_dom.call(this,LinkTracker,arguments)};StreakpanelLib.prototype.track_forms=function(){return this._track_dom.call(this,FormTracker,arguments)};StreakpanelLib.prototype.register=function(props,days){this["cookie"].register(props,days)};StreakpanelLib.prototype.register_once=function(props,default_value,days){this["cookie"].register_once(props,default_value,days)};StreakpanelLib.prototype.unregister=function(property){this["cookie"].unregister(property)};StreakpanelLib.prototype._register_single=function(prop,value){var props={};props[prop]=value;this.register(props)};StreakpanelLib.prototype.identify=function(unique_id,_set_callback,_add_callback,_append_callback,_set_once_callback){if(unique_id!=this.get_distinct_id()&&unique_id!=this.get_property(ALIAS_ID_KEY)){this.unregister(ALIAS_ID_KEY);this._register_single("distinct_id",unique_id)}this._flags.identify_called=true;this["people"]._flush(_set_callback,_add_callback,_append_callback,_set_once_callback)};StreakpanelLib.prototype.get_distinct_id=function(){return this.get_property("distinct_id")};StreakpanelLib.prototype.alias=function(alias,original){if(alias===this.get_property(PEOPLE_DISTINCT_ID_KEY)){console.critical("Attempting to create alias for existing People user - aborting.");return-2}var _this=this;if(_.isUndefined(original)){original=this.get_distinct_id()}if(alias!==original){this._register_single(ALIAS_ID_KEY,alias);return this.track("$create_alias",{alias:alias,distinct_id:original},function(response){_this.identify(alias)})}else{console.error("alias matches current distinct_id - skipping api call.");this.identify(alias);return-1}};StreakpanelLib.prototype.name_tag=function(name_tag){this._register_single("mp_name_tag",name_tag)};StreakpanelLib.prototype.set_config=function(config){if(_.isObject(config)){_.extend(this["config"],config);if(this["cookie"]){this["cookie"].update_config(this["config"])}DEBUG=DEBUG||this.get_config("debug")}};StreakpanelLib.prototype.get_config=function(prop_name){return this["config"][prop_name]};StreakpanelLib.prototype.get_property=function(property_name){return this["cookie"]["props"][property_name]};StreakpanelLib.prototype.toString=function(){var name=this.get_config("name");if(name!==PRIMARY_INSTANCE_NAME){name=PRIMARY_INSTANCE_NAME+"."+name}return name};var StreakpanelPeople=function(){};StreakpanelPeople.prototype._init=function(streakpanel){this._streakpanel=streakpanel};StreakpanelPeople.prototype.set=function(prop,to,callback){var data={};var $set={};if(_.isObject(prop)){_.each(prop,function(v,k){if(k=="$distinct_id"||k=="$token"){return}else{$set[k]=v}});callback=to}else{$set[prop]=to}if(this._get_config("save_referrer")){this._streakpanel.cookie.update_referrer_info(document.referrer)}$set=_.extend({},_.info.people_properties(),this._streakpanel.cookie.get_referrer_info(),$set);data[SET_ACTION]=$set;return this._send_request(data,callback)};StreakpanelPeople.prototype.set_once=function(prop,to,callback){var data={};var $set_once={};if(_.isObject(prop)){_.each(prop,function(v,k){if(k=="$distinct_id"||k=="$token"){return}else{$set_once[k]=v}});callback=to}else{$set_once[prop]=to}data[SET_ONCE_ACTION]=$set_once;return this._send_request(data,callback)};StreakpanelPeople.prototype.increment=function(prop,by,callback){var data={};var $add={};if(_.isObject(prop)){_.each(prop,function(v,k){if(k=="$distinct_id"||k=="$token"){return}else if(isNaN(parseFloat(v))){console.error("Invalid increment value passed to streakpanel.people.increment - must be a number");return}else{$add[k]=v}});callback=by}else{if(_.isUndefined(by)){by=1}$add[prop]=by}data[ADD_ACTION]=$add;return this._send_request(data,callback)};StreakpanelPeople.prototype.append=function(list_name,value,callback){var data={};var $append={};if(_.isObject(list_name)){_.each(list_name,function(v,k){if(k=="$distinct_id"||k=="$token"){return}else{$append[k]=v}});callback=value}else{$append[list_name]=value}data[APPEND_ACTION]=$append;return this._send_request(data,callback)};StreakpanelPeople.prototype.track_charge=function(amount,properties,callback){if(!_.isNumber(amount)){amount=parseFloat(amount);if(isNaN(amount)){console.error("Invalid value passed to streakpanel.people.track_charge - must be a number");return}}return this.append("$transactions",_.extend({$amount:amount},properties),callback)};StreakpanelPeople.prototype.clear_charges=function(callback){return this.set("$transactions",[],callback)};StreakpanelPeople.prototype.delete_user=function(){if(!this._identify_called()){console.error("streakpanel.people.delete_user() requires you to call identify() first");return}var data={$delete:this._streakpanel.get_distinct_id()};return this._send_request(data)};StreakpanelPeople.prototype.toString=function(){return this._streakpanel.toString()+".people"};StreakpanelPeople.prototype._send_request=function(data,callback){data["$token"]=this._get_config("token");data["$distinct_id"]=this._streakpanel.get_distinct_id();var date_encoded_data=_.encodeDates(data),truncated_data=_.truncate(date_encoded_data,255),json_data=_.JSONEncode(date_encoded_data),encoded_data=_.base64Encode(json_data);if(!this._identify_called()){this._enqueue(data);if(!_.isUndefined(callback)){if(this._get_config("verbose")){callback({status:-1,error:null})}else{callback(-1)}}return truncated_data}console.log("MIXPANEL PEOPLE REQUEST:");console.log(truncated_data);this._streakpanel._send_request(this._get_config("api_host")+"/engage/",{data:encoded_data},this._streakpanel._prepare_callback(callback,truncated_data));return truncated_data};StreakpanelPeople.prototype._get_config=function(conf_var){return this._streakpanel.get_config(conf_var)};StreakpanelPeople.prototype._identify_called=function(){return this._streakpanel._flags.identify_called===true};StreakpanelPeople.prototype._enqueue=function(data){if(SET_ACTION in data){this._streakpanel.cookie._add_to_people_queue(SET_ACTION,data)}else if(SET_ONCE_ACTION in data){this._streakpanel.cookie._add_to_people_queue(SET_ONCE_ACTION,data)}else if(ADD_ACTION in data){this._streakpanel.cookie._add_to_people_queue(ADD_ACTION,data)}else if(APPEND_ACTION in data){this._streakpanel.cookie._add_to_people_queue(APPEND_ACTION,data)}else{console.error("Invalid call to _enqueue():",data)}};StreakpanelPeople.prototype._flush=function(_set_callback,_add_callback,_append_callback,_set_once_callback){var _this=this,$set_queue=_.extend({},this._streakpanel.cookie._get_queue(SET_ACTION)),$set_once_queue=_.extend({},this._streakpanel.cookie._get_queue(SET_ONCE_ACTION)),$add_queue=_.extend({},this._streakpanel.cookie._get_queue(ADD_ACTION)),$append_queue=this._streakpanel.cookie._get_queue(APPEND_ACTION);if(!_.isUndefined($set_queue)&&_.isObject($set_queue)&&!_.isEmptyObject($set_queue)){_this._streakpanel.cookie._pop_from_people_queue(SET_ACTION,$set_queue);this.set($set_queue,function(response,data){if(response==0){_this._streakpanel.cookie._add_to_people_queue(SET_ACTION,$set_queue)}if(!_.isUndefined(_set_callback)){_set_callback(response,data)}})}if(!_.isUndefined($set_once_queue)&&_.isObject($set_once_queue)&&!_.isEmptyObject($set_once_queue)){_this._streakpanel.cookie._pop_from_people_queue(SET_ONCE_ACTION,$set_once_queue);this.set_once($set_once_queue,function(response,data){if(response==0){_this._streakpanel.cookie._add_to_people_queue(SET_ONCE_ACTION,$set_once_queue)}if(!_.isUndefined(_set_once_callback)){_set_once_callback(response,data)}})}if(!_.isUndefined($add_queue)&&_.isObject($add_queue)&&!_.isEmptyObject($add_queue)){_this._streakpanel.cookie._pop_from_people_queue(ADD_ACTION,$add_queue);this.increment($add_queue,function(response,data){if(response==0){_this._streakpanel.cookie._add_to_people_queue(ADD_ACTION,$add_queue)}if(!_.isUndefined(_add_callback)){_add_callback(response,data)}})}if(!_.isUndefined($append_queue)&&_.isArray($append_queue)&&$append_queue.length){for(var i=$append_queue.length-1;i>=0;i--){var $append_item=$append_queue.pop();_this.append($append_item,function(response,data){if(response==0){_this._streakpanel.cookie._add_to_people_queue(APPEND_ACTION,$append_item)}if(!_.isUndefined(_append_callback)){_append_callback(response,data)}})}_this._streakpanel.cookie.save()}};_["toArray"]=_.toArray;_["isObject"]=_.isObject;_["JSONEncode"]=_.JSONEncode;_["JSONDecode"]=_.JSONDecode;_["isEmptyObject"]=_.isEmptyObject;StreakpanelLib.prototype["init"]=StreakpanelLib.prototype.init;StreakpanelLib.prototype["disable"]=StreakpanelLib.prototype.disable;StreakpanelLib.prototype["track"]=StreakpanelLib.prototype.track;StreakpanelLib.prototype["track_links"]=StreakpanelLib.prototype.track_links;StreakpanelLib.prototype["track_forms"]=StreakpanelLib.prototype.track_forms;StreakpanelLib.prototype["track_pageview"]=StreakpanelLib.prototype.track_pageview;StreakpanelLib.prototype["register"]=StreakpanelLib.prototype.register;StreakpanelLib.prototype["register_once"]=StreakpanelLib.prototype.register_once;StreakpanelLib.prototype["unregister"]=StreakpanelLib.prototype.unregister;StreakpanelLib.prototype["identify"]=StreakpanelLib.prototype.identify;StreakpanelLib.prototype["alias"]=StreakpanelLib.prototype.alias;StreakpanelLib.prototype["name_tag"]=StreakpanelLib.prototype.name_tag;StreakpanelLib.prototype["set_config"]=StreakpanelLib.prototype.set_config;StreakpanelLib.prototype["get_config"]=StreakpanelLib.prototype.get_config;StreakpanelLib.prototype["get_property"]=StreakpanelLib.prototype.get_property;StreakpanelLib.prototype["get_distinct_id"]=StreakpanelLib.prototype.get_distinct_id;StreakpanelLib.prototype["toString"]=StreakpanelLib.prototype.toString;StreakpanelCookie.prototype["properties"]=StreakpanelCookie.prototype.properties;StreakpanelCookie.prototype["update_search_keyword"]=StreakpanelCookie.prototype.update_search_keyword;StreakpanelCookie.prototype["update_referrer_info"]=StreakpanelCookie.prototype.update_referrer_info;StreakpanelCookie.prototype["get_cross_subdomain"]=StreakpanelCookie.prototype.get_cross_subdomain;StreakpanelCookie.prototype["clear"]=StreakpanelCookie.prototype.clear;StreakpanelPeople.prototype["set"]=StreakpanelPeople.prototype.set;StreakpanelPeople.prototype["set_once"]=StreakpanelPeople.prototype.set_once;StreakpanelPeople.prototype["increment"]=StreakpanelPeople.prototype.increment;StreakpanelPeople.prototype["append"]=StreakpanelPeople.prototype.append;StreakpanelPeople.prototype["track_charge"]=StreakpanelPeople.prototype.track_charge;StreakpanelPeople.prototype["clear_charges"]=StreakpanelPeople.prototype.clear_charges;StreakpanelPeople.prototype["delete_user"]=StreakpanelPeople.prototype.delete_user;StreakpanelPeople.prototype["toString"]=StreakpanelPeople.prototype.toString;if(_.isUndefined(streakpanel)){console.critical("'streakpanel' object not initialized. Ensure you are using the latest version of the Streakpanel JS Library along with the snippet we provide.");return}if(streakpanel["__loaded"]||streakpanel["config"]&&streakpanel["cookie"]){console.error("Streakpanel library has already been downloaded at least once.");return}if(SNIPPET_VERSION<1.1){console.critical("Version mismatch; please ensure you're using the latest version of the Streakpanel code snippet.");return}var instances={};_.each(streakpanel["_i"],function(item){var name,instance;if(item&&_.isArray(item)){name=item[item.length-1];instance=create_mplib.apply(this,item);instances[name]=instance}});var extend_mp=function(){_.each(instances,function(instance,name){if(name!==PRIMARY_INSTANCE_NAME){streakpanel[name]=instance}});streakpanel["_"]=_};streakpanel["init"]=function(token,config,name){if(name){if(!streakpanel[name]){streakpanel[name]=instances[name]=create_mplib(token,config,name);streakpanel[name]._loaded()}}else{var instance=streakpanel;if(instances[PRIMARY_INSTANCE_NAME]){instance=instances[PRIMARY_INSTANCE_NAME]}else if(token){instance=create_mplib(token,config,PRIMARY_INSTANCE_NAME)}window[PRIMARY_INSTANCE_NAME]=streakpanel=instance;extend_mp()}};streakpanel["init"]();_.each(instances,function(instance){instance._loaded()});function dom_loaded_handler(){if(dom_loaded_handler.done){return}dom_loaded_handler.done=true;DOM_LOADED=true;ENQUEUE_REQUESTS=false;_.each(instances,function(inst){inst._dom_loaded()})}if(document.addEventListener){if(document.readyState=="complete"){dom_loaded_handler()}else{document.addEventListener("DOMContentLoaded",dom_loaded_handler,false)}}_.register_event(window,"load",dom_loaded_handler,true)})(window["streakpanel"]);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxDisplayText=function(){};_.extend(BoxDisplayText.prototype,{getDetailsText:function(box){var pipeline=box.getPipeline();var fields=this._getFieldsInOrder(pipeline);fields=_.uniq(fields,false,function(field){return field.key()});var detailText=[];var notes=box.get("notes").trim();if(notes){detailText.push(notes)}for(var ii=0;ii<fields.length;ii++){var text=box.getFieldDisplayTextValue(fields[ii].key()).trim();if(text.length>0){detailText.push(text)}}return detailText.join(", ")},_getFieldsInOrder:function(pipeline){var columnOrder=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(pipeline);var columnVisibility=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.load(pipeline);if(!columnOrder||!columnOrder.data||!_.isArray(columnOrder.data)){return pipeline.getFields()}var fields=[];for(var ii=0;ii<columnOrder.data.length;ii++){var column=columnOrder.data[ii];var parts=column.split("|");if(parts[0]==="field"){fields.push(pipeline.getField(parts[1]))}}return fields},destroy:function(){}});BB.Services.BoxDisplayText=new BoxDisplayText})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox;var BoxSearcher={searchNameByQuery:function(query,limit){query=(query||"").toLowerCase();limit=limit||8;var boxes=_.chain(BB.Data.getAllBoxes()).map(function(box){var boxName=box.displayName();var score=Streak.Utils.stringScore(boxName,query,.1);if(boxName.toLowerCase().indexOf(query)>-1){score+=1}return[score,box]}).sortBy(function(scoreBox){return-1*scoreBox[0]}).filter(function(scoreBox){return scoreBox[0]>.5}).map(function(scoreBox){return scoreBox[1]}).value();var boxesToReturn=[];for(var ii=0;ii<boxes.length;ii++){if(boxesToReturn.length<limit||boxes[ii].displayName().toLowerCase()===query){boxesToReturn.push(boxes[ii])}}return boxesToReturn},getBoxesWithOverlappingEmailAddresses:function(emailAddresses,excludeBox){var user=BB.getUser();if(!user){return[]}var userEmail=user.getEmail().toLowerCase();if(BB.getUser().isGoogleAppsUser()){var domain=BB.getUser().getDomain().toLowerCase();emailAddresses=_.filter(emailAddresses,function(emailAddress){return emailAddress.toLowerCase().indexOf(domain)===-1})}emailAddresses=_(emailAddresses).map(function(emailAddress){return emailAddress.toLowerCase()}).filter(function(emailAddress){if(emailAddress.indexOf("mailfoogae.appspotmail.com")>-1){return false}return emailAddress!==userEmail});return _.filter(BB.Data.getAllBoxes(),function(box){if(excludeBox){if(box.key()===excludeBox.key()){return false}}var boxEmailAddresses=box.get("emailAddresses");for(var ii=0;ii<boxEmailAddresses.length;ii++){if(emailAddresses.indexOf(boxEmailAddresses[ii].toLowerCase())>-1){return true}}return false})}};BB.Services.BoxSearcher=BoxSearcher})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox;var SuggestedBoxNames={getSuggestions:function(threads){var self=this;var i;if(threads&&threads.length>0){var map={names:{},companies:{}};var names=_.sortedPluck(threads,{pluck:function(thread){var arr=[];if(thread.emailAddresses){for(var i=0;i<thread.emailAddresses.length;i++){if(thread.emailAddresses[i]!=BB.getUser().getEmail()){var names=thread.names;if(names&&names.length>0){if(names[i]){arr.push(names[i].capitalize())}else{arr.push(thread.emailAddresses[i].split("@")[0])}}}}}return arr},filter:function(name){return name!=="me"}});names.reverse();for(i=0;i<names.length;i++){names[i]=$.trim(names[i].replace("✆","")).split(" ").map(function(s){return s.capitalize()}).join(" ")}var nameHash={};for(i=0;i<names.length;i++){if(names[i].indexOf(" ")>-1){nameHash[names[i].split(" ")[0].toLowerCase()]=names[i]}}names=_.filter(names,function(name){if(name.indexOf(" ")===-1){return!nameHash[name.toLowerCase()]}return true});var cDomain=BB.getUser().get("email").split("@")[1].split(".")[0];var companies=_.sortedPluck(threads,{pluck:function(thread){return thread.emailAddresses},map:function(address){return address.split("@")[1].capitalize().split(".")[0]},filter:function(domain){return BB.Constants.EMAIL_BLACK_LIST.indexOf(domain.toLowerCase())===-1&&domain.toLowerCase()!==cDomain.toLowerCase()}});companies.reverse();var allSuggestions=[];var subjects=_.pluckPlus(threads,function(thread){try{return thread.subject.stripTags()}catch(e){return""}});allSuggestions=allSuggestions.concat(_.firstIfPresent([subjects,companies,names]));allSuggestions=allSuggestions.concat(_.restIfPresent([names,companies,subjects]));var finalSugggestions=_.chain(allSuggestions).uniq().compact().filter(this._doesBoxNameNotExist).value();return finalSugggestions}},_doesBoxNameNotExist:function(boxName){var boxes=BB.Data.getAllBoxes();for(var ii=0;ii<boxes.length;ii++){if(boxes[ii].displayName().toLowerCase()===boxName.toLowerCase()){return false}}return true}};BB.Services.SuggestedBoxNames=SuggestedBoxNames})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PUNCTUATION_REGEX=/[^\w]|\s/;var CharacterSequenceController=function(){this._keyBuffer=null;this._bufferHistory=[];this._stateMachine=null;this._sequences=[];this._characterSequenceModels=[];this._setupShortcutListenerStateMachine()};_.extend(CharacterSequenceController.prototype,{addDataSource:function(characterSequenceModel){this._characterSequenceModels.push(characterSequenceModel);_.mutate("union",this._sequences,characterSequenceModel.getSequences());characterSequenceModel.addDelegate(this)},sequencesChanged:function(characterSequenceModel){var self=this;var sequences=_.chain(this._characterSequenceModels).map(function(characterSequenceModel){return characterSequenceModel.getSequences()}).flatten().value();this._sequences.length=0;_.mutate("union",this._sequences,sequences)}});_.extend(CharacterSequenceController.prototype,{_setupShortcutListenerStateMachine:function(){var self=this;this._stateMachine=Streak.StateMachine.create({initial:"start",events:[{name:"charPress",from:["start","someMatches"],to:"bufferCheck"},{name:"charPress",from:["noMatches"],to:"noMatches"},{name:"noMatching",from:["bufferCheck"],to:"noMatches"},{name:"matching",from:["bufferCheck"],to:"someMatches"},{name:"deletePress",from:["noMatches","someMatches"],to:"bufferCheck"},{name:"deletePress",from:["start"],to:"start"},{name:"reset",from:["noMatches","someMatches","bufferCheck","start"],to:"start"}],callbacks:{onstart:_.bind(this._onStart,this),onnoMatches:_.bind(this._onNoMatches,this),onsomeMatches:_.bind(this._onSomeMatches,this),onbufferCheck:_.bind(this._onBufferCheck,this),onbeforedeletePress:_.bind(this._onBeforeDeletePress,this)}})},_onStart:function(event,from,to){this._keyBuffer="";this._bufferHistory.length=0;this._callNoMatchCallbacks()},_onNoMatches:function(event,from,to){if(this._keyBuffer.length>0){this._bufferHistory.push(this._keyBuffer)}this._callNoMatchCallbacks()},_onSomeMatches:function(event,from,to){if(this._keyBuffer.length>0){this._bufferHistory.push(this._keyBuffer)}},_onBufferCheck:function(event,from,to,keyPressEvent){if(!this._keyBuffer||this._keyBuffer.length===0){this._stateMachine.reset();return}var matchedSequences=this._findPartialMatchSequences();if(matchedSequences.length===0){if(this._keyBuffer.match(/\s/)){this._stateMachine.reset()}this._keyBuffer="";this._stateMachine.noMatching();return}this._callPartialMatchCallbacks(matchedSequences);if(this._isThereAnExactMatch(matchedSequences)){if(this._shouldSuppressKeypress()){keyPressEvent.preventDefault()}this._callRelevantCallbacks();this._stateMachine.reset();return}this._stateMachine.matching()},_onBeforeDeletePress:function(event,from,to){if(this._bufferHistory.length>1){this._keyBuffer=this._bufferHistory.pop();this._keyBuffer=this._bufferHistory.pop()}else{this._keyBuffer=""}},_findPartialMatchSequences:function(){var self=this;return _.filter(this._sequences,function(sequence){return sequence&&sequence.indexOf(self._keyBuffer)===0})},_isThereAnExactMatch:function(sequences){for(var ii=0;ii<sequences.length;ii++){if(sequences[ii]===this._keyBuffer){return true}}return false},_shouldSuppressKeypress:function(){var matchedSequenceModels=this._findMatchingSequenceModels();for(var ii=0;ii<matchedSequenceModels.length;ii++){if(matchedSequenceModels[ii].onMatchShouldSuppress()){return true}}},_findMatchingSequenceModels:function(checkSequences){if(!checkSequences){checkSequences=[this._keyBuffer]}var sequence=this._keyBuffer;return _.filter(this._characterSequenceModels,function(characterSequenceModel){var sequences=characterSequenceModel.getSequences();for(var ii=0;ii<sequences.length;ii++){for(var jj=0;jj<checkSequences.length;jj++){if(sequences[ii]===checkSequences[jj]){return true}}}})},_callNoMatchCallbacks:function(){for(var ii=0;ii<this._characterSequenceModels.length;ii++){this._characterSequenceModels[ii].noMatchFound()}},_callRelevantCallbacks:function(){var matchedSequenceModels=this._findMatchingSequenceModels();for(var ii=0;ii<matchedSequenceModels.length;ii++){matchedSequenceModels[ii].exactMatchFound(this._keyBuffer)}},_callPartialMatchCallbacks:function(matchedSequences){var matchedSequenceModels=this._findMatchingSequenceModels(matchedSequences);for(var ii=0;ii<matchedSequenceModels.length;ii++){matchedSequenceModels[ii].partialMatchFound(this._keyBuffer)}}});_.extend(CharacterSequenceController.prototype,{destroy:function(){this._bufferHistory.length=0;this._sequences.length=0;this._characterSequenceModels.length=0},keydown:function(event){if(jwerty.is("left/right",event)){this._stateMachine.reset()}},keypress:function(event){if(jwerty.is("enter",event)){this._stateMachine.reset();return}var character=String.fromCharCode(event.keyCode);if(character.match(/\s/)&&this._stateMachine.is("noMatches")){this._stateMachine.reset();
return}if(this._stateMachine.is("noMatches")&&character.match(PUNCTUATION_REGEX)){this._stateMachine.reset();return}this._keyBuffer+=character;this._stateMachine.charPress(event)},keyup:function(event){if(jwerty.is("backspace",event)){this._stateMachine.deletePress()}},editorBlur:function(){this._stateMachine.reset()}});BB.Controllers.CharacterSequenceController=CharacterSequenceController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CharacterSequenceBaseDataSource=function(){Streak.ViewControllerBase.call(this)};CharacterSequenceBaseDataSource.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(CharacterSequenceBaseDataSource.prototype,{getSequences:function(){return this._sequences},addSequence:function(sequence){this._callDelegateFunction("sequencesChanged")},removeSequence:function(sequence){this._callDelegateFunction("sequencesChanged")},exactMatchFound:function(){this._callDelegateFunction.apply(this,["exactMatchFound"].concat(_.toArray(arguments)))},partialMatchFound:function(){this._callDelegateFunction.apply(this,["partialMatchFound"].concat(_.toArray(arguments)))},noMatchFound:function(){this._callDelegateFunction.apply(this,["noMatchFound"].concat(_.toArray(arguments)))},onMatchShouldSuppress:function(){return false}});BB.Controllers.CharacterSequenceController.CharacterSequenceBaseDataSource=CharacterSequenceBaseDataSource})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,Locale=Streak.Locale,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var Pipeline=BB.Models.Pipeline;var NOT_APPLICABLE="-";var ColumnSummary={Functions:{sum:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}return round(_.reduce(numberfy(cells),function(a,b){return a+b},0))},count:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}return autoSplitValues(cells).length},unique:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}if(type=="DATE"){cells=_.map(cells,coerceDate)}return _.uniq(autoSplitValues(cells)).length},average:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}var numbers=numberfy(cells);if(numbers.length==0){return NOT_APPLICABLE}return round(_.reduce(numbers,function(a,b){return a+b},0)/numbers.length)},min:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}var values=numberfy(cells);if(values.length==0){return NOT_APPLICABLE}var result=Math.min.apply(Math,values);if(type=="DATE"){result=coerceDate(result)}return result},max:function(cells,type){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}var values=numberfy(cells);if(values.length==0){return NOT_APPLICABLE}var result=Math.max.apply(Math,values);if(type=="DATE"){result=coerceDate(result)}return result},most_frequent:function(cells,type,pipeline,fieldKey){var counts=getCounts(cells,type,pipeline,fieldKey);if(counts===null){return NOT_APPLICABLE}return _.max(counts,function(c){return c[1]})[0]},least_frequent:function(cells,type,pipeline,fieldKey){var counts=getCounts(cells,type,pipeline,fieldKey);if(counts===null){return NOT_APPLICABLE}return _.min(counts,function(c){return c[1]})[0]},percentage_set:function(cells,type){var total=cells.length||0;if(total===0){return 0}var numSet=_.countBy(cells,_.toBoolean)["true"]||0;return numSet/total},number_set:function(cells,type){return _.countBy(cells,_.toBoolean)["true"]||0}},ListTypes:{NONE:[],BASIC:["sum","|","average","min","max","|","count","unique","|","most_frequent","least_frequent"],LIST:["count","unique","|","average","min","max","|","most_frequent","least_frequent"],DATE:["count","unique","|","min","max","|","most_frequent","least_frequent"],BOOLEAN:["percentage_set","number_set","|","most_frequent","least_frequent"],TEXT_VALUE:["count","unique","|","most_frequent","least_frequent"]},FieldTypesToListTypes:{TEXT:"BASIC",NUMBER:"BASIC",FORMULA:"BASIC",PERSON:"LIST",DATE:"DATE",CHECKBOX:"BOOLEAN",DROPDOWN:"TEXT_VALUE",TAG:"LIST"},getLocalizedName:function(name){return Locale.getString("summary_type_"+name)}};function getCounts(cells,type,pipeline,fieldKey){if(type==="FORMULA"){cells=_.map(cells,extractFormulaValue)}var splitVals=autoSplitValues(cells);if(splitVals.length==0){return null}switch(type){case"DATE":splitVals=_.map(splitVals,coerceDate);break;case"CHECKBOX":splitVals=_.map(cells,function(val){if(val){return BB.Locale.getString("checked")}else{return BB.Locale.getString("unchecked")}});break;case"DROPDOWN":var pipelineField=pipeline.getField(fieldKey);splitVals=_.map(splitVals,function(val){return pipelineField.getOption(val).name});break;case"TAG":var pipelineField=pipeline.getField(fieldKey);splitVals=_.map(splitVals,function(val){return pipelineField.getOption(val).tag});break}return counts=_.pairs(_.countBy(splitVals,_.identity))}function numberfy(cells){return _(cells).chain().map(function(val){if(_.isArray(val)){return val.length}if(_.isBoolean(val)){return val?1:0}return parseFloat(val)}).filter(function(val){return!isNaN(val)}).value()}function autoSplitValues(cells){return _(cells).chain().flatten(true).map(function(val){if(val&&val.email){val=val.email}if(typeof val=="string"){val=val.trim()}return val}).filter(function(val){return!!val||typeof val=="number"}).value()}function coerceDate(value){if(!value){return""}var dateValue=Date.create(value);if(dateValue.isValid()){return dateValue.prettyDate(true)}else{return""}}function round(value){return Math.round(value*100)/100}function extractFormulaValue(valueObject){if(_.isReal(valueObject.calculationValue)){return valueObject.calculationValue}return""}BB.ColumnSummary=ColumnSummary})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var promptVisible=false;var promptQueue=[];var self;self=BB.AssignedToController={initialized:false,init:function(cb){if(!self.initialized){NotificationCenter.subscribe({eventName:"409Conflict",observer:this,functionToCall:this._conflictFound});self.initialized=true}if(cb){cb()}},_conflictFound:function(notification){if(notification.model instanceof BB.Models.Box){this._handleBoxConflict(notification.model,notification.response)}else if(notification.model instanceof BB.Models.Pipeline){this._handlePipelineConflict(notification.model,notification.response)}},_handleBoxConflict:function(box,response){if(!response||!response.details){return}var attemptedList=response.details;var body=BB.Locale.getString("assigned_to_share_body",{pipeline:box.getPipeline().displayName(),box:box.displayName()})+"<br />"+"<ul>";for(var ii=0;ii<attemptedList.length;ii++){var contact=attemptedList[ii];var li="<li>";if(contact.fullName){li+=contact.fullName+" - "}if(contact.email){li+=contact.email}li+="</li>";body+=li}body+="</ul>";BB.Widgets.Modal.confirm(BB.Locale.getString("assigned_to_share_title"),body,function(){var pipeline=box.getPipeline();var currentACL=pipeline.get("aclEntries");currentACL=currentACL.concat(attemptedList);currentACL=_.uniq(currentACL,"email");pipeline.set("aclEntries",currentACL);var assignedToEntries=box.getAssignedToSharingEntries()||[];assignedToEntries=assignedToEntries.concat(attemptedList);assignedToEntries=_.uniq(assignedToEntries,"email");box.set("assignedToSharingEntries",assignedToEntries);Streak.Model.dependentSaveAll([pipeline,box])},function(){})},_handlePipelineConflict:function(pipeline,response){var contactsToUnshare=response.details;if(!contactsToUnshare||contactsToUnshare.length===0){return}this._promptForPipelineUnshare(pipeline,contactsToUnshare)},_promptForPipelineUnshare:function(pipeline,contactsToUnshare){var acl=pipeline.get("aclEntries");var orgWide=pipeline.get("orgWide");var emails=_.map(contactsToUnshare,function(contact){return contact.email}).join(", ");var body=BB.Locale.getString("assigned_to_unshare_pipeline_body",{contacts:emails});BB.Widgets.Modal.simpleConfirm(BB.Locale.getString("assigned_to_unshare_pipeline_title"),body)}};Streak.DependencyManager.addFunction({functionKey:"assignedToControllerInitialized",functionToCall:BB.AssignedToController.init,functionContext:BB.AssignedToController,dependentFunctionKeys:["data.pipelines.initialized","data.boxes.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var BoxSuggestionsController={trackingContext:{widgetContext:"boxGeneratedBySuggestions"},initialized:false,init:function(cb){var self=this;if(!self.initialized){var boxes=BB.Data.getAllBoxes();self.blackListOrgs.push(BB.getUser().getDomain().toLowerCase());boxes.watch("add",function(notification){self.updateBoxStemmingCache(notification.model)},this);boxes.watch("remove",function(notification){try{self.removeBoxStemmingCache(notification.model)}catch(ee){}},this);boxes.watch("change",function(notification){var box=notification.model;var property=notification.property;if(property==="name"){self.updateBoxStemmingCache(box)}},this);self.initialized=true}if(cb){cb()}},getBoxSuggestions:function(threads){var self=this;if(!threads){return[]}var threadsInfo=self.extractthreadsInfo(threads);var boxesObjectArray=self._getComputedBoxes(threadsInfo);var limitedBoxArray=_.first(boxesObjectArray,3);limitedBoxArray=_.filter(limitedBoxArray,function(box){return box.rank>=self.OVERALL_THREASHOLD});var boxesArray=_.map(limitedBoxArray,function(boxObject){var sourceOfAlgo=boxObject.rankingFactors;var _sourceRaw=sourceOfAlgo;var _source=self.generateSourceText(sourceOfAlgo);var _clickCallback=function(ee){var sourceOfAlgoArray=_.map(sourceOfAlgo,function(value,algoName){return algoName});var flattenedProps={algosArrayString:sourceOfAlgoArray.join(","),algosJSON:JSON.stringify(sourceOfAlgo)};self.track("suggestedBoxChosen",flattenedProps)};return{box:boxObject.box,clickCallback:_clickCallback,_source:_source,sourceRaw:_sourceRaw}});return boxesArray},removeBoxStemmingCache:function(box){var self=this;var boxKeywords=self.boxesStemmedKeywordsCache[box.key()];if(_.isReal(boxKeywords)){_.each(boxKeywords,function(stemmedWord){var boxes=self.keywordToBoxMapStemmingCache[stemmedWord];if(_.isReal(boxes)){boxes=_.filter(boxes,function(currBox){return currBox!==box});self.keywordToBoxMapStemmingCache[stemmedWord]=boxes}})}self.boxesStemmedKeywordsCache[box.key()]=null},updateBoxStemmingCache:function(box){var self=this;try{var boxKeywords=box.get("name").split(" ");boxKeywords=_.map(boxKeywords,function(keyword){var stemmedWord=Streak.Stemmer(keyword.toLowerCase().trim());if(!_.isReal(self.keywordToBoxMapStemmingCache[stemmedWord])){self.keywordToBoxMapStemmingCache[stemmedWord]=[]}self.keywordToBoxMapStemmingCache[stemmedWord].push(box);return stemmedWord});self.boxesStemmedKeywordsCache[box.key()]=boxKeywords}catch(ee){}},keywordToBoxMapStemmingCache:{},algosAndWeighting:{emailsAlgo:{weighting:.65,sourceReason:"emails in common with box contacts",lowerBoundthreashHold:.6},orgsAlgo:{weighting:.65,sourceReason:"similar organizations associated with box ",lowerBoundthreashHold:.6},orgNameMatchAlgo:{weighting:.8,lowerBoundthreashHold:0},subjectsAlgo:{weighting:.5,sourceReason:"subject similarity to box name",lowerBoundthreashHold:.3},wordsAlgo:{weighting:.9,sourceReason:"keywords in common with box name",lowerBoundthreashHold:.2},nameAlgo:{weighting:.5,lowerBoundthreashHold:.2}},OVERALL_THREASHOLD:.1,BOXLEN:3,COMMON_ENGLISH_WORDS:["the","is","was","to","an","did","and","a","or","you","this","they","her","not","he","she","they","would","there","their","with","about","from","have","look","know","seem","feel","leave","thing","want"],boxesStemmedKeywordsCache:{},wordsAlgo:function(threadsInfo){if(threadsInfo.keywordsInSubject.length===0){return[]}var self=this;var threadKeywords=threadsInfo.keywordsInSubject;var setOfmatchedBoxes=[];var boxes=Streak.BentoBox.Data.getAllBoxes();var mapOfKeywordsWithMatchedBoxes={};_.each(threadKeywords,function(stemmedWord){var boxes=self.keywordToBoxMapStemmingCache[stemmedWord];if(_.isReal(boxes)){mapOfKeywordsWithMatchedBoxes[stemmedWord]=boxes}});var winningBoxes=self.wordAlgoCombineBoxes(mapOfKeywordsWithMatchedBoxes);return winningBoxes},wordAlgoCombineBoxes:function(mapOfKeywordsWithMatchedBoxes){var boxMap={};_.each(mapOfKeywordsWithMatchedBoxes,function(boxes,word){var confidenceInSuggestion=.9999*1/boxes.length;_.each(boxes,function(box){if(boxMap[box.key()]){boxMap[box.key()].confidenceInSuggestion+=confidenceInSuggestion}else{boxMap[box.key()]={box:box,boxKey:box.key(),confidenceInSuggestion:confidenceInSuggestion}}})});var topBoxes=[];_.each(boxMap,function(boxObj){topBoxes.push(boxObj)});topBoxes=_.sortBy(topBoxes,function(boxObj){return boxObj.confidenceInSuggestion});return topBoxes.reverse()},stringsMatchingWeighted:function(string1,string2){var cleanString1=string1.toLowerCase().trim();var cleanString2=string2.toLowerCase().trim();var minLen=Math.min(cleanString1.length,cleanString2.length);var maxLen=Math.max(cleanString1.length,cleanString2.length);var differenceAlgoResult=Streak.calculateFastLevinshteinFinal(cleanString1,cleanString2);var result=1-differenceAlgoResult/maxLen;if(result<0){Streak.BentoBox.logError("  stringsMatchingWeighted   \n getting negative values for a weird reason on"+string1+","+string2);return 0}return result},subjectsAlgo:function(threadsInfo){if(threadsInfo.subjects.length===0){return[]}var self=this;var threadSubjects=threadsInfo.subjects;var setOfmatchedBoxes=[];var boxes=Streak.BentoBox.Data.getAllBoxes();_.each(boxes,function(box){var subjectsMatchedCount=0;var subjectsMatchedWeight=0;var subjectsMatchedWeights=[];_.each(threadSubjects,function(subject){var weight=self.stringsMatchingWeighted(subject,box.get("name"));if(weight>0){subjectsMatchedWeights.push(weight);subjectsMatchedCount++;subjectsMatchedWeight+=weight}});if(subjectsMatchedWeight!==0&&subjectsMatchedCount!==0){var calculateWeightedAvg=function(weights){var count=weights.length;var avg=0;_.each(weights,function(weight){avg=weight/count});return avg};var confidenceInSuggestion=calculateWeightedAvg(subjectsMatchedWeights);setOfmatchedBoxes.push({box:box,boxKey:box.key(),confidenceInSuggestion:confidenceInSuggestion})}});return setOfmatchedBoxes},emailsAlgo:function(threadsInfo){if(threadsInfo.emailAddressesCount===0){return[]}var setOfmatchedBoxes=[];var boxes=Streak.BentoBox.Data.getAllBoxes();var emailsInThreads=threadsInfo.emailAddresses;_.each(boxes,function(box){var boxEmails=box.get("emailAddresses");var emailsMatchedCount=0;_.each(emailsInThreads,function(count,email){if(_.contains(boxEmails,email)){emailsMatchedCount+=count}});var confidenceInSuggestion=1*emailsMatchedCount*(1/threadsInfo.emailAddressesCount);if(confidenceInSuggestion>0){setOfmatchedBoxes.push({box:box,boxKey:box.key(),confidenceInSuggestion:confidenceInSuggestion})}});return setOfmatchedBoxes},nameAlgo:function(threadsInfo){if(!threadsInfo.namesCount){return[]}var matchedBoxes=[];var boxes=BB.Data.getAllBoxes();for(var ii=0;ii<boxes.length;ii++){var box=boxes[ii];var boxName=box.displayName();var score=0;for(var name in threadsInfo.names){score+=Streak.Utils.stringScore(boxName,name,.1)*threadsInfo.names[name]}if(score>.7){matchedBoxes.push({box:box,boxKey:box.key(),confidenceInSuggestion:score/threadsInfo.namesCount})}}return matchedBoxes},extractKeywordsFromSubject:function(subject){var self=this;var subjectWords=subject.split(" ");subjectWords=_.filter(subjectWords,function(word){var cleanWord=word.toLowerCase().trim();return cleanWord.length>2&&!_.contains(self.COMMON_ENGLISH_WORDS,cleanWord)});subjectWords=_.map(subjectWords,function(word){return Streak.Stemmer(word.toLowerCase().trim())});return subjectWords},extractthreadsInfo:function(threads){var self=this;var threadsInfo={emailAddresses:{},emailAddressesCount:0,names:{},namesCount:0,subjects:[],orgs:{},threads:threads};_.each(threads,function(thread){var emails=thread.emailAddresses;_.each(emails,function(email){threadsInfo.emailAddressesCount++;if(threadsInfo.emailAddresses[email]){threadsInfo.emailAddresses[email]++}else{threadsInfo.emailAddresses[email]=1}});var names=thread.names||[];for(var ii=0;ii<names.length;ii++){threadsInfo.namesCount++;var name=names[ii];if(threadsInfo.names[name]){threadsInfo.names[name]++}else{threadsInfo.names[name]=1}}var subject=thread.subject.trim();threadsInfo.subjects.push(subject);threadsInfo.keywordsInSubject=self.extractKeywordsFromSubject(subject)});threadsInfo.orgs=self.extractOrgs(threadsInfo);return threadsInfo},processAndCombineBoxesIntoSortedArray:function(mapOfBoxes){var boxes=[];_.each(mapOfBoxes,function(boxObject,boxKey){boxes.push(boxObject)});var sortedBox=_.sortBy(boxes,function(box){return box.rank});return sortedBox},_getComputedBoxes:function(threadsInfo){var self=this;var boxMap={};var boxArray=[];_.each(self.algosAndWeighting,function(algoProperties,algoName){var algoBoxes=self[algoName](threadsInfo);_.each(algoBoxes,function(boxObject){var currBox=boxMap[boxObject.boxKey];if(_.isReal(currBox)){if(boxObject.confidenceInSuggestion>algoProperties.lowerBoundthreashHold){boxMap[boxObject.boxKey].rankingFactors[algoName]={original:boxObject.confidenceInSuggestion,processed:processedWeight};boxMap[boxObject.boxKey].rank+=boxObject.confidenceInSuggestion*algoProperties.weighting}}else{if(boxObject.confidenceInSuggestion>algoProperties.lowerBoundthreashHold){var rankingFactors={};var processedWeight=boxObject.confidenceInSuggestion*algoProperties.weighting;rankingFactors[algoName]={original:boxObject.confidenceInSuggestion,processed:processedWeight};boxMap[boxObject.boxKey]={box:boxObject.box,rank:processedWeight,rankingFactors:rankingFactors}}}})});return self.processAndCombineBoxesIntoSortedArray(boxMap).reverse()},generateSourceText:function(sourceofAlgo){var self=this;var setences=[];_.each(sourceofAlgo,function(values,algoName){setences.push(" - "+self.algosAndWeighting[algoName].sourceReason)});return setences.join("<br />")},extractOrgs:function(threadsInfo){var orgMap={};_.each(threadsInfo.emailAddresses,function(count,email){var org=email.split("@")[1].toLowerCase();if(_.contains(self.blackListOrgs,org)){return}var orgs=[org,org.split(".")[0]];_.each(orgs,function(theOrg){if(orgMap[theOrg]){orgMap[theOrg]+=count}else{orgMap[theOrg]=count}})});return orgMap},blackListOrgs:_.clone(Streak.BentoBox.Constants.EMAIL_BLACK_LIST),getMainOrg:function(orgsMap){var maxOrg;var maxCount=0;_.each(orgsMap,function(count,orgName){if(count>maxCount){maxCount=count;maxOrg=orgName}});return maxOrg},orgsAlgo:function(threadsInfo){var orgsCount=_.size(threadsInfo.orgs);if(orgsCount===0){return[]}var self=this;var setOfmatchedBoxes=[];var boxes=Streak.BentoBox.Data.getAllBoxes();var mainOrg=self.getMainOrg(threadsInfo.orgs);_.each(boxes,function(box){var boxOrgs=self.extractOrgsFromBox(box);if(_.isReal(boxOrgs[mainOrg])){var confidenceInSuggestion=boxOrgs[mainOrg]/orgsCount;if(confidenceInSuggestion>0){setOfmatchedBoxes.push({box:box,boxKey:box.key(),confidenceInSuggestion:confidenceInSuggestion})}}});return setOfmatchedBoxes},boxOrgsCache:{},extractOrgsFromBox:function(box){var self=this;var cachedOrgs=self.boxOrgsCache[box.key()];var orgs=[];var _orgsMap={};var boxEmails=box.get("emailAddresses");_.each(boxEmails,function(email){var org=email.split("@")[1];var blackListOrg=Streak.BentoBox.userEmail.split("@")[1];blackListOrg=blackListOrg.toLowerCase();org=org.toLowerCase();if(!_.contains(self.blackListOrgs,org)&&org!==blackListOrg){if(_orgsMap[org]){_orgsMap[org]+=1}else{_orgsMap[org]=1;orgs.push(org)}}});if(orgs.length>0){self.boxOrgsCache[box.key()]=_orgsMap}return _orgsMap},orgNameMatchAlgo:function(threadsInfo){var orgMap=threadsInfo.orgs;var matchedBoxObjects=[];var boxes=BB.Data.getAllBoxes();for(var ii=0;ii<boxes.length;ii++){var boxName=boxes[ii].displayName().toLowerCase();if(!orgMap[boxName]){continue}matchedBoxObjects.push({box:boxes[ii],boxKey:boxes[ii].key(),confidenceInSuggestion:orgMap[boxName]})}for(var ii=0;ii<matchedBoxObjects.length;ii++){var matchedBox=matchedBoxObjects[ii];matchedBox.confidenceInSuggestion=matchedBox.confidenceInSuggestion/matchedBoxObjects.length}return matchedBoxObjects},storeRecentlySeenBox:function(){},track:function(event,prop){BB.Tracker.trackStreakActive(this.trackingContext,prop,{eventName:event})}};Streak.DependencyManager.addFunction({functionKey:"boxSuggestionsControllerInitialized",functionToCall:BoxSuggestionsController.init,functionContext:BoxSuggestionsController,dependentFunctionKeys:["data.boxes.initialized","userLoggedIn"]});BB.Modules.BoxSuggestionsController=BoxSuggestionsController})(Streak);(function(Streak){"use strict";var Utils=Streak.Utils,BB=Streak.BentoBox;var GoogleJSAPI={_loaded:null,init:function(){if(!this._loaded){this._loaded=Utils.loadScript("https://www.google.com/jsapi")}return this._loaded},load:function(moduleName,moduleVersion,optionalSettings){return this.init().then(function(){return new Streak.RSVP.Promise(function(resolve,reject){if(!optionalSettings){optionalSettings={}}optionalSettings.callback=resolve;google.load(moduleName,moduleVersion,optionalSettings)})})}};BB.Services.GoogleJSAPI=GoogleJSAPI})(Streak);(function(Streak){"use strict";var Utils=Streak.Utils,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;function loadGoogleCharts(){return BB.Services.GoogleJSAPI.load("visualization","1",{packages:["corechart","table","timeline"]})}Streak.DependencyManager.addFunction({functionKey:"chartsInitialized",functionReference:loadGoogleCharts,dependentFunctionKeys:[]})})(Streak);(function(Streak){"use strict";var Utils=Streak.Utils,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GooglePlusOne={_loaded:null,init:function(){if(!this._loaded){this._loaded=Utils.loadScript("https://apis.google.com/js/platform.js")}return this._loaded},render:function(){return this.init().then(function(){gapi.plusone.go()}).catch(function(e){BB.logError("failed to render +1 button",e)})}};BB.Services.GooglePlusOne=GooglePlusOne})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var _contactCache={};var _userKeyToContactCache={};var _topContactsRequested=false;var _topContactsCallbacks=[];var _topContacts;BB.Contacts={init:function(cb){this.suggestionTemplate=HTML.get("peoplePickerSuggestion");if(cb){cb()}},makeContactRequest:function(path,queryParameters,cb){if(!queryParameters.limit){queryParameters.limit=15}var self=this;APIRequester.get(path,queryParameters).getPromise().then(function(res){if(!res){cb(null);return}else if(_.isString(res)){try{res=JSON.parse(res)}catch(err){cb(null);return}}var results=[];var resultArray;if(res&&res.feed&&res.feed.entry&&res.feed.entry.length>0){resultArray=res.feed.entry}else if(_.isArray(res)){resultArray=res}if(resultArray&&resultArray.length>0){$.each(resultArray,function(i,contact){var bbcon={};bbcon.id=contact.id.$t;if(contact.gd$name){bbcon.fullName=contact.gd$name.gd$fullName?contact.gd$name.gd$fullName.$t:null;bbcon.givenName=contact.gd$name.gd$givenName?contact.gd$name.gd$givenName.$t:null;bbcon.familyName=contact.gd$name.gd$familyName?contact.gd$name.gd$familyName.$t:null;bbcon.displayName=bbcon.fullName}if(contact.link){for(var ci=0,len=contact.link.length;ci<len;ci++){if(contact.link[ci].type=="image/*"&&_.isReal(contact.link[ci]["gd$etag"])){bbcon.imageUrl=BB.UI.getResourceURL("api/v1/contacts/photo?email="+encodeURIComponent(BB.userEmail)+"&photoUrl="+encodeURIComponent(contact.link[ci].href));bbcon.googleImageUrl=contact.link[ci].href;break}}}bbcon.lastUpdated=contact.updated?contact.updated.$t:null;if(contact.gd$email){for(var ci=0,len=contact.gd$email.length;ci<len;ci++){if(contact.gd$email[ci]){var clone=$.extend({},bbcon);clone.email=contact.gd$email[ci].address;clone.id=bbcon.id+"_"+clone.email;clone.fullName=bbcon.fullName||clone.email;clone.displayName=clone.fullName;results.push(clone)}}}})}results=_.uniq(results,false,function(result){return result.email});results=_.map(results,self.updateContact,self);cb(results)},function(){cb(null);return true})},queryContacts:function(query,cb,limit){BB.Contacts.makeContactRequest("contacts/search",{query:query,limit:limit},function(res){var results=res||[];results=results.sortBy(function(res){return-1*(res.fullName.intersectionRatio(query)+res.email.intersectionRatio(query))});cb(results)})},getTopContacts:function(cb,limit){if(_topContacts){cb(_topContacts);return}_topContactsCallbacks.push(cb);if(_topContactsRequested){return}_topContactsRequested=true;BB.Contacts.makeContactRequest("contacts/top",{limit:limit},function(response){_topContacts=response;for(var ii=0;ii<_topContactsCallbacks.length;ii++){_topContactsCallbacks[ii](_topContacts)}_topContactsRequested=false})},convertStringData:function(s){var bbcon=null;if(s.isValidEmail()){bbcon={id:s,fullName:s,email:s}}else{bbcon={id:s,fullName:s}}return bbcon},convertResultToLiElement:function(query,data){var li=$(BB.Contacts.suggestionTemplate({image:data.imageUrl,name:data.fullName?data.fullName.escapeHTML():data.email,tag:data.fullName?data.email:"&nbsp;"}));return li},compareContactAndQuery:function(query,data){var pass=false;if(data.fullName){pass=data.fullName.toLowerCase().indexOf(query)>-1}if(data.email){pass=pass||data.email.toLowerCase().indexOf(query)>-1}return pass},getContact:function(email){if(_contactCache[email]){return _contactCache[email]}return{email:email}},getLatestContactInformation:function(email,callback){var contact=_contactCache[email];if(!contact){contact={email:email}}if(contact.updatedFromServer){setTimeout(function(){callback(contact)},10);return}Gmail.GmailRequester.getContactDetails(email).then(function(result){if(result&&result.fullName){result.updatedFromServer=true;BB.Contacts.updateContact(result)}callback(_contactCache[email])},function(){callback(contact)});return contact},updateContact:function(contact){var newContact=contact,cachedContact;if(contact.email){cachedContact=_contactCache[contact.email];newContact=_.extend({},cachedContact,contact);_contactCache[contact.email]=newContact}return newContact},getImageURL:function(contact){var imageURL=contact.imageUrl?contact.imageUrl:contact.image;imageURL=imageURL?imageURL:Streak.server+Streak.combinedPath+"images/unknownContact.png";return imageURL},getContactImage:function(contact,parameters){_.defaults(parameters,{circle:false});var name=contact.displayName||contact.fullName||contact.email;var imageURL=BB.Contacts.getImageURL(contact);var img=document.createElement("img");img.setAttribute("src",imageURL);img.setAttribute("title",name.escapeHTML());if(parameters.circle){img.setAttribute("class","streak__circleContactImage")}img.setAttribute("email",contact.email);return img},getContactsFromUserKeys:function(userKeyList,callback){if(!userKeyList||userKeyList.length===0){callback([]);return}var contacts=[];var unseenUserKeys=[];for(var ii=0;ii<userKeyList.length;ii++){var contact=_userKeyToContactCache[userKeyList[ii]];if(contact){contacts.push(contact)}else{unseenUserKeys.push(userKeyList[ii])}}if(unseenUserKeys.length===0){callback(contacts);return}var self=this;APIRequester.get("users",{userKeyList:JSON.stringify(unseenUserKeys)}).getPromise().then(function(data){if(!data){callback(contacts);return}for(var ii=0;ii<data.length;ii++){var item=data[ii];var contact={imageUrl:item.googleProfilePhotoUrl,email:item.email,displayName:item.displayName,fullName:item.googleProfileFullName};contact=self.updateContact(contact);_userKeyToContactCache[unseenUserKeys[ii]]=contact;contacts.push(contact)}callback(contacts)})},getGravatarURL:function(email){email=email||"";var md5Hash=Streak.CryptoJS.MD5(email.trim().toLowerCase()).toString();return"https://www.gravatar.com/avatar/"+md5Hash+"?r=g&s=32"}};Streak.DependencyManager.addFunction({functionKey:"contactsInitialized",functionToCall:BB.Contacts.init,functionContext:BB.Contacts,dependentFunctionKeys:["htmlLoaded","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox;BB.Cursor={defaults:{selectedClass:"selected",highlightClass:null,selectFunc:$.noop,highlightFunc:$.noop,dimensions:1,highlightOnHover:false,highlightOnClick:false,selectOnClick:false,rollOver:false,input:null,noScroll:false,scrollStop:null,positionChangeFunc:$.noop,textSearch:false,aggressiveInputCapture:false},create:function(opts){var options={};$.extend(options,this.defaults,opts);if(!options.highlightClass){options.highlightClass=options.selectedClass}return new this.impl(options)},impl:function(options){var position=null,dataset=null,currentEl=null,isPaused=false,initialize=function(dontSetPosition){var i,j;if(dontSetPosition&&position){if(options.dimensions<2){if(position[0]>=dataset.length){position[0]=dataset.length-1}}else{try{if(position[0]>=dataset.length){position[0]=dataset.length-1}else if(position[1]>=dataset[position[0]].length){position[1]=dataset[position[0]].length-1}}catch(err){position=getZeroPosition()}}}else{position=getZeroPosition()}if(options.dimensions===1){for(i=0;i<dataset.length;i++){setupElement($(dataset[i]),[i])}}else if(options.dimensions===2){for(i=0;i<dataset.length;i++){for(j=0;j<dataset[i].length;j++){var el=dataset[i][j];el.setAttribute("cursorPosition",i+","+j)}}}updateDisplay()},setupElement=function(el,pos){el.off(".bbStreakCursor");if(options.highlightOnHover){el.on("mouseenter.bbStreakCursor",function(e){position=pos;updateDisplay(null,el,false,true)});el.on("mouseleave.bbStreakCursor",function(e){el.removeClass(options.selectedClass)})}if(options.highlightOnClick){el.on("click.bbStreakCursor",function(e){updateDisplay(pos,el)})}else if(options.selectOnClick){el.on("click.bbStreakCursor",function(e){updateDisplay(pos,el);select()})}},resetPosition=function(){position=getZeroPosition()},get=function(pos){if(!dataset){return null}var subset=dataset;for(var i=0;i<pos.length;i++){subset=subset[pos[i]]}if(pos.length===options.dimensions){return $(subset)}else{return subset}},getZeroPosition=function(){var pos=new Array(options.dimensions);for(var i=0;i<options.dimensions;i++){pos[i]=0}return pos},updatePosition=function(direction,axis){if(!axis){axis=0}if(!dataset){return}var subset=dataset;if(!position){resetPosition()}for(var i=0;i<axis;i++){subset=subset[position[i]]}if(direction==="up"){if(position[axis]-1<0){if(options.rollOver){position[axis]=subset.length-1}}else{position[axis]=position[axis]-1;if(options.dimensions>1&&axis===1){var set=get(position.first(1));if(position[axis]>=set.length){position[axis]=set.length-2}}}}else if(direction==="down"){if(position[axis]+1>=subset.length){if(options.rollOver){position[axis]=0}}else{position[axis]=position[axis]+1}}updateDisplay(position)},moveToBeginning=function(axis){if(axis===0){position[0]=0}else{position[axis]=0}updateDisplay(position)},moveToEnd=function(axis){if(axis===0){position[0]=dataset.length-1}else{position[axis]=get(position.first(axis)).length-1}updateDisplay(position)},updateDisplay=function(pos,el,noTrigger,noScroll){options.positionChangeFunc();if(pos){position=pos}var dpos=_.clone(position);if(options.dimensions>1){for(var i=1;i<options.dimensions;i++){var sset=get(dpos.first(i));if(dpos[i]>=sset.length){dpos[i]=sset.length-1}}}if(!el){el=get(dpos)}unfocus();el.addClass(options.selectedClass);if(!options.noScroll&&!noScroll){if(!el.is(".noScroll")){el.scrollintoview({duration:0,scrollStop:options.scrollStop})}}currentEl=el;if(!noTrigger){el.trigger("bbCursorSelect");options.highlightFunc(currentEl)}},triggerSelect=function(el,isEnter){if(!isPaused){options.selectFunc(el,isEnter)}},select=function(isEnter){if(!position){resetPosition()
}var getEl=get(position);if(getEl){triggerSelect(getEl,isEnter)}},setup=function(dSet,keepPosition){dataset=dSet.slice();initialize(keepPosition)},fastSetup=function(dSet){dataset=dSet},focus=function(){if(dataset!==null){updateDisplay()}},unfocus=function(){if(currentEl){currentEl.removeClass(options.selectedClass);currentEl.trigger("bbCursorDeselect")}},getCell=function(){return get(position)},setCursorPosition=function(el){var posAttribute=el.getAttribute("cursorPosition");if(posAttribute&&posAttribute.length>0){var pos=posAttribute.split(",");var coord=[parseInt(pos[0]),parseInt(pos[1])];updateDisplay(coord)}},pause=function(){isPaused=true},resume=function(){isPaused=false};if(options.input){BB.Keyboard.bindChordToEl({el:options.input,chord:"up/down",keyEvent:"keyup",useCapture:true,cb:function(e){if(!isPaused){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation()}}});BB.Keyboard.bindChordToElement(options.input,"down",function(e){if(!isPaused){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();updatePosition("down")}});BB.Keyboard.bindChordToElement(options.input,"up",function(e){if(!isPaused){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation();updatePosition("up")}});BB.Keyboard.bindChordToElement(options.input,"home",function(){moveToBeginning(0)},true);BB.Keyboard.bindChordToElement(options.input,"end",function(){moveToEnd(0)},true);BB.Keyboard.bindChordToElement(options.input,"enter",function(e){if(!isPaused){select(true);e.preventDefault();e.stopImmediatePropagation()}},false,false,false,"keydown",options.aggressiveInputCapture)}if(options.textSearch){var hInput=$(document.createElement("input"));hInput[0].setAttribute("type","text");BB.Keyboard.bindChordToElement(options.input,"[a-z]/shift+[a-z]/backspace",function(e){clearTimeout(timeout);if(Streak.jwerty.is("backspace",e)){hInput.val(hInput.val().first(hInput.val().length-1))}else{hInput.val(hInput.val()+String.fromCharCode(e.which))}setCursor();timeout=setTimeout(function(){hInput.val("")},1e3)},true,true,true);BB.Keyboard.bindChordToElement(options.input,"up/down/home/end",function(e){hInput.val("");if(!isPaused){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation()}});var setCursor=function(){var val=hInput.val().toLowerCase();$.each(dataset,function(index,item){if($(item)[0].innerText.trim().toLowerCase().startsWith(val)){updateDisplay([index]);return}})}}return{setup:setup,getPosition:function(){return position},updatePosition:updatePosition,moveToBeginning:moveToBeginning,moveToEnd:moveToEnd,select:select,focus:focus,setPosition:updateDisplay,setCursorPosition:setCursorPosition,unfocus:unfocus,reset:resetPosition,getCell:getCell,pause:pause,resume:resume,fastSetup:fastSetup}}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox;BB.VirtualCursorModel={defaults:{highlightFunc:$.noop,selectFunc:$.noop},create:function(opts){var options={};$.extend(options,this.defaults,opts);return new this.impl(options)},impl:function(options){var position=null,prevPosition=null,dataset=null,isPaused=false,noScroll=false,_classRanges=[],_seenClasses={},_cursorMap={},_cssClassMap={},resetPosition=function(){position=[0,0]},getFixedPosition=function(dpos){if(!position){resetPosition()}if(!dpos){dpos=_.clone(position)}var lastRow=0;if(dataset){lastRow=dataset.getLastRowNumber()}dpos[0]=Math.min(lastRow,dpos[0]);var lastColumn=0;if(dataset){lastColumn=dataset.getLastColumnForCurrentRow([dpos[0],0])}dpos[1]=Math.min(lastColumn,dpos[1]);return dpos},getRawPosition=function(){if(!position){resetPosition()}return position},updatePosition=function(direction,axis){this.notToTop=true;if(!axis){axis=0}if(direction==="up"){if(axis===1){position=getFixedPosition()}position[axis]=Math.max(position[axis]-1,0)}else if(direction==="down"){position[axis]=position[axis]+1;if(axis===0){position[axis]=Math.min(dataset.getLastRowNumber(),position[axis])}else if(axis===1){position=getFixedPosition()}}updateDisplay(position);this.notToTop=false},moveToBeginning=function(axis){this.notToTop=true;getFixedPosition();if(axis===0){position[0]=0}else{position[axis]=0}updateDisplay();this.notToTop=false},moveToEnd=function(axis){this.notToTop=true;getFixedPosition();if(axis===0){position[0]=dataset.getLastRowNumber()}else{position[axis]=dataset.getLastColumnForCurrentRow(position)}updateDisplay();this.notToTop=false},updateDisplay=function(pos){if(pos){position=pos}var dpos=getFixedPosition();unfocus();prevPosition=_.clone(dpos);options.highlightFunc(dpos)},select=function(){options.selectFunc(getFixedPosition())},setup=function(dSet){dataset=dSet;if(!position){resetPosition()}_cursorMap={};_cssClassMap={}},focus=function(){if(dataset!==null){updateDisplay()}},unfocus=function(){if(prevPosition){options.unhighlightFunc(getFixedPosition(prevPosition))}},pause=function(){isPaused=true},resume=function(){isPaused=false},isCoordEqual=function(coord1,coord2){return coord1[0]===coord2[0]&&coord1[1]===coord2[1]},recordSeenClass=function(cssClass){_seenClasses[cssClass]=true},getSeenClasses=function(){var _classes=[];_.each(_seenClasses,function(ii,kk){_classes.push(kk)});return _classes},setCoordinateClass=function(coord,cssClass){_cursorMap[coord]=[cssClass];recordSeenClass(cssClass)},addCoordinateClass=function(coord,cssClass){recordSeenClass(cssClass);if(_.isUndefined(_cursorMap[coord])){_cursorMap[coord]=[]}_cursorMap[coord]=_.union(_cursorMap[coord],[cssClass]);if(_.isUndefined(_cssClassMap[cssClass])){_cssClassMap[cssClass]=[]}_cssClassMap[cssClass]=_.unionPlus(_cssClassMap[cssClass],[coord],isCoordEqual)},addCursorRange=function(options){_classRanges.push(options);recordSeenClass(options.cssClass)},removeCursorRange=function(cssClass){_classRanges=_.filter(_classRanges,function(range){return range.cssClass!==cssClass})},getCursorRanges=function(){return _classRanges},addClassToCoordinates=function(cssClass,coordinates){recordSeenClass(cssClass);var coordinatesWithClass=_cssClassMap[cssClass];if(!coordinatesWithClass){coordinatesWithClass=[]}for(var ii=0;ii<coordinates.length;ii++){var coord=coordinates[ii];if(_.isUndefined(_cursorMap[coord])){_cursorMap[coord]=[cssClass]}else if(_cursorMap[coord].indexOf(cssClass)===-1){_cursorMap[coord].push(cssClass)}}_cssClassMap[cssClass]=_.unionPlus(coordinatesWithClass,coordinates,isCoordEqual)},removeAllCoordinateClasses=function(coord){_cursorMap[coord]=[]},removeCoordinateClass=function(coord,cssClass){_cursorMap[coord]=_.without(_cursorMap[coord],cssClass);_cssClassMap[cssClass]=_.withoutPlus(_cssClassMap[cssClass],coord,isCoordEqual)},removeClassForAllCoordinates=function(cssClass){var coords=_.clone(_cssClassMap[cssClass]);if(_.isArray(coords)){for(var ii=0;ii<coords.length;ii++){var classes=_cursorMap[coords[ii]];if(classes&&classes.length>0){_cursorMap[coords[ii]]=classes.removeVal(cssClass)}}}_cssClassMap[cssClass]=[]},getClassesPrettyString=function(coord){var classes=_cursorMap[coord]||[];classes=classes.concat(getRangeClasses(coord));return classes.join(" ")},getRangeClasses=function(coord){var appliedRanges=_.filter(_classRanges,function(range){return isCoordinateInRange(range,coord)});var rangeClasses=_.pluck(appliedRanges,"cssClass");for(var ii=0;ii<appliedRanges.length;ii++){var range=appliedRanges[ii];if(coord[0]===range.startCoord[0]){rangeClasses.push("streak__cursorRangeTop")}if(coord[0]===range.endCoord[0]){rangeClasses.push("streak__cursorRangeBottom")}if(coord[1]===range.startCoord[1]){rangeClasses.push("streak__cursorRangeLeft")}if(coord[1]===range.endCoord[1]){rangeClasses.push("streak__cursorRangeRight")}}return rangeClasses},isCoordinateInRange=function(range,coord){var startCoord=range.startCoord;var endCoord=range.endCoord;return coord[0]>=startCoord[0]&&coord[1]>=startCoord[1]&&coord[0]<=endCoord[0]&&coord[1]<=endCoord[1]};return{setup:setup,updatePosition:updatePosition,moveToBeginning:moveToBeginning,moveToEnd:moveToEnd,select:select,focus:focus,setPosition:updateDisplay,unfocus:unfocus,reset:resetPosition,pause:pause,resume:resume,getPosition:getFixedPosition,getRawPosition:getRawPosition,addCoordinateClass:addCoordinateClass,updateDisplay:updateDisplay,getClassesPrettyString:getClassesPrettyString,removeCoordinateClass:removeCoordinateClass,removeAllCoordinateClasses:removeAllCoordinateClasses,removeClassForAllCoordinates:removeClassForAllCoordinates,getActiveClasses:getSeenClasses,setCoordinateClass:setCoordinateClass,addCursorRange:addCursorRange,removeCursorRange:removeCursorRange,getCursorRanges:getCursorRanges,addClassToCoordinates:addClassToCoordinates}}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ThreadStorer=Streak.Class.subclass({className:"ThreadStorer",superclass:Streak.Object,_memberVariables:[{name:"_hexGmailThreadIdMap",destroy:true,defaultValue:{}},{name:"_transactionId",destroy:true,defaultValue:"threadStorer"},{name:"_isInTransaction",destroy:true,defaultValue:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._transactionId="ThreadStorer"},startTransaction:function(){this._isInTransaction=true;NotificationCenter.startTransaction(this._transactionId)},endTransaction:function(){this._isInTransaction=false;NotificationCenter.endTransaction(this._transactionId)},getGmailThread:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.GMAIL_THREAD)},getBoxKey:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.BOX_KEY)},getReminderBoxKey:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.REMINDER_BOX_KEY)},getSendLater:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.SEND_LATER)},getThreadMetaData:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.THREAD_META_DATA)},getTrackedThread:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.TRACKED_THREAD)},getLastThreadInfoTimestamp:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.LAST_THREAD_INFO_TIMESTAMP)},getBumpLaterCollection:function(hexGmailThreadId){return this._getValue(hexGmailThreadId,VALUE_TYPES.BUMP_LATER_COLLECTION)},getGmailThreadList:function(hexGmailThreadIdList,valueType){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.GMAIL_THREAD)},getBoxKeyList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.BOX_KEY)},getReminderBoxKeyList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.REMINDER_BOX_KEY)},getSendLaterList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.SEND_LATER)},getThreadMetaDataList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.THREAD_META_DATA)},getTrackedThreadList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.TRACKED_THREAD)},getLastThreadInfoTimestampList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.LAST_THREAD_INFO_TIMESTAMP)},getBumpLaterCollectionList:function(hexGmailThreadIdList){return this._getValueList(hexGmailThreadIdList,VALUE_TYPES.BUMP_LATER_COLLECTION)},_getValue:function(hexGmailThreadId,valueType){if(!this._hexGmailThreadIdMap[hexGmailThreadId]){return null}if(!this._hexGmailThreadIdMap[hexGmailThreadId][valueType]){return null}return this._hexGmailThreadIdMap[hexGmailThreadId][valueType]},_getValueList:function(hexGmailThreadIdList,valueType){var returnArray=[];for(var ii=0;ii<hexGmailThreadIdList.length;ii++){returnArray.push(this._getValue(hexGmailThreadIdList[ii],valueType))}return returnArray},getAllValues:function(hexGmailThreadId){if(!this._hexGmailThreadIdMap[hexGmailThreadId]){return null}return this._hexGmailThreadIdMap[hexGmailThreadId]},getAllThreadMetaData:function(){return this._getAll(VALUE_TYPES.THREAD_META_DATA)},getAllBumpLaterCollections:function(){return this._getAll(VALUE_TYPES.BUMP_LATER_COLLECTION)},_getAll:function(valueType){var returnArray=[];for(var hexGmailThreadId in this._hexGmailThreadIdMap){var valueMap=this._hexGmailThreadIdMap[hexGmailThreadId];if(valueMap[valueType]){returnArray.push(valueMap[valueType])}}return returnArray},setGmailThread:function(hexGmailThreadId,gmailThread){this._setValue(hexGmailThreadId,VALUE_TYPES.GMAIL_THREAD,gmailThread)},setBoxKey:function(hexGmailThreadId,boxKey){this._setValue(hexGmailThreadId,VALUE_TYPES.BOX_KEY,boxKey)},setThreadMetaData:function(hexGmailThreadId,threadMetaData){this._setValue(hexGmailThreadId,VALUE_TYPES.THREAD_META_DATA,threadMetaData)},setReminderBoxKey:function(hexGmailThreadId,reminderBoxKey){this._setValue(hexGmailThreadId,VALUE_TYPES.REMINDER_BOX_KEY,reminderBoxKey)},setSendLater:function(hexGmailThreadId,sendLater){this._setValue(hexGmailThreadId,VALUE_TYPES.SEND_LATER,sendLater)},setTrackedThread:function(hexGmailThreadId,trackedThread){this._setValue(hexGmailThreadId,VALUE_TYPES.TRACKED_THREAD,trackedThread)},setLastThreadInfoTimestamp:function(hexGmailThreadId,timestamp){this._setValue(hexGmailThreadId,VALUE_TYPES.LAST_THREAD_INFO_TIMESTAMP,timestamp)},setBumpLaterCollection:function(hexGmailThreadId,bumpLaterCollection){this._setValue(hexGmailThreadId,VALUE_TYPES.BUMP_LATER_COLLECTION,bumpLaterCollection)},_setValue:function(hexGmailThreadId,valueType,value){this._initializeMapFor(hexGmailThreadId,valueType);this._hexGmailThreadIdMap[hexGmailThreadId][valueType]=value;this._postNotification(hexGmailThreadId,valueType,value)},removeThreadMetaData:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.THREAD_META_DATA)},removeGmailThread:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.GMAIL_THREAD)},removeBoxKey:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.BOX_KEY)},removeReminderBoxKey:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.REMINDER_BOX_KEY)},removeSendLater:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.SEND_LATER)},removeTrackedThread:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.TRACKED_THREAD)},removeLastThreadInfoTimestamp:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES.LAST_THREAD_INFO_TIMESTAMP)},removeBumpLaterCollection:function(hexGmailThreadId){this._removeValue(hexGmailThreadId,VALUE_TYPES,BUMP_LATER_COLLECTION)},_removeValue:function(hexGmailThreadId,valueType,value){if(!this._hexGmailThreadIdMap[hexGmailThreadId]){return}if(!this._hexGmailThreadIdMap[hexGmailThreadId][valueType]){return}delete this._hexGmailThreadIdMap[hexGmailThreadId][valueType];this._postNotification(hexGmailThreadId,valueType,null)},_initializeMapFor:function(hexGmailThreadId,valueType){if(!this._hexGmailThreadIdMap[hexGmailThreadId]){this._hexGmailThreadIdMap[hexGmailThreadId]={}}},_postNotification:function(hexGmailThreadId,valueType,value){NotificationCenter.postNotification({eventName:"threadStorerDataChanged",hexGmailThreadId:hexGmailThreadId,valueType:valueType,value:value,sender:this,transactionId:this._isInTransaction?this._transactionId:null})}});var VALUE_TYPES={GMAIL_THREAD:"gmailThread",THREAD_META_DATA:"threadMetaData",SEND_LATER:"sendLater",BOX_KEY:"boxKey",REMINDER_BOX_KEY:"reminderBoxKey",TRACKED_THREAD:"trackedThread",LAST_THREAD_INFO_TIMESTAMP:"lastThreadInfoTimestamp",BUMP_LATER_COLLECTION:"bumpLaterCollection"};Library.set("BentoBox.Services.Threads.ThreadStorer",new ThreadStorer);DependencyManager.notifyFunctionFinished("threadsInitialized")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HexGmailThreadIdExtractor=Streak.Class.subclass({className:"HexGmailThreadIdExtractor",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getHexGmailThreadIdList:function(threadDOMRows){var hexGmailThreadIdList=[];var threadMetaDataList=BB.Services.Threads.ThreadStorer.getAllThreadMetaData();threadMetaDataList=_.sortBy(threadMetaDataList,"timestamp").reverse();var domRowMetaDataList=_.map(threadDOMRows,this._extractMetaDataFrom.bind(this));var usedThreadSubjectMap={};for(var ii=0;ii<domRowMetaDataList.length;ii++){var domRowMetaData=domRowMetaDataList[ii];domRowMetaData.uniqueKey=domRowMetaData.subject+domRowMetaData.emailString+domRowMetaData.date;var hexGmailThreadId=this._findHexGmailThreadIdFor(domRowMetaData,threadMetaDataList,usedThreadSubjectMap);hexGmailThreadIdList.push(hexGmailThreadId);if(hexGmailThreadId){usedThreadSubjectMap[domRowMetaData.uniqueKey]=(usedThreadSubjectMap[domRowMetaData.uniqueKey]||0)+1}}return hexGmailThreadIdList},_extractMetaDataFrom:function(threadDOMRow){if(!threadDOMRow){return{}}if(threadDOMRow.type==="vertical"){return this._extractMetaDataFromVerticalPreviewPaneRow(threadDOMRow)}var rowNodeElement=threadDOMRow.rowNode;var threadMetaData={};var lastTD=rowNodeElement.find("td").filter(":last");var timeSpan=lastTD.find("span");if(timeSpan&&timeSpan.length>0){threadMetaData.timeString=timeSpan.attr("title");threadMetaData.date=$.cleanString(timeSpan[0].innerHTML)}else{threadMetaData.timeString="";threadMetaData.date=""}if(threadDOMRow.subjectLink&&threadDOMRow.subjectLink.length>0){var subjectSpan=threadDOMRow.subjectLink.find("span[id]");threadMetaData.subject=subjectSpan[0].textContent.stripNonPrintableCharacters();threadMetaData.isUnread=subjectSpan[0].innerHTML.indexOf("<b>")>-1}else{threadMetaData.subject="";threadMetaData.isUnread=false}if(rowNodeElement.find(".y2").length>0){var bodyString=$.cleanString(rowNodeElement.find(".y2").cleanText()).trim();if(bodyString[0]==="-"){bodyString=bodyString.substring(1).trim()}threadMetaData.bodyString=bodyString}else{threadMetaData.bodyString=""}threadMetaData.names=[];threadMetaData.emailAddresses=[];threadMetaData.emailString="";rowNodeElement.find("span[email]").each(function(i,span){threadMetaData.names.push($(span)[0].innerHTML);threadMetaData.emailAddresses.push($(span).attr("email"))});if(threadMetaData.emailAddresses.length>0){threadMetaData.emailString=rowNodeElement.find("span[email]").closest("td").find("div.yW")[0].innerHTML.replace(/zF|yP/,"")}if(rowNodeElement.find("[streakthreadid]").length>0){threadMetaData.hexGmailThreadId=rowNodeElement.find("[streakthreadid]").attr("streakthreadid")}if(rowNodeElement.find("[title*=streakthreadid]").length>0){threadMetaData.hexGmailThreadId=rowNodeElement.find("[title*=streakthreadid]")[0].title.split(" ")[1]}return threadMetaData},_extractMetaDataFromVerticalPreviewPaneRow:function(threadDOMRow){var threadMetaData={};var rowSet=threadDOMRow.node;if(!rowSet||rowSet.length<2){return threadMetaData}if(rowSet[0].find("td.apt .apm span").length>0){threadMetaData.timeString=rowSet[0].find("td.apt .apm span").attr("title");threadMetaData.date=$.cleanString(rowSet[0].find("td.apt .apm span")[0].innerHTML)}var subjectSpan=rowSet[1].find("td[role=link] span[id]");threadMetaData.subject=subjectSpan[0].textContent.stripNonPrintableCharacters();threadMetaData.isUnread=subjectSpan[0].innerHTML.indexOf("<b>")>-1;if(rowSet.length<3){threadMetaData.bodyString=""}else if(rowSet[2].find(".y2").length>0){threadMetaData.bodyString=$.cleanText(rowSet[2].find(".y2").cleanText())}threadMetaData.names=[];threadMetaData.emailAddresses=[];threadMetaData.emailString="";rowSet[0].find("span[email]").each(function(i,span){threadMetaData.names.push($(span)[0].innerHTML);threadMetaData.emailAddresses.push($(span).attr("email"))});if(threadMetaData.emailAddresses.length>0){threadMetaData.emailString=rowSet[0].find("span[email]").closest("div")[0].innerHTML.replace(/zF|yP/,"")}if(rowSet[0].find("[streakthreadid]").length>0){threadMetaData.threadGmailId=rowSet[0].find("[streakthreadid]").attr("streakthreadid")}return threadMetaData},_findHexGmailThreadIdFor:function(domRowMetaData,threadMetaDataList,usedThreadSubjectMap){if(domRowMetaData.hexGmailThreadId){return domRowMetaData.hexGmailThreadId}var candidateThreads=this._filterThreadMetaDataOn(threadMetaDataList,"subject",domRowMetaData.subject);if(candidateThreads.length===0){return null}if(candidateThreads.length===1){return candidateThreads[0].hexGmailThreadId}candidateThreads=this._filterThreadMetaDataOn(candidateThreads,"emailString",domRowMetaData.emailString);if(candidateThreads.length===0){return null}if(candidateThreads.length===1){return candidateThreads[0].hexGmailThreadId}candidateThreads=this._filterThreadMetaDataOn(candidateThreads,"date",domRowMetaData.date);if(candidateThreads.length===0){return null}if(candidateThreads.length===1){return candidateThreads[0].hexGmailThreadId}if(!usedThreadSubjectMap[domRowMetaData.uniqueKey]){return candidateThreads[0].hexGmailThreadId}var candidateThread=candidateThreads[usedThreadSubjectMap[domRowMetaData.uniqueKey]];if(candidateThread){return candidateThread.hexGmailThreadId}return null},_filterThreadMetaDataOn:function(threadMetaDataList,property,value){var filteredList=[];for(var ii=0;ii<threadMetaDataList.length;ii++){if(threadMetaDataList[ii][property]===value){filteredList.push(threadMetaDataList[ii])}}return filteredList},getThreadIdForMessageId:function(messageId){var allMetaData=BB.Services.Threads.ThreadStorer.getAllThreadMetaData();var matches=_.filter(allMetaData,function(metaData){return _.contains(metaData.messageIds,messageId)});if(matches.length){return matches[0].threadGmailId}return messageId}});Library.set("BentoBox.Services.Threads.HexGmailThreadIdExtractor",new HexGmailThreadIdExtractor)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ThreadMetaDataCreator=Streak.Class.subclass({className:"ThreadMetaDataCreator",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},gmailLoaded:function(){this._bindToAjaxRequests();this._bindToConversationLoaded();try{this._processOnPageCrapFormatThreads()}catch(err){BB.logError("processing on page threads failed",err)}},processCrapFormatThreads:function(crapFormatThreads){if(!crapFormatThreads||crapFormatThreads.length===0){return}for(var ii=0;ii<crapFormatThreads.length;ii++){var threadMetaData=this.convertToThreadMetaData(crapFormatThreads[ii]);BB.Services.Threads.ThreadStorer.setThreadMetaData(threadMetaData.hexGmailThreadId,threadMetaData)}},convertToThreadMetaData:function(crapFormatThread){var threadMetaData={threadGmailId:crapFormatThread[0],encodedThreadId:crapFormatThread[0],hexGmailThreadId:crapFormatThread[0],subject:$.domCleanString(crapFormatThread[9]).stripNonPrintableCharacters(),date:$.cleanString(crapFormatThread[14]),timeString:$.cleanString(crapFormatThread[15]),emailString:crapFormatThread[7].replace(/zF|yP/,""),timestamp:crapFormatThread[16]/1e3,isUnread:crapFormatThread[9].indexOf("<b>")>-1,lastEmailAddress:crapFormatThread[28],bodyString:$.cleanString(crapFormatThread[10]),names:[],emailAddresses:[],messageIds:[crapFormatThread[1],crapFormatThread[2]]};var containerDiv=$(document.createElement("div"));containerDiv[0].innerHTML=threadMetaData.emailString;containerDiv.find("span[email]").each(function(i,span){threadMetaData.names.push($(span)[0].innerHTML);threadMetaData.emailAddresses.push($(span).attr("email"))});return threadMetaData},getActiveThreadMetaDataList:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);return BB.Services.Threads.ThreadStorer.getThreadMetaDataList(hexGmailThreadIdList)},_bindToAjaxRequests:function(){NotificationCenter.subscribe({eventName:"gmail.newThreadListResponse",observer:this,functionToCall:this._handleThreadListResponse})},_handleThreadListResponse:function(notification){if(!notification.response){return}this._updateThreadStorer(notification.response)},_bindToConversationLoaded:function(){Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this))},_handleConversationLoaded:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);var hexGmailThreadId;if(hexGmailThreadIdList.length===0||hexGmailThreadIdList.length>1){return}hexGmailThreadId=hexGmailThreadIdList[0];var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(hexGmailThreadId);if(threadMetaData){return}threadMetaData={};threadMetaData.hexGmailThreadId=hexGmailThreadId;threadMetaData.threadGmailId=hexGmailThreadId;threadMetaData.encodedThreadId=hexGmailThreadId;threadMetaData.subject=Gmail.getCurrentMain().find(".Bs .ha .hP").text();threadMetaData.names=[];threadMetaData.emailAddresses=[];threadMetaData.bodyString="";threadMetaData.isUnread=false;var people=Gmail.getCurrentMain().find("table.Bs div.hx span.gD, table.Bs div.hx span.g2");people.each(function(index,rawNode){var node=$(rawNode);var email=node.attr("email");if(email){if(node.isVisible()){threadMetaData.names.push(node.text());threadMetaData.emailAddresses.push(email)}}});BB.Services.Threads.ThreadStorer.setThreadMetaData(threadMetaData.hexGmailThreadId,threadMetaData)},_processOnPageCrapFormatThreads:function(){var threadResponseString=this._getOnPageThreadResponseString();if(!threadResponseString){return}threadResponseString=threadResponseString.replace(/.*var VIEW_DATA=/,"").replace(/;var GM_TIMING.*/,"");this._updateThreadStorer(threadResponseString)},_getOnPageThreadResponseString:function(){var scripts=$("script");var regex=/var VIEW_DATA\=\[\[/;for(var ii=0;ii<scripts.length;ii++){var script=scripts[ii];if(script.src){continue}var contents=script.innerHTML;if(regex.test(contents)){return contents}}return null},_updateThreadStorer:function(threadResponseString){var threadResponseArray=Gmail.ThreadResponseProcessor.extractThreads(threadResponseString);if(!threadResponseArray){return}for(var ii=0;ii<threadResponseArray.length;ii++){var threadMetaData=this.convertToThreadMetaData(threadResponseArray[ii]);BB.Services.Threads.ThreadStorer.setThreadMetaData(threadMetaData.hexGmailThreadId,threadMetaData)}}});Library.set("BentoBox.Services.Threads.ThreadMetaDataCreator",new ThreadMetaDataCreator);Streak.DependencyManager.addFunction({functionKey:"threadMetaDataCreatorInitialized",functionReference:BB.Services.Threads.ThreadMetaDataCreator.gmailLoaded,functionContext:BB.Services.Threads.ThreadMetaDataCreator,dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SentEmailsMetaDataManager=Streak.Class.subclass({className:"SentEmailsMetaDataManager",superclass:Streak.Object,_memberVariables:[{name:"_sentEmailPollingChecker",destroy:true},{name:"_sentEmailsPollingFor",destroy:true,defaultValue:[]},{name:"_isCurrentlyPolling",destroy:true,defaultValue:false},{name:"_lastSentThreadMetaData",destroy:false,get:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);NotificationCenter.subscribe({eventName:"gmail.emailSent",observer:this,functionToCall:this._handleEmailSent})},_handleEmailSent:function(notification){var response=notification.response;if(!notification.requestParameters||!notification.requestParameters.composeid){return}var composeid=notification.requestParameters.composeid;if(!this._areSubscribersInterestedInThreadId(composeid)||!this._areSubscribersInterestedInRfcMessageId(composeid)){this._postNotificationAllMetaDataRetrieved(composeid);return}var messageId=this._tryToExtractMessageIdFrom(response);if(messageId){this._getHexGmailThreadIdBySearching(messageId,notification.requestParameters);return}this._getHexGmailThreadIdByPolling(notification.requestParameters)},_areSubscribersInterestedInThreadId:function(composeid){return NotificationCenter.areThereSubscribers({eventName:"hexGmailThreadIdForSentEmailFound",composeid:composeid})},_areSubscribersInterestedInRfcMessageId:function(composeid){return NotificationCenter.areThereSubscribers({eventName:"rfcMessageIdForSentEmailFound",composeid:composeid})},_tryToExtractMessageIdFrom:function(response){var messageId;try{messageId=Gmail.ThreadResponseProcessor.extractMessageIdFromSentEmail(response)}catch(err){var msg="could not extract messageId";try{response=JSON.stringify(Gmail.ThreadResponseProcessor.deserialize(response))}catch(pe){msg+="\n not parsed"}msg+="\n"+response;BB.logError(msg,err);return}return messageId},_getHexGmailThreadIdBySearching:function(messageId,requestParameters){var self=this;this._getCrapFormatThread(messageId,function(responseString){var hexGmailThreadId;try{hexGmailThreadId=Gmail.ThreadResponseProcessor.extractHexGmailThreadIdFromMessageIdSearch(responseString)}catch(err){}if(hexGmailThreadId){var threadMetaData=self._extractThreadMetaData(hexGmailThreadId,requestParameters);self._registerSentEmail(threadMetaData);return}self._getHexGmailThreadIdByPolling(requestParameters)})},_getCrapFormatThread:function(messageId,callback){Gmail.GmailRequester.getThread(messageId,callback,function(){callback(null)})},_registerSentEmail:function(threadMetaData){BB.Services.Threads.ThreadStorer.setThreadMetaData(threadMetaData.hexGmailThreadId,threadMetaData);NotificationCenter.postNotification({eventName:"hexGmailThreadIdForSentEmailFound",sender:this,hexGmailThreadId:threadMetaData.hexGmailThreadId,composeid:threadMetaData.composeid,threadMetaData:threadMetaData});this._lastSentThreadMetaData=threadMetaData;if(this._areSubscribersInterestedInRfcMessageId(threadMetaData.composeid)){this._getRfcMessageIdForThread(threadMetaData)}else{this._postNotificationAllMetaDataRetrieved(threadMetaData.composeid)}},_extractThreadMetaData:function(hexGmailThreadId,requestParameters){var thread={threadGmailId:hexGmailThreadId,encodedThreadId:hexGmailThreadId,hexGmailThreadId:hexGmailThreadId,subject:requestParameters.subject,emailAddresses:this._extractEmails(requestParameters),names:this._extractNames(requestParameters),draft:requestParameters.draft,composeid:requestParameters.composeid};return thread},_extractNames:function(gmailEmailArrayObject){var toFields=this._extractRecipients(gmailEmailArrayObject);var self=this;var names=[];_.each(toFields,function(to){if(to.length>0){var endOfName=to.indexOf("<");var name=to.substring(0,endOfName);names.push(name)}});return names},_extractEmails:function(gmailEmailArrayObject){var toFields=this._extractRecipients(gmailEmailArrayObject);var self=this;var emails=[];_.each(toFields,function(to){if(to.length===0){return}if(to.indexOf("<")<0){emails.push(to)}else{var match=/\<.+?\>/g.exec(to);if(_.isReal(match)&&match.length>0){var _email=match[match.length-1];_email=_email.substring(1,_email.length-1);emails.push(_email)}}});return emails},_extractRecipients:function(gmailEmailArrayObject){var recipients=[];if(_.isArray(gmailEmailArrayObject.to)){recipients=recipients.concat(gmailEmailArrayObject.to)}if(_.isArray(gmailEmailArrayObject.cc)){recipients=recipients.concat(gmailEmailArrayObject.cc)}if(_.isArray(gmailEmailArrayObject.bcc)){recipients=recipients.concat(gmailEmailArrayObject.bcc)}return recipients},_getHexGmailThreadIdByPolling:function(requestParameters){if(requestParameters.rm!=="undefined"&&requestParameters.rm!==""){return}requestParameters.timestamp=Date.now();this._sentEmailPollingChecker=0;this._sentEmailsPollingFor.push(requestParameters);if(!this._isCurrentlyPolling){this._startPolling()
}},_startPolling:function(){this._isCurrentlyPolling=true;this._checkSentMail()},_checkSentMail:function(){var self=this;Gmail.GmailRequester.getSentMail(function(res){if(self._sentEmailPollingChecker>10){self._logSentEmailsCantBeFound(res)}else{self._processSentMailResponse(res)}})},_logSentEmailsCantBeFound:function(res){var msg="sent emails couldn't be found";if(self._sentEmailPollingFor){for(var ii=0;ii<self._sentEmailsPollingFor.length;ii++){var email=self._sentEmailsPollingFor[ii];if(!email.found){msg+="\n email subject: "+email.subject;msg+=" | to: "+JSON.stringify(email.to);msg+=" | timestamp: "+email.timestamp}}}BB.logError(msg);self._resetPolling()},_resetPolling:function(){this._sentEmailsPollingFor.length=0;this._sentEmailPollingChecker=0;this._isCurrentlyPolling=false},_processSentMailResponse:function(res){if(!res){return}var threadResponseArray=Gmail.ThreadResponseProcessor.extractThreads(res);var threadMetaDataList=[];for(var ii=0;ii<threadResponseArray.length;ii++){threadMetaDataList.push(BB.Services.Threads.ThreadMetaDataCreator.convertToThreadMetaData(threadResponseArray[ii]))}if(!threadMetaDataList||threadMetaDataList.length===0){return}var foundThreadsCount=0;for(var ii=0;ii<this._sentEmailsPollingFor.length;ii++){var pollThread=this._sentEmailsPollingFor[ii];for(var jj=0;jj<threadMetaDataList.length;jj++){if(this._compareSentMail(threadMetaDataList[jj],pollThread)){var foundThread=threadMetaDataList[jj];threadMetaDataList.removeAt(jj);if(!pollThread.found){foundThread.draft=pollThread.draft;foundThread.composeid=pollThread.composeid;foundThread.names=this._extractNames(pollThread);foundThread.emailAddresses=this._extractEmails(pollThread);this._registerSentEmail(foundThread)}pollThread.found=true;foundThreadsCount++;break}}}if(foundThreadsCount===this._sentEmailsPollingFor.length){this._resetPolling();return}this._sentEmailPollingChecker++;setTimeout(_.bind(this._checkSentMail,this),2e3)},_compareSentMail:function(threadMetaData,pollThread){var subjectMatch=false;var cleanSubject=$.domCleanString(Streak.cleanupEmailSubject(pollThread.subject)).removeWhitespace();if(cleanSubject===$.domCleanString(Streak.cleanupEmailSubject(threadMetaData.subject)).removeWhitespace()){subjectMatch=true}if(cleanSubject.trim().length===0){if(threadMetaData.subject.match(/^\((\s|\w)*?\)$/)){subjectMatch=true}}if(subjectMatch){if(_.isArray(pollThread.to)){for(var i=0;i<pollThread.to.length;i++){if(this._compareEmailAddresses(pollThread.to[i],threadMetaData.emailString)){var timestampMatched=this._compareTimestamps(pollThread.timestamp,threadMetaData.timestamp);if(timestampMatched){return true}else{BB.Logger.log("timestamps not matched")}}}BB.Logger.log("array to not matched");return false}else{var emailMatched=this._compareEmailAddresses(pollThread.to,threadMetaData.emailString);if(emailMatched){var timestampMatched=this._compareTimestamps(pollThread.timestamp,threadMetaData.timestamp);if(timestampMatched){return true}else{BB.Logger.log("timestamps not matched")}}BB.Logger.log("single email not matched");return false}}else{BB.Logger.log("subject not matched")}return false},_compareEmailAddresses:function(structuredEmail,emailString){if(!structuredEmail||!emailString){return false}var matches=structuredEmail.match(/(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/gi);if(matches&&matches.length>0){for(var i=0;i<matches.length;i++){var match=matches[i].toLowerCase();if(emailString.toLowerCase().indexOf(match)>-1){return true}}}else{return false}return false},_compareTimestamps:function(threadTimestamp,emailTimestamp){var d1=Date.create(threadTimestamp);var d2=Date.create(emailTimestamp);return Math.abs(d1.minutesSince(d2))<4},_getRfcMessageIdForThread:function(threadMetaData){var self=this;Gmail.RFCMessageIdExtractor.getRFCMessageIdForThread(threadMetaData.hexGmailThreadId,function(rfcMessageId){if(rfcMessageId){threadMetaData.rfcMessageId=rfcMessageId;NotificationCenter.postNotification({eventName:"rfcMessageIdForSentEmailFound",sender:self,hexGmailThreadId:threadMetaData.hexGmailThreadId,rfcMessageId:rfcMessageId,composeid:threadMetaData.composeid,threadMetaData:threadMetaData})}self._postNotificationAllMetaDataRetrieved(threadMetaData.composeid)})},_postNotificationAllMetaDataRetrieved:function(composeid){NotificationCenter.postNotification({eventName:"allMetaDataRetrievedForCompose",sender:this,composeid:composeid})}});Streak.DependencyManager.addFunction({functionKey:"sentEmailsMetaDataManagerInitialized",functionReference:function(){Library.set("BentoBox.Services.Threads.SentEmailsMetaDataManager",new SentEmailsMetaDataManager)},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ThreadInfoRequestOperation=Streak.Class.subclass({className:"ThreadInfoRequestOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_hexGmailThreadId",destroy:false,get:true}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._hexGmailThreadId=options.hexGmailThreadId;this._dependentOnTags=this._getDependentOnTags()},getMethod:function(){return"POST"},getParams:function(){return{url:"threadinfo",hexGmailThreadId:this._hexGmailThreadId}},_getDependentOnTags:function(){return["gmailThread_hexGmailThreadId_"+this._hexGmailThreadId]},_handleError:function(err){var response=err&&err.response;var xhr=err&&err.xhr;switch(xhr&&xhr.status){case 0:case 500:this._backoffAndExecuteAjaxRequest();return}this._response=response;this._xhr=xhr;this._broadcastErrorNotification();this._failureCallback(this)},_broadcastErrorNotification:function(){switch(this._xhr&&this._xhr.status){case 401:Streak.NotificationCenter.postNotification({eventName:"unauthorizedRequest",sender:this});break}}});Library.set("BentoBox.Services.Threads.ThreadInfoRequestOperation",ThreadInfoRequestOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ThreadInfoListRequestOperation=Streak.Class.subclass({className:"ThreadInfoListRequestOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_hexGmailThreadIdList",destroy:false}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._hexGmailThreadIdList=options.hexGmailThreadIdList},getMethod:function(){return"POST"},getParams:function(){return{url:"threadinfo",hexGmailThreadIdList:JSON.stringify(this._hexGmailThreadIdList)}},_handleError:function(err){var response=err&&err.response;var xhr=err&&err.xhr;switch(xhr&&xhr.status){case 0:case 500:this._backoffAndExecuteAjaxRequest();return}this._response=response;this._xhr=xhr;this._broadcastErrorNotification();this._failureCallback(this)},_broadcastErrorNotification:function(){switch(this._xhr&&this._xhr.status){case 401:Streak.NotificationCenter.postNotification({eventName:"unauthorizedRequest",sender:this});break}}});Library.set("BentoBox.Services.Threads.ThreadInfoListRequestOperation",ThreadInfoListRequestOperation)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var THREAD_INFO_CACHE_TIME=5*60*1e3;var ThreadStorer;var ThreadInfoOperationManager=Streak.Class.subclass({className:"ThreadInfoOperationManager",superclass:Streak.Operations.OperationStatusChangeHandler,_memberVariables:[],gmailLoaded:function(){ThreadStorer=BB.Services.Threads.ThreadStorer;this._bindToDOMEvents();if(Gmail.isConversation()){this._getSingleThreadDataFromServer(Gmail.getConversationId())}else{this._getThreadDataFromServer(BB.Services.Threads.HexGmailThreadIdExtractor.getHexGmailThreadIdList(Gmail.getThreadDOMRows()))}},refreshHexGmailThreadId:function(hexGmailThreadId){this._getSingleThreadDataFromServer(hexGmailThreadId)},updateThreadStorerTrackedThreadFor:function(hexGmailThreadId,trackedThread){this._updateThreadStorerTrackedThreadFor(hexGmailThreadId,trackedThread)},_bindToDOMEvents:function(){NotificationCenter.subscribe({eventName:"gmail.conversationThreadLoaded",observer:this,functionToCall:this._handleConversationLoaded});NotificationCenter.subscribe({eventName:"gmail.newThreadDOMRows",observer:this,functionToCall:this._handleNewThreadDOMRows})},_handleConversationLoaded:function(notification){if(Gmail.isPreviewPaneConversation()){this._handlePreviewConversationLoaded();return}if(Gmail.isConversation()){this._getSingleThreadDataFromServer(Gmail.getConversationId());return}},_handlePreviewConversationLoaded:function(){var threadDOMRow=Gmail.getPreviewedThreadDOMRow();var hexGmailThreadIdList=BB.Services.Threads.HexGmailThreadIdExtractor.getHexGmailThreadIdList([threadDOMRow]);this._getSingleThreadDataFromServer(hexGmailThreadIdList[0])},_getSingleThreadDataFromServer:function(hexGmailThreadId){var operation=this._createThreadInfoRequestOperation(hexGmailThreadId);var operationStatusChangeHandler=this;Streak.Operations.OperationQueue.Singleton.addOperation(operation,operationStatusChangeHandler)},_createThreadInfoRequestOperation:function(hexGmailThreadId){return new BB.Services.Threads.ThreadInfoRequestOperation({hexGmailThreadId:hexGmailThreadId})},_handleNewThreadDOMRows:function(notification){var hexGmailThreadIdList=BB.Services.Threads.HexGmailThreadIdExtractor.getHexGmailThreadIdList(notification.threadDOMRows);if(Gmail.isDrafts()){this._getSendLatersFromServer(hexGmailThreadIdList);return}hexGmailThreadIdList=this._filterOutRecentlyUpdated(hexGmailThreadIdList);if(hexGmailThreadIdList.length===0){return}this._getThreadDataFromServer(hexGmailThreadIdList)},_filterOutRecentlyUpdated:function(hexGmailThreadIdList){var lastThreadInfoTimestampList=ThreadStorer.getLastThreadInfoTimestampList(hexGmailThreadIdList);var newHexGmailThreadIdList=[];for(var ii=0;ii<hexGmailThreadIdList.length;ii++){var hexGmailThreadId=hexGmailThreadIdList[ii];var lastThreadInfoTimestamp=lastThreadInfoTimestampList[ii];if(lastThreadInfoTimestamp&&_.isDate(lastThreadInfoTimestamp)&&Math.abs(lastThreadInfoTimestamp.millisecondsFromNow())<THREAD_INFO_CACHE_TIME){continue}newHexGmailThreadIdList.push(hexGmailThreadId)}return newHexGmailThreadIdList},_getThreadDataFromServer:function(hexGmailThreadIdList){if(!hexGmailThreadIdList||hexGmailThreadIdList.length===0){return}var operation=this._createThreadInfoListRequestOperation(hexGmailThreadIdList);var operationStatusChangeHandler=this;Streak.Operations.OperationQueue.Singleton.addOperation(operation,operationStatusChangeHandler)},_createThreadInfoListRequestOperation:function(hexGmailThreadIdList){return new BB.Services.Threads.ThreadInfoListRequestOperation({hexGmailThreadIdList:hexGmailThreadIdList})},_operationSucceeded:function(operation){if(operation instanceof BB.Services.Threads.ThreadInfoRequestOperation){this._singleThreadDataSucceeded(operation);return}var threadInfoMap=operation.getResponse();this._updateThreadStorer(threadInfoMap,operation)},_singleThreadDataSucceeded:function(operation){var hexGmailThreadId=operation.getHexGmailThreadId();var pendingOperations=Streak.Operations.OperationQueue.Singleton.queryOperationQueue({containsTags:["gmailThread_hexGmailThreadId_"+hexGmailThreadId],afterOperation:operation});var response=operation.getResponse();if(pendingOperations.length===0){this._updateThreadStorerGmailThreadFor(hexGmailThreadId,response.gmailThread);this._updateThreadStorerBoxKeyFor(hexGmailThreadId,response)}this._updateThreadStorerTrackedThreadFor(hexGmailThreadId,response.trackedThread);this._updateThreadStorerBumpLaterFor(hexGmailThreadId,response.bumpLaters)},_operationFailed:function(operation){},_updateThreadStorer:function(threadInfoMap,operation){ThreadStorer.startTransaction();var hexGmailThreadIdToPendingStatusOperationMap=this._getHexGmailThreadIdToPendingStatusOperationMap(threadInfoMap,operation);for(var hexGmailThreadId in threadInfoMap){if(hexGmailThreadIdToPendingStatusOperationMap[hexGmailThreadId]){continue}this._updateThreadStorerFor(hexGmailThreadId,threadInfoMap[hexGmailThreadId])}ThreadStorer.endTransaction()},_getHexGmailThreadIdToPendingStatusOperationMap:function(threadInfoMap,operation){var tags=_.chain(threadInfoMap).keys().map(function(hexGmailThreadId){return"gmailThread_hexGmailThreadId_"+hexGmailThreadId}).value();var operations=Streak.Operations.OperationQueue.Singleton.queryOperationQueue({containsTags:tags,afterOperation:operation});var hexGmailThreadIdOperationMap={};for(var ii=0;ii<operations.length;ii++){hexGmailThreadIdOperationMap[operations[ii].getModel().get("hexGmailThreadId")]=true}return hexGmailThreadIdOperationMap},_updateThreadStorerFor:function(hexGmailThreadId,threadInfo){this._updateThreadStorerGmailThreadFor(hexGmailThreadId,threadInfo.gmailThread);this._updateThreadStorerBoxKeyFor(hexGmailThreadId,threadInfo);this._updateThreadStorerTrackedThreadFor(hexGmailThreadId,threadInfo.trackedThread);this._updateThreadStorerBumpLaterFor(hexGmailThreadId,threadInfo.bumpLaters);this._updateLastThreadInfoTimestampFor(hexGmailThreadId)},_updateThreadStorerGmailThreadFor:function(hexGmailThreadId,threadInfoGmailThread){var currentGmailThread=ThreadStorer.getGmailThread(hexGmailThreadId);if(!currentGmailThread&&threadInfoGmailThread){var gmailThread=BB.Models.GmailThread.create(threadInfoGmailThread);BB.Data.getAllGmailThreads().add(gmailThread);return}if(currentGmailThread&&!threadInfoGmailThread){BB.Data.getAllGmailThreads().remove(currentGmailThread);return}if(currentGmailThread&&threadInfoGmailThread){Streak.Operations.ModelOperationManager.Singleton.updateModel(currentGmailThread,threadInfoGmailThread)}},_updateThreadStorerBoxKeyFor:function(hexGmailThreadId,threadInfo){var currentBoxKey=ThreadStorer.getBoxKey(hexGmailThreadId);var boxKey=threadInfo.boxKey;if(!boxKey&&threadInfo.box){boxKey=threadInfo.box.boxKey}if(currentBoxKey&&!boxKey){ThreadStorer.removeBoxKey(hexGmailThreadId);return}if(!currentBoxKey&&!boxKey){return}if(currentBoxKey!==boxKey){ThreadStorer.setBoxKey(hexGmailThreadId,boxKey)}},_updateThreadStorerTrackedThreadFor:function(hexGmailThreadId,trackedThread){if(!trackedThread){return}var currentTrackedThread=ThreadStorer.getTrackedThread(hexGmailThreadId);var newTrackedThread=_.extend({},currentTrackedThread,trackedThread);ThreadStorer.setTrackedThread(hexGmailThreadId,newTrackedThread)},_getSendLatersFromServer:function(hexGmailThreadIdList){var self=this;Streak.APIRequester.get("sendlaters",{hexGmailThreadIdList:JSON.stringify(hexGmailThreadIdList)}).getPromise().then(function(sendLaterListResult){self._handleSendLatersFromServer(sendLaterListResult,hexGmailThreadIdList)})},_handleSendLatersFromServer:function(sendLaterListResult,hexGmailThreadIdList){if(!sendLaterListResult||sendLaterListResult.error){return}for(var ii=0;ii<sendLaterListResult.length;ii++){var sendLater=BB.Models.SendLater.create(sendLaterListResult[ii]);BB.Data.getAllSendLaters().add(sendLater)}},_updateThreadStorerBumpLaterFor:function(hexGmailThreadId,bumpLaterArray){if(bumpLaterArray&&!_.isArray(bumpLaterArray)){bumpLaterArray=[bumpLaterArray]}var currentBumpLaterCollection=ThreadStorer.getBumpLaterCollection(hexGmailThreadId);if(!currentBumpLaterCollection||currentBumpLaterCollection.length===0){if(!bumpLaterArray||bumpLaterArray.length===0){return}currentBumpLaterCollection=BB.Models.BumpLater.createCollection()}if(!bumpLaterArray){bumpLaterArray=[]}Streak.Operations.CollectionOperationManager.Singleton.updateCollectionWithResponse(currentBumpLaterCollection,bumpLaterArray);ThreadStorer.setBumpLaterCollection(hexGmailThreadId,currentBumpLaterCollection)},_updateLastThreadInfoTimestampFor:function(hexGmailThreadId){ThreadStorer.setLastThreadInfoTimestamp(hexGmailThreadId,Date.create())}});Library.set("BentoBox.Services.Threads.ThreadInfoOperationManager",new ThreadInfoOperationManager);Streak.DependencyManager.addFunction({functionKey:"threadInfoOperationManagerInitialized",functionReference:BB.Services.Threads.ThreadInfoOperationManager.gmailLoaded,functionContext:BB.Services.Threads.ThreadInfoOperationManager,dependentFunctionKeys:["threadMetaDataCreatorInitialized","userLoggedIn","bentoBox.triggerFirstGmailViewChange","threadsInitialized"]})})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,BB=Streak.BentoBox,APIRequester=Streak.APIRequester;var CONSTANTS={MAX_BACKOFF:10*60*1e3,SETUP_MAX_BACKOFF:10*60*1e3};BB.Realtime={active:true,initialized:false,connectDelay:4e3,setupDelay:4e3,handlers:{},connectTimeout:null,setupTimeout:null,heartbeatArrived:false,heartbeatTimer:null,heartbeatData:null,currentConnectionTime:null,tokenRefreshTimer:null,init:function(cb){var self=this;if(!this.initialized){this.setupObservers();this.setupChannelFramework();this.initialized=true;BB.bind("reup",function(){self.connectChannel()})}if(cb){cb()}},setupObservers:function(){var self=this;this.handlers.open=function(message){self.connectDelay=4e3;self.setupHeartbeat();realtimeConnectionEstablished()};this.handlers.error=function(message){console.error("realtimedata:",message)};this.handlers.close=function(message){self.setupBackoff()};this.handlers.message=function(message){var json=JSON.parse(message.data);console.log("realtime message: ",json);if(json.hash){self.handleHeartbeat(json.hash);return}switch(json.REALTIME_EVENT){case"DESKTOP_NOTIFICATION":handleDesktopNotification(json);return;break;case"BATCH_UPDATE":handleBatchUpdate(json);break}switch(json.entityType){case"Box":handleCase(json);break;case"Pipeline":handleWorkflow(json);break;case"Reminder":handleReminder(json);break;case"Comment":handleComment(json);break;case"GmailThread":handleGmailThread(json);break;case"GmailThreadIdentifier":handleGmailThreadIdentifier(json);break;case"Snippet":handleSnippet(json);break;case"User":handleUser(json);break;case"UserUISettings":handleUserSettings(json);break;default:BB.logError("Realtime Error - entityType "+json.entityType+" is not supported yet.");break}};Messenger.observe("channelConnectMessage",function(message){if(self.handlers[message.op]){self.handlers[message.op](message.data)}});Messenger.observe("channelConnectResetTeardown",function(message){});Messenger.observe("channelConnectResetReup",function(message){self.setupChannelFramework()})},setupBackoff:function(){var self=this;this.setupDelay=Math.min(this.setupDelay*2,CONSTANTS.SETUP_MAX_BACKOFF);clearTimeout(this.setupTimeout);this.setupTimeout=setTimeout(function(){if(BB.isTornDown()){self.setupBackoff();return}self.connectChannel()},this.setupDelay)},setupChannelFramework:function(){var self=this;Messenger.sendMessage("channelSetup",{src:(Streak.devRealtimeServer||Streak.server)+"/_ah/channel/jsapi",isDevServer:_.isReal(Streak.devRealtimeServer)},"channelSetupReturn",function(){self.connectChannel()})},getToken:function(){var self=this;return APIRequester.put("realtime/token").getPromise().then(function(res){self.setupTokenExpiration();return res.message})},setupTokenExpiration:function(){if(this.tokenRefreshTimer){this.tokenRefreshTimer.stop();this.tokenRefreshTimer.start();return}this.tokenRefreshTimer=_.repeatEvery(_.bind(this.backoff,this),179*60*1e3+59*1e3+999,true)},connectChannel:function(){var self=this;this.getToken().then(this._doConnectChannel.bind(this)).catch(function(err){if(!err||!err.xhr||err.xhr.status!==401){BB.logError("couldn't get token",err);self.backoff()}})},_doConnectChannel:function(token){if(!token){throw new Error("Missing token")}Messenger.sendMessage("channelConnect",{token:token,server:Streak.server})},backoff:function(){var self=this;self.connectDelay=Math.min(self.connectDelay*2,CONSTANTS.MAX_BACKOFF);clearTimeout(this.connectTimeout);this.connectTimeout=setTimeout(function(){if(BB.isTornDown()){self.backoff();return}self.setupChannelFramework()},self.connectDelay)},setupHeartbeat:function(){var self=this;if(!this.heartbeatTimer){this.heartbeatTimer=_.repeatEvery(function(){self.heartbeatData=Math.random()+"."+Date.now();self.heartbeatArrived=false;Streak.APIRequester.post("realtime/heartbeat",null,{hash:self.heartbeatData},{responseType:"text"}).getPromise().then(function(){setTimeout(function(){if(!self.heartbeatArrived){self.logBadConnection();self.setupChannelFramework()}},120*1e3)})},30*60*1e3,true)}else{this.heartbeatTimer.stop();this.heartbeatTimer.start()}this.currentConnectionTime=Date.create()},handleHeartbeat:function(data){if(data===this.heartbeatData){this.heartbeatArrived=true}},logBadConnection:function(){BB.Modules.PerformanceModule.recordStat("realtimeConnectionLength",Date.create().minutesSince(this.currentConnectionTime))}};var handleCase=function(json){var box;switch(json.REALTIME_EVENT){case"CREATE":box=BB.Data.getBox(json.key);if(!box){BB.Data.addNewBox(json.key)}break;case"DELETE":box=BB.Data.getBox(json.key);if(box){var key=box.get("pipelineKey");box.postNotification("delete")}break;case"UPDATE":box=BB.Data.getBox(json.key);if(box){box.refresh()}else{BB.Data.addNewBox(json.key)}break}};var handleWorkflow=function(json){var pipe;switch(json.REALTIME_EVENT){case"NEW_ACL":case"CREATE":case"REMOVE_ACL":BB.Data.getAllPipelines().refresh();break;case"DELETE":BB.Data.removePipeline(json.key);break;case"COLLABORATORS_MAY_HAVE_CHANGED":case"UPDATE":pipe=BB.Data.getPipeline(json.key);if(pipe){pipe.refresh()}else{BB.Data.addNewPipeline(json.key)}break;case"UPDATE_CASCADE":pipe=BB.Data.getPipeline(json.key);if(pipe){BB.Data.getPipelineBoxes(json.key).refresh()}else{BB.Data.addNewPipeline(json.key)}break;case"CALCULATION_COMPLETE":pipe=BB.Data.getPipeline(json.key);if(!pipe){return}BB.Data.getPipelineBoxes(json.key).refresh(function(){pipe.postNotification("calculationComplete")});break}};var handleComment=function(json){var box=BB.Data.getBox(json.caseKey);if(box){box.postNotification("newComment")}};var handleReminder=function(json){var box=BB.Data.getBox(json.caseKey);if(box){}};var handleGmailThread=function(json){var box=BB.Data.getBox(json.caseKey);if(box){BB.Data.getGmailThreadCollectionForBox(box.key()).refresh()}};var handleGmailThreadIdentifier=function(json){if(json.gmailThreadId){BB.Services.Threads.ThreadInfoOperationManager.refreshHexGmailThreadId(json.gmailThreadId)}};var handleSnippet=function(json){switch(json.REALTIME_EVENT){case"CREATE":case"DELETE":BB.Data.getAllSnippets().refresh();break;case"UPDATE":var snippet=BB.Data.getSnippet(json.key);if(snippet){snippet.refresh()}else{BB.Data.getAllSnippets().refresh()}break}};var handleUser=function(json){var user=BB.getUser();if(user){user.refresh()}};var handleUserSettings=function(json){BB.UserSettings.refresh()};var requestPending=false;var notificationQueue=[];var blockNotificationTimeout=false;var blockTimeout=null;var blockNotifications=false;var realtimeConnectionEstablished=function(){clearTimeout(blockNotificationTimeout);blockNotificationTimeout=setTimeout(function(){blockNotifications=false},5*1e3);blockNotifications=true};var handleDesktopNotification=function(json){if(!window.Notification){return}if(blockNotifications){handleBlockedNotification(json);return}if(BB.LocalSettings.get("notifications/desktop/deniedPermission")){return}var permissionStatus=window.Notification.permission;if(permissionStatus==="granted"){showDesktopNotification(json)}else if(permissionStatus==="default"){notificationQueue.push(json);if(!requestPending){requestPending=true;BB.Widgets.Modal.create({title:BB.Locale.getString("notification_permission_title"),inner:BB.Locale.getString("notification_permission_message"),showCancel:false,confirmText:BB.Locale.getString("ok"),confirmFunc:function(){window.Notification.requestPermission(handleDesktopNotificationPermissionChange)},cancelFunc:function(){BB.LocalSettings.set("notifications/desktop/deniedPermission",true)}}).show()}}};var missedNotifications=[];var missedNotificationTimeout=null;var handleBlockedNotification=function(notification){if(BB.getUser().getDomain().toLowerCase()!=="streak.com"){return}console.log("missed notification",notification);missedNotifications.push(notification);clearTimeout(missedNotificationTimeout);missedNotificationTimeout=setTimeout(function(){var notification=new window.Notification("Missed Notifications",{body:"You missed "+missedNotifications.length+" notifications"});missedNotifications.length=0},5e3)};var handleDesktopNotificationPermissionChange=function(){var permissionStatus=window.Notification.permission;switch(permissionStatus){case"granted":for(var ii=0;ii<notificationQueue.length;ii++){showDesktopNotification(notificationQueue[ii])}break;case"denied":notificationQueue.length=[];break}};var showDesktopNotification=function(json){var notification=new window.Notification(json.title,{body:json.message,icon:json.photoUrl});notification.onclick=function(){BB.Tracker.trackStreakActive({eventName:"desktopNotificationClicked",entityType:json.entityType});if(_.isReal(json.entityType)){switch(json.entityType){case"Case":var box=BB.Data.getBox(json.key);if(box){BB.UI.setURL(box.link())}break;case"Workflow":var pipeline=BB.Data.getPipeline(json.key);if(pipeline){BB.UI.setURL(pipeline.link())}break;case"GmailThread":BB.Data.getGmailThread(json.key,function(thread){if(!thread){return}if(thread.get("isRequestingUserOwner")){BB.UI.goToThread(thread.key())}else if(thread.get("doesRequestingUserHaveThread")){BB.UI.goToThread(thread.get("requestingUserThreadGmailId"))}else{var url=BB.UI.linkify(thread);BB.UI.setURL(url)}});break;case"EmailThread":if(json.key){BB.UI.goToThread(json.key)}break;default:}}};notification.onshow=function(){setTimeout(notification.close.bind(notification),7e3)}};function handleBatchUpdate(json){BB.Models.BoxOperationManager.getBoxesInBatch(json.keys,json.pipelineKey)}Streak.DependencyManager.addFunction({functionKey:"realtimeInitialized",functionToCall:BB.Realtime.init,functionContext:BB.Realtime,dependentFunctionKeys:["userLoggedIn"]})})(Streak);Streak.initializeData=function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;BB.Data={};_.extend(BB.Data,{pipelines:{list:BB.Models.Pipeline.createCollection()},initPipelinesList:function(){var self=this;self.pipelines.list.watch("add",function(notification){var pipeline=notification.model;if(pipeline.key()){self.pipelines.list.sort(function(a,b){return(a.displayName()>b.displayName())-(a.displayName()<b.displayName())})}},this);self.pipelines.list.watch("remove",function(notification){var pipeline=notification.model;delete self.boxes.grouped[pipeline.key()];BB.trigger("change")},this);Streak.DependencyManager.notifyFunctionFinished("data.pipelines.collectionCreated")},setupPipelineBoxCollection:function(key){var self=this;var boxCollection=BB.Models.Box.createCollection(key);boxCollection.watch("add",function(notification){self.boxes.list.add(notification.model)},this);boxCollection.watch("remove",function(notification){self.removeBox(notification.model)},this);this.boxes.grouped[key]=boxCollection;return boxCollection},resetPipeline:function(pipeline){delete self.boxes.grouped[pipeline.key()]},createSimilarPipeline:function(fromPipeline){var i;var pipelineObject={name:fromPipeline.displayNameText()+"*"};var fieldNames=[];var fieldTypes=[];var stageNames=fromPipeline.getStageNamesText();for(i=0;i<fromPipeline.getFields().length;i++){fieldNames.push(fromPipeline.getFields()[i].displayNameText());fieldTypes.push(fromPipeline.getFields()[i].get("type"))}var newPipeline=BB.Models.Pipeline.create(pipelineObject);newPipeline.set("stageNames",stageNames);newPipeline.set("fieldNames",fieldNames);newPipeline.set("fieldTypes",fieldTypes);var self=this;newPipeline.save(function(){for(var i=0;i<fromPipeline.getSystemColumns().length;i++){newPipeline.addSystemColumn(fromPipeline.getSystemColumns()[i],null,null,true)}BB.Models.BoxField.copyFieldOptions(fromPipeline,newPipeline);BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.copyColumnOrder(fromPipeline,newPipeline);newPipeline.save(function(){BB.Data.getAllPipelines().add(newPipeline);BB.UI.setURL(newPipeline.link())})})},createPipelineFromTemplate:function(templatePipeline,cb){templatePipeline.name=templatePipeline.name||templatePipeline.friendlyName;var stageNames=[];var fieldNames=[];var fieldTypes=[];if(templatePipeline.stageOrder&&templatePipeline.stageOrder.length>0){for(var ii=0;ii<templatePipeline.stageOrder.length;ii++){var stageObject=templatePipeline.stages[templatePipeline.stageOrder[ii]];stageNames.push(stageObject.name)}}for(ii=0;ii<templatePipeline.fields.length;ii++){var field=templatePipeline.fields[ii];fieldNames.push(field.name);fieldTypes.push(field.type)}var pipeline=BB.Models.Pipeline.create({name:templatePipeline.name,stageNames:stageNames,fieldNames:fieldNames,fieldTypes:fieldTypes});var operationProgressId=pipeline.save(function(){for(var i=0;i<templatePipeline.systemProperties.length;i++){pipeline.addSystemColumn({property:templatePipeline.systemProperties[i]},null,null,true)}pipeline.save(function(){if(cb){cb(pipeline)}})});BB.Data.getAllPipelines().add(pipeline);return operationProgressId},getPipeline:function(key){return this.pipelines.list.getByKey(key)},getAllPipelines:function(){return this.pipelines.list},addNewPipeline:function(key){var self=this;APIRequester.get("pipelines/"+key).getPromise().then(function(res){var pipeline=BB.Models.Pipeline.create(res);self.pipelines.list.add(pipeline)})},removePipeline:function(key){if(this.getPipeline(key)){this.getPipeline(key).postNotification("delete");return true}return false},hasSharedPipelines:function(){var pips=BB.Data.getAllPipelines();if(!pips){return false}for(var i=0;i<pips.length;i++){if(pips[i].get("shareState")!=="PRIVATE"){return true}}return false},numSharedPipelines:function(){var pips=BB.Data.getAllPipelines();var count=0;if(!pips){return 0}for(var i=0;i<pips.length;i++){if(pips[i].get("shareState")!=="PRIVATE"){return count++}}return count},numBoxesCreatedByCurrentUser:function(){return Streak._.filter(Streak.BentoBox.Data.getAllBoxes(),function(box){return box.get("creatorKey")===Streak.BentoBox.getUser().key()}).length},numBoxesCreatedByCurrentUserThatContainAThread:function(){return Streak._.filter(Streak.BentoBox.Data.getAllBoxes(),function(box){return box.get("creatorKey")===Streak.BentoBox.getUser().key()&&box.get("gmailThreadCount")>0}).length}});_.extend(BB.Data,{boxes:{list:BB.Models.Box.createCollection(),grouped:{},byHex:{},hexList:{}},addBox:function(rawBox){if(this.getBox(rawBox.boxKey)){}else{if(rawBox.pipelineKey){var collection=this.getPipelineBoxes(rawBox.pipelineKey);if(collection){var box=BB.Models.Box.create(rawBox);collection.add(box)}}}},addNewBox:function(key,cb){var self=this;APIRequester.get("boxes/"+key).getPromise().then(function(res){self.addBox(res)})},getBox:function(key){return this.getAllBoxes().getByKey(key)},initAllBoxes:function(){var pipelines=this.getAllPipelines();for(var ii=0;ii<pipelines.length;ii++){var boxes=this.getPipelineBoxes(pipelines[ii].key());for(var jj=0;jj<boxes.length;jj++){this.boxes.list.add(boxes[jj])}}},getAllBoxes:function(){return this.boxes.list},getCreatedBoxes:function(){return _.filter(this.boxes.list,function(box){return box.get("creatorKey")===BB.getUser().key()})},getPipelineBoxes:function(key){var boxes=this.boxes.grouped[key];if(!boxes){this.setupPipelineBoxCollection(key)}return this.boxes.grouped[key]},removeBox:function(box){var self=this;
if(self.boxes.grouped[box.get("pipelineKey")]&&self.boxes.grouped[box.get("pipelineKey")].indexOf(box)>=0){self.boxes.grouped[box.get("pipelineKey")].remove(box)}var list=self.boxes.hexList[box.key()];if(list&&list.length>0){_.each(list,function(hexId){delete self.boxes.byHex[hexId]});delete self.boxes.hexList[box.key()]}self.boxes.list.remove(box)},createBox:function(name,pipelineKey){var box=BB.Models.Box.create({name:name,pipelineKey:pipelineKey,stageKey:this.getPipeline(pipelineKey).getStages()[0].key()});this.getPipelineBoxes(pipelineKey).add(box);return box.save()}});_.extend(BB.Data,{reminders:{grouped:{}},getReminderCollection:function(boxKey){if(!this.reminders.grouped[boxKey]){this.reminders.grouped[boxKey]=BB.Models.Reminder.createCollection(boxKey)}return this.reminders.grouped[boxKey]}});_.extend(BB.Data,{emailFilters:{grouped:{}},getEmailFilterCollection:function(boxKey){if(!this.emailFilters.grouped[boxKey]){this.emailFilters.grouped[boxKey]=BB.Models.EmailFilter.createCollection(boxKey)}return this.emailFilters.grouped[boxKey]}});_.extend(BB.Data,{emailFilterBlacklist:null,getEmailFilterBlacklistCollection:function(){if(!_.isReal(this.emailFilterBlacklist)){this.emailFilterBlacklist=BB.Models.EmailFilterBlacklist.createCollection()}return this.emailFilterBlacklist}});_.extend(BB.Data,{PlanCollection:{all:null,byUser:{},forCurrentUser:null},getPlanCollection:function(){if(!_.isReal(this.PlanCollection.all)){this.PlanCollection.all=BB.Models.Plan.createCollection()}return this.PlanCollection.all},getParticipatingPlans:function(options){options=options||{};if(options.userKey){if(!_.isReal(this.PlanCollection.forCurrentUser)){this.PlanCollection.forCurrentUser=BB.Models.Plan.getParticipatingPlans()}return this.PlanCollection.forCurrentUser}else{if(!_.isReal(this.PlanCollection.byUser[options.userKey])){this.PlanCollection.byUser[options.userKey]=BB.Models.Plan.getParticipatingPlans({userKey:options.userKey})}return this.PlanCollection.byUser[options.userKey]}}});_.extend(BB.Data,{PlanInstanceCollection:{byBillingAdmin:{},whereCurrentUserIsBillingAdmin:null},getBillingPlanInstances:function(options){options=options||{};if(options.userKey){if(!_.isReal(this.PlanInstanceCollection.whereCurrentUserIsBillingAdmin)){this.PlanInstanceCollection.whereCurrentUserIsBillingAdmin=BB.Models.PlanInstance.getBillingPlanInstances()}return this.PlanInstanceCollection.whereCurrentUserIsBillingAdmin}else{if(!_.isReal(this.PlanInstanceCollection.byBillingAdmin[options.userKey])){this.PlanInstanceCollection.byBillingAdmin[options.userKey]=BB.Models.PlanInstance.getBillingPlanInstances({userKey:options.userKey})}return this.PlanInstanceCollection.byBillingAdmin[options.userKey]}}});_.extend(BB.Data,{Files:{grouped:{}},getFileGroup:function(key){if(!this.Files.grouped[key]){this.Files.grouped[key]=BB.Models.File.createCollection(key)}return this.Files.grouped[key]}});_.extend(BB.Data,{gmailThreads:{list:BB.Models.GmailThread.createCollection(),grouped:{}},initGmailThreads:function(){var self=this;self.gmailThreads.list.watch("add",function(notification){var gThread=notification.model;if(gThread.get("boxKey")){self.getGmailThreadCollectionForBox(gThread.get("boxKey")).add(gThread)}},this)},getAllGmailThreads:function(){return this.gmailThreads.list},createGmailThreadGroup:function(key){this.gmailThreads.grouped[key]=BB.Models.GmailThread.createCollection(key)},getGmailThreadCollectionForBox:function(key){if(!this.gmailThreads.grouped[key]){this.gmailThreads.grouped[key]=BB.Models.GmailThread.createCollection(key)}return this.gmailThreads.grouped[key]},getGmailThreads:function(key,cb,isImmediate){var self=this;if(isImmediate){return this.gmailThreads.grouped[key]}if(!this.gmailThreads.grouped[key]){this.createGmailThreadGroup(key)}this.gmailThreads.grouped[key].refresh(function(){cb(self.gmailThreads.grouped[key])})},getGmailThread:function(key,cb,isImmediate){var self=this;var gThread=self.gmailThreads.list.getByKey(key);if(gThread||isImmediate){if(isImmediate){return gThread}else{cb(gThread)}}else{APIRequester.get("threads/"+key).getPromise().then(function(res){var gmailThread=BB.Models.GmailThread.create(res);self.gmailThreads.list.add(gmailThread);cb(gmailThread)})}}});_.extend(BB.Data,{sendLaters:{list:BB.Models.SendLater.createCollection()},getSendLater:function(key){return this.sendLaters.keyed[key]},newSendLater:function(obj){var sendLater=BB.Models.SendLater.create(obj||{});this.sendLaters.list.add(sendLater);return sendLater},getAllSendLaters:function(){return this.sendLaters.list}});_.extend(BB.Data,{snippets:{list:BB.Models.Snippet.createCollection(),grouped:{}},initSnippetsList:function(){var self=this;var defP="snippets_personal";this.snippets.list.watch("add",function(notification){var snippet=notification.model;var pipelineKey=snippet.get("pipelineKey");if(!pipelineKey){pipelineKey=defP}if(!self.snippets.grouped[pipelineKey]){self.snippets.grouped[pipelineKey]=[]}self.snippets.grouped[pipelineKey].push(snippet)},this);this.snippets.list.watch("remove",function(notification){var snippet=notification.model;var pipelineKey=snippet.get("pipelineKey");if(!pipelineKey)pipelineKey=defP;self.snippets.grouped[pipelineKey].removeVal(snippet)},this)},getAllSnippets:function(){return this.snippets.list},getSnippet:function(key){return this.snippets.list.getByKey(key)},getSnippetsByPipeline:function(key){return this.snippets.grouped[key]||[]},newSnippet:function(obj,cb){var self=this;var snippet=BB.Models.Snippet.create(obj);self.snippets.list.add(snippet);snippet.save(function(){if(cb){cb()}});return snippet}});_.extend(BB.Data,{bumpLaters:{list:BB.Models.BumpLater.createCollection()},getBumpLater:function(key){return this.bumpLaters.list.getByKey(key)},getAllBumpLaters:function(){return this.bumpLaters.list}})};Streak.initializeData(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var DataInitializer=Streak.Class.subclass({className:"DataInitializer",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setupInitializationProcess:function(){this._initializePipelineData();this._initializeSendLaterData();this._initializeSnippetData();this._initializeGmailThreadsData();this._initializeStreakSettingsData();this._initializeOauth2ScopesData()},_initializePipelineData:function(){BB.Data.initPipelinesList();BB.Data.pipelines.list.refresh(this._initializePipelineBoxes.bind(this))},_initializePipelineBoxes:function(){var boxCollections=[];var pipelines=BB.Data.getAllPipelines();if(pipelines.length===0){DependencyManager.notifyFunctionFinished("data.pipelines.initialized");DependencyManager.notifyFunctionFinished("data.boxes.initialized");return}for(var ii=0;ii<pipelines.length;ii++){var boxCollection=BB.Data.setupPipelineBoxCollection(pipelines[ii].key());boxCollections.push(boxCollection)}var progressId=Streak.Collection.refreshAll(boxCollections);NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:progressId,operationIsComplete:true},functionToCall:this._initializeAllBoxes,observer:this,unsubscribeImmediately:true});DependencyManager.notifyFunctionFinished("data.pipelines.initialized")},_initializeAllBoxes:function(){BB.Data.initAllBoxes();DependencyManager.notifyFunctionFinished("data.boxes.initialized")},_initializeSendLaterData:function(){var progressId=BB.Data.sendLaters.list.refresh();var dependencyKey="data.sendLaters.initialized";this._addDataNotificationWatcher(progressId,dependencyKey)},_initializeSnippetData:function(){BB.Data.initSnippetsList();var progressId=BB.Data.snippets.list.refresh();var dependencyKey="data.snippets.initialized";this._addDataNotificationWatcher(progressId,dependencyKey)},_initializeGmailThreadsData:function(){BB.Data.initGmailThreads();DependencyManager.notifyFunctionFinished("data.gmailThreads.initialized")},_initializeStreakSettingsData:function(){var operation=new Streak.Operations.AjaxRequestOperation({method:"GET",url:"users/me/settings"});var progressId=Streak.Operations.OperationQueue.Singleton.addOperation(operation);NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operation:operation,operationIsComplete:true},functionToCall:function(){BB.Data.streakSettings=BB.Models.StreakSettings.create(operation.getResponse());DependencyManager.notifyFunctionFinished("data.streakSettings.initialized")},observer:this,unsubscribeImmediately:true})},_initializeOauth2ScopesData:function(){var operation=new Streak.Operations.AjaxRequestOperation({method:"GET",url:"users/me/oauth2scopes"});var progressId=Streak.Operations.OperationQueue.Singleton.addOperation(operation);NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operation:operation,operationIsComplete:true},functionToCall:function(){BB.getUser().set("oauth2Scopes",operation.getResponse()||[]);DependencyManager.notifyFunctionFinished("data.oauth2Scopes.initialized")},observer:this,unsubscribeImmediately:true})},_addDataNotificationWatcher:function(progressId,dependencyKey){NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:progressId,operationIsComplete:true},functionToCall:function(notificationParameters){if(notificationParameters.operationProgressStats.isFinished){DependencyManager.notifyFunctionFinished(dependencyKey)}},observer:this,unsubscribeImmediately:true})}});var dataInitializer=new DataInitializer;Library.set("BentoBox.DataInitializer",dataInitializer);Streak.DependencyManager.addFunction({functionKey:"dataInitialized",functionReference:dataInitializer.setupInitializationProcess,functionContext:dataInitializer,dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ThreadStorerValueManager=Streak.Class.subclass({className:"ThreadStorerValueManager",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._setupGmailThreadManagement();this._setupSendLaterManagement();this._setupBumpLaterManagement()},_setupGmailThreadManagement:function(){BB.Data.getAllGmailThreads().watch("add",this._handleGmailThreadAdded,this);BB.Data.getAllGmailThreads().watch("remove",this._handleGmailThreadRemoved,this)},_handleGmailThreadAdded:function(notification){var hexGmailThreadId=notification.model.get("requestingUserThreadGmailId");if(!hexGmailThreadId){hexGmailThreadId=notification.model.get("hexGmailThreadId")||notification.model.get("threadGmailId")}BB.Services.Threads.ThreadStorer.setGmailThread(hexGmailThreadId,notification.model);BB.Services.Threads.ThreadStorer.setBoxKey(hexGmailThreadId,notification.model.get("boxKey"))},_handleGmailThreadRemoved:function(notification){var hexGmailThreadId=notification.model.get("hexGmailThreadId")||notification.model.get("threadGmailId");BB.Services.Threads.ThreadStorer.removeGmailThread(hexGmailThreadId);BB.Services.Threads.ThreadStorer.removeBoxKey(hexGmailThreadId)},_setupSendLaterManagement:function(){var sendLaterCollection=BB.Data.getAllSendLaters();sendLaterCollection.watch("add",this._handleSendLaterAdded,this);sendLaterCollection.watch("remove",this._handleSendLaterRemoved,this);NotificationCenter.subscribe({eventName:"set",filterParameters:{collectionId:sendLaterCollection.getId(),property:"gmailDraftId"},observer:this,functionToCall:this._handleGmailDraftIdSet})},_handleSendLaterAdded:function(notification){var hexGmailThreadId=notification.model.get("gmailDraftId");BB.Services.Threads.ThreadStorer.setSendLater(hexGmailThreadId,notification.model)},_handleSendLaterRemoved:function(notification){var hexGmailThreadId=notification.model.get("gmailDraftId");BB.Services.Threads.ThreadStorer.removeSendLater(hexGmailThreadId)},_handleGmailDraftIdSet:function(notification){var previousDraftId=notification.previousValue;var currentDraftId=notification.newValue;BB.Services.Threads.ThreadStorer.removeSendLater(previousDraftId);BB.Services.Threads.ThreadStorer.setSendLater(currentDraftId,notification.model)},_setupBumpLaterManagement:function(){var bumpLaterCollection=BB.Data.getAllBumpLaters();bumpLaterCollection.watch("add",this._handleBumpLaterAdded,this);bumpLaterCollection.watch("remove",_.delayed(this._handleBumpLaterRemoved,5),this)},_handleBumpLaterAdded:function(notification){var hexGmailThreadId=notification.model.get("gmailThreadId");var bumpLater=notification.model;var bumpLaterCollection=BB.Services.Threads.ThreadStorer.getBumpLaterCollection(hexGmailThreadId);if(!bumpLaterCollection){bumpLaterCollection=BB.Models.BumpLater.createCollection()}bumpLaterCollection.add(bumpLater);BB.Services.Threads.ThreadStorer.setBumpLaterCollection(hexGmailThreadId,bumpLaterCollection)},_handleBumpLaterRemoved:function(notification){if(!notification.model){return}var hexGmailThreadId=notification.model.get("gmailThreadId");var bumpLaterCollection=BB.Services.Threads.ThreadStorer.getBumpLaterCollection(hexGmailThreadId);if(bumpLaterCollection){bumpLaterCollection.remove(notification.model)}BB.Services.Threads.ThreadStorer.setBumpLaterCollection(hexGmailThreadId,bumpLaterCollection)}});Library.set("BentoBox.Services.Threads.ThreadStorerValueManager",new ThreadStorerValueManager)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailAddressExtractor=function(){};_.extend(EmailAddressExtractor.prototype,{extractEmailAddressesFromCSVRows:function(rows){var map={};var emails=[];var tempEmails=null;for(var ii=0;ii<rows.length;ii++){tempEmails=this._extractEmailsFromRow(rows[ii]);this._updateMapWithEmails(map,tempEmails,rows[ii]);_.mutate("union",emails,tempEmails)}return{emailAddresses:emails,emailAddressToRowListMap:map}},_extractEmailsFromRow:function(row){var combined=[];for(var field in row){combined.push(row[field])}return combined.join(" ").toLowerCase().replace(/\r|\t|\n/gim," ").match(/(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/g)},extractEmailAddressesFromBoxes:function(extractionSettings,boxes){var map={};var emails=[];var tempEmails=null;for(var ii=0;ii<boxes.length;ii++){tempEmails=this._extractEmailsFromBox(extractionSettings,boxes[ii]);this._updateMapWithEmails(map,tempEmails,boxes[ii]);_.mutate("union",emails,tempEmails)}return{emailAddresses:emails,emailAddressToBoxListMap:map}},_extractEmailsFromBox:function(extractionSettings,box){var emails=[];var tempEmails=null;if(extractionSettings.extractEmailsFrom.threads){var emailAddresses=box.get("emailAddresses");_.mutate("union",emails,_.map(emailAddresses,function(email){if(email){return email.toLowerCase()}}))}if(extractionSettings.extractEmailsFrom.assignedTo){tempEmails=this._extractEmailPropertyFromPeopleField(box.get("assignedToSharingEntries"));_.mutate("union",emails,tempEmails)}if(extractionSettings.extractEmailsFrom.columns){tempEmails=this._extractEmailsFromColumns(box);_.mutate("union",emails,tempEmails)}_.mutate("compact",emails);var myEmail=BB.getUser().get("email").toLowerCase();var domain=BB.getUser().getDomain().toLowerCase();return _.filter(emails,function(email){if(extractionSettings.ignoreEmails.myself){if(email.toLowerCase()===myEmail){return false}}if(extractionSettings.ignoreEmails.org){if(email.split("@")[1].toLowerCase()===domain){return false}}return true})},_extractEmailPropertyFromPeopleField:function(contacts){if(!contacts){return[]}return _.chain(contacts).pluck("email").compact().map(function(email){return email.toLowerCase()}).value()},_extractEmailsFromPeopleField:function(contacts){if(!contacts){return[]}return _.chain(contacts).map(function(contact){return[(contact.email||"").toLowerCase(),(contact.displayName||"").toLowerCase()]}).flatten().compact().value()},_extractEmailsFromColumns:function(box){var values=[];values.push(box.get("notes"));values.push(box.get("name"));var fieldValueMap=this._getBoxFieldValueMap(box);var fields=box.getPipeline().getFields();for(var ii=0;ii<fields.length;ii++){var value=fieldValueMap[fields[ii].key()];if(fields[ii].get("type")==="PERSON"){_.mutate("union",values,this._extractEmailsFromPeopleField(value))}else if(fields[ii].get("type")==="TEXT_INPUT"){values.push(value)}}return values.join(" ").toLowerCase().match(/(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/g)},_updateMapWithEmails:function(map,emails,row){if(!emails){return}for(var ii=0;ii<emails.length;ii++){if(!map[emails[ii]]){map[emails[ii]]=[]}map[emails[ii]].push(row)}},_getBoxFieldValueMap:function(box){var valueMap={};var fields=box.getPipeline().getFields();for(var ii=0;ii<fields.length;ii++){valueMap[fields[ii].key()]=box.getFieldValue(fields[ii].key())}return valueMap}});Streak.DependencyManager.addFunction({functionKey:"emailAddressExtractorInitialized",functionToCall:function(callback){BB.Services.EmailAddressExtractor=new EmailAddressExtractor;if(callback){callback()}}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RAPPORTIVE_EXTENSION_ID="hihakjfhbmlmjdnnhegiciffjplmdhin";var RapportiveStatusController=Streak.Class.subclass({className:"RapportiveStatusController",superclass:Streak.Object,_memberVariables:[{name:"_isEnabled",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);Messenger.sendMessage("extensionListRequest",null,"extensionListResponse",this._checkExtensions.bind(this))},_checkExtensions:function(appsAndExtensions){this._isEnabled=_.filter(appsAndExtensions,function(appOrExtension){return!appOrExtension.isApp&&appOrExtension.mayDisable&&appOrExtension.enabled&&appOrExtension.id===RAPPORTIVE_EXTENSION_ID}).length>0},isEnabled:function(){return this._isEnabled},getSidebar:function(){return Gmail.getCurrentMain().find("#rapportive-sidebar")}});Streak.DependencyManager.addFunction({functionKey:"RapportiveStatusControllerInitialized",functionReference:function(){Library.set("BentoBox.Services.RapportiveStatusController",new RapportiveStatusController)}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TEMPLATE_REGEX=/\{\{((box|email|field)_(.+?))\}\}/gi;var TemplateProcessor=function(){this._lookupTables={}};_.extend(TemplateProcessor.prototype,{getCompiledString:function(box,contact,fieldObject,template,usePlainText){if(!template){return""}var lookupTable;if(box){lookupTable=this._getLookupTable(box.getPipeline())}var self=this;return template.replace(TEMPLATE_REGEX,function(){return self._generateReplacementString(arguments,box,contact,fieldObject,lookupTable,usePlainText)})},_generateReplacementString:function(matchArguments,box,contact,fieldObject,lookupTable,usePlainText){var fullMatchedTag=matchArguments[0];var innerMatchedTag=matchArguments[1];var fieldType=matchArguments[2];var fieldKey=matchArguments[3];if(fieldType==="email"){if(!contact){return""}if(usePlainText){return contact[fieldKey]||""}else{return $.getTextHTML(contact[fieldKey])||""}}if(!lookupTable){if(fieldObject&&fieldObject[fieldKey]){if(usePlainText){return fieldObject[fieldKey]}else{return $.getTextHTML(fieldObject[fieldKey])}}return""}if(!lookupTable[fieldKey]){return fullMatchedTag}var column=lookupTable[fieldKey];if(!column){return fullMatchedTag}if(column.columnType==="field"){if(usePlainText){return box.getFieldDisplayTextValue(column.value.fieldKey)}else{return _.escape(box.getFieldDisplayTextValue(column.value.fieldKey))}}else{if(usePlainText){return box.getDisplayTextValue(column.value.property)}else{return _.escape(box.getDisplayTextValue(column.value.property))}}},findReferencedFields:function(pipeline){var matches=[];var referencedFields={email:{},box:{},other:{}};var templates=_.toArray(arguments).slice(1);for(var ii=0;ii<templates.length;ii++){if(templates[ii]){_.mutate("union",matches,templates[ii].match(TEMPLATE_REGEX))}}for(var ii=0;ii<matches.length;ii++){if(matches[ii]){this._updateReferencedFields(referencedFields,matches[ii],this._getLookupTable(pipeline))}}return referencedFields},_getLookupTable:function(pipeline){if(!pipeline){return}if(this._lookupTables[pipeline.key()]){return this._lookupTables[pipeline.key()]}this._buildReverseColumnLookup(pipeline);return this._lookupTables[pipeline.key()]},_buildReverseColumnLookup:function(pipeline){var reverseColumnLookupTable={};var columns=BB.UI.getPipelineColumnList(pipeline,pipeline.getAllSystemColumns());var self=this;_.each(columns,function(column){reverseColumnLookupTable[column.name]=column});this._lookupTables[pipeline.key()]=reverseColumnLookupTable},_updateReferencedFields:function(referencedFields,matchedTag,lookupTable){var fieldTemplate=matchedTag.replace("{{","").replace("}}","");var fieldParts=fieldTemplate.split("_");if(fieldParts.length<2){return}var fieldType=fieldParts[0];var fieldKey=_.rest(fieldParts).join("_");if(fieldType==="field"){if(lookupTable&&lookupTable[fieldKey]){referencedFields["box"][fieldKey]=lookupTable[fieldKey];return}referencedFields["other"][fieldKey]=true}else{referencedFields[fieldType][fieldKey]=true}}});BB.Services.TemplateProcessor=new TemplateProcessor})(Streak);(function(Streak){var $=Streak.jQuery,BB=Streak.BentoBox,HTML=Streak.HTML;BB.FirstRun={init:function(cb){this.elements={};this.elements.stage2modal=HTML.get("stage2_modal",true);this.elements.stage3modal=HTML.get("stage2_modal",true);if(cb){cb()}},getStage:function(){return 3},setupModals:function(){this.s2modal=BB.Widgets.Modal.create({title:BB.Locale.getString("stage2_modal_title"),confirmText:"OK",showCancel:false,inner:this.elements.stage2modal,confirmFunc:$.noop,maxHeight:"600px",onClose:function(){BB.Modules.BoxesButton.el.css({zIndex:"1"})},trackingContext:{widgetContext:"firstRun"}});this.s3modal=BB.Widgets.Modal.create({title:BB.Locale.getString("stage3_modal_title"),confirmText:"OK",showCancel:false,inner:this.elements.stage3modal,maxHeight:"600px",trackingContext:{widgetContext:"firstRun"}})},showStageModal:function(stage){var self=this;self["showStage"+(stage?stage:self.getStage())+"Modal"]()},showStage1Modal:function(){BB.Modules.LeftLink.newPipelineShow()},showStage2Modal:function(){if(!this.s2Modal){this.setupModals()}BB.Modules.BoxesButton.el.css({zIndex:"2000"});this.s2modal.show()},showStage3Modal:function(){if(!this.s2Modal){this.setupModals()}this.s3modal.show()}};Streak.DependencyManager.addFunction({functionKey:"firstRunInitialized",functionToCall:BB.FirstRun.init,functionContext:BB.FirstRun,dependentFunctionKeys:["HTML"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Gmail=Streak.Gmail,BB=Streak.BentoBox;BB.Keyboard={activeTimer:null,clearTime:1e3,activeChords:[],multiChords:[],chordHelp:[],initialized:false,helpRendered:false,helpEl:null,init:function(cb){var self=this;if(!this.initialized){Gmail.elements.body.bind("keydown",function(e){self.handleChordKeyEntry(e)});self.bindChord("shift+/",function(){setTimeout(function(){self.renderHelpItems()},20)});this.initialized=true}if(cb){cb()}},bindChord:function(chord,cb,description){var chordParts=chord.split(",");if(chordParts.length===1){var jfunc=jwerty.event(chord,cb);Gmail.elements.body.bind("keydown",function(e){if(!$(e.target).is("input,textarea,[contentEditable=true],.input")){jfunc(e)}})}else{this.multiChords.push({chord:chordParts,cb:cb})}if(description){this.addChordHelpItem(chord,description)}},addChordHelpItem:function(chord,description){this.chordHelp.push({chord:chord,description:description})},handleChordKeyEntry:function(e){var i,activeChord,currentKey,chord;var self=this;if(!$(e.target).is("input,textarea,[contentEditable=true],.input")){if(self.activeTimer){clearTimeout(self.activeTimer)}self.activeTimer=setTimeout(function(){self.activeChords=[]},self.clearTime);var active=[];var callbacks=[];for(i=0;i<self.multiChords.length;i++){activeChord=self.multiChords[i];currentKey=activeChord.chord[0];if(jwerty.is(currentKey,e)){chord=activeChord.chord.slice();chord.shift();active.push({chord:chord,cb:activeChord.cb})}}for(i=0;i<self.activeChords.length;i++){activeChord=self.activeChords[i];currentKey=activeChord.chord.shift();if(jwerty.is(currentKey,e)){if(activeChord.chord.length===0){callbacks.push(activeChord.cb)}else{active.push(activeChord)}}}if(callbacks.length>0){self.activeChord=[];clearTimeout(self.activeTimer);for(i=0;i<callbacks.length;i++){callbacks[i](e)}}else{self.activeChords=active}if(callbacks.length>0){e.preventDefault();e.stopPropagation()}}},bindChordToElement:function(el,chord,cb,noBubble,noDefault,notOnInput,keyEvent,useCapture){this.bindChordToEl({el:el,chord:chord,cb:cb,noBubble:noBubble,noDefault:noDefault,notOnInput:notOnInput,keyEvent:keyEvent,useCapture:useCapture})},bindChordToEl:function(options){var el=options.el,chord=options.chord,cb=options.cb,noBubble=options.noBubble,noDefault=options.noDefault,notOnInput=options.notOnInput,keyEvent=options.keyEvent,useCapture=options.useCapture,delegate=options.delegate;if(!keyEvent){keyEvent="keydown"}var jfunc=jwerty.event(chord,cb);var eventCallbackFunction;var bind=function(event){if(useCapture){eventCallbackFunction=checkAndRun;el.each(function(){this.addEventListener(keyEvent,eventCallbackFunction,true)})}else{eventCallbackFunction=function(e){if(!(notOnInput&&$(e.target).is("input,textarea,[contentEditable=true],.input"))){checkAndRun(e)}};el.on(event,options.delegate,null,eventCallbackFunction)}};var checkAndRun=function(e){jfunc(e);if(noBubble&&jwerty.is(chord,e)){if(useCapture){e.stopPropagation();e.stopImmediatePropagation()}else{e.stopPropagation()}}if(noDefault&&jwerty.is(chord,e)){e.preventDefault()}};if(_.isArray(keyEvent)){_.each(keyEvent,function(event){bind(event)})}else{bind(keyEvent)}return function(){if(useCapture){el.each(function(){this.removeEventListener(keyEvent,eventCallbackFunction,true)})}else{el.off(event,options.delegate,eventCallbackFunction)}}},renderHelpItems:function(){var self=this;var row=$(document.createElement("tr"));row[0].innerHTML='<th class="Do"></th><th class="Do"><span class="boxIcon"></span>Streak</th>';this.getKeyboardHelpFirstColumn().append(row);_.each(self.chordHelp,function(help){self.renderChordHelpItem(help.chord,help.description)})},renderSeparator:function(separator){switch(separator){case",":return'</span> <span class="wb">then</span> ';break;case"+":return'</span> <span class="wb">+</span> ';break;default:return""}},renderChordHelpItem:function(chord,description){var parts=chord.split(/[,+]/g);var separators=chord.match(/[,+]/g);var row=$(document.createElement("tr"));var html='<td class="wg Dn">';for(var i=0;i<parts.length-1;i++){html+='<span class="wh">'+parts[i].escapeHTML()+this.renderSeparator(separators[i])}html+='<span class="wh">'+_.last(parts)+"</span>"+" :</td>";html+='<td class="we Dn">'+description+"<td>";row[0].innerHTML=html;this.getKeyboardHelpFirstColumn().append(row)},getKeyboardHelpFirstColumn:function(){return Gmail.getKeyboardHelp().find(".cf.wd .cf").filter(":first").find("tbody")}};Streak.DependencyManager.addFunction({functionKey:"keyboardInitialized",functionToCall:BB.Keyboard.init,functionContext:BB.Keyboard,dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Model=Streak.Model,BB=Streak.BentoBox;LocalSettings=Streak.Eventer.create({settings:null,initialized:false,init:function(){if(!this.initialized){this.email=Streak.userEmail;this.settings=Streak.ObjectPath.create(localStorage["streakLocalSettings"+this.email]);this.initialized=true}},get:function(path){return this.settings.get(path)},setSetting:function(path,value){this.set(path,value)},getItem:function(path){return this.get(path)},setItem:function(path,value){this.set(path,value)},set:function(path,value){this.settings.set(path,value);this.save();this.trigger("localSettingsSet")},save:function(){localStorage["streakLocalSettings"+this.email]=this.settings.toString()}});BB.LocalSettings=LocalSettings;Streak.DependencyManager.addFunction({functionKey:"localSettingsInitialized",functionReference:BB.LocalSettings.init,functionContext:BB.LocalSettings})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,BB=Streak.BentoBox;var performance=window.performance;if(!performance){performance={}}if(!performance.webkitNow){performance.webkitNow=function(){return(new Date).getTime()}}BB.Logger={isDebug:false,init:function(cb){cb()},log:function(){if(this.isDebug){console.log.apply(console,_.toArray(arguments))}},debug:function(){if(this.isDebug){console.debug.apply(console,_.toArray(arguments))}},colorLog:function(){var args=_.toArray(arguments);var newArgs=["%cdebug: ","color:"+_.last(args)+";"].concat(_.initial(args));this.debug.apply(this,newArgs)},output:function(activity,diff){console.debug(activity+": "+diff+" ticks")},start:function(activity){return new function(){var sd=performance.webkitNow();var d=performance.webkitNow();var end=function(anActivity){if(BB.Logger.isDebug){BB.Logger.output(anActivity||activity,performance.webkitNow()-sd)}};var mark=function(anActivity){if(BB.Logger.isDebug){BB.Logger.output(anActivity||activity,performance.webkitNow()-d);d=performance.webkitNow()}};return{end:end,mark:mark}}}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var self=MailHelper={initialized:false,_queuedEmailLists:[],_currentEmailList:null,_nextSendTimeout:null,_hideComposeWindowRule:null,_sendingEmails:false,_sentCounter:0,sendEmail:function(emailPackage){if(self._currentEmailList&&self._currentEmailList.sendingEmail){self._currentEmailList.sendingEmail(emailPackage)}Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){setTimeout(function(){try{self._handleComposeWindow(composeWindowViewController,emailPackage)}catch(err){BB.logError("mail merge sending error",err);if(_.isFunction(self._currentEmailList.finishedSendingCallback)){self._currentEmailList.finishedSendingCallback()}BB.ButterBarManager.showError("Error with mail merge: "+self._sentCounter+" email(s) sent",{time:5e3})}},2e3)})},sendMultipleEmails:function(emailListPackage){if(self._currentEmailList){self._queuedEmailLists.push(emailListPackage)}else{self._currentEmailList=emailListPackage;self._prepareSendingEmails();self._processEmailList()}},cancelSending:function(){if(self._currentEmailList){clearTimeout(self._nextSendTimeout);self._processNextEmailList()}},isMailHelperSendingEmails:function(){return this._sendingEmails},_processEmailList:function(){if(_.isFunction(self._currentEmailList.startSendingCallback)){self._currentEmailList.startSendingCallback(self._currentEmailList.emailPackages.length)}this._sentCounter=0;self._runThroughEmailList()},_runThroughEmailList:function(){if(_.isArray(self._currentEmailList.emailPackages)&&self._currentEmailList.emailPackages.length>0){var delay=self._currentEmailList.delayBetweenEmails||2e3;var emailPackage=self._currentEmailList.emailPackages.shift();
emailPackage.emailSentCallback=function(){if(!self._currentEmailList){self._processNextEmailList();return}if(_.isFunction(self._currentEmailList.emailSentCallback)){self._currentEmailList.emailSentCallback(self._sentCounter,self._currentEmailList.emailPackages.length)}self._nextSendTimeout=setTimeout(self._runThroughEmailList,delay);self._sentCounter+=1};self.sendEmail(emailPackage)}else{if(_.isFunction(self._currentEmailList.finishedSendingCallback)){self._currentEmailList.finishedSendingCallback()}self._processNextEmailList()}},_processNextEmailList:function(){if(self._queuedEmailLists.length>0){self._prepareSendingEmails();self._currentEmailList=self._queuedEmailLists.shift();self._processEmailList()}else{self._currentEmailList=null;self._finishSendinEmails()}},_prepareSendingEmails:function(){this._sendingEmails=true;this._hideComposeWindows()},_finishSendinEmails:function(){this._sendingEmails=false;this._unhideComposeWindows()},_hideComposeWindows:function(){self._hideComposeWindowRule=Streak.CSSStyleManipulator.addRule(".Wk [role=dialog], .dw [role=dialog] {visibility: hidden;}",0)},_unhideComposeWindows:function(){Streak.document.styleSheets[0].removeRule(self._hideComposeWindowsRule)},_init:function(cb){if(!self.initialized){Gmail.bind("newSentEmail",self._handleNewSentMail)}self.initialized=true;if(cb){cb()}},_handleComposeWindow:function(composeWindowViewController,emailPackage){composeWindowViewController.notify("mailHelperSendingEmails");if(emailPackage.toAddresses){composeWindowViewController.setToAddresses(emailPackage.toAddresses)}if(emailPackage.subject){composeWindowViewController.setSubject(emailPackage.subject)}if(emailPackage.body){composeWindowViewController.setEmailBody(emailPackage.body)}if(emailPackage.attachments){}Streak.NotificationCenter.subscribe({eventName:"rfcMessageIdForSentEmailFound",filterParameters:{composeid:composeWindowViewController.getComposeid()},observer:this,functionToCall:function(notification){var threadMetaData=notification.threadMetaData;if(emailPackage.boxKey){self._addEmailToBox(emailPackage,threadMetaData)}if(emailPackage.isPixelTracked){self._addEmailToTrackedThread(emailPackage,threadMetaData)}if(_.isFunction(emailPackage.emailSentCallback)){emailPackage.emailSentCallback()}},unsubscribeImmediately:true});setTimeout(function(){composeWindowViewController.send()},250)},_addEmailToBox:function(emailPackage,threadMetaData){var box=BB.Data.getBox(emailPackage.boxKey);if(_.isReal(box)){BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.createGmailThread(box.key(),threadMetaData,"mailMerge");BB.Tracker.track("addThreadsToBox",{threadCount:1,context:"mailMerge"})}},_addEmailToTrackedThread:function(emailPackage,threadMetaData){var guid=emailPackage.pixelTrackingGuid;var threadId=threadMetaData.hexGmailThreadId;var subject=threadMetaData.subject;var emails=emailPackage.toAddresses;var names=[""];var rfcMessageId=threadMetaData.rfcMessageId;var trackedLink=new Streak.BentoBox.Models.TrackedLink({guid:guid,hexGmailThreadId:threadId,snippetKeyList:emailPackage.snippetKeyList,mailMergeId:emailPackage.mailMergeId,subject:subject,names:names,emails:emails,isMailMerge:true,rfcMessageId:rfcMessageId});trackedLink.save();BB.Tracker.trackStreakActive("pixel_track_email_sent",{source:"mailMerge"});BB.Modules.PixelTrackerConversationImageFixer.sendIgnoreImageRequest(guid)}};Streak.DependencyManager.addFunction({functionKey:"mailHelperInitialized",functionToCall:MailHelper._init,functionContext:MailHelper,dependentFunctionKeys:["gmailLoaded"]});BB.MailHelper=MailHelper})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MoveBoxHelper=Streak.Class.subclass({className:"MoveBoxHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},moveBox:function(box,newPipeline){this.moveBoxes(box.getPipeline(),newPipeline,[box])},moveBoxes:function(pipeline,newPipeline,boxes){var self=this;var moveMessage=this._getMoveBoxesMessage(pipeline,newPipeline,boxes);BB.Tracker.track("moveBoxesAsk");BB.Widgets.Modal.confirm(BB.Locale.getString("move_boxes_confirm_title",{pluralize:[boxes]}),moveMessage,function(){self._startMovingBoxes(pipeline,newPipeline,boxes)},function(){BB.Tracker.track("moveBoxesCancelled")})},_getMoveBoxesMessage:function(pipeline,newPipeline,boxes){var oldFields=pipeline.getFields();var newFields=newPipeline.getFields();var missedFields=[];for(var i=0;i<oldFields.length;i++){var field=oldFields[i];var any=_.any(newFields,function(newField){return newField.get("name")===field.get("name")&&newField.get("type")===field.get("type")});if(!any){missedFields.push(field.get("name"))}}var message=null;if(missedFields.length>0){message=BB.Locale.getString("move_boxes_confirm_message_fields",{oldPipeline:pipeline.displayName(),newPipeline:newPipeline.displayName(),number:boxes.length,fields:missedFields.join(", "),pluralize:[boxes.length,missedFields.length]})}else{message=BB.Locale.getString("move_boxes_confirm_message",{number:boxes.length,oldPipeline:pipeline.displayName(),newPipeline:newPipeline.displayName(),pluralize:[boxes.length]})}return message},_startMovingBoxes:function(pipeline,newPipeline,boxes){BB.Tracker.track("moveBoxesAccepted");BB.Models.BoxOperationManager.moveBoxes(boxes,pipeline.key(),newPipeline.key())}});Library.set("BentoBox.MoveBoxHelper",new MoveBoxHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var self=PixelTrackingHTMLGenerator={getGuid:function(){return Streak.guid()},injectTrackingHTML:function(composeWindowViewController){var guid=this.getGuid();var trackingHTML=this.getTrackingHTML(guid);composeWindowViewController.removeSelectorFromBody("[hspace=streak-pt-mark]");composeWindowViewController.addHTMLToBodyBeforeQuotedText(trackingHTML);return guid},getTrackingHTML:function(guid){if(!guid){guid=this.getGuid()}return['<div hspace="streak-pt-mark" style="max-height:1px;">',this._getImage(guid),this._getSearchMarker(),"</div>"].join("")},getEncodedEmailAddress:function(){return encodeURIComponent("a"+btoa(BB.getUser().getEmail()))},_getImage:function(guid){return'<img style="width:0px; max-height:0px;" src=\''+Streak.server+"/t?sender="+this.getEncodedEmailAddress()+"&type=zerocontent&guid="+guid+"'/>"},_getSearchMarker:function(){var self=this;return'<font color="#ffffff" size="1">'+BB.Modules.PixelTrackerSearch.CONSTANTS.TRACKED_KEY+"</font>"}};BB.PixelTrackingHTMLGenerator=PixelTrackingHTMLGenerator})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={GA_USER_KEY_HANDLE:"dimension1",GA_ORG_KEY_HANDLE:"dimension2",GA_EXPERIMENTS_HANDLE:"dimension3",GA_STREAK_CLIENT_VERSION_HANDLE:"dimension4",GA_IS_GOOGLE_APPS_HANDLE:"dimension5",GA_INSTALLED_EXTENSIONS_HANDLE:"dimension6",GA_ACCOUNT_AGE_HANDLE:"metric1",GA_NUM_SHARED_PIPELINES_HANDLE:"metric2"};BB.Tracker={isDebug:false,init:function(cb){var self=this;self.initializeAnalytics();cb()},trackAssociateBoxWithThread:function(args){var props={};var numThreads=BB.Data.numBoxesCreatedByCurrentUserThatContainAThread();props.eventName="associateBoxWithThread";props.numThreads=numThreads;props.boxType=args.boxType;props.source=args.source;props.value=numThreads;BB.Tracker.trackStreakActive(props);if(numThreads===0){BB.Tracker.trackStreakActive({eventName:"boxedFirstThread"})}},initializeStreakpanel:function(){streakpanel.init("streaktoken2")},initializeAnalytics:function(){var self=this;self.initializeStreakpanel()},currentTrackableViewName:function(){var vToUse=BB.UI.getCurrentView();return vToUse},addTracking:function(el,elEvent,props){el.bind(elEvent,function(){BB.Tracker.trackStreakActive(props)})},addPassiveTracking:function(el,elEvent,props){el.bind(elEvent,function(){BB.Tracker.trackStreakPassive(props)})},addDelegatedTracking:function(el,selector,elEvent,props){el.on(elEvent,selector,function(){BB.Tracker.trackStreakActive(props)})},trackStreakActive:function(){var arr=_.compact(arguments);var props=_.extend.apply(null,arr);if(props!==null){props.category="StreakActive";BB.Tracker.recordEvent(props)}},trackStreakPassive:function(props){if(props!==null){props.category="StreakPassive";BB.Tracker.recordEvent(props)}},track:function(eventName){var eventProperties={eventName:eventName};this.trackStreakActive.apply(this,[eventProperties].concat(_.toArray(arguments).slice(1)))},trackStreakPerformance:function(props){if(!props){props={}}props.category="ExtensionPerformance";BB.Tracker.recordEvent(props)},trackGmail:function(props){if(props!==null){props.category="Gmail";props.context=BB.Tracker.currentTrackableViewName();BB.Tracker.recordEvent(props)}},getExperimentsString:function(){var experimentsFlat=",";var experiments=Streak.BentoBox.getUser().get("experiments");Streak._.each(experiments,function(experimentObj,experimentName){if(Streak._.isReal(experimentObj)&&experimentObj.inExperiment===true){experimentsFlat+=experimentName+","}});if(experimentsFlat===","){experimentsFlat=""}return experimentsFlat},getStreakpanelSuperProperties:function(){var superProps={};if(_.isReal(Streak.BentoBox.getUser())){superProps["experiments"]=BB.Tracker.getExperimentsString()}if(BB.user){superProps["userKey"]=BB.getUser().key();superProps["orgKey"]=BB.getUser().get("orgKey")}superProps["email"]=Streak.userEmail;superProps["clientVersion"]=Streak.clientVersion;superProps["extensionVersion"]=Streak.extVersion;superProps["language"]=BB.Locale.getCurrent();superProps["previewPane"]=Gmail.getPreviewPaneSettings();superProps["isConversationViewDisabled"]=Gmail.isConversationViewDisabled();return superProps},sendStreakpanel:function(props){var superProps=BB.Tracker.getStreakpanelSuperProperties();var streakpanelProps=_.extend(_.clone(props),superProps);delete streakpanelProps.eventName;streakpanel.track(props.eventName,streakpanelProps)},recordEvent:function(props){try{if(this.isDebug){console.log("track event:",props)}BB.Tracker.sendStreakpanel(props)}catch(err){BB.Logger.log(err)}}};Streak.DependencyManager.addFunction({functionKey:"trackerInitialized",functionToCall:BB.Tracker.init,functionContext:BB.Tracker})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={LoggedInToCurrentAccountKey:"streak__loggedInToAccountEver "+Streak.userEmail.toLowerCase()};BB.TrackerListener={init:function(cb){var self=this;self.trackStreakLoadedLoggedOut();self.listenForGmailEvents();if(cb){cb()}},loggedInInit:function(callback){this.listenForNewPipeline();this.trackStreakLoadedLoggedIn();if(callback){callback()}},listenForNewPipeline:function(){BB.Data.getAllPipelines().watch("add",function(){var pipelineCount=BB.Data.getAllPipelines().length;BB.Tracker.trackStreakPassive({eventName:"pipelineCreated",numPipelines:pipelineCount});if(pipelineCount===1){BB.Tracker.trackStreakPassive({eventName:"firstPipelineCreated"})}},this)},listenForGmailEvents:function(){Gmail.observe("viewChanged",function(view){var eventName="viewChanged";var lastView=BB.UI.getPreviousView();if(Gmail.isGmailView()){BB.Tracker.trackGmail({eventName:eventName,lastView:lastView})}else{BB.Tracker.trackStreakPassive({eventName:eventName,lastView:lastView,context:BB.Tracker.currentTrackableViewName()})}})},trackStreakLoadedLoggedOut:function(){var loggedOutLabel="hasLoggedInToCurrentAccountBefore";if(!localStorage["streak__loggedInEver"]){loggedOutLabel="neverLoggedInToAnyAccountBefore"}else if(!localStorage[CONSTANTS.LoggedInToCurrentAccountKey]){loggedOutLabel="neverLoggedInToCurrentAccountBefore"}BB.Tracker.trackStreakPassive({eventName:"StreakLoadedLoggedOut",status:loggedOutLabel})},trackStreakLoadedLoggedIn:function(){var loggedInLabel="hasLoggedInToCurrentAccountBefore";if(!localStorage["streak__loggedInEver"]){localStorage["streak__loggedInEver"]=true;loggedInLabel="loggedInForFirstTime"}else if(!localStorage[CONSTANTS.LoggedInToCurrentAccountKey]){localStorage[CONSTANTS.LoggedInToCurrentAccountKey]=true;loggedInLabel="loggedInToCurrentAccountForFirstTime"}BB.Tracker.trackStreakPassive({eventName:"StreakLoadedLoggedIn",status:loggedInLabel});if(BB.Data.getAllPipelines().length===0){BB.Tracker.trackStreakPassive({eventName:"noPipelinesWhenStreakLoaded"})}if(BB.Data.numBoxesCreatedByCurrentUserThatContainAThread()===0){BB.Tracker.trackStreakPassive({eventName:"noBoxesCreatedByCurrentUserThatContainAThreadWhenStreakLoaded"})}}};Streak.DependencyManager.addFunction({functionKey:"trackerListenerInitialized",functionToCall:BB.TrackerListener.init,functionContext:BB.TrackerListener,dependentFunctionKeys:["gmailLoaded","trackerInitialized"]});Streak.DependencyManager.addFunction({functionKey:"trackerListenerLoggedInInit",functionToCall:BB.TrackerListener.loggedInInit,functionContext:BB.TrackerListener,dependentFunctionKeys:["userLoggedIn","trackerInitialized","data.pipelines.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={COLORS:["#FA573C","#FFAD46","#B3DC6C","#16A765","#9FC6E7","#4986E7","#7BD148","#F83A22","#AC725E","#92E1C0","#42D692","#D06B64","#FAD165","#FF7537","#9FE1E7"]};BB.UI={suppressSearch:false,originalHash:null,el:null,interval:false,initialized:false,viewHistory:[],fullViewHistory:[],init:function(cb){var self=this;if(!self.initialized){self.el=$(document.createElement("div"));self.el.addClass("BltHke nH oy8Mbf");self.el.attr("id","workflowArea");self.el.hide();Gmail.observe("viewChanged",function(view){self.setupViewCanvas()},null,1);if(!self.interval){self.interval=true;$(window).bind("resize.mainResize",function(){if(self.isBentoBoxView()){self.setHeight()}})}}self.initialized=true;if(cb){cb()}},teardown:function(){if(this.isBentoBoxView()){this.setURL(Gmail.Constants.Inbox);this.el.hide();this.el.siblings().show()}},destroy:function(){if(this.el){this.el.remove()}},setHeight:function(){var leftBarHeight=parseInt(Gmail.getLeftBar()[0].style.height,10);if(this.height!==leftBarHeight){this.height=leftBarHeight;this.el[0].style.height=this.height+33+"px"}},fixTopOffset:function(){var bodyContainer=this.el.parentsUntil("body").last();bodyContainer.offset({top:0})},setGmailView:function(){this.el.hide();this.el.siblings().show()},setupViewCanvas:function(){this.fullViewHistory.push(Gmail.hash.partsString);this.fullViewHistory=_.last(this.fullViewHistory,100);if(Gmail.isConversation()){this.viewHistory.push("conversation")}else{this.viewHistory.push(Gmail.view)}this.viewHistory=_.last(this.viewHistory,100);var isGoingBBToGmail=false;if(this.isBentoBoxView()){var mainContainer=Gmail.getCurrentMainContainer()[0];mainContainer.insertBefore(this.el[0],mainContainer.firstChild);this.el.siblings().fastHide();this.el.show();this.setHeight();this.fixTopOffset()}else{if(this.el.isVisible()){isGoingBBToGmail=true}this.el.hide();this.el.siblings().fastShow("");this.el.detach();if(Gmail.view===Gmail.Constants.Contact){var contactNotes=Gmail.$(".acn textarea.R5").filterOutInvisible();if(contactNotes&&contactNotes.length>0){var contactNotesContainer=contactNotes.closest(".nn");if(contactNotesContainer.length>0){var contactNotesContainerParent=contactNotesContainer.parent();contactNotesContainer.height(contactNotesContainerParent.height())}}}if(isGoingBBToGmail){var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",true,false,window,0);window.dispatchEvent(evt)}}this.suppressSearch=false},goBack:function(){var last=this.fullViewHistory.pop();last=this.fullViewHistory.pop();this.setURL(last)},isBoxView:function(){return Gmail.view==Gmail.Constants.Box},isPipelineView:function(){return Gmail.view==Gmail.Constants.Pipeline},isPipelineReportsView:function(){return Gmail.view==Gmail.Constants.PipelineReports},isDeepLinkLoadingView:function(){return Gmail.view==Gmail.Constants.DeepLinkLoading},isPaywallView:function(){return Gmail.view==Gmail.Constants.Paywall},isAccountView:function(){return Gmail.view==Gmail.Constants.PaidAccount},isBentoBoxView:function(view){if(typeof view==="undefined"){view=Gmail.view}return Gmail.Constants.BentoBoxViews.indexOf(view)>-1},getCanvas:function(){return this.el},goToThread:function(hexGmailThreadId){var url=Gmail.Constants.Inbox+"/"+hexGmailThreadId;var composeWindowViewControllers=Gmail.GmailComposeWindowMasterController.getComposeWindows();if(composeWindowViewControllers.length>0){var hasNew=false;var draftIds=[];for(var ii=0;ii<composeWindowViewControllers.length;ii++){var draftId=composeWindowViewControllers[ii].getDraftId();if(draftId){draftIds.push(draftId)}else{hasNew=true}}if(hasNew){draftIds.push("new")}url+="?compose="+draftIds.join(encodeURIComponent(","))}this.setURL(url)},linkify:function(type,key){if(type.link){return type.link()}else{if(type=="thread"||type=="GmailThread"){return Gmail.Constants.GmailThread+"/"+key}}},setURL:function(url,callback,replace){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){var vcBind=Gmail.observe("viewChanged",function(){Gmail.unobserve("viewChanged",vcBind);var startEvent=this.event;Gmail.bind("finishedExecuting_viewChanged",function(endEvent){if(endEvent!==startEvent){return false}if(callback){try{callback()}catch(err){BB.logError("error with setURL callback",err)}}try{self.fixTopOffset()}catch(err){BB.logError("error with setURL fixTopOffset",err)}resolve();return true})});if(replace){window.location.replace("#"+url)}else{window.location.hash="#"+url}})},appendURLQuery:function(part){var append=null;if(Gmail.hash.query===null){append="?"}else{append=encodeURIComponent(",")}location.hash=location.hash+append+part},getResourceURL:function(url){return Streak.server+(url.indexOf("/")===0?"":"/")+url+(url.indexOf("?")>-1?"&":"?")+"clientVersion="+encodeURIComponent(Streak.clientVersion)+"&email="+encodeURIComponent(Streak.ai||Streak.userEmail)},getPreviousView:function(){return _.chain(this.viewHistory).last(2).first(1).value()[0]},getCurrentView:function(){if(this.viewHistory.length>0){return _.last(this.viewHistory)}return null},dateNameConstants:["today","tomorrow","this sunday","this monday","this tuesday","this wednesday","this thursday","this friday","this saturday","this week","this month","this sunday","this monday","this tuesday","this wednesday","this thursday","this friday","this saturday","this week","this month"],getAssignedToSharingEntriesForPipelineBoxes:function(pipeline){var boxes=BB.Data.getPipelineBoxes(pipeline.key());return _(boxes).chain().filter(function(box){var people=box.getAssignedToSharingEntries();return people&&people.length>0}).map(function(box){return box.getAssignedToSharingEntries()}).flatten().uniq(function(contact){return contact.email}).map(function(contact){return{display:contact.fullName||contact.email,value:contact}}).value()},getFieldValues:function(pipeline,fieldKey){return BB.Models.BoxField.getExistingTextValuesInBoxes(pipeline,fieldKey)},processString:function(value,inLocale,inHTML){var locale=inLocale||BB.Locale;var html=inHTML||Streak.HTML;if(!_.isString(value)){return value}else if(_.isObject(value)){for(var key in value){value[key]=this.processString(value[key],locale,html)}return value}var processed=value;var tempProcessed=value;for(var i=0;i<100;i++){processed=tempProcessed.replace(/%\w+%/,function(match){return locale.getString(match.substring(1,match.length-1))}).replace(/\*\w+\*/,function(match){return html.get(match.substring(1,match.length-1))()});if(processed===tempProcessed){break}else{tempProcessed=processed}}return processed},getPipelineColumnList:function(pipeline,systemProperties,justFields){var columns=_.map(pipeline.getFields(),function(field){return{name:field.displayName(),columnType:"field",value:{fieldKey:field.key(),columnKey:"field|"+field.key()}}});if(!justFields){columns=columns.concat(_.map(systemProperties,function(systemColumn){return{name:systemColumn.title,columnType:"property",value:{property:systemColumn.property,columnKey:"property|"+(systemColumn.uniqueKey||systemColumn.property)}}}))}return columns.sortBy(function(column){return column.name})},getSortedVisiblePipelines:function(){var sortedPipelines=[];var sortedPipelineKeys=BB.UserSettings.get("leftLink/pipelineSort");if(sortedPipelineKeys){for(var ii=0;ii<sortedPipelineKeys.length;ii++){var pipeline=BB.Data.getPipeline(sortedPipelineKeys[ii]);if(pipeline&&!pipeline.isHidden()){sortedPipelines.push(pipeline)}}}_.chain(BB.Data.getAllPipelines()).filter(function(pipeline){return!pipeline.isHidden()}).filter(function(pipeline){if(sortedPipelineKeys){if(sortedPipelineKeys.indexOf(pipeline.key())>-1){return false}}return true}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){sortedPipelines.push(pipeline)});return sortedPipelines},getSortedPipelines:function(){var sortedPipelines=[];var sortedPipelineKeys=BB.UserSettings.get("leftLink/pipelineSort");if(sortedPipelineKeys){for(var ii=0;ii<sortedPipelineKeys.length;ii++){var pipeline=BB.Data.getPipeline(sortedPipelineKeys[ii]);if(pipeline&&!pipeline.isHidden()){sortedPipelines.push(pipeline)}}}_.chain(BB.Data.getAllPipelines()).filter(function(pipeline){return!pipeline.isHidden()}).filter(function(pipeline){if(sortedPipelineKeys){if(sortedPipelineKeys.indexOf(pipeline.key())>-1){return false}}return true}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){sortedPipelines.push(pipeline)});_.chain(BB.Data.getAllPipelines()).filter(function(pipeline){return pipeline.isHidden()}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){sortedPipelines.push(pipeline)});return sortedPipelines},getStageColors:function(pipeline){var settings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings.load(pipeline);if(_.isNotReal(settings.data["property|stageKey"])){settings.data["property|stageKey"]={}}var colorMap=settings.data["property|stageKey"];var stageKeys=_.pluck(pipeline.getStagesAsListText(),"value");var retVal={};for(var ii=0;ii<stageKeys.length;ii++){stageKey=stageKeys[ii];if(colorMap[stageKey]){retVal[stageKey]=colorMap[stageKey]}else{retVal[stageKey]={backgroundColor:this.getIndexColor(ii,colorMap),textColor:"white"}}}return retVal},getIndexColor:function(index,colorMap){var colors=_.pluck(_.values(colorMap),"backgroundColor");var maxColorLength=CONSTANTS.COLORS.length;var colorLength=colors.length;for(var ii=index;ii<100;ii++){var tempColor=CONSTANTS.COLORS[ii%CONSTANTS.COLORS.length];var cIndex=colors.indexOf(tempColor);if(cIndex===-1){return tempColor}if(Math.abs(index-cIndex)>10){return tempColor}}return CONSTANTS.COLORS[Number.random(0,CONSTANTS.COLORS.length-1)]},getBoxListDisplayHTML:function(box){var color=box.getPipeline().getColor();var pipelineSpan="";if(BB.Data.getAllPipelines().length>1){pipelineSpan='<span class="streak__boxListDisplay_pipeline" '+'style="background-color:'+color.backgroundColor+"; color: "+color.textColor+';">'+box.getPipeline().displayNameHTML()+"</span>"}return'<span class="streak__boxListDisplay">'+'<span class="streak__boxListDisplay_box">'+box.displayNameHTML()+"</span>"+pipelineSpan;"</span>"}};BB.UI.originalHash=location.hash;Streak.DependencyManager.addFunction({functionKey:"uiInitialized",functionToCall:BB.UI.init,functionContext:BB.UI,dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Model=Streak.Model,BB=Streak.BentoBox;var UserSettings=Streak.Eventer.create({userUISettings:null,settings:null,active:true,saveTimeout:null,init:function(callback){var self=this;this.userUISettings=BB.Models.UserUISettings.create({});this.userUISettings.refresh(function(){self.refreshSettings();if(callback){callback()}})},refresh:function(){this.userUISettings.refresh(this.refreshSettings.bind(this))},refreshSettings:function(){if(this.userUISettings.get("clientJSONUISettings")){try{this.settings=new Model(JSON.parse(this.userUISettings.get("clientJSONUISettings")))}catch(err){}}if(!this.settings){this.settings=new Model({})}this.trigger("refresh")},getSetting:function(path){var parts=path.split("/");var setting=this.settings.get(parts[0]);for(var i=1;i<parts.length;i++){if(setting){setting=setting[parts[i]]}}return setting},get:function(path){return this.getSetting(path)},setSetting:function(path,value){var parts=path.split("/");if(parts.length===1){this.settings.set(parts[0],value)}else{var osetting=this.settings.get(parts[0]);if(!osetting){osetting={}}var setting=osetting;for(var i=1;i<parts.length-1;i++){var newSetting=setting[parts[i]];if(!newSetting){newSetting={};setting[parts[i]]=newSetting}setting=newSetting}setting[_.last(parts)]=value;this.settings.set(parts[0],osetting)}Streak.NotificationCenter.postNotification({eventName:"userSettingSet",sender:this,path:path,value:value})},set:function(path,value){this.setSetting(path,value)},saveSettings:function(){if(this.active){var self=this;clearTimeout(this.saveTimeout);this.saveTimeout=setTimeout(function(){var settings=self.settings.getWrappedObject();var editOperations=self.settings.getEditOperations();if(editOperations){for(var ii=0;ii<editOperations.length;ii++){settings[editOperations[ii].property]=editOperations[ii].value}}self.userUISettings.set("clientJSONUISettings",JSON.stringify(settings));self.userUISettings.save(null,null,true)},500)}},save:function(shouldRefresh){this.saveSettings();if(shouldRefresh){this.trigger("refresh")}}});BB.UserSettings=UserSettings;Streak.DependencyManager.addFunction({functionKey:"userSettingsInitialized",functionToCall:BB.UserSettings.init,functionContext:BB.UserSettings,dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;BB.Workers={pool:null,size:3,initialized:false,init:function(cb){if(!this.initialized){this.initialized=true;this.pool=Streak.jobPool.create(this.size)}if(cb){cb()}},run:function(code,parameters,cb){this.pool.dispatch({callable:code,parameters:parameters,oncomplete:cb})},prepareObject:function(obj){return JSON.parse(JSON.stringify(obj))},terminate:function(){this.pool.terminate(true)}};BB.onLoad(function(cb){BB.Workers.init(cb)})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TourChapterViewController=Streak.Class.subclass({className:"TourChapterViewController",superclass:UI.ViewController,currentChapterViewController:null,_memberVariables:[{name:"_currentChapterDefinition",destroy:false},{name:"_tourHistory",destroy:false},{name:"_currentTourPageViewController",destroy:true},{name:"_defaultChapterClasses",destroy:true},{name:"_currentChapterClasses",destroy:false},{name:"_chapters",destroy:false},{name:"_tourWidgetFactory",destroy:true},{name:"_pagesViewed",destroy:true},{name:"_currentMark",destroy:false},{name:"_isDestroyed",destroy:false}],_initialize:function(){UI.ViewController.prototype._initialize.call(this);this._isDestroyed=false;this._tourHistory=[];this._defaultChapterClasses=[];this._currentChapterClasses=[];this._initializeDefaultChapterClasses()},run:function(chapterDefinition,chapters){if(TourChapterViewController.currentChapterViewController){TourChapterViewController.currentChapterViewController.destroy()}if(!chapterDefinition.pages||chapterDefinition.pages.length===0){return}BB.Tracker.track("helpTour started",{chapterName:chapterDefinition.name});TourChapterViewController.currentChapterViewController=this;this._chapters=chapters;this._currentChapterDefinition=chapterDefinition;this._pagesViewed=0;this._initializeTourWidgetFactory();this._fillInIncludes();this._startRunningTourChapter()},_initializeTourWidgetFactory:function(){this._tourWidgetFactory=Library.getInstance("BentoBox.Tour.TourWidgetFactory")},_initializeDefaultChapterClasses:function(){this._defaultChapterClasses.push(Library.getInstance("BentoBox.Tour.HelperClass.PipelineTourHelper"));this._defaultChapterClasses.push(Library.getInstance("BentoBox.Tour.HelperClass.BoxTourHelper"));this._defaultChapterClasses.push(Library.getInstance("BentoBox.Tour.HelperClass.ComposeTourHelper"));this._defaultChapterClasses.push(Library.getInstance("BentoBox.Tour.HelperClass.InboxTourHelper"));this._defaultChapterClasses.push(Library.getInstance("BentoBox.Tour.HelperClass.TourSelectorHelper"))},_fillInIncludes:function(){var pages=this._currentChapterDefinition.pages.slice();var newClassNames=(this._currentChapterDefinition.classNames||[]).slice();for(var jj=0;jj<1e4;jj++){var includeFound=false;var newPages=[];for(var ii=0;ii<pages.length;ii++){var page=pages[ii];if(page.include){var onEnterFunctionArray=[];if(page.onEnter){onEnterFunctionArray.push(page.onEnter)}else if(page.onEnterFunctionArray){onEnterFunctionArray=page.onEnterFunctionArray}includeFound=true;var chapterDefinition=this._getChapterDefinition(page.include);var chapterPages=chapterDefinition.pages;this._addOnEnterFunctionsToIncludeChapterPages(onEnterFunctionArray,chapterPages);newPages=newPages.concat(chapterPages);newClassNames=newClassNames.concat(chapterDefinition.classNames)}else{newPages.push(page)}}pages=newPages;if(!includeFound){break}}this._currentChapterDefinition.pages=pages;this._currentChapterDefinition.classNames=_.uniq(newClassNames)},_addOnEnterFunctionsToIncludeChapterPages:function(onEnterFunctionArray,chapterPages){for(ii=0;ii<chapterPages.length;ii++){var onEnters=_.clone(onEnterFunctionArray);var page=chapterPages[ii];if(page.onEnter){onEnters.push(page.onEnter)}else if(page.onEnterFunctionArray){onEnters=onEnters.concat(page.onEnterFunctionArray)}page.onEnter=null;page.onEnterFunctionArray=onEnters}},_startRunningTourChapter:function(){this._notifyTourStarting();this._resetTourState();this._initializeChapterClasses();this._loadNextChapterPage()},_notifyTourStarting:function(){NotificationCenter.postNotification({eventName:"tourStarting",sender:this})},_notifyTourFinished:function(){NotificationCenter.postNotification({eventName:"tourFinished",sender:this})},_resetTourState:function(){this._tourHistory.length=0;this._resetChapterClasses()},_initializeChapterClasses:function(){this._resetChapterClasses();var classNames=this._currentChapterDefinition.classNames;if(!classNames||classNames.length===0){return}for(var ii=0;ii<classNames.length;ii++){if(!classNames[ii]){continue}var classInstance=Library.getInstance("BentoBox.Tour.HelperClass."+classNames[ii]);this._currentChapterClasses.push(classInstance)}},_resetChapterClasses:function(){for(var ii=0;ii<this._currentChapterClasses.length;ii++){this._currentChapterClasses[ii].destroy()}this._currentChapterClasses.length=0},_loadNextChapterPage:function(){this._resetTourPageViewController();var nextEntry=this._getNextTourHistoryEntry();if(!nextEntry){this.finish();return}this._tourHistory.unshift(nextEntry);this._setupTourPageViewController(nextEntry.pageDefinition);if(this._isDestroyed){return}BB.Tracker.track("helpTour next page",{chapterName:this._currentChapterDefinition.name,pagesViewed:this._pagesViewed,chapterPageIndex:nextEntry.pageDefinition.pageIndex})},_resetTourPageViewController:function(){if(this._currentTourPageViewController){this._currentTourPageViewController.destroy();this._currentTourPageViewController=null}},_getNextTourHistoryEntry:function(){if(this._tourHistory.length===0){return{chapterDefinition:this._currentChapterDefinition,pageIndex:0,pageDefinition:this._currentChapterDefinition.pages[0]}}var nextPageIndex=this._tourHistory[0].pageIndex+1;if(this._currentChapterDefinition.pages.length<=nextPageIndex){return}return{chapterDefinition:this._currentChapterDefinition,pageIndex:nextPageIndex,pageDefinition:this._currentChapterDefinition.pages[nextPageIndex]}
},_setupTourPageViewController:function(pageDefinition){this._currentTourPageViewController=new BB.Tour.TourPageViewController;this._currentTourPageViewController.setDelegate(this);this._currentTourPageViewController.run(JSON.deepClone(pageDefinition),this._tourWidgetFactory);this._pagesViewed+=1},callFunction:function(functionName,functionArguments,basicTourCallbacks){var functionObject=null;var functionReference=null;if(this[functionName]){return this[functionName].apply(this,[functionArguments,basicTourCallbacks])}var functionClasses=this._currentChapterClasses.concat(this._defaultChapterClasses);for(var ii=0;ii<functionClasses.length;ii++){var chapterClassInstance=functionClasses[ii];if(chapterClassInstance&&chapterClassInstance[functionName]){return chapterClassInstance[functionName].apply(chapterClassInstance,[functionArguments,basicTourCallbacks])}}},next:function(){this._loadNextChapterPage()},previous:function(){this._resetTourPageViewController();var previousEntry=this._getPreviousTourEntry();if(!previousEntry){this.destroy();return}if(previousEntry.chapterDefinition.name!==this._currentChapterDefinition.name){this._currentChapterDefinition=previousEntry.chapterDefinition;this._initializeChapterClasses()}this._setupTourPageViewController(previousEntry.pageDefinition);BB.Tracker.track("helpTour previous page",{chapterName:this._currentChapterDefinition.name,pagesViewed:this._pagesViewed,chapterPageIndex:previousEntry.pageDefinition.pageIndex})},moveBackPages:function(numberOfPagesToMoveBack){this._resetTourPageViewController();var previousEntry;for(var ii=0;ii<numberOfPagesToMoveBack;ii++){previousEntry=this._getPreviousTourEntry();if(!previousEntry){this.destroy();return}}if(previousEntry.chapterDefinition.name!==this._currentChapterDefinition.name){this._currentChapterDefinition=previousEntry.chapterDefinition;this._initializeChapterClasses()}this._setupTourPageViewController(previousEntry.pageDefinition);BB.Tracker.track("helpTour move back pages",{chapterName:this._currentChapterDefinition.name,pagesViewed:this._pagesViewed,chapterPageIndex:previousEntry.pageDefinition.pageIndex})},_getPreviousTourEntry:function(){var previousEntry;for(var ii=0;ii<1e4;ii++){this._tourHistory.shift();if(this._tourHistory.length===0){previousEntry=null;break}previousEntry=this._tourHistory[0];if(!previousEntry.pageDefinition.noHistory){break}}return previousEntry},earlyExit:function(reason){BB.Tracker.track("helpTour early exit",{chapterName:this._currentChapterDefinition.name,pagesViewed:this._pagesViewed,chapterPageIndex:this._tourHistory[0].pageIndex,reason:reason});this.destroy()},finish:function(){BB.Tracker.track("helpTour finish",{chapterName:this._currentChapterDefinition.name,pagesViewed:this._pagesViewed,chapterPageIndex:this._tourHistory[0].pageIndex});this.destroy()},closeClicked:function(){NotificationCenter.postNotification({eventName:"tourHelpCloseClicked",sender:this})},changeChapter:function(chapterName,pageIndex){this._resetTourPageViewController();var chapterDefinition=this._getChapterDefinition(chapterName);this._currentChapterDefinition=chapterDefinition;this._initializeChapterClasses();if(!_.isNumber(pageIndex)){pageIndex=0}var historyEntry={chapterDefinition:this._currentChapterDefinition,pageIndex:pageIndex,pageDefinition:this._currentChapterDefinition.pages[pageIndex]};this._tourHistory.unshift(historyEntry);this._setupTourPageViewController(historyEntry.pageDefinition)},_getChapterDefinition:function(chapterName){var chapters=this._chapters;for(var ii=0;ii<chapters.length;ii++){var chapter=chapters[ii];if(chapter.name===chapterName){return JSON.deepClone(chapter)}}return null},delay:function(delayTime){return new Streak.Promise(function(resolve,reject){setTimeout(resolve,delayTime)})},destroy:function(){TourChapterViewController.currentChapterViewController=null;this._notifyTourFinished();UI.ViewController.prototype.destroy.call(this);this._isDestroyed=true}});TourChapterViewController.stopCurrentTour=function(){if(TourChapterViewController.currentChapterViewController){TourChapterViewController.currentChapterViewController.destroy()}};Library.set("BentoBox.Tour.TourChapterViewController",TourChapterViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TourPageViewController=Streak.Class.subclass({className:"TourPageViewController",superclass:UI.ViewController,_memberVariables:[{name:"_widgets",destroy:false},{name:"_pageDefinition",destroy:false},{name:"_tourWidgetFactory",destroy:false},{name:"_nextPageSelectorTimer",destroy:true},{name:"_isDestroyed",destroy:false}],_initialize:function(){UI.ViewController.prototype._initialize.call(this);this._widgets=[];this._isDestroyed=false},run:function(pageDefinition,tourWidgetFactory){this._pageDefinition=pageDefinition;this._tourWidgetFactory=tourWidgetFactory;this._loadOnEnter()},_loadOnEnter:function(){if(!this._pageDefinition.onEnter&&!this._pageDefinition.onEnterFunctionArray){this._waitForSelector();return}if(this._pageDefinition.onEnter){this._handleOnEnter();return}this._handleOnEnterFunctionArray()},_handleOnEnter:function(){var basicTourCallbacks=this._getBasicTourCallbacks();var convertedFunction=this._convertWidgetFunction(this._pageDefinition.onEnter);var promise=convertedFunction(basicTourCallbacks);if(this._isDestroyed){return}if(!promise){this._waitForSelector();return}promise.then(this._waitForSelector.bind(this))},_handleOnEnterFunctionArray:function(){if(this._isDestroyed){return}var self=this;var basicTourCallbacks=this._getBasicTourCallbacks();var promises=[];for(var ii=0;ii<this._pageDefinition.onEnterFunctionArray.length;ii++){var convertedFunction=this._convertWidgetFunction(this._pageDefinition.onEnterFunctionArray[ii]);var promise=convertedFunction(basicTourCallbacks);if(promise){promises.push(promise)}}if(promises.length===0){this._waitForSelector()}else{Streak.RSVP.Promise.all(promises).then(this._waitForSelector.bind(this)).catch(function(err){BB.logError("error in TourPageViewController._handleOnEnterFunctionArray",err)})}},_waitForSelector:function(){if(this._isDestroyed){return}if(!this._pageDefinition.waitForSelector){this._loadWidgets();return}var self=this;_.checkAndThenRun(function(){return self._isDestroyed||$(self._pageDefinition.waitForSelector).length>0},function(){if(self._isDestroyed){return}self._loadWidgets()},50)},_getBasicTourCallbacks:function(){var delegate=this._delegate;return{moveBackPages:function(numberOfPagesToMoveBack){delegate.callFunction("moveBackPages",numberOfPagesToMoveBack)},previous:function(){delegate.callFunction("previous")},next:function(){delegate.callFunction("next")},earlyExit:function(){delegate.callFunction("earlyExit")},finish:function(){delegate.callFunction("finish")}}},_loadWidgets:function(){var widgets=this._pageDefinition.widgets;if(widgets&&widgets.length>0){for(var ii=0;ii<widgets.length;ii++){this._loadWidget(widgets[ii])}}this._tourWidgetFactory.flush();if(!widgets){this._delegate.callFunction("next");return}this._startWaitingForNextPageSelector()},_loadWidget:function(widgetDefinition){if(widgetDefinition.type==="COMPOSITE"){var widgetTypes=widgetDefinition.widgetTypes;for(var ii=0;ii<widgetTypes.length;ii++){var widgetType=widgetTypes[ii];var newWidgetDefinition=JSON.deepClone(widgetDefinition);newWidgetDefinition.type=widgetType;this._loadWidget(newWidgetDefinition)}return}var processedDefinition=this._processWidgetDefinition(JSON.deepClone(widgetDefinition));var widget=this._tourWidgetFactory.get(processedDefinition);if(!widget){return}this._widgets.push(widget);if(widget.show){widget.show()}},_processWidgetDefinition:function(widgetDefinition){this._processStrings(widgetDefinition);this._processFunctions(widgetDefinition);var delegate=this._delegate;widgetDefinition.previousFunction=function(){delegate.callFunction("previous")};widgetDefinition.nextFunction=function(){delegate.callFunction("next")};widgetDefinition.earlyExitTourFunction=function(reason){delegate.callFunction("earlyExit",reason)};widgetDefinition.finishFunction=function(){delegate.callFunction("finish")};widgetDefinition.closeClicked=function(){delegate.callFunction("closeClicked")};return widgetDefinition},_processStrings:function(widgetDefinition){for(var key in widgetDefinition){var value=widgetDefinition[key];if(key==="textBody"){widgetDefinition.body=value}else if(key==="htmlBody"){widgetDefinition.body=HTML.getStringWithSelector(value)}if(_.isObject(value)){this._processStrings(value)}}},_processFunctions:function(widgetDefinition){if(!_.isObject(widgetDefinition)){return}for(var key in widgetDefinition){if(key.toLowerCase().indexOf("function")>-1){widgetDefinition[key]=this._convertWidgetFunction(widgetDefinition[key])}var value=widgetDefinition[key];if(_.isObject(value)){this._processFunctions(value)}else if(_.isArray(value)){for(var ii=0;ii<value.length;ii++){this._processFunctions(value[ii])}}}},_convertWidgetFunction:function(functionDefinition){var delegate=this._delegate;var functionName=null;var functionArguments=null;if(_.isString(functionDefinition)){functionName=functionDefinition}else if(_.isObject(functionDefinition)){functionName=functionDefinition.name;functionArguments=functionDefinition.arguments}return function(basicTourCallbacks){if(!functionArguments){functionArguments=basicTourCallbacks}return delegate.callFunction(functionName,functionArguments,basicTourCallbacks)}},_startWaitingForNextPageSelector:function(){if(!this._pageDefinition.goToNextPageWhenSelectorVisible&&!this._pageDefinition.goToNextPageWhenSelectorNotVisible){return}var self=this;this._nextPageSelectorTimer=_.checkAndThenRun(function(){if(self._isDestroyed){return true}if(self._pageDefinition.goToNextPageWhenSelectorVisible){return $(self._pageDefinition.goToNextPageWhenSelectorVisible).filter(":visible").length>0}if(self._pageDefinition.goToNextPageWhenSelectorNotVisible){return $(self._pageDefinition.goToNextPageWhenSelectorNotVisible).filter(":visible").length===0}},function(){if(self._isDestroyed){return}self._delegate.callFunction("next")},100)},destroy:function(){if(this._pageDefinition.onExit){var convertedFunction=this._convertWidgetFunction(this._pageDefinition.onExit);var callbacks=this._getBasicTourCallbacks();convertedFunction(callbacks)}for(var ii=0;ii<this._widgets.length;ii++){this._tourWidgetFactory.release(this._widgets[ii])}UI.ViewController.prototype.destroy.call(this);this._isDestroyed=true}});Library.set("BentoBox.Tour.TourPageViewController",TourPageViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TourWidgetFactory=Streak.Class.subclass({className:"TourWidgetFactory",superclass:Streak.Object,_memberVariables:[{name:"_widgetMap",destroy:false},{name:"_listOfAllReusableWidgets",destroy:true},{name:"_tourSelectorModifierHelper",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._widgetMap={};this._listOfAllReusableWidgets=[];this._tourSelectorModifierHelper=Library.getInstance("BentoBox.Tour.TourSelectorModifierHelper")},get:function(widgetDefinition){var type=widgetDefinition.type;var options=this._processWidgetDefinition(widgetDefinition);return this._getWidget(type,options)},release:function(widget){if(!widget.reuse){widget.destroy();return}if(!widget.getType){widget.destroy();return}var type=widget.getType();var widgetList=this._widgetMap[type];if(!widgetList){widgetList=[];this._widgetMap[type]=widgetList}widgetList.push(widget);this._listOfAllReusableWidgets.push(widget)},flush:function(){for(var ii=0;ii<this._listOfAllReusableWidgets.length;ii++){this._listOfAllReusableWidgets[ii].destroy()}this._listOfAllReusableWidgets.length=0},_processWidgetDefinition:function(widgetDefinition){var processFunc=this["_processWidgetDefinitionFor"+widgetDefinition.type.camelize()];if(!processFunc){return widgetDefinition}return processFunc.call(this,widgetDefinition)},_processWidgetDefinitionForModal:function(widgetDefinition){var options={};if(typeof widgetDefinition.leftButton!=="undefined"){if(widgetDefinition.leftButton){options.cancelFunc=widgetDefinition.leftButton.function;options.cancelText=widgetDefinition.leftButton.name;options.cancelButtonColor=widgetDefinition.leftButton.color}else{options.showCancel=false}}else{options.cancelFunc=widgetDefinition.previousFunction;options.cancelText="Previous"}if(typeof widgetDefinition.rightButton!=="undefined"){if(widgetDefinition.rightButton){options.confirmFunc=widgetDefinition.rightButton.function;options.confirmText=widgetDefinition.rightButton.name;options.doneButtonColor=widgetDefinition.rightButton.color}else{options.showCancel=false}}else{options.confirmFunc=widgetDefinition.nextFunction;options.confirmText="Next"}options.close=false;options.force=true;options.opacity=65;options.dontStack=true;options.escClose=false;options.inner=widgetDefinition.body;options.title=widgetDefinition.title;options.width=widgetDefinition.width;return options},_processWidgetDefinitionForHighlight:function(widgetDefinition){widgetDefinition.targetSelector=this._tourSelectorModifierHelper.getElement(widgetDefinition.targetSelector);return widgetDefinition},_processWidgetDefinitionForWaitForClick:function(widgetDefinition){widgetDefinition.rawTargetSelector=widgetDefinition.targetSelector;widgetDefinition.targetSelector=this._tourSelectorModifierHelper.getElement(widgetDefinition.targetSelector);if(!widgetDefinition.function){widgetDefinition.function=widgetDefinition.nextFunction}return widgetDefinition},_processWidgetDefinitionForWaitForEvent:function(widgetDefinition){widgetDefinition.rawTargetSelector=widgetDefinition.targetSelector;widgetDefinition.targetSelector=this._tourSelectorModifierHelper.getElement(widgetDefinition.targetSelector);if(!widgetDefinition.function){widgetDefinition.function=widgetDefinition.nextFunction}if(!widgetDefinition.event){widgetDefinition.event="focusout"}return widgetDefinition},_processWidgetDefinitionForTooltip:function(widgetDefinition){widgetDefinition.targetSelector=this._tourSelectorModifierHelper.getElement(widgetDefinition.targetSelector);return widgetDefinition},_processWidgetDefinitionForBar:function(widgetDefinition){var options={html:widgetDefinition.body};if(typeof widgetDefinition.leftButton==="undefined"){options.leftButtonFunction=widgetDefinition.previousFunction;options.leftButtonHTML="Previous"}else{if(widgetDefinition.leftButton){options.leftButtonFunction=widgetDefinition.leftButton.function;options.leftButtonHTML=widgetDefinition.leftButton.name}else{options.showLeft=false}}if(typeof widgetDefinition.rightButton==="undefined"){options.rightButtonFunction=widgetDefinition.nextFunction;options.rightButtonHTML="Next"}else{if(widgetDefinition.rightButton){options.rightButtonFunction=widgetDefinition.rightButton.function;options.rightButtonHTML=widgetDefinition.rightButton.name}else{options.showRight=false}}return options},_processWidgetDefinitionForOverlay:function(widgetDefinition){var options={showLeftButton:false,showRightButton:false};if(widgetDefinition.leftButton){options.leftButtonFunction=widgetDefinition.leftButton.function;options.leftButtonText=widgetDefinition.leftButton.name;options.leftButtonColor=widgetDefinition.leftButton.color}if(widgetDefinition.rightButton){options.rightButtonFunction=widgetDefinition.rightButton.function;options.rightButtonText=widgetDefinition.rightButton.name;options.rightButtonColor=widgetDefinition.rightButton.color}options.infoHTML=widgetDefinition.body;options.infoCss=widgetDefinition.bodyCSS;if(widgetDefinition.tips&&widgetDefinition.tips.length>0){var tips=[];for(var ii=0;ii<widgetDefinition.tips.length;ii++){var widgetTip=widgetDefinition.tips[ii];var tip={targetElement:this._tourSelectorModifierHelper.getElement(widgetTip.targetSelector),description:widgetTip.body,buttons:widgetTip.buttons};tips.push(tip)}options.tips=tips}return options},_processWidgetDefinitionForBottomModal:function(widgetDefinition){if(widgetDefinition.backButtonFunction){return}widgetDefinition.backButtonFunction=widgetDefinition.finishFunction;return widgetDefinition},_getWidget:function(type,options){var widgetList=this._widgetMap[type];if(widgetList&&widgetList.length>0){var widget=widgetList.pop();widget.reuse(options);this._listOfAllReusableWidgets.removeVal(widget);return widget}return this["_create"+type.camelize()](options)},_createModal:function(options){return BB.Widgets.Modal.create(options)},_createHighlight:function(options){return BB.Widgets.Tour.Highlight.create(options)},_createTooltip:function(options){var tooltip=new BB.Widgets.Tour.GmailTooltip;tooltip.setup(options);return tooltip},_createBar:function(options){return BB.Widgets.Tour.Bar.create(options)},_createOverlay:function(options){return BB.Widgets.Tour.Overlay.create(options)},_createWaitForClick:function(options){var waitForClick=new BB.Widgets.Tour.WaitForClick;waitForClick.setup(options);return waitForClick},_createWaitForEvent:function(options){var waitForEvent=new BB.Widgets.Tour.WaitForEvent;waitForEvent.setup(options);return waitForEvent},_createFunction:function(options){options.function(options.callbacks)},_createBottomModal:function(options){var bottomModal=new BB.Widgets.Tour.BottomModal;bottomModal.setup(options);return bottomModal}});Library.set("BentoBox.Tour.TourWidgetFactory",TourWidgetFactory)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TourSelectorModifierHelper=Streak.Class.subclass({className:"TourSelectorModifierHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getElement:function(selector){if(selector.indexOf(".gmail_")===-1){return selector}return this._processGmailSelector(selector)},_processGmailSelector:function(selector){var matches=selector.match(/(\.gmail_.*?)(\s|$|:)/);if(!matches){return selector}var gmailElementReference=matches[1];var restOfSelector=selector.replace(gmailElementReference,"");if(gmailElementReference.indexOf("inboxRow")>-1){return this._getGmailInboxRow(gmailElementReference)}return this._getGmailElement(gmailElementReference)},_getGmailElement:function(gmailElementReference){var elementReference=gmailElementReference.replace(".gmail_","");if(Gmail["get"+elementReference.camelize()]){return Gmail["get"+elementReference.camelize()]()}return this["_getGmail"+elementReference.camelize()]()},_getGmailInboxRow:function(){return Gmail.getVisibleThreadRows()[0].rowNode}});Library.set("BentoBox.Tour.TourSelectorModifierHelper",TourSelectorModifierHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxTourHelper=Streak.Class.subclass({className:"BoxTourHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},skipPageIfAnyBoxExists:function(basicTourCallbacks){var boxes=BB.Data.getAllBoxes();if(boxes&&boxes.length>0){basicTourCallbacks.next()}},skipPageIfBoxExists:function(basicTourCallbacks){var pipelineKey=Gmail.getConversationId();var boxes=BB.Data.getPipelineBoxes(pipelineKey);if(boxes&&boxes.length>0){basicTourCallbacks.next()}},skipPageIfOnBoxView:function(basicTourCallbacks){if(BB.UI.isBoxView()){basicTourCallbacks.next()}},skipPageIfMoreThanOneBoxExists:function(basicTourCallbacks){var boxes=BB.Data.getAllBoxes();if(boxes&&boxes.length>1){basicTourCallbacks.next()}}});Library.set("BentoBox.Tour.HelperClass.BoxTourHelper",BoxTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeTourHelper=Streak.Class.subclass({className:"ComposeTourHelper",superclass:Streak.Object,_memberVariables:[{name:"_composeWindowViewController",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},openComposeWindow:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){self._composeWindowViewController=composeWindowViewController;resolve()})})},openComposeToolbarOverflow:function(){var self=this;return Streak.Utils.wait(1).then(function(){return self._composeWindowViewController.openComposeToolbarOverflow()})},closeComposeWindow:function(){if(!this._composeWindowViewController.isDestroyed()){try{this._composeWindowViewController.close()}catch(err){}}},ensureTrackingIsOff:function(){this._composeWindowViewController.notify("turnOffTracking")},contactUs:function(callbacks){Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){composeWindowViewController.setToAddresses(["support@streak.com"]);callbacks.doneFunction()})}});Library.set("BentoBox.Tour.HelperClass.ComposeTourHelper",ComposeTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineTourHelper=Streak.Class.subclass({className:"PipelineTourHelper",superclass:Streak.Object,_memberVariables:[{name:"_newPipelineModal",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},skipPageIfPipelineExists:function(basicTourCallbacks){if(BB.Data.getAllPipelines().length>0){basicTourCallbacks.next()}},skipPageIfOnPipelineView:function(basicTourCallbacks){if(BB.UI.isPipelineView()){basicTourCallbacks.next()}},ensurePipelineListVisible:function(basicTourCallbacks){BB.Modules.LeftLink.open()},createPipeline:function(callbacks){this._newPipelineModal=BB.Widgets.NewPipelineModal.create({title:BB.FirstRun.getStage()===1?BB.Locale.getString("left_link_setup_first"):BB.Locale.getString("left_link_make_new"),noPipelineChosenCallback:callbacks.noPipelineCreatedFunction,pipelineSavedCallback:callbacks.pipelineCreatedFunction});this._newPipelineModal.show()},goToPipelineView:function(){if(BB.UI.isPipelineView()){return}var pipeline=BB.Data.getAllPipelines()[0];var promise=new Streak.Promise(function(resolve,reject){BB.UI.setURL(pipeline.link(),resolve)});return promise},bringUpPipelineSearchBox:function(){BB.Modules.PipelineView.activePipelineView.showSearchBox();var promise=new Streak.Promise(function(resolve,reject){setTimeout(resolve,500)});return promise},closePipelineSearchBox:function(){BB.Modules.PipelineView.activePipelineView.hideSearchBox()}});Library.set("BentoBox.Tour.HelperClass.PipelineTourHelper",PipelineTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var InboxTourHelper=Streak.Class.subclass({className:"InboxTourHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},goToInboxView:function(){BB.UI.setURL(Gmail.Constants.Inbox);var self=this;var promise=new Streak.Promise(function(resolve,reject){_.checkAndThenRun(function(){return Gmail.getCurrentMain().find("[gh=tl]").length>0},resolve,100)});return promise},skipPageIfGmailSettingsVisible:function(basicTourCallbacks){if(Gmail.getGearButton().is(":FastVisible")){basicTourCallbacks.next()}},skipPageIfOnGmailSettings:function(basicTourCallbacks){if(Gmail.view===Gmail.Constants.Settings){basicTourCallbacks.next()}},skipPageIfOnStreakSettings:function(basicTourCallbacks){if(Gmail.view==="settingsStreak"){basicTourCallbacks.next()}},skipPageIfInboxRowsPresent:function(basicTourCallbacks){if(Gmail.getVisibleThreadRows().length>0){basicTourCallbacks.next()}},skipPageIfThreadWithMultipleMessagesPresent:function(basicTourCallbacks){var inboxList=Gmail.getMainList();var threadsWithMultipleMessages=inboxList.find("tr .yW:contains(()");if(threadsWithMultipleMessages.length>0){basicTourCallbacks.next()}},skipPageIfThreadViewEnabled:function(basicTourCallbacks){if(!Gmail.isConversationViewDisabled()){basicTourCallbacks.next()}},waitUntilConversationViewVisible:function(){return new Streak.RSVP.Promise(function(resolve,reject){_.checkAndThenRun(Gmail.isConversationVisible.bind(Gmail),resolve,100)})},goToInboxViewAndWaitForSettings:function(callbacks){BB.UI.setURL(Gmail.Constants.Inbox);_.checkAndThenRun(function(){return Gmail.getGearButton().is(":FastVisible")},callbacks.nextFunction,100)},waitForGmailSettingsVisible:function(callbacks){var promise=new Streak.Promise(function(resolve,reject){_.checkAndThenRun(function(){return Gmail.getGearButton().is(":FastVisible")},resolve,500)});return promise}});Library.set("BentoBox.Tour.HelperClass.InboxTourHelper",InboxTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailTrackingTourHelper=Streak.Class.subclass({className:"EmailTrackingTourHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._searchValue=null},ensureTrackedSearchLinkVisible:function(){if(!Streak.$(".streak__leftNav_sentNested .streak__leftNavLink").is(":visible")){Streak.$(".streak__leftNav_sentExpando").simulateRawClick()}var promise=new Streak.Promise(function(resolve,reject){setTimeout(resolve,100)});return promise},showHasTrackingInSearch:function(callback){this._searchValue=Gmail.getSearchInput().val();Gmail.getSearchInput().val("has:tracking")},restoreSearch:function(){Gmail.getSearchInput().val(this._searchValue)},showUnlockPixelTracking:function(callbacks){var shareModal=Streak.Library.getInstance("BentoBox.Modules.PixelTrackingShareModalViewController");shareModal.show(callbacks.doneFunction)}});Library.set("BentoBox.Tour.HelperClass.EmailTrackingTourHelper",EmailTrackingTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TourSelectorHelper=Streak.Class.subclass({className:"TourSelectorHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},skipPageIfSelectorVisible:function(selector,basicTourCallbacks){if($(selector).is(":visible")){basicTourCallbacks.next()}},skipPageIfSelectorNotVisible:function(selector,basicTourCallbacks){if(!$(selector).is(":visible")){basicTourCallbacks.next()}},wait:function(milliseconds){return new Streak.Promise(function(resolve,reject){setTimeout(resolve,milliseconds)})}});Library.set("BentoBox.Tour.HelperClass.TourSelectorHelper",TourSelectorHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SavedViewTourHelper=Streak.Class.subclass({className:"SavedViewTourHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},skipPageIfSavedViewsExist:function(basicTourCallbacks){var anySavedViews=_.some(BB.Data.getAllPipelines(),function(pipeline){return pipeline.getSavedViews().length!=0});if(anySavedViews){basicTourCallbacks.next()}},expandFirstSavedView:function(basicTourCallbacks){var savedViewEl=$(".streak__savedViewsHolder .linkItem");if(!savedViewEl.is(":visible")){savedViewEl.parent().prev().find(".expando").simulateRawClick()}},ensureAssignedToColumnFilterSelected:function(basicTourCallbacks){var columnText=$(".savedViewsFilterSection .filterColumnOptions .dropdown .bbButton").text().trim();var assignedToText=BB.Locale.getString("system_assigned_to").trim();if(columnText!==assignedToText){basicTourCallbacks.moveBackPages(2)}else{basicTourCallbacks.next()}},ensureIsAnyOfFilterOptionChosen:function(basicTourCallbacks){var columnText=$(".savedViewsFilterSection .filterOperationOptions .dropdown .bbButton").text().trim();var optionText=BB.Locale.getString("filter_is_any").trim();if(columnText!==optionText){basicTourCallbacks.moveBackPages(2)}else{basicTourCallbacks.next()}},ensureMeFilterValueChosen:function(basicTourCallbacks){var columnText=$(".savedViewsFilterSection .filterValueOptions .streak__valuesMultiSelect").text().trim();var valueText="Me";if(columnText!==valueText){basicTourCallbacks.moveBackPages(2)}else{basicTourCallbacks.next()}}});Library.set("BentoBox.Tour.HelperClass.SavedViewTourHelper",SavedViewTourHelper)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};var MobileModalTourHelper=Streak.Class.subclass({className:"MobileModalTourHelper",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},showIOSModal:function(basicTourCallbacks){var inner=$(HTML.get("extendedTouriPhoneModalInner")());var inputWrapper=inner.find(".extendedTourIPhoneModalInput");var input=inputWrapper.find("input");var inputStatus=inner.find(".extendedTourIPhoneModalInputStatus");var resolvePromiseFunction;var promise=new Streak.Promise(function(resolve){resolvePromiseFunction=resolve});var submitButton=BB.Widgets.Button.create({name:"Send To My Phone",color:"blue",onFunc:function(e){track("send_ios_link_attempt");submitButton.disable();modal.getOkButton().disable();submitButton.el.html("<div>Sending...</div>");var phoneNumber=input.val();APIRequester.post("promos/ioslink",{phoneNumber:phoneNumber}).getPromise().then(function(res){if(res.success){track("send_ios_link_successful");submitButton.el.html("<div>Sent!</div>");setTimeout(function(){modal.close()},2*1e3)}else{track("send_ios_link_failure");modal.getOkButton().enable();submitButton.enable();submitButton.el.html("<div>Send To My Phone</div>");inputStatus.css("color","red");inputStatus.html("Sorry there was an error. Please go to www.streak.com/iphone on your iPhone.");inputStatus.show()}},function(){inputStatus.css("color","red");inputStatus.html("Sorry there was an error. Please go to www.streak.com/iphone on your iPhone.");inputStatus.show()})}});inputWrapper.find(".extendedTourIPhoneModalInputButton").append(submitButton.el);input.on("keydown",function(e){if(e.which===13){submitButton.on()}});input.on("focus",function(e){inputWrapper.addClass("acm")});input.on("blur",function(e){inputWrapper.removeClass("acm")});$.tabChain([input,submitButton.el]);var modal=BB.Widgets.Modal.create({title:"Get Streak for your iPhone",width:"550px",inner:inner,showConfirm:true,showCancel:false,confirmText:"No thanks",doneButtonColor:"normal",onClose:resolvePromiseFunction});
modal.show();setTimeout(function(){input.focus()},50);return promise}});Library.set("BentoBox.Tour.HelperClass.MobileModalTourHelper",MobileModalTourHelper)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var FOREVER=0;var ButterBarManager=Streak.Class.subclass({className:"ButterBarManager",superclass:Streak.Object,memberVariables:[{name:"_currentPacket",destroy:true},{name:"_hiddenPackets",destroy:true,defaultValue:[]}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},_dummyPacket:{destroy:function(){},_destroyed:true,_notice:null,_pushBack:function(){},options:{}},_ancientComplainTime:2*60*1e3,FOREVER:FOREVER,showMessage:function(message,options){options=this._interpretParameters(arguments);if(options.priority==null){options.priority=-1}if(options.time==null){if(!options.operationProgressId){options.time=15*1e3}else{options.time=FOREVER}}if(options.hideOnViewChanged==null){options.hideOnViewChanged=options.time!=FOREVER}this.hideMessage(options.messageKey);var canShowNow=!this._currentPacket||options.priority>=this._currentPacket.options.priority;if(!canShowNow&&!options.persistent)return this._dummyPacket;if(options.hideOnViewChanged){options.hideOnViewChanged=false;this._initViewChangeKiller();setTimeout(function(){options.hideOnViewChanged=true},0)}if(options.persistent)this._initPersistenceManager();var packet={};packet.options=options;packet.creationStack=Streak.Utils.getStackTrace();var that=this;packet.destroy=_.once(function(){packet._destroyed=true;that._cleanupPacketRefs();if(packet._notice)packet._notice.destroy();delete packet._notice;clearTimeout(packet.timeout)});if(!canShowNow){this._hiddenPackets.push(packet)}else{this._displayPacket(packet)}if(options.time!=FOREVER){packet.timeout=setTimeout(packet.destroy,options.time)}if(options.operationProgressId){var destroyJob=Streak.Promise.defer();destroyJob.promise.done(packet.destroy);this._watchForOperationCompleteNotification(this,destroyJob,options.operationProgressId)}return packet},showLoading:function(options){options=this._interpretParameters(arguments);options.message=options.message||BB.Locale.getString("loading");options.priority=-3;options.time=FOREVER;options.persistent=true;options.hideOnViewChanged=true;return this.showMessage(options)},showSaving:function(options){options=this._interpretParameters(arguments);options=_.defaults(options,{message:BB.Locale.getString("saving"),priority:-2,time:FOREVER,persistent:true,showConfirmation:true});var savingMessage=this.showMessage(options);var job=Streak.Promise.defer();var that=this;if(options.showConfirmation){job.promise.then(function(){that.showMessage({message:BB.Locale.getString("saved"),messageKey:options.messageKey,time:1*1e3,priority:200})})}job.promise.done(function(){savingMessage.destroy();if(options.operationProgressId)NotificationCenter.unsubscribe({observer:job})});if(options.operationProgressId){this._watchForOperationCompleteNotification(job,job,options.operationProgressId)}return job},showError:function(message,options){options=this._interpretParameters(arguments);options.priority=100;return this.showMessage(options)},showCriticalError:function(message,options){return this.showError(message,options)},showProgress:function(options){options=_.defaults(options,{initial:"saving",progressSuccess:"generic_progress",progressError:"generic_progress_bad",completeSuccess:"generic_progress_success",completeError:"generic_progress_error",progressSuccessCallback:false,progressErrorCallback:false,completeSuccessCallback:false,completeErrorCallback:false});if(!options.operationProgressId)throw new Error("ButterBarManager.showProgress() calls require an operationProgressId!");var observer={};if(options.initial){this.showMessage({message:BB.Locale.getString(options.initial),messageKey:observer,priority:-2,persistent:true,time:FOREVER})}var that=this;Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:options.operationProgressId},observer:observer,functionToCall:function(notification){var strParameters={succeeded:notification.operationProgressStats.succeeded,failed:notification.operationProgressStats.failed,total:notification.operationProgressStats.total};function getMessage(key){if(typeof key=="function")return key(notification,strParameters);else return BB.Locale.getString(key,strParameters)}var progressTime=notification.operationIsComplete?5e3:FOREVER;if(notification.operation.getState()===Streak.Operations.Operation.STATES.SUCCEEDED){if(options.progressSuccessCallback){options.progressSuccessCallback(notification)}if(options.progressSuccess){that.showMessage({message:getMessage(options.progressSuccess),messageKey:observer,priority:-2,persistent:true,time:progressTime})}}else if(notification.operation.getState()===Streak.Operations.Operation.STATES.FAILED){if(options.progressErrorCallback){options.progressErrorCallback(notification)}if(options.progressError){that.showError({message:getMessage(options.progressError),messageKey:observer,persistent:true,time:progressTime})}}if(notification.operationIsComplete){Streak.NotificationCenter.unsubscribe({observer:observer});if(notification.operationProgressStats.failed>0){if(options.completeErrorCallback){options.completeErrorCallback(notification)}if(options.completeError){that.showError({message:getMessage(options.completeError),messageKey:observer})}}else{if(options.completeSuccessCallback){options.completeSuccessCallback(notification)}if(options.completeSuccess){that.showMessage({message:getMessage(options.completeSuccess),messageKey:observer,priority:200,time:3e3})}}}}})},hideMessage:function(messageKey){if(!messageKey)return;_.map(this._hiddenPackets,function(packet){if(packet.options.messageKey===messageKey)packet.destroy()});if(this._currentPacket&&this._currentPacket.options.messageKey===messageKey){this._currentPacket.destroy()}},_displayPacket:function(packet){if(this._currentPacket)this._currentPacket._pushBack();this._currentPacket=packet;packet._notice=Gmail.newNotice(packet.options.message);var complainTimeout=setTimeout(this._complainAboutAncientMessage.bind(this,packet),this._ancientComplainTime);var that=this;packet._pushBack=_.once(function(){clearTimeout(complainTimeout);if(packet._destroyed)return;delete packet._notice;if(that._currentPacket===packet)that._currentPacket=null;if(packet.options.persistent)that._hiddenPackets.push(packet);else packet.destroy()});packet._notice.endPromise.done(packet._pushBack)},_interpretParameters:function(params){var options;if(typeof params[0]==="string"){options=params[1]||{};options.message=params[0]}else{options=params[0]||{}}return options},_initViewChangeKiller:_.once(function(){var that=this;Streak.Gmail.observe("viewChanged",function(){_.map(that._hiddenPackets,function(packet){if(packet.options.hideOnViewChanged)packet.destroy()});if(that._currentPacket&&that._currentPacket.options.hideOnViewChanged)that._currentPacket.destroy()})}),_initPersistenceManager:_.once(function(){var that=this;NotificationCenter.subscribe({eventName:"gmail.noticesCleared",observer:this,functionToCall:function(event){if(event.noticeSpawned)return;if(that._currentPacket)that._currentPacket._pushBack();var packet;do{packet=that._hiddenPackets.pop()}while(packet&&packet._destroyed);if(packet){that._displayPacket(packet);event.noticeSpawned=true}}})}),_cleanupPacketRefs:function(){if(this._currentPacket&&this._currentPacket._destroyed)this._currentPacket=null;this._cleanupHiddenPacketRefs()},_cleanupHiddenPacketRefs:_.throttle(function(){this._hiddenPackets=_.filter(this._hiddenPackets,function(packet){return!packet._destroyed})},100,{leading:false}),_complainAboutAncientMessage:function(packet){BB.logError("ButterBarManager message was displayed for more than "+this._ancientComplainTime+" milliseconds.\n"+"creationStack:\n"+packet.creationStack,null,JSON.stringify({options:packet.options}));packet.destroy()},_watchForOperationCompleteNotification:function(observer,deferred,operationProgressId){NotificationCenter.subscribe({eventName:"operationProgressUpdate",observer:observer,filterParameters:{operationProgressId:operationProgressId,operationIsComplete:true},unsubscribeImmediately:true,functionToCall:function(notification){if(!notification.operationProgressStats.failed)deferred.resolve();else deferred.reject()}})}});Library.set("BentoBox.ButterBarManager",new ButterBarManager)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var SQUARE_RIGHT="T-I-Js-IF",SQUARE_LEFT="T-I-Js-Gs";var ToolbarManager=Streak.Class.subclass({className:"ToolbarManager",superclass:Streak.Object,memberVariables:[{name:"_buttons",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._buttons=[];Gmail.observe("viewChanged",this._update.bind(this));Gmail.observe("toolbarUpdate",this._update.bind(this))},registerButton:function(button){if(!button||!button.element||!button.showFor){throw new Error("button missing properties")}this._buttons.push(button);this._update()},_checkShowFor:function(showFor,viewTags){if(_.isFunction(showFor)){return showFor(viewTags)}else if(_.isArray(showFor)){return _.intersection(viewTags,showFor).length>0}else if(_.isString(showFor)){return _.contains(viewTags,showFor)}},_getViewTags:function(){var viewTags=[];var view=Gmail.isInConversation()?"conversation":Gmail.getLiveView();switch(view){case"inbox":case"starred":case"imp":case"label":case"search":case"sent":case"spam":case"trash":case"apps":case"all":viewTags.push("threadList");viewTags.push("threadSelection");break;case"drafts":viewTags.push("drafts");break;case"conversation":viewTags.push("conversation");viewTags.push("threadSelection");break;case"pipeline":viewTags.push("pipeline");break;case"box":viewTags.push("box");break}return viewTags},_updateButtonForIconMode:function(iconMode,element){element.toggleClass("streak__iconMode",iconMode);var textEl=element.find(".buttonText").toggle(!iconMode);if(iconMode){var text=textEl.text();element.attr({"aria-label":text,"data-tooltip":text})}else{element.removeAttr("aria-label data-tooltip")}},_update:function(){var self=this;var viewTags=this._getViewTags();var interestedButtons;if(viewTags.length){interestedButtons=_.filter(this._buttons,function(button){return self._checkShowFor(button.showFor,viewTags)})}var notInterestedButtons=_.difference(this._buttons,interestedButtons);_.each(notInterestedButtons,function(button){button.element.detach()});var placements=["default"];if(_.intersection(viewTags,["threadList","conversation"])){placements.push("archiveGroup");placements.push("moveGroup")}var buttonGroups=_.groupBy(interestedButtons,function(button){var list=typeof button.placement=="string"?[button.placement]:button.placement;return _.intersection(list,placements)[0]||"default"});placements.forEach(function(group){if(!buttonGroups[group]){buttonGroups[group]=[]}});var iconButtonMode=Gmail.isIconButtonModeActive();_.each(buttonGroups,function(buttons,placement){buttons=_.sortBy(buttons,"orderHint");_.each(buttons,function(button,i){button.element.toggleClass(SQUARE_LEFT,placement!="default"||i!=0).toggleClass(SQUARE_RIGHT,i!=buttons.length-1);self._updateButtonForIconMode(iconButtonMode,button.element)});if(placement=="archiveGroup"){var $deleteButton=Gmail.getDeleteButton().first();var nextButtonPresent=$deleteButton.nextAll().filter(":not(.bbButton)").length>0;$deleteButton.toggleClass(SQUARE_RIGHT,nextButtonPresent||buttons.length>0);_.each(buttons.reverse(),function(button,i){if(nextButtonPresent&&i==buttons.length-1){button.element.addClass(SQUARE_RIGHT)}button.element.insertAfter($deleteButton).show()})}else if(placement=="moveGroup"){var $labelButton=Gmail.getMoveAndLabelDropdownButtons().last();$labelButton.toggleClass(SQUARE_RIGHT,buttons.length>0);_.each(buttons.reverse(),function(button){button.element.insertAfter($labelButton).show()})}else if(placement=="default"){var $gmailMoreButton=Gmail.getCurrentMoreButton().first();var shouldShow=!_.contains(viewTags,"threadList")||Gmail.getSelectedThreadRows().length>0;_.each(buttons.reverse(),function(button){button.element.insertAfter($gmailMoreButton).toggle(shouldShow)})}else{BB.logError("unknown button placement type",null,{placement:placement})}})}});Library.set("BentoBox.Services.ToolbarManager",new ToolbarManager)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var EmailOptionManager=Streak.Class.subclass({className:"EmailOptionManager",superclass:Streak.Object,memberVariables:[{name:"_buttons",destroy:true},{name:"_menu",destroy:false},{name:"_email",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._buttons=[];Gmail.observe("emailMenuOpen",this._menuOpen.bind(this));Gmail.observe("viewChanged",this._onViewChanged.bind(this))},registerButton:function(button){this._buttons.push(button);this._buttons=_.sortBy(this._buttons,"orderHint");this._update()},_clearManagedItems:function(){if(this._menu){this._menu.find(".emailOptionManagerRuler, .emailOptionManagerItem").remove()}},_onViewChanged:function(view){if(view!="conversation"){this._clearManagedItems();this._menu=null;this._email=null}},_menuOpen:function($menu,$email){this._clearManagedItems();this._menu=$menu;this._email=$email;this._update()},_showFor:function(mid,button){if(!button.showFor){return true}else{return button.showFor(mid)}},_update:function(){if(!this._menu){return}this._clearManagedItems();var self=this,$menu=this._menu,$email=this._email;var mid=Gmail.getMessageIdFromElement($email);if(!mid){BB.logError("Could not get message id for email",null,{$emailLength:$email.length});return}var interestedButtons=_.filter(this._buttons,this._showFor.bind(this,mid));if(interestedButtons.length){$menu.append($("<div/>").addClass("J-Kh").addClass("emailOptionManagerRuler"));_.each(interestedButtons,function(button){var $entry=$("<div/>").addClass("J-N").addClass("emailOptionManagerItem").attr("role","menuitem").text(button.text).click(function(){Gmail.closeActiveEmailMenu();button.fn(mid)}).hover(function(){$(this).addClass("J-N-JT")},function(){$(this).removeClass("J-N-JT")}).appendTo($menu);_.each(button.extraCSSClasses,function(className){$entry.addClass(className)})})}}});Streak.DependencyManager.addFunction({functionKey:"emailOptionManagerInitialized",functionReference:function(){Library.set("BentoBox.Services.EmailOptionManager",new EmailOptionManager)},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var FeatureLimiter=Streak.Class.subclass({className:"FeatureLimiter",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},incrementUsage:function(numberOfTimes){if(!numberOfTimes){numberOfTimes=1}var settingsKey=this._getFeatureKey()+"/count";var currentCount=BB.LocalSettings.get(settingsKey)||0;BB.LocalSettings.set(settingsKey,currentCount+numberOfTimes)},isLocked:function(){if(BB.isFeatureEnabled(this._getFeatureKey())){return false}return this._isOverLimit()},showGateway:function(){var title=this._getGatewayTitle();var bodyText=this._getGatewayBodyText();var featureKey=this._getFeatureKey();var gateway=new BB.Widgets.PaywallGatewayViewController({title:title,text:bodyText});gateway.show({closed:function(upgradeClicked){if(upgradeClicked){BB.Tracker.track(featureKey+"GatewayUpgradePressed")}else{BB.Tracker.track(featureKey+"GatewayCancelPressed")}}});BB.Tracker.track(featureKey+"GatewayShown")},_isOverLimit:function(){var settingsKey=this._getFeatureKey()+"/count";var currentCount=BB.LocalSettings.get(settingsKey)||0;return currentCount>=this._getLimit()},_getFeatureKey:function(){throw new Error("must define _getFeatureKey")},_getGatewayTitle:function(){throw new Error("must define _getGatewayTitle")},_getGatewayBodyText:function(){throw new Error("must define _getGatewayBodyText")},_getLimit:function(){throw new Error("must define _getLimit")}});Library.set("BentoBox.Services.FeatureLimiter",FeatureLimiter)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var MoreMenuManager=Streak.Class.subclass({className:"MoreMenuManager",superclass:Streak.Object,memberVariables:[{name:"_buttons",destroy:true},{name:"_menu",destroy:false},{name:"_lastView",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._buttons=[];Gmail.observe("moreMenuOpen",this._menuOpen.bind(this));Gmail.observe("viewChanged",this._onViewChanged.bind(this))},registerButton:function(button){this._buttons.push(button);this._buttons=_.sortBy(this._buttons,"orderHint");this._update()},_clearManagedItems:function(){if(this._menu){this._menu.find(".moreManagerRuler, .moreManagerItem").remove()}},_onViewChanged:function(view){if(this._lastView&&this._lastView!=view){this._clearManagedItems();this._menu=null;this._email=null}this._lastView=view},_menuOpen:function($menu,$email){this._clearManagedItems();this._menu=$menu;this._email=$email;this._update()},_showFor:function(view,button){return button.showFor(view)},_enableFor:function(view,button){return!button.enableFor||button.enableFor(view)},_update:function(){if(!this._menu){return}this._clearManagedItems();var self=this,$menu=this._menu;var view=Gmail.isInConversation()?"conversation":Gmail.getLiveView();var $menuItemSection=$menu.find(".J-N").first().parent();var interestedButtons=_.filter(this._buttons,this._showFor.bind(this,view));if(interestedButtons.length){$menuItemSection.append($("<div/>").addClass("J-Kh").addClass("moreManagerRuler"));_.each(interestedButtons,function(button){var enabled=self._enableFor(view,button);var $innerEntry=$("<div/>").addClass("J-N-Jz").text(button.text);var $entry=$("<div/>").addClass("J-N").addClass("moreManagerItem").attr("role","menuitem").append($innerEntry).appendTo($menuItemSection);_.each(button.extraCSSClasses,function(className){$entry.addClass(className)});if(enabled){$entry.click(function(){Gmail.getCurrentMoreButton().simulateRawClick();button.fn()}).hover(function(){$(this).addClass("J-N-JT")},function(){$(this).removeClass("J-N-JT")})}else{$entry.addClass("J-N-JE").show().attr("aria-disabled",true)}})}}});Streak.DependencyManager.addFunction({functionKey:"moreMenuManagerInitialized",functionReference:function(){Library.set("BentoBox.Services.MoreMenuManager",new MoreMenuManager)},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var _=Streak._;var self=FileStore={RESERVATION_SIZE:50*1024*1024,init:function(){this._isActive=false;this._validEmailPath="/"+Streak.userEmail.replace("@","_").replace(".","_")+"/";this._filer=new Streak.Filer;try{this._filer.init({persistent:false,size:this.RESERVATION_SIZE},function(fileSystem){self._isActive=true},function(){})}catch(err){this._isActive=false}},isEnabled:function(){return this._isActive},load:function(path,callback){if(!this._isActive){this._callCallback(callback,null)}var fullPath=this._validEmailPath+path;this._filer.open(fullPath,function(file){self._readAndParseJSONFile(file,callback)},function(){self._callCallback(callback,null)})},store:function(path,value,callback){if(!path){this._callCallback(callback);return}var fullPath=this._validEmailPath+path;this._makeDirectory(fullPath,function(){self._writeFile(fullPath,value,callback)})},remove:function(path,callback){if(!_.isFunction(callback)){callback=function(){}}this._filer.rm(this._validEmailPath+path,callback)},_makeDirectory:function(fullPath,callback){var dirPath=_.initial(fullPath.split("/")).join("/");this._filer.mkdir(dirPath,false,callback,this._logError)},_writeFile:function(fullPath,value,callback){this._filer.write(fullPath,{data:value,type:"text",append:false},function(fileEntry,fileWriter){self._callCallback(callback,fileEntry)},this._logError)},_readAndParseJSONFile:function(file,callback){if(!file){this._callCallback(callback,null);return}var reader=new FileReader;reader.onload=function(){var result;if(reader.result){try{result=JSON.parse(reader.result)}catch(err){self._logError(err)}}self._callCallback(callback,result)};reader.onerror=this._logError;reader.readAsText(file,"UTF-8")},_callCallback:function(callback){if(callback){callback.apply(null,_.rest(arguments))}},_logError:function(err){Streak.BentoBox.logError("problem with file store",err)}};Streak.FileStore=FileStore;Streak.DependencyManager.addFunction({functionKey:"fileStoreLoaded",functionReference:FileStore.init,functionContext:FileStore})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Widget=function(options){this.options=null;this.setOptions(options)};_.extend(Widget.prototype,{defaults:{},initialized:false,init:function(cb){if(!this.initialized&&this.initializeWidget){this.initializeWidget(cb)}else if(cb){cb()}},setOptions:function(options){this.options=_.extend({},this.defaults,this.options,options)},destroy:function(){}});BB.Widgets.Widget=Widget;BB.Widgets.UIControllers={}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var FormulaValueLabel=Streak.Class.subclass({className:"FormulaValueLabel",superclass:UI.ViewController,_memberVariables:[{name:"_unbinders",destroy:false}],_initialize:function(options){UI.ViewController.prototype._initialize.call(this);this._model=options.model;this._property=options.property;this._view.addClass("streak__formulaValueLabel");this._bindToModel();this._updateDisplay()},getElement:function(){return this._view.getElement()},_bindToModel:function(){NotificationCenter.unsubscribe({observer:this});this._model.watch("set",this._updateDisplay,this,this._property)},_updateDisplay:function(){this._view.setHTML(this._getValue())},_getValue:function(){var value=this._model.get(this._property);if(!value){return""}switch(value.calculationStatus){case"SUCCESS":if(value.calculationValue){return BB.Models.BoxField.getFormulaHTMLForType(value)}else{return""}break;case"NOT_ATTEMPTED":return"Pending";break;default:return this._getErrorHTML(value)}},_getErrorHTML:function(value){var tooltipString=BB.Locale.getString("formula_error_"+value.calculationStatus.toLowerCase());if(value.errorDetails){tooltipString+=": \n\n"+_.escape(value.errorDetails)}return'<div class="streak__formulaError" data-tooltip="'+tooltipString+'">Error</div>'},destroy:function(){NotificationCenter.unsubscribe({observer:this});UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.FormulaValueLabel",FormulaValueLabel)})(Streak);(function(Streak){var $=Streak.$,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var PipelineLockdownWarningView=Streak.Class.subclass({className:"PipelineLockdownWarningView",superclass:superclass,_memberVariables:[{name:"_message",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._message=this._element.find(".streak__message")},_setupElement:function(){this._element=$(HTML.getElement("streak__pipeline_lockdown_warning"))},setWarning:function(){this._element.removeClass("streak__pipeline_lockdown").show()},setLockdown:function(){this._element.addClass("streak__pipeline_lockdown").show()},setHelpButton:function(button){this._element.find(".streak__lockdown_learn_more").html(button.getElement())},setEmailButton:function(button){this._element.find(".streak__email_button").html(button.getElement())},setRemoveButton:function(button){this._element.find(".streak__remove_button").html(button.getElement())},setUpgradeButton:function(button){this._element.find(".streak__lockdown_upgrade_button").html(button.getElement())},toggleUpgrade:function(show){if(show){this._element.find(".streak__upgrade").show().css("display","")}else{this._element.find(".streak__upgrade").hide()}},toggleEmail:function(show){if(show){this._element.find(".streak__email").show().css("display","")}else{this._element.find(".streak__email").hide()}},toggleRemove:function(show){if(show){this._element.find(".streak__remove").show().css("display","")}else{this._element.find(".streak__remove").hide()}},setDaysRemaining:function(daysRemaining){this._element.find(".streak__days_remaining").text(daysRemaining)},setTotalCollaborators:function(totalCollaborators){this._element.find(".streak__numberOfCollaborators").text(totalCollaborators)},hide:function(){this._element.hide()}});Library.set("BentoBox.Widgets.PipelineLockdownWarningView",PipelineLockdownWarningView)})(Streak);(function(Streak){var $=Streak.$,_=Streak._,Gmail=Streak.Gmail,Library=Streak.Library,Locale=Streak.Locale,UI=Streak.UI,BB=Streak.BentoBox,Tracker=BB.Tracker;var superclass=UI.ViewController;var PROBLEMS={USER_PLAN_IS_TOO_SMALL:1,USER_HAS_NO_PLAN:2,BILLING_ADMIN_PLAN_TOO_SMALL:3};var PipelineLockdownWarningViewController=Streak.Class.subclass({className:"PipelineLockdownWarningViewController",superclass:superclass,_memberVariables:[{name:"_pipeline",destroy:false},{name:"_participatingPlans",destroy:false},{name:"_billingPlanInstances",destroy:false},{name:"_emailButton",destroy:true},{name:"_upgradeButton",destroy:true},{name:"_removeButton",destroy:true},{name:"_peopleToEmail",destroy:false},{name:"_peopleToRemove",destroy:false},{name:"_peopleToAdd",destroy:false},{name:"_numberOfPeopleNeededOnNewPlan",destroy:true},{name:"_helpButton",destroy:true},{name:"_problems",destroy:true},{name:"_status",destroy:true},{name:"_daysRemaining",destroy:true},{name:"_totalCollaborators",destroy:true},{name:"_helpModal",destroy:true},{name:"_timedUpdateID",destroy:false},{name:"_helpUpgradeAllButton",destroy:true},{name:"_removeCollaboratorsLink",destroy:true},{name:"_canUpgradeUsers",destroy:true}],_initialize:function(pipeline){superclass.prototype._initialize.call(this);this._pipeline=pipeline;this._setupEmailButton();this._setupUpgradeButton();this._setupRemoveButton();this._setupHelpButton();this._setupParticipatingPlans();this._setupBillingPlans();this._setupTimedUpdate();this._updateCollaboratorStatus();this._subscribeToPipelineStatusChanges()},destroy:function(){this._removeHelpModal();Streak.NotificationCenter.unsubscribe({observer:this});this._clearTimedUpdate();superclass.prototype.destroy.apply(this,arguments);this.destroyed=true},_setupParticipatingPlans:function(){this._participatingPlans=BB.Data.getParticipatingPlans();if(!this._participatingPlans.getHasLoaded()){this._participatingPlans.refresh(this._updateCollaboratorStatus.bind(this))}this._participatingPlans.watch("change",this._updateCollaboratorStatus,this)},_setupBillingPlans:function(){this._billingPlanInstances=BB.Data.getBillingPlanInstances();if(!this._billingPlanInstances.getHasLoaded()){this._billingPlanInstances.refresh(this._updateCollaboratorStatus.bind(this))}this._billingPlanInstances.watch("change",this._updateCollaboratorStatus,this)},_subscribeToPipelineStatusChanges:function(){this._pipeline.watch("change",this._updateCollaboratorStatus,this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.PipelineLockdownWarningView")},_updateCollaboratorStatus:function(){var readyToDisplay=!this.destroyed&&this._userPlanLoaded()&&this._billingPlanLoaded();if(!readyToDisplay){if(this._view)this._view.hide();return}this._status=this._pipeline.getCollaborationStatus();if(this._status==="OK"){this._view.hide();return}var problems=[];this._daysRemaining=this._pipeline.getNumberOfDaysUntilLockdown();this._totalCollaborators=this._pipeline.get("numberOfTotalCollaborators");this._view.setTotalCollaborators(this._totalCollaborators);this._view.setDaysRemaining(this._daysRemaining);this._orgWideCollaborators=this._pipeline.get("numberOfOrgWideOnlyCollaborators");var billingPlanInstance=this.getBillingPlanInstance();var userIsBillingAdmin=!!billingPlanInstance;var userOnAPlan=!!this.getUserPlan();var problemCollaborators=this._pipeline.get("problematicCollaborators");var collaboratorsOnAWrongPlan=_.select(problemCollaborators,this._onAPlan);var collaboratorsOnAWrongPlanYouCantUpgrade=_.reject(collaboratorsOnAWrongPlan,function(collaborator){if(!userIsBillingAdmin)return false;var planInstance=collaborator.planInstance;if(!planInstance)return false;return planInstance.get("key")===billingPlanInstance.get("key")});var collaboratorsNotOnAPlan=_.reject(problemCollaborators,this._onAPlan);var thereAreCollaboratorsYouCantAddToAPlan=collaboratorsNotOnAPlan.length>0&&userOnAPlan&&!userIsBillingAdmin;if(collaboratorsOnAWrongPlanYouCantUpgrade.length>0||thereAreCollaboratorsYouCantAddToAPlan){this._canUpgradeUsers=false;this._peopleToEmail=[];if(collaboratorsOnAWrongPlanYouCantUpgrade.length>0){problems=problems.concat(_.map(collaboratorsOnAWrongPlanYouCantUpgrade,function(collaborator){return{problem:PROBLEMS.USER_PLAN_IS_TOO_SMALL,collaborator:collaborator}}));this._peopleToEmail=this._peopleToEmail.concat(collaboratorsOnAWrongPlanYouCantUpgrade)}if(thereAreCollaboratorsYouCantAddToAPlan){problems=problems.concat(_.map(collaboratorsNotOnAPlan,function(collaborator){return{problem:PROBLEMS.USER_HAS_NO_PLAN,collaborator:collaborator}}));this._peopleToEmail=this._peopleToEmail.concat(collaboratorsNotOnAPlan)}this._view.toggleEmail(true);this._view.toggleUpgrade(false)}else{this._canUpgradeUsers=true;if(this._totalCollaborators>this.getPlanCollaboratorLimit()){problems.push({problem:PROBLEMS.BILLING_ADMIN_PLAN_TOO_SMALL,currentPlan:this.getPlanName(),currentPlanLimit:this.getPlanCollaboratorLimit()})}if(collaboratorsNotOnAPlan.length>0){problems=problems.concat(_.map(collaboratorsNotOnAPlan,function(collaborator){return{problem:PROBLEMS.USER_HAS_NO_PLAN,collaborator:collaborator}}))}this._peopleToAdd=collaboratorsNotOnAPlan;this._view.toggleEmail(false);this._view.toggleUpgrade(true)}this._view.toggleRemove(true);this._peopleToRemove=problemCollaborators;this._problems=problems;if(this._status==="LOCKDOWN"){this._view.setLockdown();Tracker.track("lockdownWarning.pipelineLockedDownShown")}else if(this._status==="WARNING"){this._view.setWarning();Tracker.track("lockdownWarning.pipelineWarningShown")}else{BB.logError("Collaborator status took an unexpected value",status);this._view.hide()}},_onAPlan:function(collaborator){return collaborator.planKey&&collaborator.planKey!==""},_isBillingAdmin:function(collaborator){return collaborator.get("planInstance")},getUserPlan:function(){if(!this._userPlanLoaded()){throw new Error("User plan was not loaded when getUserPlan was called")}return this._participatingPlans[0]},getBillingPlanInstance:function(){if(!this._billingPlanLoaded()){throw new Error("Admin billing plan was not loaded when getBillingPlanInstance was called")}return _.select(this._billingPlanInstances,function(planInstance){return planInstance.isActive()})[0]},_setupEmailButton:function(){var self=this;this._emailButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("pipeline_collaborator_email_users"),color:"blue",onFunction:function(){self._emailButtonPressed()}});this._view.setEmailButton(this._emailButton)},_setupUpgradeButton:function(){var self=this;this._upgradeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("pipeline_collaborator_upgrade_plan"),color:"blue",onFunction:function(){self._upgradeButtonPressed()
}});this._view.setUpgradeButton(this._upgradeButton)},_setupRemoveButton:function(){var self=this;this._removeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("pipeline_collaborator_remove_from_plan"),color:"blue",onFunction:function(){self._removeButtonPressed()}});this._view.setRemoveButton(this._removeButton)},_setupHelpButton:function(){var self=this;this._helpButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("pipeline_collaborator_learn_more"),color:"blue",onFunction:function(){self._helpButtonPressed()}});this._view.setHelpButton(this._helpButton)},_emailButtonPressed:function(){Tracker.track("lockdownWarning.emailButtonPressed");var self=this;Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){composeWindowViewController.setToAddresses(_.map(self._peopleToEmail,function(collaborator){return collaborator.user.email}));composeWindowViewController.setSubject(Locale.getString("pipeline_collaborator_email_subject",{pipeline:self._pipeline.get("name")}));var body=self._problemsBody();composeWindowViewController.setEmailBody(body.innerHTML)})},_problemsBody:function(){var self=this;var body=$("<div></div>");var prelude=Locale.getString(this._orgWideCollaborators?"pipeline_collaborator_email_body_prelude_org_wide":"pipeline_collaborator_email_body_prelude",{pipeline:this._pipeline.get("name"),totalCollaborators:this._totalCollaborators,orgWideCollaborators:this._orgWideCollaborators,explicitCollaborators:this._totalCollaborators-this._orgWideCollaborators});body.append("<p>"+prelude+"</p>");var problemList=$("<ul></ul>");_.each(this._problems,function(problem){var listElement=$("<li></li>");if(problem.problem===PROBLEMS.USER_HAS_NO_PLAN){listElement.html(Locale.getString("pipeline_collaborator_problem_user_no_plan",{user:problem.collaborator.user.email,totalCollaborators:self._totalCollaborators}))}else if(problem.problem===PROBLEMS.USER_PLAN_IS_TOO_SMALL){listElement.html(Locale.getString("pipeline_collaborator_problem_user_small_plan",{user:problem.collaborator.user.email,totalCollaborators:self._totalCollaborators}))}else if(problem.problem===PROBLEMS.BILLING_ADMIN_PLAN_TOO_SMALL){return}else{throw new Error("Unknown problem type")}problemList.append(listElement)});body.append(problemList);if(this._status==="WARNING"){var warningMessage=Locale.getString("pipeline_collaborator_email_body_end_warning",{days:this._daysRemaining});body.append("<p>"+warningMessage+"</p>")}if(this._status==="LOCKDOWN"){var lockdownMessage=Locale.getString("pipeline_collaborator_email_body_end_lockdown");body.append("<p>"+lockdownMessage+"</p>")}return body[0]},_upgradeButtonPressed:function(){Tracker.track("lockdownWarning.upgradeButtonPressed");var paywallViewControllerInstance=Library.get("BentoBox.Modules.Paywall.PaywallViewControllerInstance");paywallViewControllerInstance.switchToViewToUpgradePlan({peopleToAdd:this._peopleToAdd,numberOfPeopleNeededOnNewPlan:this._totalCollaborators>this.getPlanCollaboratorLimit()?this._totalCollaborators:null})},_removeButtonPressed:function(){Tracker.track("lockdownWarning.removeButtonPressed");var ShareButton=BB.Modules.PipelineView.ShareButton;ShareButton.updateOptions({pipeline:this._pipeline});ShareButton.showModal()},_helpButtonPressed:function(){Tracker.track("lockdownWarning.learnMorePressed");if(!this._helpModal){this._helpModal=Library.getInstance("BentoBox.Widgets.Tour.BottomModal");this._helpModal.setup({title:Locale.getString("pipeline_collaborator_help_title"),body:this._getHelpBody(),displayAlone:true,finishFunction:this._removeHelpModal.bind(this)});this._helpModal.show()}},_getHelpBody:function(){var self=this;var body=$("<div></div>");var helpBodyPart1=Locale.getString("pipeline_collaborator_lockdown_help_body1",{pipeline:this._pipeline.displayName(),totalCollaborators:this._totalCollaborators,neededPlan:neededPlan});body.append("<p>"+helpBodyPart1+"</p>");var problemList=$("<ul></ul>");_.each(this._problems,function(problem){var listElement=$("<li></li>");if(problem.problem===PROBLEMS.USER_HAS_NO_PLAN){listElement.text(problem.collaborator.user.email)}else if(problem.problem===PROBLEMS.USER_PLAN_IS_TOO_SMALL){listElement.text(problem.collaborator.user.email)}else if(problem.problem===PROBLEMS.BILLING_ADMIN_PLAN_TOO_SMALL){return}else{throw new Error("Unknown problem type")}problemList.append(listElement)});body.append(problemList);var neededPlan;if(this._totalCollaborators>5){neededPlan="Starter Plan"}if(this._totalCollaborators>10){neededPlan="Corporate Plan"}if(this._totalCollaborators>25){neededPlan="Enterprise Plan"}var neededPlanText=Locale.getString("pipeline_collaborator_lockdown_help_neededPlan",{neededPlan:neededPlan});body.append(neededPlanText);if(this._status==="WARNING"){var warningMessage=Locale.getString("pipeline_collaborator_email_body_end_warning",{days:this._daysRemaining});body.append("<p>"+warningMessage+"</p>")}if(this._status==="LOCKDOWN"){var lockdownMessage=Locale.getString("pipeline_collaborator_email_body_end_lockdown");body.append("<p>"+lockdownMessage+"</p>")}var removeCollaboratorsWrapper=$(document.createElement("div"));removeCollaboratorsWrapper.addClass("streak__pipelineLockdownHelp_removeCollaboratorsWrapper");if(this._canUpgradeUsers){this._helpUpgradeAllButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:Locale.getString("upgrade_all_users"),onFunction:this._upgradeButtonPressed.bind(this)});var helpButtonWrapper=$(document.createElement("div"));helpButtonWrapper.addClass("streak__pipelineLockdownHelp_upgradeButton");helpButtonWrapper.append(this._helpUpgradeAllButton.getElement());body.append(helpButtonWrapper);removeCollaboratorsWrapper.addClass("streak__pipelineLockdownHelp_removeCollaboratorsWrapperWithUpgradeButton");removeCollaboratorsWrapper.append(BB.Locale.getString("or"))}this._removeCollaboratorsLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("remove_some_collaborators"),onFunction:function(){BB.Modules.PipelineView.ShareButton.updateOptions({pipeline:self._pipeline}).showModal()}});removeCollaboratorsWrapper.append(this._removeCollaboratorsLink.getElement());body.append(removeCollaboratorsWrapper);return body},_removeHelpModal:function(){if(this._helpModal){this._helpModal.destroy()}delete this._helpModal},_billingPlanLoaded:function(){return this._billingPlanInstances&&this._billingPlanInstances.getHasLoaded()},_userPlanLoaded:function(){return this._participatingPlans&&this._participatingPlans.getHasLoaded()},getPlanName:function(){if(this.getUserPlan()){this.getUserPlan().getLocalizedName()}else{return Locale.getString("free_plan_name")}},getPlanCollaboratorLimit:function(){if(this.getUserPlan()){this.getUserPlan().get("collaboratorLimit")}else{return 5}},getEmailFromCollaborator:function(collaborator){return collaborator.user.email},getDisplayNameFromCollaborator:function(collaborator){return collaborator.user.displayName},_clearTimedUpdate:function(){if(this._timedUpdateID){clearInterval(this._timedUpdateID);this._timedUpdateID=null}},_setupTimedUpdate:function(){this._clearTimedUpdate();this._timedUpdateID=setInterval(this._updateCollaboratorStatus.bind(this),1e3*60*60)}});Library.set("BentoBox.Widgets.PipelineLockdownWarningViewController",PipelineLockdownWarningViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var SearchSimpleVC=function(){Streak.ViewControllerBase.call(this);this._view=new BB.Widgets.SearchSimpleView;this._view.addDelegate(this);this._suppressTab=false};SearchSimpleVC.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SearchSimpleVC.prototype,{reset:function(){this._view.reset()},focus:function(){this._view.focus()},getFocusElement:function(){return this._view.getFocusElement()},setPlaceholder:function(placeholder){this._view.setPlaceholder(placeholder)},clearQuery:function(){this._view.clearQuery();this.queryChange("")},setQuery:function(query){this._view.setQuery(query)},setEnabled:function(enabled){this._view.setEnabled(enabled)},getView:function(){return this._view},queryChange:function(query){this._callDelegateFunction("queryChange",query)},getQuery:function(){return this._view.getQuery()},keyPressed:function(keyCode,isCursorAtEnd){this._callDelegateFunction("keyPressed",keyCode,isCursorAtEnd)},keydown:function(event){this._callDelegateFunction("keydown",event);if(this._suppressTab){if(Streak.jwerty.is("tab",event)){event.preventDefault()}}},setSupressTab:function(value){this._suppressTab=value},destroy:function(){Streak.ViewControllerBase.prototype.destroy.call(this);this._view.destroy()},inputFocus:function(e){this._callDelegateFunction("inputFocus",e)},inputBlur:function(e){this._callDelegateFunction("inputBlur",e)},isEmpty:function(){return this._view.isEmpty()}});BB.Widgets.SearchSimpleVC=SearchSimpleVC})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var SearchSimpleView=function(options){Streak.ViewControllerBase.call(this);this._el=$(HTML.get("simpleSearchMain")());this._initInput()};SearchSimpleView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SearchSimpleView.prototype,{_initInput:function(){this._input=this._el.find(".streak__simpleinput");this._setupKeybinding();this._setupFocusBlurEvents()},_setupKeybinding:function(){var self=this;this._input.off("keyup");this._input.on("keyup",function(e){if(self._currValue!==self._input.val()){self._queryChange(self._input.val())}self._callDelegateFunction("keyPressed",e.which,self._isCursorAtEnd());e.stopPropagation()});this._input.off("keydown");this._input.on("keydown",function(e){self._callDelegateFunction("keydown",e);if(Streak.jwerty.is("down/up",e)){e.preventDefault()}})},_setupFocusBlurEvents:function(){var self=this;this._input.on("focus",function(e){self._callDelegateFunction("inputFocus",e);self._el.addClass("acm");self._el.removeClass("aco")});this._input.on("blur",function(e){self._callDelegateFunction("inputBlur",e);self._el.addClass("aco");self._el.removeClass("acm")})},setPlaceholder:function(placeholder){if(!_.isReal(placeholder)){return}this._input[0].setAttribute("placeholder",placeholder)},getEl:function(){return this._el},getElement:function(){return this._el},getFocusElement:function(){return this._input},focus:function(){this._input.focus()},clearQuery:function(){this._input.val("");this._currValue=""},setQuery:function(query){this._input.val(query);this._queryChange(query)},getQuery:function(){return this._input.val()},reset:function(){this._setupKeybinding();this.clearQuery()},setEnabled:function(enabled){this._input.prop("disabled",!enabled);if(enabled){this._el.removeClass("disabled")}else{this._el.addClass("disabled")}},_queryChange:function(query){this._currValue=query;this._callDelegateFunction("queryChange",query)},_isCursorAtEnd:function(){return this._input.caret().start>=this._input.val().length},isEmpty:function(){return this._input.val().length===0},destroy:function(){Streak.ViewControllerBase.prototype.destroy.call(this);this._el.remove()}});BB.Widgets.SearchSimpleView=SearchSimpleView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date;var CursorController=function(){Streak.ViewControllerBase.call(this)};CursorController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(CursorController.prototype,{keyPressed:function(keycode,isCursorAtEnd){if(keycode===jwerty.KEYS.keys.right){this._callDelegateFunction("cursorRight",isCursorAtEnd)}if(keycode===jwerty.KEYS.keys.left){this._callDelegateFunction("cursorLeft")}},keydown:function(event,isCursorAtEnd){var keycode=event.which;if(jwerty.is("enter",event)){this._callDelegateFunction("cursorEnter");event.preventDefault();event.stopPropagation()}if(keycode===jwerty.KEYS.keys.up){this._callDelegateFunction("cursorUp");event.preventDefault()}if(keycode===jwerty.KEYS.keys.down){this._callDelegateFunction("cursorDown");event.preventDefault()}}});BB.Modules.CursorController=CursorController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesDetailsVC=function(){this._delegates=[];this._view=new BB.Widgets.BoxesDetailsView};_.extend(BoxesDetailsVC.prototype,{setModel:function(model){this._model=model;this._view.setModel(model)},getView:function(){var self=this;return self._view},hideView:function(){var self=this;self._view.hide()},addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},destroy:function(){this._view.destroy()}});BB.Widgets.BoxesDetailsVC=BoxesDetailsVC})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesDetailsView=function(){var self=this;self._delegates=[];self._el=$(HTML.get("boxesDetailsPaneHolder")({}));self._templates={};self._templates.boxDetails=HTML.get("boxesDetailsPane")};_.extend(BoxesDetailsView.prototype,{getEl:function(){return this._el},getElement:function(){return this._el},setModel:function(model){var self=this;self._model=model;self._refresh()},hide:function(){var self=this;self._el.hide()},_refresh:function(){var self=this;self._el.show();var boxNameEl=self._el.find(".streak__boxname");self._el.empty();var details=self._displayBox(self._model);self._el.append(details)},addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},_displayBox:function(box){var self=this;var pipeline=box.getPipeline();var details=$(self._templates.boxDetails());details.find(".boxName").text(box.get("name"));details.find(".pipelineName").text(BB.Locale.getString("in")+" "+pipeline.displayName());if(box.get("notes")){details.find(".boxNotes").show();details.find(".boxNotes").plainText(box.get("notes"))}else{details.find(".boxNotes").hide()}var text="<b>"+BB.Locale.getString("stage")+":</b>"+box.getStageName();var fields=pipeline.getFields();for(var i=0;i<fields.length;i++){var val=box.getFieldTextValue(fields[i].key());if(val){if(text.length>0){text+="<br />"}text+="<b>"+pipeline.getFields()[i].displayName()+":</b>"+_.escape(val)}}details.find(".boxFieldValues").html(text);return details},destroy:function(){this._el.remove()}});BB.Widgets.BoxesDetailsView=BoxesDetailsView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;BB.Widgets.SidebarAssignedTo={templates:{},defaults:{imgHeight:25,imgWidth:25,numPerRow:-1,border:"never",model:null,delayedBind:false,bindTab:false},init:function(cb){this.templates.wrapper=HTML.get("peoplePicker");if(cb){cb()}},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.SidebarAssignedTo.impl(o)}};BB.Widgets.SidebarAssignedTo.impl=function(options){var newOptions=_.extend(options,{model:options.box,property:"assignedToSharingEntries",existingList:options.pipeline.getAllAssignedToValues(),jsonified:false,onlyValidEmailAddress:true});var peoplePicker=BB.Widgets.PeoplePicker.create(newOptions);Streak.NotificationCenter.subscribe({eventName:"409Conflict",filterParameters:{model:options.box},observer:peoplePicker,functionToCall:function(){peoplePicker.updateDisplay(true)}});return peoplePicker};Streak.DependencyManager.addFunction({functionKey:"widgets.sidebarAssignedTo.initialized",functionToCall:BB.Widgets.SidebarAssignedTo.init,functionContext:BB.Widgets.SidebarAssignedTo,dependentFunctionKeys:["htmlLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ButtonFactory=function(){};_.extend(ButtonFactory.prototype,{createButton:function(options){options.buttonType=this._getButtonType(options);return BB.Widgets.Buttons.NewButton.create(options)},createToggleButton:function(options){options.buttonType=this._getButtonType(options);return BB.Widgets.Buttons.ToggleButton.create(options)},createMenuButton:function(options){options.buttonType=this._getButtonType(options);var button;if(options.isFixedPosition){button=BB.Widgets.Buttons.FixedPositionMenuButton.create(options)}else{button=BB.Widgets.Buttons.MenuButton.create(options)}return button},createTooltipMenuButton:function(options){options.buttonType=this._getButtonType(options);return new BB.Widgets.Buttons.TooltipMenuButton(options)},createSplitMenuButton:function(options){options.buttonType=this._getButtonType(options);return new BB.Widgets.Buttons.SplitMenuButton(options)},createMultiSelectMenuButton:function(options){options.buttonType=this._getButtonType(options);return new BB.Widgets.Buttons.MultiSelectMenuButton(options)}});_.extend(ButtonFactory.prototype,{_getButtonType:function(options){return new BB.Widgets.Buttons.ButtonTypes[options.type+"ButtonType"](options)}});BB.Widgets.Buttons={ButtonTypes:{}};DependencyManager.addFunction({functionKey:"buttonFactoryInitialized",functionToCall:function(callback){BB.Widgets.Buttons.ButtonFactory=new ButtonFactory;if(callback){callback()}}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;var Button={classes:{normal:{inactive:"T-I-ax7",hover:"T-I-JW",active:"T-I-Kq"},blue:{inactive:"T-I-atl",hover:"T-I-JW",active:"T-I-JO"},red:{inactive:"T-I-KE",hover:"T-I-JW",active:"T-I-JO"},icon:{inactive:"J-Z-I",hover:"J-Z-I-JW",active:"J-Z-I-KO"}},defaults:{button:{name:null,nameText:null,isRefresh:false,isToggle:false,enableDepressedState:true,onFunc:$.noop,offFunc:$.noop,color:"normal",hasButtonToLeft:false,hasButtonToRight:false,customButton:null,onClass:null,hoverClass:null,isDropdown:false,isOn:false,iconClassName:undefined,tooltip:undefined,tabIndex:0},group:{}},templates:{button:null,group:null,refresh:null},init:function(cb){Button.templates.refresh=HTML.get("refreshButton");if(cb){cb()}},create:function(options){var o={};_.extend(o,this.defaults.button,options);return new this.impl(o)},createGroup:function(options){var o={};_.extend(o,this.defaults.group,options);return new this.groupImpl(o)}};Button.impl=function(o){var options=o,isOn=options.isOn;var el=null;var innerEl=null;var disabled=false;if(options.customButton){el=$(options.customButton)}else{el=$(document.createElement("div"));innerEl=$(document.createElement("div"));el.append(innerEl);if(_.isDefined(options.tooltip)){el.attr("data-tooltip",options.tooltip)}if(_.isDefined(options.iconClassName)){var iconDiv=$("<div class='bbIcon' ></div>");iconDiv.addClass(options.iconClassName);el.prepend(iconDiv);if(options.name){iconDiv.attr("style","vertical-align: middle; padding-top:2px;padding-right: 4px;");innerEl.attr("style","vertical-align: middle; display: inline-block;")}else{iconDiv.attr("style","vertical-align: middle;");el[0].setAttribute("style","min-width: 0px; padding-right: 10px; padding-left: 10px")}}el[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton");el[0].setAttribute("tabindex",options.tabIndex);if(options.isRefresh){innerEl[0].innerHTML=Button.templates.refresh()}else{if(options.name){innerEl.append(options.name)}else if(options.nameText){innerEl.text(options.nameText)}}if(options.isDropdown){innerEl.append('<div class="downArrow G-asx T-I-J3 J-J5-Ji">&nbsp;</div>')}}var on=function(dontCallback,e){if(disabled){return}var butName=options.isRefresh?"refresh":$.trim(el.text());butName=options.overridenTrackingName?options.overridenTrackingName:butName;if(o.isToggle){if(o.enableDepressedState){if(options.customButton){el.addClass(options.onClass)}else{el.addClass("J-Zh-I-Jo").addClass("J-Zh-I-Kq").addClass("bbActive").addClass(Button.classes[options.color].active)}}isOn=true;if(options.enableDepressedState){el.trigger("hold")}}if(!dontCallback){options.onFunc(e)}},setOnFunc=function(fxn){options.onFunc=fxn},off=function(dontCallback,e){if(isOn){if(!dontCallback)options.offFunc(e)}isOn=false;el.trigger("unhold");if(o.enableDepressedState){if(options.customButton){el.removeClass(options.onClass)}else{el.removeClass("J-Zh-I-Jo").removeClass("J-Zh-I-Kq").removeClass("bbActive").removeClass(Button.classes[options.color].active)}}};if(options.hasButtonToRight){el.addClass("T-I-Js-IF")}if(options.hasButtonToLeft){el.addClass("T-I-Js-Gs")}if(options.customButton){if(options.hoverClass){el.easyHoverClass(options.hoverClass)}}else{el.addClass(Button.classes[options.color].inactive);el.easyHoverClass(Button.classes[options.color].hover+" J-Zh-I-JW")}el.click(function(e){if(isOn){off(false,e)}else{on(false,e)}e.stopPropagation()});BB.Keyboard.bindChordToElement(el,"enter/space",function(){if(isOn){off()}else{on()}},true,true);return{setOnFunc:setOnFunc,el:el,innerEl:innerEl,on:on,off:off,getElement:function(){return el},changeIconByClass:function(oldClass,newClass){if(_.isDefined(iconDiv)){iconDiv.removeClass(oldClass);iconDiv.addClass(newClass)}},toggleRoundLeft:function(){var className="T-I-Js-Gs";if(_.isDefined(el)&&el.hasClass(className)){el.removeClass(className)}else if(_.isDefined(el)){el.addClass(className)}},toggleRoundRight:function(){var className="T-I-Js-IF";if(_.isDefined(el)&&el.hasClass(className)){el.removeClass(className)}else if(_.isDefined(el)){el.addClass(className)}},disable:function(){if(!options.customButton){el.addClass("T-I-JE")}el.trigger("disabled");disabled=true},enable:function(){if(!options.customButton){el.removeClass("T-I-JE")}el.trigger("enabled");disabled=false},destroy:function(){innerEl.remove();el.remove()}}};Button.groupImpl=function(o){var options=o,el=$(document.createElement("div"));el[0].setAttribute("class","VP5otc-HT6HAf J-J5-Ji G-Ni bbButtonGroup");return{el:el,destroy:function(){el.remove()}}};Streak.DependencyManager.addFunction({functionKey:"widgets.button.initialized",functionToCall:Button.init,functionContext:Button,dependentFunctionKeys:["htmlLoaded","localeLoaded"]});BB.Widgets.Button=Button})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;var _defaults={text:"click me",clickFunction:$.noop,stopPropagation:true,preventDefault:true};var LinkButton=function(options){this.el=$("<span/>").addClass("streak__linkButton bbButton").attr("tabindex",0).text(options.text);this.el.on("mousedown",function(e){e.preventDefault()});this.el.on("click",function(e){options.clickFunction();if(options.preventDefault){e.preventDefault()}if(options.stopPropagation){e.stopPropagation()}});var self=this;BB.Keyboard.bindChordToEl({el:this.el,chord:"enter/space",cb:function(){setTimeout(function(){self.el.click()},150)},noDefault:true,noBubble:true,useCapture:true});this.getElement=function(){return this.el}};_.extend(LinkButton.prototype,{getElement:function(){return this.el},destroy:function(){this.el.remove()}});LinkButton.create=function(options){var o=_.extend({},_defaults,options);return new LinkButton(o)};BB.Widgets.LinkButton=LinkButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;BaseButtonType=function(){this._element=null;this._setupElement()};_.extend(BaseButtonType.prototype,{_setupElement:function(){throw new Error("_setupElement not defined")},getElement:function(){return this._element},setText:function(text){this._element.text(text)},setHTML:function(html){this._element[0].innerHTML=html},addClass:function(className){this._element.addClass(className)},removeClass:function(className){this._element.removeClass(className)},setTooltip:function(tooltip){this._element[0].setAttribute("data-tooltip",tooltip)},setTabIndex:function(tabIndex){this._element[0].setAttribute("tabindex",tabIndex)},activate:function(){},deactivate:function(){},setEnabled:function(){},setDisabled:function(){},destroy:function(){this._element.remove()}});BB.Widgets.Buttons.ButtonTypes.BaseButtonType=BaseButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CircleButtonType=function(options){BB.Widgets.Buttons.ButtonTypes.BaseButtonType.call(this);this.setText(options.text)};CircleButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.BaseButtonType.prototype);_.extend(CircleButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("streak__circleButtonType")}});BB.Widgets.Buttons.ButtonTypes.CircleButtonType=CircleButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var IconButtonType=function(options){BB.Widgets.Buttons.ButtonTypes.BaseButtonType.call(this);this.addClass(options.iconClass)};IconButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.BaseButtonType.prototype);_.extend(IconButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("streak__iconButtonType")}});BB.Widgets.Buttons.ButtonTypes.IconButtonType=IconButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox;var GmailButtonType=function(options){this._innerElement=null;this._color=options.color||"default";BB.Widgets.Buttons.ButtonTypes.BaseButtonType.call(this);if(options.text){this.setText(options.text)}else if(options.html){this.setHTML(options.html)}if(options.hasButtonToRight){this.addClass("T-I-Js-IF")}if(options.hasButtonToLeft){this.addClass("T-I-Js-Gs")}};GmailButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.BaseButtonType.prototype);_.extend(GmailButtonType.prototype,{classes:{"default":{INACTIVE_CLASS:"T-I-ax7",HOVER_CLASS:"T-I-JW",ACTIVE_CLASS:"T-I-Kq"},blue:{INACTIVE_CLASS:"T-I-atl",HOVER_CLASS:"T-I-JW",ACTIVE_CLASS:"T-I-JO"},red:{INACTIVE_CLASS:"T-I-KE",HOVER_CLASS:"T-I-JW",ACTIVE_CLASS:"T-I-JO"},icon:{INACTIVE_CLASS:"J-Z-I",HOVER_CLASS:"J-Z-I-JW",ACTIVE_CLASS:"J-Z-I-KO"},green:{INACTIVE_CLASS:"streak__gmailButton_green_inactive",HOVER_CLASS:"streak__gmailButton_green_hover",ACTIVE_CLASS:"streak__gmailButton_green_active"}},_setupElement:function(){this._element=$(document.createElement("div"));this._innerElement=$(document.createElement("div"));this._element.append(this._innerElement);this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton "+this.classes[this._color].INACTIVE_CLASS);this._element[0].setAttribute("tabIndex",-1);this._setupHoverEvents()},_setupHoverEvents:function(){this._element.easyHoverClass(this.classes[this._color].HOVER_CLASS)},getElement:function(){return this._element},setText:function(text){this._innerElement.text(text)},setHTML:function(html){this._innerElement[0].innerHTML=html},activate:function(){this.addClass(this.classes[this._color].ACTIVE_CLASS+" "+this.classes[this._color].HOVER_CLASS)},deactivate:function(){this.removeClass(this.classes[this._color].ACTIVE_CLASS+" "+this.classes[this._color].HOVER_CLASS)},setEnabled:function(){this._element.css("opacity","")},setDisabled:function(){this._element.css("opacity",.55)},setColor:function(color){this._color=color;this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton "+this.classes[this._color].INACTIVE_CLASS)},destroy:function(){this._innerElement.remove();this._element.remove()}});BB.Widgets.Buttons.ButtonTypes.GmailButtonType=GmailButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailIconButtonType=function(options){this._innerElement=null;BB.Widgets.Buttons.ButtonTypes.GmailButtonType.call(this,options);this.changeIconClass(options.iconClass)};GmailIconButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype);_.extend(GmailIconButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton G-Ni "+this.classes[this._color].INACTIVE_CLASS);this._innerElement=$(document.createElement("div"));this._rawIconElement=document.createElement("div");this._rawIconElement.innerHTML="&nbsp;";this._element.append(this._innerElement);this._innerElement.append(this._rawIconElement);this._setupHoverEvents()},setText:function(){},changeIconClass:function(className){this._rawIconElement.setAttribute("class",className)}});BB.Widgets.Buttons.ButtonTypes.GmailIconButtonType=GmailIconButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailArrowButtonType=function(options){this._innerElement=null;BB.Widgets.Buttons.ButtonTypes.GmailButtonType.call(this,options);this.setText(options.text)};GmailArrowButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype);_.extend(GmailArrowButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton streak__GmailArrowButtonType G-Ni "+this.classes[this._color].INACTIVE_CLASS);this._innerElement=$(document.createElement("div"));this._innerElement[0].innerHTML='<div class="downArrow G-asx T-I-J3 - J-J5-Ji">&nbsp;</div>';this._element.append(this._innerElement);this._rawTextElement=document.createElement("span");this._rawTextElement.setAttribute("class","buttonText");this._innerElement.prepend(this._rawTextElement);this._setupHoverEvents()},setText:function(text){if(!text){$(this._rawTextElement).hide()}else{$(this._rawTextElement).show();this._rawTextElement.innerHTML=_.escape(text)}},setHTML:function(html){if(!html){$(this._rawTextElement).hide()}else{$(this._rawTextElement).show();this._rawTextElement.innerHTML=html}}});BB.Widgets.Buttons.ButtonTypes.GmailArrowButtonType=GmailArrowButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailIconArrowButtonType=function(options){this._innerElement=null;BB.Widgets.Buttons.ButtonTypes.GmailButtonType.call(this,options);this.changeIconClass(options.iconClass);this.setText(options.text)};GmailIconArrowButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype);_.extend(GmailIconArrowButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton streak__gmailIconArrowButtonType G-Ni "+this.classes[this._color].INACTIVE_CLASS);this._innerElement=$(document.createElement("div"));this._innerElement[0].innerHTML='<div class="downArrow G-asx T-I-J3 - J-J5-Ji">&nbsp;</div>';this._element.append(this._innerElement);this._rawIconElement=document.createElement("span");this._rawTextElement=document.createElement("span");this._rawTextElement.setAttribute("class","buttonText streak__gmailIconArrowButtonType_text");this._innerElement.prepend(this._rawTextElement);this._innerElement.prepend(this._rawIconElement);this._setupHoverEvents()},setText:function(text){this._rawTextElement.innerHTML=_.escape(text)},setHTML:function(html){this._rawTextElement.innerHTML=html},changeIconClass:function(className){this._rawIconElement.setAttribute("class",className)
}});BB.Widgets.Buttons.ButtonTypes.GmailIconArrowButtonType=GmailIconArrowButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailTextIconButtonType=function(options){this._innerElement=null;BB.Widgets.Buttons.ButtonTypes.GmailButtonType.call(this,options);this.changeIconClass(options.iconClass);this.setText(options.text)};GmailTextIconButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype);_.extend(GmailTextIconButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton G-Ni "+this.classes[this._color].INACTIVE_CLASS);this._innerElement=$(document.createElement("div"));this._rawIconElement=document.createElement("div");this._rawIconElement.innerHTML="&nbsp;";this._element.append(this._innerElement);this._innerElement.append(this._rawIconElement);this._setupHoverEvents()},setText:function(text){$(this._rawIconElement).detach();this._innerElement.text(text);this._innerElement.prepend(this._rawIconElement)},setHTML:function(html){$(this._rawIconElement).detach();this._innerElement.html(html);this._innerElement.prepend(this._rawIconElement)},changeIconClass:function(className){this._rawIconElement.setAttribute("class",className)}});BB.Widgets.Buttons.ButtonTypes.GmailTextIconButtonType=GmailTextIconButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailSplitArrowButtonType=function(options){this._mainButton=null;this._arrowButton=null;this._color=options.color||"default";BB.Widgets.Buttons.ButtonTypes.GmailButtonType.call(this,options);this.setText(options.text)};GmailSplitArrowButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype);_.extend(GmailSplitArrowButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("J-J5-Ji streak__gmailSplitArrowButtonType T-I");this._setupMainButton();this._setupArrowButton()},_setupMainButton:function(){this._mainButton=new BB.Widgets.Buttons.ButtonTypes.GmailButtonType({hasButtonToRight:true});this._element.append(this._mainButton.getElement())},_setupArrowButton:function(){this._arrowButton=$(document.createElement("div"));this._arrowButton[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton streak__GmailArrowButtonType G-Ni T-I-Js-Gs "+BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].INACTIVE_CLASS);this._arrowButton[0].innerHTML='<div class="downArrow G-asx T-I-J3 - J-J5-Ji">&nbsp;</div>';this._element.append(this._arrowButton)},_setupHoverEvents:function(){},getMainClickableElement:function(){return this._mainButton.getElement()},getMenuClickableElement:function(){return this._arrowButton},getElement:function(){return this._element},setText:function(text){this._mainButton.setText(text);return this},setHTML:function(html){this._mainButton.setHTML(html);return this},activate:function(){this._arrowButton.addClass(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].ACTIVE_CLASS+" "+BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].HOVER_CLASS);return this},deactivate:function(){this._arrowButton.removeClass(BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].ACTIVE_CLASS+" "+BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].HOVER_CLASS);return this},setEnabled:function(){this._element.css("opacity","");return this},setDisabled:function(){this._element.css("opacity",.55);return this},disableMenu:function(){this._arrowButton.css("opacity",.55);return this},enableMenu:function(){this._arrowButton.css("opacity","");return this},setColor:function(color){this._color=color;this._mainButton.setColor(color);this._arrowButton[0].setAttribute("class","T-I J-J5-Ji ar7 L3 J-Zh-I bbButton streak__GmailArrowButtonType G-Ni T-I-Js-Gs "+BB.Widgets.Buttons.ButtonTypes.GmailButtonType.prototype.classes[this._color].INACTIVE_CLASS);return this},destroy:function(){this._mainButton.destry();this._element.remove()}});Library.set("BentoBox.Widgets.Buttons.ButtonTypes.GmailSplitArrowButtonType",GmailSplitArrowButtonType)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;TextButtonType=function(options){BB.Widgets.Buttons.ButtonTypes.BaseButtonType.call(this);if(options.text){this.setText(options.text)}else if(options.html){this.setHTML(options.html)}this.setColor(options.color)};TextButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.BaseButtonType.prototype);_.extend(TextButtonType.prototype,{classes:{blue:"streak__textButton_blue",cornflowerblue:"streak__textButton_cornflowerBlue",lightblue:"streak__textButton_lightBlue"},_setupElement:function(){this._element=$(document.createElement("span"));this._element.addClass("streak__textButton");this.setTabIndex(-1)},setColor:function(color){if(!color){return}this._element.addClass(this.classes[color])}});BB.Widgets.Buttons.ButtonTypes.TextButtonType=TextButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;TextArrowButtonType=function(options){BB.Widgets.Buttons.ButtonTypes.TextButtonType.call(this,options);this.setText(options.text);this.setColor(options.color)};TextArrowButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.TextButtonType.prototype);_.extend(TextArrowButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("streak__textButton streak__textArrowButton");this._element[0].innerHTML='<span class="streak__textArrowButton_text"></span><div class="downArrow G-asx T-I-J3 - J-J5-Ji">&nbsp;</div>'},setText:function(newText){this._element.find(".streak__textArrowButton_text").text(newText)},getMainClickableElement:function(){return this._element.find(".streak__textArrowButton_text")},getMenuClickableElement:function(){return this._element.find(".downArrow")}});BB.Widgets.Buttons.ButtonTypes.TextArrowButtonType=TextArrowButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;XButtonType=function(options){BB.Widgets.Buttons.ButtonTypes.BaseButtonType.call(this)};XButtonType.prototype=Object.create(BB.Widgets.Buttons.ButtonTypes.BaseButtonType.prototype);_.extend(XButtonType.prototype,{_setupElement:function(){this._element=$(document.createElement("span"));this._element.addClass("Kj-JD-K7-Jq");this._element.addClass("streak__littleX")}});BB.Widgets.Buttons.ButtonTypes.XButtonType=XButtonType})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ButtonMenu={templates:{},defaults:{css:{left:"0px",width:"auto"},buttonCss:{},buttonInner:"",showButtonArrow:true,menuInner:"",onFunc:$.noop,postOnFunc:$.noop,offFunc:$.noop,postOffFunc:$.noop,color:"normal",closeOnSelect:true,customButton:null,onClass:null,hoverClass:null,justMenu:false,dynamicPosition:false,fixedPosition:false,rightAligned:false,bottomAligned:false,menu:null,isLast:false,identityClass:null,attachTo:null},init:function(cb){this.templates.menu=HTML.get("buttonMenuMenu");if(cb){cb()}},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};ButtonMenu.impl=function(o){var options=o,group=BB.Widgets.Button.createGroup(),menu=options.menu||$(ButtonMenu.templates.menu({inner:options.menuInner})),justMenu=options.justMenu,visible=false,menuOff=null,menuOn=null;if(options.trackingContext){options.trackingContext.widgetContext="/buttonMenu"}group.el.addClass(options.identityClass);var on=function(e){visible=true;if(!options.onFunc(e)){menu.show();if(options.dynamicPosition){}else if(options.fixedPosition){menu.css({position:"fixed",left:"auto"})}else if(options.isLast){menu.css({left:-1*menu.width()})}if(options.bottomAligned){if(options.fixedPosition){menu.css("bottom",Gmail.elements.body[0].clientHeight-buttonEl.offset().top+"px")}else{menu.css("bottom",button.el.outerHeight()+"px")}}else{if(options.fixedPosition){menu.css("top",buttonEl.offset().top+buttonEl.outerHeight()+"px")}}if(options.rightAligned){var anchorEl=options.justMenu?button:button.el;var left;if(options.dynamicPosition){left=anchorEl.position().left}else if(options.fixedPosition){left=anchorEl.offset().left}menu.css({left:left+(anchorEl.outerWidth()-menu.outerWidth())});menu.css({minWidth:menu.width()})}if(options.fixedPosition){menu.containByScreen(buttonEl)}if(options.postOnFunc){options.postOnFunc(e)}if(e){e.stopPropagation()}menu.bodyCloseAndStop({closeFunction:function(){if(visible&&!justMenu){button.off()}else if(visible&&justMenu){off()}},body:Gmail.elements.body,stop:justMenu?button[0]:group.el[0]})}},off=function(e){visible=false;options.offFunc(e);menu.hide();if(options.postOffFunc){options.postOffFunc(e)}if(e){e.stopPropagation()}menu.unbindBodyCloseAndStop()},isOn=function(){return visible},button=null,buttonEl=null;if(justMenu){menuOff=off;menuOn=on;button=options.customButton;button.click(function(e){if(visible){off()}else{on()}});buttonEl=button}else{button=BB.Widgets.Button.create({name:options.buttonInner,isToggle:true,onFunc:function(e){on(e)},offFunc:function(e){off(e)},color:options.color,hasButtonToLeft:options.hasButtonToLeft,hasButtonToRight:options.hasButtonToRight,customButton:options.customButton,onClass:options.onClass,hoverClass:options.hoverClass,isDropdown:options.showButtonArrow});buttonEl=button.el;button.el.css(options.buttonCss);group.el.append(button.el);if(options.attachTo){options.attachTo.append(menu)}else{group.el.append(menu)}}menu.hide();menu.css(options.css);menu.click(function(e){if(options.closeOnSelect){button.off()}e.stopPropagation()});var setEnabled=function(enabled){if(button&&button.enable&&button.disable){if(enabled){button.enable()}else{button.disable()}}};return{el:group.el,group:group,button:button,menu:menu,setEnabled:setEnabled,on:menuOn||button.on,off:menuOff||button.off,isOn:isOn,getElement:function(){return group.el},getButtonElement:function(){return buttonEl},updateOptions:function(newOptions){_.extend(options,newOptions)},destroy:function(){if(_.isFunction(button.destroy)){button.destroy()}menu.remove();group.destroy()}}};Streak.DependencyManager.addFunction({functionKey:"widgets.buttonMenu.initialized",functionToCall:ButtonMenu.init,functionContext:ButtonMenu,dependentFunctionKeys:["htmlLoaded","localeLoaded"]});BB.Widgets.ButtonMenu=ButtonMenu})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;var defaults={buttonType:null,onFunction:$.noop};var NewButton=function(inOptions){var options=_.extend({},defaults,inOptions);BB.Widgets.Widget.call(this,options);this._isDisabled=false;this._buttonType=options.buttonType;this._setupEventBindings(options.useEventBubbling)};NewButton.prototype=Object.create(BB.Widgets.Widget.prototype);_.extend(NewButton.prototype,{on:function(){if(this._isDisabled){this.getElement().simulateHover();return}if(this.options.onFunction){this.options.onFunction()}},enable:function(){if(!this._isDisabled){return}this._isDisabled=false;this._buttonType.setEnabled()},disable:function(){if(this._isDisabled){return}this._isDisabled=true;this._buttonType.setDisabled()},toggleDisabled:function(disabled){if(disabled){this.disable()}else{this.enable()}},setColor:function(color){this._buttonType.setColor(color)},setText:function(text){this._buttonType.setText(text)},setHTML:function(html){this._buttonType.setHTML(html)},addClass:function(className){this._buttonType.addClass(className)},removeClass:function(className){this._buttonType.removeClass(className)},setTooltip:function(tooltip){this._buttonType.setTooltip(tooltip)},setTabIndex:function(tabIndex){this._buttonType.setTabIndex(tabIndex)},changeIconClass:function(iconClass){this._buttonType.changeIconClass(iconClass)},setOnFunction:function(callback){if(!this.options){this.options={}}this.options.onFunction=callback},destroy:function(){this._buttonType.destroy()},getElement:function(){return this._buttonType.getElement()},_setupEventBindings:function(useEventBubbling){var self=this;this.getElement()[0].addEventListener("click",function(e){self._buttonClicked();e.preventDefault();e.stopImmediatePropagation()},!useEventBubbling);BB.Keyboard.bindChordToEl({el:this.getElement(),chord:"enter/space",cb:function(){setTimeout(function(){self._buttonClicked()},150)},noDefault:true,noBubble:true,useCapture:true})},_buttonClicked:function(){this.on()}});NewButton.create=function(inOptions){return new NewButton(inOptions)};NewButton.classes={normal:{inactive:"T-I-ax7",hover:"T-I-JW",active:"T-I-Kq"},blue:{inactive:"T-I-atl",hover:"T-I-JW",active:"T-I-JO"},red:{inactive:"T-I-KE",hover:"T-I-JW",active:"T-I-JO"},icon:{inactive:"J-Z-I",hover:"J-Z-I-JW",active:"J-Z-I-KO"}};BB.Widgets.Buttons.NewButton=NewButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var defaults={holdOnState:true,noDeactivation:false};var ToggleButton=function(inOptions){var options=_.extend({},defaults,inOptions);BB.Widgets.Buttons.NewButton.call(this,options);this._isOn=inOptions.isOn||false;this._noDeactivation=inOptions.noDeactivation;if(!this._isOn&&!this._noDeactivation){this._buttonType.deactivate()}};ToggleButton.prototype=Object.create(BB.Widgets.Buttons.NewButton.prototype);_.extend(ToggleButton.prototype,{on:function(){if(this._isDisabled){this.getElement().simulateHover();return}this._isOn=true;BB.Widgets.Buttons.NewButton.prototype.on.call(this);if(!this._noDeactivation){this._buttonType.activate()}},off:function(){if(this._isDisabled){this.getElement().simulateHover();return}this._isOn=false;if(!this._noDeactivation){this._buttonType.deactivate()}if(this.options.offFunction){this.options.offFunction()}},_buttonClicked:function(){if(this._isOn){this.off()}else{this.on()}}});ToggleButton.create=function(inOptions){return new ToggleButton(inOptions)};BB.Widgets.Buttons.ToggleButton=ToggleButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var defaults={menu:null,preOnFunction:null,postOnFunction:null,preOffFunction:null,postOffFunction:null,doesEscapeCloseMenu:true,menuClickTriggersOff:false};var MenuButton=function(inOptions){if(!inOptions.menu){throw new Error("need a menu widget")}var options=_.extend({},defaults,inOptions);BB.Widgets.Buttons.ToggleButton.call(this,options);this._escapeUnbinder=null};MenuButton.prototype=Object.create(BB.Widgets.Buttons.ToggleButton.prototype);_.extend(MenuButton.prototype,{on:function(){if(this._isDisabled){this.getElement().simulateHover();return}if(this.options.preOnFunction){if(this.options.preOnFunction()){return}}BB.Widgets.Buttons.ToggleButton.prototype.on.call(this);this._showMenu();if(this.options.postOnFunction){this.options.postOnFunction()}if(!this.options.noCloseOnOutsideClick){this._registerGlobalClickBinding()}},_showMenu:function(){this._buttonType.getElement().after(this.options.menu.getElement());this.options.menu.getElement().show();this.options.menu.getElement().css({position:"",top:"",bottom:"",left:"",right:""})},off:function(){if(this._isDisabled){this.getElement().simulateHover();return}if(this.options.preOffFunction){if(this.off.preOffFunction()){return true}}BB.Widgets.Buttons.ToggleButton.prototype.off.call(this);if(!this.options.noCloseOnOutsideClick){this._unregisterGlobalClickBinding()}this._hideMenu();if(this.options.postOffFunction){this.options.postOffFunction()}},_hideMenu:function(){this.options.menu.getElement().detach()},_registerGlobalClickBinding:function(){var self=this;this.options.menu.getElement().bodyCloseAndStop({closeFunction:function(){self.off()},body:Gmail.elements.body,stop:this._buttonType.getElement(),useCapture:this.options.useCapture,stopOnSelf:!this.options.menuClickTriggersOff});if(this.options.doesEscapeCloseMenu){this._escapeUnbinder=BB.Keyboard.bindChordToEl({el:this.options.menu.getElement(),chord:"escape",noBubble:true,noDefault:true,cb:function(){self.off()}})}},_unregisterGlobalClickBinding:function(){this.options.menu.getElement().unbindBodyCloseAndStop();if(this.options.doesEscapeCloseMenu&&this._escapeUnbinder){this._escapeUnbinder()}},destroy:function(){if(this._isOn){this.off()}BB.Widgets.Buttons.ToggleButton.prototype.destroy.call(this)}});MenuButton.create=function(inOptions){if(!inOptions.menu){throw new Error("need a menu widget")}return new MenuButton(inOptions)};BB.Widgets.Buttons.MenuButton=MenuButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var defaults={isBottomAligned:false,isRightAligned:false};var FixedPositionMenuButton=function(inOptions){if(!inOptions.menu){throw new Error("need a menu widget")}var options=_.extend({},defaults,inOptions);BB.Widgets.Buttons.MenuButton.call(this,options)};FixedPositionMenuButton.prototype=Object.create(BB.Widgets.Buttons.MenuButton.prototype);_.extend(FixedPositionMenuButton.prototype,{_showMenu:function(){var menuElement=this.options.menu.getElement();var element=this._buttonType.getElement();Gmail.elements.body.append(menuElement);menuElement[0].style.position="fixed";menuElement.containByScreen(element,this.options)}});FixedPositionMenuButton.create=function(options){return new FixedPositionMenuButton(options)};BB.Widgets.Buttons.FixedPositionMenuButton=FixedPositionMenuButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var defaults={content:null,preOnpreOnFunction:null,postOnFunction:null,preOffFunction:null,postOffFunction:null,doesEscapeCloseMenu:true};var TooltipMenuButton=function(inOptions){if(!inOptions.content){throw new Error("need tooltip content")}var options=_.extend({},defaults,inOptions);options.menu=inOptions.content;BB.Widgets.Buttons.MenuButton.call(this,options);this._tooltipViewController=null};TooltipMenuButton.prototype=Object.create(BB.Widgets.Buttons.MenuButton.prototype);_.extend(TooltipMenuButton.prototype,{_showMenu:function(){this._initializeTooltipViewController();this._tooltipViewController.show();this._tooltipViewController.addArrowClass("streak__tooltipMenuButton_tooltipArrow")},_initializeTooltipViewController:function(){this._destroyTooltip();this._tooltipViewController=new BB.Widgets.TooltipViewController;this._tooltipViewController.setContent(this.options.content);this._tooltipViewController.setTarget(this.getElement());this._tooltipViewController.hideClose();this._tooltipViewController.setPlacement({position:"bottom"});this._tooltipViewController.getView().addClass("streak__tooltipMenuButton_tooltip")},_hideMenu:function(){this._destroyTooltip()},_registerGlobalClickBinding:function(){var self=this;this._tooltipViewController.getView().getElement().bodyCloseAndStop({closeFunction:function(){self.off()},body:Gmail.elements.body,stop:this._buttonType.getElement()});if(this.options.doesEscapeCloseMenu){this._escapeUnbinder=BB.Keyboard.bindChordToEl({el:this._tooltipViewController.getView().getElement(),chord:"escape",noBubble:true,noDefault:true,cb:function(){self.off()}})}},_unregisterGlobalClickBinding:function(){this._tooltipViewController.getView().getElement().unbindBodyCloseAndStop();if(this.options.doesEscapeCloseMenu&&this._escapeUnbinder){this._escapeUnbinder()}},_destroyTooltip:function(){if(!this._tooltipViewController){return}this._tooltipViewController.destroy();this._tooltipViewController=null},destroy:function(){this._destroyTooltip();BB.Widgets.Buttons.MenuButton.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.Buttons.TooltipMenuButton",TooltipMenuButton)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SplitMenuButton=function(inOptions){BB.Widgets.Buttons.FixedPositionMenuButton.call(this,inOptions);this._isMenuDisabled=false};SplitMenuButton.prototype=Object.create(BB.Widgets.Buttons.FixedPositionMenuButton.prototype);_.extend(SplitMenuButton.prototype,{on:function(){if(this._isDisabled){this.getElement().simulateHover();return}if(this.options.preOnFunction){if(this.options.preOnFunction()){return}}this._isOn=true;this._showMenu();if(this.options.postOnFunction){this.options.postOnFunction()}this._registerGlobalClickBinding();this._buttonType.activate()},_setupEventBindings:function(useEventBubbling){var self=this;this._getMainClickableElement()[0].addEventListener("click",function(e){BB.Widgets.Buttons.NewButton.prototype.on.call(self);e.preventDefault();e.stopImmediatePropagation()},!useEventBubbling);BB.Keyboard.bindChordToEl({el:this._getMainClickableElement(),chord:"enter/space",cb:function(){setTimeout(function(){BB.Widgets.Buttons.NewButton.prototype.on.call(self)},150)},noDefault:true,noBubble:true,useCapture:true});this._getMenuClickableElement()[0].addEventListener("click",function(e){if(self._isMenuDisabled){return}self._buttonClicked();e.preventDefault();e.stopImmediatePropagation()},!useEventBubbling);BB.Keyboard.bindChordToEl({el:this._getMenuClickableElement(),chord:"enter/space",cb:function(){if(self._isMenuDisabled){return}setTimeout(function(){BB.Widgets.Buttons.NewButton.prototype.on.call(self)},150)},noDefault:true,noBubble:true,useCapture:true})},disableMenu:function(){this._buttonType.disableMenu();this._isMenuDisabled=true},enableMenu:function(){this._buttonType.enableMenu();this._isMenuDisabled=false},_getMainClickableElement:function(){return this._buttonType.getMainClickableElement()},_getMenuClickableElement:function(){return this._buttonType.getMenuClickableElement()}});BB.Widgets.Buttons.SplitMenuButton=SplitMenuButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;CollapseSection={templates:{},defaults:{title:"Section",bodyEl:null,startOpen:true,openFunc:$.noop,closeFunc:$.noop,localToggleStateKey:null,titleClick:true},init:function(cb){this.templates.main=HTML.get("collapseSection");if(cb){cb()}},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.CollapseSection.impl(o)}};CollapseSection.impl=function(options){var title=options.title,bodyEl=options.bodyEl,localToggleStateKey=options.localToggleStateKey,isOpen=(localToggleStateKey&&_.isReal(BB.LocalSettings.get(localToggleStateKey))?BB.LocalSettings.get(localToggleStateKey):options.startOpen)||false,el=$(document.createElement("div")),updateDisplay=function(){el.toggleClass("open",isOpen);if(isOpen){el.find(".bbIndicator").removeClass("Wo").addClass("Wq")}else{el.find(".bbIndicator").removeClass("Wq").addClass("Wo")}},toggle=function(forceState){if(_.isReal(forceState)){isOpen=forceState}else{isOpen=!isOpen}updateDisplay();if(localToggleStateKey){BB.LocalSettings.set(localToggleStateKey,isOpen)}if(isOpen){options.openFunc()}else{options.closeFunc()}},updateTitle=function(ptitle){title=ptitle;el.find(".titleSection .title").text(title)},addToRightOfTitle=function(element){el.find(".streak__titleRight").remove();var wrapper=$(document.createElement("div"));wrapper.addClass("streak__titleRight");wrapper.append(element);el.find(".titleSection").append(wrapper)};el.addClass("collapseSection");el[0].innerHTML=CollapseSection.templates.main();var titleSection=el.find(".titleSection");var bodySection=el.find(".bodySection");bodySection.append(bodyEl);var events="bbCursorClick";if(options.titleClick){events+=" click"}el.find(".titleSection").on(events,function(e){toggle()});if(localToggleStateKey){toggle(isOpen)}else{updateDisplay()}updateTitle(title);return{el:el,titleSection:titleSection,bodySection:bodySection,toggle:toggle,updateTitle:updateTitle,addToRightOfTitle:addToRightOfTitle,isOpen:function(){return isOpen},destroy:function(){el.remove()}}};Streak.DependencyManager.addFunction({functionKey:"widgets.collapseSection.initialized",functionToCall:CollapseSection.init,functionContext:CollapseSection,dependentFunctionKeys:["htmlLoaded"]});BB.Widgets.CollapseSection=CollapseSection})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ColorPicker={templates:{},defaults:{label:"Pick a color",previewText:"preview",color:{backgroundColor:null,textColor:null},colorChosenFunc:function(color){},showRemove:false,removeColorFunc:function(){}},init:function(cb){this.templates.container=HTML.get("colorPickerMenuContainer");this.templates.menu=HTML.get("colorPickerMenuInner")();this.templates.modal=HTML.get("colorPickerModal")();this.initStaticPicker();if(cb){cb()}},initStaticPicker:function(){var self=this;this.currentOptions=null;this.modal=null;this.selectedText=null;this.selectedBg=null;this.elements={};this.elements.innerMenu=$(this.templates.menu);this.elements.innerModal=$(this.templates.modal);this.elements.modalPreviewEl=this.elements.innerModal.find(".previewTextBox");this.elements.modalPreviewTextEl=this.elements.modalPreviewEl.find(".previewText");this.elements.innerModal.find(".background").on("click","[role=gridcell]",function(e){self.selectBackgroundColor($(this))});this.elements.innerModal.find(".text").on("click","[role=gridcell]",function(e){self.selectTextColor($(this))})},updateSelected:function(){if(this.currentOptions.color.backgroundColor&&this.currentOptions.color.textColor){var cells=this.elements.innerMenu.find("[role=gridcell]");for(var i=0;i<cells.length;i++){var cell=cells[i].children[0];var backgroundColor=cell.style.backgroundColor;var textColor=cell.style.color;if(backgroundColor===this.currentOptions.color.backgroundColor&&textColor===this.currentOptions.color.textColor){cell.innerHTML="";$(cells[i]).addClass("JA-Kn-Jr-Kw-Jn-KO")}else{cell.innerHTML="a";$(cells[i]).removeClass("JA-Kn-Jr-Kw-Jn-KO")}}}},openModal:function(){var self=this;$.modal.close();this.modal=BB.Widgets.Modal.create({title:BB.Locale.getString("color_add_custom"),confirmText:BB.Locale.getString("apply"),cancelText:BB.Locale.getString("modal_cancel"),inner:this.elements.innerModal,persist:true,width:"364px",confirmFunc:function(){self.currentOptions.colorChosenFunc(self.currentOptions.color);BB.Tracker.trackStreakActive(self.currentOptions.trackingContext,{eventName:"choseColor",type:"modal"})}});this.modal.show();this.updateModalPreview()},updateModalPreview:function(){if(this.currentOptions.color.backgroundColor&&this.currentOptions.color.textColor){this.elements.modalPreviewEl[0].style.backgroundColor=this.currentOptions.color.backgroundColor;this.elements.modalPreviewEl[0].style.borderColor=this.currentOptions.color.backgroundColor;this.elements.modalPreviewEl[0].children[0].style.borderColor=this.currentOptions.color.backgroundColor;this.elements.modalPreviewTextEl[0].style.color=this.currentOptions.color.textColor}},selectTextColor:function(cell){if(this.selectedText){this.selectedText.removeClass("ajZ-Jn-KO")}this.selectedText=cell;this.selectedText.addClass("ajZ-Jn-KO");this.currentOptions.color.textColor=$(this.selectedText[0].children[0]).css("background-color");this.updateModalPreview()},selectBackgroundColor:function(cell){var length,testIndex;if(this.selectedBg){this.selectedBg.removeClass("ajZ-Jn-KO")}this.selectedBg=cell;this.selectedBg.addClass("ajZ-Jn-KO");this.currentOptions.color.backgroundColor=$(this.selectedBg[0].children[0]).css("background-color");var group=cell.closest(".ajZ")[0].getAttribute("group");if(group==="blackAndWhite"){var testBW=this.elements.innerModal.find(".text [group=blackAndWhite] td");var index=cell.index();length=testBW.length;testIndex=0;if(length/2>index){testIndex=length-1}this.selectTextColor($(testBW[testIndex]))}else if(group==="solidColors"){this.selectTextColor($(this.elements.innerModal.find(".text [group=gradients] tr").filter(":last").find("td")[cell.index()]))}else if(group==="gradients"){var rowIndex=cell.closest("tr").index();var colIndex=cell.index();var rows=this.elements.innerModal.find(".text [group=gradients] tr");length=rows.length;testIndex=0;if(length/2>rowIndex){testIndex=length-1}this.selectTextColor($($(rows[testIndex]).find("td")[colIndex]))}},updateOptions:function(options){this.currentOptions=options;this.selectedText=null;this.selectedBg=null;if(options.showRemove){this.elements.innerMenu.filter(".removeColor").show()}else{this.elements.innerMenu.filter(".removeColor").hide()}this.elements.innerModal.find(".previewText").text(options.previewText)},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};ColorPicker.impl=function(o){var options=o;var el=$(ColorPicker.templates.container({label:options.label}));el.filter(".removeColor").easyHoverClass("J-N-JT");el.filter(".removeColor").click(function(e){options.removeColorFunc()});el.filter(".customColor").easyHoverClass("J-N-JT");el.filter(".customColor").click(function(e){ColorPicker.openModal()});function showMenu(){ColorPicker.updateOptions(options);ColorPicker.updateSelected();el.filter(".colorGrid").append(ColorPicker.elements.innerMenu);el.find("[role=grid]").on({mouseenter:function(){$(this).addClass("JA-Kn-Jr-Kw-Jn-JW")},mouseleave:function(){$(this).removeClass("JA-Kn-Jr-Kw-Jn-JW")}},"[role=gridcell]");el.find("[role=grid]").on("click","[role=gridcell]",function(e){var cell=$(this).find("div");var backgroundColor=cell.css("background-color");var textColor=cell.css("color");options.color.backgroundColor=backgroundColor;options.color.textColor=textColor;ColorPicker.updateSelected();options.colorChosenFunc(options.color);e.stopImmediatePropagation();BB.Tracker.trackStreakActive(options.trackingContext,{eventName:"choseColor",type:"grid"})})}return{el:el,showMenu:showMenu,updateColor:function(newColor,previewText){options.color=newColor;options.previewText=previewText}}};Streak.DependencyManager.addFunction({functionKey:"widgets.colorPicker.initialized",functionToCall:ColorPicker.init,functionContext:ColorPicker,dependentFunctionKeys:["htmlLoaded","localeLoaded"]});BB.Widgets.ColorPicker=ColorPicker})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;$.fn.ContactAutoSuggest=function(config){var defaults={doneCB:$.noop,listChangeFunc:$.noop,suggestionTemplate:$.noop,list:[],el:null,immediateDone:false,onlyValidEmailAddress:false};var options={};$.extend(options,defaults,config);return this.each(function(){var input=$(this);input.MultipleAutoSuggest(_.extend({data:options.list,wrapperCss:{display:"inline-block",verticalAlign:"middle"},clickStop:options.el,clickBody:Gmail.elements.body,immediateDone:options.immediateDone,noResultsFoundText:BB.Locale.getString("auto_suggest_no_results"),doneFunc:options.doneFunc,listChangeFunc:options.listChangeFunc,existingList:options.existingList,onlyValidEmailAddress:options.onlyValidEmailAddress,isRightAligned:options.isRightAligned},BB.Widgets.PersonPicker.ContactAutoSuggestFunctions))
})}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,StateMachine=Streak.StateMachine,Gmail=Streak.Gmail,BB=Streak.BentoBox;var DrivePickerButton={templates:{},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};DrivePickerButton.impl=function(o){var options=o;var self=this;var box=options.box;var fileCollection=options._fileCollection;var showSelectionDialog=function(){var params="caseKey="+encodeURIComponent(box.key())+"&email="+encodeURIComponent(BB.getUser().get("email"))+"&serverURL="+encodeURIComponent(Streak.server)+"&clientVersion="+Streak.clientVersion+"&extVersion="+Streak.extVersion;var url=Streak.server+"/drivePicker.jsp?"+params;var width=800;var height=600;var top=window.screenY+(window.outerHeight/2-height/2);var left=window.screenX+(window.outerWidth/2-width/2);var win=window.open(url,"Drive Picker","height="+height+",width="+width+",top="+top+",left="+left+",toolbar=0,resizable=0,menubar=0,location=0,status=0,scrollbars=0");var closeChecker=_.repeatEvery(function(){if(win&&win.closed){closeChecker.stop();fileCollection.refresh()}},500)};var submitComplete=function(filesChanged){$.modal.close()};function checkAndOpenDrive(){if(BB.getUser().get("oauth2Scopes").indexOf("https://www.googleapis.com/auth/drive")===-1){addDriveFile.disable();BB.Widgets.Modal.confirm(BB.Locale.getString("streak_reauthorize_title"),BB.Locale.getString("streak_reauthorize_body"),function(){addDriveFile.disable();BB.Modules.TopNav.startOauth();BB.bind("userReady",function(){BB.Data.initOauth2Scopes(function(){checkAndOpenDrive()})})},$.noop,$.noop,BB.Locale.getString("streak_reauthorize_button"))}else{addDriveFile.enable();showSelectionDialog()}}var addDriveFile=BB.Widgets.Button.create({color:"blue",name:BB.Locale.getString("add_drive_file"),onFunc:checkAndOpenDrive});$(addDriveFile.el).addClass("boxDriveButtons");if(box){if(box.getIsEditable()){addDriveFile.enable()}else{addDriveFile.disable()}}return{destroy:function(){clearTimeout(self.timeOutId);$.modal.close();$(self.divHolder).remove();$(self.iframe).remove();$(addDriveFile.el).remove()},el:addDriveFile.el}};BB.Widgets.DrivePickerButton=DrivePickerButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var KeyboardCaptureWidget=function(){Streak.ViewControllerBase.call(this);this._element=null;this._setupUIElement()};KeyboardCaptureWidget.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(KeyboardCaptureWidget.prototype,{_setupUIElement:function(){this._element=$(document.createElement("input"));this._element[0].setAttribute("type","text");this._element[0].setAttribute("tabindex","-1");this._element[0].style.height="0px";this._element[0].style.width="0px";this._element[0].style.border="0";this._element[0].style.position="absolute";this._element[0].style.outline="none";this.setupKeyBinding()},setupKeyBinding:function(){var self=this;this._element.off("keyup");this._element.on("keyup",function(e){e.preventDefault();self._callDelegateFunction("keyPressed",e.which);e.stopPropagation();return false});this._element.on("keydown",function(e){self._callDelegateFunction("keydown",e)})},getElement:function(){return this._element},focus:function(){this._element.focus()},destroy:function(){this._element.remove()}});BB.Widgets.KeyboardCaptureWidget=KeyboardCaptureWidget})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var IconButton={templates:{},defaults:{},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.templates.button){this.templates.button=HTML.get("iconButton")}}};IconButton.impl=function(o){var options=o,innerHTML=IconButton.templates.button({iconClass:options["iconClass"]});options.name=innerHTML;options.color="icon";return BB.Widgets.Button.create(options)};BB.Widgets.IconButton=IconButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Modal={templates:{},defaults:{title:null,canSubmitFunc:function(){return true},confirmFunc:$.noop,cancelFunc:$.noop,showCancel:true,cancelText:null,showConfirm:true,confirmText:null,width:"400px",minHeight:null,onClose:$.noop,inner:"",showTitle:true,doneButtonColor:"blue",cancelButtonColor:"normal",showLink:false,linkText:null,linkFunc:$.noop,escClose:true,close:true},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.defaults.cancelText){this.defaults.cancelText=BB.Locale.getString("modal_cancel");this.defaults.confirmText=BB.Locale.getString("modal_done");this.templates.modal=HTML.get("modalModal")}},confirm:function(title,message,cb,cancelFunction,closeFunction,confirmText,noFocus){var modal=Modal.create({title:title,inner:message,confirmFunc:cb,cancelFunc:cancelFunction,onClose:closeFunction,doneButtonColor:"red",confirmText:confirmText||BB.Locale.getString("ok"),trackingContext:{eventName:"confirmModal"}});modal.show();if(noFocus){return modal}setTimeout(function(){modal.getOkButton().el.focus()},100);return modal},simpleConfirm:function(title,message){var modal=Modal.create({title:title,inner:message,showCancel:false,doneButtonColor:"red",confirmText:BB.Locale.getString("ok"),trackingContext:{eventName:"confirmModal"}});modal.show()},confirmDelete:function(item,cb,extraText,cancelFunction){var delTitle=BB.Locale.getString("confirm_delete_title",{item:item});var message=BB.Locale.getString("confirm_delete_message",{item:"<strong>"+item+"</strong>"});if(extraText){message+="<br /><br />"+_.escape(extraText)}BB.Widgets.Modal.confirm(delTitle,message,cb,cancelFunction,null,null,true)},textboxModal:function(options){var title=options.title;var subheading=options.subheading;var extraText=options.extraText;var callback=options.callback;var cancelCallback=options.cancelCallback;var allowEmpty=options.allowEmpty;var placeholderText=options.placeholderText||"";var startingText=options.startingText;var innerDiv=$(document.createElement("div"));innerDiv.addClass("streak__textboxModalInner");if(_.isReal(subheading)){var subheadingDiv=$(document.createElement("div"));subheadingDiv[0].innerHTML=subheading;innerDiv.append(subheadingDiv)}var input=$('<input type="text" placeholder="'+_.escape(placeholderText)+'">');innerDiv.append(input);if(_.isReal(extraText)){var extraTextDiv=$(document.createElement("div"));extraTextDiv.text(extraText);innerDiv.append(extraTextDiv)}if(_.isReal(startingText)){input.val(startingText)}var modal=Modal.create({title:title,inner:innerDiv,confirmFunc:function(){if(input.val().trim().length===0&&!allowEmpty){return true}var newValue=input.val().trim();if(newValue===startingText){return}if(_.isFunction(callback)){callback(newValue)}},cancelFunc:function(){if(_.isFunction(cancelCallback)){cancelCallback()}},showCancel:_.isFunction(cancelCallback)});modal.show();input.on("keydown",function(e){if(Streak.jwerty.is("enter",e)){modal.confirm()}});var tabArray=[input];if(modal.getOkButton()){tabArray.push(modal.getOkButton().el)}if(modal.getCancelButton()){tabArray.push(modal.getCancelButton().el)}$.tabChain(tabArray);setTimeout(function(){input.focus()},100)}};Modal.impl=function(o){var options=o,linkButton=null,okButton=null,cancelButton=null,el=null;if(options.trackingContext){options.trackingContext.widgetContext+="/modal";options.trackingContext.widget="modal"}var track=function(eventName){BB.Tracker.trackStreakActive(options.trackingContext,{eventName:eventName})},checkCanSubmit=function(){if(options.canSubmitFunc()){okButton.enable();return true}else{okButton.disable();return false}},create=function(){el=$(Modal.templates.modal({title:options.title,confirm:options.confirmText}));el.find(".inner").append(options.inner);if(!options.showTitle){el.find(".title").hide()}el.width(options.width);if(!options.showCancel&&!options.showConfirm){el.find(".buttonArea").hide()}if(options.showLink){linkButton=BB.Widgets.LinkButton.create({text:options.linkText,clickFunction:function(){options.linkFunc()}});el.find(".buttonArea").append(linkButton.el)}if(options.showCancel){cancelButton=BB.Widgets.Button.create({name:options.cancelText,onFunc:function(){track("cancelButtonPressed");options.cancelFunc();Gmail.currentVisibleModal="";close()},isToggle:false,color:options.cancelButtonColor,trackingContext:_.clone(options.trackingContext)});el.find(".buttonArea").append(cancelButton.el)}if(options.showConfirm){okButton=BB.Widgets.Button.create({name:options.confirmText,onFunc:function(){track("confirmButtonPressed");if(options.confirmFunc){if(options.confirmFunc()){return}}Gmail.currentVisibleModal="";close()},isToggle:false,color:options.doneButtonColor,trackingContext:_.clone(options.trackingContext)});el.find(".buttonArea").append(okButton.el);checkCanSubmit()}if(options.close){el.find(".close").click(function(e){options.cancelFunc();close()})}else{el.find(".close").css("display","none")}if(options.escClose){BB.Keyboard.bindChordToElement(el,"escape",function(){options.cancelFunc();close()})}el.on("keydown",function(e){e.stopPropagation()});if(cancelButton&&okButton){cancelButton.el.easyTab({prev:okButton.el,next:okButton.el});okButton.el.easyTab({prev:cancelButton.el,next:cancelButton.el})}},show=function(dontStack){Gmail.currentVisibleModal=options.title;if(!el){create()}el.bbmodal({appendTo:Gmail.elements.body,onClose:function(){Gmail.currentVisibleModal="";if(options.onClose){options.onClose()}},dontStack:dontStack,overlayCss:options.overlayCss});el.focus()};var getEl=function(){if(!el){create()}return el};var close=function(){if(el){if(el.is(":FastVisible")){$.modal.close()}}};return{show:show,checkCanSubmit:checkCanSubmit,confirm:function(){okButton.on()},getEl:getEl,getOkButton:function(){return okButton},getCancelButton:function(){return cancelButton},destroy:function(){close()},close:close,getType:function(){return"MODAL"},setConfirmFunc:function(confirmFunc){options.confirmFunc=confirmFunc}}};BB.Widgets.Modal=Modal})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var templates={};var pipelineTemplates=[];var initialized=false;function init(){if(!initialized){templates.newPipelineItem=HTML.get("newPipelineItem");templates.group=HTML.get("newPipelineListGroup");NewPipelineModal.prototype.defaults.title=BB.Locale.getString("left_link_make_new");NewPipelineModal.prototype.defaults.cancelText=BB.Locale.getString("modal_done");initialized=true;return APIRequester.get("templates").getPromise().then(function(res){pipelineTemplates=res})}}var NewPipelineModal=function(options){BB.Widgets.Widget.call(this,options);this.newModalInner=HTML.get("newPipelineModal",true);this.options.inner=this.newModalInner;this.options.cancelFunc=this.options.noPipelineChosenCallback;this.newModal=BB.Widgets.Modal.create(this.options)};NewPipelineModal.prototype=Object.create(BB.Widgets.Widget.prototype);_.extend(NewPipelineModal.prototype,{show:function(options){this.newModal.show();this.loadPipelineTemplates();if(options){this.setOptions(options)}this.newModalInner.find(".subHeadingText")[0].innerHTML=this.options.subHeadingText;this.newModal.getEl().find("span.title")[0].innerHTML=this.options.title;Streak.NotificationCenter.postNotification({eventName:"newPipelineModalShowing",sender:this})},loadPipelineTemplates:function(){this.newModalInner.find(".templateList").empty();var self=this;var groups={};_.each(pipelineTemplates,function(template){var group=groups[template.categoryType];if(!group){group=self.renderGroup(template.categoryType)}groups[template.categoryType]=group;var t=self.renderTemplate(template);group.find(".list").append(t)});this.loaded=true},renderGroup:function(group){var el=$(templates.group({name:group}));this.newModalInner.find(".templateList").append(el);return el},renderTemplate:function(template){var self=this;var el=$(templates.newPipelineItem({name:template.templateTitle,description:template.shortDescription,src:BB.UI.getResourceURL(template.templateImageUrl),beginComment:"<!--",endComment:"-->"}));el.click(function(e){self.createNewPipeline(template);$.modal.close()});return el},createNewPipeline:function(template){var self=this;BB.ButterBarManager.showLoading(BB.Locale.getString("creating_pipeline"),{messageKey:"creatingPipeline"});if(self.options.pipelineChosenCallback){self.options.pipelineChosenCallback()}APIRequester.get("templates/"+template.templateType).getPromise().then(function(res){var operationProgressId=BB.Data.createPipelineFromTemplate(res,function(pipeline){BB.ButterBarManager.hideMessage("creatingPipeline");self.options.pipelineSavedCallback(pipeline)});self.options.pipelinePrecreateCallback(operationProgressId)},function(){BB.ButterBarManager.hideMessage("creatingPipeline");BB.ButterBarManager.showError("Error: Could not create pipeline")})},close:function(){this.newModal.close()},defaults:{subHeadingText:"",noPipelineChosenCallback:$.noop,pipelineChosenCallback:$.noop,pipelinePrecreateCallback:$.noop,pipelineSavedCallback:$.noop,showConfirm:false,width:"725px",maxHeight:"600px",minHeight:"600px",destroy:function(){this.newModal.close();this.newModalInner.remove()}}});NewPipelineModal.create=function(options){return new NewPipelineModal(options)};BB.Widgets.NewPipelineModal=NewPipelineModal;Streak.DependencyManager.addFunction({functionKey:"newPipelineModalInitialized",functionReference:init,dependentFunctionKeys:["htmlLoaded","localeLoaded","userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var NewComposeInspiredModal={templates:{},defaults:{isSoftCloseEnabled:true,topbar_text:"",closeCallback:$.noop,startOpen:true,minimizeCallback:$.noop},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.templates.NewComposeInspiredModal){this.templates.NewComposeInspiredModal=HTML.get("NewComposeInspiredModal")}}};NewComposeInspiredModal.impl=function(o){var options=o;var outerHTML=$(NewComposeInspiredModal.templates.NewComposeInspiredModal({topbar_text:options.topbar_text}));var contentArea=outerHTML.find(".streak_NCIModalContent");contentArea.append(o.innerHTML);var toggle=true;var minimizeButton=outerHTML.find(".streak_NCIMinimizeButton");if(options.startOpen){contentArea.show();outerHTML.removeClass("streak_NCIModalCollapsed")}else{contentArea.hide();outerHTML.addClass("streak_NCIModalCollapsed")}var minimizeFunction=function(){options.minimizeCallback();if(toggle){contentArea.hide();outerHTML.addClass("streak_NCIModalCollapsed")}else{contentArea.show();outerHTML.removeClass("streak_NCIModalCollapsed")}toggle=!toggle};minimizeButton.click(function(e){e.stopPropagation();minimizeFunction()});var topBar=outerHTML.find(".streak_NCIModalTopBar");topBar.click(minimizeFunction);var closeFunction=function(e){if(options.isSoftCloseEnabled){outerHTML.hide()}else{outerHTML.remove()}};var closeButton=outerHTML.find(".streak_NCICloseButton");closeButton.click(function(e){options.closeCallback();closeFunction();e.stopPropagation()});return{el:outerHTML,getElement:function(){return outerHTML},destroy:function(){outerHTML.remove();options=null},close:closeFunction}};BB.Widgets.NewComposeInspiredModal=NewComposeInspiredModal})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,BB=Streak.BentoBox;var defaults={imgHeight:30,imgWidth:30,numPerRow:-1,border:"always",display:"grid",includeNames:false,circle:false};var superclass=Streak.UI.View;var PeopleList=Streak.Class.subclass({className:"PeopleList",superclass:superclass,memberVariables:[{name:"_options",destroy:false}],_initialize:function(options){this._options=_.defaults(options||{},defaults);superclass.prototype._initialize.call(this);if(this._options.numPerRow>-1){this._element.width(this._options.imgWidth*this._options.numPerRow+"px")}switch(this._options.border){case"never":this._element.addClass("peopleListNoborder");break;case"hover":break;case"always":this._element.addClass("peopleListBorder");break}},_setupElement:function(){this._element=$(HTML.getElement("peopleList"))},destroy:function(){this._element.empty();this._element.remove()},setTab:function(prev,next){this._element.easyTab({prev:prev,next:next})},updateDisplay:function(list){this._element.empty();if(list&&list.length>0){var self=this;_.each(list,function(contact){var elementForContact=self.elementForContact(contact);self._element.append(elementForContact)});this._element.append('<div style="clear:both;"></div>')}else{this._element.html("&nbsp;")}},elementForContact:function(contact){contact=BB.Contacts.updateContact(contact);var span,div;var name=contact.displayName||contact.fullName||contact.email;var img=this.imageForContact(contact);switch(this._options.display){case"grid":if(this._options.includeNames){div=$(document.createElement("div"));div.addClass("imgItem");span=$(document.createElement("span"));span.addClass("people");if(contact.email){span.attr("email",contact.email)}span.text(name);div.append(img);div.append(span);return div}else{return img}break;case"list":div=$(document.createElement("div"));div[0].setAttribute("class","item");span=$(document.createElement("div"));span.addClass("streak__name");span.text(name);span.css("margin-left",this._options.imgWidth+5+"px");span.css("line-height",this._options.imgHeight+"px");if(contact.email){span.attr("email",contact.email)}div.append(img).append(span);return div}},imageForContact:function(contact){var img=$(BB.Contacts.getContactImage(contact,_.pick(this._options,"circle")));img.css("height",this._options.imgHeight);img.css("width",this._options.imgWidth);return img}});PeopleList.create=function(options){return new BB.Widgets.PeopleList(options)};BB.Widgets.PeopleList=PeopleList})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var defaults={border:"never",display:"list",imgHeight:32,imgWidth:32,circle:true};var superclass=BB.Widgets.PeopleList;BB.Widgets.People=Streak.Class.subclass({className:"People",superclass:superclass,memberVariables:[{name:"_emailAllButton",destroy:true},{name:"_emailIndividualButtons",destroy:true},{name:"_relatedEmailButtons",destroy:true},{name:"_contacts",destroy:true}],_initialize:function(options){options=options||{};_.defaults(options,defaults);superclass.prototype._initialize.call(this,options)},_setupElement:function(){this._element=$(HTML.getElement("boxViewPeople"))},findEmailsRelatedTo:function(contact){BB.Tracker.track("People.findEmailsRelatedTo.clicked",{trackingContext:this._options.trackingContext,contact:contact.email});var searchQuery="from:"+contact.email;Gmail.setURL("search/"+encodeURIComponent(searchQuery))},emailSingleUser:function(contact){BB.Tracker.track("People.emailSingleUser.clicked",{trackingContext:this._options.trackingContext,contact:contact.email});Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){composeWindowViewController.setToAddresses([contact.email]);composeWindowViewController.focusSubject()})},emailAllUsers:function(contacts){BB.Tracker.track("People.emailAllUsers.clicked",{trackingContext:this._options.trackingContext});Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){composeWindowViewController.setToAddresses(_.map(contacts,"email"));composeWindowViewController.focusSubject()})},updateDisplay:function(contacts){this._contacts=contacts;superclass.prototype.updateDisplay.call(this,contacts)},elementForContact:function(contact){contact=BB.Contacts.updateContact(contact);var name=contact.displayName||contact.fullName||contact.email;var img=this.imageForContact(contact);var div=$(HTML.getElement("boxViewPeople_item"));var label=div.find(".text");label.css("margin-left",this._options.imgWidth+5+"px");label.css("line-height",this._options.imgHeight+"px");if(contact.email){label.attr("email",contact.email)}label.find(".streak__name").text(name);var emailButton=this._createButtonToEmail(contact);if(emailButton){label.find(".streak__emailButton").html(emailButton.getElement())}var relatedEmailsButton=this._createButtonToFindRelatedEmails(contact);if(relatedEmailsButton){label.find(".streak__relatedEmailsButton").html(relatedEmailsButton.getElement())}div.find(".image").html(img);return div},createEmailAllButton:function(){var self=this;var emailAllButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("email_all"),color:"blue",onFunction:function(){self.emailAllUsers(self._contacts)}});return emailAllButton},_createButtonToEmail:function(contact){if(!contact.email)return null;var self=this;var emailUserButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:contact.email,color:"blue",onFunction:function(){self.emailSingleUser(contact)}});return emailUserButton},_createButtonToFindRelatedEmails:function(contact){var self=this;var findRelatedEmailsButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("related_emails"),color:"blue",onFunction:function(){self.findEmailsRelatedTo(contact)}});return findRelatedEmailsButton}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var NewPeopleListViewController=Streak.Class.subclass({className:"NewPeopleListViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_expandedNumberToShow",destroy:false,defaultValue:3,get:true,set:true},{name:"_collapsedMenuButton",destroy:true}],_initialize:function(expandedNumberToShow){Streak.UI.ViewController.prototype._initialize.call(this);this._expandedNumberToShow=expandedNumberToShow||this._expandedNumberToShow;this._view.addClass("streak__peopleList")},renderList:function(listOfContacts){this._view.empty();if(this._collapsedMenuButton){this._collapsedMenuButton.destroy();this._collapsedMenuButton=null}if(!listOfContacts||listOfContacts.length===0){return}var expandedNumberToShow=Math.min(listOfContacts.length,this._expandedNumberToShow);for(var ii=0;ii<expandedNumberToShow;ii++){this._renderContact(listOfContacts[ii])}if(expandedNumberToShow===listOfContacts.length-1){this._renderContact(listOfContacts[expandedNumberToShow]);return}if(expandedNumberToShow<listOfContacts.length){this._renderCollapsedContacts(expandedNumberToShow,listOfContacts)}},_renderContact:function(contact){var img=this._renderContactImage(contact);this._view.getElement().append(img)},_renderCollapsedContacts:function(expandedNumberToShow,listOfContacts){var numberOfContactsLeft=listOfContacts.length-expandedNumberToShow;var menuContent=this._renderMenuContent(expandedNumberToShow,listOfContacts);this._collapsedMenuButton=BB.Widgets.Buttons.ButtonFactory.createTooltipMenuButton({type:"Circle",text:"+"+numberOfContactsLeft,content:menuContent});this._view.getElement().append(this._collapsedMenuButton.getElement())},_renderMenuContent:function(expandedNumberToShow,listOfContacts){var menuContent=$(document.createElement("div"));menuContent.addClass("streak__peopleList_extraContacts");for(var ii=expandedNumberToShow;ii<listOfContacts.length;ii++){var expandedContact=this._renderExpandedContact(listOfContacts[ii]);menuContent.append(expandedContact)}return menuContent},_renderExpandedContact:function(contact){var entry=$(document.createElement("div"));entry[0].setAttribute("class","streak__peopleList_extraContact");var contactImage=this._renderContactImage(contact);entry.append(contactImage);var name=contact.displayName||contact.fullName||contact.email;var nameSpan=$(document.createElement("span"));nameSpan.text(name);entry.append(nameSpan);return entry},_renderContactImage:function(contact){contact=BB.Contacts.updateContact(contact);return BB.Contacts.getContactImage(contact,{circle:true})}});Library.set("BentoBox.Widgets.NewPeopleListViewController",NewPeopleListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var CONSTANTS={HOVER_CLASS:"aco",FOCUS_CLASS:"acm"};BB.Widgets.PeoplePicker={templates:{},defaults:{imgHeight:25,imgWidth:25,numPerRow:-1,border:"never",model:null,delayedBind:false,bindTab:false,existingList:[],jsonified:false,parent:null,onlyValidEmailAddress:false,neverShowRead:false},create:function(options){this._init();var o={};_.extend(o,this.defaults,options);return new BB.Widgets.PeoplePicker.impl(o)},_init:function(){if(!this.templates.wrapper){this.templates.wrapper=HTML.get("peoplePicker")}}};BB.Widgets.PeoplePicker.impl=function(options){var returnObject={};var el=null,peoplePicker=null,input=null,bound=false,saveValue=null,editVisible=false,inUse=false,unbindFunction=null,peopleList=BB.Widgets.PeopleList.create({imgHeight:options.imgHeight,imgWidth:options.imgWidth,numPerRow:options.numPerRow,border:"hover",includeNames:options.includeNames}),setupElement=function(){if(el){el.remove()}el=$(document.createElement("div"));el[0].innerHTML=BB.Widgets.PeoplePicker.templates.wrapper();el[0].setAttribute("class","smartInput peoplePickerWrapper");el[0].setAttribute("tabindex","-1");el.append(peopleList.getElement());if(options.model){setEnabled(options.model.getIsEditable())}peoplePicker=el.find(".peoplePicker");el.click(function(e){if(!editVisible){setupWidget()}else{input.focus()}});el.focus(function(){if(!editVisible){Gmail.elements.body.trigger("bodyCloseAndStop");setTimeout(function(){setupWidget()},10)}});switch(options.border){case"never":el.addClass("peoplePickerNoborder");break;case"hover":peopleList.addClass("R5");peoplePicker.addClass("R5");el.easyHoverClass(CONSTANTS.HOVER_CLASS,null,true);break;case"always":el.addClass("peoplePickerBorder");break}if(options&&options.model){options.model.watch("set",bindUpdate,returnObject,options.property);updateDisplay(true);showRead();bind(true)}},setTab=function(prev,next){el.easyTab({prev:prev,next:next})},getValue=function(){return options.model.get(options.property)},getParsedValue=function(){var list=getValue();if(options.jsonified){list=list&&list.length>0?JSON.parse(list):null}return list},updateValue=function(){var currList=getValue();if(!JSON.isEqual(currList,saveValue)){if(_.isNotReal(saveValue)){saveValue=[]}options.model.set(options.property,saveValue);options.model.save(function(){BB.Tracker.trackStreakActive({property:options.property,widget:"peoplePickerInstance"},options.trackingContext)})}},updateDisplay=function(force){if(force||!JSON.isEqual(currentValue,getValue())){currentValue=getValue();peopleList.updateDisplay(getParsedValue())}},clear=function(){updateValue("")},showRead=function(){if(options.neverShowRead){return}peopleList.updateDisplay(getParsedValue());peoplePicker.hide();peopleList.getElement().show();el.removeClass("active");if(options.border==="hover"){el.removeClass(CONSTANTS.FOCUS_CLASS);if(getParsedValue()&&getParsedValue().length>0){el.trigger("unhold")}else{el.trigger("hold")}}else{el.trigger("unhold")}editVisible=false},showEdit=function(){input.data("peopleList",getParsedValue());input.data("existingList",options.existingList);input.trigger("setPeopleList");peopleList.getElement().hide();peoplePicker.show();if(options.border==="hover"){el.addClass(CONSTANTS.FOCUS_CLASS)}el.addClass("active");editVisible=true;inUse=true},attachAutoSuggest=function(list){input.ContactAutoSuggest({list:list,el:_.isReal(options.parent)?options.parent:el,immediateDone:true,listChangeFunc:function(list){if(options.jsonified){saveValue=list&&list.length>0?JSON.stringify(list):""}else{saveValue=list}},doneFunc:function(list){if(!inUse){return}updateValue();showRead()},onlyValidEmailAddress:options.onlyValidEmailAddress,existingList:options.existingList,isRightAligned:options.isRightAligned})},setupWidget=function(){if(el.hasClass("disabled")){return}bind();showEdit();input.val("");input.focus();input.attr("size",1);input.trigger("bbFocus");if(options.border=="hover"){el.trigger("hold")}currentValue=getValue();saveValue=currentValue},setup=function(newOptions){options.model=newOptions.model;options.property=newOptions.property;options.parent=newOptions.parent;options.existingList=newOptions.existingList;setupElement()},set=function(val){setupWidget();input.val(val);input[0].setArrowMode(true)},setEnabled=function(enabled){if(enabled){el.removeClass("disabled")}else{el.addClass("disabled")}},focus=function(){setupWidget();input[0].setArrowMode(false)},bind=function(force){if(!bound||force){peoplePicker[0].innerHTML='<div><input type="text" /></div>';input=el.find("input");attachAutoSuggest(getParsedValue());input.keydown(function(e){if(e.which===27){}else if(e.which===9){}else if(e.which!==9){e.stopPropagation()}});input.bind("escapePressed",function(e){input.data("peopleList",getParsedValue());input.trigger("setPeopleList");showRead()});input.spreadsheetArrow(["up","down"]);bound=true;el.addClass("bbBound")}},currentValue=null;var uniq="peoplePickerUpdateDisplay"+Date.create().getTime();var bindUpdate=function(){if(editVisible){return}updateDisplay(true)};setupElement();_.extend(returnObject,{el:el,getElement:function(){return el},setTab:setTab,clear:clear,focus:focus,set:set,setup:setup,updateValue:updateValue,updateDisplay:updateDisplay,done:function(){inUse=false},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:returnObject});peopleList.destroy();if(input){input.unbind();input.remove()}el.empty();el.remove()}});return returnObject}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;BB.Widgets.PersonPicker={templates:{},defaults:{selectFunc:$.noop,allowEmail:true,allowName:true,initial:[]},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.PersonPicker.impl(o)}};BB.Widgets.PersonPicker.ContactAutoSuggestFunctions={dataFunc:BB.Contacts.queryContacts,stringDataFunc:BB.Contacts.convertStringData,convertFunc:BB.Contacts.convertResultToLiElement,compareFunc:BB.Contacts.compareContactAndQuery};BB.Widgets.PersonPicker.impl=function(options){var input=$('<input type="text" placeholder="'+BB.Locale.getString("person_picker_input_placeholder")+'"/>'),el=$("<div></div>"),setTab=function(prev,next){el.easyTab({prev:prev,next:next})},setup=function(){input.val("");input.focus()},excluded=[];el.addClass("personPicker");el.append(input);el.focus(function(e){input.val("");input.focus()});input.AutoSuggest(_.extend({noResultsFoundText:BB.Locale.getString("auto_suggest_no_results"),loadingResultsText:BB.Locale.getString("auto_suggest_loading_results"),selectFunc:function(person){if(person){options.selectFunc(person)}},getExcludedIDsFunc:function(){return _.pluck(excluded,"email")},isRightAligned:false},BB.Widgets.PersonPicker.ContactAutoSuggestFunctions));return{el:el,setTab:setTab,focus:setup,setExcluded:function(list){excluded=list},getElement:function(){return el},destroy:function(){el.remove()},selectItem:function(){el.find("input").trigger("bbSelect")}}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PersonPickerViewController=Streak.Class.subclass({className:"PersonPickerViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_textInput",destroy:true},{name:"_addButton",destroy:true},{name:"_excludedEmails",destroy:false,get:true,set:true,defaultValue:[]},{name:"_contactSelectedCallback",destroy:false}],_initialize:function(options){Streak.UI.ViewController.prototype._initialize.call(this,options);
this._contactSelectedCallback=options.contactSelectedCallback},setExcluded:function(excludedContacts){this._excludedEmails=_.pluck(excludedContacts,"email")},focus:function(){this._textInput.focus()},_setupView:function(){Streak.UI.ViewController.prototype._setupView.call(this);this._view.addClass("streak__personPicker");this._createTextInput();this._createAddButton()},_createTextInput:function(){var self=this;this._textInput=Library.getInstance("BentoBox.Widgets.GmailTextareaViewController",{plainTextOnly:false});this._textInput.getView().getElement().find("[contenteditable=true]").AutoSuggest({noResultsFoundText:BB.Locale.getString("auto_suggest_no_results"),loadingResultsText:BB.Locale.getString("auto_suggest_loading_results"),isRightAligned:false,dataFunc:BB.Contacts.queryContacts,stringDataFunc:BB.Contacts.convertStringData,convertFunc:BB.Contacts.convertResultToLiElement,compareFunc:BB.Contacts.compareContactAndQuery,getExcludedIDsFunc:this.getExcludedEmails.bind(this),selectFunc:function(person){if(person&&self._contactSelectedCallback){self._contactSelectedCallback(person)}}});this._view.addSubView(this._textInput.getView())},_createAddButton:function(){var self=this;this._addButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("add"),onFunction:function(){self._textInput.getView().getElement().find("[contenteditable=true]").trigger("bbSelect")}});this._view.addSubView(this._addButton)}});Library.set("BentoBox.Widgets.PersonPickerViewController",PersonPickerViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,BB=Streak.BentoBox;var RadioList={defaults:{changeCallback:$.noop},create:function(options){var o={};_.extend(o,this.defaults,options);return new this.impl(o)}};RadioList.impl=function(o){var options=o,renderedList=[],renderedRadios=[],list=[],el=$(document.createElement("div"));el.addClass("streakRadioList");function addOption(text,key){var container=$(document.createElement("span"));var radio=$('<input type="radio" />');container.append(radio);container.append(text);container.on("click",function(e){setSelected(key);if(options.changeCallback){options.changeCallback(key)}});renderedList.push(container);renderedRadios.push(radio);list.push(key);el.append(container)}function setSelected(key){for(var ii=0;ii<renderedRadios.length;ii++){if(list[ii]===key){renderedRadios[ii][0].checked=true}else{renderedRadios[ii][0].checked=false}}}return{el:el,addOption:addOption,setSelected:setSelected}};BB.Widgets.RadioList=RadioList})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,jwerty=Streak.jwerty,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var CustomDropdown={templates:{},defaults:{overrideTab:false,list:[{name:"Default",value:"Default"}],currentIndex:0,maxHeight:200,extraHTML:null,prefixHTML:null,unselectedDisplayText:null,fixPosition:false,border:null,changeFunc:function(newItem){},comparisonFunction:function(listItemValue,potentialSelectedItemValue){return listItemValue===potentialSelectedItemValue}},create:function(options){this._init();var o={};_.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.templates.menu){this.templates.menu=HTML.get("smartDropdownMenu");this.templates.item=HTML.get("smartDropdownItem")}}};CustomDropdown.impl=function(o){var options=o,el=$(document.createElement("div")),span=options.span||$(document.createElement("span")),extraHTML=options.extraHTML||"",prefixHTML=options.prefixHTML||"",hInput=$(document.createElement("input")),menu=$(CustomDropdown.templates.menu()),bound=false,isActive=true,current=null,updateDisplay=function(){span.text(current.name||current.display);if(prefixHTML){span.prepend(prefixHTML)}span.append(extraHTML)},focus=function(){if(!isActive){return}bind();hInput.val("");arrowMode=false;menu.show();if(options.fixPosition){var elOffset=_.clone(el.offset());elOffset.top+=parseFloat(el.height());menu.position({top:0,left:0});menu.offset(elOffset)}else{menu.show()}var currentPosition=0;var realIndex=0;for(var ii=0;ii<options.list.length;ii++){var item=options.list[ii];if(!item.value){continue}if(options.comparisonFunction){if(options.comparisonFunction(item.value,current.value)){currentPosition=realIndex}}realIndex++}cursor.setPosition([currentPosition])},hide=function(){menu.hide()},bind=function(){if(!bound){renderMenu();el.bind("blur",function(e){menu.hide();el.trigger("menuClosed")});BB.Keyboard.bindChordToElement(el,"[a-z]/shift+[a-z]/backspace",function(e){clearTimeout(timeout);if(jwerty.is("backspace",e)){hInput.val(hInput.val().first(hInput.val().length-1))}else{hInput.val(hInput.val()+String.fromCharCode(e.which))}setCursor();timeout=setTimeout(function(){hInput.val("")},1e3)},true,true);BB.Keyboard.bindChordToElement(el,"up/down/home/end",function(e){hInput.val("")},true,true);BB.Keyboard.bindChordToElement(el,"escape",function(e){menu.hide();el.trigger("menuClosed")},true,true,true);if(options.overrideTab){BB.Keyboard.bindChordToElement(el,"tab",function(e){cursor.select();el.trigger("innerTabPressed")},true,true,true);BB.Keyboard.bindChordToElement(el,"shift+tab",function(e){cursor.select();el.trigger("innerShiftTabPressed")},true,true,true)}bound=true;el.addClass("bbBound")}},renderMenu=function(list){if(list){if(list.length>0){if(current.value!=="__unselected"){current=list[0]}}options.list=list}menu.find(".bb_menu_inner").empty();for(var ii=0;ii<options.list.length;ii++){var item=options.list[ii];if(item==="__separator"){var separator=document.createElement("div");separator.setAttribute("class","J-Kh");separator.setAttribute("role","separator");menu.find(".bb_menu_inner").append(separator)}else{var name=item.name||item.display;if(name){var itemEl=$(document.createElement("div"));itemEl[0].setAttribute("class","J-N item");itemEl[0].setAttribute("role","menuitem");itemEl[0].innerHTML='<div class="J-LC-Jz value" style="">'+_.escape(name)+"</div>";itemEl.data("itemValue",item);menu.find(".bb_menu_inner").append(itemEl)}else{BB.logError("tried to add menu entry with no name",null,item)}}}cursor.setup(menu.find(".item"),menu.find(".item"));cursor.setPosition([options.currentIndex])},setCursor=function(){var val=hInput.val().toLowerCase();for(var ii=0;ii<options.list.length;ii++){var item=options.list[ii];if((item.name||item.display||"").toLowerCase().startsWith(val)){cursor.setPosition([ii]);return}}},setSelected=function(selectedValue){selectedValue=selectedValue||null;current=_.find(options.list,function(item){if(item==="__separator"){return false}if(options.comparisonFunction){return options.comparisonFunction(item.value,selectedValue)}});if(_.isNotReal(current)){deselect();return}updateDisplay()},deselect=function(){if(_.isReal(options.unselectedDisplayText)){current={name:options.unselectedDisplayText,value:"__unselected"}}else if(options.list.length>0){setSelected(options.list[0].value)}updateDisplay()},cursor=BB.Cursor.create({selectedClass:"J-N-JT",selectOnClick:true,aggressiveInputCapture:true,selectFunc:function(itemEl){current=itemEl.data("itemValue");updateDisplay();options.changeFunc(current);hide();el.trigger("itemSelected")},highlightOnHover:true,rollOver:true,input:el}),arrowMode=false;el[0].setAttribute("class","dropdown smartInput customDropdown");span.addClass("input");hInput[0].setAttribute("type","text");el.append(span);if(_.isNotReal(options.span)){el[0].setAttribute("tabindex","-1");el.append('<div class="downArrow G-asx T-I-J3 J-J5-Ji">&nbsp;</div>')}el.append(menu);el.bind("bbCursorSelect",function(e){e.stopPropagation()});el.bind("focus",function(e){focus()});if(options.border==="alwaysGmail"){el.addClass("R5")}menu[0].style.maxHeight=options.maxHeight+"px";var timeout=null;current=options.list[options.currentIndex];updateDisplay();bind();return{el:el,focus:focus,menu:menu,setMenuList:renderMenu,setSelected:setSelected,deselect:deselect,getSelected:function(){return current},disable:function(){isActive=false},enable:function(){isActive=true},getElement:function(){return el},destroy:function(){el.remove()},hide:hide}};BB.Widgets.CustomDropdown=CustomDropdown})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ButtonCustomDropdown={defaults:{buttonColor:"normal",autoClose:true,overrideTab:false,list:[{name:"Default",value:"Default"}],currentIndex:0,maxHeight:200,changeFunc:function(newItem){},comparisonFunction:function(listItemValue,potentialSelectedItemValue){return listItemValue===potentialSelectedItemValue}},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};ButtonCustomDropdown.impl=function(o){var options=o;var bodyClosed=false;options.trackingContext.widgetContext+="/ButtonCustomDropdown";var button;button=BB.Widgets.Button.create({trackingContext:options.trackingContext,color:options.buttonColor,isToggle:true,onFunc:function(e){customDropdown.focus();customDropdown.menu.containByScreen(button.el)},offFunc:function(e){customDropdown.hide();button.el.focus()},isDropdown:true,hasButtonToRight:options.hasButtonToRight,hasButtonToLeft:options.hasButtonToLeft});options.span=button.el;options.extraHTML='<div class="downArrow G-asx T-I-J3 J-J5-Ji">&nbsp;</div>';options.fixPosition=true;var customDropdown=BB.Widgets.CustomDropdown.create(options);customDropdown.el.bind({menuClosed:function(){button.off()},itemSelected:function(){button.off()},innerTabPressed:function(){button.off();button.el.trigger("tabPressed")},innerShiftTabPressed:function(){button.off();button.el.trigger("shiftTabPressed")}});customDropdown.menu.css("position","fixed");button.el.bodyCloseAndStop({closeFunction:function(){button.off();button.el.blur()},body:Gmail.elements.body,stop:customDropdown.el[0]});customDropdown.disable=button.disable;customDropdown.enable=button.enable;customDropdown.el.addClass("TI");customDropdown.destroy=function(){customDropdown.el.remove();button.destroy()};return customDropdown};BB.Widgets.ButtonCustomDropdown=ButtonCustomDropdown})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,jwerty=Streak.jwerty,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var SmartDropdown={templates:{},defaults:{borderOnHover:false,property:null,fieldIndex:-1,model:null,list:null,autoSave:true,delayedBind:false,overrideTab:false,extraHTML:null},create:function(options){this._init();var o={};_.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.templates.menu){this.templates.menu=HTML.get("smartDropdownMenu");this.templates.item=HTML.get("smartDropdownItem")}}};SmartDropdown.impl=function(o){var returnObject={};var options=o,el=$(document.createElement("div")),span=options.span||$(document.createElement("span")),extraHTML=options.extraHTML||"",hInput=$(document.createElement("input")),menu=$(SmartDropdown.templates.menu()),bound=false,menuRendered=false,uniq="smartDropdown"+(new Date).getTime(),getValue=function(){if(options.property){return options.model.get(options.property)}else if(options.fieldKey){return options.model.getFieldModel(options.fieldKey)}},getItem=function(){var index=options.list.findIndex(function(anItem){return(anItem.value?anItem.value:anItem)===getValue()});return options.list[index]},updateDisplay=function(){var index=options.list.findIndex(function(anItem){return(anItem.value?anItem.value:anItem)===getValue()});if(index>-1){var theItem=options.list[index];if(cursor){cursor.setPosition([index])}span.data("itemValue",theItem);span.empty();span.text(theItem.text?theItem.text:theItem);span.append(extraHTML)}},updateValue=function(){var newValue=span.data("itemValue");if(newValue!=currentValue){var value=newValue.value?newValue.value:newValue;if(options.property){options.model.set(options.property,value)}if(options.autoSave){options.model.save(function(){BB.Tracker.trackStreakActive({property:options.property,widget:"smartDropdown"},options.trackingContext)})}currentValue=newValue}},clear=function(){},focus=function(){bind();hInput.val("");el.focus();arrowMode=false},set=function(val){focus();hInput.val(val);setCursor();arrowMode=true},hide=function(){menu.hide()},bind=function(){if(!bound){basicBind();BB.Keyboard.bindChordToElement(el,"[a-z]/shift+[a-z]/backspace",function(e){clearTimeout(timeout);if(jwerty.is("backspace",e)){hInput.val(hInput.val().first(hInput.val().length-1))}else{hInput.val(hInput.val()+String.fromCharCode(e.which))}setCursor();timeout=setTimeout(function(){hInput.val("")},1e3)},true,true);BB.Keyboard.bindChordToElement(el,"up/down/home/end",function(e){hInput.val("")},true,true);BB.Keyboard.bindChordToElement(el,"right",function(e){if(arrowMode){el.trigger("rightPressed");cursor.select()}});BB.Keyboard.bindChordToElement(el,"left",function(e){if(arrowMode){el.trigger("leftPressed");cursor.select()}});BB.Keyboard.bindChordToElement(el,"escape",function(e){menu.hide();el.trigger("menuClosed")},true,true,true);if(options.overrideTab){BB.Keyboard.bindChordToElement(el,"tab",function(e){setTimeout(function(){el.trigger("innerTabPressed")},10)},true,true,true);BB.Keyboard.bindChordToElement(el,"shift+tab",function(e){setTimeout(function(){el.trigger("innerShiftTabPressed")},10)},true,true,true)}bound=true;el.addClass("bbBound")}},basicBind=function(){menu.unbind(".smartDropdown");span.unbind(".smartDropdown");menu.bind("click.smartDropdown",function(e){cursor.select()});el.bind("focus",function(e){renderMenu();menu.show()});if(!options.overrideTab){el.bind("blur",function(e){menu.hide();el.trigger("menuClosed")})}},renderMenu=function(list){if(list){options.list=list;menuRendered=false;return}if(menuRendered){return}list=options.list;menu.find(".bb_menu_inner").empty();_.each(options.list,function(item){var text=item.text?item.text:item;var itemEl=$(SmartDropdown.templates.item({name:text}));itemEl.data("itemValue",item);menu.find(".bb_menu_inner").append(itemEl)});cursor=BB.Cursor.create({selectedClass:"J-N-JT",selectFunc:function(itemEl){var item=itemEl.data("itemValue");span.data("itemValue",itemEl.data("itemValue"));updateValue();el.trigger("itemSelected")},highlightOnHover:true,rollOver:true,input:el,noScroll:true});cursor.setup(menu.find(".item"),menu.find(".item"));updateDisplay()},setCursor=function(){var val=hInput.val().toLowerCase();$.each(options.list,function(index,item){if((item.text?item.text:item).toLowerCase().startsWith(val)){cursor.setPosition([index]);return}})},cursor=null,currentValue=getValue(),arrowMode=false;el[0].setAttribute("class","dropdown smartInput");el[0].setAttribute("tabindex","-1");span.addClass("input");hInput[0].setAttribute("type","text");el.append(span);el.append(menu);el.bind("bbCursorSelect",function(e){e.stopPropagation()});function updateAllDisplay(){span.data("itemValue",getItem());updateDisplay()}options.model.watch("set",updateAllDisplay,returnObject,options.property);var timeout=null;if(!options.delayedBind){bind()}updateDisplay();var reset=function(list){options.list=list;basicBind()};returnObject.el=el;returnObject.clear=clear;returnObject.focus=focus;returnObject.set=set;returnObject.reset=reset;returnObject.renderMenu=renderMenu;returnObject.hide=hide;returnObject.destroy=function(){Streak.NotificationCenter.unsubscribe({observer:returnObject});menu.remove();el.remove();if(hInput){hInput.remove()}if(span){span.remove()}};return returnObject};BB.Widgets.SmartDropdown=SmartDropdown})(Streak);(function(Streak){var $=Streak.jQuery,BB=Streak.BentoBox;BB.Widgets.SmartInput={create:function(type,options){return BB.Models.BoxField.getInputWidget(type,options)}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={HOVER_CLASS:"aco",FOCUS_CLASS:"acm"};BB.Widgets.SidebarTextarea={template:'<div contentEditable="true" class="textAreaBaseStyle edit"></div>',defaults:{model:null,property:null,border:"always",enter:false,placeholder:null,autoSave:true,readHTML:false,useAutocomplete:true,existingList:[]},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.SidebarTextarea.impl(o)}};BB.Widgets.SidebarTextarea.impl=function(o){var returnObject={};var options=o;var el=$('<div><div class="sidebarTextareaRead"></div></div>');var readEl=el.find("div");var property=options.property;var model=options.model;var autoSave=options.autoSave;var currentValue=null;var bound=false;var editValue=null;var saveTimeout=null;var valueChanged=false;var changedValueSaved=false;var modelUnbinder=false;var isValueValid=options.isValueValidFunction;var getValue=function(){return model.get(property)||""};var getCleanValue=function(){return $.cleanText(getValue(),true).escapeHTML()};var updateValue=function(){var val=getValue();editEl.find(".bbAutocomplete").hide();var editValue=editEl.plainText();editEl.find(".bbAutocomplete").show();if(editValue.length===0){if(!editEl.is(":FastVisible")){editValue=el.plainText()}}if(isValueValid){if(!isValueValid(editValue)){return}}if(currentValue!==editValue){valueChanged=true;model.set(property,editValue);clearTimeout(saveTimeout);saveTimeout=setTimeout(saveValue,500)}currentValue=editValue};var saveValue=function(){updateValue();clearTimeout(saveTimeout);saveTimeout=null;if(!valueChanged){return}changedValueSaved=true;if(autoSave){model.save()}valueChanged=false};var setEnabled=function(enabled){if(enabled){el.removeClass("disabled")}else{el.addClass("disabled")}};var updateDisplay=function(){if(getValue()!==currentValue){if(el.is(".active")){return}}else{return}showRead()};var showRead=function(){editEl.trigger("detach");editEl.detach();if(options.readHTML){readEl.setPlainText(getValue())}else{readEl[0].innerHTML=getCleanValue()}el.removeClass("active");el.empty();el.append(readEl);editEl.unbindBodyCloseAndStop();if(options.border==="hover"){el.removeClass(CONSTANTS.FOCUS_CLASS);if(getCleanValue()){el.removeClass(CONSTANTS.HOVER_CLASS);el.trigger("unhold")}else{el.trigger("hold");el.addClass(CONSTANTS.HOVER_CLASS)}}else if(options.border==="alwaysGmail"){el.removeClass(CONSTANTS.FOCUS_CLASS)}};var showEdit=function(){if(el.hasClass("disabled")||editEl.is(":focus")){return}readEl.detach();editEl.detach();editEl.setPlainText(getValue());currentValue=getValue();el.append(editEl);el.addClass("active");if(options.border==="hover"||options.border==="alwaysGmail"){el.addClass(CONSTANTS.FOCUS_CLASS)}bind();bindToBodyClick();if(options.useAutocomplete){editEl[0].setAutoCompleteList(options.existingList)}editEl.focus();setCursor()};var setCursor=function(){setTimeout(function(){var sel,range;var doc=Streak.document;if(doc.createRange){range=doc.createRange();range.selectNodeContents(editEl[0]);range.collapse(false);sel=doc.getSelection();sel.removeAllRanges();sel.addRange(range)}},1)};var editEl=$(BB.Widgets.SidebarTextarea.template);var bind=function(){if(!bound){editEl[0].addEventListener("keydown",function(e){if(e.which===13){if(e.metaKey||e.ctrlKey){e.stopImmediatePropagation()}}},true);editEl.on("escapePressed",function(e){editEl.setPlainText(currentValue);showRead();el.trigger("blurred")});BB.Keyboard.bindChordToEl({el:editEl,chord:"tab/shift+tab",useCapture:true,cb:function(e){saveValue();showRead()}});editEl.delayedSave({saveFunction:updateValue,delay:0,saveOnBlur:false,enter:true});if(options.useAutocomplete){editEl.autoComplete("plainText")}bound=true}};function bindToBodyClick(){el.bodyCloseAndStop({closeFunction:function(){el.unbindBodyCloseAndStop();if(editEl.isVisible()){updateValue();saveValue();showRead()}},stop:el,body:Gmail.elements.body,useCapture:true})}el.addClass("smartInput sidebarTextarea");el[0].setAttribute("tabindex",-1);el.click(function(){if(!editEl.is(":FastVisible(noCompute)")){setTimeout(showEdit,50)}});el.focus(function(){if(!editEl.is(":FastVisible(noCompute)")){Gmail.elements.body.trigger("bodyCloseAndStop");setTimeout(showEdit,50)}});switch(options.border){case"never":el.addClass("noTextareaBorder");break;case"hover":readEl.addClass("R5");editEl.addClass("R5");el.easyHoverClass(CONSTANTS.HOVER_CLASS);break;case"always":el.addClass("textareaBorder");break;case"alwaysGmail":readEl.addClass("R5");editEl.addClass("R5");el.addClass(CONSTANTS.HOVER_CLASS)}if(model){model.watch("set",updateDisplay,returnObject,property);if(model.getIsEditable){setEnabled(model.getIsEditable())}showRead()}if(options.placeHolder){el.attr("placeholder",options.placeHolder)}returnObject.el=el;returnObject.getElement=function(){return el};returnObject.focus=function(){el.focus()};returnObject.focusAndSelect=function(){el.focus();setTimeout(function(){editEl.selectContents()},150)};returnObject.setModelAndProperty=function(inModel,inProperty){Streak.NotificationCenter.unsubscribe({observer:returnObject});model=inModel;property=inProperty;model.watch("set",updateDisplay,returnObject,property);editEl.setPlainText("");updateDisplay()};returnObject.destroy=function(){el.unbindBodyCloseAndStop();Streak.NotificationCenter.unsubscribe({observer:returnObject});readEl.remove();editEl.find("*").unbind();editEl.remove();el.empty();el.remove();if(changedValueSaved){BB.Tracker.trackStreakActive({eventName:"boxDataEdited",property:options.property,widget:"sidebarTextarea"},options.trackingContext)}};return returnObject}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={HOVER_CLASS:"aco",FOCUS_CLASS:"acm"};BB.Widgets.SmartTextarea={template:'<div class="streak__smartTextarea"><div class="R5" contentEditable="true"></div></div>',defaults:{model:null,property:null,useRawHTML:false,border:"always",enter:false,autoSave:true,trackingContext:{widget:"smartTextarea"}},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.SmartTextarea.impl(o)}};BB.Widgets.SmartTextarea.impl=function(o){var observer={};var options=o,valueChanged=false,outerEl=$(BB.Widgets.SmartTextarea.template),saveTimeout=null,modelUnbinder=null,setTab=function(prev,next){el.easyTab({prev:prev,next:next})},updateValue=function(){var val=options.model.get(options.property);var text=null;if(options.useRawHTML){text=el.html()}else{text=el.plainText()}if(val!==text){options.model.set(options.property,text);clearTimeout(saveTimeout);saveTimeout=setTimeout(saveValue,1);valueChanged=true}},saveValue=function(){if(!valueChanged){return}clearTimeout(saveTimeout);saveTimeout=null;valueChanged=false;options.model.save(function(){BB.Tracker.trackStreakActive(_.extend({property:options.property,widget:"smartTextarea"},options.trackingContext))})},getValue=function(){var val=options.model.get(options.property);return $.trim(val)},setEnabled=function(enabled){el.prop("contenteditable",!!enabled);if(enabled){el.removeClass("disabled")}else{el.addClass("disabled")}},updateDisplay=function(){if(!outerEl.is("."+CONSTANTS.FOCUS_CLASS)){if(options.useRawHTML){el.html(getValue())}else{el.setPlainText(getValue())}}if(options.border==="hover"){if(options.model.get(options.property)){outerEl.removeClass(CONSTANTS.HOVER_CLASS);el.trigger("unhold")}else{el.trigger("hold");outerEl.addClass(CONSTANTS.HOVER_CLASS)}}if(options.placeholder){if(!options.model.get(options.property)){outerEl.append(placeholderEl)}else{placeholderEl.detach()}}};var el=outerEl.find(".R5");outerEl[0].setAttribute("tabindex",-1);el.addClass("textAreaBaseStyle");if(options.useRawHTML){el.addClass("streak__textArea_rawHTML")}el[0].setAttribute("tabindex",-1);el.delayedSave({delay:4e3,saveFunction:function(){updateValue()},enter:options.enter});var placeholderEl=$('<div class="smartTextareaPlaceholder"></div>');if(options.placeholder){placeholderEl[0].innerHTML=options.placeholder}outerEl.focus(function(){el.focus()});el.focus(function(){if(el.hasClass("disabled")){return}placeholderEl.detach();outerEl.addClass(CONSTANTS.FOCUS_CLASS)});el.blur(function(){updateValue();updateDisplay();outerEl.removeClass(CONSTANTS.FOCUS_CLASS)});el.click(function(){el.focus()});if(options.model&&options.model.getIsEditable){setEnabled(options.model.getIsEditable())}switch(options.border){case"never":el.addClass("noTextareaBorder");break;case"hover":outerEl.addClass("noTextareaBorder");el.easyHoverClass(CONSTANTS.HOVER_CLASS,null,true,outerEl);break;case"always":el.addClass("textareaBorder");break;case"alwaysHover":outerEl.addClass(CONSTANTS.HOVER_CLASS);break}if(options.model){options.model.watch("set",updateDisplay,observer,options.property);updateDisplay()}return{el:outerEl,getElement:function(){return outerEl},focus:function(){el.focus()},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:observer});outerEl.find("*").unbind();outerEl.empty();outerEl.remove()},setModelAndProperty:function(inModel,inProperty){Streak.NotificationCenter.unsubscribe({observer:observer});options.model=inModel;options.property=inProperty;options.model.watch("set",updateDisplay,observer,options.property);updateDisplay()},placeholderEl:placeholderEl,setTab:setTab}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,BB=Streak.BentoBox;var CONSTANTS={HOVER_CLASS:"aco",FOCUS_CLASS:"acm"};BB.Widgets.SmartTextbox={template:'<div><input type="textbox"></div>',defaults:{model:null,border:"hover",enter:true,property:null,autoSave:true,onlyEnter:false,autoGrow:false,delay:300,delayedBind:false,allowEmpty:true},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.SmartTextbox.impl(o)}};BB.Widgets.SmartTextbox.impl=function(options){var observer={};var outerEl=$(BB.Widgets.SmartTextbox.template),el=outerEl.find("input"),bound=false,valueChanged=false,setTab=function(prev,next){el.easyTab({prev:prev,next:next})},setEnabled=function(enabled){el.prop("disabled",!enabled)},getValue=function(){return options.model.get(options.property)},updateValue=function(){if(!el.val()&&!currentValue){return}if(el.val()===currentValue){return}if(!options.allowEmpty&&!el.val()){updateDisplay(true);return}currentValue=el.val();options.model.set(options.property,el.val().trim());valueChanged=true},saveValue=function(){if(!valueChanged){return}valueChanged=false;options.model.save(function(){BB.Tracker.trackStreakActive({property:options.property,widget:"smartTextbox"},options.trackingContext)})},updateDisplay=function(force){if(force||getValue()!==currentValue){if(el.is(":focus"))return;el.val(getValue());el.change()}},clear=function(){el.val("");updateValue()},focus=function(){bind();currentValue=getValue();el.focus();arrowMode=false},set=function(val){el.val(val);focus();arrowMode=true},bind=function(){if(!bound){el.focus(function(e){outerEl.addClass(CONSTANTS.FOCUS_CLASS)});el.blur(function(){updateValue();saveValue();outerEl.removeClass(CONSTANTS.FOCUS_CLASS)});if(options.autoGrow){el.autoGrowInput()}BB.Keyboard.bindChordToElement(el,"escape",function(e){el.val(currentValue)});BB.Keyboard.bindChordToElement(el,"enter",function(e){el.blur();el.trigger("enterPressed")},true,true);BB.Keyboard.bindChordToElement(el,"up",function(e){if(arrowMode){el.trigger("upPressed")}});BB.Keyboard.bindChordToElement(el,"down",function(e){if(arrowMode){el.trigger("downPressed")}});BB.Keyboard.bindChordToElement(el,"right",function(e){if(el.caret().start===el.val().length){e.preventDefault();e.stopPropagation()}if(arrowMode){if(el.caret().start===el.val().length){el.trigger("rightPressed")}}});BB.Keyboard.bindChordToElement(el,"left",function(e){if(el.caret().start===0){e.preventDefault();e.stopPropagation()}if(arrowMode){if(el.caret().start===0){el.trigger("leftPressed")}}});el.addClass("bbBound");bound=true}},currentValue=getValue(),arrowMode=false;outerEl[0].setAttribute("class","smartInput streak__smartTextbox");outerEl[0].setAttribute("tabindex","-1");if(options.model.getIsEditable){setEnabled(options.model.getIsEditable())}options.model.watch("set",updateDisplay,observer,options.property);updateDisplay(true);switch(options.border){case"never":outerEl.addClass("textboxNoborder");break;case"hover":outerEl.addClass("textboxNoborder");outerEl.easyHoverClass("textboxBorder");break;case"gmailHover":el.addClass("R5");outerEl.easyHoverClass(CONSTANTS.HOVER_CLASS);break;case"always":outerEl.addClass("textboxBorder");break}if(!options.delayedBind){bind()}outerEl.focus(function(e){focus()});return{el:outerEl,setTab:setTab,clear:clear,focus:focus,set:set,getElement:function(){return outerEl},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:observer});outerEl.remove()}}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Streak.Object;var EmailInvoiceButtonController=Streak.Class.subclass({className:"EmailInvoiceButtonController",superclass:superclass,_memberVariables:[{name:"_button",get:true,destroy:false},{name:"_rowId",destroy:false}],_initialize:function(rowId){superclass.prototype._initialize.call(this);this._rowId=rowId;if(!this._rowId){throw new Error("rowId not initialized in EmailInvoiceButtonController")}this._setupButton()},_setupButton:function(){var self=this;this._button=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("email_invoice"),color:"blue",onFunction:function(){self.sendEmailInvoice()}})},sendEmailInvoice:function(){var self=this;BB.Tracker.track("invoice.email.send",this.rowId);this._sendEmailInvoicePromise().then(function(){BB.ButterBarManager.showMessage({message:BB.Locale.getString("email_invoice_success"),messageKey:"email_invoice"})}).catch(function(error){BB.Tracker.track("invoice.email.send.failed",self.rowId);BB.ButterBarManager.showError(BB.Locale.getString("email_invoice_failure"),{messageKey:"email_invoice"})})},_sendEmailInvoicePromise:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){var emailInvoiceOperation=Library.getInstance("BentoBox.Modules.Paywall.EmailInvoiceOperation",{invoiceId:self._rowId});var operationProgressId=Streak.Operations.OperationQueue.Singleton.addOperation(emailInvoiceOperation);BB.ButterBarManager.showMessage({message:BB.Locale.getString("email_invoice_start"),operationProgressId:operationProgressId,messageKey:"email_invoice"});var complete=function(notification){if(notification.operationHasErrors){reject()}else{resolve()}};Streak.NotificationCenter.subscribe({observer:{},filterParameters:{operationIsComplete:true,operationProgressId:operationProgressId},unsubscribeImmediately:true,functionToCall:complete})})}});Library.set("BentoBox.Widgets.EmailInvoiceButtonController",EmailInvoiceButtonController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,BB=Streak.BentoBox;FilterableGroupList={templates:{},defaults:{searchInput:null,closedSectionList:[],openFunc:$.noop,closeFunc:$.noop,selectFunc:$.noop,compareFunc:$.noop,parentHeaderClass:"titleSection",itemClass:"menuItem",selectedClass:"J-N-JT",highlightClass:"J-N-JT"},create:function(options){var o={};_.extend(o,this.defaults,options);return new FilterableGroupList.impl(o)}};FilterableGroupList.impl=function(options){var el=$(document.createElement("div"));var data=null;var cursor=BB.Cursor.create({selectedClass:options.selectedClass,selectFunc:function(el,isEnter){if(el.hasClass("titleSection")){el.trigger("bbCursorClick")}else{options.selectFunc(el.data("groupListData"))}},highlightOnHover:true,selectOnClick:true,rollOver:true,input:options.searchInput});var filterText="";var closedSectionList=options.closedSectionList||[];function render(){el.empty();_.each(data,function(index,key){var added=[];var collapsable=BB.Widgets.CollapseSection.create({title:data[key].title,startOpen:closedSectionList.indexOf(key)===-1,titleClick:false,openFunc:function(){closedSectionList.removeVal(key);options.openFunc(closedSectionList);collapsable.bodySection.find("."+options.itemClass).addClass("cursorItem");
setupCursor()},closeFunc:function(){closedSectionList=_.union(closedSectionList,[key]);options.closeFunc(closedSectionList);collapsable.bodySection.find(".cursorItem").removeClass("cursorItem");setupCursor()}});var isOpen=closedSectionList.indexOf(key)===-1;collapsable.titleSection.addClass("cursorItem");var list=data[key].list;for(var ii=0;ii<list.length;ii++){if(!options.compareFunc(filterText,list[ii].data)){continue}var item=BB.Widgets.Menu.createItem(list[ii].display);item.data("groupListData",list[ii].data);item.addClass(options.itemClass);if(isOpen){item.addClass("cursorItem")}collapsable.bodySection.append(item);added.push(item)}if(added.length>0){el.append(collapsable.el);collapsable.titleSection.find(".bbResults").remove();collapsable.titleSection.find(".title").append('<span class="bbResults">('+added.length+")</span>")}});setupCursor()}function setData(inData,inClosedSectionList){data=inData;filterText="";closedSectionList=inClosedSectionList||[];render()}function addSection(section){_.extend(data,section);render()}function setupCursor(){var position=cursor.getPosition();cursor.setup(el.find(".cursorItem"));cursor.setPosition(position)}options.searchInput.delayedSave({delay:100,saveFunction:function(isEnter){if(!isEnter){filterText=options.searchInput.val();render()}},dontPropagate:true});return{el:el,render:render,setData:setData}};BB.Widgets.FilterableGroupList=FilterableGroupList})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,BB=Streak.BentoBox;BB.Widgets.FirstPipelinePromo={templates:{},defaults:{width:"300px",useBentoBoxTitle:false,buttonFirst:false,showBottomBorder:false},create:function(options){var o={};_.extend(o,this.defaults,options);return new BB.Widgets.FirstPipelinePromo.impl(o)}};BB.Widgets.FirstPipelinePromo.impl=function(options){var el=HTML.get("firstPipelinePromo",true);el.css("width",options.width);if(options.useBentoBoxTitle){el.find(".firstPipelineTitle").html("Streak")}else{el.find(".firstPipelineTitle").hide()}if(options.showBottomBorder){el.find(".am6").show()}if(options.buttonFirst){var buttonContainer=el.find(".newPipelineContainer");buttonContainer.detach();buttonContainer.insertAfter(el.find(".firstPipelineTitle"))}var createButton=BB.Widgets.Button.create({name:BB.Locale.getString("create_first_pipeline"),onFunc:function(){BB.FirstRun.showStageModal(1)},isToggle:false,color:"blue"});el.find(".newPipelineContainer").append(createButton.el);return{el:el}}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Template=Streak.Template,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var FeedListViewController=Streak.Class.subclass({className:"FeedListViewController",superclass:Streak.Object,_memberVariables:[{name:"_model",destroy:false},{name:"_scrollViewport",destroy:false},{name:"_closeCallback",destroy:false},{name:"_element",destroy:true,get:true},{name:"_feedListContent",destroy:false},{name:"_mostRecentFeedListData",destroy:true},{name:"_postCommentViewController",destroy:true},{name:"_titlePositions",destroy:true}],_initialize:function(options){Streak.Object.prototype._initialize.call(this);this._element=HTML.getElement("feedList");this._feedListContent=this._element.find(".feedListContent");this._model=options.model;this._closeCallback=options.closeCallback;this._scrollViewport=options.scrollViewport||this._element.find(".feedListContentScrollable");this._manualTop=options.manualTop;if(options.usePostWidget){this._setupPostWidget()}this._setupFilterButtons();this._addEventTracking();this._watchModel();this._setupScrollHandler();this.refresh(true)},filterMode:{ALL:"ALL",IMPORTANT:"IMPORTANT",COMMENTS:"COMMENTS"},_setupPostWidget:function(){if(!this._isBox()){throw new Error("FeedList widget can only have comment widget in a box")}this._postCommentViewController=new BB.Widgets.PostCommentViewController(this._model,this);this._element.find(".postCommentWidget").html(this._postCommentViewController.getElement())},_setupFilterButtons:function(){var self=this;this._$all=this._element.find(".feedListOption.allFilter");this._$important=this._element.find(".feedListOption.importantFilter");this._$comments=this._element.find(".feedListOption.commentsFilter");if(this._isBox()){this._$important.remove();this.chooseFilter(BB.LocalSettings.get("boxView/feed/filterMode")||this.filterMode.ALL)}else{this._$comments.remove();this.chooseFilter(BB.LocalSettings.get("pipelineView/feed/filterMode")||this.filterMode.IMPORTANT)}this._$all.click(this._filterClick.bind(this,this.filterMode.ALL));this._$important.click(this._filterClick.bind(this,this.filterMode.IMPORTANT));this._$comments.click(this._filterClick.bind(this,this.filterMode.COMMENTS));var $close=this._element.find(".streak__feedListCloseBtn");if(!this._closeCallback){$close.remove()}else{$close.click(function(e){e.preventDefault();self._closeCallback()})}},_filterClick:function(filter,e){e.preventDefault();e.stopPropagation();this.chooseFilter(filter);if(this._isBox()){BB.LocalSettings.set("boxView/feed/filterMode",filter)}else{BB.LocalSettings.set("pipelineView/feed/filterMode",filter)}},chooseFilter:function(filter){if(this._currentFilter==filter){return}var oldFilter=this._currentFilter;this._currentFilter=filter;switch(this._currentFilter){case this.filterMode.ALL:this._$all.addClass("selected");this._$important.removeClass("selected");this._$comments.removeClass("selected");break;case this.filterMode.IMPORTANT:this._$all.removeClass("selected");this._$important.addClass("selected");this._$comments.removeClass("selected");break;case this.filterMode.COMMENTS:this._$all.removeClass("selected");this._$important.removeClass("selected");this._$comments.addClass("selected");break;default:throw new Error("Invalid newsfeed filter mode")}this.refresh(true)},_setupScrollHandler:function(){this._boundResizeHandler=this._configureScrollHandler.bind(this);$(window).on("resize",this._boundResizeHandler);this._boundScrollHandler=this._onscroll.bind(this);this._scrollViewport.on("scroll",this._boundScrollHandler)},_onscroll:function(e){if(!this._titlePositions||!this._titlePositions.length){return}var yPos=this._scrollViewport.scrollTop();yPos-=this._feedListContent.children().offset().top-this._scrollViewport.children().offset().top;var titlePosLen=this._titlePositions.length;for(var i=0;i<titlePosLen;i++){if(this._titlePositions[i].top>=yPos){break}}var newStickyTitleIndex=i-1;var followingTitleIndex=i;var newStickyTitle=this._titlePositions[newStickyTitleIndex];var followingTitle=this._titlePositions[followingTitleIndex];if(newStickyTitle!==this._currentStickyTitle){if(this._currentStickyTitle&&this._currentStickyTitle.$el){this._currentStickyTitle.$spacer.hide();this._currentStickyTitle.$el.removeClass("streak__feedListSectionTitleSticky").css({position:"static",top:""})}if(newStickyTitle&&newStickyTitle.$el){newStickyTitle.$spacer.show();newStickyTitle.$el.addClass("streak__feedListSectionTitleSticky").css({position:"absolute"})}this._currentStickyTitle=newStickyTitle}if(newStickyTitle&&newStickyTitle.$el){var shift=0;if(followingTitle){shift=followingTitle.top-yPos-newStickyTitle.height;if(shift>0){shift=0}}if(this._manualTop){shift+=yPos}newStickyTitle.$el.css("top",shift+"px")}},reconfigureSize:function(){this._configureScrollHandler()},_configureScrollHandler:_.throttle(function(){if(!this._element){return}if(!this._feedListContent){return}var titlePositions=[];var $sectionTitles=this._feedListContent.find(".streak__feedListSectionTitle");if($sectionTitles.length){var topOffset=this._feedListContent.children().position().top;$sectionTitles.each(function(i){var $this=$(this);var height=$this.outerHeight();var $spacer=$this.next(".streak__spacer");if(!$spacer.length){$spacer=$("<div/>").addClass("streak__spacer").hide().insertAfter($this)}$spacer.css("height",height);var top=($spacer.is(":visible")?$spacer:$this).position().top-topOffset;titlePositions.push({top:top,height:height,$el:$this,$spacer:$spacer})});var $lastChild=this._feedListContent.children().last();titlePositions.push({top:$lastChild.position().top-topOffset+$lastChild.height()})}this._titlePositions=titlePositions;this._onscroll()},500),_destroyScrollHandler:function(){$(window).off("resize",this._boundResizeHandler);if(this._scrollViewport){this._scrollViewport.off("scroll",this._boundScrollHandler)}},newCommentPosted:function(){this.refresh()},refresh:_.debounce(function(notQuiet){this._refresh(notQuiet)},100),_refresh:function(notQuiet){if(!this._model||!this._model.key||!this._model.key()){return}var self=this;if(this._currentRequest){this._currentRequest.cancel()}if(notQuiet){this._mostRecentFeedListData=this._titlePositions=null;this._feedListContent.html(HTML.getElement("feedListLoading"))}var path;if(this._isBox()){path="boxes/"+this._model.key()+"/newsfeed"}else{path="pipelines/"+this._model.key()+"/newsfeed"}var queryParameters=this._getWhatParams();this._currentRequest=Streak.APIRequester.get(path,queryParameters);this._currentRequest.getPromise().then(this._renderFeedItems.bind(this),function(err){if(!self._model||err.message=="Canceled"){return}self._feedListContent.find(".streak__feedListLoading").remove();self._feedListContent.append($("<div/>").addClass("streak__feedListNotice").text(BB.Locale.getString("feed_load_fail")))})},_getWhatParams:function(){switch(this._currentFilter){case this.filterMode.IMPORTANT:return{detailLevel:"CONDENSED"};case this.filterMode.COMMENTS:return{detailLevel:"COMMENTS_ONLY"};default:return{detailLevel:"ALL"}}},_getNewsfeedFilterSetting:function(settingKey,defval){var modelType=this._isBox()?"box":"pipeline";var setting=BB.UserSettings.getSetting("newsFeed/"+modelType+"/"+this._model.key()+"/"+settingKey);if(setting===undefined||setting===""){setting=BB.UserSettings.getSetting("newsFeed/pipeline/global/"+settingKey);return setting===undefined||setting===""?defval:setting}else{return setting}},_rerender:function(){if(this._mostRecentFeedListData){this._renderFeedItems(this._mostRecentFeedListData)}},_renderFeedItems:function(items){if(!this._feedListContent){return}var self=this;this._mostRecentFeedListData=items;var today=Streak.moment().startOf("day");var groupings=[{name:"today",time:today},{name:"yesterday",time:today.clone().subtract("days",1)},{name:"this_week",time:today.clone().startOf("week")},{name:"last_week",time:today.clone().startOf("week").subtract("weeks",1)},{name:"this_month",time:today.clone().startOf("month")},{name:"last_month",time:today.clone().startOf("month").subtract("months",1)},{name:"this_year",time:today.clone().startOf("year")},{name:"last_year",time:today.clone().startOf("year").subtract("years",1)},{name:"long_ago"}];var groupedItems=_.groupBy(items,function(item){var timestamp=Streak.moment(item.timestamp);return _.find(groupings,function(grouping){return!grouping.time||timestamp>=grouping.time}).name});self._feedListContent.empty();_.each(groupings,function(grouping){var group=_.filter(groupedItems[grouping.name],function(itemData){if(self._isBox()&&!BB.Data.getBox(itemData.boxKey)){return false}if(!BB.Data.getPipeline(itemData.pipelineKey)){return false}return true});if(group.length==0){return}group=_.sortBy(group,function(itemData){return-itemData.timestamp});var groupname=BB.Locale.getString("newsfeed_time_"+grouping.name);var groupSection=HTML.getElement("feedListSection");groupSection.find(".streak__feedListSectionTitle").text(groupname);self._feedListContent.append(groupSection);_.each(group,function(itemData){try{var storyPipeline=BB.Data.getPipeline(itemData.pipelineKey);var date=Date.create(itemData.timestamp);var rowElement=$("<div/>").addClass("bb_feeditem").html(Template.underscore("widgets/feedList/feedListRow")({datetime:date.getGmailFormatted(true),completeDatetime:date.customFormat("longDateTime"),storyHtml:self._generateStoryHtml(itemData),userImageUrl:self._getUserImageUrl(itemData),comment:self._getComment(itemData),detail:self._getDetailText(itemData),objects:self._getObjects(itemData)}));if(self._getComment(itemData)){rowElement.addClass("hasComment")}self._setupPipelineLink(rowElement,storyPipeline);rowElement.addClass("loaded");groupSection.find(".streak__feedListSectionContent").append(rowElement)}catch(e){BB.logError("Error rendering newsfeed item",e)}})});if(self._feedListContent.html().trim()==""){self._feedListContent.append($("<div/>").addClass("streak__feedListNotice").text(BB.Locale.getString("feed_load_nothing")))}this._setupBoxLinks(this._feedListContent);this._configureScrollHandler()},_getObjects:function(itemData){if(itemData.boxKey&&itemData.boxKey!==this._model.key()){var boxname;var box=Streak.BentoBox.Data.getBox(itemData.boxKey);if(box){boxname=box.get("name")}else if(itemData.newsfeedEntrySpecific!="ADD_LINKED_BOX"&&itemData.newsfeedEntrySpecific!="REMOVE_LINKED_BOX"){boxname=itemData.specificVariables.BOX_NAME}else{boxname="(deleted)"}return[Template.underscore("widgets/feedList/boxObject")({name:boxname,key:itemData.boxKey})]}},_generateStoryHtml:function(itemData){var storyVariables=_.clone(itemData.specificVariables);var story=itemData.storyText||itemData.storyTextBox||itemData.storyTextPipeline||itemData.storyTextGlobal;if(!story){throw new Error("Server did not give story for newsfeed entry key "+itemData.newsfeedEntryKey)}switch(storyVariables.FIELD_TYPE){case"DATE":var value=storyVariables.FIELD_VALUE;if(!value){storyVariables.FIELD_VALUE=""}else{storyVariables.FIELD_VALUE=Date.create(storyVariables.FIELD_VALUE).customFormat("shortDate")}break;case"PERSON":try{var list=JSON.parse(storyVariables.FIELD_VALUE);var arr=[];for(var ii=0;ii<list.length;ii++){var name=list[ii].displayName||list[ii].fullName||list[ii].email;if(name===undefined){throw new Error("No displayName or fullName property found for person")}arr.push(name)}storyVariables.FIELD_VALUE=arr.join(", ")}catch(err){BB.logError("Could not parse person JSON",err,{FIELD_VALUE:storyVariables.FIELD_VALUE,newsfeedEntryKey:itemData.newsfeedEntryKey});storyVariables.FIELD_VALUE=""}break}var sanitizedStoryVariables=this._sanitizeStoryVariables(storyVariables);sanitizedStoryVariables.BOX='<a href="#" class="streak__newsfeed_box">BOX</a>';sanitizedStoryVariables.PIPELINE='<a href="#" class="streak__newsfeed_pipeline">PIPELINE</a>';sanitizedStoryVariables.STORY_AUTHOR_DISPLAY_NAME='<span class="streak__author_name">'+storyVariables.STORY_AUTHOR_DISPLAY_NAME+"</span>";try{_.each(sanitizedStoryVariables,function(value,name){var search=new RegExp(Streak.Utils.RegExpQuote("<"+name+">"),"g");story=story.replace(search,value.replace(/\$/g,"$$$$"))})}catch(e){BB.logError("newsfeed failed to render story template",null,{story:story,sanitizedStoryVariables:sanitizedStoryVariables});story=story.escapeHTML()}return story},_sanitizeStoryVariables:function(storyVariables){var sanitizedStoryVariables={};for(var variable in storyVariables){var value=storyVariables[variable];if(value){sanitizedStoryVariables[variable]=(""+value).escapeHTML()}else{sanitizedStoryVariables[variable]=value}}return sanitizedStoryVariables},_getUserImageUrl:function(itemData){if(itemData.userImageUrl){return itemData.userImageUrl}return itemData.userImageUrl=Streak.server+Streak.combinedPath+"images/unknownContact.png"},_getComment:function(itemData){if(itemData.detailText){var detailTextKey=itemData.detailText.replace(/[<>]/g,"");if(detailTextKey==="COMMENT"){return itemData.specificVariables[detailTextKey]}}},_getDetailText:function(itemData){if(itemData.detailText){var detailTextKey=itemData.detailText.replace(/[<>]/g,"");if(detailTextKey!=="COMMENT"){return itemData.specificVariables[detailTextKey]}}},_setupBoxLinks:function(el){el.find("a.streak__newsfeed_box").each(function(){var $this=$(this);var boxkey=$this.attr("data-key");if(!boxkey){BB.logError("newsfeed box link had no key");return}var box=BB.Data.getBox(boxkey);if(!box){$this.addClass("deleted")}else{$this.attr("href","#"+box.link())}}).off("click").click(function(e){e.preventDefault();e.stopPropagation();var $this=$(this);var boxkey=$this.attr("data-key");if(!boxkey){return}var box=BB.Data.getBox(boxkey);if(!box){BB.ButterBarManager.showError("That box could not be found.")}else{BB.UI.setURL(box.link())}})},_setupPipelineLink:function(rowElement,storyPipeline){var pipelineLink=rowElement.find(".streak__newsfeed_pipeline");if(pipelineLink.length===0){return}pipelineLink.text(storyPipeline.displayNameText());pipelineLink.on("click",function(e){e.preventDefault();e.stopPropagation();BB.UI.setURL(storyPipeline.link())})},_addEventTracking:function(){BB.Tracker.addDelegatedTracking(this._element,"a.streak__newsfeed_box","click",{eventName:"BoxClicked",widget:"Newsfeed"});BB.Tracker.addDelegatedTracking(this._element,"a.streak__newsfeed_pipeline","click",{eventName:"PipelineClicked",widget:"Newsfeed"})},_watchModel:function(){this._model.watch("newComment",this.refresh.bind(this,false),this);NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationIsComplete:true},observer:this,functionToCall:this._operationCompleted})},_operationCompleted:function(notification){if(notification.operationHasErrors){return}if(!notification.operation||!notification.operation.getModel||!notification.operation.getModel()){return}var model=notification.operation.getModel();if(model===this._model){this.refresh();return}},_isBox:function(){return this._model instanceof BB.Models.Box},destroy:function(){this._destroyScrollHandler();NotificationCenter.unsubscribe({observer:this});Streak.Object.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.FeedListViewController",FeedListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var IframeBridge=function(options){var self=this;self._path=options.path;self._cssClass=options.cssClass;self._uniqueId=(Math.random()+"").replace(".","_");self._rawIframe=null;self._iframe=null;self._iframeLoaded=false;self._messageQueue=[];self._constructIframe()};_.extend(IframeBridge.prototype,{_constructIframe:function(){var self=this;var iframe=Streak.$('<iframe class="'+this._cssClass+'"  src="'+Streak.server+"/clientiFrames/"+self._path+'.jsp"></iframe>');self._rawIframe=iframe[0];self._iframe=iframe;self._iframe.load(function(){self._iframeLoaded=true;self.handleQueuedMessages()})},sendMessage:function(functionName,jsonObj){var self=this;var encodedObj={functionName:functionName,args:jsonObj};self.handleMessage(encodedObj)},handleQueuedMessages:function(message){self=this;for(var i=0;i<self._messageQueue.length;i++){self.postMessageToIframe(self._messageQueue[i])}},handleMessage:function(message){var self=this;if(self._iframeLoaded){self.postMessageToIframe(message)}else{self._messageQueue.push(message)}},postMessageToIframe:function(message){this._rawIframe.contentWindow.postMessage(message,this._rawIframe.src)},addHandlerForIncomingMessages:function(callback){var self=this},getFrameElement:function(){return this._iframe},destroy:function(){this._iframe.remove()},_handleMessage:function(event){var self=this},fff:function(){}});BB.Widgets.IframeBridge=IframeBridge})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Menu={templates:{},defaults:{css:null,maxHeight:350},init:function(callback){this.templates.menu=HTML.get("menuMenu");this.templates.item=HTML.get("menuMenuItem");this.templates.headerItem=HTML.get("menuHeaderItem");this.templates.checkItem=HTML.get("menuCheckItem");this.templates.radioItem=HTML.get("menuRadioItem");if(callback){callback()}},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)},createItem:function(html){var item=$(document.createElement("div"));item[0].innerHTML=this.templates.item();item=item.children();item.find(".text").empty().append(html);return item}};Menu.impl=function(o){var options=o,menu=$(document.createElement("div")),header=null,body=null,footer=null;var isLast=options.isLast;var subMenus=[];var addItem=function(html,cb,prepend){var item=createItem(html,cb);addItemToBody(item,prepend);return item},createItem=function(html,cb){var item=$(document.createElement("div"));item[0].innerHTML=Menu.templates.item();item=item.children();item.find(".text").empty().append(html);var enabled=true;item.setEnabled=function(_enabled){enabled=_enabled;if(enabled){this.removeClass("disabled");this.attr("aria-disabled",false)}else{this.addClass("disabled");this.attr("aria-disabled",true)}};item.getEnabled=function(){return enabled};if(cb){item.click(function(e){if(enabled){cb(e)}})}item.superEasyHoverClass("J-N-JT");return item},addHeaderItem=function(html){var item=$(document.createElement("div"));item[0].innerHTML=Menu.templates.headerItem();item=item.children();item.find(".text").empty().append(html);addItemToBody(item);return item},addItemToHeader=function(item,prepend){if(prepend){header.prepend(item)}else{header.append(item)}body.addClass("streak__bodyMenu_overflowAuto")},addItemToBody=function(item,prepend){if(prepend){body.prepend(item)}else{body.append(item)}},addItemToFooter=function(item,prepend){if(prepend){footer.prepend(item)}else{footer.append(item)}body.addClass("streak__overflowAuto")},addSeparator=function(prepend){var item=createSeparator();addItemToBody(item,prepend);return item},createSeparator=function(){var item=document.createElement("div");item.setAttribute("class","J-Kh");item.setAttribute("role","separator");return $(item)},addCheckItem=function(html,cb,startChecked){var item=createCheckItem(html,cb,startChecked);addItemToBody(item);return item},createCheckItem=function(html,cb,startChecked){var isChecked=startChecked;var item=$(document.createElement("div"));item[0].innerHTML=Menu.templates.checkItem();item=item.children();item.find(".text").html(html);if(isChecked){item.addClass("J-LC-JR-Jp")}else if(isChecked===null){item.addClass("J-LC-Ky-Jp")}if(cb){item.click(function(e){isChecked=isChecked===null?false:!isChecked;if(!isChecked){item.removeClass("J-LC-JR-Jp");item.removeClass("J-LC-Ky-Jp")}else{item.addClass("J-LC-JR-Jp");item.removeClass("J-LC-Ky-Jp")}cb(isChecked,e)})}item.superEasyHoverClass("J-N-JT");item.setCheckboxState=function(checkboxState){isChecked=checkboxState;item.toggleClass("J-LC-Ky-Jp",isChecked===null);item.toggleClass("J-LC-JR-Jp",!!isChecked)};var enabled=true;item.setEnabled=function(_enabled){enabled=_enabled;if(enabled){this.removeClass("disabled");this.attr("aria-disabled",false)}else{this.addClass("disabled");this.attr("aria-disabled",true)}};item.getEnabled=function(){return enabled};return item},addRadioGroup=function(groupName){var item=createRadioGroup(groupName);addItemToBody(item);return item},createRadioGroup=function(groupName){var item=$(document.createElement("div"));item.addClass(groupName);item.addClass("J-awr");return item},addRadioItem=function(html,radioGroup,cb,startChecked){var isChecked=startChecked;var item=$(document.createElement("div"));item[0].innerHTML=Menu.templates.radioItem();item=item.children();item.find(".text").html(html);if(isChecked){item.addClass("J-Ks-KO")}if(cb){item.click(function(e){radioGroup.find(".radioItem").removeClass("J-Ks-KO");item.addClass("J-Ks-KO");isChecked=true;cb(isChecked,e)})}item.superEasyHoverClass("J-N-JT");radioGroup.append(item);return item},addSubMenu=function(phtml,psubMenu,itemOptions){var html=phtml,subMenu=psubMenu,menuClicked=false;var itemType;var itemCallback;if(itemOptions){itemType=itemOptions.itemType;itemCallback=itemOptions.itemCallback}var item;if(itemType==="checkItem"){item=addCheckItem(html,function(isChecked,e){if(!menuClicked){if(itemCallback){itemCallback()}e.stopPropagation()}menuClicked=false})}else{item=addItem(html,function(e){if(!menuClicked){if(itemCallback){itemCallback()}e.stopPropagation()}menuClicked=false})}subMenus.push(subMenu);subMenu.setIsLast(isLast);subMenu.el.click(function(){menuClicked=true});subMenu.el[0].style.position="fixed";item.addClass("subMenuItem");item.append('<span class="outerMenuArrow"><span class="menuArrow"></span></span>');item.append(subMenu.el);var hideTimeout;item.hover(function(){if(!item.getEnabled()){return}subMenu.el.show();clearTimeout(hideTimeout);var pos={top:item.offset().top,left:item.offset().left+menu.outerWidth()-5};if(isLast){pos.left+=-1*(menu.outerWidth()+subMenu.el.outerWidth())+5}subMenu.el.css(pos);subMenu.el.containByScreen(item,{isAligned:true,isTopAligned:true,forceFit:true})},function(){hideTimeout=setTimeout(function(){subMenu.el.hide()},100)});return item},hideHeader=function(){header.hide()},hideBody=function(){body.hide()},hideFooter=function(){footer.hide()},showHeader=function(){header.show()},showBody=function(){body.show()},showFooter=function(){footer.show()},addSection=function(html,prepend){if(prepend){body.prepend(html)}else{body.append(html)}return html},empty=function(){header.empty();body.empty();footer.empty()},reset=function(){menu.find(".J-N-JT").removeClass("J-N-JT");menu.find(".hover").removeClass("hover");menu.find(".bb_menu").hide();menu.find(".J-LC-JR-Jp").removeClass("J-LC-JR-Jp")};menu.addClass("J-M uEPqDe bb_menu");if(options.css){menu.css(options.css)}menu[0].innerHTML=Menu.templates.menu();header=menu.find(".menuHeader");body=menu.find(".menuBody");footer=menu.find(".menuFooter");if(options.maxHeight){menu.css("max-height",options.maxHeight)}if(options.bodyMaxHeight){body.css("max-height",options.bodyMaxHeight)}return{el:menu,addItem:addItem,addHeaderItem:addHeaderItem,addItemToBody:addItemToBody,addItemToHeader:addItemToHeader,addItemToFooter:addItemToFooter,addCheckItem:addCheckItem,addSubMenu:addSubMenu,addSeparator:addSeparator,addSection:addSection,addRadioGroup:addRadioGroup,addRadioItem:addRadioItem,createCheckItem:createCheckItem,createItem:createItem,createRadioGroup:createRadioGroup,createSeparator:createSeparator,hideHeader:hideHeader,hideBody:hideBody,hideFooter:hideFooter,showHeader:showHeader,showBody:showBody,showFooter:showFooter,empty:empty,reset:reset,getElement:function(){return menu},setIsLast:function(pIsLast){isLast=pIsLast;for(var ii=0;ii<subMenus.length;ii++){if(subMenus[ii]&&subMenus[ii].setIsLast){subMenus[ii].setIsLast(isLast)}}},destroy:function(){menu.remove()}}};Streak.DependencyManager.addFunction({functionKey:"menuInitialized",functionToCall:Menu.init,functionContext:Menu,dependentFunctionKeys:["htmlLoaded","localeLoaded"]});BB.Widgets.Menu=Menu})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,UI=Streak.UI,Reports=Streak.BentoBox.Widgets,Locale=Streak.Locale;var superclass=UI.ViewController;BB.Widgets.CollapsibleMultiselectMenuViewController=Streak.Class.subclass({className:"CollapsibleMultiselectMenuViewController",superclass:superclass,memberVariables:[{name:"_menuButton",destroy:true},{name:"_menu",destroy:true},{name:"_collapseItem",destroy:false},{name:"_expandItem",destroy:false},{name:"_items",destroy:false},{name:"_headerSeparator",destroy:false},{name:"_footerSeparator",destroy:false},{name:"_collapsed",destroy:false},{name:"_buttonPrefix",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._items={};this._collapsed=false},create:function(options){var self=this;var menuOptions=options.menuOptions||{};if(menuOptions.bodyMaxHeight===undefined){menuOptions=_.extend(menuOptions,{bodyMaxHeight:150})}this._menu=BB.Widgets.Menu.create(menuOptions);this._buttonPrefixHTML=options.buttonPrefixHTML||"";this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton(_.extend(options.buttonOptions,{menu:this._menu}));var headerGroup=this._menu.createRadioGroup("header");this._menu.addItemToHeader(headerGroup);this._collapseItem={label:options.collapseItem.label,value:options.collapseItem.value};this._expandItem={label:options.expandItem.label};this._menu.addRadioItem(options.collapseItem.label,headerGroup,_.bind(this._collapseItemChanged,this),true);this._menu.addRadioItem(options.expandItem.label,headerGroup,_.bind(this._expandItemChanged,this),false);this._headerSeparator=this._menu.createSeparator();this._menu.addItemToHeader(this._headerSeparator);this._footerSeparator=this._menu.createSeparator();this._menu.addItemToFooter(this._footerSeparator);var selectAllItem=this._menu.createItem(options.selectAllItem.label,_.bind(this._selectAllChosen,this));this._menu.addItemToFooter(selectAllItem);var selectNoneItem=this._menu.createItem(options.selectNoneItem.label,_.bind(this._deselectAllChosen,this));this._menu.addItemToFooter(selectNoneItem);var items=options.items;for(var i=0;i<items.length;i++){var item=items[i];var checkboxItem=this._menu.addCheckItem(item.label,_.bind(this._selectionChangedFunction(item.value),this),item.selected);this._items[item.value]={label:item.label,value:item.value,checkbox:checkboxItem,selected:item.selected}}this._collapse();this._view.addSubView(this._menuButton);return this},_collapseItemChanged:function(isChecked){if(isChecked){this._collapse();this._menuButton.off();this._reportChange()}},_expandItemChanged:function(isChecked){if(isChecked){this._expand();this._reportChange()}},_selectionChangedFunction:function(value){var self=this;return function(isChecked){self._items[value].selected=isChecked;self._reportChange()}},_selectAllChosen:function(){this._selectAll();this._reportChange()},_selectAll:function(){for(var value in this._items){this._items[value].checkbox.setCheckboxState(true);this._items[value].selected=true}},_deselectAllChosen:function(){this._deselectAll();this._reportChange()},_deselectAll:function(){for(var value in this._items){this._items[value].checkbox.setCheckboxState(false);this._items[value].selected=false}},_collapse:function(){if(this._collapsed){return}this._collapsed=true;this._headerSeparator.hide();this._menu.hideBody();this._menu.hideFooter();this._refreshButtonText()},_expand:function(){if(!this._collapsed){return}this._selectAll();this._collapsed=false;this._headerSeparator.show();this._menu.showBody();this._menu.showFooter();this._refreshButtonText()},_refreshButtonText:function(){var buttonText="";if(this._collapsed){buttonText=this._collapseItem.label}else{var selections=this._getSelections();if(selections.length===1){buttonText=this._items[selections[0]].label}else{buttonText=selections.length?Locale.getString("number_selected",{number:selections.length}):Locale.getString("none_selected")}}this._menuButton.setHTML(this._buttonPrefixHTML+buttonText)},_getSelections:function(){if(this._collapsed){return this._collapseItem.value}else{selectedValues=[];for(value in this._items){if(this._items[value].selected){selectedValues.push(value)}}}return selectedValues},_reportChange:function(){this._callDelegateFunction("multiselectMenuSelectionsChanged",{delegator:this,selections:this._getSelections()});if(this._menuButton){this._refreshButtonText()}}})})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Library=Streak.Library,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var ListViewViewController=Streak.Class.subclass({className:"ListViewViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_dataSource",destroy:false,set:true,get:true},{name:"_currentSection",destroy:true,defaultValue:0},{name:"_currentRow",destroy:true,defaultValue:0},{name:"_selectedSection",destroy:true,defaultValue:0},{name:"_selectedRow",destroy:true,defaultValue:0},{name:"_cursor",destroy:true},{name:"_rowSelectionLocked",destroy:true,defaultValue:false}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._cursor=new BB.Modules.CursorController;this._cursor.addDelegate(this);var self=this;this._delayedUnblockMouseEvents=_.debounce(function(){if(!self._view){return}self._view.unblockMouseEvents()},500)},_setupView:function(){this._view=new BB.Widgets.ListView.ListViewView
},keyPressed:function(keycode,isCursorAtEnd){this._cursor.keyPressed(keycode,isCursorAtEnd)},keydown:_.debounce(function(event,isCursorAtEnd){this._cursor.keydown(event,isCursorAtEnd)},10,true),setDataSource:function(dataSource){this._dataSource=dataSource;this._view.setDataSource(dataSource);dataSource.addDelegate(this);if(this._dataSource.getWrapperClass){this._view.getElement().addClass(this._dataSource.getWrapperClass())}},_highlightCurrentRow:function(){this._highlightRow(this._currentSection,this._currentRow)},_highlightRow:function(sectionIndex,rowIndex){this._view.highlightRow(sectionIndex,rowIndex)},_unhighlightCurrentRow:function(){this._unhighlightRow(this._currentSection,this._currentRow)},_unhighlightRow:function(sectionIndex,rowIndex){this._view.unhighlightRow(sectionIndex,rowIndex)},_selectRow:function(){this._selectedSection=this._currentSection;this._selectedRow=this._currentRow;this._view.selectRow(this._currentSection,this._currentRow)},_deselectRow:function(){this._view.deselectRow(this._selectedSection,this._selectedRow)},_selectNextRow:function(){if(this._rowSelectionLocked){return}this._unhighlightCurrentRow();this._moveToNextRow();this._highlightCurrentRow()},_selectPreviousRow:function(){if(this._rowSelectionLocked){return}this._unhighlightCurrentRow();this._moveToPreviousRow();this._highlightCurrentRow()},_moveToNextRow:function(times){if(this._rowSelectionLocked){return}times=times||1;if(times>100){return}this._currentRow++;if(this._currentRow>=this._dataSource.numberOfRowsForSection(this._currentSection)){this._currentRow=0;this._currentSection++;if(this._currentSection>=this._dataSource.numberOfSections()){this._currentSection=0}if(this._dataSource.numberOfRowsForSection(this._currentSection)===0){this._moveToNextRow(times+1);return}}this._notifyMovedHighlightedRow()},_moveToPreviousRow:function(times){if(this._rowSelectionLocked){return}times=times||1;if(times>100){return}this._currentRow--;if(this._currentRow<0){this._currentSection--;if(this._currentSection<0){this._currentSection=this._dataSource.numberOfSections()-1}if(this._dataSource.numberOfRowsForSection(this._currentSection)===0){this._moveToPreviousRow(times+1);return}this._currentRow=this._dataSource.numberOfRowsForSection(this._currentSection)-1}this._notifyMovedHighlightedRow()},_resetCursor:function(){this._currentRow=-1;this._currentSection=-1},getHighlightedRowData:function(){return this._getRowData()},_getRowData:function(sectionIndex,rowIndex){sectionIndex=_.isReal(sectionIndex)?sectionIndex:this._currentSection;rowIndex=_.isReal(rowIndex)?rowIndex:this._currentRow;return this._dataSource.infoForRow(sectionIndex,rowIndex)},rowHovered:function(sectionIndex,rowIndex){if(this._rowSelectionLocked){return}this._currentSection=sectionIndex;this._currentRow=rowIndex;this._highlightCurrentRow();this._notifyRowFocused()},rowUnhovered:function(sectionIndex,rowIndex){if(this._rowSelectionLocked){return}this._unhighlightRow(sectionIndex,rowIndex);this._callDelegateFunction("rowUnfocused",this._getRowData(sectionIndex,rowIndex))},rowPressed:function(sectionIndex,rowIndex){if(this._rowSelectionLocked){return}if(this._dataSource.rowsAreNotSelectable&&this._dataSource.rowsAreNotSelectable()){return}this._currentSection=sectionIndex;this._currentRow=rowIndex;this._deselectRow();this._selectRow();this._notifyRowPressed()},rowMetaActionPressed:function(sectionIndex,rowIndex){this._callDelegateFunction("rowMetaActionPressed",this._getRowData(sectionIndex,rowIndex))},cursorDown:function(){var self=this;this._view.blockMouseEvents();this._delayedUnblockMouseEvents();this._selectNextRow();this._notifyRowFocused()},cursorEnter:function(){if(!this.isRowHighlighted()){this._notifyEmptyPressed();return}this._deselectRow();this._selectRow();this._notifyRowPressed()},cursorUp:function(){var self=this;this._view.blockMouseEvents();this._delayedUnblockMouseEvents();this._selectPreviousRow();this._notifyRowFocused()},cursorLeft:function(){this._callDelegateFunction("cursorLeft",this._getRowData())},cursorRight:function(isCursorAtEnd){this._callDelegateFunction("cursorRight",this._getRowData(),isCursorAtEnd)},dataChanged:function(){this._unhighlightCurrentRow();this._resetCursor();this._refresh();if(this._dataSource.numberOfSections()===0){return}this._highlightCurrentRow();this._notifyRowFocused()},_notifyRowFocused:function(){if(this._currentSection===-1||this._currentRow===-1){return}var rowData=this._getRowData();this._callDelegateFunction("rowFocused",rowData);this._eventStream.push({eventName:"rowFocused",rowData:rowData})},_notifyRowPressed:function(){if(this._currentSection===-1||this._currentRow===-1){return}var rowData=this._getRowData();this._callDelegateFunction("rowPressed",rowData);this._eventStream.push({eventName:"rowPressed",rowData:rowData})},_notifyMovedHighlightedRow:function(){if(this._currentSection===-1||this._currentRow===-1){return}var rowData=this._getRowData();this._callDelegateFunction("movedRow",rowData);this._eventStream.push({eventName:"movedRow",rowData:rowData})},_notifyEmptyPressed:function(){this._callDelegateFunction("emptyPressed");this._eventStream.push({eventName:"emptyPressed"})},select:function(){this._unhighlightCurrentRow();this.cursorEnter();this._highlightCurrentRow()},highlightPosition:function(position){this._unhighlightCurrentRow();this._currentSection=position.sectionIndex;this._currentRow=position.rowIndex;this._moveToNextRow();this._moveToPreviousRow();this._highlightCurrentRow()},selectPosition:function(position){this._unhighlightCurrentRow();this._deselectRow();this._currentSection=position.sectionIndex;this._currentRow=position.rowIndex;this._moveToNextRow();this._moveToPreviousRow();this._highlightCurrentRow();this._selectRow()},isRowHighlighted:function(){return this._currentSection>=0&&this._currentRow>=0},reset:function(){this._deselectRow();this._unhighlightCurrentRow()},lockRowSelection:function(){this._rowSelectionLocked=true;this._selectRow()},unlockRowSelection:function(){this._rowSelectionLocked=false;this._deselectRow()},refresh:function(){this._refresh()},_refresh:function(){this._view.hide();this._view.empty();var numSections=this._dataSource.numberOfSections();if(numSections===0){return}for(var ii=0;ii<numSections;ii++){this._renderSection(ii)}if(!this._dataSource.dontHighlightOnDataChange||!this._dataSource.dontHighlightOnDataChange()){if(this._currentSection===-1){this._currentSection=0}if(this._currentRow===-1){this._currentRow=0}}this._view.show()},_renderSection:function(sectionIndex){if(!this._dataSource.sectionShouldShow(sectionIndex)){return}if(this._dataSource.isSectionSeparator&&this._dataSource.isSectionSeparator(sectionIndex)){this._view.renderSeparator();return}if(this._dataSource.isSectionFreeForm&&this._dataSource.isSectionFreeForm(sectionIndex)){this._view.addFreeFormSectionElement(this._dataSource.getSectionFreeFormElement(sectionIndex));return}var sectionTitle,sectionTitleClass,sectionIconClass,doesSectionToggle,extraTitleText,sectionAfterTitleIconClass;if(this._dataSource.sectionTitle){sectionTitle=this._dataSource.sectionTitle(sectionIndex)}if(this._dataSource.sectionTitleClass){sectionTitleClass=this._dataSource.sectionTitleClass(sectionIndex)}if(this._dataSource.sectionIconClass){sectionIconClass=this._dataSource.sectionIconClass(sectionIndex)}if(this._dataSource.sectionAfterTitleIconClass){sectionAfterTitleIconClass=this._dataSource.sectionAfterTitleIconClass(sectionIndex)}if(this._dataSource.doesSectionToggle){doesSectionToggle=this._dataSource.doesSectionToggle(sectionIndex)}if(this._dataSource.sectionTitleExtraText){extraTitleText=this._dataSource.sectionTitleExtraText(sectionIndex)}this._view.addSection(sectionIndex,sectionTitle,sectionTitleClass,sectionIconClass,doesSectionToggle,extraTitleText,sectionAfterTitleIconClass);this._renderSectionRows(sectionIndex)},_renderSectionRows:function(sectionIndex){var rowCount=this._dataSource.numberOfRowsForSection(sectionIndex);for(var ii=0;ii<rowCount;ii++){this._renderRow(sectionIndex,ii)}},_renderRow:function(sectionIndex,rowIndex){var rowData=this._dataSource.infoForRow(sectionIndex,rowIndex);var rowEl=null;if(rowData.viewController){rowData.viewController.setListViewController(this);this._view.addViewRow(rowData.viewController.getView(),sectionIndex,rowIndex)}else{this._view.renderBasicListRow(rowData,sectionIndex,rowIndex)}if(rowData.isHighlighted&&this._currentSection===-1&&this._currentRow===-1){this._currentSection=sectionIndex;this._currentRow=rowIndex}},getScrollPosition:function(){return this._view.getElement().scrollTop()},setScrollPosition:function(scrollAmount){this._view.getElement().scrollTop(scrollAmount)}});Library.set("BentoBox.Widgets.ListView.ListViewViewController",ListViewViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var ListViewView=Streak.Class.subclass({className:"ListViewView",superclass:Streak.UI.View,_memberVariables:[{name:"_dataSource",destroy:false,set:true},{name:"_scrollOnHighlight",destroy:true,set:true,defaultValue:true},{name:"_listItemHoverElement",destroy:true},{name:"_rows",destroy:true,defaultValue:{}},{name:"_sections",destroy:true,defaultValue:{}},{name:"_rowTemplate",destroy:false},{name:"_sectionTemplate",destroy:false},{name:"_mouseEventsBlocked",destroy:true,set:true,defaultValue:false}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._rowTemplate=HTML.get("listViewRow");this._sectionTemplate=HTML.get("listViewSection");this._listItemHoverElement=$('<div class="streak__listView_hoverItem"></div>')},_setupElement:function(){this._element=HTML.getElement("listViewMain")},getEl:function(){return this.getElement()},hide:function(){this._element.fastHide()},show:function(){this._element.fastShow()},empty:function(){this._element.empty();this._rows={};this._sections={}},blockMouseEvents:function(){this._mouseEventsBlocked=true},unblockMouseEvents:function(){this._mouseEventsBlocked=false},addSection:function(sectionIndex,sectionTitle,titleClass,titleIconClass,doesSectionToggle,extraTitleText,sectionAfterTitleIconClass){var sectionEl=$(document.createElement("div"));sectionEl[0].setAttribute("class","streak__listViewSection");sectionEl[0].innerHTML=this._sectionTemplate({title:sectionTitle});var sectionTitleElement=sectionEl.find(".streak__listViewHeader");if(_.isReal(titleIconClass)){var iconEl=sectionTitleElement.find(".streak__bbIcon");iconEl.css("display","");iconEl.addClass(titleIconClass)}sectionTitleElement.add(titleClass);if(!_.isReal(titleClass)&&!_.isReal(sectionTitle)){sectionTitleElement.remove()}if(doesSectionToggle){sectionTitleElement.find(".streak__openCloseExpando")[0].style.display="";this._addSectionHeaderOpenCloseEvents(sectionTitleElement,sectionEl)}else{sectionTitleElement.find(".streak__openCloseExpando")[0].style.display="none"}if(sectionAfterTitleIconClass){sectionTitleElement.find(".streak__titleExtra").before('<span class="streak__bbIcon '+sectionAfterTitleIconClass+'"></span>')}if(extraTitleText){sectionTitleElement.find(".streak__titleExtra").text(extraTitleText);sectionTitleElement.find(".streak__titleExtra").show()}else{sectionTitleElement.find(".streak__titleExtra").hide()}this._element.append(sectionEl);this._sections[sectionIndex]=sectionEl},_addSectionHeaderOpenCloseEvents:function(sectionTitle,sectionEl){var isOn=true;sectionTitle[0].addEventListener("click",function(){isOn=!isOn;if(isOn){sectionTitle.find(".streak__openCloseExpando").removeClass("Wo").addClass("Wq");sectionEl.find(".streak__listViewTable")[0].style.display=""}else{sectionTitle.find(".streak__openCloseExpando").removeClass("Wq").addClass("Wo");sectionEl.find(".streak__listViewTable")[0].style.display="none"}})},addViewRow:function(view,sectionIndex,rowIndex){var rowEl=$(document.createElement("div"));rowEl[0].setAttribute("class","streak__listViewRow");rowEl.append(view.getElement());this._setupRowBindings(rowEl,sectionIndex,rowIndex);this._rows[""+sectionIndex+"_"+rowIndex]=rowEl;this._sections[sectionIndex].find(".streak__listViewTable").append(rowEl)},renderBasicListRow:function(rowInfo,sectionIndex,rowIndex){var rowEl=$(document.createElement("div"));rowEl[0].setAttribute("class","streak__listViewRow  J-N J-LC-Jz");if(rowInfo.text){rowEl[0].innerHTML=this._rowTemplate({text:rowInfo.text})}else if(rowInfo.html){rowEl[0].innerHTML=this._rowTemplate({text:""});rowEl.find("div").html(rowInfo.html)}if(rowInfo.displayClass){rowEl.addClass(rowInfo.displayClass)}if(rowInfo.hasRightArrow){rowEl.find(".streak__menuArrow").show();rowEl.find(".streak__menuArrow").css("visibility","visible")}if(rowInfo.hasLeftArrow){rowEl.find(".streak__menuArrowLeft").show();rowEl.find(".streak__menuArrowLeft").css("visibility","visible")}this._setupRowBindings(rowEl,sectionIndex,rowIndex);this._rows[""+sectionIndex+"_"+rowIndex]=rowEl;this._sections[sectionIndex].find(".streak__listViewTable").append(rowEl);if(rowInfo.isSelected){this.selectRow(sectionIndex,rowIndex)}},_setupRowBindings:function(el,sectionIndex,rowIndex){var self=this;el.mouseenter(function(){if(self._mouseEventsBlocked){return}self._callDelegateFunction("rowHovered",sectionIndex,rowIndex);if(self._doesHaveItemMetaClass(sectionIndex,rowIndex)){self._addHoverItemElement(el,sectionIndex,rowIndex)}});el.mouseleave(function(){if(self._mouseEventsBlocked){return}self._callDelegateFunction("rowUnhovered",sectionIndex,rowIndex);if(self._doesHaveItemMetaClass(sectionIndex,rowIndex)){self._listItemHoverElement.remove()}});el.click(function(e){self._callDelegateFunction("rowPressed",sectionIndex,rowIndex);e.stopPropagation()})},_doesHaveItemMetaClass:function(sectionIndex,rowIndex){return this._dataSource.getItemMetaClass&&this._dataSource.getItemMetaClass(sectionIndex,rowIndex)},_addHoverItemElement:function(listItemElement,sectionIndex,rowIndex){var self=this;this._listItemHoverElement.addClass(this._dataSource.getItemMetaClass(sectionIndex,rowIndex));listItemElement.append(this._listItemHoverElement);this._listItemHoverElement.off(".listView");this._listItemHoverElement.on("click.listView",function(e){self._callDelegateFunction("rowMetaActionPressed",sectionIndex,rowIndex);e.stopPropagation()})},renderSeparator:function(){var separator=document.createElement("div");separator.setAttribute("class","J-Kh");separator.setAttribute("role","separator");this._element.append(separator)},addFreeFormSectionElement:function(element){this._element.append(element)},unhighlightRow:function(sectionIndex,rowIndex){if(_.isNotReal(sectionIndex)||_.isNotReal(rowIndex)){return}this._element.find(".streak__listViewRowHover").removeClass("streak__listViewRowHover");var rowEl=this._rows[""+sectionIndex+"_"+rowIndex];if(_.isReal(rowEl)){rowEl.removeClass("streak__listViewRowHover")}},highlightRow:function(sectionIndex,rowIndex){if(_.isNotReal(sectionIndex)||_.isNotReal(rowIndex)){return}var rowEl=this._rows[""+sectionIndex+"_"+rowIndex];if(_.isReal(rowEl)){rowEl.addClass("streak__listViewRowHover");if(!this._dataSource.dontScrollOnHighlight||!this._dataSource.dontScrollOnHighlight()){rowEl.scrollintoview({duration:0})}}},selectRow:function(sectionIndex,rowIndex){if(_.isNotReal(sectionIndex)||_.isNotReal(rowIndex)){return}var rowEl=this._rows[""+sectionIndex+"_"+rowIndex];if(_.isReal(rowEl)){rowEl.addClass("streak__listViewRowSelected")}},deselectRow:function(sectionIndex,rowIndex){if(_.isNotReal(sectionIndex)||_.isNotReal(rowIndex)){return}var rowEl=this._rows[""+sectionIndex+"_"+rowIndex];if(_.isReal(rowEl)){rowEl.removeClass("streak__listViewRowSelected")}}});Streak.Library.set("BentoBox.Widgets.ListView.ListViewView",ListViewView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superClass=Streak.UI.Delegator;var ListViewBaseModel=Streak.Class.subclass({superclass:superClass,_memberVariables:[{name:"_sections",destroy:true}],_initialize:function(){superClass.prototype._initialize.call(this);this._sections=[];return this},removeAllSections:function(){this._sections.length=0;this._callDelegateFunction("dataChanged")},addSection:function(section){this._sections.push(section);this._callDelegateFunction("dataChanged");return this._sections.length-1},numberOfSections:function(){return this._sections.length},numberOfRowsForSection:function(sectionIndex){var section=this._sections[sectionIndex];if(!section){return-1}var rows=section.rows;if(rows){return rows.length}return 0},sectionShouldShow:function(sectionIndex){return true},isSectionSeparator:function(sectionIndex){return false},isSectionFreeForm:function(sectionIndex){return false},getSectionFreeFormElement:function(sectionIndex){return null},infoForRow:function(sectionIndex,row){if(this._sections.length===0){return}return this._sections[sectionIndex].rows[row]},sectionTitle:function(sectionIndex){return this._sections[sectionIndex].name},sectionTitleClass:function(sectionIndex){},sectionIconClass:function(sectionIndex){},doesSectionToggle:function(sectionIndex){return this._sections[sectionIndex].doesSectionToggle},sectionTitleExtraText:function(sectionIndex){return this._sections[sectionIndex].extraHeaderText}});Streak.Library.set("BentoBox.Widgets.ListView.ListViewBaseModel",ListViewBaseModel)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var SmartButtonMenu={templates:{},defaults:{list:null,model:null,property:null,fieldIndex:-1,autoSave:true,buttonColor:"normal",autoClose:false},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o)},_init:function(cb){if(!this.templates.button){this.templates.button=HTML.get("smartButtonMenuButton")}}};SmartButtonMenu.impl=function(o){var options=o;var bodyClosed=false;options.trackingContext.widgetContext+="/smartButtonMenu";var button=BB.Widgets.Button.create({trackingContext:options.trackingContext,color:options.buttonColor,isToggle:true,onFunc:function(e){sdm.focus()},offFunc:function(e){sdm.hide();button.el.focus()},isDropdown:true});options.span=button.el;options.extraHTML=button.innerEl[0].innerHTML;var sdm=BB.Widgets.SmartDropdown.create(options);sdm.el.bind({menuClosed:function(){button.off()},itemSelected:function(){button.off()},innerTabPressed:function(){button.off();button.el.trigger("tabPressed")},innerShiftTabPressed:function(){button.off();button.el.trigger("shiftTabPressed")}});if(options.autoClose){button.el.bodyCloseAndStop({closeFunction:function(){button.off();button.el.blur()},body:Gmail.elements.body,stop:sdm.el[0]})}sdm.getElement=function(){return sdm.el};sdm.setEnabled=function(enabled){if(enabled){sdm.el.removeClass("disabled");button.enable()}else{sdm.el.addClass("disabled");button.disable()}};var _destroy=sdm.destroy;sdm.destroy=function(){if(_.isFunction(_destroy)){_destroy()}button.el.unbindBodyCloseAndStop();button.destroy()};return sdm};BB.Widgets.SmartButtonMenu=SmartButtonMenu})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox;var StageButton={defaults:{pipeline:null,box:null},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};StageButton.impl=function(o){var observer={};var options=o;options.trackingContext.widgetContext+="/stageButton";var sbm=BB.Widgets.SmartButtonMenu.create({list:options.pipeline.getStagesAsListText(),model:options.box,property:"stageKey",overrideTab:true,autoClose:true,trackingContext:options.trackingContext});if(options.box){sbm.setEnabled(options.box.getIsEditable())}var updateMenu=function(){sbm.renderMenu(options.pipeline.getStagesAsListText())};options.pipeline.watch("stageChange",updateMenu,observer);var _destroy=sbm.destroy;sbm.destroy=function(){if(_destroy){_destroy()}Streak.NotificationCenter.unsubscribe({observer:observer})};return sbm};BB.Widgets.StageButton=StageButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var NewSpreadsheet=Streak.Class.subclass({className:"NewSpreadsheet",superclass:Streak.UI.View,_memberVariables:[{name:"_inputMap",destroy:false,defaultValue:{}},{name:"_createdInputs",destroy:true,defaultValue:[]},{name:"_currentInput",destroy:false},{name:"_tableModel",destroy:false},{name:"_cursorModel",destroy:false},{name:"_cursorDiv",destroy:true},{name:"_renderSettings",destroy:false},{name:"_groupRows",destroy:false},{name:"_currentStickyGroupRow",destroy:false,defaultValue:0},{name:"_boundCopyCellFunction",destroy:false}],render:function(){this._removeGlobalEventListeners();this._resetElement();this._resetRenderSettings();this._renderHead();this._generateWidthMap();this._renderGroupRows();this._generateGroupRowStats();this._setupClickBlurHandler();this._forceRedraw();this._setupOnscrollHandler();this.focus();NewSpreadsheet.globals.activeSpreadsheet=this},redraw:function(){this._redraw()},resize:function(){this._forceRedraw()},focus:function(){this._cursorDiv.fastShow();this._redrawCursor();this._element.focus()},unfocus:function(){this._cursorDiv.fastHide();this._closeMenus();this._element.blur()},blur:function(){this._delegate.unfocusCursor();if(this._cursorDiv.isVisible()){this._cursorDiv.fastHide()}this._closeMenus();this._element.blur()},_initialize:function(tableModel,cursorModel){Streak.Object.prototype._initialize.call(this);this._tableModel=tableModel;this._cursorModel=cursorModel;this._setupElement();this._setupCursor();this._setupGeneralDOMEventBindings();this._setupKeyboardEventBindings();this._setupCopyAndPasteEventBindings();this._initializeColumnMenu();this._initializeRenderSettings()},_setupElement:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","spreadsheet scrollable");this._element[0].setAttribute("tabindex","-1")},_setupCursor:function(){var self=this;this._cursorDiv=$(document.createElement("div"));this._cursorDiv[0].setAttribute("class","cursor");this._cursorDiv[0].oncontextmenu=function(){if(self._renderSettings.currentCoord[0]===0){if(self._renderSettings.currentCoord[1]>1){self._renderSettings.currentCell.customTrigger("showMenu");return false}}};this._cursorDiv.click(function(){self._tableModel.cursorSelect()})},_setupGeneralDOMEventBindings:function(){this._setupCellDelegateEvents();this._setupElementCustomEventBindings();this._setupGroupSummaryMenuEvents();this._setupEventPropagationStops()},_setupCellDelegateEvents:function(){var eventMap={};var self=this;eventMap["mousedown.bbCursor"]=function(e){e.stopPropagation();if($(e.originalEvent.srcElement).parents(".bb_menu").length>0){return}var td=e.currentTarget;var coord=self._extractCellPosition(td);self._closeMenus();var didStateChange=self._delegate.cursorSelect(coord,e.shiftKey);if(!didStateChange){return}e.preventDefault();if(self._currentInput){return}if(self._delegate.isMenuOpen()){return}self._element.focus()};eventMap["enterPressed.bbEvent"]=function(e){if(self._tableModel.canGoDownOnEnter(self._delegate.getCursorPosition())){self._delegate.updateCursorPosition("down",0)}else{self._delegate.unfocusCursor();self._delegate.focus()}self._element.focus()};eventMap["escapePressed.bbEvent"]=function(e){self._delegate.unfocusCursor();self._delegate.focus()};eventMap["tabPressed.bbEvent"]=function(e){self._delegate.updateCursorPosition("down",1);self._element.focus()};eventMap["shiftTabPressed.bbEvent"]=function(e){self._delegate.updateCursorPosition("up",1);self._element.focus()};eventMap["keypress.bbEvent"]=function(e){if(e.which===13){e.stopPropagation();e.preventDefault()}};this._element.on(eventMap,".cell, .headCell")},_setupElementCustomEventBindings:function(){var element=this._element;var self=this;element.bind({upPressed:function(e){self._delegate.updateCursorPosition("up",0);element.focus()},rightPressed:function(e){self._delegate.updateCursorPosition("down",1);element.focus()},downPressed:function(e){self._delegate.updateCursorPosition("down",0);element.focus()},leftPressed:function(e){self._delegate.updateCursorPosition("up",1);element.focus()},mouseup:function(e){var srcElement=e.originalEvent.srcElement;if(srcElement===self._renderSettings.tbody[0]||srcElement===self._renderSettings.overflowBody[0]||srcElement===self._element[0]){self.blur()}}})},_setupGroupSummaryMenuEvents:function(){var self=this;this._element.on("mousedown",".streak__group_summary_link",function(e){if($(e.originalEvent.srcElement).parents(".bb_menu").length>0){return}e.stopPropagation();var span=$(e.currentTarget);var cell=span.closest(".cell");var coord=self._extractCellPosition(cell[0]);if(cell.find(".bb_menu").length>0){self._closeMenus();return}if(!self._tableModel.getPipeline().getIsEditable()){return}self._closeMenus();self._delegate.unfocusCursor();span=cell.find(".streak__group_summary_link");span.append(NewSpreadsheet.globals.groupSummaryMenu.getElement());NewSpreadsheet.globals.groupSummaryMenu.setup(self._tableModel.getColumnData(coord[1]),cell)})},_setupEventPropagationStops:function(){this._element.bind("keydown",function(e){e.stopPropagation()});this._addKeyboardBindingToElement("escape/delete/del/backspace",function(e){})},_setupKeyboardEventBindings:function(){var element=this._element;var self=this;BB.Keyboard.bindChordToElement(element,"tab",function(e){self._delegate.updateCursorPosition("down",1);element.focus()},true,true);BB.Keyboard.bindChordToElement(element,"shift+tab",function(e){self._delegate.updateCursorPosition("up",1);element.focus()},true,true);this._addKeyboardBindingToElement("down",function(e){self._delegate.updateCursorPosition("down",0)});this._addKeyboardBindingToElement("up",function(e){self._delegate.updateCursorPosition("up",0)});this._addKeyboardBindingToElement("right",function(e){self._delegate.updateCursorPosition("down",1)});this._addKeyboardBindingToElement("left",function(e){self._delegate.updateCursorPosition("up",1)});this._addKeyboardBindingToElement("home",function(e){self._delegate.updateCursorToBeginning(1)});this._addKeyboardBindingToElement("end",function(e){self._delegate.updateCursorToEnd(1)});this._addKeyboardBindingToElement("ctrl+down/meta+down",function(){self._delegate.updateCursorToEnd(0)});this._addKeyboardBindingToElement("ctrl+up/meta+up",function(){self._delegate.updateCursorToBeginning(0)});this._addKeyboardBindingToElement("ctrl+right/meta+right",function(e){self._delegate.updateCursorToEnd(1)});this._addKeyboardBindingToElement("ctrl+left/meta+left",function(e){self._delegate.updateCursorToBeginning(1)});this._addKeyboardBindingToElement("ctrl+home/meta+home",function(e){self._delegate.updateCursorToBeginning(0);self._delegate.updateCursorToBeginning(1)});this._addKeyboardBindingToElement("ctrl+end/meta+end",function(e){self._delegate.updateCursorToEnd(0);self._delegate.updateCursorToEnd(1)});this._addKeyboardBindingToElement("space/=/enter",function(e){self._delegate.cursorSelect(null,e.shiftKey)});this._addKeyboardBindingToElement("[a-z]/[0-9]/shift+[a-z]/shift+[0-9]",this._setCharacterInCurrentCell.bind(this));BB.Keyboard.bindChordToElement(element,"ctrl+b/meta+b",function(e){self._delegate.startNewBox()},true,true,false,null,true);BB.Keyboard.bindChordToElement(element,"ctrl+d/meta+d",function(e){self._delegate.startDeleteBox()},true,true,false,null,true)},_addKeyboardBindingToElement:function(chord,callback){BB.Keyboard.bindChordToElement(this._element,chord,callback,true,true,true)},_setCharacterInCurrentCell:function(e){this._delegate.cursorSelect();if(!this._currentInput){return}var s=String.fromCharCode(e.which);if(e.shiftKey){if(NewSpreadsheet.globals.numberMap[s]){s=NewSpreadsheet.globals.numberMap[s]}else{s=s.toUpperCase()}}else{s=s.toUpperCase();s=s.toLowerCase()}this._currentInput.set(s)},_setupCopyAndPasteEventBindings:function(){this._boundCopyCellFunction=this._copyCell.bind(this);window.addEventListener("copy",this._boundCopyCellFunction);this._element[0].addEventListener("paste",this._handlePaste.bind(this))},_copyCell:function(event){if(this._currentInput){return}if(!this._cursorDiv.isVisible()){return}var cell=$(event.srcElement);if(cell.parents(this._element).length===0){return}var clipboardData=event.clipboardData?event.clipboardData:window.clipboardData;if(!clipboardData||!clipboardData.setData){return}clipboardData.setData("text",this._tableModel.getTextValue(this._tableModel.getCursorPosition()));event.preventDefault()},_handlePaste:function(e){if($(e.target).is("input, [contenteditable=true]")){return}if(this._currentInput){return}var data=e.clipboardData.getData("text/plain");if(!_.isReal(data)){return}this._delegate.cursorSelect();if(this._currentInput){this._currentInput.set("")}},_initializeColumnMenu:function(){NewSpreadsheet.globals.columnMenu.setItemChosenCallback(this._closeMenus.bind(this));NewSpreadsheet.globals.groupSummaryMenu.setItemChosenCallback(this._closeMenus.bind(this))},_initializeRenderSettings:function(){this._renderSettings={contentRows:[],orderedContentRows:[],groupRows:[],groupRowNameWidth:0,totalWidth:0,widthMap:[],columnStartingPosition:[],visibleColumnRange:{start:0,end:-1},previousVisibleColumnRange:null,visibleColumns:0,currentCell:null,currentCoord:null,cursorAtTop:false,highlightCell:null,headCollapse:null,headCheckbox:null,headCheckboxInput:null,currentInputBoundingBox:{top:null,left:null,right:null,bottom:null}}},widthChange:function(columnIndex){this._generateWidthMap();for(var i=0;i<this._renderSettings.contentRows.length;i++){var contentRow=this._renderSettings.contentRows[i];var children=contentRow.DOMRow.children();var childrenLength=children.length;for(var jj=0;jj<childrenLength;jj++){children[jj].style.width=this._renderSettings.widthMap[jj]+"px";children[jj].style.left=this._renderSettings.columnStartingPosition[jj-2]+"px"}}for(var ii=0;ii<this._groupRows.length;ii++){var groupRow=this._groupRows[ii];var children=groupRow.DOMRow.children();var childrenLength=children.length;for(var jj=0;jj<childrenLength;jj++){children[jj].style.width=this._renderSettings.widthMap[jj]+"px";children[jj].style.left=this._renderSettings.columnStartingPosition[jj-2]+"px"}}this._renderSettings.tbody[0].style.width=NewSpreadsheet.globals.widthConstants.table+this._renderSettings.groupRowNameWidth+1+"px";this._redrawCursor()},redrawTable:function(){this._forceRedraw()},redrawContentRows:function(){this.redrawHeaderRow();this._redraw(true)},redrawHeaderRow:function(){this.redrawRow(0)},redrawGroupRows:function(){this._redrawGroupRows()},redrawRow:function(rowIndex){if(rowIndex===0){for(var ii=0;ii<this._tableModel.getNumberOfVisibleColumnsForRow([0,0]);ii++){this._updateHeadCell([0,ii])}return}if(this._tableModel.isGroup([rowIndex,0])){var groupIndex=this._tableModel.getGroupIndex(rowIndex);this._redrawGroupRow(this._groupRows[groupIndex],rowIndex);return}var hash=this._tableModel.getRowHash(rowIndex);var rows=this._getRowsForHash(hash);for(var i=0;i<rows.length;i++){this._renderContentRow(rows[i],rows[i].rowIndex,true)}},redrawCell:function(coord){if(coord[0]===0){this._updateHeadCell(coord)}else{if(this._isCellChangeInGroupRow(coord)){this._cellChangeInGroupRow(coord);return}var hash=this._tableModel.getRowHash(coord[0]);var rows=this._getRowsForHash(hash);for(var i=0;i<rows.length;i++){var row=rows[i];if(row.DOMRow[0].style.display==="none"){continue}var cellDiv=row.DOMRow.children()[coord[1]];if(this._tableModel.getActionType(coord)==="CHECKBOX"){if(coord[1]>1){this._renderContentCheckboxCell(cellDiv,[row.rowIndex,coord[1]])}else{this._renderCheckboxCell(cellDiv,cellDiv.querySelectorAll("div")[0],[row.rowIndex,coord[1]])}}else{var cellInput=this._renderCell(cellDiv,[row.rowIndex,coord[1]]);if(cellInput){cellInput.focus()}}}}},_isCellChangeInGroupRow:function(coord){if(!this._renderSettings){return
}return this._renderSettings.groupRowIndexes.indexOf(coord[0])>-1},_cellChangeInGroupRow:function(coord){var groupIndex=this._renderSettings.groupRowIndexes.indexOf(coord[0]);var groupRow=this._groupRows[groupIndex];var groupRowIndex=this._renderSettings.groupRowIndexes[groupIndex];if(coord[1]===0){this._renderCell(groupRow.firstChild,[groupRowIndex,0]," cellExpando",true);return}if(coord[1]===1){this._renderCheckboxCell(groupRow.checkboxHolder,groupRow.checkboxInput,[groupRowIndex,1]);return}var cellInput=this._renderCell(groupRow.cells[coord[1]-2],coord,"groupCell"+(coord[1]===2?" streak__nameGroupCell":""),true);if(cellInput){cellInput.focus()}},_handleCursorChange:function(coord,noXScroll,isVisible,toTop,noScroll){this._saveCellChanges();if(isVisible){this._cursorDiv.fastShow("block");this._renderCursor(coord,noXScroll,toTop,noScroll)}else{this._cursorDiv.fastHide()}},setScrollPosition:function(position){this._renderSettings.overflowBody[0].scrollTop=position.scrollTop;this._renderSettings.overflowBody[0].scrollLeft=position.scrollLeft},hideCursor:function(){this._saveCellChanges();this._cursorDiv.fastHide()},showCursor:function(coord,options){this._saveCellChanges();this._cursorDiv.fastShow("block");this._renderCursor(coord,options.noHorizontalScroll)},_renderCursor:function(coord,noXScroll,toTop,noScroll){var left=-2;var scrollRectangle={};if(coord[0]===0){this._cursorDiv[0].style.top=Math.max(NewSpreadsheet.globals.contentRowHeight*(coord[0]-1)-2,-1)+"px";this._cursorDiv[0].style.zIndex=3;scrollRectangle.top=0;this._renderSettings.cursorAtTop=true;this._cursorDiv[0].style.pointerEvents="none"}else{this._renderSettings.cursorAtTop=false;var topPosition=this._getRowTopPosition(coord[0]);topPosition+=NewSpreadsheet.globals.contentRowHeight;topPosition-=this._renderSettings.top;this._cursorDiv[0].style.top=topPosition+"px";if(this._renderSettings.top>0){this._cursorDiv[0].style.zIndex=1}scrollRectangle.top=this._getRowTopPosition(coord[0]-2);this._cursorDiv[0].style.pointerEvents=""}var isGroup=this._tableModel.isGroup(coord);if(isGroup){this._cursorDiv[0].style.height=this._getGroupRowHeight()-2+"px"}else{this._cursorDiv[0].style.height=NewSpreadsheet.globals.contentRowHeight-2+"px"}if(coord[1]===0){this._cursorDiv[0].style.width=NewSpreadsheet.globals.widthConstants.col1+"px"}else if(coord[1]===1){left+=NewSpreadsheet.globals.widthConstants.col1;this._cursorDiv[0].style.width=NewSpreadsheet.globals.widthConstants.col2+"px"}else{left+=NewSpreadsheet.globals.widthConstants.col1+NewSpreadsheet.globals.widthConstants.col2;if(isGroup){this._cursorDiv[0].style.width=this._renderSettings.groupRowNameWidth+"px"}else{for(var i=2;i<coord[1];i++){left+=this._renderSettings.widthMap[i]+NewSpreadsheet.globals.columnPadding}this._cursorDiv[0].style.width=this._renderSettings.widthMap[coord[1]]+NewSpreadsheet.globals.columnPadding+"px"}}this._cursorDiv[0].style.left=left-this._renderSettings.left+"px";if(!noScroll){scrollRectangle.bottom=scrollRectangle.top+NewSpreadsheet.globals.contentRowHeight+100;scrollRectangle.left=parseInt(this._cursorDiv[0].style.left,10)-80;scrollRectangle.right=scrollRectangle.left+parseInt(this._cursorDiv[0].style.width,10)+95;this._renderSettings.tbody.scrollintoview({duration:0,direction:noXScroll?"y":"both",toTop:toTop,rectangle:scrollRectangle,scroller:this._renderSettings.overflowtBody})}this._renderSettings.currentCoord=coord},_resetElement:function(){this._element.find(".thead").detach();this._element[0].innerHTML='<div class="thead bb_tr"></div><div class="spreadsheetContainer"><div class="overflowtBody"><div class="tbody"></div></div></div>';this._element.append(this._cursorDiv)},_resetRenderSettings:function(){this._renderSettings.contentRows=[];this._renderSettings.spreadsheetContainer=this._element.find(".spreadsheetContainer");this._renderSettings.overflowBody=this._element.find(".overflowtBody");this._renderSettings.tbody=this._element.find(".tbody");this._renderSettings.thead=this._element.find(".thead");this._renderSettings.left=0;this._renderSettings.top=0;this._renderSettings.highlightCell=null;this._renderSettings.currentCoord=[0,0];this._renderSettings.currentColumnCutoff=-1},_renderHead:function(){var i,index=0;var hidden=false;var head=this._element.find("div.thead");head[0].innerHTML='<div class="bb_th first-child cell cellExpando" tabindex="-1"></div><div class="bb_th firstHidden second-child cell" tabindex="-1" role="checkbox"><div class="oZ-jc T-Jo J-J5-Ji"><div class="T-Jo-auh"></div></div></div>';var prevVisible=this._element.find(".thead .firstHidden");var divs=head.children();this._renderSettings.headCollapse=divs[0];this._renderSettings.headCheckbox=divs[1];this._renderSettings.headCheckboxInput=$(divs[1]).find("[role=checkbox] div")[0];for(i=2,index=0;i<this._tableModel.getTotalColumnCount()+2;i++){if(this._tableModel.isColumnNotPresent(i)){continue}if(this._tableModel.isColumnVisible(i)){var th=this._renderHeadCell(index,i);head[0].appendChild(th[0]);prevVisible=th;hidden=false;index++}else{if(!hidden){this._renderHeadHiddenCell(prevVisible,i)}}}this._renderSettings.visibleColumns=index;head.append("<br />");var self=this;if(self._tableModel.getPipeline().getIsEditable()){head.find(".headCell").columnReorder({body:this._renderSettings.tbody,doneReorder:function(oldIndex,newIndex,isAfter){self._tableModel.columnReorder(oldIndex,newIndex,isAfter);BB.Tracker.trackStreakActive(NewSpreadsheet.globals.trackingContext,{eventName:"ColumnOrderChanged"})}})}this._redrawHead()},_renderHeadCell:function(visibleIndex,columnIndex){var self=this;var cIndex=visibleIndex+2;var th=$(document.createElement("div"));var inner=$(document.createElement("div"));inner.addClass("name");th[0].setAttribute("class","bb_th headCell");th[0].setAttribute("tabindex","-1");th[0].setAttribute("cellPosition","0,"+cIndex);if(this._tableModel.isColumnRenameable(columnIndex)){th.addClass("th_editable")}var columnWidth=this._tableModel.getColumnWidth(columnIndex);th.css({minWidth:columnWidth,width:columnWidth,maxWidth:columnWidth});if(self._tableModel.getPipeline().getIsEditable()){th.colResizable({onResize:function(width){self._tableModel.setColumnWidth(columnIndex,width)},doneResize:function(){self._tableModel.saveColumnWidth(columnIndex)}})}inner.append(self._tableModel.getHTMLValue([0,cIndex]));inner[0].setAttribute("data-tooltip",self._tableModel.getTextValue([0,cIndex]));var settingsDiv=$('<div class="settings"><div class="afM"></div></div>');var menuButton=settingsDiv.find(".afM");menuButton.easyHoverClass("afN");function renderMenu(force){if(settingsDiv.find(".bb_menu").length>0){if(settingsDiv.find(".bb_menu").is(":FastVisible")){self._closeMenus()}}else{self._closeMenus();settingsDiv.append(NewSpreadsheet.globals.columnMenu.menu.el);NewSpreadsheet.globals.columnMenu.setColumnData(self._tableModel.getColumnData(cIndex),self._tableModel.getPipeline(),th)}}menuButton.on("mousedown",function(e){self._delegate.unfocusCursor();renderMenu();BB.Tracker.trackStreakActive(NewSpreadsheet.globals.trackingContext,{eventName:"ColumnMenuArrowClick"});e.stopPropagation();e.preventDefault();self._delegate.setIsMenuOpen(true)});th.customBind("showMenu",function(){renderMenu(true)});th[0].oncontextmenu=function(){BB.Tracker.trackStreakActive(NewSpreadsheet.globals.trackingContext,{eventName:"ColumnRightClick"});renderMenu(true);return false};th.append(inner);if(self._tableModel.getPipeline().getIsEditable()){th.append(settingsDiv)}return th},_renderHeadHiddenCell:function(th,columnIndex){var hidden=$(document.createElement("div"));hidden[0].innerHTML='<div class="streak__hiddenContainer"></div><div class="streak__hiddenContainerTwo"><div class="left"></div><div class="right"></div></div>';hidden.addClass("hiddenCell");th.append(hidden);var self=this;hidden.mousedown(function(e){self._tableModel.action([0,columnIndex]);e.stopPropagation()})},_generateWidthMap:function(){this._renderSettings.widthMap=[];this._renderSettings.groupRowNameWidth=0;this._renderSettings.columnStartingPosition.length=0;var currentWidth=NewSpreadsheet.globals.widthConstants.col1+NewSpreadsheet.globals.widthConstants.col2;for(var i=2,index=0;i<this._tableModel.getTotalColumnCount()+2;i++){if(this._tableModel.isColumnNotPresent(i)){continue}if(this._tableModel.isColumnVisible(i)){this._renderSettings.columnStartingPosition.push(currentWidth);var cIndex=index+2;var columnWidth=this._tableModel.getColumnWidth(i);this._renderSettings.widthMap[cIndex]=columnWidth;this._renderSettings.groupRowNameWidth+=this._renderSettings.widthMap[cIndex]+NewSpreadsheet.globals.columnPadding;index+=1;currentWidth+=columnWidth+NewSpreadsheet.globals.columnPadding}}this._renderSettings.visibleColumnRange.start=0;this._renderSettings.visibleColumnRange.end=this._renderSettings.widthMap.length;this._renderSettings.totalWidth=_.reduce(this._renderSettings.widthMap,function(item,val){return item+val+NewSpreadsheet.globals.columnPadding},NewSpreadsheet.globals.widthConstants.col1+NewSpreadsheet.globals.widthConstants.col2)},_renderGroupRows:function(){var numberOfGroupRows=this._tableModel.getNumberOfGroupRows();this._groupRows=[];for(var ii=0;ii<numberOfGroupRows;ii++){var groupDOMRow=this._renderGroupRow(ii);var groupRow={DOMRow:groupDOMRow,cells:groupDOMRow.findReturnRaw(".groupCell"),firstChild:groupDOMRow.findReturnRaw(".first-child")[0],checkboxHolder:groupDOMRow.findReturnRaw("[role=checkbox]")[0],checkboxInput:groupDOMRow.findReturnRaw("[role=checkbox] div")[0]};this._groupRows.push(groupRow);this._renderSettings.tbody.append(groupRow.DOMRow)}},_renderGroupRow:function(groupIndex){var groupDOMRow=document.createElement("div");groupDOMRow.setAttribute("class","bb_row bb_tr group bb_hbox");var groupHTML=NewSpreadsheet.globals.templates.groupRow;for(var i=2;i<this._renderSettings.visibleColumns+2;i++){groupHTML+=['<div class="cell groupCell" tabindex="-1" style="width:'+this._renderSettings.widthMap[i]+"px; left:"+this._renderSettings.columnStartingPosition[i-2]+'px;">',"</div>"].join("")}groupDOMRow.innerHTML=groupHTML;groupDOMRow=$(groupDOMRow);groupDOMRow[0].style.display="block";var color=this._tableModel.getGroupRowColor(groupIndex);groupDOMRow[0].style.backgroundColor=color.backgroundColor;groupDOMRow[0].style.color=color.textColor;return groupDOMRow},_generateGroupRowStats:function(){this._renderSettings.groupRowIndexes=this._tableModel.getGroupRowIndexes()},_setupOnscrollHandler:function(){var self=this;var requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame;self._renderSettings.overflowBody[0].onscroll=function(scrollEvent){requestAnimationFrame(function(){self._renderSettings.left=self._renderSettings.overflowBody[0].scrollLeft;self._renderSettings.top=self._renderSettings.overflowBody[0].scrollTop;self._renderSettings.bottom=self._renderSettings.top+self._renderSettings.offsetHeight;self._repositionGroupRows();self._redraw();self._delegate.registerScrollPosition({scrollTop:self._renderSettings.top,scrollLeft:self._renderSettings.left})});scrollEvent.stopPropagation();scrollEvent.stopImmediatePropagation()}},_removeOnscrollHandler:function(){if(this._renderSettings.overflowBody&&this._renderSettings.overflowBody.length>0){this._renderSettings.overflowBody[0].onscroll=null}},_setupClickBlurHandler:function(){var self=this;this._renderSettings.overflowBody.bodyCloseAndStop({body:Gmail.elements.body,stop:null,useCapture:true,closeFunction:function(e){if(!self._element.isVisible()){return}var target=$(e.target);if(target.is(".bb_menu, .streak__spreadsheetStopper, .streak__helpModal")){return}var parents=target.parents();if(parents.filter(".bb_menu, .streak__spreadsheetStopper, .streak__helpModal").length>0){return}if(parents.filter(self._element).length===0){self.blur()}}})},_forceRedraw:function(){this._setupViewport();this._redrawHead();this._redrawGroupRows();this._redraw(true)},_setupViewport:function(){if(!this._renderSettings||!this._renderSettings.tbody){return}this._renderSettings.overflowBodyWidth=this._renderSettings.overflowBody.width();this._renderSettings.offsetHeight=this._element[0].offsetHeight;this._renderSettings.tbody[0].style.width=NewSpreadsheet.globals.widthConstants.table+this._renderSettings.groupRowNameWidth-NewSpreadsheet.globals.columnPadding+"px";this._renderSettings.tbody[0].style.height=(this._tableModel.getLastRowNumber()-this._tableModel.getNumberOfGroupRows())*NewSpreadsheet.globals.contentRowHeight+this._tableModel.getNumberOfGroupRows()*NewSpreadsheet.globals.groupRowHeight+NewSpreadsheet.globals.paddingBottom+"px";this._element[0].style.height=this._element.parent()[0].offsetHeight+"px";this._element[0].style.width=this._element.parent()[0].offsetWidth+"px"},_throttledSetupViewport:_.throttle(function(){this._setupViewport()},1e3),_redraw:function(forceRefresh){if(!this._renderSettings||!this._renderSettings.tbody){return}this._throttledSetupViewport();var cellh=NewSpreadsheet.globals.contentRowHeight;var oheight=this._renderSettings.offsetHeight;var top=this._renderSettings.top;var left=this._renderSettings.left;var currentWidth=this._renderSettings.overflowBodyWidth;var topRow=Math.floor((top+this._currentStickyGroupRow*(NewSpreadsheet.globals.contentRowHeight-this._getGroupRowHeight()))/cellh);var len=this._tableModel.getLastRowNumber();var slosh=NewSpreadsheet.globals.viewportBuffer;var desiredRows=Math.floor(oheight/cellh)+slosh;this._ensure(desiredRows);var start=Math.max(topRow-Math.ceil(slosh/2),0);var end=Math.min(len,start+desiredRows);start=Math.max(0,end-desiredRows);var rows=this._renderSettings.contentRows;this._renderSettings.orderedContentRows.length=0;var widthStart=left-20;var widthEnd=left+currentWidth+20;this._renderSettings.previousVisibleColumnRange=_.clone(this._renderSettings.visibleColumnRange);this._renderSettings.visibleColumnRange.start=0;for(var ii=0;ii<this._renderSettings.columnStartingPosition.length;ii++){var colPosition=this._renderSettings.columnStartingPosition[ii];if(colPosition<widthStart){this._renderSettings.visibleColumnRange.start=ii}if(widthEnd>colPosition){this._renderSettings.visibleColumnRange.end=ii}}for(var i=start;i<start+rows.length;i++){var row=rows[i%rows.length];if(i<len){this._renderContentRow(row,i+1,forceRefresh);this._renderSettings.orderedContentRows.push(row)}else{row.DOMRow[0].style.display="none"}}this._renderSettings.thead[0].style.left=-1*left+"px";this._redrawCursor();this._redrawHead();if(this._currentInput&&this._renderSettings.currentInputBoundingBox.top>this._renderSettings.top&&this._renderSettings.currentInputBoundingBox.bottom<this._renderSettings.bottom&&this._renderSettings.currentInputBoundingBox.left>this._renderSettings.left&&this._renderSettings.currentInputBoundingBox.right<this._renderSettings.totalWidth){this._currentInput.focus(true)}},_ensure:function(desired){var contentRowHTML=NewSpreadsheet.globals.templates.contentRow;for(var i=2;i<this._renderSettings.visibleColumns+2;i++){contentRowHTML+='<div class="cell contentCell" tabindex="-1" style="width:'+this._renderSettings.widthMap[i]+"px; left:"+this._renderSettings.columnStartingPosition[i-2]+'px;"></div>'}while(this._renderSettings.contentRows.length<desired){var contentDOMRow=document.createElement("div");contentDOMRow.setAttribute("class","contentRow bb_row");contentDOMRow.style.width=this._renderSettings.totalWidth+"px";contentDOMRow.innerHTML=contentRowHTML;contentDOMRow=$(contentDOMRow);contentDOMRow.fastHide();var contentRow={DOMRow:contentDOMRow,cells:contentDOMRow.findReturnRaw(".contentCell"),firstChild:contentDOMRow.findReturnRaw(".first-child")[0],checkboxHolder:contentDOMRow.findReturnRaw("[role=checkbox]")[0],checkboxInput:contentDOMRow.findReturnRaw("[role=checkbox] div")[0]};this._renderSettings.contentRows.unshift(contentRow);this._renderSettings.tbody.prepend(contentRow.DOMRow)}},_redrawHead:function(){this._renderCell(this._renderSettings.headCollapse,[0,0]," bb_th first-child cellExpando");this._renderCheckboxCell(this._renderSettings.headCheckbox,this._renderSettings.headCheckboxInput,[0,1]);this._updateCellClass(this._renderSettings.headCheckbox,[0,1]," bb_th ")},_updateHeadCell:function(coord){if(coord[1]<2){this._redrawHead();return}var state=this._tableModel.getState(coord);var cell=$(this._renderSettings.thead.children()[coord[1]]);if(!cell||cell.length===0){return}switch(state){case"DEFAULT":case"HIGHLIGHT":cell.find(".name").html(this._tableModel.getHTMLValue(coord));cell.children().fastShow("block");if(state==="HIGHLIGHT"){this._renderSettings.currentCell=cell}break;case"EDIT":var cellData=this._tableModel.getData(coord);if(cellData.model){cell.children().fastHide();cellData.parent=cell;this._currentInput=this._getInput(cellData.type);this._currentInput.setup(cellData);cell.append(this._currentInput.getElement());this._currentInput.focus();this._renderSettings.currentCell=cell}break}this._updateHeadCellClass(cell[0],coord,state)},_updateHeadCellClass:function(cell,coord,state){var classString=this._getExtraClassesForCell(coord);if(coord[1]>1){classString+=" bb_th headCell "}if(state==="EDIT"){var cellData=this._tableModel.getData(coord);classString+=" bigEdit selected ";if(cellData.model){classString+=" active "}}cell.setAttribute("class",classString)},_redrawCursor:function(){if(this._cursorDiv[0].style.display!=="none"){this._renderCursor(this._delegate.getCursorPosition(),false,false,true)}},_redrawGroupRows:function(){this._repositionGroupRows();for(var ii=0;ii<this._groupRows.length;ii++){this._redrawGroupRow(this._groupRows[ii],this._renderSettings.groupRowIndexes[ii])}},_repositionGroupRows:function(){var potentialStickyRowIndex;var groupRowInformation=[];for(var ii=0;ii<this._groupRows.length;ii++){var groupRow=this._groupRows[ii];var groupRowIndex=this._renderSettings.groupRowIndexes[ii];var topPosition=this._getRowTopPosition(groupRowIndex);groupRowInformation.push({groupRow:groupRow,groupRowIndex:groupRowIndex,topPosition:topPosition});if(topPosition<this._renderSettings.top){if(potentialStickyRowIndex!=null){this._groupRows[potentialStickyRowIndex].DOMRow[0].style.display="none"}potentialStickyRowIndex=ii}else if(topPosition>this._renderSettings.bottom){this._groupRows[ii].DOMRow[0].style.display="none"}else{this._groupRows[ii].DOMRow[0].style.display="block"}var currentTop=groupRow.DOMRow[0].style.top;if(topPosition+"px"!==currentTop){groupRow.DOMRow[0].style.top=topPosition+"px"}var currentzIndex=groupRow.DOMRow[0].style.zIndex;if(currentzIndex!=="0"||currentzIndex!==""){groupRow.DOMRow[0].style.zIndex=""}}this._currentStickyGroupRow=potentialStickyRowIndex||0;if(_.isNotReal(potentialStickyRowIndex)){return}this._groupRows[potentialStickyRowIndex].DOMRow[0].style.display="block";var stickyTopPosition=this._renderSettings.top;if(potentialStickyRowIndex<this._groupRows.length-1){var nextGroupRowTopPosition=groupRowInformation[potentialStickyRowIndex+1].topPosition;stickyTopPosition=Math.min(this._renderSettings.top,nextGroupRowTopPosition-this._getGroupRowHeight())}var stickGroupRowDOMRow=groupRowInformation[potentialStickyRowIndex].groupRow.DOMRow[0];stickGroupRowDOMRow.style.top=stickyTopPosition+"px";var currentzIndex=stickGroupRowDOMRow.style.zIndex;if(!currentzIndex||currentzIndex==="0"){stickGroupRowDOMRow.style.zIndex=2}},_redrawGroupRow:function(groupRow,groupRowIndex){this._renderCell(groupRow.firstChild,[groupRowIndex,0]," cellExpando",true);this._renderCheckboxCell(groupRow.checkboxHolder,groupRow.checkboxInput,[groupRowIndex,1]);for(var ii=0;ii<groupRow.cells.length;ii++){this._renderCell(groupRow.cells[ii],[groupRowIndex,ii+2]," groupCell"+(ii===0?" streak__nameGroupCell":""),true)}},_renderContentRow:function(row,index,forceRefresh){var ii,colIndex,el=row.DOMRow,hash=this._tableModel.getRowHash(index),cells=row.cells;if(this._renderSettings.groupRowIndexes.indexOf(index)>-1){el[0].style.display="none"}else if(row.hash===hash&&!forceRefresh){el[0].style.display="block";for(ii=0;ii<cells.length;ii++){if(!_.isReal(cells[ii])){continue}if(ii>=this._renderSettings.visibleColumnRange.start&&ii<=this._renderSettings.visibleColumnRange.end){cells[ii].style.display="block";this._updateCellClass(cells[ii],[index,ii+2])}else{cells[ii].style.display="none"}}}else{this._renderCell(row.firstChild,[index,0]);this._renderCheckboxCell(row.checkboxHolder,row.checkboxInput,[index,1]);if(cells.length>0){for(ii=0;ii<cells.length;ii++){if(!_.isReal(cells[ii])){continue}var coord=[index,ii+2];if(this._tableModel.getActionType(coord)==="CHECKBOX"){this._renderContentCheckboxCell(cells[ii],coord)}else{this._renderCell(cells[ii],[index,ii+2])}if(ii>=this._renderSettings.visibleColumnRange.start&&ii<=this._renderSettings.visibleColumnRange.end){cells[ii].style.display="block"}else{cells[ii].style.display="none"}}}el[0].style.display="block";el[0].style.top=this._getRowTopPosition(index)+"px";row.hash=hash;row.rowIndex=index;var children=el.children();$(children[children.length-1]).addClass("last-child");el[0].setAttribute("rowIndex",index)}},_renderCheckboxCell:function(cell,input,coord){cell.setAttribute("cellPosition",coord[0]+","+coord[1]);if(this._tableModel.getActionType(coord)==="CHECKBOX"){input.style.display="inline-block";if(this._tableModel.isChecked(coord)){$(input).addClass("T-Jo-Jp")}else{$(input).removeClass("T-Jo-Jp")}}else{input.style.display="none"}this._updateCellClass(cell,coord)},_renderContentCheckboxCell:function(cell,coord){if(!cell){return}cell.setAttribute("cellPosition",coord[0]+","+coord[1]);var classString="cell contentCell";var html=cell.innerHTML;var newHTML=this._tableModel.getHTMLValue(coord);if(html!==newHTML){cell.innerHTML=newHTML}classString+=" "+this._getExtraClassesForCell(coord);cell.setAttribute("class",classString)},_renderCell:function(cell,coord,extraClassString,isGroup){if(!cell){return}cell.setAttribute("cellPosition",coord[0]+","+coord[1]);var isCurrentlyEdit=cell.getAttribute("class").indexOf("bigEdit")>-1;var cellElement=cell;if(!cellElement){cellElement=cell}this._updateCellClass(cell,coord,extraClassString,isGroup);var newHTML,html;var state=this._tableModel.getState(coord);switch(state){case"DEFAULT":html=cellElement.innerHTML;newHTML=this._tableModel.getHTMLValue(coord);if(html!==newHTML){cellElement.innerHTML=newHTML}break;case"HIGHLIGHT":html=cellElement.innerHTML;newHTML=this._tableModel.getHTMLValue(coord);if(html!==newHTML){cellElement.innerHTML=newHTML}this._renderSettings.currentCell=cell;break;case"EDIT":var jCell=$(cell);if(isCurrentlyEdit){return}var cellData=this._tableModel.getData(coord);cellData.parent=jCell;cellData.cursor=this._cursorModel;this._currentInput=this._getInput(cellData.type);this._currentInput.setup(cellData);if(_.isUndefined(this._currentInput)){jCell.removeClass("active")}else{jCell.empty();jCell.append(this._currentInput.getElement());this._renderSettings.currentCell=cell;this._renderSettings.currentInputBoundingBox.top=NewSpreadsheet.globals.contentRowHeight*(coord[0]-1);this._renderSettings.currentInputBoundingBox.bottom=this._renderSettings.currentInputBoundingBox.top+NewSpreadsheet.globals.contentRowHeight;this._renderSettings.currentInputBoundingBox.left=this._renderSettings.columnStartingPosition[coord[1]-2];this._renderSettings.currentInputBoundingBox.right=this._renderSettings.currentInputBoundingBox.left+this._renderSettings.widthMap[coord[1]];if(isGroup){cell.style.minWidth=this._renderSettings.groupRowNameWidth+"px";this._renderSettings.currentInputBoundingBox.right=this._renderSettings.currentInputBoundingBox.left+this._renderSettings.groupRowNameWidth}this._currentInput.focus()}break}if(state==="EDIT"){return this._currentInput}if(isGroup&&coord[1]===2&&cell.style.minWidth){cell.style.minWidth=""}},_updateCellClass:function(cell,coord,extraClassString,isGroup){if(!cell){return}var classString="cell";if(coord[1]===0){classString+=" first-child"}else if(coord[1]===1){classString+=" second-child checkbox"}else if(isGroup){classString+=" groupCell";if(this._tableModel.doesColumnHaveSummaryType(coord[1])){classString+=" streak__groupSummaryColumnValue"}}else{classString+=" contentCell"}if(extraClassString){classString+=" "+extraClassString}var isCurrentlyEdit=cell.getAttribute("class").indexOf("bigEdit")>-1;var newHTML,html;var state=this._tableModel.getState(coord);switch(state){case"DEFAULT":break;case"HIGHLIGHT":classString+=" selected";break;case"EDIT":if(isCurrentlyEdit){return}classString+=" active bigEdit selected";break}classString+=" "+this._getExtraClassesForCell(coord);var currentClass=cell.getAttribute("class");if(currentClass!==classString){cell.setAttribute("class",classString)}},_getInput:function(type){if(!this._inputMap[type]){var input=this._createInput(type);this._inputMap[type]=input;this._createdInputs.push(input)}return this._inputMap[type]},_createInput:function(type){var inputOptions=NewSpreadsheet.globals.inputOptions;switch(type){case"TEXT":return BB.Widgets.SpreadsheetTextbox.create(inputOptions);break;case"TEXT_INPUT":return BB.Widgets.SpreadsheetTextarea.create(inputOptions);break;case"SIMPLE_DROPDOWN":return BB.Widgets.SpreadsheetSmartDropdown.create(inputOptions);break;case"DATE":return new BB.Widgets.SpreadsheetSmartTextCalendarViewController(inputOptions);break;case"PERSON":return BB.Widgets.SpreadsheetPeoplePicker.create(inputOptions);break;case"ASSIGNED_TO":return BB.Widgets.SpreadsheetAssignedTo.create(inputOptions);break;case"LINKED_BOXES":return new BB.Widgets.SpreadsheetLinkedBoxesViewController(inputOptions);break;case"FORMULA":return new BB.Widgets.SpreadsheetFormulaViewController(inputOptions);break;case"DROPDOWN":return new BB.Widgets.SpreadsheetSmartTextDropdownViewController(inputOptions);break;case"TAG":return new BB.Widgets.SpreadsheetSmartTagsViewController(inputOptions);break}},_getRowTopPosition:function(rowIndex){var numberOfGroupRowsAbove=0;for(var ii=0;ii<this._renderSettings.groupRowIndexes.length;ii++){var groupRowIndex=this._renderSettings.groupRowIndexes[ii];if(groupRowIndex<rowIndex){numberOfGroupRowsAbove++}else{break}}var contentRowsAbove=rowIndex-numberOfGroupRowsAbove-1;return contentRowsAbove*NewSpreadsheet.globals.contentRowHeight+numberOfGroupRowsAbove*this._getGroupRowHeight()},_getRowsForHash:function(hash){var ret=[];for(var i=0;i<this._renderSettings.contentRows.length;i++){if(this._renderSettings.contentRows[i].hash===hash){ret.push(this._renderSettings.contentRows[i])}}return ret},_getExtraClassesForCell:function(coord){var classes=this._cursorModel.getClassesPrettyString(coord);if(_.isDefined(classes)&&classes.length>0){return classes}return""},_extractCellPosition:function(cell){var position=cell.getAttribute("cellPosition");var coord;if(position&&position.length>0){var pos=position.split(",");coord=[parseInt(pos[0],10),parseInt(pos[1],10)]}return coord},_saveCellChanges:function(){if(!this._currentInput){return}var saveInput=this._currentInput;this._currentInput=null;if(saveInput.preDetach){saveInput.preDetach()}saveInput.getElement().detach();saveInput.updateValue();if(saveInput.done){saveInput.done()}},_getGroupRowHeight:function(){return NewSpreadsheet.globals.groupRowHeight},_closeMenus:function(){NewSpreadsheet.globals.columnMenu.close();NewSpreadsheet.globals.columnMenu.menu.el.detach();NewSpreadsheet.globals.groupSummaryMenu.close();this._delegate.setIsMenuOpen(false)},_removeGlobalEventListeners:function(){window.removeEventListener("copy",this._boundCopyCellFunction);if(this._renderSettings&&this._renderSettings.overflowBody){this._renderSettings.overflowBody.unbindBodyCloseAndStop()}},destroy:function(){this._saveCellChanges();this._removeOnscrollHandler();this._removeGlobalEventListeners();if(this._element){this._element.remove()}Streak.Object.prototype.destroy.call(this);NewSpreadsheet.globals.activeSpreadsheet=false}});NewSpreadsheet.globals={};function setupNewSpreadsheetGlobals(){setupTemplates();setupInputOptions();setupMenus();setupKeyboardEvents();setupWindowResizeListening();setupNumberKeypadMapping();setupRenderingConstants()}function setupTemplates(){NewSpreadsheet.globals.templates={};NewSpreadsheet.globals.templates.groupRow=HTML.get("spreadsheetGroup")();NewSpreadsheet.globals.templates.contentRow=HTML.get("spreadsheetRow")()}function setupInputOptions(){NewSpreadsheet.globals.trackingContext={widgetContext:"pipelineView/spreadsheet",eventName:"SpreadsheetCellEdit"};NewSpreadsheet.globals.inputOptions={trackingContext:NewSpreadsheet.globals.trackingContext}}function setupMenus(){NewSpreadsheet.globals.columnMenu=BB.Widgets.ColumnMenu;NewSpreadsheet.globals.groupSummaryMenu=new BB.Widgets.NewSpreadsheet.GroupSummaryMenuViewController}function setupKeyboardEvents(){BB.Keyboard.addChordHelpItem("<Ctrl>+b",BB.Locale.getString("keyboard_create_new_box"));BB.Keyboard.addChordHelpItem("<Ctrl>+d",BB.Locale.getString("keyboard_delete_selected_boxes"))}function setupWindowResizeListening(){$(window).resize(function(){if(NewSpreadsheet.globals.activeSpreadsheet&&NewSpreadsheet.globals.activeSpreadsheet.getElement()&&NewSpreadsheet.globals.activeSpreadsheet.getElement().isVisible()){NewSpreadsheet.globals.activeSpreadsheet.resize()}})}function setupNumberKeypadMapping(){NewSpreadsheet.globals.numberMap={1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")"}}function setupRenderingConstants(){NewSpreadsheet.globals.columnPadding=5;NewSpreadsheet.globals.contentRowHeight=23;NewSpreadsheet.globals.paddingBottom=100;NewSpreadsheet.globals.viewportBuffer=4;NewSpreadsheet.globals.widthConstants={col1:36,col2:41,table:82};NewSpreadsheet.globals.groupRowHeight=35}Streak.DependencyManager.addFunction({functionKey:"newSpreadsheetInitialized",functionReference:setupNewSpreadsheetGlobals,dependentFunctionKeys:["columnMenuInitialized","keyboardInitialized","htmlLoaded","localeLoaded"]});Library.set("BentoBox.Widgets.NewSpreadsheet",NewSpreadsheet)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,BB=Streak.BentoBox,Gmail=Streak.Gmail,Locale=BB.Locale;var self,ColumnMenu;self=ColumnMenu={menu:null,linkedBoxPipelineMenu:null,columnData:null,pipeline:null,parentElement:null,filterValueChanged:false,itemChosenCallback:null,menuItems:{},trackingContext:{widgetContext:"pipelineView/spreadsheet",widget:"columnMenu"},init:function(cb){self.setup();if(cb){cb()}},setColumnData:function(columnData,pipeline,parentElement){self.columnData=columnData;self.pipeline=pipeline;self.parentElement=parentElement;self.toggleItems()},setup:function(){var menu=BB.Widgets.Menu.create({css:{position:"fixed",overflow:"visible",minWidth:"200px"}});this._addSortOptions(menu);menu.addSeparator();this._addFilterOptions(menu);this._addGroupByOption(menu);this._addDateGroupByOption(menu);menu.addSeparator();this._addMoveOptions(menu);menu.addSeparator();this._addInsertColumnOptions(menu);this._addSummaryOptions(menu);this._addHideOption(menu);this._addDeleteOption(menu);this._addRemoveOption(menu);menu.el.on("click",function(e){e.stopPropagation();e.preventDefault()});self.menu=menu},setItemChosenCallback:function(callback){self.itemChosenCallback=callback;self.summarySubmenu.setItemChosenCallback(callback)},callItemChosenCallback:function(){if(self.itemChosenCallback){self.itemChosenCallback()}},_addSortOptions:function(menu){var setSort=function(isAsc,isChecked){var type="ASC";if(!isAsc){type="DESC"}if(isChecked){self.columnData.changeSort(type);type+="_ON"}else{self.columnData.changeSort("NONE");type+="_OFF"}self.track("sortColumn",{type:type});self.callItemChosenCallback()};self.menuItems.sortTextASC=menu.addCheckItem(Locale.getString("sort_asc"),function(isChecked,e){setSort(true,isChecked)});self.menuItems.sortTextDESC=menu.addCheckItem(Locale.getString("sort_desc"),function(isChecked,e){setSort(false,isChecked)});self.menuItems.sortDateASC=menu.addCheckItem(Locale.getString("sort_date_asc"),function(isChecked,e){setSort(true,isChecked)});self.menuItems.sortDateDESC=menu.addCheckItem(Locale.getString("sort_date_desc"),function(isChecked,e){setSort(false,isChecked)
});self.menuItems.sortNumberASC=menu.addCheckItem(Locale.getString("sort_number_asc"),function(isChecked,e){setSort(true,isChecked)});self.menuItems.sortNumberDESC=menu.addCheckItem(Locale.getString("sort_number_desc"),function(isChecked,e){setSort(false,isChecked)})},_addFilterOptions:function(menu){self.menuItems.filterSection=$(document.createElement("div"));self.menuItems.filterSection.addClass("streak__filterInputSection J-N");self.menuItems.filterSection[0].innerHTML='<div class="streak__filterInputTitle"></div>';self.menuItems.filterInput=$('<input type="text" placeholder="'+BB.Locale.getString("filter_text_placeholder")+'"></input>');self.menuItems.filterSection.append(self.menuItems.filterInput);self.menuItems.filterInput[0].oninput=function(){self.filterValueChanged=true};self.menuItems.filterInput.on("keydown",function(e){if(e.which===13){if(self.menuItems.filterInput.val().length>0){self.close()}else{self.columnData.clearFilter()}}});menu.addSection(self.menuItems.filterSection);self.menuItems.filterAdvanced=menu.addItem(BB.Locale.getString("column_advanced_filters"),function(){self.columnData.setAdvancedFilter();self.callItemChosenCallback()})},_addGroupByOption:function(menu){self.menuItems.groupBySeparator=menu.addSeparator();self.menuItems.groupBy=menu.addCheckItem(Locale.getString("column_group_by"),function(isChecked,e){if(isChecked){self.columnData.setGroupBy()}else{self.columnData.unGroupBy()}self.callItemChosenCallback()})},_addDateGroupByOption:function(menu){var dateSubMenu=BB.Widgets.Menu.create({css:{"overflow-y":"auto","overflow-x":"hidden"}});var toggleGroupBy=function(granularity,isChecked){if(isChecked){self.columnData.setGroupBy(granularity)}else{self.columnData.unGroupBy()}self.callItemChosenCallback()};self.menuItems.dateGroupByDay=dateSubMenu.addCheckItem(BB.Locale.getString("group_by_date_granularity_day"),function(isChecked){toggleGroupBy("DAY",isChecked)});self.menuItems.dateGroupByWeek=dateSubMenu.addCheckItem(BB.Locale.getString("group_by_date_granularity_week"),function(isChecked){toggleGroupBy("WEEK",isChecked)});self.menuItems.dateGroupByMonth=dateSubMenu.addCheckItem(BB.Locale.getString("group_by_date_granularity_month"),function(isChecked){toggleGroupBy("MONTH",isChecked)});self.menuItems.dateGroupByQuarter=dateSubMenu.addCheckItem(BB.Locale.getString("group_by_date_granularity_quarter"),function(isChecked){toggleGroupBy("QUARTER",isChecked)});self.menuItems.dateGroupByYear=dateSubMenu.addCheckItem(BB.Locale.getString("group_by_date_granularity_year"),function(isChecked){toggleGroupBy("YEAR",isChecked)});self.menuItems.dateGroupBy=menu.addSubMenu(Locale.getString("column_group_by"),dateSubMenu,{itemType:"checkItem",itemCallback:function(isChecked){if(isChecked){toggleGroupBy("MONTH",isChecked)}else{self.columnData.unGroupBy();self.callItemChosenCallback()}}})},_addMoveOptions:function(menu){self.menuItems.moveLeft=menu.addItem(Locale.getString("fields_move_left"),function(e){menu.el.trigger("moveLeft");self.columnData.moveLeft();self.track("moveColumn",{type:"left"});self.callItemChosenCallback()});self.menuItems.moveRight=menu.addItem(Locale.getString("fields_move_right"),function(e){menu.el.trigger("moveRight");self.columnData.moveRight();self.track("moveColumn",{type:"right"});self.callItemChosenCallback()})},_addInsertColumnOptions:function(menu){var addSubMenu=BB.Widgets.Menu.create({css:{overflow:"visible"}});this._addInsertCustomColumnOptions(addSubMenu);addSubMenu.addSeparator();this._addInsertSystemColumnOptions(addSubMenu);addSubMenu.addSeparator();this._addLinkedBoxesColumnOptions(addSubMenu);menu.addSubMenu(BB.Locale.getString("fields_button_text"),addSubMenu)},_addInsertCustomColumnOptions:function(addSubMenu){var customColumnTypes=BB.Models.BoxField.getCustomColumnTypes();_.each(customColumnTypes,function(customColumnType){addSubMenu.addItem(customColumnType.name,function(){self.menu.el.hide();self.columnData.addCustomColumn(customColumnType.type);self.track("addColumn",{type:customColumnType.type});self.callItemChosenCallback()})})},_addInsertSystemColumnOptions:function(addSubMenu){var addSubMenuSystemBoxFields=BB.Widgets.Menu.create({css:{"overflow-y":"auto","overflow-x":"hidden"}});var currGroup=null;_.chain(BB.Models.Pipeline.getExtraSystemProperties()).sortBy(function(systemProperty){return systemProperty.group+" "+systemProperty.title}).each(function(systemProperty){if(currGroup!==systemProperty.group){if(currGroup!==null){addSubMenuSystemBoxFields.addSeparator()}currGroup=systemProperty.group}addSubMenuSystemBoxFields.addItem(systemProperty.title,function(){self.columnData.addSystemColumn(systemProperty);self.callItemChosenCallback()})});addSubMenu.addSubMenu(BB.Locale.getString("system_columns"),addSubMenuSystemBoxFields)},_addLinkedBoxesColumnOptions:function(addSubMenu){self._linkedBoxPipelineMenu=BB.Widgets.Menu.create({css:{"overflow-y":"auto","overflow-x":"hidden"}});addSubMenu.addSubMenu(BB.Locale.getString("linked_boxes_columns"),self._linkedBoxPipelineMenu)},_setupLinkedBoxesColumnOptions:function(){self._linkedBoxPipelineMenu.empty();self._linkedBoxPipelineMenu.addItem(BB.Locale.getString("all_linked_boxes"),function(){self.columnData.addSystemColumn(BB.Models.Pipeline.getLinkedBoxSystemColumn());self.callItemChosenCallback()});var pipelines=BB.UI.getSortedPipelines();if(pipelines.length>1){self._linkedBoxPipelineMenu.addSeparator()}_.each(pipelines,function(pipeline){self._linkedBoxPipelineMenu.addItem(BB.Locale.getString("linked_boxes_title",{pipeline:pipeline.displayName()}),function(){self.columnData.addSystemColumn(BB.Models.Pipeline.getLinkedBoxSystemColumn(pipeline));self.callItemChosenCallback()})})},_addSummaryOptions:function(menu){self.summarySubmenu=new BB.Widgets.NewSpreadsheet.GroupSummaryMenuViewController;self.summarySubmenuEntry=menu.addSubMenu(BB.Locale.getString("summarize_column"),self.summarySubmenu.getMenu())},_addHideOption:function(menu){menu.addItem(Locale.getString("hide"),function(e){self.columnData.hide();self.track("hideColumn");self.callItemChosenCallback()})},_addDeleteOption:function(menu){self.menuItems.deleteItem=menu.addItem(Locale.getString("delete"),function(e){self.track("DeleteColumnAttempt");BB.Widgets.Modal.confirmDelete(self.columnData.getName(),function(){var fieldKey=self.columnData.fieldKey;if(!fieldKey){self.columnData.remove();return}var fieldValues=BB.UI.getFieldValues(self.pipeline,fieldKey);if(fieldValues.length===0){self.columnData.remove();self.track("DeleteColumn");return}var del2Message=BB.Locale.getString("confirm_2_text");var del2Modal=BB.Widgets.Modal.create({title:BB.Locale.getString("confirm_delete_title",{item:self.columnData.getName()}),confirmFunc:function(){$.modal.close();self.columnData.remove();self.track("DeleteColumn");self.callItemChosenCallback()},confirmText:BB.Locale.getString("delete"),inner:'<div class="superConfirm">'+del2Message+"</div>",doneButtonColor:"red"});del2Modal.show(true);return true},null,function(){self.track("DeleteColumnCancelled")})})},_addRemoveOption:function(menu){self.menuItems.removeItem=menu.addItem(Locale.getString("remove"),function(e){self.track("removeSystemColumn");self.columnData.remove();self.callItemChosenCallback()})},close:function(){if(self.filterValueChanged){self.filterValueChanged=false;self.columnData.setContainsFilter(self.menuItems.filterInput.val());self.callItemChosenCallback()}},toggleItems:function(){self.menu.reset();self.menu.el.show();self.filterValueChanged=false;var filterable=true;if(_.isReal(self.columnData.property)){filterable=BB.Models.Pipeline.isPropertyFilterable(self.columnData.property)}if(filterable){self.menuItems.filterSection.show();self.menuItems.filterAdvanced.show();if(self.columnData.canFilterByContains()){self.menuItems.filterInput.val("");self.menuItems.filterInput.prop("disabled",false);if(self.columnData.isAdvancedFiltered()){self.menuItems.filterInput.val("part of advanced filter");self.menuItems.filterInput.prop("disabled",true)}else if(self.columnData.getContainsFilter()){self.menuItems.filterInput.val(self.columnData.getContainsFilter())}}else{self.menuItems.filterSection.hide()}}else{self.menuItems.filterSection.hide();self.menuItems.filterAdvanced.hide()}self.menuItems.groupBySeparator.show();if(self.columnData.isDateColumn()){self.menuItems.groupBy.hide();self.menuItems.dateGroupBy.show();self.menuItems.dateGroupBy.find("> div > .text").text(BB.Locale.getString("column_group_by",{column:self.columnData.getName()}));self.menuItems.dateGroupBy.setCheckboxState(self.columnData.isGroupedBy());self.menuItems.dateGroupByDay.setCheckboxState(false);self.menuItems.dateGroupByWeek.setCheckboxState(false);self.menuItems.dateGroupByMonth.setCheckboxState(false);self.menuItems.dateGroupByQuarter.setCheckboxState(false);self.menuItems.dateGroupByYear.setCheckboxState(false);if(self.columnData.isGroupedBy()){switch(self.columnData.getGranularity()){case"DAY":self.menuItems.dateGroupByDay.setCheckboxState(true);break;case"WEEK":self.menuItems.dateGroupByWeek.setCheckboxState(true);break;case"MONTH":self.menuItems.dateGroupByMonth.setCheckboxState(true);break;case"QUARTER":self.menuItems.dateGroupByQuarter.setCheckboxState(true);break;case"YEAR":self.menuItems.dateGroupByYear.setCheckboxState(true);break}}}else{self.menuItems.dateGroupBy.hide();self.menuItems.groupBy.show();self.menuItems.groupBy.find(".text").text(BB.Locale.getString("column_group_by",{column:self.columnData.getName()}));if(_.isReal(self.columnData.property)){if(BB.Models.Pipeline.isPropertyGroupable(self.columnData.property)){self.menuItems.groupBy.setCheckboxState(self.columnData.isGroupedBy())}else{self.menuItems.groupBySeparator.hide();self.menuItems.groupBy.hide()}}else{self.menuItems.groupBy.setCheckboxState(self.columnData.isGroupedBy())}}var columnType;if(self.columnData.property){columnType=BB.Models.Pipeline.getPropertySortType(self.columnData.property)}else if(self.columnData.fieldKey){columnType=self.pipeline.getField(self.columnData.fieldKey).get("type")}self.menuItems.sortTextASC.hide();self.menuItems.sortTextDESC.hide();self.menuItems.sortDateASC.hide();self.menuItems.sortDateDESC.hide();self.menuItems.sortNumberASC.hide();self.menuItems.sortNumberDESC.hide();var sortMenuASC,sortMenuDESC;switch(columnType){case"NUMBER":sortMenuASC=self.menuItems.sortNumberASC;sortMenuDESC=self.menuItems.sortNumberDESC;break;case"DATE":sortMenuASC=self.menuItems.sortDateASC;sortMenuDESC=self.menuItems.sortDateDESC;break;default:sortMenuASC=self.menuItems.sortTextASC;sortMenuDESC=self.menuItems.sortTextDESC}sortMenuASC.show();sortMenuDESC.show();sortMenuASC.setCheckboxState(self.columnData.sort==="ASC");sortMenuDESC.setCheckboxState(self.columnData.sort==="DESC");self.columnData.isFirst?self.menuItems.moveLeft.hide():self.menuItems.moveLeft.show();self.columnData.isLast?self.menuItems.moveRight.hide():self.menuItems.moveRight.show();self._setupLinkedBoxesColumnOptions();if(self.columnData.isSummarizable){self.summarySubmenu.setup(self.columnData);self.summarySubmenuEntry.show()}else{self.summarySubmenuEntry.hide()}if(self.columnData.isRemovable){self.menuItems.removeItem.show()}else{self.menuItems.removeItem.hide()}if(self.columnData.isDeletable){self.menuItems.deleteItem.show()}else{self.menuItems.deleteItem.hide()}self.menu.setIsLast(self.columnData.isLast);self.menu.el.css({left:self.parentElement.offset().left-self.menu.el.outerWidth()+self.parentElement.outerWidth(),top:self.parentElement.offset().top+self.parentElement.outerHeight()});self.menu.el.containByScreen(self.parentElement,{isRightAligned:true})},track:function(event,properties){BB.Tracker.trackStreakActive(this.trackingContext,properties,{eventName:event})}};Streak.DependencyManager.addFunction({functionKey:"columnMenuInitialized",functionToCall:ColumnMenu.init,functionContext:ColumnMenu,dependentFunctionKeys:["menuInitialized","enabledFeaturesControllerInitialized"]});BB.Widgets.ColumnMenu=ColumnMenu})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,ColumnSummary=BB.ColumnSummary,Locale=Streak.Locale;var superclass=Streak.UI.ViewController;var GroupSummaryMenuViewController=Streak.Class.subclass({className:"GroupSummaryMenuViewController",superclass:superclass,memberVariables:[{name:"_menu",destroy:true},{name:"_itemChosenCallback",destroy:false,set:true},{name:"_column",destroy:false},{name:"_cell",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._menu=BB.Widgets.Menu.create({css:{position:"fixed",overflow:"visible",minWidth:"200px"}})},_setupView:function(){},getMenu:function(){return this._menu},getElement:function(){return this._menu.getElement()},close:function(){this._menu.getElement().detach();if(this._cell){this._cell.removeClass("menuOpen")}this._column=null;this._cell=null},setup:function(column,cell){this._column=column;this._cell=cell;if(this._cell){this._cell.addClass("menuOpen")}this._configureMenu()},_configureMenu:function(){var self=this,column=this._column;this._menu.empty();if(!column.summaryFunctions||column.summaryFunctions.length===0){this._menu.addItem("Error: no summary functions for column");BB.logError("No summary functions for column");return}["none","|"].concat(column.summaryFunctions).forEach(function(summaryFunctionName){if(summaryFunctionName==="|"){self._menu.addSeparator();return}var summaryFunction=summaryFunctionName=="none"?null:summaryFunctionName;var menuHtml=ColumnSummary.getLocalizedName(summaryFunctionName).escapeHTML();var menuItem=self._menu.addCheckItem(menuHtml,function(){if(summaryFunction!==null&&!BB.isFeatureEnabled("formulaFields")&&BB.Services.PipelineSummaryLimiter.isLocked()){BB.Services.PipelineSummaryLimiter.showGateway();return}column.setSummaryFunction(summaryFunction);BB.Services.PipelineSummaryLimiter.incrementUsage();if(self._itemChosenCallback){self._itemChosenCallback()}});menuItem.setCheckboxState(summaryFunction==column.chosenSummaryFunction)});if(this._cell){var menuEl=this._menu.getElement();var parentEl=menuEl.parent();menuEl.css({left:parentEl.offset().left-menuEl.outerWidth()+parentEl.outerWidth(),top:parentEl.offset().top+parentEl.outerHeight()});menuEl.containByScreen(parentEl)}}});BB.Widgets.NewSpreadsheet.GroupSummaryMenuViewController=GroupSummaryMenuViewController})(Streak);(function(Streak){var $=Streak.jQuery,BB=Streak.BentoBox;$.fn.spreadsheetArrow=function(disabledKeys){disabledKeys=disabledKeys||[];return this.each(function(){var self=this;var el=$(this);var arrowMode=false;self.setArrowMode=function(isArrow){arrowMode=isArrow};BB.Keyboard.bindChordToElement(el,"tab",function(e){el.trigger("onblur");el.trigger("tabPressed")},true,true);BB.Keyboard.bindChordToElement(el,"shift+tab",function(e){el.trigger("onblur");el.trigger("shiftTabPressed")},true,true);BB.Keyboard.bindChordToElement(el,"up",function(e){if(arrowMode&&disabledKeys.indexOf("up")===-1){el.trigger("upPressed");el.trigger("onblur")}});BB.Keyboard.bindChordToElement(el,"down",function(e){if(arrowMode&&disabledKeys.indexOf("down")===-1){el.trigger("downPressed");el.trigger("onblur")}});BB.Keyboard.bindChordToElement(el,"right",function(e){var val=el.val();if(el.is("div")){val=el[0].innerHTML}if(el.caret().start===val.length){e.preventDefault();e.stopPropagation()}if(arrowMode&&disabledKeys.indexOf("right")===-1){if(el.caret().start===val.length){el.trigger("rightPressed");el.trigger("onblur")}}});BB.Keyboard.bindChordToElement(el,"left",function(e){if(el.caret().start===0){e.preventDefault();e.stopPropagation()}if(arrowMode&&disabledKeys.indexOf("left")===-1){if(el.caret().start===0){el.trigger("leftPressed");el.trigger("onblur")}}})})}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,jwerty=Streak.jwerty,BB=Streak.BentoBox;var SpreadsheetAssignedTo={templates:{},create:function(){return new this.impl}};SpreadsheetAssignedTo.impl=function(){return BB.Widgets.PeoplePicker.create({jsonified:false,delayedBind:true,onlyValidEmailAddress:true,neverShowRead:true,isRightAligned:false})};BB.Widgets.SpreadsheetAssignedTo=SpreadsheetAssignedTo})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,jwerty=Streak.jwerty,BB=Streak.BentoBox;var SpreadsheetPeoplePicker={templates:{},create:function(options){return new this.impl(options)}};SpreadsheetPeoplePicker.impl=function(options){options.neverShowRead=true;options.isRightAligned=false;return BB.Widgets.PeoplePicker.create(options)};BB.Widgets.SpreadsheetPeoplePicker=SpreadsheetPeoplePicker})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var SpreadsheetSmartDropdown={templates:{},create:function(options){return new this.impl(options)}};SpreadsheetSmartDropdown.impl=function(o){var outerEl=null,el=null,hInput=null,currentValue=null,menu=BB.Widgets.Menu.create({maxHeight:"250px"}),model=null,models=null,property=null,list=null,updateCallback=$.noop,options=o;var setupElement=function(){if(outerEl){outerEl.remove()}outerEl=$(document.createElement("div"));el=$(document.createElement("div"));hInput=$(document.createElement("input"));outerEl[0].setAttribute("class","dropdownWrapper");el[0].setAttribute("class","dropdown smartInput");el[0].setAttribute("tabindex","-1");menu.getElement().addClass("streak__spreadsheetDropdownMenu");bind()},getValue=function(){if(property){return model.get(property)}},updateValue=function(newValue){if(newValue!=currentValue){if(property){var saveCalls=[];for(var i=0;i<models.length;i++){var value=newValue.value?newValue.value:newValue;models[i].set(property,value)}var savingProgressId=Streak.Model.saveAll(models,null,true);_addMessagesForStageChangeProgress(savingProgressId);BB.Tracker.trackStreakActive(options.trackingContext,{property:property,widget:"SpreadsheetSmartDropdown",numberOfBoxes:models.length})}}},showEdit=function(){var index=list.findIndex(function(item){return(item.value?item.value:item)===getValue()});currentValue=list[index];outerEl.text(currentValue.text?currentValue.text:currentValue);outerEl.append(el);renderMenu(index)},focus=function(){arrowMode=false;hInput.val("");showEdit();saveValue=currentValue;el.focus()},set=function(val){hInput.val(val);setCursor();arrowMode=true},setup=function(options){setupElement();model=options.model;models=options.models;property=options.property;list=options.list;updateCallback=options.updateCallback},bind=function(){outerEl.off("bbCursorDeselect");outerEl.on("bbCursorDeselect",function(e){e.preventDefault();e.stopPropagation()});outerEl.bind("click.smartDropdown",function(e){el.trigger("escapePressed")});menu.el.bind("click.smartDropdown",function(e){cursor.select();e.preventDefault();e.stopPropagation()});BB.Keyboard.bindChordToElement(el,"[a-z]/shift+[a-z]/backspace",function(e){clearTimeout(timeout);if(jwerty.is("backspace",e)){hInput.val(hInput.val().first(hInput.val().length-1))}else{hInput.val(hInput.val()+String.fromCharCode(e.which))}setCursor();timeout=setTimeout(function(){hInput.val("")},1e3)},true,true);BB.Keyboard.bindChordToElement(el,"up/down/home/end",function(e){hInput.val("")},true,true);BB.Keyboard.bindChordToElement(el,"right",function(e){if(arrowMode){el.trigger("rightPressed");cursor.select()}});BB.Keyboard.bindChordToElement(el,"left",function(e){if(arrowMode){el.trigger("leftPressed");cursor.select()}});BB.Keyboard.bindChordToElement(el,"escape",function(e){el.trigger("escapePressed")},true,true,true);BB.Keyboard.bindChordToElement(el,"tab",function(e){el.trigger("tabPressed")},true,true,true);BB.Keyboard.bindChordToElement(el,"shift+tab",function(e){el.trigger("shiftTabPressed")},true,true,true);cursor=BB.Cursor.create({selectedClass:"J-N-JT",selectFunc:function(itemEl,isEnter){updateValue(itemEl.data("itemValue"));el.trigger("escapePressed")},highlightOnHover:true,rollOver:true,input:el,noScroll:true})},renderMenu=function(index){menu.empty();_.each(list,function(item){var text=item.text?item.text:item;var itemEl=menu.addItem(_.escape(text),function(){});itemEl.data("itemValue",item)});cursor.setup(menu.el.find(".menuItem"));cursor.setPosition([index]);var anchor=outerEl;Gmail.elements.body.append(menu.getElement());menu.getElement()[0].style.position="fixed";menu.el.containByScreen(outerEl)},setCursor=function(){var val=hInput.val().toLowerCase();$.each(list,function(index,item){var text=item.text?item.text:item;if(text.toLowerCase().startsWith(val)){cursor.setPosition([index]);return}})},cursor=null,arrowMode=false,timeout=null;return{el:outerEl,getElement:function(){return outerEl},focus:focus,set:set,setup:setup,updateValue:function(){menu.getElement().detach()},destroy:function(){if(outerEl){outerEl.remove()}}}};function _addMessagesForStageChangeProgress(savingProgressId){BB.ButterBarManager.showProgress({initial:"saving",progressSuccess:"stage_change_boxes_status_update",progressError:function(notification,strParameters){strParameters.box=_.escape(notification.operation.getModel().displayName());return BB.Locale.getString("stage_change_boxes_error_update",strParameters)},completeSuccess:undefined,completeError:"stage_change_boxes_error",operationProgressId:savingProgressId})}BB.Widgets.SpreadsheetSmartDropdown=SpreadsheetSmartDropdown})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var SpreadsheetTextarea={templates:{},create:function(options){return new this.impl(options)}};SpreadsheetTextarea.impl=function(o){var el=null,editEl=null,currentValue=null,editValue=null,arrowMode=false,model=null,property=null,existingList=[],options=o;var setupElement=function(){if(el){el.remove()}el=$(document.createElement("div"));el[0].innerHTML='<div contentEditable="true" class="edit"></div>';el[0].setAttribute("class","smartInput spreadsheetTextarea");el[0].setAttribute("tabindex","-1");editEl=el.find(".edit");bind()},getValue=function(){return model.get(property)||""},updateValue=function(){var val=getValue();if(val!==editValue){currentValue=editValue;model.set(property,editValue);model.save();BB.Tracker.trackStreakActive(options.trackingContext,{property:property,widget:"spreadsheetTextarea"})}},showEdit=function(){if(editEl.is(":focus")){return}editEl.setPlainText(getValue());editEl[0].setAutoCompleteList(existingList);editEl.focus();focusEnd()},focus=function(){currentValue=getValue();editValue=currentValue;showEdit();editEl[0].setArrowMode(false)},focusEnd=function(){setTimeout(function(){editEl.caret().goToEnd()},1)},set=function(val){currentValue=getValue();focus();editEl.setPlainText(val);editEl[0].setArrowMode(true);editEl.trigger("input")},setup=function(options){setupElement();model=options.model;property=options.property;existingList=options.existingList},preDetach=function(){editEl.trigger("preDetach")},bind=function(){editEl.bind("escapePressed",function(e){editValue=getValue();editEl.setPlainText(editValue)});editEl.bind("enterPressed",function(e){editValue=editEl.plainText()});BB.Keyboard.bindChordToElement(editEl,"meta+enter/ctrl+enter",function(e){e.stopPropagation()},true,false,false,"keypress");editEl.delayedSave({saveFunction:function(){editValue=editEl.plainText()},delay:1});editEl.on("autoCompleteSet",function(e){editValue=editEl.plainText()});editEl.autoComplete("plainText");editEl.spreadsheetArrow()};return{el:el,getElement:function(){return el},focus:focus,set:set,setup:setup,updateValue:updateValue,preDetach:preDetach,destroy:function(){if(el){el.remove()}}}};BB.Widgets.SpreadsheetTextarea=SpreadsheetTextarea})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,BB=Streak.BentoBox;var SpreadsheetTextbox=function(options){this.el=$(document.createElement("input"));this.property=null;this.model=null;this.td=null;this.currentValue=null;this.options=options;this.arrowMode=false;this.validator=null;this.callOnEmptyFunction=null;this.setupElement();this.setupBindings()};SpreadsheetTextbox.create=function(options){return new SpreadsheetTextbox(options)};_.extend(SpreadsheetTextbox.prototype,{setupElement:function(){this.el[0].setAttribute("type","text");this.el[0].setAttribute("class","smartInput textboxNoborder");this.el[0].setAttribute("tabindex","-1")},setupBindings:function(){var self=this;BB.Keyboard.bindChordToElement(self.el,"escape",function(e){self.el.val(self.currentValue);self.el.trigger("escapePressed")},true,true,true,"keydown",true);BB.Keyboard.bindChordToElement(self.el,"enter",function(e){self.el.trigger("enterPressed")},true,true,true,"keydown",true);BB.Keyboard.bindChordToElement(self.el,"up",function(e){if(self.arrowMode){self.el.trigger("upPressed")}});BB.Keyboard.bindChordToElement(self.el,"down",function(e){if(self.arrowMode){self.el.trigger("downPressed")}});BB.Keyboard.bindChordToElement(self.el,"right",function(e){if(self.el.caret().start===self.el.val().length){e.preventDefault();e.stopPropagation()}if(self.arrowMode){if(self.el.caret().start===self.el.val().length){self.el.trigger("rightPressed")}}});BB.Keyboard.bindChordToElement(self.el,"left",function(e){if(self.el.caret().start===0){e.preventDefault();e.stopPropagation()}if(self.arrowMode){if(self.el.caret().start===0){self.el.trigger("leftPressed")}}})},setup:function(options){this.options=options;this.model=options.model;this.property=options.property;this.validator=options.validator;this.callOnEmptyFunction=options.callOnEmptyFunction;this.el.val(this.getValue())},getValue:function(){return this.model.get(this.property)},updateValue:function(){var editorValue=this.el.val().trim();try{if(!editorValue&&!this.currentValue){if(this.callOnEmptyFunction){this.callOnEmptyFunction()}return}}catch(e){return}if(!editorValue){return}if(editorValue===this.currentValue){return}this.currentValue=editorValue;this.model.set(this.property,editorValue.trim());this.model.save();this.track()},focus:function(){this.currentValue=this.getValue();this.el.show();this.el.focus();this.el.caret().goToEnd();this.arrowMode=false},set:function(val){this.el.val(val);this.focus();this.arrowMode=true},getElement:function(){return this.el},track:function(){BB.Tracker.trackStreakActive({property:this.property,widget:"spreadsheetTextbox"})},destroy:function(){this.el.remove()}});BB.Widgets.SpreadsheetTextbox=SpreadsheetTextbox})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,_=Streak._,BB=Streak.BentoBox;var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Widgets.FollowerButton={templates:{},defaults:{width:"50px",box:null,hideUnfollow:false,followEventCallback:$.noop,unfollowEventCallback:$.noop,displayValue:"block"},create:function(options){this._init();var o={};_.extend(o,this.defaults,options);return new BB.Widgets.FollowerButton.impl(o)},_init:function(cb){if(!this.templates.mainView){this.templates.mainView=HTML.get("followerButton")}}};BB.Widgets.FollowerButton.impl=function(options){var returnObject={};var box=options.box;var el=$(BB.Widgets.FollowerButton.templates.mainView());options.trackingContext.widgetContext+="/followerButton";var followButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("follow_box"),color:"green",onFunction:function(){track("followBox",options.trackingContext);var userKey=BB.getUser().get("userKey");var followerKeys=box.get("followerKeys");if(!_.isArray(followerKeys)){followerKeys=[]}if(followerKeys.indexOf(userKey)<0){followerKeys.push(userKey);box.set("followerKeys",followerKeys);box.save();options.followEventCallback()}renderButton()}});var unfollowButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("unfollow_box"),color:"default",onFunction:function(){track("unfollowBox",options.trackingContext);var userKey=BB.getUser().get("userKey");var followerKeys=box.get("followerKeys");if(followerKeys.indexOf(userKey)>-1){followerKeys.removeVal(userKey);box.set("followerKeys",followerKeys);box.save();options.unfollowEventCallback()}renderButton()}});var renderButton=function(){if(isFollowing()){followButton.getElement().hide();if(!options.hideUnfollow){unfollowButton.getElement().fastShow(options.displayValue)}}else{unfollowButton.getElement().hide();followButton.getElement().fastShow(options.displayValue)}};var isFollowing=function(){return box.get("followerKeys").indexOf(BB.getUser().get("userKey"))>-1};followButton.getElement().hide();unfollowButton.getElement().hide();renderButton();box.watch("set",renderButton,returnObject,"followerKeys");followButton.getElement().addClass("followerButton");unfollowButton.getElement().addClass("followerButton");el.append(followButton.getElement());el.append(unfollowButton.getElement());returnObject.el=el;returnObject.getActiveButton=function(){if(isFollowing()){return unfollowButton.getElement()}else{return followButton.getElement()}};returnObject.destroy=function(){Streak.NotificationCenter.unsubscribe({observer:returnObject});followButton.destroy();unfollowButton.destroy();el.remove()};returnObject.getElement=function(){return returnObject.el};return returnObject}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var NewFollowerListViewController=Streak.Class.subclass({className:"NewFollowerListViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_box",destroy:false},{name:"_followerButton",destroy:true},{name:"_newPeopleListViewController",destroy:true}],_initialize:function(box){Streak.UI.ViewController.prototype._initialize.call(this);this._view.addClass("streak__newFollowerList");this._box=box;this._setupFollowerButton();this._setNewPeopleListViewController();this._bindToBox();this._render()},_setupFollowerButton:function(){this._followerButton=BB.Widgets.FollowerButton.create({box:this._box,displayValue:"inline-block",trackingContext:{widgetContext:"newFollowerListViewController"}});this._view.addSubView(this._followerButton)},_setNewPeopleListViewController:function(){this._newPeopleListViewController=new BB.Widgets.NewPeopleListViewController(2);this._view.addSubView(this._newPeopleListViewController.getView())},_bindToBox:function(){this._box.watch("set",this._render.bind(this),this,"followerKeys")},_render:function(){if(this._box.get("followerKeys").length===0){this._newPeopleListViewController.renderList([]);return}var self=this;BB.Contacts.getContactsFromUserKeys(this._box.get("followerKeys"),function(contacts){if(!self._newPeopleListViewController){return}self._newPeopleListViewController.renderList(contacts)})},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.NewFollowerListViewController",NewFollowerListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PostCommentViewController=Streak.Class.subclass({className:"PostCommentViewController",superclass:Streak.Object,_memberVariables:[{name:"_box",destroy:false},{name:"_element",destroy:true,get:true},{name:"_commentTextarea",destroy:true},{name:"_postButton",destroy:true},{name:"_feedListViewController",destroy:false}],_initialize:function(box,feedListViewController){Streak.Object.prototype._initialize.call(this);this._box=box;this._feedListViewController=feedListViewController;this._setupElement();this._setupPostButton();this._setupEnabler()},_setupElement:function(){this._element=HTML.getElement("postComment");this._commentTextarea=this._element.find(".postCommentField");
var user=BB.getUser();if(user){var src=user.get("googleProfilePhotoUrl");if(src){this._element.find(".comment_userface").html($("<img/>").attr("src",src))}}},_setupPostButton:function(){this._postButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("post_comment"),color:"green",onFunction:this._postComment.bind(this)});this._postButton.addClass("postCommentButton");this._commentTextarea.easyTab({next:this._postButton.getElement()});this._postButton.getElement().easyTab({prev:this._commentTextarea});this._element.find(".buttonWidget").append(this._postButton.getElement())},_setupEnabler:function(){this._setEnabled(this._box.getPipeline().getCollaborationStatus()!="LOCKDOWN")},_setEnabled:function(enabled){if(enabled){this._element.removeClass("disabled");this._commentTextarea.attr("contenteditable",true);this._postButton.enable()}else{this._element.addClass("disabled");this._commentTextarea.removeAttr("contenteditable");this._postButton.disable()}},_postComment:function(){var commentText=this._commentTextarea.plainText();if(!commentText){return}this._postButton.disable();this._addSaveCommentOperation(commentText);BB.Tracker.track("post comment")},_addSaveCommentOperation:function(commentText){var saveCommentOperation=new BB.Widgets.SaveCommentOperation({boxKey:this._box.key(),commentText:commentText});var operationProgressId=Streak.Operations.OperationQueue.Singleton.addOperation(saveCommentOperation);BB.ButterBarManager.showSaving({operationProgressId:operationProgressId});NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationIsComplete:true,operationProgressId:operationProgressId},observer:this,unsubscribeImmediately:true,functionToCall:this._handleSaveCommentOperationFinished})},_handleSaveCommentOperationFinished:function(notification){this._postButton.enable();if(notification.operationHasErrors){BB.ButterBarManager.showError(BB.Locale.getString("error_comment"),{time:5e3})}else{this._commentTextarea.text("");this._feedListViewController.newCommentPosted()}}});Library.set("BentoBox.Widgets.PostCommentViewController",PostCommentViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SaveCommentOperation=Streak.Class.subclass({className:"SaveCommentOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_boxKey",destroy:false},{name:"_commentText",destroy:false}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._boxKey=options.boxKey;this._commentText=options.commentText;this._tags=this._getTags();this._dependentOnTags=this._tags;this._limiterTagsAndTypes=this._getLimiterTagsAndTypes()},_getTags:function(){return["box_newComment_boxKey_"+this._boxKey]},_getLimiterTagsAndTypes:function(){return BB.Data.getBox(this._boxKey).getRequestLimiterTagsAndTypes("UPDATE")},getMethod:function(){return"PUT"},getParams:function(){return{url:"boxes/"+this._boxKey+"/comments",message:this._commentText}}});Library.set("BentoBox.Widgets.SaveCommentOperation",SaveCommentOperation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=UI.View;var ReminderEditView=Streak.Class.subclass({className:"ReminderEditView",superclass:superclass,_memberVariables:[{name:"_createButtonElement",destroy:true},{name:"_editButtonElement",destroy:true},{name:"_deleteButtonElement",destroy:true},{name:"_createButton",destroy:false},{name:"_editButton",destroy:false},{name:"_input",destroy:true},{name:"_date",destroy:true},{name:"_formValid",destroy:false,defaultValue:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._createButtonElement=this._element.find(".streak__reminderViewMenu_createButton");this._editButtonElement=this._element.find(".streak__reminderViewMenu_editButton");this._deleteButtonElement=this._element.find(".streak__reminderViewMenu_deleteButton");this._setupInputBox();this._setupSuggestedTimeLinks();this._setupCheckbox();this._setupMessage();this._setupTabOrder()},setMessage:function(message){this._element.find(".notesEnter").val(message)},setIncludeFollowers:function(showIncludeFollowers){this._element.find(".includeFollowers")[0].checked=showIncludeFollowers},setCreateButton:function(button){this._createButton=button;this._createButtonElement.html(button.getElement());this._setupTabOrder()},setDeleteButton:function(button){this._deleteButtonElement.html(button.getElement());this._setupTabOrder()},setEditButton:function(button){this._editButton=button;this._editButtonElement.html(button.getElement());this._setupTabOrder()},showEditButton:function(visible){this._editButtonElement.toggle(visible)},showCreateButton:function(visible){this._createButtonElement.toggle(visible)},showDeleteButton:function(visible){this._deleteButtonElement.toggle(visible)},focus:function(){this._input.focus()},setDate:function(date){this._date=date;var dateValid=!!date;this._enableSaveButtonElements(dateValid);this._input.toggleClass("valid",dateValid);this._callDelegateFunction("dateChanged",date)},setKnownValidDate:function(date){this._input.val(date.customFormat("longDateTime"));this._element.find(".scheduledDate").text(date.customFormat("shortWithWeekday"));this._input.addClass("valid")},getDateText:function(){return this._input.val().trim()},setSendLaterText:function(text){this._element.find(".scheduledDate").text(text)},_setupInputBox:function(){var self=this;this._input=this._element.find(".dateInput");this._input.keyup(function(e){if(Streak.jwerty.is("escape",e)){self._callDelegateFunction("escapePressed");return}if(Streak.jwerty.is("enter",e)){self._callDelegateFunction("enterPressed");return}self._callDelegateFunction("dateTextChanged")})},_messageChanged:function(){var message=this._element.find(".notesEnter").val();this._callDelegateFunction("messageChanged",message)},_remindFollowersChanged:function(){var remindFollowers=this._element.find(".includeFollowers")[0].checked===true;this._callDelegateFunction("remindFollowersChanged",remindFollowers)},_setupElement:function(){this._element=HTML.getElement("reminderListMenu")},_setupTabOrder:function(){$.tabChain(_.compact([this._input,this._element.find(".notesEnter"),this._element.find(".includeFollowers"),this._createButtonElement,this._editButtonElement]))},_setupSuggestedTimeLinks:function(){var self=this;this._element.find("a.streak__suggestedTime").click(function(e){e.preventDefault();self._suggestedTimeLinkClicked($(this).attr("title"))})},_suggestedTimeLinkClicked:function(text){var d=Date.ccreate(text);this._input.val(d.customFormat("longDateTime"));this._callDelegateFunction("dateTextChanged");BB.Tracker.track("suggestedTimeClick",{text:text})},_setupCheckbox:function(){this._element.find(".includeFollowers").on("change",this._remindFollowersChanged.bind(this));var id="remindFollowers"+Streak.guid();this._element.find(".includeFollowers").prop("id",id);this._element.find(".checkbox label").prop("for",id)},_setupMessage:function(){this._element.find(".notesEnter").on("change",this._messageChanged.bind(this))},_enableSaveButtonElements:function(enabled){this._createButton.toggleDisabled(!enabled);this._editButton.toggleDisabled(!enabled)}});Library.set("BentoBox.Widgets.ReminderEditView",ReminderEditView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=UI.ViewController;var ReminderEditViewController=Streak.Class.subclass({className:"ReminderEditViewController",superclass:superclass,_memberVariables:[{name:"_reminder",destroy:false},{name:"_isCreate",destroy:false},{name:"_options",destroy:false}],_initialize:function(options){if(options.reminder===undefined)throw new Error("'reminder' is a required parameter to ReminderEditViewController");this._reminder=options.reminder;if(options.isCreate===undefined)throw new Error("'isCreate' is a required parameter to ReminderEditViewController");this._isCreate=options.isCreate;this._options=_.defaults(options,{showDelete:false,showCreate:this._isCreate,showEdit:!this._isCreate});superclass.prototype._initialize.call(this);this._view.setDelegate(this);this._setupCreateButton();this._setupDeleteButton();this._setupEditButton();this._initializeViewWithReminder()},enterPressed:function(){if(!this._isReminderValid()){return}if(this._isCreate){BB.Tracker.track("contents.reminder.create");BB.Tracker.track("contents.reminder.create.enter");this._callDelegateFunction("create")}else{BB.Tracker.track("contents.reminder.edit");BB.Tracker.track("contents.reminder.edit.enter");this._callDelegateFunction("edit")}},escapePressed:function(){BB.Tracker.track("contents.reminder.escape");this._closeModal()},dateChanged:function(date){this._reminder.set("remindDate",date&&date.getTime())},messageChanged:function(message){this._reminder.set("message",message)},remindFollowersChanged:function(shouldRemindFollowers){this._reminder.set("remindFollowers",shouldRemindFollowers)},dateTextChanged:function(){var dateText=this._view.getDateText();if(dateText===""){this._view.setSendLaterText(BB.Locale.getString("send_later_enter_date"));this._view.setDate(null);return}var date=this._parseDate(dateText);if(date===null||!date.isValid()){this._view.setSendLaterText(BB.Locale.getString("send_later_invalid_date"));this._view.setDate(null);return}var now=new Date;if(date.isBefore(now)){this._view.setSendLaterText(BB.Locale.getString("send_later_future_date"));this._view.setDate(null)}else{this._view.setSendLaterText(date.customFormat("shortWithWeekday"));this._view.setDate(date)}},_parseDate:function(val){if(!val)return null;var date=Date.ccreate(val);if(date&&date.isValid())return date;return null},_isReminderValid:function(){return this._reminder.get("remindDate")},_assertReminderValid:function(){var valid=this._isReminderValid();if(!valid)BB.logError("enter pressed but reminder date was invalid",{date:this._reminder.get("remindDate")});return valid},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.ReminderEditView")},_setupEditButton:function(){var self=this;var editButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("reminder_save"),onFunction:function(){if(!self._assertReminderValid()){return}BB.Tracker.track("contents.reminder.edit");BB.Tracker.track("contents.reminder.edit.button");self._callDelegateFunction("edit")}});this._view.setEditButton(editButton);this._view.showEditButton(this._options.showEdit)},_setupCreateButton:function(){var self=this;var createButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("create"),onFunction:function(){if(!self._assertReminderValid()){return}BB.Tracker.track("contents.reminder.create");BB.Tracker.track("contents.reminder.create.button");self._callDelegateFunction("create")}});createButton.disable();this._view.setCreateButton(createButton);this._view.showCreateButton(this._options.showCreate)},_setupDeleteButton:function(){var self=this;var deleteButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("reminder_cancel"),onFunction:function(){BB.Tracker.track("contents.reminder.delete");BB.Tracker.track("contents.reminder.delete.button");self._callDelegateFunction("delete")}});this._view.setDeleteButton(deleteButton);this._view.showDeleteButton(this._options.showDelete)},_initializeViewWithReminder:function(){if(this._reminder.get("remindDate")){var d=Date.ccreate(this._reminder.get("remindDate"));this._view.setKnownValidDate(d)}this._view.setMessage(this._reminder.get("message"));this._view.setIncludeFollowers(this._reminder.get("remindFollowers"))}});Library.set("BentoBox.Widgets.ReminderEditViewController",ReminderEditViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=UI.Delegator;var ReminderMenuViewController=Streak.Class.subclass({className:"ReminderMenuViewController",superclass:superclass,_memberVariables:[{name:"_boxKey",destroy:true},{name:"_reminder",destroy:false},{name:"_reminderPatch",destroy:true},{name:"_viewController",destroy:true}],_initialize:function(parameters){parameters=parameters||{};superclass.prototype._initialize.call(this);this._reminder=parameters.reminder;this._boxKey=parameters.boxKey},getViewControllerForMenu:function(){this._setupReminderEditViewController();return this},closeModal:function(){this._callDelegateFunction("close",this);this._nullifyMemberVariable("_viewController",true)},edit:function(){this._reminderPatch.commit();this._nullifyMemberVariable("_reminderPatch",true);this._reminder.save();this.closeModal()},create:function(){this._reminder.save();BB.Data.getReminderCollection(this._boxKey).add(this._reminder);this.closeModal()},"delete":function(){this._reminder.del();this.closeModal()},getView:function(){return this._viewController.getView()},onShow:function(){this.getView().focus()},_setupReminderEditViewController:function(){var isEdit=!!this._reminder;if(isEdit){this._reminderPatch=this._reminder.createPatch();this._viewController=Library.getInstance("BentoBox.Widgets.ReminderEditViewController",{reminder:this._reminderPatch,isCreate:false,showDelete:false})}else{this._reminder=BB.Models.Reminder.create({boxKey:this._boxKey,message:"",remindFollowers:false});this._viewController=Library.getInstance("BentoBox.Widgets.ReminderEditViewController",{reminder:this._reminder,isCreate:true,showDelete:false})}this._viewController.setDelegate(this)}});Library.set("BentoBox.Widgets.ReminderMenuViewController",ReminderMenuViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,Model=Streak.Model,BB=Streak.BentoBox;var trackingContext=null;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};ReminderList={templates:{},defaults:{box:null,pipeline:null,showTitle:true,useLinkButtonForNewReminder:false},create:function(options){this._init();var o={};_.extend(o,this.defaults,options);return new BB.Widgets.ReminderList.impl(o)},_init:function(){if(!this.templates.main){this.templates.main=HTML.get("reminderList");this.templates.menu=HTML.get("reminderListMenu");this.templates.reminder=HTML.get("reminderItem")}}};ReminderList.impl=function(options){var returnObject={};var box=options.box,pipeline=options.pipeline;options.trackingContext.widgetContext+="/reminderList";trackingContext=options.trackingContext;var el=$(document.createElement("div"));el.addClass("reminderList section");el[0].innerHTML=ReminderList.templates.main();if(!options.showTitle){el.find(".title").hide()}var inner=el.find(".reminderInnerList");var inputs=[];var uniq=""+Date.now();var reminderCollection=BB.Data.getReminderCollection(box.key());var createWrapperEl=el.find(".reminderCreate");var refresh=function(){renderLoading();destroyInputs();reminderCollection.refresh(renderReminders);refreshNew()},renderReminders=function(){if(inputs===null){return}inner.empty();if(reminderCollection.length===0){renderEmpty();return}var sortedReminders=_.sortBy(reminderCollection,function(reminder){return-1*reminder.get("remindDate")});for(var ii=0;ii<sortedReminders.length;ii++){inner.append(renderReminder(sortedReminders[ii]))}},renderLoading=function(){inner.empty();var empty=$(document.createElement("tr"));empty.addClass("asd ja empty");empty[0].innerHTML=BB.Locale.getString("loading");inner.append(empty)},renderEmpty=function(){inner.empty();var empty=$(document.createElement("tr"));empty.addClass("asd ja empty");empty[0].innerHTML=BB.Locale.getString("no_reminders");inner.append(empty)},renderReminder=function(reminder){var rem=$(ReminderList.templates.reminder());reminder.watch("delete",function(){rem.remove();if(inner.find(".reminderItem").length===0){renderEmpty()}},returnObject);reminder.watch("save",function(){var newEl=$(ReminderList.templates.reminder());renderReminderEl(reminder,newEl);rem.after(newEl);rem.remove();rem=newEl},returnObject);renderReminderEl(reminder,rem);return rem},renderReminderEl=function(reminder,rem){if(reminder.get("message")){rem.find(".notes").show();rem.find(".notes").text(reminder.get("message"));rem.find(".notes").attr("title",reminder.get("message"))}else{rem.find(".notes").hide()}if(reminder.get("remindDate")){var d=Date.ccreate(reminder.get("remindDate"));var dEl=rem.find(".date");dEl.html(d.customFormat("shortWithWeekday"));if(d.isBefore(Date.now())){rem.addClass("passed")}rem.find(".y2").show();if(!reminder.get("message")){dEl.detach();rem.find(".innerDetails").append(dEl);rem.find(".dateSecond").hide()}}if(reminder.get("remindFollowers")){rem.find(".followerText").html(BB.Locale.getString("remind_followers"))}else{rem.find(".followerText").html(BB.Locale.getString("reminders_reminding")+" "+reminder.get("creatorName"))}var bm=BB.Widgets.ButtonMenu.create({menuInner:ReminderList.templates.menu(),closeOnSelect:false,customButton:rem.find(".innerDetails"),hoverClass:"active",justMenu:true,css:{width:"220px"},fixedPosition:true,rightAligned:true,trackingContext:options.trackingContext});renderMenu(bm,reminder);rem.find(".innerDetails").append(bm.menu)};var renderMenu=function(bm,reminder,isNewReminder){var menu=bm.menu;var isNew=!reminder.key();var input=menu.find(".dateInput");if(reminder.get("remindDate")){var d=Date.ccreate(reminder.get("remindDate"));input.val(d.customFormat("longDateTime"));bm.menu.find(".scheduledDate").text(d.customFormat("shortWithWeekday"));input.addClass("valid")}input.keyup(function(e){if(Streak.jwerty.is("escape",e)){bm.off();return}var val=input.val().trim();var text;input.removeClass("valid");reminder.set("remindDate",null);if(val===""){text=BB.Locale.getString("send_later_enter_date")}else{var date=Date.ccreate(val);if(!date.isValid()){date=Date.ccreate(val,BB.Locale.getCurrent());if(!date.isValid()){text=BB.Locale.getString("send_later_invalid_date")}}else{if(date.isBefore(new Date)){text=BB.Locale.getString("send_later_future_date")}else{input.addClass("valid");saveButton.el.prop("disabled",false);text=date.customFormat("shortWithWeekday");reminder.set("remindDate",date.getTime());if(e.which===13){saveButton.on()}}}}bm.menu.find(".scheduledDate").text(text)});menu.find("a").click(function(e){e.preventDefault();var d=Date.ccreate($(this).attr("title"));input.val(d.customFormat("longDateTime"));bm.menu.find(".scheduledDate").text(d.customFormat("shortWithWeekday"));reminder.set("remindDate",d.getTime());input.addClass("valid");track("suggestedTimeClick")});menu.find(".notesEnter").val(reminder.get("message"));if(reminder.get("remindFollowers")){menu.find(".includeFollowers")[0].checked=true}var id="remindFollowers"+Date.ccreate().getTime()*Math.random();menu.find(".includeFollowers").prop("id",id);menu.find(".checkbox label").prop("for",id);if(!isNewReminder){var delButton=BB.Widgets.Button.create({name:BB.Locale.getString("reminder_cancel"),isToggle:false,hasButtonToRight:true,onFunc:function(){delButton.el.trigger("delete");bm.off();reminder.del();track("deleteReminder",{messageLength:reminder.get("message").length,remindFollowers:reminder.get("remindFollowers")})},trackingContext:options.trackingContext});delButton.el.css({"float":"left"});menu.find(".buttons").append(delButton.el)}var saveButton=BB.Widgets.Button.create({name:BB.Locale.getString(isNew?"create":"save"),isToggle:false,onFunc:function(){if(reminder.get("remindDate")){reminder.set("message",menu.find(".notesEnter").val());reminder.set("remindFollowers",menu.find(".includeFollowers")[0].checked===true);bm.off();var eventName="editReminder";if(isNewReminder){eventName="newReminder"}track(eventName,{messageLength:reminder.get("message").length,remindFollowers:reminder.get("remindFollowers")});if(isNewReminder){reminder.save(function(){reminderCollection.add(reminder);renderReminders()});destroyInputs();refreshNew()}else{reminder.save()}}},color:"red",trackingContext:options.trackingContext});saveButton.el.addClass("bbLast");menu.find(".buttons").append(saveButton.el);$.tabChain([input,menu.find(".notesEnter"),menu.find(".includeFollowers"),saveButton.el]);bm.updateOptions({postOnFunc:function(){input.focus()}});inputs.push(bm);inputs.push(saveButton);return menu};var newBm=null;var newReminder=null;var refreshNew=function(){newReminder=BB.Models.Reminder.create({boxKey:box.key(),pipelineKey:pipeline.key(),message:""});createWrapperEl.empty();var menuButtonOptions={color:"blue",menuInner:ReminderList.templates.menu(),closeOnSelect:false,css:{width:"220px"},rightAligned:true,trackingContext:options.trackingContext,fixedPosition:true};if(options.useLinkButtonForNewReminder){menuButtonOptions.customButton=BB.Widgets.LinkButton.create({text:"+ "+BB.Locale.getString("new_reminder")}).getElement();menuButtonOptions.justMenu=true}else{menuButtonOptions.buttonInner=BB.Locale.getString("reminder_new")}newBm=BB.Widgets.ButtonMenu.create(menuButtonOptions);newBm.setEnabled(box.getIsEditable());renderMenu(newBm,newReminder,true);newReminder.watch("create",createReminderCallback,returnObject);if(options.useLinkButtonForNewReminder){createWrapperEl.empty();createWrapperEl.append(newBm.getButtonElement());createWrapperEl.append(newBm.menu)}else{newBm.button.el.addClass("center");createWrapperEl.append(newBm.el)}};var createReminderCallback=function(){refresh();track("newReminder",{messageLength:newReminder.get("message").length,remindFollowers:newReminder.get("remindFollowers")})};refresh();box.watch("reminderRefresh",refresh,returnObject);function destroyInputs(){if(!inputs){return}for(var ii=0;ii<inputs.length;ii++){if(inputs[ii]&&_.isFunction(inputs[ii].destroy)){inputs[ii].destroy()}}}returnObject.el=el;returnObject.getFocusElement=function(){return createWrapperEl.find(".bbButton").first()};returnObject.getNewReminderButtonElement=function(){return createWrapperEl};returnObject.refresh=refresh;returnObject.destroy=function(){destroyInputs();inputs=null;Streak.NotificationCenter.unsubscribe({observer:returnObject})};return returnObject};BB.Widgets.ReminderList=ReminderList})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ShareStreak=function(options){BB.Widgets.Widget.call(this,options);this.pipelines=options.pipelines;this.modal=$(HTML.get("shareStreakModal")({modal_description:this.options.modalDescription}));this.potentialPeople=[];this.acl=[];this.suggestionsFoundObj=Streak.Eventer.create();this.setupUI();this.prepareData();this.saved=false};ShareStreak.prototype=Object.create(BB.Widgets.Widget.prototype);_.extend(ShareStreak.prototype,{setupUI:function(){var self=this;this.personPicker=BB.Widgets.PersonPicker.create({selectFunc:function(person){var row=self.renderACLRow(person,true);row.scrollintoview({duration:0});self.personPicker.setExcluded(_.pluck(self.potentialPeople,"personObject").concat({email:BB.getUser().get("email")}))},allowName:false});this.personPicker.setExcluded([{email:BB.getUser().get("email")}]);this.personPicker.el.addClass("bb_boxflex1 bb_vbox");this.modal.find(".sharingEnter").append(this.personPicker.el);var addButton=BB.Widgets.Button.create({color:"red",name:BB.Locale.getString("add"),onFunc:function(){self.personPicker.el.find("input").trigger("bbSelect")}});this.modal.find(".sharingEnter").append(addButton.el);var defaultModalOptions={title:this.options.title,confirmText:this.options.confirmText,inner:this.modal,confirmFunc:this.saveList.bind(this),cancelFunc:this.cancelFunction.bind(this),width:"500px"};var newModalOptions=$.extend({},defaultModalOptions,this.options.modalOptions);this.shareModal=BB.Widgets.Modal.create(newModalOptions)},prepareData:function(){var self=this;BB.Contacts.getTopContacts(function(results){results=results||[];if(results.length===0){self.modal.find(".sharingList").html(BB.Locale.getString("share_no_contacts"))}else{self.modal.find(".sharingList").empty();_(results).chain().filter(function(person){return person.email!==BB.getUser().get("email")&&person.fullName!==person.email}).each(function(person){self.renderACLRow(person,false)})}self.suggestionsFoundObj.trigger("ready")},50)},renderACLRow:function(person,checked){var row=HTML.get("shareStreakItem",true);var personEl=$(BB.Contacts.suggestionTemplate({image:person.imageUrl,name:person.fullName||person.email,tag:person.fullName?person.email:"&nbsp;"})).children().unwrap();row.find(".aclRowContent").append(personEl);var checkbox=Gmail.widgets.getCheckbox("",checked);row.find(".selectionCheckbox").append(checkbox);row.find(".remove").click(function(e){row.remove();acl.removeVal(person);pp.setExcluded(acl.concat(pipeline.get("owner")));e.preventDefault()});personEl.click(function(e){checkbox.click()});if(checked){this.modal.find(".sharingList").prepend(row)}else{this.modal.find(".sharingList").append(row)}checkbox.bind("change",function(){row.toggleClass("bbChecked",checkbox.isChecked())});row.toggleClass("bbChecked",checkbox.isChecked());this.potentialPeople.push({row:row,personObject:person,checkbox:checkbox});return row},saveList:function(){var self=this;for(var i=0;i<this.potentialPeople.length;i++){if(this.potentialPeople[i].checkbox.isChecked()){this.acl.push(this.potentialPeople[i].personObject)}}if(this.options.onPresave){if(this.options.onPresave(this.acl)){return}}if(this.acl.length===0){return}if(this.options.pipelines&&this.options.pipelines.length>0){this.executeSaveList()}},setPipelines:function(pipelines){this.options.pipelines=pipelines;this.executeSaveList()},executeSaveList:function(){var self=this;var after=_.onceAfter(this.options.pipelines.length,function(){self.options.onSave()});_.each(this.options.pipelines,function(pipeline){pipeline.set("aclEntries",self.acl);pipeline.save(after)})},cancelFunction:function(){if(this.options.cancelFunction){this.options.cancelFunction()}},show:function(options){var self=this;if(options){this.setOptions(options)}self.shareModal.show();this.suggestionsFoundObj.ready(function(){var ok=self.shareModal.getOkButton().el;self.personPicker.setTab(ok,ok);ok.easyTab({next:self.personPicker.el,prev:self.personPicker.el})})},close:function(){this.shareModal.close()},defaults:{pipelines:[],onPresave:$.noop,onSave:$.noop,modalOptions:{}}});ShareStreak.create=function(options){return new ShareStreak(options)};BB.Widgets.ShareStreak=ShareStreak})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var trackingContext;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};var SearchBox={defaults:{searchController:null},create:function(o){this._init();var options={};$.extend(options,this.defaults,o);return new this.impl(options)},_init:function(){if(!this.templates){this.templates={};this.templates.searchDiv=HTML.get("searchBox")}}};SearchBox.impl=function(o){var searchController=o.searchController;var el=$(document.createElement("div"));var currentResultIndex=0;el[0].innerHTML=SearchBox.templates.searchDiv();var self=this;self.o=o;var searchInput=el.find("input");el.find(".bbPrevButton").click(function(e){searchController.selectPrevious();searchInput.focus()});el.find(".bbNextButton").click(function(e){searchController.selectNext();searchInput.focus()});el.find(".bbCloseButton").click(function(e){el.removeClass("showDown");el.addClass("hideUp");searchController.hideSearch()});var inputContainer=el.find(".searchInputContainer");searchInput.focus(function(e){$(inputContainer).addClass("searchInputSelected")});searchInput.blur(function(e){$(inputContainer).removeClass("searchInputSelected")});BB.Keyboard.bindChordToEl({el:searchInput,chord:"enter",noDefault:true,cb:function(e){searchController.selectNext();searchInput.focus()}});BB.Keyboard.bindChordToEl({el:searchInput,chord:"shift+enter",noDefault:true,cb:function(e){searchController.selectPrevious();searchInput.focus()}});BB.Keyboard.bindChordToEl({el:searchInput,chord:"escape",noDefault:true,cb:function(e){el.removeClass("showDown");el.addClass("hideUp");searchController.hideSearch()}});searchInput.delayedSave({delay:300,dontPropagate:true,saveFunction:function(e){var searchVal=searchInput.val();searchController.searchTriggered(searchVal);searchInput.focus()}});function updateResultState(){var results=searchController.getResultState();el.find(".searchResultsPosition").html(results.selectedIndex);el.find(".searchResultsCount").html(results.total)}function hideSearchBar(){el.removeClass("showDown");el.addClass("hideUp");el.remove()}return{el:el,startUsing:function(){var searchVal=searchInput.val();searchController.searchTriggered(searchVal);searchInput.focus()},findNext:function(){searchController.selectNext();searchInput.focus()},searchResultsChanged:function(){updateResultState()},destroy:function(){hideSearchBar()}}};BB.Widgets.SearchBox=SearchBox})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TabFocusController=function(){Streak.ViewControllerBase.call(this);this._elements=[]};TabFocusController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(TabFocusController.prototype,{addElement:function(element){this._elements.push(element);this._resetTabs()},addElements:function(elementArray){_.mutate("union",this._elements,elementArray);this._resetTabs()},removeElement:function(element){this._elements.removeVal(element);this._resetTabs()},addView:function(view){this._elements.push(view.getElement());this._resetTabs()},removeView:function(view){this._elements.removeVal(view.getElement());this._resetTabs()},destroy:function(){this._unbind();this._elements.length=0},_resetTabs:function(){this._unbind();$.tabChain(this._elements,50,"tabFocusController")},_unbind:function(){for(var ii=0;ii<this._elements.length;ii++){if(this._elements[ii]){this._elements[ii].off(".tabFocusController")}}}});BB.Widgets.TabFocusController=TabFocusController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ThreadTask={templates:{},defaults:{gmailThread:null},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};ThreadTask.impl=function(o){var retObj={},options=o,gmailThread=o.gmailThread,el=$(document.createElement("span"));var taskLabel=null;var taskCheckbox=null;var makeTaskLink=null;function updateDisplay(force){switch(gmailThread.get("taskStatus")){case"NOT_A_TASK":case"":renderMakeTask();break;case"NOT_DONE_TASK":renderAsTask(false);break;case"DONE_TASK":renderAsTask(true);break}return null}function renderMakeTask(){if(!makeTaskLink){makeTaskLink=$(document.createElement("span"));makeTaskLink[0].innerHTML='[<a href="#">'+BB.Locale.getString("make_task")+"</a>]";makeTaskLink.find("a").captureClick(function(e){gmailThread.set("taskStatus","NOT_DONE_TASK");gmailThread.save();e.preventDefault();track("markAsTask")})}if(taskLabel){taskLabel.detach()}if(taskCheckbox){taskCheckbox.detach()
}el.append(makeTaskLink)}function renderAsTask(isDone){if(taskLabel&&taskCheckbox){taskCheckbox.setChecked(gmailThread.get("taskStatus")==="DONE_TASK")}else{taskLabel=Gmail.widgets.getLabelActionTag({backgroundColor:"rgb(254, 173, 71)",textColor:"rgb(0, 0, 0)",labelText:BB.Locale.getString("task"),labelHelpText:BB.Locale.getString("task_help"),xHelpText:BB.Locale.getString("untask_help"),xCallback:function(){gmailThread.set("taskStatus","NOT_A_TASK");gmailThread.save();track("markNotTask")}});taskCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("task_done"),isDone);taskCheckbox.bind("change",function(e){gmailThread.set("taskStatus",taskCheckbox.isChecked()?"DONE_TASK":"NOT_DONE_TASK");gmailThread.save();track("threadTaskStatusChanged",{isChecked:taskCheckbox.isChecked()})})}if(makeTaskLink){makeTaskLink.detach()}if(taskLabel.parents().length===0||taskLabel.parent()[0]!==el[0]){el.append(taskLabel)}if(taskCheckbox.parents().length===0||taskCheckbox.parent()[0]!==el[0]){el.append(taskCheckbox)}taskLabel.reset()}el.addClass("threadTask");el.click(function(e){e.preventDefault();e.stopPropagation()});el.data("threadTask",retObj);gmailThread.watch("set",updateDisplay,retObj,"taskStatus");updateDisplay(true);retObj.el=el;retObj.destroy=function(){el.remove();Streak.NotificationCenter.unsubscribe({observer:retObj})};retObj.getElement=function(){return el};return retObj};BB.Widgets.ThreadTask=ThreadTask})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeMasterControllerBase=function(){this._active=true;this._instances=[];Gmail.GmailComposeManager.registerModule(this)};_.extend(ComposeMasterControllerBase.prototype,{getViewController:function(){var instance=this._createNewInstanceType();this._instances.push(instance);instance.addDelegate(this);return instance},destroy:function(instance){this._instances.removeVal(instance)}});BB.Modules.ComposeMasterControllerBase=ComposeMasterControllerBase})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeViewControllerBase=Streak.Class.subclass({superclass:Streak.UI.ViewController,_memberVariables:[{name:"_composeWindowViewController",destroy:false}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);return this},allModificationsInitialized:function(){},shouldProcessModification:function(){return true},aboutToProcessModification:function(){},getModificationType:function(){},getModificationArea:function(){},getModificationPlacement:function(){},getModificationPriority:function(){},getModificationElement:function(){},shouldModifyTabOrder:function(){return true},initialize:function(composeWindowViewController){throw new Error("must override")},justAdded:function(){},getListenerType:function(){},getCharacterSequenceListener:function(){},draftSaved:function(){},aboutToSend:function(){},emailSent:function(){},sentEmailThreadMetaDataFound:function(threadMetaData){},discarded:function(){}});BB.Modules.ComposeViewControllerBase=ComposeViewControllerBase})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxAndGmailThreadCreator=Streak.Class.subclass({className:"BoxAndGmailThreadCreator",superclass:Streak.Operations.OperationStatusChangeHandler,_memberVariables:[],_initialize:function(){Streak.Operations.OperationStatusChangeHandler.prototype._initialize.call(this)},createBoxAndGmailThreads:function(boxName,pipelineKey,threadMetaDataList){var box=BB.Models.Box.create({name:boxName,pipelineKey:pipelineKey,stageKey:BB.Data.getPipeline(pipelineKey).getStages()[0].key()});BB.Data.getPipelineBoxes(pipelineKey).add(box);var self=this;box.save(function(){if(threadMetaDataList.length===1){self.createGmailThread(box.key(),threadMetaDataList[0]);NotificationCenter.postNotification({eventName:"boxAndGmailThreadCreated",sender:self,hexGmailThreadId:threadMetaDataList[0].hexGmailThreadId})}else{self.createGmailThreads(box.key(),threadMetaDataList)}});return box},createGmailThreads:function(boxKey,threadMetaDataList){if(threadMetaDataList.length===1){this.createGmailThread(boxKey,threadMetaDataList[0]);return}var multipleGmailThreadCreationOperation=new BB.Modules.BoxesMenu.MultipleGmailThreadCreationOperation({boxKey:boxKey,threadMetaDataList:threadMetaDataList});var operationStatusChangeHandler=this;return Streak.Operations.OperationQueue.Singleton.addOperation(multipleGmailThreadCreationOperation,operationStatusChangeHandler)},_operationSucceeded:function(operation){Streak.Operations.CollectionOperationManager.Singleton.updateCollectionWithResponse(BB.Data.getAllGmailThreads(),operation.getResponse(),true)},_operationFailed:function(operation){},createGmailThread:function(boxKey,threadMetaData){var gmailThread=BB.Models.GmailThread.create({boxKey:boxKey,hexGmailThreadId:threadMetaData.hexGmailThreadId});BB.Data.getAllGmailThreads().add(gmailThread);gmailThread.save()},deleteGmailThreads:function(hexGmailThreadIdList){for(var ii=0;ii<hexGmailThreadIdList.length;ii++){var gmailThread=BB.Services.Threads.ThreadStorer.getGmailThread(hexGmailThreadIdList[ii]);if(!gmailThread){return}gmailThread.del()}},getNumberOfThreadsBeingSaved:function(hexGmailThreadIdList){var tags=[];for(var ii=0;ii<hexGmailThreadIdList.length;ii++){tags.push("gmailThread_create_hexGmailThreadId_"+hexGmailThreadIdList[ii]);tags.push("gmailThread_delete_hexGmailThreadId_"+hexGmailThreadIdList[ii])}var operations=Streak.Operations.OperationQueue.Singleton.queryOperationQueue({notStates:[Streak.Operations.Operation.STATES.SUCCEEDED,Streak.Operations.Operation.STATES.FAILED],containsTags:tags});return operations.length}});Library.set("BentoBox.Modules.BoxesMenu.BoxAndGmailThreadCreator",new BoxAndGmailThreadCreator)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxesMenuViewController=function(){Streak.ViewControllerBase.call(this);this._view=new BB.Modules.BoxesMenu.BoxesMenuView;this._boxesMenuModel=new BB.Modules.BoxesMenu.BoxesMenuModel;this._boxDetailsVC=new BB.Widgets.BoxesDetailsVC;this._listViewVC=new BB.Widgets.ListView.ListViewViewController;this._searchbox=new BB.Widgets.SearchSimpleVC;this._searchbox.setSupressTab(true);this._keyboardCaptureWidget=new BB.Widgets.KeyboardCaptureWidget;this._stateViewController=new BB.Modules.BoxesMenu.BoxesMenuStateController(this._boxesMenuModel);this._doneCallback=null;this._setupDelegates();this._setupView();this._setupCreatePipelineButton()};BoxesMenuViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(BoxesMenuViewController.prototype,{_setupDelegates:function(){this._boxesMenuModel.addDelegate(this);this._boxesMenuModel.addDelegate(this._stateViewController);this._listViewVC.setDataSource(this._boxesMenuModel);this._listViewVC.addDelegate(this);this._listViewVC.addDelegate(this._stateViewController);this._searchbox.addDelegate(this._stateViewController);this._searchbox.addDelegate(this._listViewVC);this._keyboardCaptureWidget.addDelegate(this._listViewVC)},_setupView:function(){this._searchbox.setPlaceholder(BB.Locale.getString("search_all_boxes"));this._view.setSearchArea(this._searchbox.getView().getEl());this._view.setListSection(this._listViewVC.getView().getEl());this._view.setRightPane(this._boxDetailsVC.getView().getEl());this._view.setKeyboardCapture(this._keyboardCaptureWidget.getElement())},getElement:function(){return this._view.getEl()},use:function(options){this._view.hideRightPane();this._boxesMenuModel.reset();this._searchbox.reset();this._doneCallback=options.doneCallback;this._boxesMenuModel.setDontAssociate(options.dontAssociate);var threadMetaDataList=options.threadMetaDataList;if(!threadMetaDataList){var hexGmailThreadIdList=options.hexGmailThreadIdList;if(!hexGmailThreadIdList){hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor)}threadMetaDataList=BB.Services.Threads.ThreadStorer.getThreadMetaDataList(hexGmailThreadIdList)}this._stateViewController.setThreads(threadMetaDataList);if(options.box){this._stateViewController.setBox(options.box)}this._boxesMenuModel.setContext(options.context)},focus:function(){this._searchbox.focus()},stateChanged:function(){var menuState=this._boxesMenuModel.getState();this._view.hideCreatePipeline();this._view.showListSection();switch(menuState){case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.SEARCH_STATE:this._view.showSearchArea();this._searchbox.focus();break;case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.REMOVE_STATE:case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.CHOOSE_PIPELINE_STATE:case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.THREADS_BEING_SAVED_STATE:case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.NO_PREVIEWED_ROW_STATE:this._view.hideSearchArea();this._keyboardCaptureWidget.focus();break;case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.NO_PIPELINES_STATE:this._view.hideSearchArea();this._view.hideListSection();this._view.showCreatePipeline();break;case BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.DONE_STATE:if(this._doneCallback){this._doneCallback(this._boxesMenuModel.getBox())}break}},rowFocused:function(rowInfo){if(!rowInfo){this._view.hideRightPane();return}if(!rowInfo.data||!rowInfo.data.box){this._view.hideRightPane();return}this._boxDetailsVC.setModel(rowInfo.data.box);this._view.showRightPane()},setThreads:function(threads){this._stateViewController.setThreads(threads)},_setupCreatePipelineButton:function(){var self=this;var newPipelineModal=BB.Widgets.NewPipelineModal.create({title:BB.Locale.getString("left_link_make_new"),pipelineSavedCallback:function(pipeline){BB.UI.setURL(pipeline.link())}});this._createPipelineButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:BB.Locale.getString("create_new_pipeline"),onFunction:function(){newPipelineModal.show();self._boxesMenuModel.setState(BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.DONE_STATE)}});this._view.setCreatePipelineButton(this._createPipelineButton)},destroy:function(){this._view.destroy();this._boxDetailsVC.destroy();this._listViewVC.destroy();this._searchbox.destroy();this._stateViewController.destroy()}});Streak.DependencyManager.addFunction({functionKey:"boxesMenuViewControllerInitialized",functionReference:function(){Streak.Library.set("BentoBox.Modules.BoxesMenu.BoxesMenuViewController",new BoxesMenuViewController)},dependentFunctionKeys:["htmlLoaded","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesMenuModel=function(){BB.Widgets.ListView.ListViewBaseModel.call(this);this._state="default";this._query=null;this._threads=null;this._boxName="";this._box=null;this._storedSections=null;this._dontAssociate=null;this._context=null};BoxesMenuModel.prototype=Object.create(BB.Widgets.ListView.ListViewBaseModel.prototype);_.extend(BoxesMenuModel.prototype,{reset:function(){this.removeAllSections();this.setThreads(null);this.setBoxName(null);this.setBox(null);this.setQuery(null)},setThreads:function(threads){this._threads=threads},getThreads:function(){return this._threads},setBoxName:function(boxName){this._boxName=boxName},getBoxName:function(){return this._boxName},setBox:function(box){this._box=box},getBox:function(){return this._box},setState:function(state){this._state=state;this._callDelegateFunction("stateChanged")},getState:function(){return this._state},setQuery:function(query){this._query=query},getQuery:function(){return this._query},setDontAssociate:function(dontAssociate){this._dontAssociate=dontAssociate},getDontAssociate:function(){return this._dontAssociate},setContext:function(context){this._context=context},getContext:function(){return this._context}});_.extend(BoxesMenuModel.prototype,{archiveSections:function(){this._storedSections=this._sections},restoreSections:function(){if(_.isReal(this._storedSections)){this.removeAllSections();this._sections=this._storedSections;this._callDelegateFunction("dataChanged")}},removeAllSections:function(){this._sections.length=0;this._callDelegateFunction("dataChanged")},addSection:function(section){this._sections.push(section);this._callDelegateFunction("dataChanged")},numberOfSections:function(){return this._sections.length},numberOfRowsForSection:function(ii){return this._sections[ii].rows.length},infoForRow:function(section,row){return this._sections[section].rows[row]},sectionTitle:function(sectionIndex){return this._sections[sectionIndex].name},sectionTitleClass:function(sectionIndex){var classString="streak__listViewHeader2";if(this._sections[sectionIndex].titleClass){classString+=" "+this._sections[sectionIndex].titleClass}return classString},sectionIconClass:function(sectionIndex){return this._sections[sectionIndex].sectionIconClass}});BB.Modules.BoxesMenu.BoxesMenuModel=BoxesMenuModel})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesMenuView=function(options){this._el=$(HTML.get("bm_main_container")());this._listContainer=this._el.find(".streak_bm_container");this._searchAreaEl=this._el.find(".streak__bm_searcharea");this._rightPane=this._el.find(".streak__bm_right_pane")};_.extend(BoxesMenuView.prototype,{hideSearchArea:function(){this._searchAreaEl.css({opacity:0,width:0,height:0})},showSearchArea:function(){this._searchAreaEl.css({opacity:1,width:"",height:""})},setKeyboardCapture:function(element){this._el.append(element)},getEl:function(){return this._el},getElement:function(){return this._el},setSearchArea:function(searchArea){this._el.find(".streak__bm_searcharea").empty();this._el.find(".streak__bm_searcharea").append(searchArea)},setListSection:function(section){this._el.find(".streak__bm_top_section").empty();this._el.find(".streak__bm_top_section").append(section)},setRightPane:function(rightPane){this._rightPane.empty();this._rightPane.append(rightPane)},showRightPane:function(){this._rightPane.show();this._listContainer.addClass("streak_bm_container_withRightPane")},hideRightPane:function(){this._listContainer.removeClass("streak_bm_container_withRightPane");this._rightPane.hide()},hideCreatePipeline:function(){this._el.find(".streak__bm_noPipelines").hide()},showCreatePipeline:function(){this._el.find(".streak__bm_noPipelines").show()},setCreatePipelineButton:function(button){this._el.find(".streak__bm_noPipelines").append(button.getElement())},hideListSection:function(){this._el.find(".streak__bm_top_section").hide()},showListSection:function(){this._el.find(".streak__bm_top_section").show()}});BB.Modules.BoxesMenu.BoxesMenuView=BoxesMenuView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesMenuStateController=function(boxesMenuModel){Streak.ViewControllerBase.call(this);this._boxesMenuModel=boxesMenuModel;this._threadsBeingSavedStateController=new BB.Modules.BoxesMenu.ThreadsBeingSavedStateController(boxesMenuModel);this._removeStateController=new BB.Modules.BoxesMenu.RemoveStateController(boxesMenuModel);this._emptyQueryStateController=new BB.Modules.BoxesMenu.SearchEmptyStateContrller(this._boxesMenuModel);this._searchQueryStateController=new BB.Modules.BoxesMenu.SearchQueryStateController(this._boxesMenuModel);this._pipelineStateController=new BB.Modules.BoxesMenu.PipelineStateController(boxesMenuModel);this._boxAddRemoveController=new BB.Modules.BoxesMenu.BoxesMenuAddRemoveController(boxesMenuModel);this._noPreviewedRowStateController=new BB.Modules.BoxesMenu.NoPreviewedRowStateController(boxesMenuModel)};BoxesMenuStateController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(BoxesMenuStateController.prototype,{SEARCH_STATE:"SEARCH",REMOVE_STATE:"REMOVE",CHOOSE_PIPELINE_STATE:"CHOOSE_PIPELINE_STATE",DONE_STATE:"DONE",THREADS_BEING_SAVED_STATE:"THREADS_BEING_SAVED_STATE",NO_PREVIEWED_ROW_STATE:"NO_PREVIEWED_ROW_STATE",NO_PIPELINES_STATE:"NO_PIPELINES_STATE",setThreads:function(threadMetaDataList){this._boxesMenuModel.setThreads(threadMetaDataList);this._determineStateFromThreads()},setBox:function(box){this._boxesMenuModel.setBox(box);this._boxesMenuModel.setState(this.REMOVE_STATE)},rowPressed:function(rowInfo){if(!rowInfo.type){return}switch(rowInfo.type){case"go_back_from_pipeline":this._goBackFromPipeline();BB.Tracker.track("boxes menu go back from pipeline");break;case"existing_box":this._boxAddRemoveController.associateBoxWithThreads(rowInfo.data.box);this._boxesMenuModel.setState(this.DONE_STATE);BB.Tracker.track("boxes menu choose existing box");break;case"new_box_name":this._newBoxNameChosen(rowInfo.data.boxName);BB.Tracker.track("boxes menu choose new box name");break;case"pipeline":this._boxAddRemoveController.createNewBoxInPipelineAndAssociateThreads(rowInfo.data.pipeline);this._boxesMenuModel.setState(this.DONE_STATE);BB.Tracker.track("boxes menu choose pipeline");break;case"remove_box":this._boxAddRemoveController.removeThreadsFromBox();this._boxesMenuModel.setState(this.DONE_STATE);BB.Tracker.track("boxes menu remove box");break}},_determineStateFromThreads:function(){if(BB.Data.getAllPipelines().length===0){this._boxesMenuModel.setState(this.NO_PIPELINES_STATE);return}var threadMetaDataList=this._boxesMenuModel.getThreads();if(!threadMetaDataList||threadMetaDataList.length===0){this._boxesMenuModel.setState(this.NO_PREVIEWED_ROW_STATE);return}var hexGmailThreadIdList=_(threadMetaDataList).chain().compact().pluck("hexGmailThreadId").value();var areThreadsBeingSaved=BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.getNumberOfThreadsBeingSaved(hexGmailThreadIdList)>0;if(areThreadsBeingSaved){this._boxesMenuModel.setState(this.THREADS_BEING_SAVED_STATE);return}var boxKeys=BB.Services.Threads.ThreadStorer.getBoxKeyList(hexGmailThreadIdList);for(var ii=0;ii<boxKeys.length;ii++){if(boxKeys[ii]&&BB.Data.getBox(boxKeys[ii])){this._boxesMenuModel.setState(this.REMOVE_STATE);return}}this._boxesMenuModel.setState(this.SEARCH_STATE)},stateChanged:function(){var state=this._boxesMenuModel.getState();this._boxesMenuModel.removeAllSections();switch(state){case this.REMOVE_STATE:this._removeStateController.use();break;case this.CHOOSE_PIPELINE_STATE:this._pipelineStateController.use();break;case this.SEARCH_STATE:this.queryChange("");break;case this.THREADS_BEING_SAVED_STATE:this._threadsBeingSavedStateController.use();break;case this.NO_PREVIEWED_ROW_STATE:this._noPreviewedRowStateController.use();break}},queryChange:function(query){this._boxesMenuModel.removeAllSections();this._boxesMenuModel.setQuery(query);if(query===""){this._emptyQueryStateController.use()}else{this._searchQueryStateController.use()}},cursorLeft:function(rowInfo){if(this._boxesMenuModel.getState()===this.CHOOSE_PIPELINE_STATE){this._goBackFromPipeline()}},cursorRight:function(rowInfo,isCursorAtEnd){if(isCursorAtEnd&&rowInfo&&rowInfo.hasRightArrow){this.rowPressed(rowInfo)}},_goBackFromPipeline:function(){this._boxesMenuModel.restoreSections();this._boxesMenuModel.setState(this.SEARCH_STATE)},_newBoxNameChosen:function(boxName){this._boxesMenuModel.setBoxName(boxName);if(BB.Data.getAllPipelines().length===1){this._boxAddRemoveController.createNewBoxInPipelineAndAssociateThreads(BB.Data.getAllPipelines()[0]);return}this._boxesMenuModel.setState(this.CHOOSE_PIPELINE_STATE)}});BB.Modules.BoxesMenu.BoxesMenuStateController=BoxesMenuStateController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var BoxesMenuAddRemoveController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(BoxesMenuAddRemoveController.prototype,{associateBoxWithThreads:function(box){var threads=this._boxesMenuModel.getThreads();if(!this._boxesMenuModel.getDontAssociate()){BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.createGmailThreads(box.key(),threads)}this._updateBoxesMenuModelAndTrack(box,threads)},createNewBoxInPipelineAndAssociateThreads:function(pipeline){var self=this;var boxName=this._boxesMenuModel.getBoxName();var threads=this._boxesMenuModel.getThreads();var box;if(this._boxesMenuModel.getDontAssociate()){box=BB.Models.Box.create({name:boxName,pipelineKey:pipeline.key(),stageKey:pipeline.getStages()[0].key()});BB.Data.getPipelineBoxes(pipeline.key()).add(box)}else{BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.createBoxAndGmailThreads(boxName,pipeline.key(),threads)}this._updateBoxesMenuModelAndTrack(box,threads)},removeThreadsFromBox:function(){var threads=this._boxesMenuModel.getThreads();if(!this._boxesMenuModel.getDontAssociate()){BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.deleteGmailThreads(_.pluck(threads,"hexGmailThreadId"))}this._boxesMenuModel.setBox(null);this._boxesMenuModel.setState(BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.DONE_STATE);BB.Tracker.track("removeThreadFromBox",{threadCount:threads.length,context:this._boxesMenuModel.getContext()})},_updateBoxesMenuModelAndTrack:function(box,threads){this._boxesMenuModel.setBox(box);this._boxesMenuModel.setState(BB.Modules.BoxesMenu.BoxesMenuStateController.prototype.DONE_STATE);BB.Tracker.track("addThreadsToBox",{threadCount:threads.length,context:this._boxesMenuModel.getContext()})}});BB.Modules.BoxesMenu.BoxesMenuAddRemoveController=BoxesMenuAddRemoveController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MultipleGmailThreadCreationOperation=Streak.Class.subclass({className:"MultipleGmailThreadCreationOperation",superclass:Streak.Operations.AjaxRequestOperation,_memberVariables:[{name:"_boxKey",destroy:true},{name:"_threadMetaDataList",destroy:false}],_initialize:function(options){Streak.Operations.AjaxRequestOperation.prototype._initialize.call(this,options);this._boxKey=options.boxKey;this._threadMetaDataList=options.threadMetaDataList;this._tags=this._getTags();this._dependentOnTags=this._tags},_getTags:function(){var tags=[];for(var ii=0;ii<this._threadMetaDataList.length;ii++){var hexGmailThreadId=this._threadMetaDataList[ii].hexGmailThreadId;tags=tags.concat(["gmailThread_create_boxKey_"+this._boxKey,"gmailThreadCollection_boxKey_"+this._boxKey,"gmailThread_create_hexGmailThreadId_"+hexGmailThreadId,"gmailThread_hexGmailThreadId_"+hexGmailThreadId])}return tags},getMethod:function(){return"PUT"},getParams:function(){return{url:"boxes/"+this._boxKey+"/threads",json:JSON.stringify(this._threadMetaDataList)}}});Library.set("BentoBox.Modules.BoxesMenu.MultipleGmailThreadCreationOperation",MultipleGmailThreadCreationOperation)})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var PipelineStateController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(PipelineStateController.prototype,{use:function(){this._loadGoBackButton();this._loadPipelines()},_loadGoBackButton:function(){this._boxesMenuModel.addSection({rows:[{text:Locale.getString("go_back_from_pipeline"),type:"go_back_from_pipeline",hasLeftArrow:true}]})},_loadPipelines:function(){var self=this;var rows=[];_.each(BB.UI.getSortedVisiblePipelines(),function(pipeline){rows.push({text:pipeline.displayName(),type:"pipeline",data:{pipeline:pipeline}})});this._boxesMenuModel.addSection({name:Locale.getString("select_a_pipeline_for_a_new_box"),rows:rows})}});BB.Modules.BoxesMenu.PipelineStateController=PipelineStateController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var RemoveStateController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(RemoveStateController.prototype,{use:function(){var boxes=this._extractBoxesFromThreads();if(boxes.length===0){return}if(boxes.length===1){this._removeSingleBox(boxes[0]);return}this._removeMultipleBoxes()},_extractBoxesFromThreads:function(){var box=this._boxesMenuModel.getBox();if(box){return[box]}return _(this._boxesMenuModel.getThreads()).chain().map(function(thread){return BB.Services.Threads.ThreadStorer.getBoxKey(thread.hexGmailThreadId)}).filter(function(boxKey){return!!boxKey&&!!BB.Data.getBox(boxKey)}).map(function(boxKey){return BB.Data.getBox(boxKey)}).compact().value()},_removeSingleBox:function(box){this._boxesMenuModel.addSection({rows:[{html:Locale.getString("remove_box",{box:"<strong>"+box.displayNameHTML()+"</strong>"}),type:"remove_box"}]})},_removeMultipleBoxes:function(){this._boxesMenuModel.addSection({rows:[{text:Locale.getString("remove_all_boxes"),type:"remove_box"}]})}});BB.Modules.BoxesMenu.RemoveStateController=RemoveStateController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var SearchEmptyStateContrller=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(SearchEmptyStateContrller.prototype,{LIMIT_ENTRIES:3,use:function(){this._loadExisting();this._loadSuggestedNames()},_loadExisting:function(){var rows=this._getExistingBoxesAsRows();if(_.isReal(rows)&&rows.length>0){this._boxesMenuModel.addSection({name:Locale.getString("suggested_existing_boxes"),sectionIconClass:"streak__boxAddIcon",rows:rows})}},_getExistingBoxesAsRows:function(){var boxSuggestions=BB.Modules.BoxSuggestionsController.getBoxSuggestions(this._boxesMenuModel.getThreads());boxSuggestions=boxSuggestions.slice(0,self.LIMIT_ENTRIES);var boxSuggestionsAsRows=_.map(boxSuggestions,function(boxSourceObject){return{html:BB.UI.getBoxListDisplayHTML(boxSourceObject.box),displayClass:"streak__boxListRow",type:"existing_box",data:{box:boxSourceObject.box}}});return boxSuggestionsAsRows},_loadSuggestedNames:function(){var names=BB.Services.SuggestedBoxNames.getSuggestions(this._boxesMenuModel.getThreads());names=names.slice(0,self.LIMIT_ENTRIES);if(!names||names.length===0){return}var showRightArrow=BB.Data.getAllPipelines().length>1;var namesAsRows=_.map(names,function(name){return{text:name,type:"new_box_name",data:{boxName:name},hasRightArrow:showRightArrow}});this._boxesMenuModel.addSection({name:Locale.getString("suggested_names_for_box"),sectionIconClass:"streak__boxCreateIcon",rows:namesAsRows})}});BB.Modules.BoxesMenu.SearchEmptyStateContrller=SearchEmptyStateContrller})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var SearchQueryStateController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(SearchQueryStateController.prototype,{LIMIT_ENTRIES:3,use:function(){this._loadExistingSection();this._loadQuerySection()},_loadQuerySection:function(){var showRightArrow=BB.Data.getAllPipelines().length>1;this._boxesMenuModel.addSection({name:Locale.getString("create_new_box_named"),sectionIconClass:"streak__boxCreateIcon",rows:[{text:this._boxesMenuModel.getQuery(),type:"new_box_name",data:{boxName:this._boxesMenuModel.getQuery()},hasRightArrow:showRightArrow}]})},_loadExistingSection:function(){var existingBoxes=BB.Services.BoxSearcher.searchNameByQuery(this._boxesMenuModel.getQuery());if(!existingBoxes||existingBoxes.length===0){return}var boxesAsRows=_.map(existingBoxes,function(box){return{html:BB.UI.getBoxListDisplayHTML(box),displayClass:"streak__boxListRow",type:"existing_box",data:{box:box}}});this._boxesMenuModel.addSection({name:Locale.getString("or_add_it_to_an_existing_box"),sectionIconClass:"streak__boxAddIcon",rows:boxesAsRows})}});BB.Modules.BoxesMenu.SearchQueryStateController=SearchQueryStateController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var ThreadsBeingSavedStateController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(ThreadsBeingSavedStateController.prototype,{use:function(){var threadMetaDataList=this._boxesMenuModel.getThreads();var hexGmailThreadIdList=_.pluck(threadMetaDataList,"hexGmailThreadId");var numberOfThreadsBeingSaved=BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.getNumberOfThreadsBeingSaved(hexGmailThreadIdList);this._boxesMenuModel.addSection({name:numberOfThreadsBeingSaved+" out of "+threadMetaDataList.length+" threads are currently being synced please wait for them to finish",titleClass:"streak__boxesMenu_syncingMessage",rows:[]})}});BB.Modules.BoxesMenu.ThreadsBeingSavedStateController=ThreadsBeingSavedStateController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,_=Streak._,Date=Streak.Date;var NoPreviewedRowStateController=function(boxesMenuModel){this._boxesMenuModel=boxesMenuModel};_.extend(NoPreviewedRowStateController.prototype,{use:function(){this._boxesMenuModel.addSection({name:"No row is currently selected or previewed in inbox.",titleClass:"streak__boxesMenu_syncingMessage",rows:[]})}});BB.Modules.BoxesMenu.NoPreviewedRowStateController=NoPreviewedRowStateController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var self=ListRowBoxesButton={_isActive:false,_isTornDown:false,_buttons:[],init:function(callback){if(BB.Data.streakSettings.settingIsEnabled("streak_it_title")){Gmail.InboxManipulator.addDataSource(self)}if(callback){callback()}},teardown:function(){this._isTornDown=true},reup:function(){this._isTornDown=false},setIsActive:function(callback){this._isActive=true;Gmail.InboxManipulator.refreshAll();if(callback){callback()}},getGlobalManipulation:function(){if(Gmail.isDrafts()){return}return{type:"CSS_CHANGE",columnName:"STAR",cssRule:"width: 52px"}},getTableManipulation:function(){if(Gmail.isDrafts()){return}return{type:"COLUMN_WIDTH",columnName:"STAR",width:52}},getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(Gmail.isDrafts()){return}if(this._isTornDown){return}if(Gmail.isVerticalSplitPreviewPane()){return}if(!hexGmailThreadId){return}var manipulation=new ListRowBoxesButton.ListRowBoxesButtonInboxRowManipulation(hexGmailThreadId,threadDOMRow);if(this._isActive){manipulation.setActive()}return manipulation}};function track(event,props){BB.Tracker.trackStreakActive(props,{widgetContext:"addToBoxesButton",eventName:event})}Streak.DependencyManager.addFunction({functionKey:"listRowBoxesButtonInitialized",functionToCall:ListRowBoxesButton.init,functionContext:ListRowBoxesButton,dependentFunctionKeys:["inboxManipulatorInitialized","data.streakSettings.initialized","htmlLoaded","boxesMenuViewControllerInitialized"]});Streak.DependencyManager.addFunction({functionKey:"listRowBoxesButton.setIsActive",functionToCall:ListRowBoxesButton.setIsActive,functionContext:ListRowBoxesButton,dependentFunctionKeys:["data.pipelines.initialized","data.boxes.initialized"]});BB.Modules.ListRowBoxesButton=ListRowBoxesButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;
var ListRowBoxesButtonInboxRowManipulation=function(hexGmailThreadId,threadDOMRow){Gmail.InboxManipulator.InboxRowManipulationBase.call(this);this._hexGmailThreadId=hexGmailThreadId;this._threadDOMRow=threadDOMRow;this._element=null;this._menuButton=null;this._htmlID=null;this._menuOpen=false;this._setupUIElements()};ListRowBoxesButtonInboxRowManipulation.prototype=Object.create(Gmail.InboxManipulator.InboxRowManipulationBase.prototype);_.extend(ListRowBoxesButtonInboxRowManipulation.prototype,{_setupUIElements:function(){this._element=$(document.createElement("div"));this._element[0].setAttribute("class","addBoxesButtonIndicator");this._setupMenuButton();this.update();this._htmlID=this._threadDOMRow.rowNode.attr("id")},_setupMenuButton:function(){var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"Icon",iconClass:"__streak_It_Indicator",menu:BB.Modules.BoxesMenu.BoxesMenuViewController,preOnFunction:function(){self._threadDOMRow.rowNode.attr("id","");self._element.addClass("__streak_It_Indicator_hover");self._menuOpen=true},postOnFunction:function(){self._element.css("z-index",2);BB.Modules.BoxesMenu.BoxesMenuViewController.use({hexGmailThreadIdList:[self._hexGmailThreadId],doneCallback:function(){self._threadDOMRow.rowNode.attr("id",self._htmlID);self._menuButton.off()},context:"listRowBoxesButton"})},postOffFunction:function(){self._element.css("z-index","");self._menuOpen=false;self._threadDOMRow.rowNode.attr("id",self._htmlID);self._element.removeClass("__streak_It_Indicator_hover")}});this._element.append(this._menuButton.getElement())},update:function(){var boxKey=BB.Services.Threads.ThreadStorer.getBoxKey(this._hexGmailThreadId);if(!boxKey){this._menuButton.removeClass("__streak_selected_streakit");return}var box=BB.Data.getBox(boxKey);if(!box){this._menuButton.removeClass("__streak_selected_streakit");return}this._menuButton.addClass("__streak_selected_streakit")},setActive:function(){var self=this;this._element.mousedown(function(e){self._threadDOMRow.rowNode.attr("id","");self._element.addClass("__streak_It_Indicator_hover")});this._element.on("mouseup mouseout",function(e){if(self._menuOpen){return}self._threadDOMRow.rowNode.attr("id",self._htmlID);self._element.removeClass("__streak_It_Indicator_hover")})},getElement:function(){return this._element},getColumnName:function(){return"STAR"},getManipulationType:function(){return"APPEND_ELEMENT"}});BB.Modules.ListRowBoxesButton.ListRowBoxesButtonInboxRowManipulation=ListRowBoxesButtonInboxRowManipulation})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeBoxesButtonMasterController=function(){Gmail.GmailComposeManager.registerModifierModule(this)};_.extend(ComposeBoxesButtonMasterController.prototype,{getViewControllers:function(){var composeBoxesButtonViewController=new BB.Modules.ComposeBoxesButtonViewController;var taskThreadViewController=new BB.Modules.ComposeTaskThreadViewController;composeBoxesButtonViewController.addDelegate(taskThreadViewController);return[composeBoxesButtonViewController,taskThreadViewController,new BB.Modules.ComposeBoxSidebarViewController]}});DependencyManager.addFunction({functionKey:"composeBoxesMasterControllerInitialized",functionToCall:function(callback){BB.Modules.ComposeBoxesButtonMasterController=new ComposeBoxesButtonMasterController;if(callback){callback()}},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","data.boxes.initialized","data.pipelines.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeBoxesButtonViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._menuButton=null;this._shouldLoad=true;this._box=null};ComposeBoxesButtonViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(ComposeBoxesButtonViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupMenuButton()},shouldProcessModification:function(){return this._shouldLoad},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"BEFORE_FORMATTING"},getModificationPriority:function(){return 2},getModificationElement:function(){return this._menuButton.getElement()},activeModulesChanged:function(activeModules){this._menuButton.enable();if(activeModules.indexOf("sendLater")>-1){this._menuButton.disable()}if(activeModules.indexOf("threadBox")>-1){this._menuButton.addClass("streak__boxOnComposeActive")}else{this._menuButton.removeClass("streak__boxOnComposeActive")}},mailMergeActive:function(){if(!this._shouldLoad){return}this._shouldLoad=false;this._composeWindowViewController.reloadModification(this)},mailMergeCancelled:function(){this._shouldLoad=true;this._composeWindowViewController.reloadModification(this)},aboutToSend:function(){this._box=this._composeWindowViewController.getModuleStorageValue("threadBox")},sentEmailThreadMetaDataFound:function(threadMetaData){if(!this._box){this._callDelegateFunction("boxesButtonDestroyed");return}BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.createGmailThread(this._box.key(),threadMetaData);BB.Tracker.track("addThreadsToBox",{threadCount:1,context:"composeBoxesButton"});this._callDelegateFunction("gmailThreadCreated",threadMetaData.hexGmailThreadId)},destroy:function(){this._menuButton.destroy();this._composeWindowViewController=null}});_.extend(ComposeBoxesButtonViewController.prototype,{_setupMenuButton:function(){var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIcon",color:"icon",iconClass:"boxIconOnNewCompose",menu:BB.Modules.BoxesMenu.BoxesMenuViewController,isBottomAligned:true,isFixedPosition:true,isRightAligned:true,preOnFunction:function(){self._prepareBoxesMenu();BB.Tracker.track("boxes menu open",{method:"compose"})},postOnFunction:function(){BB.Modules.BoxesMenu.BoxesMenuViewController.focus()}});this._menuButton.setTooltip(BB.Locale.getString("add_to_box"))},_prepareBoxesMenu:function(){var self=this;BB.Modules.BoxesMenu.BoxesMenuViewController.use({dontAssociate:true,threadMetaDataList:[this._composeWindowViewController.getThreadMetaData()],box:this._composeWindowViewController.getModuleStorageValue("threadBox"),doneCallback:function(box){self._menuButton.off();if(box){if(box.isSavedOnServer()){self._composeWindowViewController.setModuleStorageValue("threadBox",box);self._composeWindowViewController.setModuleActive("threadBox");self._composeWindowViewController.notify("threadAddedToBox",box);BB.Tracker.track("addBoxToCompose",{context:"composeBoxesButton"})}else{box.save(function(){self._composeWindowViewController.setModuleStorageValue("threadBox",box);self._composeWindowViewController.setModuleActive("threadBox");self._composeWindowViewController.notify("threadAddedToBox",box);BB.Tracker.track("addBoxToCompose",{context:"composeBoxesButton"})});BB.Tracker.track("createNewBoxOnCompose",{context:"composeBoxesButton"})}self._menuButton.setTooltip(BB.Locale.getString("compose_button_tooltip",{box:box.displayName()}))}else{self._composeWindowViewController.setModuleStorageValue("threadBox",null);self._composeWindowViewController.setModuleInactive("threadBox");self._composeWindowViewController.notify("threadRemovedFromBox");self._menuButton.setTooltip(BB.Locale.getString("add_to_box"));BB.Tracker.track("removeBoxFromCompose")}},context:"composeBoxesButton"})}});BB.Modules.ComposeBoxesButtonViewController=ComposeBoxesButtonViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeBoxSidebarViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._sidebar=null;this._box=null;this._modificationParameters=null};ComposeBoxSidebarViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(ComposeBoxSidebarViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){return this._box!==null},aboutToProcessModification:function(){if(this._box){this._renderSidebar();return}if(this._sidebar){this._sidebar.destroy();this._sidebar=null}},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"INTERNAL_SIDEBAR"},getModificationPlacement:function(){return"RIGHT"},getModificationElement:function(){if(this._sidebar){return this._sidebar.getElement()}},getFirstTabFocusElement:function(){return this._sidebar.getFirstFocusable()},getLastTabFocusElement:function(){return this._sidebar.getLastFocusable()},threadAddedToBox:function(box){this._box=box;this._composeWindowViewController.reloadModification(this);BB.Tracker.track("box added to compose")},threadRemovedFromBox:function(){this._box=null;this._composeWindowViewController.reloadModification(this);BB.Tracker.track("box removed from compose")},destroy:function(){this._composeWindowViewController=null;this._callDelegateFunction("destroy",this);if(this._sidebar){this._sidebar.destroy();this._sidebar=null}},_renderSidebar:function(){var self=this;this._sidebar=BB.Modules.ConversationSidebar.BoxSidebar.create({box:this._box,keyboardTabs:true,blur:function(){self._composeWindowViewController.getEditor().focus()}});this._sidebar.getElement().addClass("boxOnNewCompose")}});BB.Modules.ComposeBoxSidebarViewController=ComposeBoxSidebarViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ComposeTaskThreadViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._box=null;this._modificationParameters=null;this._taskThreadModel=null;this._threadTaskWidget=null};ComposeTaskThreadViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(ComposeTaskThreadViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){return this._box!==null},aboutToProcessModification:function(){if(this._box){this._renderThreadTask();return}this._removeThreadTask()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM"},getModificationElement:function(){if(this._threadTaskWidget){return this._threadTaskWidget.getElement()}},threadAddedToBox:function(box){this._box=box;this._composeWindowViewController.reloadModification(this)},threadRemovedFromBox:function(){this._box=null;this._composeWindowViewController.reloadModification(this)},boxesButtonDestroyed:function(){this._destroy()},_destroy:function(){this._composeWindowViewController=null;this._callDelegateFunction("destroy",this);if(this._threadTaskWidget){this._threadTaskWidget.destroy()}},_removeThreadTask:function(){if(!this._threadTaskWidget){return}this._threadTaskWidget.destroy();this._threadTaskWidget=null;this._taskThreadModel=null},_renderThreadTask:function(){if(!this._taskThreadModel){this._taskThreadModel=BB.Models.GmailThread.create({});this._taskThreadModel.save=$.noop}this._threadTaskWidget=BB.Widgets.ThreadTask.create({gmailThread:this._taskThreadModel})},gmailThreadCreated:function(hexGmailThreadId){var gmailThread=BB.Services.Threads.ThreadStorer.getGmailThread(hexGmailThreadId);if(!gmailThread){return}gmailThread.set("taskStatus",this._taskThreadModel.get("taskStatus"));gmailThread.save();this._destroy()}});BB.Modules.ComposeTaskThreadViewController=ComposeTaskThreadViewController})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var BoxesButton=Streak.Class.subclass({className:"BoxesButton",superclass:Streak.Object,memberVariables:[{name:"_button",destroy:true}],_initialize:function(){var self=this;Streak.Object.prototype._initialize.call(this);this._button=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIconArrow",iconClass:"boxIcon",text:BB.Locale.getString("boxes_button_boxes"),isFixedPosition:true,isRightAligned:true,menu:BB.Modules.BoxesMenu.BoxesMenuViewController,postOnFunction:function(){BB.Modules.BoxesMenu.BoxesMenuViewController.use({doneCallback:function(){self._button.off()},context:"boxesButton"})}});this._button.addClass("streak__boxesButton");BB.Keyboard.bindChord("w,a",function(){if(self._button.getElement().is(":visible")){setTimeout(function(){self._button.on()},10)}},BB.Locale.getString("keyboard_boxes_button_description"))},getElement:function(){return this._button.getElement()}});Streak.DependencyManager.addFunction({functionKey:"boxesButtonInitialized",functionToCall:function(callback){var button=new BoxesButton;BB.Services.ToolbarManager.registerButton({element:button.getElement(),showFor:"threadSelection",placement:"moveGroup",orderHint:2});if(callback){callback()}},dependentFunctionKeys:["data.boxes.initialized","data.pipelines.initialized","threadsInitialized","boxesMenuViewControllerInitialized","localeLoaded","gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var OverridableHTML={defaults:{Locale:Streak.Locale,fileName:null},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};OverridableHTML.impl=function(o){var self=this;self.o=o;self.html={};self.fetchHTML=function(fileName){var self=this;return new Streak.Request("GET",Streak.server,fileName,{isAnonymous:true,responseType:"text"}).getPromise()};self.loadHTML=function(cb){var self=this;if(!self.o.fileName){if(cb){cb()}return}self.fetchHTML(self.o.fileName).then(function(htmlString){var htmlObj=$(htmlString);htmlObj.each(function(e){var _id=$(htmlObj[e]).attr("id");if(_id&&_id.length>0){var currHTML=htmlObj[e];self.html[_id]=currHTML.innerHTML.unescapeHTML()}});cb()})};self.substituteHTML=function(s){var self=this;return s.replace(/<%\*([\s\S]+?)%>/g,function(match,code){return self.getHelper(code.trim())})},self.getClone=function(){var _html=Streak.$.extend(true,{},self.html);return Streak.$.extend(true,{},self,{html:_html})};self.setMode=function(mode){var self=this;mode="__"+mode;var changes=[];Streak._.each(self.html,function(value,key){var positionOfModeInkey=key.indexOf(mode);if(positionOfModeInkey>0){var baseKey=key.substring(0,positionOfModeInkey);changes.push({baseKey:baseKey,value:self.html[key]})}});var changeLength=changes.length;for(var ii=0;ii<changeLength;ii++){var change=changes[ii];self.html[change.baseKey]=change.value}};self.getHelper=function(id){return self.html[id]},self.get=function(id){var currentString="";var lastString=this.substituteHTML(this.html[id]);for(var ii=0;ii<100;ii++){var currentString=this.substituteHTML(lastString);if(lastString===currentString){break}else{lastString=currentString}}return _.template(self.o.Locale.localize(currentString))};return self};BB.Modules.OverridableHTML=OverridableHTML})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,StateMachine=Streak.StateMachine,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,HTML=Streak.HTML,BB=Streak.BentoBox;var self=ContextioStatusNotifier={init:function(){self._contextioStatus=null;return self._getContextioStatus()},_getContextioStatus:function(){return APIRequester.get("users/me/contextiostatus").getPromise().then(function(contextioStatusResponse){self._handleContextioStatusReponse(contextioStatusResponse)})},_handleContextioStatusReponse:function(contextioStatusResponse){self._contextioStatus=contextioStatusResponse;if(self._shouldShowContextioSatusModal()){self._showContextioStatusModal()}},_shouldShowContextioSatusModal:function(){return self._contextioStatus==="NO_ACCESS_TO_ALL_MAIL"&&!BB.Modules.TourRunner.isTourRunning()},_showContextioStatusModal:function(){BB.Widgets.Modal.create({title:BB.Locale.getString("no_access_all_mail_title"),inner:BB.Locale.getString("no_access_all_mail_body"),showCancel:false,confirmText:BB.Locale.getString("ok")}).show()}};if(Streak.isDev){return}Streak.DependencyManager.addFunction({functionKey:"contextioStatusNotifierInitialized",functionReference:ContextioStatusNotifier.init,functionContext:ContextioStatusNotifier,dependentFunctionKeys:["gmailLoaded","htmlLoaded","tourRunner.initRunTour"]});BB.Modules.ContextioStatusNotifier=ContextioStatusNotifier})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var TabbedSidebarMaster={initialized:false,_conversationId:null,init:function(){if(!this.initialized){this.initializeVariables();Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._handleConversationThread.bind(this),null,1);Gmail.addTimerObserver(this._handleTimerCallback.bind(this));this.initialized=true}},initializeVariables:function(){this._sidebars={}},reaup:function(){},teaddown:function(){},registerNewSidebar:function(options){var sidebar=this._sidebars[this._conversationId];if(!_.isReal(sidebar)){sidebar=new BB.Modules.TabbedSidebar;this._sidebars[this._conversationId]=sidebar}return sidebar.registerSidebar(options)},removeSidebar:function(sidebarId){var sidebar=this._sidebars[this._conversationId];if(_.isReal(sidebar)){sidebar.removeSidebar(sidebarId)}},_handleViewChanged:function(){if(!Gmail.isConversation()){this.destroySidebars();this._conversationId=null}},_handleConversationThread:function(){var hexGmailThreadIDList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIDList.length===0){this.destroySidebars();this._conversationId=null;return}if(hexGmailThreadIDList[0]!==this._conversationId){this.destroySidebars()}this._conversationId=hexGmailThreadIDList[0]},_handleTimerCallback:function(){if(Gmail.isPreviewPane()){if(!Gmail.isConversationVisible()){this.destroySidebars();return}}_.each(this._sidebars,function(sidebar){if(sidebar._fixSidebar){sidebar._fixSidebar()}})},destroySidebars:function(){var newSidebars={};_.each(this._sidebars,function(sidebar,conversationId){sidebar.destroy()});this._sidebars=newSidebars}};Streak.DependencyManager.addFunction({functionKey:"tabbedSidebarMasterInitialized",functionReference:TabbedSidebarMaster.init,functionContext:TabbedSidebarMaster,dependentFunctionKeys:["gmailLoaded"]});BB.Modules.TabbedSidebarMaster=TabbedSidebarMaster})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var CONSTANTS={TAB_COLOR_CLASSES:["aIf-aLe","aKe-aLe","aJi-aLe","aH2-aLe","aHE-aLe"]};var TabbedSidebar=function(){this.el=$(HTML.get("tabbedSidebar")());this._elements={};this._selectedTabId=null;this._registeredSidebars={};this._loadSidebarContainer()};_.extend(TabbedSidebar.prototype,{registerSidebar:function(sidebarEntry){var self=this;if(self._registeredSidebars[sidebarEntry.id]){self.removeSidebar(sidebarEntry.id,true)}var _id="sidebar_"+Math.random();sidebarEntry.id=_id;self._registeredSidebars[_id]=sidebarEntry;self._elements.tabbedSidebarBody.append(sidebarEntry.sidebar.getElement());self._generateSelectedTab();self._refresh();self._tabStatusChanged();return _id},removeSidebar:function(id,noRefresh){var self=this;if(_.isReal(self._registeredSidebars[id])){if(_.isReal(self._registeredSidebars[id].destroy)){self._registeredSidebars[id].destroy()}delete self._registeredSidebars[id]}if(self._selectedTabId===id){self._generateSelectedTab()}if(!noRefresh){self._refresh();self._tabStatusChanged()}},destroy:function(){var self=this;for(key in this._registeredSidebars){if(this._registeredSidebars[key].sidebar&&this._registeredSidebars[key].sidebar.destroy){this._registeredSidebars[key].sidebar.destroy()}}self.el.empty();self.el.remove()},_loadSidebarContainer:function(){var self=this;self._elements.tabbedSidebarTabs=self.el.find(".__streak_CS_tabs");self._elements.tabbedSidebarBody=self.el.find(".__streak_CS_body");self.el.hide();Gmail.getRightSide().prepend(self.el);self.hasBeenLoaded=true;self._refresh();self._fixSidebar()},_fixSidebar:function(){if(!this.el.isVisible()){Gmail.getRightSide().prepend(this.el)}if(this.el.parents(".adC").length>0){var gmailSidebarContainerDiv=this.el.parents(".adC");if(gmailSidebarContainerDiv[0].style.position==="absolute"&&!BB.Services.RapportiveStatusController.isEnabled()){gmailSidebarContainerDiv[0].style.position="relative"}}var siblingsNH=this.el.siblings(".nH");if(siblingsNH.length>0){if(siblingsNH[0].style.position==="absolute"){siblingsNH[0].style.position="relative"}if(siblingsNH[0].style.right){siblingsNH[0].style.right=""}}if(BB.Services.RapportiveStatusController.isEnabled()){var rapportive=BB.Services.RapportiveStatusController.getSidebar();var container=rapportive.closest(".adC");if(container.length>0){container.removeClass("adC");if(container[0].style.position==="absolute"){container[0].style.position="static"}}if(this.el.parent()[0]!==rapportive[0]){rapportive.prepend(el)}this.el.addClass("rapportivePresent")}if(this.el.siblings(".y4").length>0){this.el.siblings(".y4")[0].style.display="none"}},_refresh:function(){var self=this;if(!_.isReal(self._selectedTabId)){self._generateSelectedTab()}if(!self.hasBeenLoaded){return}if(self._currentSidebarsCount()>0){self.el.show()}else{self.el.hide()}self._renderTabs(self._elements.tabbedSidebarTabs);self._refreshSidebarBody()},_getSelected:function(){},_getFirstEntry:function(){return _.values(this._registeredSidebars).first()},_isSelectedTab:function(sidebarEntry){var self=this;return self._selectedTabId===sidebarEntry.id},_renderTabs:function(tabContainer,registeredSidebars){var self=this;tabContainer.empty();var tabParent=tabContainer.parents(".__streak_CS_tabsContainer");tabParent.show();_(this._registeredSidebars).chain().values().sortBy(function(sidebarEntry){return sidebarEntry.priority}).each(function(sidebarEntry,index){if(self._shouldNotAddTab(sidebarEntry)){if(sidebarEntry.sidebar.notAddedToSidebar){sidebarEntry.sidebar.notAddedToSidebar()}return}if(sidebarEntry.sidebar.addedToSidebar){sidebarEntry.sidebar.addedToSidebar()}var tabEl=self._renderTab(sidebarEntry,index);tabContainer.append(tabEl)})},_shouldNotAddTab:function(sidebarEntry){if(this._registeredSidebars.length>1&&sidebarEntry.dontShowIfOnlyTab){return true}if(sidebarEntry.dependentTabIdentifiers){if(!this._doTabIdentifiersExist(sidebarEntry.dependentTabIdentifiers)){return true}}return false},_doTabIdentifiersExist:function(tabIdentifiers){var sidebars=this._registeredSidebars;return _.filter(tabIdentifiers,function(tabIdentifier){return _.filter(sidebars,function(sidebar){return sidebar.tabIdentifier===tabIdentifier}).length>0}).length>0},_renderTab:function(sidebarEntry,index){var self=this;var tabEl=$(HTML.get("sidebarTab")({tabPrettyTitle:sidebarEntry.prettyTitle}));tabEl.click(function(){self._setSelectedTabById(sidebarEntry.id)});var innerTab=tabEl.find("[role=tab]");innerTab.addClass(CONSTANTS.TAB_COLOR_CLASSES[index%CONSTANTS.TAB_COLOR_CLASSES.length]);tabEl.hover(function(e){innerTab.addClass("J-KU-Je J-KU-JW")},function(e){innerTab.removeClass("J-KU-Je J-KU-JW")});tabEl.find(".__streak_CS_tabIcon").addClass(sidebarEntry.iconClass);if(self._isSelectedTab(sidebarEntry)){innerTab.addClass("J-KU-KO");tabEl.addClass("streak__CS_selectedTab")}return tabEl},_currentSidebarsCount:function(){var self=this;var count=0;_.each(self._registeredSidebars,function(){count++});return count},_generateSelectedTab:function(){this._selectedTabId=_.chain(this._registeredSidebars).values().sortBy(function(sidebar){return sidebar.priority||100}).pluck("id").first().value();return this._selectedTabId},_getSelectedSidebarEntry:function(){var self=this;return self._registeredSidebars[self._selectedTabId]},_refreshSidebarBody:function(){if(!_.isReal(this._getSelectedSidebarEntry())){return}this._hideSidebarBodies();this._showSelectedSidebar()},_showSelectedSidebar:function(){this._getSelectedSidebarEntry().sidebar.getElement().show();if(this._getSelectedSidebarEntry().sidebar["sidebarShown"]){this._getSelectedSidebarEntry().sidebar["sidebarShown"]()}},_hideSidebarBodies:function(){this._elements.tabbedSidebarBody.children().hide();this._callFunctionOnSidebars("sidebarHidden")},_callFunctionOnSidebars:function(functionName){var self=this;_.each(this._registeredSidebars,function(sidebarEntry,id){if(!self._shouldNotAddTab(sidebarEntry)&&sidebarEntry&&sidebarEntry.sidebar[functionName]){sidebarEntry.sidebar[functionName]()}})},_setSelectedTabById:function(tabId){var self=this;self._selectedTabId=tabId;self._refresh()},_tabStatusChanged:function(){_.each(this._registeredSidebars,function(sidebarEntry,id){if(sidebarEntry&&sidebarEntry.tabStatusChanged){sidebarEntry.tabStatusChanged()}})}});Streak.BentoBox.Modules.TabbedSidebar=TabbedSidebar})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Eventer=Streak.Eventer,Gmail=Streak.Gmail,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var BoxSidebarMasterController={_tabbedSidebarId:null,_boxSidebar:null,_currentBox:null,_relatedBoxesViewController:null,init:function(){this._reset();Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"boxKey"},functionToCall:this._handleBoxKeySet});Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._refresh.bind(this),null)},_reset:function(){if(this._tabbedSidebarId){BB.Modules.TabbedSidebarMaster.removeSidebar(this._tabbedSidebarId)}if(this._boxSidebar){this._boxSidebar.destroy()}if(this._relatedBoxesViewController){this._relatedBoxesViewController.destroy()}this._tabbedSidebarId=null;this._boxSidebar=null;this._currentBox=null;this._relatedBoxesViewController=null},_handleViewChanged:function(){if(!Gmail.isConversation()){this._reset()}},_handleBoxKeySet:function(notification){if(!Gmail.isConversationVisible()){return}var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}if(notification.hexGmailThreadId!==hexGmailThreadIdList[0]){return}this._refresh()},_refresh:function(){this._reset();var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}var boxKey=BB.Services.Threads.ThreadStorer.getBoxKey(hexGmailThreadIdList[0]);var box=BB.Data.getBox(boxKey);var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(hexGmailThreadIdList[0]);var relatedBoxes=BB.Services.BoxSearcher.getBoxesWithOverlappingEmailAddresses(threadMetaData.emailAddresses);if(relatedBoxes.length>10){if(relatedBoxes.length/BB.Data.getAllBoxes().length>.1){relatedBoxes.length=0}}this._loadBoxSidebar(box,relatedBoxes,hexGmailThreadIdList[0])},_loadBoxSidebar:function(box,relatedBoxes,hexGmailThreadId){if(this._currentBox&&box&&box.key()===this._currentBox.key()){return}this._currentBox=box;if(!this._currentBox){if(!relatedBoxes||relatedBoxes.length===0){return}this._relatedBoxesViewController=new BB.Modules.RelatedBoxesViewController(relatedBoxes);this._tabbedSidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:BB.Locale.getString("box_tab_title"),iconClass:"darkBoxIcon",priority:1,sidebar:this._relatedBoxesViewController.getView()});return}this._boxSidebar=BB.Modules.ConversationSidebar.BoxSidebar.create({box:this._currentBox,hexGmailThreadId:hexGmailThreadId,keyboardTabs:true,clearIDAttributeOfMainElement:false});if(relatedBoxes&&relatedBoxes.length>0){relatedBoxes=_.filter(relatedBoxes,function(relatedBox){return relatedBox.key()!==box.key()});if(relatedBoxes.length>0){this._relatedBoxesViewController=new BB.Modules.BoxSidebarRelatedBoxesViewController(relatedBoxes,this._currentBox);this._boxSidebar.setRelatedBoxesView(this._relatedBoxesViewController.getView())}}this._tabbedSidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:BB.Locale.getString("box_tab_title"),iconClass:"darkBoxIcon",priority:1,sidebar:this._boxSidebar})}};Streak.DependencyManager.addFunction({functionKey:"boxSidebarMasterControllerInitialized",functionReference:BoxSidebarMasterController.init,functionContext:BoxSidebarMasterController,dependentFunctionKeys:["tabbedSidebarMasterInitialized"]});BB.Controllers.BoxSidebarMasterController=BoxSidebarMasterController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Eventer=Streak.Eventer,Gmail=Streak.Gmail,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var ReminderSidebarController={_tabbedSidebarId:null,_boxSidebar:null,_currentBox:null,init:function(){this._reset();Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"reminderBoxKey"},functionToCall:this._handleReminderBoxKeySet});Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this),null)},_reset:function(){if(this._tabbedSidebarId){BB.Modules.TabbedSidebarMaster.removeSidebar(this._tabbedSidebarId)}if(this._boxSidebar){this._boxSidebar.destroy()}this._tabbedSidebarId=null;this._boxSidebar=null;this._currentBox=null},_handleViewChanged:function(){if(!Gmail.isConversation()){this._reset()}},_handleConversationLoaded:function(){this._reset();var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}var boxKey=BB.Services.Threads.ThreadStorer.getReminderBoxKey(hexGmailThreadIdList[0]);var box=BB.Data.getBox(boxKey);if(box){this._loadBoxSidebar(box)}else{this._reset()}},_handleReminderBoxKeySet:function(notification){if(!Gmail.isConversationVisible()){return}var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}if(notification.hexGmailThreadId!==hexGmailThreadIdList[0]){return}if(notification.value){var box=BB.Data.getBox(notification.value);if(box){this._loadBoxSidebar(box);return}}this._reset()},_loadBoxSidebar:function(box){if(this._currentBox&&box&&box.key()===this._currentBox.key()){return}this._currentBox=box;this._boxSidebar=BB.Modules.ConversationSidebar.BoxSidebar.create({box:this._currentBox,keyboardTabs:true,clearIDAttributeOfMainElement:false});this._tabbedSidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:BB.Locale.getString("reminder_box_tab_title"),iconClass:"reminderIcon",sidebar:this._boxSidebar})}};Streak.DependencyManager.addFunction({functionKey:"remindersSidebarControllerInitialized",functionReference:ReminderSidebarController.init,functionContext:ReminderSidebarController,dependentFunctionKeys:["tabbedSidebarMasterInitialized"]});BB.Controllers.ReminderSidebarController=ReminderSidebarController})(Streak);Streak.BentoBox.Modules.ConversationSidebar={};(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Library=Streak.Library,Locale=Streak.BentoBox.Locale,BB=Streak.BentoBox;var ConversationSidebar=BB.Modules.ConversationSidebar;var trackingContext={widgetContext:"ConversationSidebar.BoxSidebar"};var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};ConversationSidebar.BoxSidebar={defaults:{box:null,keyboardTabs:true,blur:$.noop,trackingContext:null,clearIDAttributeOfMainElement:true},create:function(options){var o={};
_.extend(o,ConversationSidebar.BoxSidebar.defaults,options);return new ConversationSidebar.BoxSidebar.impl(o)}};ConversationSidebar.BoxSidebar.impl=function(options){if(!options.box||!options.box.getPipeline){return}ConversationSidebar.templates={};ConversationSidebar.templates.normal=Streak.HTML.get("ConversationSidebar");ConversationSidebar.templates.field=Streak.HTML.get("ConversationSidebarField");this.options=options;this.box=this.options.box;this.pipeline=this.box.getPipeline();this.hexGmailThreadId=options.hexGmailThreadId;this.el=null;this.stages=null;this.notesArea=null;this.assignedTo=null;this.reminderSection=null;this.reminderList=null;this.followerSection=null;this.linkedBoxesSection=null;this.followers=null;this.columnOrder=null;this.columnVisibility=null;this._simpleBoxesMenu=null;this._linkedBoxesInner=null;this.uniq=Date.now()+"."+Math.random();this.inputs=[];this.tabFocusController=new BB.Widgets.TabFocusController;this.setup()};_.extend(ConversationSidebar.BoxSidebar.impl.prototype,{getElement:function(){return this.el},setup:function(){this.el=$(ConversationSidebar.templates.normal({boxName:this.box.displayName(),pipelineName:this.pipeline.displayName()}));if(this.options.clearIDAttributeOfMainElement){this.el.attr("id","")}this.columnOrder=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(this.pipeline).data;this.columnVisibility=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.load(this.pipeline).data;this.renderHeading();this.renderStages();this.renderAssignedTo();this.renderFields();this.renderReminders();this.renderEmailFilters();this.renderEmailFilterSuggestions();this.renderFollowers();this.renderLinkedBoxes();this.bindEvents();this.setupTabArray()},destroy:function(){this.tabFocusController.destroy();for(var ii=0;ii<this.inputs.length;ii++){if(this.inputs[ii]&&this.inputs[ii].destroy){this.inputs[ii].destroy()}}Streak.NotificationCenter.unsubscribe({observer:this});this.followers.destroy();this.reminderList.destroy();this._emailFilter.destroy();this.el.remove()},renderHeading:function(){var self=this;this.el.find(".boxLink").click(function(e){track("boxLinkClicked");e.preventDefault();BB.UI.setURL(self.box.link())});this.el.find(".pipelineLink").click(function(e){track("pipelineLinkClicked");e.preventDefault();BB.UI.setURL(self.pipeline.link())});this.notesArea=BB.Widgets.SmartTextarea.create({model:this.box,property:"notes",borderOnHover:false,trackingContext:_.clone(trackingContext)});this.el.find(".boxNotes").append(this.notesArea.el);this.inputs.push(this.notesArea)},renderStages:function(){this.stages=BB.Widgets.StageButton.create({pipeline:this.pipeline,box:this.box,trackingContext:_.clone(trackingContext)});this.el.find(".stageButton").append(this.stages.el);this.inputs.push(this.stages)},renderAssignedTo:function(){var assignedToContainer=this.el.find(".assignedTo");this.el.find(".assignedTo *").trigger("unbind");assignedToContainer.empty();assignedToContainer.hide();var assignedToColumn=this.pipeline.getSystemColumnByProperty("assignedToSharingEntries");if(_.isNotReal(assignedToColumn)){return}var isVisible=this.columnVisibility["property|"+assignedToColumn.uniqueKey];if(isVisible===false){return}assignedTo=BB.Widgets.SidebarAssignedTo.create({box:this.box,pipeline:this.pipeline,border:"never",persist:true,imgHeight:23,imgWidth:23,includeNames:true,delayedBind:true});var field=$(ConversationSidebar.templates.field({name:BB.Locale.getString("assignedTo")}));field.find(".fieldValue").append(assignedTo.el);this.inputs.push(assignedTo);assignedToContainer.append(field);assignedToContainer.show();this.assignedTo=assignedTo},renderFields:function(){var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(this.pipeline);this.el.find(".boxFields *").trigger("unbind");this.el.find(".boxFields").empty();for(var i=0;i<this.columnOrder.length;i++){var columnKey=this.columnOrder[i];if(columns[columnKey].field){var field=this.renderField(columns[columnKey].field.key());this.el.find(".boxFields").append(field)}}},renderField:function(fieldKey){var pipelineFieldModel=this.pipeline.getField(fieldKey);var field=$(ConversationSidebar.templates.field({name:pipelineFieldModel.displayName()}));var input=BB.Models.BoxField.getSidebarInputWidget(this.box,pipelineFieldModel,field.find(".fieldValue"),{widgetContext:"boxSidebar"});if(!input){return}var inputElement=input.getElement?input.getElement():input.el;field.find(".fieldValue").append(inputElement);this.inputs.push(input);pipelineFieldModel.watch("set",function(){if(field.is(":inBody")){field.find(".fieldName").text(pipelineFieldModel.displayName())}else{return true}},this,"name");return field},renderReminders:function(){var self=this;var title=BB.Locale.getString("reminders_title");if(this.box.get("reminderKeys")&&this.box.get("reminderKeys").length>0){title+=" ("+this.box.get("reminderKeys").length+")"}this.reminderList=BB.Widgets.ReminderList.create({box:this.box,pipeline:this.pipeline,showTitle:false,useLinkButtonForNewReminder:true,trackingContext:_.clone(trackingContext)});this.reminderSection=BB.Widgets.CollapseSection.create({title:title,bodyEl:this.reminderList.el,startOpen:false,localToggleStateKey:"boxSidebar/remindersSection"});this.el.find(".reminders").empty().append(this.reminderSection.el);this.inputs.push(this.reminderList);var element=this.reminderList.getNewReminderButtonElement();element.addClass("reminderList");this.reminderSection.addToRightOfTitle(element)},updateReminderTitle:function(){title=BB.Locale.getString("reminders_title");var length=BB.Data.getReminderCollection(this.box.key()).length;if(length>0){title+=" ("+length+")"}this.reminderSection.updateTitle(title)},renderFollowers:function(){this.followers=BB.Widgets.FollowerButton.create({box:this.box,trackingContext:_.clone(trackingContext)});this.el.find(".boxFollowers").append(this.followers.el);this.inputs.push(this.followers)},renderEmailFilters:function(){if(!this._emailFilter){this._emailFilter=new BB.Modules.EmailFilters.EmailFilterViewController({boxKey:this.box.key(),useLinkButtonForNewFilter:true,showTitle:false});if(this._emailFilterCollection){this._emailFilter.setEmailFilters(this._emailFilterCollection)}if(this._emailFilterBlacklistCollection){this._emailFilter.setEmailFilterBlacklists(this._emailFilterBlacklistCollection)}}if(!this._emailFiltersSection){this._emailFiltersSection=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("email_filters"),bodyEl:this._emailFilter.getElement(),startOpen:true,localToggleStateKey:"boxSidebar/emailFiltersSection"});var newEmailFilterButtonElement=this._emailFilter.getNewEmailFilterButtonElement();this._emailFiltersSection.addToRightOfTitle(newEmailFilterButtonElement)}if(!this._emailFilterCollection){this._updateEmailFilterCollection()}this.el.find(".streak__emailFiltersOuter").html(this._emailFiltersSection.el)},_updateEmailFilterCollection:function(){this._emailFilterCollection=BB.Data.getEmailFilterCollection(this.box.key());this._emailFilter.setEmailFilters(this._emailFilterCollection);this._emailFilterCollection.refresh();this._emailFilterCollection.watch("collectionChange",this._emailFilterCollectionUpdated.bind(this),this);this._emailFilterCollectionUpdated()},_updateEmailFilterBlacklistCollection:function(){this._emailFilterBlacklistCollection=BB.Data.getEmailFilterBlacklistCollection(this.box.key());this._emailFilterBlacklistCollection.refresh();this._emailFilter.setEmailFilterBlacklists(this._emailFilterBlacklistCollection);this._emailFilterBlacklistCollection.watch("collectionChange",this._emailFilterBlacklistCollectionUpdated.bind(this),this);this._emailFilterBlacklistCollectionUpdated()},_emailFilterCollectionUpdated:function(){if(this._emailFilterCollection&&this._emailFilterBlacklistCollection){this.updateEmailFilterSuggestions()}},_emailFilterBlacklistCollectionUpdated:function(){if(this._emailFilterCollection&&this._emailFilterBlacklistCollection){this.updateEmailFilterSuggestions()}},renderEmailFilterSuggestions:function(){if(!this._emailFilterBlacklistCollection){this._updateEmailFilterBlacklistCollection()}var self=this;Streak.NotificationCenter.subscribe({eventName:"boxAndGmailThreadCreated",filterParameters:{hexGmailThreadId:this.hexGmailThreadId},functionToCall:function(){self._boxCreated=true;self.updateEmailFilterSuggestions()},observer:this})},createEmailFilter:function(emailAddress){var emailFilterLimiter=Library.get("BentoBox.Services.EmailFilterLimiter");if(emailFilterLimiter.isLocked()){emailFilterLimiter.showGateway()}else{var newFilter=BB.Models.EmailFilter.create({type:"EMAIL_ADDRESS_FILTER",value:emailAddress,boxKey:this.box.key()});newFilter.save();this._emailFilterCollection.add(newFilter);emailFilterLimiter.incrementUsage()}},createDomainFilter:function(domain){var emailFilterLimiter=Library.get("BentoBox.Services.EmailFilterLimiter");if(emailFilterLimiter.isLocked()){emailFilterLimiter.showGateway()}else{var newFilter=BB.Models.EmailFilter.create({type:"DOMAIN_FILTER",value:domain,boxKey:this.box.key()});newFilter.save();this._emailFilterCollection.add(newFilter);emailFilterLimiter.incrementUsage()}},blacklistEmailAddress:function(emailAddress){var newBlacklist=BB.Models.EmailFilterBlacklist.create({blacklistEmail:emailAddress});newBlacklist.save();this._emailFilterBlacklistCollection.add(newBlacklist)},getEmailAddressesInGmailThread:function(){var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(this.hexGmailThreadId);if(threadMetaData){return threadMetaData.emailAddresses}else{return[]}},shouldShowEmailSuggestions:function(){if(!this._boxCreated){return false}if(this._suggestionsHidden){return false}var shouldShow=this._shouldShowEmailSuggestionsIfBoxCreated();this._suggestionsHidden=!shouldShow;return shouldShow},setRelatedBoxesView:function(relatedBoxesView){this.el.find(".relatedBoxes").show();this.el.find(".relatedBoxes").append(relatedBoxesView.getElement())},_shouldShowEmailSuggestionsIfBoxCreated:function(){var emailsInThread=this.getEmailAddressesInGmailThread();var filters=this._emailFilterCollection,blacklists=this._emailFilterBlacklistCollection;if(_.some(emailsInThread,function(email){return _.some(filters,function(filter){return filter.matches(email)})})){return false}var filteredEmails=_.filter(emailsInThread,function(email){return!_.some(blacklists,function(blacklist){return blacklist.matches(email)})});filteredEmails.removeVal(BB.getUser().getEmail());if(filteredEmails.length==0){this._emailFilterSuggestedEmail=null;this._emailFilterSuggestedDomain=null;return false}else{this._emailFilterSuggestedEmail=filteredEmails[0];this._emailFilterSuggestedDomain=filteredEmails[0].split("@")[1];return true}},updateEmailFilterSuggestions:function(){var shouldShowSuggestions=this.shouldShowEmailSuggestions();if(shouldShowSuggestions&&!this._emailFilterSuggestions){this._setupEmailFilterSuggestions()}else if(shouldShowSuggestions&&this._emailFilterSuggestions&&this._emailFilterSuggestions.is(":hidden")){this._emailFilterSuggestions.show()}else if(!shouldShowSuggestions&&this._emailFilterSuggestions&&this._emailFilterSuggestions.is(":visible")){this._emailFilterSuggestions.hide()}},_setupEmailFilterSuggestions:function(){this._emailFilterSuggestions=$(HTML.getElement("emailFilterSuggestions"));var emailText=BB.Locale.getString("email_suggestion_one_email",{email:this._emailFilterSuggestedEmail});this._emailFilterSuggestions.find(".streak_emailFilter_email").html(emailText);var domainText=BB.Locale.getString("email_suggestion_one_domain",{domain:this._emailFilterSuggestedDomain});this._emailFilterSuggestions.find(".streak_emailFilter_domain").html(domainText);var self=this;this._dontShowButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("email_suggestion_dont_show_again"),onFunction:function(){self._dontShowClickedInSuggestions()}});this._dontShowButton.addClass("dontShowButton");this._createFilterSuggestionButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("email_suggestion_create_filter"),color:"blue",css:{"margin-right":"0px"},onFunction:function(){self._createFilterClickedInSuggestions()}});this._createFilterSuggestionButton.addClass("createFilter");this._emailFilterSuggestions.find(".streak__emailFilterSuggestions_dont_show").html(this._dontShowButton.getElement());this._emailFilterSuggestions.find(".streak__emailFilterSuggestions_create_filter").html(this._createFilterSuggestionButton.getElement());this.el.find(".emailFilterSuggestions").html(this._emailFilterSuggestions)},_createFilterClickedInSuggestions:function(){var filterType=this._emailFilterSuggestions.find("input:radio:checked[name=emailFilterSuggestion]").val();if(filterType==="email"){this.createEmailFilter(this._emailFilterSuggestedEmail)}else if(filterType==="domain"){this.createDomainFilter(this._emailFilterSuggestedDomain)}this._emailFilterSuggestions.hide()},_dontShowClickedInSuggestions:function(){this.blacklistEmailAddress(this._emailFilterSuggestedEmail);this._emailFilterSuggestions.hide()},renderLinkedBoxes:function(){if(!this.linkedBoxesSection){this._setupLinkedBoxesSection()}var title=BB.Locale.getString("linked_boxes");var numberOfLinkedBoxes=this.box.get("linkedBoxKeys")?this.box.get("linkedBoxKeys").length:0;if(numberOfLinkedBoxes>0){title+=" ("+numberOfLinkedBoxes+")"}this.linkedBoxesSection.updateTitle(title);this._renderLinkedBoxes()},_setupLinkedBoxesSection:function(){this._linkedBoxesInner=$(document.createElement("div"));this._linkedBoxesInner.addClass("streak__linkedBoxes");this._linkedBoxesList=$(document.createElement("div"));this._linkedBoxesList.addClass("streak__linkedBoxes_list");this._linkedBoxesInner.append(this._linkedBoxesList);var self=this;this._simpleBoxesMenu=Streak.Library.getInstance("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuViewController");this._simpleBoxesMenu.addDelegate({boxChosen:function(chosenBox){self.box.addLinkedBox(chosenBox)}});this.inputs.push(this._simpleBoxesMenu);this._linkedBoxesInner.append(this._simpleBoxesMenu.getView().getElement());this.linkedBoxesSection=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("linked_boxes"),bodyEl:this._linkedBoxesInner,startOpen:false,localToggleStateKey:"boxSidebar/linkedBoxesSection"});this.el.find(".linkedBoxes").append(this.linkedBoxesSection.el)},_renderLinkedBoxes:function(){var boxKeys=this.box.get("linkedBoxKeys");var groupedBoxes;var missingBoxCount=0;this._linkedBoxesList.empty();var self=this;_.chain(boxKeys).map(function(boxKey){var connectedBox=BB.Data.getBox(boxKey);if(connectedBox){return connectedBox}missingBoxCount+=1}).compact().sortBy(function(box){return box.get("lastUpdatedTimestamp")}).sortBy(function(box){return box.displayName()}).sortBy(function(box){var stageOrder=box.getPipeline().get("stageOrder");return stageOrder.indexOf(box.get("stageKey"))}).groupBy(function(box){return box.getPipeline().key()}).tap(function(intermediateResults){groupedBoxes=intermediateResults}).keys().map(function(pipelineKey){return BB.Data.getPipeline(pipelineKey)}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){self._renderLinkedBoxSection(pipeline,groupedBoxes[pipeline.key()])});this._simpleBoxesMenu.setExcludedBoxKeys(boxKeys.concat([this.box.key()]))},_renderLinkedBoxSection:function(pipeline,boxes){var sectionContainer=$(HTML.get("boxSidebarLinkedBoxes")({pipelineName:pipeline.displayName()}));var listBody=sectionContainer.find("ul");for(var ii=0;ii<boxes.length;ii++){var boxRow=this._renderLinkedBox(boxes[ii],pipeline.getColor());listBody.append(boxRow)}this._linkedBoxesList.append(sectionContainer)},_renderLinkedBox:function(connectedBox,color){var row=$(HTML.get("boxSidebarLinkedBox")({boxName:connectedBox.displayName()}));row.on("click",function(e){BB.UI.setURL(connectedBox.link())});var self=this;row.find(".ar9").on("click",function(e){var boxKeyArray=self.box.get("linkedBoxKeys")||[];boxKeyArray.removeVal(connectedBox.key());self.box.set("linkedBoxKeys",boxKeyArray);self.box.save();boxKeyArray=connectedBox.get("linkedBoxKeys")||[];boxKeyArray.removeVal(self.box.key());connectedBox.set("linkedBoxKeys",boxKeyArray);connectedBox.save();e.stopPropagation()});return row},bindEvents:function(){var self=this;var observer=this;this.pipeline.watch("set",function(){if(self.el&&self.el.find(".pipelineLink").length>0){self.el.find(".pipelineLink").text(self.pipeline.displayName())}else{return true}},observer,"name");this.box.watch("set",function(){if(self.el&&self.el.find(".boxLink").length>0){self.el.find(".boxLink").text(self.box.displayName())}else{return true}},observer,"name");this.pipeline.watch("set",function(){self.renderFields();self.setupTabArray()},observer,"fields");BB.Data.getReminderCollection(this.box.key()).watch("collectionChange",function(){self.updateReminderTitle()},observer);this.box.watch("set",function(){self.renderLinkedBoxes()},observer,"linkedBoxKeys");BB.Keyboard.bindChordToEl({el:this.el,chord:"escape",noDefault:true,noBubble:true,cb:function(){self.options.blur()}});this.el.bind("blurred",function(e){self.options.blur()})},setupTabArray:function(){if(!this.options.keyboardTabs){return}this.tabArray=[];this.tabArray.push(this.stages.el.find(".bbButton"));this.tabArray.push(this.notesArea.el);if(this.assignedTo){this.tabArray.push(this.assignedTo.el)}var fields=this.el.find(".boxFields .smartInput");for(var i=0;i<fields.length;i++){this.tabArray.push($(fields[i]))}this.tabArray.push(this.reminderList.getFocusElement());if(this.linkedBoxesSection){this.tabArray.push(this._simpleBoxesMenu.getFocusElement())}this.tabArray.push(null);this.tabFocusController.addElements(this.tabArray)},getFirstFocusable:function(){return this.stages.el.find(".bbButton")},getLastFocusable:function(){return this.tabArray.last(2).first()}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Eventer=Streak.Eventer,Gmail=Streak.Gmail,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var ConversationTaskThreadMasterController={_threadTask:null,_currentGmailThread:null,init:function(){this._reset();Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"gmailThread"},functionToCall:this._handleGmailThreadSet});Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this),null)},_reset:function(){if(this._threadTask){this._threadTask.destroy()}this._threadTask=null;this._currentGmailThread=null},_handleViewChanged:function(){if(!Gmail.isConversation()){this._reset()}},_handleConversationLoaded:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}var gmailThread=BB.Services.Threads.ThreadStorer.getGmailThread(hexGmailThreadIdList[0]);if(gmailThread){this._loadThreadTask(gmailThread)}else{this._reset()}},_handleGmailThreadSet:function(notification){if(!Gmail.isConversationVisible()){return}var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}if(notification.hexGmailThreadId!==hexGmailThreadIdList[0]){return}if(notification.value){var gmailThread=notification.value;if(gmailThread){this._loadThreadTask(gmailThread);return}}this._reset()},_loadThreadTask:function(gmailThread){if(this._currentGmailThread&&gmailThread&&gmailThread.key()===this._currentGmailThread.key()){return}this._reset();this._currentGmailThread=gmailThread;this._threadTask=BB.Widgets.ThreadTask.create({gmailThread:gmailThread,trackingContext:{widgetContext:"conversationTaskThreadController"}});Gmail.getConversationSubjectHeader().append(this._threadTask.el)}};Streak.DependencyManager.addFunction({functionKey:"conversationTaskThreadMasterControllerInitialized",functionReference:ConversationTaskThreadMasterController.init,functionContext:ConversationTaskThreadMasterController});BB.Controllers.ConversationTaskThreadMasterController=ConversationTaskThreadMasterController})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,HTML=Streak.HTML,BB=Streak.BentoBox,UI=Streak.UI;var superclass=UI.View;var ThingsView=Streak.Class.subclass({className:"ThingsView",superclass:superclass,_memberVariables:[{name:"_things",destroy:false,defaultValue:[]},{name:"_isLoading",destroy:false,defaultValue:true},{name:"_isEmpty",destroy:false,defaultValue:true},{name:"_openDropdown",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._list=this._element.find(".streak_things_list");this._loading=this._element.find(".streak_things_loading")},_setupElement:function(){this._element=HTML.getElement("things_section")},setAddButton:function(el){this._element.find(".streak_things_add_btn").html(el)},setFilterButton:function(el){this._element.find(".streak_things_type_filter").html(el)},setSortButtons:function(buttons){var $buttons=this._element.find(".streak_things_sort_buttons").empty();_.each(buttons,function(button,i){if(i!=0){$buttons.append(" | ")}$buttons.append(button.getElement())})},setThings:function(things,isLoading,isEmpty){this._things=things;this._isLoading=isLoading;this._isEmpty=isEmpty;this._renderThings()},makeDropdown:function(viewController,anchorEl){if(this._openDropdown){this._openDropdown.destroy();delete this._openDropdown}var el=(viewController.getView?viewController.getView():viewController).getElement();var onClose=viewController.destroy?viewController.destroy.bind(viewController):$.noop;var anchorOffset=$(anchorEl).offset();var thingsOffset=this.getElement().offset();var anchorBottom=anchorOffset.top+$(anchorEl).height();var anchorRight=anchorOffset.left+$(anchorEl).width();var thingsRight=thingsOffset.left+this.getElement().outerWidth();var $container=$("<div/>").addClass("streak__dropdown").css({position:"absolute",top:anchorBottom-thingsOffset.top,right:thingsRight-anchorRight}).html(el).appendTo(this.getElement());var dropdown=this._openDropdown={destroy:function(){$container.unbindBodyCloseAndStop();$container.remove();onClose()}};$container.bodyCloseAndStop({body:document.body,stop:$container,closeFunction:dropdown.destroy.bind(dropdown)});if(viewController.addDelegate){viewController.addDelegate({close:dropdown.destroy.bind(dropdown)})}if(viewController.onShow){viewController.onShow()}},_renderThings:function(){this._list.empty();var self=this;if(!this._isLoading&&!this._things.length){this._things=[{title:BB.Locale.getString(this._isEmpty?"no_contents":"no_contents_match"),type:"NONE",extraCssClasses:["empty_entry"],typeName:BB.Locale.getString("placeholder")}]}_.each(this._things,function(thing,i){var $item=$("<li/>").addClass("streak__thing_item").addClass("streak__thing_type_"+thing.type.replace(/\s/g,"_"));_.each(thing.extraCssClasses,function(classname){$item.addClass("streak__thing_extra_"+classname.replace(/\s/g,"_"))});var $main;if(thing.linkFn){$main=$("<a/>").attr("href",thing.linkHref||"#").click(function(e){e.preventDefault();thing.linkFn.call(thing)})}else if(thing.linkHref){$main=$("<a/>").attr("href",thing.linkHref)}else{$main=$("<span/>")}var $icon=$("<span/>").attr("title",thing.typeName).addClass("streak__thing_icon");if(thing.iconURL){$icon.css({"background-image":"url("+thing.iconURL.replace(/["'\\()]/g,"\\$&")+")","background-size":"16px"})}$main.addClass("streak__thing_main").appendTo($item).append($icon," ");var $title=$("<span/>").addClass("streak__thing_title").appendTo($main);if(thing.titleHTML){$title.html(thing.titleHTML)}else{$title.addClass("streak__thing_title_text").text(thing.title)}if(thing.detail||thing.detailHTML){var $detail=$("<span/>").addClass("streak__thing_detail");if(thing.detailHTML){$detail.html(thing.detailHTML)}else{$detail.text(thing.detail)}$main.append(" ",$detail)}var $right=$("<span/>").addClass("streak__thing_right").appendTo($item);var $actions=$("<span/>").addClass("streak__thing_actions").appendTo($right);_.each(thing.actions,function(action){$actions.append(" ",$("<span/>").addClass("streak__thing_right_item").append($("<a/>").addClass("streak_thing_action").text(action.title).attr("href","#").click(function(e){e.preventDefault();var result=action.fn.call(thing);if(action.dropdown){self.makeDropdown(result,this)}})))});if(thing.date){$right.append(" ",$("<span/>").addClass("streak__thing_right_item").addClass("streak__thing_date").text(new Streak.Date(thing.date).getGmailFormatted()))}self._list.append($item)});this._loading.toggle(this._isLoading)},hide:function(){this._element.hide()}});Library.set("BentoBox.Modules.BoxView.ThingsView",ThingsView)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Gmail=Streak.Gmail,Library=Streak.Library,Locale=Streak.Locale,UI=Streak.UI,BB=Streak.BentoBox,Utils=Streak.Utils,Tracker=BB.Tracker;var superclass=UI.ViewController;var ThingsViewController=Streak.Class.subclass({className:"ThingsViewController",superclass:superclass,_memberVariables:[{name:"_providers",destroy:true,defaultValue:[]},{name:"_thingTypes",destroy:false,defaultValue:{}},{name:"_thingsByType",destroy:false,defaultValue:{}},{name:"_rememberedThingPositions",destroy:false},{name:"_addButtonMenu",destroy:true},{name:"_addMenu",destroy:true},{name:"_filterMenu",destroy:true},{name:"_filterButtonMenu",destroy:true},{name:"_sortButtons",destroy:true},{name:"_filterAllMenuItem",destroy:false}],_initialize:function(box){superclass.prototype._initialize.call(this);var self=this;this._addMenu=BB.Widgets.Menu.create();this._addButtonMenu=BB.Widgets.ButtonMenu.create({menu:this._addMenu.getElement(),buttonInner:BB.Locale.getString("add_to_box"),showButtonArrow:false,rightAligned:true,dynamicPosition:true,color:"red"});this._view.setAddButton(this._addButtonMenu.getElement());this._filterMenu=BB.Widgets.Menu.create();this._filterButtonMenu=BB.Widgets.ButtonMenu.create({buttonInner:_.escape(BB.Locale.getString("view_filter")),menu:this._filterMenu.getElement(),dynamicPosition:true,closeOnSelect:false});this._view.setFilterButton(this._filterButtonMenu.getElement());this._sortButtons={type:BB.Widgets.LinkButton.create({text:_.escape(BB.Locale.getString("fields_button_modal_type")),clickFunction:this._setSortMode.bind(this,"type")}),date:BB.Widgets.LinkButton.create({text:_.escape(BB.Locale.getString("column_type_date")),clickFunction:this._setSortMode.bind(this,"date")})};this._view.setSortButtons([this._sortButtons["type"],this._sortButtons["date"]]);this._setSortMode("type");_.each(ThingsViewController._providerClasses,function(providerClass){var provider=new providerClass(box);self._providers.push(provider);self._defineType(provider);provider.addDelegate({setThings:self._setThingsForType.bind(self,provider.getType())});provider.run(box)})},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.BoxView.ThingsView")},_defineType:function(provider){var settings={type:provider.getType(),name:provider.getName(),orderHint:provider.getOrderHint(),adder:provider.adder?provider.adder.bind(provider):null,adderIsDropdown:provider.getAdderIsDropdown()};if(_.has(this._thingTypes,settings.type)){throw new Error("Things type "+settings.type+" was already defined")}if(typeof settings.name!="string"){throw new Error("Type must have a name set")}settings._filterShow=true;this._thingTypes[settings.type]=settings;this._setupFiltersMenu();this._setupAddersMenu();_.defer(this._render.bind(this))},_setupAddersMenu:function(){this._addMenu.empty();var self=this;_.each(_.sortBy(_.filter(this._thingTypes,function(typeSettings){return!!typeSettings.adder}),"orderHint"),function(typeSettings){self._addMenu.addItem(typeSettings.name,function(e){var result=typeSettings.adder();if(typeSettings.adderIsDropdown){self._view.makeDropdown(result,self._addButtonMenu.getElement())}})})},_setupFiltersMenu:function(){this._filterMenu.empty();var self=this;this._filterAllMenuItem=this._filterMenu.addCheckItem(_.escape(BB.Locale.getString("feed_all_updates")),this._setAllFilter.bind(this),true);this._filterMenu.addSeparator();_.each(_.sortBy(this._thingTypes,"orderHint"),function(thingType){thingType._filterMenuItem=self._filterMenu.addCheckItem(_.escape(thingType.name),self._setTypeFilter.bind(self,thingType.type),thingType._filterShow)})},_setAllFilter:function(enabled){_.each(this._thingTypes,function(thingType){thingType._filterShow=enabled;thingType._filterMenuItem.setCheckboxState(enabled)});delete this._rememberedThingPositions;this._render()},_setTypeFilter:function(type,enabled){this._thingTypes[type]._filterShow=enabled;var allHaveSameSetting=_.every(this._thingTypes,function(thingType){return thingType._filterShow===enabled});this._filterAllMenuItem.setCheckboxState(allHaveSameSetting?enabled:null);delete this._rememberedThingPositions;this._render()},_setThingsForType:function(type,things){if(!this._thingTypes){return}if(!_.has(this._thingTypes,type)){throw new Error("Tried to set things with unknown type "+type)}if(!_.isArray(things)){throw new Error("Things must be an array")}things=_.clone(things);var self=this;_.each(things,function(thing){if(thing.type==null){thing.type=type}else if(thing.type!==type){throw new Error("Thing with type "+thing.type+" was expected to be type "+type)}thing.typeName=self._thingTypes[type].name;if(thing.title==null&&thing.titleHTML==null){throw new Error("Thing is missing title")}if(thing.key==null){throw new Error("Thing is missing key")}thing.key+="";if(!_.isArray(thing.actions)){throw new Error("Thing is missing actions")}});this._thingsByType[type]=things;_.defer(this._render.bind(this))},_setSortMode:function(mode){this._setupSorting(mode);_.defer(this._render.bind(this));_.each(_.without(_.toArray(this._sortButtons),this._sortButtons[mode]),function(button){button.getElement().removeClass("selected")});this._sortButtons[mode].getElement().addClass("selected")},_setupSorting:function(mode){var self=this;delete this._rememberedThingPositions;var byType=Utils.makeComparisonByFn(function(thing){return self._thingTypes[thing.type].orderHint});var byOrderHintOrDate=Utils.reverseComparisonFn(Utils.makeComparisonByFn(function(thing){return thing.orderHint||thing.date}));var byTitle=Utils.makeComparisonByFn("title");var byKey=Utils.makeComparisonByFn("key");var comparisonFns;if(mode=="type"){comparisonFns=[byType,byOrderHintOrDate,byTitle,byKey]}else{comparisonFns=[byOrderHintOrDate,byTitle,byType,byKey]}this._thingCompare=Utils.combineComparisonFns(comparisonFns)},_render:_.throttle(function(){if(!this._view){return}var self=this;var isLoading=_.keys(this._thingTypes).length!==_.keys(this._thingsByType).length;var allThings=Array.prototype.concat.apply([],_.values(this._thingsByType));var isEmpty=allThings.length==0;var things=_.filter(allThings,function(thing){return self._thingTypes[thing.type]._filterShow});if(isLoading){delete this._rememberedThingPositions}else{var thingsPrepend=[];_.each(this._rememberedThingPositions,function(key){for(var i=0;i<things.length;i++){if(things[i].key===key){thingsPrepend.push(things[i]);things.splice(i,1);break}}})}things.sort(this._thingCompare);if(thingsPrepend){things=thingsPrepend.concat(things);this._rememberedThingPositions=_.compact(_.pluck(things,"key"))}this._view.setThings(things,isLoading,isEmpty)},100),setEnabled:function(enabled){this._addButtonMenu.setEnabled(enabled)},destroy:function(){superclass.prototype.destroy.apply(this,arguments)}});ThingsViewController._providerClasses=[];ThingsViewController.registerProviderClass=function(providerClass){this._providerClasses.push(providerClass)};Library.set("BentoBox.Modules.BoxView.ThingsViewController",ThingsViewController)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Gmail=Streak.Gmail,Library=Streak.Library,Locale=Streak.Locale,NotificationCenter=Streak.NotificationCenter,UI=Streak.UI,BB=Streak.BentoBox;
var superclass=UI.Delegator;var CollectionThingProviderBase=Streak.Class.subclass({className:"CollectionThingProviderBase",superclass:superclass,_memberVariables:[{name:"_box",destroy:false},{name:"_collection",destroy:false},{name:"_thingsHandle",destroy:false}],getType:function(){throw new Error("Not implemented")},getName:function(){throw new Error("Not implemented")},getOrderHint:function(){throw new Error("Not implemented")},adder:null,getAdderIsDropdown:function(){return false},_getCollection:function(){throw new Error("Not implemented")},_collectionFilter:function(item){return true},_createThing:function(item){throw new Error("Not implemented")},run:function(box){this._box=box;this._collection=this._getCollection();var updateThingsThrottled=_.throttle(this._updateThings.bind(this),100);this._collection.watch("change",updateThingsThrottled,this);this._updateThings();this._collection.refresh(updateThingsThrottled)},_updateThings:function(){if(!this._box||!this._collection.getHasLoaded()){return}var self=this;var items=_.filter(this._collection,this._collectionFilter.bind(this));this._callDelegateFunction("setThings",_.map(items,this._createThing.bind(this)))},destroy:function(){NotificationCenter.unsubscribe({observer:this});superclass.prototype.destroy.apply(this,arguments)}});Library.set("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase",CollectionThingProviderBase)})(Streak);(function(Streak){"use strict";var _=Streak._,Library=Streak.Library,Locale=Streak.Locale,BB=Streak.BentoBox;var superclass=Library.get("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase");var EmailThingProvider=Streak.Class.subclass({className:"EmailThingProvider",superclass:superclass,_memberVariables:[],_getCollection:function(){return BB.Data.getGmailThreadCollectionForBox(this._box.key())},getType:function(){return"EMAIL"},getName:function(){return BB.Locale.getString("email")},getOrderHint:function(){return 1},_collectionFilter:function(gmailThread){var taskStatus=gmailThread.get("taskStatus");return!(taskStatus=="NOT_DONE_TASK"||taskStatus=="DONE_TASK")},_createThing:function(gmailThread){var self=this;var timestamp=gmailThread.get("lastEmailTimestamp")||gmailThread.get("lastUpdatedTimestamp");var date=timestamp?new Date(timestamp):null;var thing={title:gmailThread.get("subject"),key:gmailThread.key(),detail:(gmailThread.get("names")||["Unknown"]).join(", "),date:date,linkHref:"#"+gmailThread.link(),linkFn:function(){if(BB.isFeatureEnabled("alwaysUnified")){BB.UI.setURL(gmailThread.link());return}if(gmailThread.get("isRequestingUserOwner")){BB.UI.goToThread(gmailThread.get("threadGmailId"))}else if(gmailThread.get("doesRequestingUserHaveThread")){BB.UI.goToThread(gmailThread.get("requestingUserThreadGmailId"))}else{BB.UI.setURL(gmailThread.link())}BB.Tracker.trackStreakActive({eventName:"emailLinkClicked"})},actions:[{title:BB.Locale.getString("make_task"),fn:function(){gmailThread.set("taskStatus","NOT_DONE_TASK");gmailThread.save()}},{title:BB.Locale.getString("remove_from_box"),fn:function(){gmailThread.del()}}]};return thing}});Library.set("BentoBox.Modules.BoxView.ThingProviders.EmailThingProvider",EmailThingProvider);Library.get("BentoBox.Modules.BoxView.ThingsViewController").registerProviderClass(EmailThingProvider)})(Streak);(function(Streak){"use strict";var _=Streak._,Library=Streak.Library,BB=Streak.BentoBox;var superclass=Library.get("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase");var ReminderThingProvider=Streak.Class.subclass({className:"ReminderThingProvider",superclass:superclass,_memberVariables:[],_getCollection:function(){return BB.Data.getReminderCollection(this._box.key())},getType:function(){return"REMINDER"},getName:function(){return BB.Locale.getString("reminder")},getOrderHint:function(){return 4},_createThing:function(reminder){var extraCssClasses=[];if(reminder.get("status")==="REMINDED"){extraCssClasses.push("passed")}var details=_.compact([reminder.get("message"),new Streak.Date(reminder.get("remindDate")).customFormat("shortWithWeekday"),reminder.get("remindFollowers")?BB.Locale.getString("remind_followers"):null]);if(details.length===0)throw new Error("Reminder._createThing is missing all data");var title=details[0];var detail=details.slice(1).join(" - ");var thing={title:title,key:reminder.key(),detail:detail,orderHint:reminder.get("remindDate"),date:null,extraCssClasses:extraCssClasses,actions:[{title:BB.Locale.getString("edit_button"),fn:function(){BB.Tracker.track("contents.reminder.edit",{reminder:reminder.key()});var menu=Library.getInstance("BentoBox.Widgets.ReminderMenuViewController",{reminder:reminder});return menu.getViewControllerForMenu()},dropdown:true},{title:BB.Locale.getString("remove_from_box"),fn:function(){BB.Tracker.track("contents.reminder.delete",{reminder:reminder.key()});reminder.del()}}]};return thing},getAdderIsDropdown:function(){return true},adder:function(){BB.Tracker.track("contents.reminder.add",{boxKey:this._box.key()});var menu=Library.getInstance("BentoBox.Widgets.ReminderMenuViewController",{boxKey:this._box.key()});return menu.getViewControllerForMenu()}});Library.set("BentoBox.Modules.BoxView.ThingProviders.ReminderThingProvider",ReminderThingProvider);Library.get("BentoBox.Modules.BoxView.ThingsViewController").registerProviderClass(ReminderThingProvider)})(Streak);(function(Streak){"use strict";var _=Streak._,Library=Streak.Library,Locale=Streak.Locale,BB=Streak.BentoBox;var superclass=Library.get("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase");var TaskThingProvider=Streak.Class.subclass({className:"TaskThingProvider",superclass:superclass,_memberVariables:[],_getCollection:function(){return BB.Data.getGmailThreadCollectionForBox(this._box.key())},getType:function(){return"TASK"},getName:function(){return BB.Locale.getString("task")},getOrderHint:function(){return 2},_collectionFilter:function(gmailThread){var taskStatus=gmailThread.get("taskStatus");return taskStatus=="NOT_DONE_TASK"||taskStatus=="DONE_TASK"},_createThing:function(gmailThread){var self=this;var timestamp=Math.max(gmailThread.get("lastUpdatedTimestamp")||null,gmailThread.get("lastEmailTimestamp")||null);var date=timestamp?new Date(timestamp):null;var extraCssClasses=[];var actions=[{title:BB.Locale.getString("make_email"),fn:function(){gmailThread.set("taskStatus","NOT_A_TASK");gmailThread.save()}}];if(gmailThread.get("taskStatus")=="DONE_TASK"){extraCssClasses.push("task_done");actions.unshift({title:BB.Locale.getString("mark_incomplete"),fn:function(){gmailThread.set("taskStatus","NOT_DONE_TASK");gmailThread.save()}})}else{actions.unshift({title:BB.Locale.getString("mark_complete"),fn:function(){gmailThread.set("taskStatus","DONE_TASK");gmailThread.save()}})}var thing={title:gmailThread.get("subject"),key:gmailThread.key(),detail:(gmailThread.get("names")||["Unknown"]).join(", "),date:date,linkHref:"#"+gmailThread.link(),linkFn:function(){if(gmailThread.get("isRequestingUserOwner")){BB.UI.goToThread(gmailThread.get("threadGmailId"))}else if(gmailThread.get("doesRequestingUserHaveThread")){BB.UI.goToThread(gmailThread.get("requestingUserThreadGmailId"))}else{BB.UI.setURL(gmailThread.link())}},extraCssClasses:extraCssClasses,actions:actions};return thing}});Library.set("BentoBox.Modules.BoxView.ThingProviders.TaskThingProvider",TaskThingProvider);Library.get("BentoBox.Modules.BoxView.ThingsViewController").registerProviderClass(TaskThingProvider)})(Streak);(function(Streak){"use strict";var _=Streak._,Library=Streak.Library,Locale=Streak.Locale,BB=Streak.BentoBox;var superclass=Library.get("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase");var EmailFilterThingProvider=Streak.Class.subclass({className:"EmailFilterThingProvider",superclass:superclass,_memberVariables:[{name:"_emailFilterListViewController",destroy:true}],_getCollection:function(){if(!this._emailFilterListViewController){this._emailFilterListViewController=new BB.Modules.EmailFilters.EmailFilterViewController({boxKey:this._box.key(),useLinkButtonForNewFilter:false,fetchInfoFromServer:true,suggestionsFromThread:false,modalFromButton:false,trackingContext:{widgetContext:"boxView"}});this._emailFilterListViewController.addDelegate(this)}return this._emailFilterListViewController.getEmailFilters()},getType:function(){return"EMAIL_FILTER"},getName:function(){return BB.Locale.getString("email_filter")},getOrderHint:function(){return 10},_createThing:function(emailFilter){var self=this;var thing={titleHTML:emailFilter.filterDisplayHtml(),key:emailFilter.key(),actions:[{title:BB.Locale.getString("remove"),fn:function(){BB.Tracker.track("things.emailFilter.delete.clicked");self._emailFilterListViewController.removeFilter(emailFilter)}}]};return thing},getAdderIsDropdown:function(){return true},adder:function(){BB.Tracker.track("things.emailFilter.add.clicked");return this._emailFilterListViewController.showCreateFilterDialog()}});Library.set("BentoBox.Modules.BoxView.ThingProviders.EmailFilterThingProvider",EmailFilterThingProvider);Library.get("BentoBox.Modules.BoxView.ThingsViewController").registerProviderClass(EmailFilterThingProvider)})(Streak);(function(Streak){"use strict";var _=Streak._,Library=Streak.Library,Locale=Streak.Locale,BB=Streak.BentoBox;function classForMimeType(mimeType){if(mimeType){if(mimeType.match(/^audio\//)){return"sound"}else if(mimeType.match(/^image\//)){return"image"}else if(mimeType.match(/^application\/(msword|vnd\.openxmlformats-officedocument\.wordprocessingml\.document)/)){return"doc"}else if(mimeType.match(/^application\/vnd\.(ms-excel|openxmlformats-officedocument\.spreadsheetml\.sheet)/)){return"xls"}else if(mimeType.match(/^application\/vnd\.(ms-powerpoint|openxmlformats-officedocument\.presentationml)/)){return"ppt"}else if(mimeType.match(/^application\/pdf/)){return"pdf"}}return null}var superclass=Library.get("BentoBox.Modules.BoxView.ThingProviders.CollectionThingProviderBase");var FileThingProvider=Streak.Class.subclass({className:"FileThingProvider",superclass:superclass,_memberVariables:[{name:"_addDriveFileButton",destroy:true}],_getCollection:function(){return BB.Data.getFileGroup(this._box.key())},getType:function(){return"FILE"},getName:function(){return BB.Locale.getString("file")},getOrderHint:function(){return 3},_createThing:function(file){var self=this;var timestamp=file.get("lastUpdatedTimestamp")||file.get("creationTimestamp");var date=timestamp?new Date(timestamp):null;var detail=file.get("size")||file.get("size")===0?Streak.Utils.fileSizeFormat(+file.get("size")):null;var extraCssClasses=_.compact([classForMimeType(file.get("mimeType"))]);var actions=[];if(file.get("fileType")==="DRIVE"){actions.push({title:BB.Locale.getString("remove_file"),fn:function(){file.del()}})}var thing={title:file.displayName(),key:file.key(),detail:detail,extraCssClasses:extraCssClasses,iconURL:file.get("driveIconUrl")||null,date:date,linkHref:file.link(),actions:actions};return thing},adder:function(){if(!this._addDriveFileButton){this._addDriveFileButton=BB.Widgets.DrivePickerButton.create({box:this._box,_fileCollection:this._collection})}this._addDriveFileButton.el.click()}});Library.set("BentoBox.Modules.BoxView.ThingProviders.FileThingProvider",FileThingProvider);Library.get("BentoBox.Modules.BoxView.ThingsViewController").registerProviderClass(FileThingProvider)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,HTML=Streak.HTML,BB=Streak.BentoBox,UI=Streak.UI;var superclass=Streak.Object;var HIDE_FEED_CLASS="apJ",SHOW_FEED_CLASS="apK";var ShowHideFeedButton=Streak.Class.subclass({className:"ShowHideFeedButton",superclass:superclass,_memberVariables:[{name:"_toggleCallback",destroy:false},{name:"_trackingContext",destroy:false},{name:"_button",destroy:true}],_initialize:function(options){this._toggleCallback=options.toggleCallback;this._trackingContext=options.trackingContext;superclass.prototype._initialize.call(this);this._button=BB.Widgets.Buttons.ButtonFactory.createToggleButton({type:"GmailTextIcon",iconClass:"apH apJ bbIcon",text:BB.Locale.getString("newsfeed"),hasButtonToRight:false,tooltip:BB.Locale.getString("toggle_newsfeed"),noDeactivation:true,isOn:options.startEnabled,onFunction:this._toggleFeed.bind(this,true),offFunction:this._toggleFeed.bind(this,false)});this._button.addClass("apF showHideFeedButton");if(options.css){this._button.getElement().css(options.css)}},getElement:function(){return this._button.getElement()},on:function(){this._button.on()},off:function(){this._button.off()},_styleButton:function(enabled){if(enabled){this._button.changeIconClass("apJ apH bbIcon")}else{this._button.changeIconClass("apK apH bbIcon")}},_toggleFeed:function(enabled){this._styleButton(enabled);this._toggleCallback(enabled)}});Library.set("BentoBox.Modules.BoxView.ShowHideFeedButton",ShowHideFeedButton)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxViewMasterController=Streak.Class.subclass({className:"BoxViewMasterController",superclass:Streak.Object,_memberVariables:[{name:"._activeBoxViewViewController",destroy:true},{name:"_activeBox",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this);BB.Keyboard.bindChord("w,tab",this._keyboardChordTriggered.bind(this));Gmail.observe("viewChanged",this._handleViewChanged.bind(this))},_keyboardChordTriggered:function(){var self=this;setTimeout(function(){if(self._activeBoxViewViewController){self._activeBoxViewViewController.getFocusArea().focus()}},10)},_handleViewChanged:function(){if(this._activeBoxViewViewController){this._activeBoxViewViewController.destroy();this._activeBoxViewViewController=null;this._activeBox=null}if(!BB.UI.isBoxView()){return}var box=BB.Data.getBox(Gmail.getConversationId());if(!box){BB.logError("Box does not exist \nid:"+Gmail.getConversationId());BB.ButterBarManager.showError(BB.Locale.getString("box_not_exist"));BB.UI.setURL("inbox");return}var pipeline=box.getPipeline();if(!pipeline){BB.logError("Pipeline does not exist \nid:"+Gmail.getConversationId());BB.ButterBarManager.showError(BB.Locale.getString("pipeline_not_exist"));BB.UI.setURL("inbox");return}return this._createBoxView(box)},teardown:function(){if(this._activeBoxViewViewController){this._activeBoxViewViewController.destroy();this._activeBoxViewViewController=null;this._activeBox=null}},_createBoxView:function(box){this._activeBoxViewViewController=new BB.Modules.BoxViewViewController(box);var promise=this._activeBoxViewViewController.render();BB.UI.getCanvas().append(this._activeBoxViewViewController.getElement());return promise}});Library.set("BentoBox.Modules.BoxViewMasterController",new BoxViewMasterController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var BoxViewViewController=Streak.Class.subclass({className:"BoxViewViewController",superclass:Streak.Object,_memberVariables:[{name:"_element",destroy:true,get:true},{name:"_box",destroy:false},{name:"_pipeline",destroy:false},{name:"_tabFocusElements",destroy:false},{name:"_fieldInputs",destroy:true,defaultValue:[]},{name:"_columnOrder",destroy:false},{name:"_columnVisibility",destroy:false},{name:"_columns",destroy:false},{name:"_backButton",destroy:true},{name:"_pipelineLink",destroy:true},{name:"_nameTextbox",destroy:true},{name:"_actionButtonMenu",destroy:true},{name:"_actionMenu",destroy:true},{name:"_movePipelinesMenu",destroy:false},{name:"_newFollowerListViewController",destroy:true},{name:"_stageButton",destroy:true},{name:"_notesTextarea",destroy:true},{name:"_assignedToInput",destroy:true},{name:"_feedListViewController",destroy:true},{name:"_feedToggleButton",destroy:true},{name:"_thingsViewController",destroy:true},{name:"_emailPeopleList",destroy:true},{name:"_pipelineLockdownWarning",destroy:true},{name:"_linkedBoxesMenu",destroy:true},{name:"_gmailThreadCollection",destroy:false}],_initialize:function(box){Streak.Object.prototype._initialize.call(this);this._box=box;this._pipeline=box.getPipeline()},render:function(){this._setupElement();this._setupColumnData();this._setupTopBar();this._renderNotes();this._renderStageButton();this._renderAssignedTo();this._renderFeedList();this._renderBoxFields();this._renderEmailPeopleList();this._setupThings();this._setupContactsWatcher();this._setupLinkedBoxes();this._setupWarning();this._bindToEvents();var self=this;return new Streak.Promise(function(resolve,reject){self._box.refresh(resolve)})},_setupElement:function(){this._element=$(HTML.get("boxView")({pipelineName:this._pipeline.displayName()}))},_setupColumnData:function(){this._columnOrder=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(this._pipeline).data;this._columnVisibility=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.load(this._pipeline).data;this._columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(this._pipeline)},_setupTopBar:function(){this._setupBackButton();this._setupPipelineLink();this._setupBoxName();this._setupActionMenu();this._renderFollowers()},_setupBackButton:function(){var backButtonContainer=$(document.createElement("div"));backButtonContainer[0].setAttribute("class","streak__boxView_backButtonContainer");this._backButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailIcon",iconClass:"ar6",onFunction:function(e){BB.Tracker.track("backButtonPressed");history.back()}});backButtonContainer.append(this._backButton.getElement());this._element.find(".bb_top_bar").append(backButtonContainer)},_setupPipelineLink:function(){var self=this;this._pipelineLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:this._pipeline.displayName(),color:"blue",onFunction:function(){BB.Tracker.track("pipelineLinkClicked");BB.UI.setURL(self._pipeline.link())}});this._pipelineLink.addClass("pipelineLink");this._element.find(".bb_top_bar").append(this._pipelineLink.getElement());this._element.find(".bb_top_bar").append(" &raquo; ")},_updatePipelineLink:function(){this._pipelineLink.setText(this._pipeline.displayNameText())},_setupBoxName:function(){this._nameTextbox=BB.Widgets.SmartTextbox.create({model:this._box,property:"name",autoGrow:true});this._element.find(".bb_top_bar").append(this._nameTextbox.getElement())},_setupActionMenu:function(){this._actionMenu=BB.Widgets.Menu.create({css:{overflow:"visible"}});this._actionMenu.addItem(BB.Locale.getString("rename"),this._handleRenameBox.bind(this));this._actionMenu.addItem(BB.Locale.getString("delete"),this._handleDeleteBox.bind(this));this._addMovePipelineActions();this._actionButtonMenu=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"Icon",iconClass:"G-asx",menu:this._actionMenu,isFixedPosition:true});var actionMenuContainer=$(document.createElement("div"));actionMenuContainer[0].setAttribute("class","streak__boxView_actionMenuContainer");actionMenuContainer.append(this._actionButtonMenu.getElement());this._element.find(".bb_top_bar").append(actionMenuContainer)},_handleRenameBox:function(){BB.Tracker.track("renameBox");this._nameTextbox.focus();this._actionButtonMenu.off()},_handleDeleteBox:function(){BB.Tracker.track("deleteBoxClicked");this._actionButtonMenu.off();var self=this;BB.Widgets.Modal.confirmDelete(this._box.displayName(),function(){BB.Tracker.track("deleteBox");BB.UI.setURL(self._box.getPipeline().link());self._box.del()})},_addMovePipelineActions:function(){if(BB.Data.getAllPipelines().length<2){return}var self=this;this._movePipelinesMenu=BB.Widgets.Menu.create();this._addPipelinesToMovePipelinesMenu();this._actionMenu.addSubMenu(BB.Locale.getString("move_box"),this._movePipelinesMenu)},_addPipelinesToMovePipelinesMenu:function(){var self=this;var sortedPipelines=BB.UI.getSortedPipelines();_.each(sortedPipelines,function(pipeline){if(pipeline.key()===self._pipeline.key()){return}self._movePipelinesMenu.addItem(pipeline.displayName(),function(){self._actionButtonMenu.off();BB.MoveBoxHelper.moveBox(self._box,pipeline)})})},_updateMovePipelinesMenu:function(){this._movePipelinesMenu.empty();this._addPipelinesToMovePipelinesMenu()},_renderFollowers:function(){this._newFollowerListViewController=new BB.Widgets.NewFollowerListViewController(this._box);this._element.find(".bb_top_bar").append(this._newFollowerListViewController.getView().getElement())},_renderNotes:function(){this._notesTextarea=BB.Widgets.SmartTextarea.create({model:this._box,property:"notes",border:"alwaysHover",placeholder:BB.Locale.getString("box_view_add_notes"),trackingContext:{widgetContext:"boxView"}});this._notesTextarea.placeholderEl.addClass("d8");this._element.find(".boxNotes").append(this._notesTextarea.getElement());this._element.find(".boxNotesWrap").superEasyHoverClass("RV")},_renderStageButton:function(){var stageContainer=this._element.find(".bb_stages");this._stageButton=BB.Widgets.StageButton.create({pipeline:this._pipeline,box:this._box,trackingContext:{widgetContext:"boxView"}});var field=this._getFieldContainer(BB.Locale.getString("stage"),this._stageButton.getElement());stageContainer.append(field)},_updateStageButton:function(){this._stageButton.destroy();this._element.find(".bb_stages").empty();this._renderStageButton()},_renderAssignedTo:function(){var assignedToContainer=this._element.find(".bbAssignedTo");assignedToContainer.hide();var assignedToColumn=this._pipeline.getSystemColumnByProperty("assignedToSharingEntries");if(_.isNotReal(assignedToColumn)){return}var isVisible=this._columnVisibility["property|"+assignedToColumn.uniqueKey];if(isVisible===false){return}this._assignedToInput=BB.Widgets.SidebarAssignedTo.create({box:this._box,pipeline:this._pipeline,border:"hover",persist:true,imgHeight:20,imgWidth:20,includeNames:true,delayedBind:true,trackingContext:{widgetContext:"boxView"}});var field=this._getFieldContainer(BB.Locale.getString("assignedTo"),this._assignedToInput.getElement());assignedToContainer.append(field);assignedToContainer.show()},_renderFeedList:function(){var self=this;var $sidebar=this._element.find(".streak__box_sidebar");this._feedListViewController=new BB.Widgets.FeedListViewController({model:this._box,usePostWidget:true,closeCallback:function(){self._feedToggleButton.off()}});this._feedToggleButton=Library.getInstance("BentoBox.Modules.BoxView.ShowHideFeedButton",{toggleCallback:function(enabled){BB.LocalSettings.set("boxView/hideFeed",!enabled);if(enabled){$sidebar.show();self._feedListViewController.reconfigureSize()}else{$sidebar.hide()}}});this._element.find(".streak__boxView_actionMenuContainer").after(this._feedToggleButton.getElement());$sidebar.html(this._feedListViewController.getElement());this._feedListViewController.reconfigureSize();if(BB.LocalSettings.get("boxView/hideFeed")){this._feedToggleButton.off()}else{this._feedToggleButton.on()}},_renderBoxFields:function(){this._element.find(".bb_fields *").trigger("unbind");this._element.find(".bb_fields").empty();this._tabFocusElements=[];this._tabFocusElements.push(this._stageButton.getElement().find(".bbButton"));this._tabFocusElements.push(this._notesTextarea.getElement());if(this._assignedToInput){this._tabFocusElements.push(this._assignedToInput.getElement())}for(var i=0;i<this._columnOrder.length;i++){var columnKey=this._columnOrder[i];if(this._columns[columnKey].field){var field=this._renderBoxField(this._columns[columnKey].field.key());this._element.find(".bb_fields").append(field);this._tabFocusElements.push(field.find(".smartInput"))}}this._tabFocusElements.push(null);$.tabChain(this._tabFocusElements)},_renderBoxField:function(index){var pipeField=this._pipeline.getField(index);var field=this._getFieldContainer(pipeField.displayName());var input=BB.Models.BoxField.getBoxViewInputWidget(this._box,pipeField,field.find(".fieldValue"),{widgetContext:"boxView"});this._fieldInputs.push(input);var inputElement=input.getElement?input.getElement():input.el;field.find(".fieldValue").append(inputElement);return field},_getFieldContainer:function(fieldLabel,fieldContent){var field=$(HTML.get("boxViewField")({name:fieldLabel}));if(fieldContent){field.find(".fieldValue").append(fieldContent)}field.superEasyHoverClass("RV");return field},_updateBoxFields:function(){for(var ii=0;ii<this._fieldInputs.length;ii++){this._fieldInputs[ii].destroy()}this._fieldInputs=[];this._renderBoxFields()},_renderEmailPeopleList:function(){this._emailPeopleList=new BB.Widgets.People({trackingContext:{widgetContext:"boxView"}});this._element.find("#streak_email_ppl .streak_email_ppl_list").append(this._emailPeopleList.getElement());this._element.find("#streak_email_ppl .streak__emailAllButton").html(this._emailPeopleList.createEmailAllButton().getElement())},_setupContactsWatcher:function(){this._gmailThreadCollection=BB.Data.getGmailThreadCollectionForBox(this._box.key());var self=this;this._gmailThreadCollection.watch("collectionChange",function(){self._updateEmailContacts()},this);this._updateEmailContacts();this._gmailThreadCollection.refresh()},_setupThings:function(){this._thingsViewController=Streak.Library.getInstance("BentoBox.Modules.BoxView.ThingsViewController",this._box);this._element.find("section.streak_things").replaceWith(this._thingsViewController.getView().getElement());this._thingsViewController.setEnabled(this._box.getIsEditable())},_updateEmailContacts:function(){var contacts=[];for(var i=0;i<this._gmailThreadCollection.length;i++){for(var j=0;j<this._gmailThreadCollection[i].get("emailAddresses").length;j++){contacts.push({email:this._gmailThreadCollection[i].get("emailAddresses")[j],fullName:this._gmailThreadCollection[i].get("names")[j]})}}contacts=_.uniq(contacts,false,function(item){return item.email});contacts=_.sortBy(contacts,function(item){return item.fullName});if(contacts.length===0){this._element.find("#streak_email_ppl").hide();return}this._element.find("#streak_email_ppl").show();this._emailPeopleList.updateDisplay(contacts)},_setupLinkedBoxes:function(){this._renderLinkedBoxesMenu();this._renderLinkedBoxes();this._box.watch("set",this._renderLinkedBoxes,this,"linkedBoxKeys")},_renderLinkedBoxesMenu:function(){this._linkedBoxesMenu=Streak.Library.getInstance("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuViewController");this._linkedBoxesMenu.setEnabled(this._box.getIsEditable());this._element.find(".bb_linked_boxes_search").html(this._linkedBoxesMenu.getView().getElement());var self=this;this._linkedBoxesMenu.addDelegate({boxChosen:function(chosenBox){self._box.addLinkedBox(chosenBox)}})},_renderLinkedBoxes:function(){var boxKeys=this._box.get("linkedBoxKeys")||[];var groupedBoxes;var foundBoxes;var missingBoxCount=0;this._element.find(".streak__boxView_linkedBoxes").empty();var self=this;var stageKeys=_.map(this._box.getPipeline().getStages(),function(stage){return stage.key()});_.chain(boxKeys).map(function(boxKey){var connectedBox=BB.Data.getBox(boxKey);if(connectedBox){return connectedBox}missingBoxCount+=1}).tap(function(intermediateResults){foundBoxes=intermediateResults}).compact().sortBy(function(box){return box.get("lastUpdatedTimestamp")}).sortBy(function(box){return box.displayName()}).sortBy(function(box){return stageKeys.indexOf(box.get("stageKey"))}).groupBy(function(box){return box.getPipeline().key()}).tap(function(intermediateResults){groupedBoxes=intermediateResults}).keys().map(function(pipelineKey){return BB.Data.getPipeline(pipelineKey)}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){self._renderLinkedBoxSection(pipeline,groupedBoxes[pipeline.key()])});this._linkedBoxesMenu.setExcludedBoxKeys(boxKeys.concat([this._box.key()]));this._element.find(".streak__boxView_linkedBoxes_wrapper").show();this._element.find(".streak__boxView_linkedBoxes_empty").hide();this._element.find(".streak__boxView_linkedBoxes").show()},_renderLinkedBoxSection:function(pipeline,boxes){var sectionContainer=$(HTML.get("boxViewConnectedBoxSection")({pipelineName:pipeline.displayName()}));var tableBody=sectionContainer.find("tbody");var stageColors=BB.UI.getStageColors(pipeline);for(var ii=0;ii<boxes.length;ii++){var boxRow=this._renderLinkedBox(boxes[ii],stageColors[boxes[ii].get("stageKey")]);tableBody.append(boxRow)}this._element.find(".streak__boxView_linkedBoxes").append(sectionContainer)},_renderLinkedBox:function(connectedBox,color){var row=HTML.get("boxViewConnectedBoxRow")({boxNameHTML:connectedBox.displayName(),groupcolor:color.backgroundColor,textcolor:color.textColor,boxStageNameHTML:connectedBox.getStageName(),boxDetails:BB.Services.BoxDisplayText.getDetailsText(connectedBox),boxDate:Date.create(connectedBox.get("lastUpdatedTimestamp")).getGmailFormatted()});row=$(row);row.on("click",function(){BB.UI.setURL(connectedBox.link())});var box=this._box;row.find(".streak__boxView_removeLinkedBox").on("click",function(e){box.removeLinkedBox(connectedBox);e.stopPropagation()});return row},_setupWarning:function(){this._pipelineLockdownWarning=new BB.Widgets.PipelineLockdownWarningViewController(this._pipeline);this._element.find(".streak__pipeline_lockdown_warning").html(this._pipelineLockdownWarning.getView().getElement())},_bindToEvents:function(){var self=this;this._box.watch("set",this._handlePipelineChanged,this,"pipelineKey");this._pipeline.watch("set",this._updatePipelineLink,this,"name")},_handlePipelineChanged:function(notification){var newPipelineKey=notification.newValue;this._pipeline=BB.Data.getPipeline(newPipelineKey);this._setupColumnData();this._updatePipelineLink();this._updateMovePipelinesMenu();this._updateStageButton();this._updateBoxFields()},destroy:function(){Streak.Object.prototype.destroy.call(this);NotificationCenter.unsubscribe({observer:this})}});Library.set("BentoBox.Modules.BoxViewViewController",BoxViewViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,HTML=Streak.HTML,Utils=Streak.Utils;var ChatLinker={initialized:false,init:function(cb){var self=this;if(!self.initialized){Gmail.observe("newChatMessage",self.processChatMessage.bind(self));self.initialized=true}if(cb){cb()}},processChatMessage:function(chatMessage){if(chatMessage&&chatMessage.length>0){var titleSpan=chatMessage.find("[title]");if(titleSpan.length>0&&titleSpan[0].title==="streak@mailfoogae.appspotchat.com"){var boldedBoxes=chatMessage.find("b");for(var ii=0;ii<boldedBoxes.length;ii++){var boxName=$(boldedBoxes[ii]).text();var box=this.getBox(boxName);if(box){this.linkify($(boldedBoxes[ii]),box.link())}}}var links=chatMessage.find('a[href*="mail.google.com"]');for(var i=0;i<links.length;i++){var link=$(links[i]);if(this.isBentoboxInternalLink(link)){this.relink(link)}}}},getBox:function(boxName){var boxes=_.filter(BB.Data.getAllBoxes(),function(box){return box.displayName()===boxName});if(boxes.length===1){return boxes[0]}},linkify:function(span,link){var jspan=$(span);var a=jspan.parent();if(!a.is("a")){a=$(document.createElement("a"));a[0].setAttribute("href","#");jspan.before(a);jspan.detach();a.append(jspan);a.click(function(e){BB.UI.setURL(link);e.preventDefault();e.stopPropagation()})}},relink:function(link){if(link.is("a")){var href=link.attr("href");var hash=href.split("#")[1];if(hash){link.click(function(e){BB.UI.setURL(hash);e.preventDefault();e.stopPropagation()})}}},isBentoboxInternalLink:function(link){var href=link.attr("href");var urlNoHash=href.split("#")[0];var hash=href.split("#")[1];if(urlNoHash.indexOf("mail.google.com")==-1||!hash){return false}return BB.UI.isBentoBoxView(Gmail.getStoredView(hash.split("/")))}};Streak.DependencyManager.addFunction({functionKey:"chatLinkerInitialized",functionToCall:ChatLinker.init,functionContext:ChatLinker,dependentFunctionKeys:["gmailLoaded","data.pipelines.initialized","data.boxes.initialized"]});
BB.Modules.ChatLinker=ChatLinker})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Eventer=Streak.Eventer,Model=Streak.Model,Locale=Streak.Locale,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var MailMergeModel=function(){Streak.ViewControllerBase.call(this);this._extractionSettings=null;this._boxes=null;this._pipeline=null;this._emailAddresses=null;this._emailAddressToBoxListMap={};this._emailAddressToRowListMap={};this._templateSubject=null;this._templateBody=null;this._csvFields=null;this._entryDetailModels=[];this._currentlyPreviewedEntryIndex=null;this._isPixelTrackingOn=false;this._usedSnippets=[];this._mailMergeId=null;this._setupStartingExtractionSettings()};MailMergeModel.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergeModel.prototype,{getExtractionSettingValue:function(categoryKey,settingKey){return this._extractionSettings[categoryKey][settingKey]},updateExtractionSettingValue:function(categoryKey,settingKey,settingValue,noSave){this._extractionSettings[categoryKey][settingKey]=settingValue;if(!noSave){BB.LocalSettings.set("mailMerge/extractionSettings/"+categoryKey+"/"+settingKey,settingValue)}},setPipeline:function(pipeline){this._pipeline=pipeline},setCSVFields:function(csvFields){this._csvFields=csvFields},clearChosenEmails:function(){for(var ii=0;ii<this._entryDetailModels.length;ii++){this._entryDetailModels[ii].destroy()}this._entryDetailModels.length=0},getPipeline:function(){return this._pipeline},setBoxes:function(boxes){this._boxes=boxes},getBoxes:function(){return this._boxes},setEmailAddresses:function(emailAddresses){this._emailAddresses=emailAddresses},setEmailAddressToBoxListMap:function(boxListMap){this._emailAddressToBoxListMap=boxListMap},setEmailAddressToRowListMap:function(rowListMap){this._emailAddressToRowListMap=rowListMap},getNumberOfBoxesSelected:function(){if(this.isUsingCSVFile()){return 0}if(this._entryDetailModels.length===0){if(!this._boxes){return 0}return this._boxes.length}var uniqueBoxes=[];for(var ii=0;ii<this._entryDetailModels.length;ii++){if(this._entryDetailModels[ii].isIncludedInMailMerge()){uniqueBoxes.push(this._entryDetailModels[ii].getBoxes())}}return _.chain(uniqueBoxes).flatten().uniq().value().length},getNumberOfEmailsExtracted:function(){if(this._entryDetailModels.length===0){if(!this._emailAddresses){return 0}return this._emailAddresses.length}return _.filter(this._entryDetailModels,function(entryDetailModel){return entryDetailModel.isIncludedInMailMerge()}).length},getExtractionSettings:function(){return this._extractionSettings},getEntryDetailModel:function(entryIndex){if(this._entryDetailModels[entryIndex]){return this._entryDetailModels[entryIndex]}var email=this._emailAddresses[entryIndex];var entryDetailModel=new BB.Modules.MailMergeEntryDetailModel;entryDetailModel.setEntryIndex(entryIndex);entryDetailModel.setEmail(email);entryDetailModel.setBoxes(this._emailAddressToBoxListMap[email]);entryDetailModel.setOtherFieldObjects(this._emailAddressToRowListMap[email]);entryDetailModel.setParentModel(this);this._entryDetailModels[entryIndex]=entryDetailModel;return entryDetailModel},setTemplateSubject:function(subject,body){if(this.isAnEntryBeingPreviewed()){return}if(this.isEntryDetailBeingEdited()){this.getCurrentlyEditedEntryDetail().setOverwrittenEmailTemplateSubject(subject);this.getCurrentlyEditedEntryDetail().setOverwrittenEmailTemplateBody(body);return}this._templateSubject=subject;this._findReferencedFields();this._updateEntryDetailModels()},setTemplateBody:function(body,subject){if(this.isAnEntryBeingPreviewed()){return}if(this.isEntryDetailBeingEdited()){this.getCurrentlyEditedEntryDetail().setOverwrittenEmailTemplateBody(body);this.getCurrentlyEditedEntryDetail().setOverwrittenEmailTemplateSubject(subject);return}this._templateBody=body;this._findReferencedFields();this._updateEntryDetailModels()},isEntryDetailBeingEdited:function(){return!!this.getCurrentlyEditedEntryDetail()},getFieldList:function(){if(this._pipeline){return _.map(BB.UI.getPipelineColumnList(this._pipeline,this._pipeline.getActiveSystemColumns()),function(column){return column.name})}if(this._csvFields){return this._csvFields}},getCurrentlyEditedEntryDetail:function(){var currentlyEdited=_.filter(this._entryDetailModels,function(entryDetailModel){return entryDetailModel.isCurrentlyEditing()});if(currentlyEdited.length>0){return currentlyEdited[0]}},getCurrentSubject:function(){if(this.isEntryDetailBeingEdited()){return this.getCurrentlyEditedEntryDetail().getTemplateSubject()}if(_.isReal(this._currentlyPreviewedEntryIndex)){return this._entryDetailModels[this._currentlyPreviewedEntryIndex].getTemplateSubject()}return this.getTemplateSubject()},getCurrentBody:function(){if(this.isEntryDetailBeingEdited()){return this.getCurrentlyEditedEntryDetail().getTemplateBody()}if(_.isReal(this._currentlyPreviewedEntryIndex)){return this._entryDetailModels[this._currentlyPreviewedEntryIndex].getTemplateBody()}return this.getTemplateBody()},getTemplateSubject:function(){return this._templateSubject},getTemplateBody:function(){return this._templateBody},getEntryDetailModels:function(){return this._entryDetailModels},getReferencedFields:function(){return this._referencedFields},getReverseColumnLookupTable:function(){return this._reverseColumnLookupTable},setPreviewedEntryIndex:function(entryIndex){this._callDelegateFunction("previewedEntryAboutToChange");this._currentlyPreviewedEntryIndex=entryIndex;this._callDelegateFunction("previewedEntryChanged")},entryRestored:function(){this._callDelegateFunction("previewedEntryChanged")},markEmailSent:function(entryIndex){this._entryDetailModels[entryIndex].setNotIncludedInMailMerge()},editingEntryIndexAboutToModify:function(){},editingEntryIndexModified:function(){this._callDelegateFunction("editedEntryChanged")},currentlyEditingEntryDetailChanged:function(){this._callDelegateFunction("editedEntryChanged")},isAnEntryBeingPreviewed:function(){return!this.isEntryDetailBeingEdited()&&_.isReal(this._currentlyPreviewedEntryIndex)},isPixelTracked:function(){return this._isPixelTrackingOn},setPixelTrackingStatus:function(status){this._isPixelTrackingOn=status},includedEmailsModified:function(){this._callDelegateFunction("includedEmailsModified")},snippetAdded:function(snippet){this._usedSnippets.push(snippet)},getSnippetKeyList:function(){return _.map(this._usedSnippets,function(snippet){return snippet.key()})},getMailMergeId:function(){if(!this._mailMergeId){this._mailMergeId=Streak.guid()}return this._mailMergeId},isUsingCSVFile:function(){return!!this._csvFields},getErrors:function(){if(!this._entryDetailModels||this._entryDetailModels.length===0){return["NO_EMAIL_ADDRESSES"]}return _.chain(this._entryDetailModels).filter(function(entryDetailModel){return entryDetailModel.isIncludedInMailMerge()}).map(function(entryDetailModel){return entryDetailModel.getErrors()}).compact().flatten().value()},_findReferencedFields:function(){this._referencedFields=BB.Services.TemplateProcessor.findReferencedFields(this._pipeline,this._templateSubject,this._templateBody)},_updateEntryDetailModels:function(){for(var ii=0;ii<this._entryDetailModels.length;ii++){this._entryDetailModels[ii].update()}},_setupStartingExtractionSettings:function(){this._loadDefaultExtractionSettings();this._loadSavedExtractionSettings()},_loadDefaultExtractionSettings:function(){this._extractionSettings={extractEmailsFrom:{threads:true,assignedTo:false,columns:true},ignoreEmails:{myself:true,org:BB.Constants.EMAIL_BLACK_LIST.indexOf(BB.getUser().getDomain().toLowerCase())===-1}}},_loadSavedExtractionSettings:function(){var savedExtractionSettings=BB.LocalSettings.get("mailMerge/extractionSettings");if(!savedExtractionSettings){return}this._updateWithSavedExtractionSetting("extractEmailsFrom","threads",savedExtractionSettings);this._updateWithSavedExtractionSetting("extractEmailsFrom","assignedTo",savedExtractionSettings);this._updateWithSavedExtractionSetting("extractEmailsFrom","columns",savedExtractionSettings);this._updateWithSavedExtractionSetting("ignoreEmails","myself",savedExtractionSettings);this._updateWithSavedExtractionSetting("ignoreEmails","org",savedExtractionSettings)},_updateWithSavedExtractionSetting:function(categoryKey,settingKey,savedExtractionSettings){var value;if(savedExtractionSettings[categoryKey]){if(_.isReal(savedExtractionSettings[categoryKey][settingKey])){value=savedExtractionSettings[categoryKey][settingKey]}}if(_.isReal(value)){this._extractionSettings[categoryKey][settingKey]=value}}});BB.Modules.MailMergeModel=MailMergeModel})(Streak);(function(Streak){var Library=Streak.Library,$=Streak.jQuery,Gmail=Streak.Gmail,Locale=Streak.Locale,BB=Streak.BentoBox,HTML=Streak.HTML,_=Streak._;var MailMergeController=Streak.Class.subclass({superclass:Library.get("BentoBox.Modules.ComposeViewControllerBase"),_memberVariables:[{name:"_stateManager",destroy:true},{name:"_mailMergeBoxChooserViewController",destroy:true},{name:"_mailMergeModel",destroy:true},{name:"_mailMergeSenderViewController",destroy:true},{name:"_clearAttachmentsModal",destroy:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);this._setupStateManager();this._setupMailMergeModel()},initialize:function(composeWindowController){this._composeWindowController=composeWindowController},shouldProcessModification:function(){return false},getListenerType:function(){return null},canStartMailMerge:function(){return this._stateManager.canStartMailMerge()},isChoosingPipelineOrImportCSV:function(){return this._stateManager.isChoosingPipelineOrImportCSV()},startLinkClicked:function(){this._stateManager.startLinkClicked()},pipelineChosen:function(pipeline){this._mailMergeModel.setPipeline(pipeline);this._mailMergeModel.clearChosenEmails();this._stateManager.pipelineChosen()},boxesChosen:function(){this._stateManager.boxesChosen()},loadEditTemplateState:function(){Gmail.unhideComposeLayer();if(!this._composeWindowController){Gmail.GmailComposeWindowRequester.requestNewComposeWindow()}this._destroyBoxChooser()},mailMergeStateChanged:function(){this._callDelegateFunction("mailMergeStateChanged")},isWaitingForCompose:function(){return!this._composeWindowController&&this._stateManager.isEditTemplate()},shouldShowSidebar:function(){return this._stateManager.shouldShowSidebar()},cancel:function(){this._stateManager.cancel();BB.Modules.MailMergeMasterController.mailMergeCancelled(this);this._destroyBoxChooser();if(this._composeWindowController){this._composeWindowController.setModuleInactive("mailMerge");this._composeWindowController.notify("mailMergeCancelled")}},doneCancelling:function(){if(this._composeWindowController){this._composeWindowController.unhide()}Gmail.unhideComposeLayer()},setPreviewedEntryIndex:function(entryIndex){this._mailMergeModel.setPreviewedEntryIndex(entryIndex)},getMailMergeModel:function(){return this._mailMergeModel},shouldNotSend:function(){return this.shouldShowSidebar()},sendCancelled:function(){if(!this._stateManager.isMailMergeActive()){return}if(this._mailMergeModel.getErrors().length>0){this._showErrorModal();return}this._stateManager.startSending()},_showErrorModal:function(){var errors=_.uniq(this._mailMergeModel.getErrors());var inner=$(document.createElement("div"));inner[0].innerHTML=HTML.getString("mailMergeErrors");var ul=$(document.createElement("ul"));for(var ii=0;ii<errors.length;ii++){ul.append("<li>"+BB.Locale.getString("mail_merge_"+errors[ii].toLowerCase())+"</li>")}inner.append(ul);var modal=BB.Widgets.Modal.create({title:BB.Locale.getString("mail_merge_blocking_errors_title"),inner:inner,showCancel:false,confirmText:BB.Locale.getString("ok")});modal.show()},startSending:function(){this._composeWindowController.hide();this._mailMergeSenderViewController=Library.getInstance("BentoBox.Modules.MailMergeSenderViewController");this._mailMergeSenderViewController.setDataSource(this.getMailMergeModel());this._mailMergeSenderViewController.setDelegate(this);this._mailMergeSenderViewController.startSending()},finishedSending:function(){this._composeWindowController.unhide();this._composeWindowController.discard()},allModificationsInitialized:function(){if(this.shouldShowSidebar()){this._composeWindowController.setModuleActive("mailMerge");this._composeWindowController.notify("mailMergeActive")}},activeModulesChanged:function(activeModules){this._stateManager.unblocked();if(activeModules.indexOf("sendLater")>-1){this._stateManager.blocked()}if(activeModules.indexOf("threadBox")>-1){this._stateManager.blocked()}if(activeModules.indexOf("bumpLater")>-1){this._stateManager.blocked()}},snippetAdded:function(snippet){this._mailMergeModel.snippetAdded(snippet)},pixelTrackingOn:function(){this._mailMergeModel.setPixelTrackingStatus(true)},pixelTrackingOff:function(){this._mailMergeModel.setPixelTrackingStatus(false)},includedEmailsModified:function(){this._callDelegateFunction("includedEmailsModified")},newAttachmentAdded:function(){if(!this._stateManager.isMailMergeActive()){return}if(this._clearAttachmentsModal){return}this._showClearAttachmentsModal()},_showClearAttachmentsModal:function(){var self=this;this._clearAttachmentsModal=BB.Widgets.Modal.confirm(BB.Locale.getString("mm_attachment_found_title"),BB.Locale.getString("mm_attachment_found_message"),function(){self._composeWindowController.clearAttachments();BB.Tracker.track("mail merge attachments cleared");self._clearAttachmentsModal=null},function(){self.cancel();self._clearAttachmentsModal=null})},_setupStateManager:function(){this._stateManager=new BB.Modules.MailMergeStateManager;this._stateManager.setMailMergeController(this)},_setupMailMergeModel:function(){this._mailMergeModel=new BB.Modules.MailMergeModel;this._mailMergeModel.addDelegate(this)}});_.extend(MailMergeController.prototype,{loadBoxChooser:function(){if(!this._areWeInPipeline()){this._loadPipelineViewAndCreateBoxChooser()}else{this._createBoxChooser()}},_areWeInPipeline:function(){return Gmail.getConversationId()===this._mailMergeModel.getPipeline().key()},_loadPipelineViewAndCreateBoxChooser:function(){var self=this;BB.UI.setURL(this._mailMergeModel.getPipeline().link(),function(){self._createBoxChooser()})},_createBoxChooser:function(){Gmail.hideComposeLayer();this._mailMergeBoxChooserViewController=new BB.Modules.MailMergeBoxChooserViewController;this._mailMergeBoxChooserViewController.setMailMergeController(this);this._mailMergeBoxChooserViewController.setDataSource(this._mailMergeModel)},_destroyBoxChooser:function(){if(!this._mailMergeBoxChooserViewController){return}this._mailMergeBoxChooserViewController.destroy();this._mailMergeBoxChooserViewController=null},updateExtractionSettingValue:function(categoryKey,settingKey,settingValue){this._mailMergeModel.updateExtractionSettingValue(categoryKey,settingKey,settingValue);this._updateEmailExtractionFromBoxes()},updateBoxesChosen:function(boxes){this._mailMergeModel.setBoxes(boxes);this._updateEmailExtractionFromBoxes()},_updateEmailExtractionFromBoxes:function(){var extractionSettings=this._mailMergeModel.getExtractionSettings();var boxes=this._mailMergeModel.getBoxes();var extracted=BB.Services.EmailAddressExtractor.extractEmailAddressesFromBoxes(extractionSettings,boxes);this._mailMergeModel.setEmailAddresses(extracted.emailAddresses);this._mailMergeModel.setEmailAddressToBoxListMap(extracted.emailAddressToBoxListMap);if(this._mailMergeBoxChooserViewController){this._mailMergeBoxChooserViewController.statsChanged()}},updateCSVRows:function(csvRows){var fields=_.keys(csvRows[0]);this._mailMergeModel.setCSVFields(fields);var extracted=BB.Services.EmailAddressExtractor.extractEmailAddressesFromCSVRows(csvRows);this._mailMergeModel.setEmailAddresses(extracted.emailAddresses);this._mailMergeModel.setEmailAddressToRowListMap(extracted.emailAddressToRowListMap);this._stateManager.csvUploaded()}});_.extend(MailMergeController.prototype,{getNumberOfEmailsExtracted:function(){return this._mailMergeModel.getNumberOfEmailsExtracted()},getEntryDetailModel:function(entryIndex){return this._mailMergeModel.getEntryDetailModel(entryIndex)}});BB.Modules.MailMergeController=MailMergeController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox,_=Streak._;var MailMergeMasterController=function(){Gmail.GmailComposeManager.registerModifierModule(this);this._pipelineStartedMailMergeController=null};_.extend(MailMergeMasterController.prototype,{GMAIL_MAX_EMAILS_OUT:50,APPS_MAX_EMAILS_OUT:200,DELAY_BETWEEN_EMAILS:5*1e3,_mailMergeModel:null,getViewControllers:function(){var mailMergeController;if(this._pipelineStartedMailMergeController&&this._pipelineStartedMailMergeController.isWaitingForCompose()){mailMergeController=this._pipelineStartedMailMergeController;this._pipelineStartedMailMergeController=null}else{mailMergeController=new BB.Modules.MailMergeController}var mailMergeComposeStartLinkViewController=new BB.Modules.MailMergeComposeStartLinkViewController;mailMergeComposeStartLinkViewController.setDataSource(mailMergeController);var mailMergePipelineChooserCSVImporter=new BB.Modules.MailMergePipelineChooserCSVImporterViewController;mailMergePipelineChooserCSVImporter.setDelegate(mailMergeController);mailMergePipelineChooserCSVImporter.setDataSource(mailMergeController.getMailMergeModel());var mailMergeSidebarViewController=new BB.Modules.MailMergeSidebarViewController;mailMergeSidebarViewController.setDataSource(mailMergeController);mailMergeSidebarViewController.setDelegate(mailMergeController);var mailMergeContentManagerViewController=new BB.Modules.MailMergeContentManagerViewController;mailMergeContentManagerViewController.setDataSource(mailMergeController.getMailMergeModel());mailMergeContentManagerViewController.setDelegate(mailMergeController);var mailMergeInsertTagViewController=new BB.Modules.MailMergeInsertTagViewController;mailMergeInsertTagViewController.setDataSource(mailMergeController.getMailMergeModel());mailMergeInsertTagViewController.setDelegate(mailMergeController);var mailMergeStatsViewController=Streak.Library.getInstance("BentoBox.Modules.MailMergeSendStatsViewController");mailMergeStatsViewController.setDataSource(mailMergeController.getMailMergeModel());mailMergeStatsViewController.setDelegate(mailMergeController);mailMergeController.addDelegate(mailMergeComposeStartLinkViewController);mailMergeController.addDelegate(mailMergePipelineChooserCSVImporter);mailMergeController.addDelegate(mailMergeInsertTagViewController);mailMergeController.addDelegate(mailMergeContentManagerViewController);mailMergeController.addDelegate(mailMergeSidebarViewController);mailMergeController.addDelegate(mailMergeStatsViewController);return[mailMergeComposeStartLinkViewController,mailMergePipelineChooserCSVImporter,mailMergeSidebarViewController,mailMergeContentManagerViewController,mailMergeInsertTagViewController,mailMergeStatsViewController,mailMergeController]},startMailMergeFromPipelineView:function(pipeline,boxes){this._pipelineStartedMailMergeController=new BB.Modules.MailMergeController;this._pipelineStartedMailMergeController.pipelineChosen(pipeline);this._pipelineStartedMailMergeController.updateBoxesChosen(boxes)},mailMergeCancelled:function(mailMergeController){if(this._pipelineStartedMailMergeController===mailMergeController){this._pipelineStartedMailMergeController=null}}});Streak.DependencyManager.addFunction({functionKey:"mailMergeMasterControllerInitialized",functionToCall:function(callback){BB.Modules.MailMergeMasterController=new MailMergeMasterController;if(callback){callback()}},dependentFunctionKeys:["data.pipelines.initialized","data.boxes.initialized","gmailLoaded","htmlLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeComposeStartLinkViewController=Streak.Class.subclass({superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_element",destroy:true},{name:"_dataSource",destroy:false,set:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);return this},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._generateLink()},shouldProcessModification:function(){return this._dataSource.canStartMailMerge()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"EXTRA_RECIPIENTS"},getModificationElement:function(){return this._element},_generateLink:function(){var self=this;this._element=HTML.get("mm_main_button",true);this._element.on("click",function(e){self._startLinkClicked();BB.Tracker.track("mail merge started",{method:"to area link"})})},_startLinkClicked:function(){if(this._composeWindowViewController.hasAttachments()){this._askToClearAttachments();return}this._composeWindowViewController.setModuleActive("mailMerge");this._composeWindowViewController.notify("mailMergeActive");this._dataSource.startLinkClicked()},_askToClearAttachments:function(){var self=this;BB.Widgets.Modal.confirm(BB.Locale.getString("mm_attachment_found_title"),BB.Locale.getString("mm_attachment_found_message"),function(){self._composeWindowViewController.clearAttachments();self._waitForAttachmentsToClearAndNotify();BB.Tracker.track("mail merge attachments cleared")})},_waitForAttachmentsToClearAndNotify:function(){var self=this;setTimeout(function(){self._composeWindowViewController.setModuleActive("mailMerge");self._composeWindowViewController.notify("mailMergeActive");self._dataSource.startLinkClicked()},200)},mailMergeStateChanged:function(){this._composeWindowViewController.reloadModification(this)}});BB.Modules.MailMergeComposeStartLinkViewController=MailMergeComposeStartLinkViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeStateManager=function(){this._mailMergeController=null;this._stateMachine=null;this._setupStateMachine()};_.extend(MailMergeStateManager.prototype,{_setupStateMachine:function(){var self=this;this._stateMachine=new Streak.StateMachine.create({initial:"start",events:[{name:"startLinkClicked",from:["start"],to:"choosePipelineImportCSV"},{name:"blocked",from:["start"],to:"currentlyBlocked"},{name:"unblocked",from:["currentlyBlocked"],to:"start"},{name:"pipelineChosen",from:["choosePipelineImportCSV","editTemplate","start"],to:"chooseBoxes"},{name:"boxesChosen",from:["chooseBoxes"],to:"editTemplate"},{name:"csvUploaded",from:["choosePipelineImportCSV"],to:"editTemplate"},{name:"startSending",from:["editTemplate"],to:"sendingEmails"},{name:"cancel",from:["chooseBoxes","editTemplate","choosePipelineImportCSV"],to:"start"},{name:"cancel",from:["sendingEmails"],to:"editTemplate"}],callbacks:{onchangestate:function(){if(self._mailMergeController){self._mailMergeController.mailMergeStateChanged()}},oneditTemplate:function(){self._mailMergeController.loadEditTemplateState()},onchooseBoxes:function(){self._mailMergeController.loadBoxChooser()},onsendingEmails:function(){self._mailMergeController.startSending()},onaftercancel:function(){self._mailMergeController.doneCancelling()}}})},setMailMergeController:function(mailMergeController){this._mailMergeController=mailMergeController},startLinkClicked:function(){this._stateMachine.startLinkClicked()},blocked:function(){this._stateMachine.blocked()},unblocked:function(){this._stateMachine.unblocked()},boxesChosen:function(){this._stateMachine.boxesChosen()},pipelineChosen:function(){this._stateMachine.pipelineChosen()},csvUploaded:function(){this._stateMachine.csvUploaded()},startSending:function(){this._stateMachine.startSending()},cancel:function(){this._stateMachine.cancel()},canStartMailMerge:function(){return this._stateMachine.is("start")},isChoosingPipelineOrImportCSV:function(){return this._stateMachine.is("choosePipelineImportCSV")},isSendingEmails:function(){return this._stateMachine.is("sendingEmails")},shouldShowSidebar:function(){return this._stateMachine.is("editTemplate")},isEditTemplate:function(){return this._stateMachine.is("editTemplate")},isMailMergeActive:function(){return!this._stateMachine.is("start")&&!this._stateMachine.is("currentlyBlocked")},destroy:function(){this._stateMachine=null}});BB.Modules.MailMergeStateManager=MailMergeStateManager})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergePipelineChooserCSVImporterView=function(){Streak.ViewControllerBase.call(this);this._element=null;this._setupUIElements()};MailMergePipelineChooserCSVImporterView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergePipelineChooserCSVImporterView.prototype,{_setupUIElements:function(){this._element=HTML.get("MM_ButtonArea",true);this._element.find(".streak__mailMerge_chooseOr").hide();this._element.find(".streak__mailMerge_selectedNotice").hide();this._element.find(".streak__mailMerge_chooseBoxes").hide()},getElement:function(){return this._element},setPipelineChooser:function(pipelineChooser){pipelineChooser.getElement().css({display:"inline-block"});this._element.find(".streak__mailMerge_pipelineChooser").prepend(pipelineChooser.getElement());this._element.find(".streak__mailMerge_chooseOr").show()},setChooseBoxesLink:function(chooseBoxesLink){this._element.find(".streak__mailMerge_chooseBoxes").append(chooseBoxesLink.getElement());chooseBoxesLink.getElement().addClass("__streak_MM_chooseBoxes")},setImportCSVButton:function(importCSVButton){this._element.find(".streak__mailMerge_csvInput").append(importCSVButton.getElement())},setImportCSVFileInput:function(importCSVFileInput){this._element.find(".streak__mailMerge_csvInput").append(importCSVFileInput);importCSVFileInput.hide()},showChooseBoxesLink:function(){this._element.find(".streak__mailMerge_chooseBoxes").show()},showSelectedNotice:function(){this._element.find(".streak__mailMerge_selectedNotice").show()},hideCSVImport:function(){this._element.find(".streak__mailMerge_csvInput").hide();this._element.find(".streak__mailMerge_chooseOr").hide()},setCancelLink:function(cancelLink){this._element.find(".streak__mailMerge_chooser_cancel").html(cancelLink.getElement())},destroy:function(){this._element.remove();Streak.ViewControllerBase.prototype.destroy.call(this)}});BB.Modules.MailMergePipelineChooserCSVImporterView=MailMergePipelineChooserCSVImporterView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergePipelineChooserCSVImporterViewController=Streak.Class.subclass({superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_pipelineChooser",destroy:true},{name:"_importCSVButton",destroy:true},{name:"_importCSVFileInput",destroy:true},{name:"_cancelLink",destroy:true},{name:"_currentPipeline",destroy:false},{name:"_dataSource",destroy:false,set:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);return this},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){return this._delegate.isChoosingPipelineOrImportCSV()},aboutToProcessModification:function(){if(!this._view){this._setupTheView()}},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"RECIPIENTS_OVERLAY"},getModificationHeight:function(){return"65px"},getModificationElement:function(){if(!this._view){return null}return this._view.getElement()},mailMergeStateChanged:function(){this._composeWindowViewController.reloadModification(this)},_setupView:function(){},_setupTheView:function(){this._view=new BB.Modules.MailMergePipelineChooserCSVImporterView;this._setupInputs()},_setupInputs:function(){if(BB.Data.getAllPipelines().length>0){this._setupPipelineChooser();this._setupChooseBoxesLink()}this._setupCSVImport();this._setupCancelLink()},_setupPipelineChooser:function(){var self=this;this._pipelineChooser=BB.Widgets.ButtonCustomDropdown.create({unselectedDisplayText:BB.Locale.getString("mm_choose_pipeline"),list:_.map(BB.Data.getAllPipelines(),function(_pipeline){return{name:_pipeline.displayName(),value:_pipeline}}),trackingContext:{widgetContext:"mm_pipelineChooser"},changeFunc:function(newItem){self._pipelineChosen(newItem.value)}});this._pipelineChooser.deselect();this._view.setPipelineChooser(this._pipelineChooser)},_pipelineChosen:function(pipeline){this._currentPipeline=pipeline;this._view.hideCSVImport();this._view.showChooseBoxesLink();this._view.showSelectedNotice()},_setupChooseBoxesLink:function(){var self=this;this._chooseBoxesLink=BB.Widgets.LinkButton.create({text:BB.Locale.getString("mm_choose_boxes_2"),clickFunction:function(){self._delegate.pipelineChosen(self._currentPipeline);BB.Tracker.track("mail merge pipeline chosen")}});this._view.setChooseBoxesLink(this._chooseBoxesLink)},_setupCSVImport:function(){var self=this;this._importCSVFileInput=$('<input type="file" accept="text/csv, text/txt">');this._importCSVFileInput[0].addEventListener("change",this._csvUploaded.bind(this),false);this._view.setImportCSVFileInput(this._importCSVFileInput);this._importCSVButton=BB.Widgets.LinkButton.create({text:BB.Locale.getString("mm_upload_csv"),clickFunction:function(e){self._importCSVFileInput.simulateRawClick();BB.Tracker.track("mail merge csv file window open")}});this._view.setImportCSVButton(this._importCSVButton)},_csvUploaded:function(event){var self=this;event.stopPropagation();event.preventDefault();var files=event.target.files||event.dataTransfer.files;var file=files[0];var fileReader=new FileReader;fileReader.onload=function(){self._processCSVData(fileReader.result);BB.Tracker.track("mail merge csv file uploaded")};fileReader.onerror=function(){self._showCSVError()};fileReader.readAsText(file,"UTF-8")},_processCSVData:function(csvData){var csvRows=null;try{csvRows=Streak.csvParser.parse(csvData)}catch(err){this._showCSVError();return}this._delegate.updateCSVRows(csvRows)},_showCSVError:function(){BB.Widgets.Modal.create({title:BB.Locale.getString("mm_error_csv_title"),inner:BB.Locale.getString("mm_error_csv_message"),confirmText:BB.Locale.getString("ok"),showCancel:false}).show();BB.Tracker.track("mail merge import CSV error")},_setupCancelLink:function(){var self=this;this._cancelLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("cancel"),onFunction:function(){self._delegate.cancel();BB.Tracker.track("mail merge cancelled",{stage:"pipeline chooser"})}});this._view.setCancelLink(this._cancelLink)},destroy:function(){this._composeWindowViewController=null;if(this._view){this._view.destroy()}if(this._pipelineChooser){this._pipelineChooser.destroy()}if(this._importCSVButton){this._importCSVButton.destroy()}}});BB.Modules.MailMergePipelineChooserCSVImporterViewController=MailMergePipelineChooserCSVImporterViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeBoxChooserView=function(){Streak.ViewControllerBase.call(this);this._yellowBar=null;this._innerYellowBar=null;this._clickBlockOverlay=null;this._setupYellowBar();this._setupClickBlockOverlay()};MailMergeBoxChooserView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergeBoxChooserView.prototype,{_setupYellowBar:function(){var self=this;this._setupInnerYellowBar();
this._yellowBar=BB.Widgets.Tour.Bar.create({html:this._innerYellowBar,rightButtonText:BB.Locale.getString("continue_with_mail_merge"),showLink:true,customClasses:"__streak_MM_Chooser",cancelFunc:function(){self._callDelegateFunction("cancelClicked")},showLeftButton:false,rightButtonFunction:function(){self._callDelegateFunction("continueClicked")}});this._yellowBar.show()},_setupInnerYellowBar:function(){this._innerYellowBar=HTML.get("mailMergeBarHTML",true)},_setupClickBlockOverlay:function(){var self=this;this._clickBlockOverlay=BB.Widgets.Tour.Highlight.create({targetElement:$(".pv_container"),backgroundOpacity:0,clickCallback:function(){self._callDelegateFunction("cancelClicked")}});this._clickBlockOverlay.show()},setExtractionSettingsMenuButton:function(menuButton){this._innerYellowBar.find(".__streak_MM_extractingFrom .__streak_buttonPosition").prepend(menuButton.getElement())},setBoxesSelectedCount:function(count){this._innerYellowBar.find(".__streak_MM_boxesExtracted").html(count)},setEmailsExtractedCount:function(count){this._innerYellowBar.find(".__streak_MM_emaislExtracted").html(count)},showExtractionLineSettings:function(){this._innerYellowBar.find(".__streak_MM_extractingFrom").show()},hideExtractionLineSettings:function(){this._innerYellowBar.find(".__streak_MM_extractingFrom").hide()},showSelectBoxesNotice:function(){this._innerYellowBar.find(".__streak_MM_extractingInstructions").show()},hideSelectBoxesNotice:function(){this._innerYellowBar.find(".__streak_MM_extractingInstructions").hide()},destroy:function(){this._yellowBar.destroy();this._clickBlockOverlay.destroy();Streak.ViewControllerBase.prototype.destroy.call(this)}});BB.Modules.MailMergeBoxChooserView=MailMergeBoxChooserView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeBoxChooserViewController=function(){Streak.ViewControllerBase.call(this);this._mailMergeController=null;this._dataSource=null;this._view=null;this._extractionSettingsMenu=null;this._extractionSettingsMenuButton=null;this._setupTheView()};MailMergeBoxChooserViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergeBoxChooserViewController.prototype,{setMailMergeController:function(mailMergeController){this._mailMergeController=mailMergeController},setDataSource:function(dataSource){this._dataSource=dataSource;this._setupExtractionSettingsMenu();this._setupExtractionSettingsMenuButton();this._setupNotificationBindings();this.statsChanged()},_setupView:function(){},_setupTheView:function(){this._view=new BB.Modules.MailMergeBoxChooserView;this._view.addDelegate(this)},_setupExtractionSettingsMenu:function(){this._extractionSettingsMenu=BB.Widgets.Menu.create();this._extractionSettingsMenu.addItem(BB.Locale.getString("mm_extrac_emails_from"));this._addExtractionSetting("extractEmailsFrom","threads");this._addExtractionSetting("extractEmailsFrom","columns");this._addExtractionSetting("extractEmailsFrom","assignedTo");this._extractionSettingsMenu.addSeparator();this._extractionSettingsMenu.addItem(BB.Locale.getString("mm_ignore_emails_from"));this._addExtractionSetting("ignoreEmails","myself");this._addExtractionSetting("ignoreEmails","org")},_addExtractionSetting:function(categoryKey,settingKey){var self=this;var settingValue=this._dataSource.getExtractionSettingValue(categoryKey,settingKey);var settingName=this._getExtractionSettingName(categoryKey,settingKey);var checkItem=this._extractionSettingsMenu.addCheckItem(settingName,function(){settingValue=!settingValue;checkItem.setCheckboxState(settingValue);self._mailMergeController.updateExtractionSettingValue(categoryKey,settingKey,settingValue);self._updateExtractionSettingsMenuButton();BB.Tracker.track("mail merge extract setting changed",{settingName:settingName,settingValue:settingValue})},settingValue)},_getExtractionSettingName:function(categoryKey,settingKey){return BB.Locale.getString(extractionSettingNameKeys[categoryKey][settingKey],{org:BB.getUser().getDomain().capitalize()})},_setupExtractionSettingsMenuButton:function(){this._extractionSettingsMenuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"Text",text:this._getExtractionSettingsMenuButtonText(),isFixedPosition:true,menu:this._extractionSettingsMenu,preOnFunction:function(){BB.Tracker.track("mail merge extract settings menu open")}});this._view.setExtractionSettingsMenuButton(this._extractionSettingsMenuButton)},_updateExtractionSettingsMenuButton:function(){this._extractionSettingsMenuButton.setText(this._getExtractionSettingsMenuButtonText())},_getExtractionSettingsMenuButtonText:function(){var entriesArray=[];if(this._dataSource.getExtractionSettingValue("extractEmailsFrom","threads")){entriesArray.push(this._getExtractionSettingName("extractEmailsFrom","threads"))}if(this._dataSource.getExtractionSettingValue("extractEmailsFrom","columns")){entriesArray.push(this._getExtractionSettingName("extractEmailsFrom","columns"))}if(this._dataSource.getExtractionSettingValue("extractEmailsFrom","assignedTo")){entriesArray.push(this._getExtractionSettingName("extractEmailsFrom","assignedTo"))}if(entriesArray.length===0){return BB.Locale.getString("mm_none")}else{return entriesArray.join(", ")}},_setupNotificationBindings:function(){NotificationCenter.subscribe({eventName:"pipeline.selectedBoxesChanged",functionToCall:this._selectedBoxesChanged,observer:this,filterParameters:{pipelineKey:this._dataSource.getPipeline().key()}});NotificationCenter.postNotification({eventName:"disableBoxLoading",pipelineKey:this._dataSource.getPipeline(),sender:this});this._mailMergeController.updateBoxesChosen(BB.Modules.PipelineView.getSelectedBoxes())},_selectedBoxesChanged:function(functionParameters){var selectedBoxes=functionParameters.selectedBoxes;this._mailMergeController.updateBoxesChosen(selectedBoxes)},statsChanged:function(){var boxesSelected=this._dataSource.getNumberOfBoxesSelected();var emailsExtracted=this._dataSource.getNumberOfEmailsExtracted();this._view.setBoxesSelectedCount(boxesSelected);this._view.setEmailsExtractedCount(emailsExtracted);if(boxesSelected>0){this._view.showExtractionLineSettings();this._view.hideSelectBoxesNotice()}else{this._view.showSelectBoxesNotice();this._view.hideExtractionLineSettings()}},continueClicked:function(){this._mailMergeController.boxesChosen()},cancelClicked:function(){var self=this;BB.Widgets.Modal.create({title:BB.Locale.getString("mail_merge"),confirmText:BB.Locale.getString("continue_with_mail_merge"),inner:BB.Locale.getString("middle_of_mm_warning"),showCancel:true,cancelText:BB.Locale.getString("exit_mail_merge"),cancelFunc:function(){self._mailMergeController.cancel();BB.Tracker.track("mail merge cancelled",{stage:"pipeline box choosing"})},confirmFunc:function(){$.modal.close()}}).show()},destroy:function(){this._view.destroy();this._extractionSettingsMenu.destroy();this._extractionSettingsMenuButton.destroy();NotificationCenter.unsubscribe({observer:this});NotificationCenter.postNotification({eventName:"enableBoxLoading",pipelineKey:this._dataSource.getPipeline(),sender:this})}});var extractionSettingNameKeys={extractEmailsFrom:{threads:"mm_email_threads",assignedTo:"mm_assigned_to",columns:"mm_pipeline_cols"},ignoreEmails:{myself:"mm_me",org:"mm_anyone_at"}};BB.Modules.MailMergeBoxChooserViewController=MailMergeBoxChooserViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeSidebarViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._listViewController=null;this._dataSource=null;this._delegate=null;this._mailMergeEntryDetailViewControllers=[]};MailMergeSidebarViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(MailMergeSidebarViewController.prototype,{setDataSource:function(dataSource){this._dataSource=dataSource},setDelegate:function(delegate){this._delegate=delegate},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},aboutToProcessModification:function(){this._destroyEntryDetails();this._setupElement()},shouldProcessModification:function(){return this._dataSource.shouldShowSidebar()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"EXTERNAL_SIDEBAR"},getModificationElement:function(){if(this._listViewController&&this._listViewController.getView()){return this._listViewController.getView().getElement()}},getModificationTitle:function(){return BB.Locale.getString("mm_extracted_emails")},mailMergeStateChanged:function(){this._composeWindowViewController.reloadModification(this)},_setupElement:function(){if(!this._listViewController){this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._listViewController.setDataSource(this);this._listViewController.addDelegate(this)}var numberOfPeople=this._dataSource.getNumberOfEmailsExtracted();for(var ii=0;ii<numberOfPeople;ii++){var mailMergeEntryDetailViewController=new BB.Modules.MailMergeEntryDetailViewController(ii);mailMergeEntryDetailViewController.setDataSource(this._dataSource.getEntryDetailModel(ii));this._mailMergeEntryDetailViewControllers.push(mailMergeEntryDetailViewController)}this._listViewController.dataChanged()},numberOfSections:function(){return 1},sectionShouldShow:function(){return true},numberOfRowsForSection:function(){return this._mailMergeEntryDetailViewControllers.length},infoForRow:function(sectionIndex,rowIndex){return{viewController:this._mailMergeEntryDetailViewControllers[rowIndex]}},dontScrollOnHighlight:function(){return true},rowFocused:function(rowInfo){this._dataSource.setPreviewedEntryIndex(rowInfo.viewController.getEntryIndex())},rowUnfocused:function(rowInfo){this._dataSource.setPreviewedEntryIndex(null)},getWrapperClass:function(){return"streak__mailMerge_sidebar"},rowsAreNotSelectable:function(){return true},dontHighlightOnDataChange:function(){return true},destroy:function(){if(this._listViewController){this._listViewController.destroy()}this._composeWindowViewController=null;this._destroyEntryDetails()},_destroyEntryDetails:function(){if(!this._mailMergeEntryDetailViewControllers){return}for(var ii=0;ii<this._mailMergeEntryDetailViewControllers.length;ii++){this._mailMergeEntryDetailViewControllers[ii].destroy()}this._mailMergeEntryDetailViewControllers.length=0}});BB.Modules.MailMergeSidebarViewController=MailMergeSidebarViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeContentManagerViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._dataSource=null;this._delegate=null;this._subjectDebounceTimeout=null;this._bodyDebounceTimeout=null;this._updatedCompose=false};MailMergeContentManagerViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(MailMergeContentManagerViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},setDataSource:function(dataSource){this._dataSource=dataSource;this._dataSource.addDelegate(this)},setDelegate:function(delegate){this._delegate=delegate},subjectChanged:function(subject){if(this._dataSource.isAnEntryBeingPreviewed()){return}if(this._dataSource.isEntryDetailBeingEdited()&&this._updatedCompose){return}clearTimeout(this._subjectDebounceTimeout);var self=this;this._subjectDebounceTimeout=setTimeout(function(){self._dataSource.setTemplateSubject(subject,self._composeWindowViewController.getComposeBodyHTML())},100)},emailBodyChanged:function(emailBody,extraInformation){if(this._dataSource.isAnEntryBeingPreviewed()){return}if(this._dataSource.isEntryDetailBeingEdited()){if(extraInformation&&extraInformation.fromDraftSaving){return}if(this._updatedCompose){return}}clearTimeout(this._bodyDebounceTimeout);var self=this;this._bodyDebounceTimeout=setTimeout(function(){self._dataSource.setTemplateBody(emailBody,self._composeWindowViewController.getSubject())},100)},previewedEntryAboutToChange:function(){this._dataSource.setTemplateSubject(this._composeWindowViewController.getSubject());this._dataSource.setTemplateBody(this._composeWindowViewController.getComposeBodyHTML())},previewedEntryChanged:function(){this._updateComposeWithRelevantContent()},editedEntryChanged:function(){this._updateComposeWithRelevantContent()},_updateComposeWithRelevantContent:function(){var subject=this._dataSource.getCurrentSubject();var body=this._dataSource.getCurrentBody();this._updatedCompose=true;this._composeWindowViewController.setSubject(subject);this._composeWindowViewController.setEmailBody(body);if(this._dataSource.isAnEntryBeingPreviewed()){this._composeWindowViewController.disableEditing()}else{this._composeWindowViewController.enableEditing()}this._updatedCompose=false},destroy:function(){this._composeWindowViewController.enableEditing();this._composeWindowViewController=null}});BB.Modules.MailMergeContentManagerViewController=MailMergeContentManagerViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeEntryDetailModel=Streak.Class.subclass({superclass:Streak.UI.Delegator,_memberVariables:[{name:"_parentModel",destroy:false,set:true},{name:"_entryIndex",destroy:true,get:true,set:true},{name:"_boxes",destroy:false,get:true},{name:"_selectedBox",destroy:false,get:true},{name:"_contact",destroy:true,get:true},{name:"_email",destroy:true,get:true},{name:"_otherFieldsModel",destroy:true,get:true},{name:"_overwrittenEmailTemplateSubject",destroy:false,get:true,set:true},{name:"_overwrittenEmailTemplateBody",destroy:false,get:true,set:true},{name:"_missingEmailFields",destroy:true,get:true},{name:"_missingBoxFields",destroy:true,get:true},{name:"_missingOtherFields",destroy:true,get:true},{name:"_isIncludedInMailMerge",destroy:true,set:true},{name:"_isCurrentlySelected",destroy:true,set:true,get:true},{name:"_isCurrentlyEditing",destroy:true,get:true},{name:"_isRefreshingContact",destroy:true,get:true,set:true}],_initialize:function(){Streak.UI.Delegator.prototype._initialize.call(this);this._missingEmailFields=[];this._missingBoxFields=[];this._missingOtherFields=[];this._isIncludedInMailMerge=true;this._isCurrentlySelected=false;this._isCurrentlyEditing=false;this._isRefreshingContact=true;return this},setEmail:function(email){this._email=email;this._setupContact()},_setupContact:function(){this._isRefreshingContact=true;var self=this;var rawContact=BB.Contacts.getLatestContactInformation(this._email,function(contact){if(contact){self._contact.setWrappedObject(contact)}self._isRefreshingContact=false;self._delegate.refresh();self._bindEventsToContactModel()});this._contact=new Streak.Model(rawContact)},setBoxes:function(boxes){this._boxes=boxes;if(!this._boxes){return}if(this._boxes.length===1){this.setSelectedBox(this._boxes[0])}},setOtherFieldObjects:function(otherFieldsObjects){if(!this._otherFieldsModel){this._otherFieldsModel=new Streak.Model({});this._bindToOtherFieldsModel()}if(!otherFieldsObjects){return}for(var ii=0;ii<otherFieldsObjects.length;ii++){this._otherFieldsModel.setWrappedObject(otherFieldsObjects[ii])}},doneRefreshingContact:function(){this._isRefreshingContact=false;this._delegate.refresh()},setSelectedBox:function(selectedBox){this._selectedBox=selectedBox;this._bindToBox();if(this._delegate){this._delegate.refresh()}},needsSelectedBox:function(){return this._selectedBox===null&&this._boxes&&this._boxes.length>1},isIncludedInMailMerge:function(){return this._isIncludedInMailMerge},setNotIncludedInMailMerge:function(){this._isIncludedInMailMerge=false;if(this._isCurrentlyEditing){this.setIsCurrentlyEditing(false)}else{this._delegate.refresh()}this._parentModel.includedEmailsModified()},isCurrentlyEditing:function(){return this._isCurrentlyEditing},setIsCurrentlyEditing:function(value){this._isCurrentlyEditing=value;this._delegate.refresh();this._parentModel.editingEntryIndexModified()},isRefreshingContact:function(){return this._isRefreshingContact},isFromCSV:function(){return false},getErrors:function(){var errors=[];if(this._boxes&&this._boxes.length>0&&!this._selectedBox){errors.push("NO_BOX_CHOSEN")}if(this.doesHaveMissingEmailFields()){errors.push("MISSING_EMAIL_FIELDS")}if(this.doesHaveMissingBoxFields()){errors.push("MISSING_BOX_FIELDS")}if(this.doesHaveMissingOtherFields()){errors.push("MISSING_CSV_FIELDS")}return errors},getMissingEmailFieldsErrorMessage:function(){var fieldNames=this.getMissingEmailFields();return BB.Locale.getString("mm_email_info_missing",{info:fieldNames.join(", ")})},getMissingBoxFieldsErrorMessage:function(){var fieldNames=this.getMissingBoxFields();return BB.Locale.getString("mm_following_fields_missing",{fields:fieldNames.join(", ")})},getMissingOtherFieldsErrorMessage:function(){var fieldNames=this.getMissingOtherFields();return BB.Locale.getString("mm_following_fields_missing",{fields:fieldNames.join(", ")})},getMoreThanOneRowOrBoxMessage:function(){return BB.Locale.getString(this.isFromCSV()?"mm_more_than_one_row":"mm_more_than_one_box")},getTemplateSubject:function(){if(this.isUsingCustomTemplate()){return this._overwrittenEmailTemplateSubject}if(this.needsSelectedBox()){return this.getMoreThanOneRowOrBoxMessage()}return BB.Services.TemplateProcessor.getCompiledString(this._selectedBox,this._contact.getLatestObject(),this._getOtherFieldsObject(),this._parentModel.getTemplateSubject(),true)},getTemplateBody:function(){if(this.isUsingCustomTemplate()){return this._overwrittenEmailTemplateBody}if(this.needsSelectedBox()){return this.getMoreThanOneRowOrBoxMessage()}return BB.Services.TemplateProcessor.getCompiledString(this._selectedBox,this._contact.getLatestObject(),this._getOtherFieldsObject(),this._parentModel.getTemplateBody())},isUsingCustomTemplate:function(){return _.isReal(this._overwrittenEmailTemplateBody)||_.isReal(this._overwrittenEmailTemplateSubject)},restore:function(){this._overwrittenEmailTemplateSubject=null;this._overwrittenEmailTemplateBody=null;this._delegate.refresh();this._parentModel.entryRestored()},update:function(){this._updateFields();this._delegate.refresh()},doesHaveMissingEmailFields:function(){return!this.isUsingCustomTemplate()&&this._missingEmailFields.length>0},doesHaveMissingBoxFields:function(){return!this.isUsingCustomTemplate()&&this._missingBoxFields.length>0},doesHaveMissingOtherFields:function(){return!this.isUsingCustomTemplate()&&this._missingOtherFields.length>0},getReferencedFields:function(){return this._parentModel.getReferencedFields()},isAbleToSetAsEditing:function(){return!this._parentModel.isEntryDetailBeingEdited()},_updateFields:function(){this._missingEmailFields.length=0;this._missingBoxFields.length=0;this._missingOtherFields.length=0;if(this.isUsingCustomTemplate()){return}this._checkReferencedEmailFields();this._checkReferencedBoxFields();this._checkReferencedOtherFields()},_checkReferencedEmailFields:function(){var referencedFields=this._parentModel.getReferencedFields();if(!referencedFields.email){return}for(var emailField in referencedFields.email){if(!this._contact.get(emailField)){this._missingEmailFields.push(emailField)}}},_checkReferencedBoxFields:function(){if(!this._selectedBox){return}var referencedFields=this._parentModel.getReferencedFields();if(!this._selectedBox||!referencedFields.box){return}for(var columnKey in referencedFields.box){var column=referencedFields.box[columnKey];this._checkReferencedBoxField(column)}},_checkReferencedBoxField:function(column){var columnValue;if(column.columnType==="field"){columnValue=this._selectedBox.getFieldTextValue(column.value.fieldKey)}else{columnValue=this._selectedBox.getTextValue(column.value.property)}if(!columnValue){this._missingBoxFields.push(column.name)}},_checkReferencedOtherFields:function(){if(!this._otherFieldsModel){return}var referencedFields=this._parentModel.getReferencedFields();if(!referencedFields.other){return}for(var otherField in referencedFields.other){if(!this._otherFieldsModel.get(otherField)){this._missingOtherFields.push(otherField)}}},_bindEventsToContactModel:function(){var self=this;this._contact.watch("change",function(){if(self.isCurrentlyEditing()){self._parentModel.currentlyEditingEntryDetailChanged();self._updateFields();self._delegate.refreshErrorsAndWarnings()}},this)},_bindToBox:function(){var self=this;if(!this._selectedBox){return}this._selectedBox.watch("change",function(){if(self.isCurrentlyEditing()){self._parentModel.currentlyEditingEntryDetailChanged();self._updateFields();self._delegate.refreshErrorsAndWarnings()}},this)},_bindToOtherFieldsModel:function(){var self=this;if(!this._otherFieldsModel){return}this._otherFieldsModel.watch("change",function(){if(self.isCurrentlyEditing()){self._parentModel.currentlyEditingEntryDetailChanged();self._updateFields();self._delegate.refreshErrorsAndWarnings()}},this)},_getOtherFieldsObject:function(){if(!this._otherFieldsModel){return null}return this._otherFieldsModel.getLatestObject()},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});Streak.UI.Delegator.prototype.destroy.call(this)}});BB.Modules.MailMergeEntryDetailModel=MailMergeEntryDetailModel})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeEntryDetailView=function(){this._delegate=null;this._element=null;this._errorsAndWarningsContainer=null;this._setup()};_.extend(MailMergeEntryDetailView.prototype,{setDelegate:function(delegate){this._delegate=delegate},getElement:function(){return this._element},hide:function(){this._element.hide()},setEntryTitle:function(contact){var fullName=contact.get("fullName");var email=contact.get("email");var text=fullName;if(text){text+=" &#60;"+email+"&#62;"}else{text=email}this._element.find(".__streak_MMContactName")[0].innerHTML=text},showBoxName:function(){this._element.find(".streak__mailMerge_boxName").show()},hideBoxName:function(){this._element.find(".streak__mailMerge_boxName").hide()},setBoxName:function(boxName){this._element.find(".streak__mailMerge_boxName")[0].innerHTML=boxName},hideFieldDetails:function(){this._element.find(".streak__boxDetailsMM").hide()},showFieldDetails:function(){this._element.find(".streak__boxDetailsMM").show()},clearFieldDetails:function(){this._element.find(".streak__boxDetailsMM").empty()},addInputField:function(fieldName,input){var fieldDiv=$(HTML.get("mm_box_detail_entry")({name:fieldName}));fieldDiv.find(".fieldValue").append(input.getElement());this._element.find(".streak__boxDetailsMM").append(fieldDiv)},setRemoveLink:function(removeLink){this._element.find(".streak__mailMerge_li_removeLink").append(removeLink.getElement())},setEditLink:function(editLink){this._element.find(".streak__mailMerge_li_editLink").append(editLink.getElement())},hideEditLink:function(){this._element.find(".streak__mailMerge_li_editLink")[0].style.display="none"},showEditLink:function(){this._element.find(".streak__mailMerge_li_editLink")[0].style.display=""},setDoneLink:function(doneLink){this._element.find(".streak__mailMerge_li_doneLink").append(doneLink.getElement())},hideDoneLink:function(){this._element.find(".streak__mailMerge_li_doneLink")[0].style.display="none"},showDoneLink:function(){this._element.find(".streak__mailMerge_li_doneLink")[0].style.display=""},clearErrorsAndWarnings:function(){this._errorsAndWarningsContainer.empty()},showErrorsAndWarnings:function(){this._errorsAndWarningsContainer.show()},hideErrorsAndWarnings:function(){this._errorsAndWarningsContainer.hide()},addErrorMessage:function(message){var messageDiv=$(HTML.get("mm_error_div")({msg:message}));this._errorsAndWarningsContainer.append(messageDiv)},addWarningMessage:function(message){var messageDiv=$(HTML.get("mm_warning_div")({msg:message}));this._errorsAndWarningsContainer.append(messageDiv)},showRestore:function(restoreButton){var warningDiv=$(HTML.get("mm_warning_div")({msg:BB.Locale.getString("mm_email_modified")}));warningDiv.append(restoreButton.getElement());this._errorsAndWarningsContainer.append(warningDiv)},showMoreThanOneBoxError:function(menuButton,message){var errorDiv=$(HTML.get("mm_more_than_one_box")({moreBoxMessage:message}));errorDiv.append(menuButton.getElement());this._errorsAndWarningsContainer.append(errorDiv)},destroy:function(){this._element.remove()}});_.extend(MailMergeEntryDetailView.prototype,{_setup:function(){this._element=HTML.get("mm_EmailLI",true);this._errorsAndWarningsContainer=this._element.find("._streak_liErrorsAndWarnings")}});BB.Modules.MailMergeEntryDetailView=MailMergeEntryDetailView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeEntryDetailViewController=function(entryIndex){Streak.ViewControllerBase.call(this);this._view=null;this._dataSource=null;this._listViewController=null;this._entryIndex=entryIndex;this._removeLink=null;this._doneLink=null;this._editLink=null;this._errorsAndWarningsVisible=false;this._inputs=[];this._setupTheView()};MailMergeEntryDetailViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergeEntryDetailViewController.prototype,{getView:function(){return this._view},setDataSource:function(dataSource){this._dataSource=dataSource;this._dataSource.setDelegate(this);this.refresh()},setListViewController:function(listViewController){this._listViewController=listViewController},_setupView:function(){},_setupTheView:function(){this._view=new BB.Modules.MailMergeEntryDetailView;this._view.setDelegate(this);this._setupActionLinks()},_setupActionLinks:function(){this._setupRemoveLink();this._setupEditLink();this._setupDoneLink()},_setupRemoveLink:function(){var self=this;this._removeLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("mm_remove"),onFunction:function(){self._dataSource.setNotIncludedInMailMerge();BB.Tracker.track("mail merge entry removed")}});this._view.setRemoveLink(this._removeLink)},_setupEditLink:function(){var self=this;this._editLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("edit").capitalize(),onFunction:function(){if(!self._dataSource.isAbleToSetAsEditing()){return}self._dataSource.setIsCurrentlyEditing(true);self._listViewController.lockRowSelection();BB.Tracker.track("mail merge entry editing")}});this._view.setEditLink(this._editLink)},_setupDoneLink:function(){var self=this;this._doneLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("done").capitalize(),onFunction:function(){self._dataSource.setIsCurrentlyEditing(false);self._listViewController.unlockRowSelection();BB.Tracker.track("mail merge entry done editing")},useEventBubbling:true});this._view.setDoneLink(this._doneLink)},refresh:function(){this._clearInputs();if(!this._dataSource.isIncludedInMailMerge()){this._view.hide();return}this._view.setEntryTitle(this._dataSource.getContact());this._view.clearFieldDetails();this._view.hideFieldDetails();if(this._dataSource.isCurrentlyEditing()){this._renderFieldDetails()}this._refreshActionLinks();this._refreshErrorsAndWarningsSection();if(this._dataSource.getSelectedBox()&&!this._errorsAndWarningsVisible){this._view.showBoxName();this._view.setBoxName("Box: "+this._dataSource.getSelectedBox().displayName())}else{this._view.hideBoxName()}},refreshErrorsAndWarnings:function(){this._refreshErrorsAndWarningsSection()},_refreshActionLinks:function(){this._view.hideEditLink();this._view.hideDoneLink();if(this._dataSource.isCurrentlyEditing()){this._view.showDoneLink();return}if(!this._dataSource.needsSelectedBox()){this._view.showEditLink()}},_refreshErrorsAndWarningsSection:function(){this._view.clearErrorsAndWarnings();this._view.hideErrorsAndWarnings();this._renderAnyErrors()},_renderAnyErrors:function(){var showErrorArea=false;if(this._dataSource.isRefreshingContact()){showErrorArea=true;this._showRefreshingContactNotice()}if(this._dataSource.isUsingCustomTemplate()){showErrorArea=true;this._setupRestoreButton()}if(this._dataSource.doesHaveMissingEmailFields()){showErrorArea=true;this._showMissingEmailFieldErrors()}if(this._dataSource.doesHaveMissingBoxFields()){showErrorArea=true;this._showMissingBoxFieldErrors()}if(this._dataSource.doesHaveMissingOtherFields()){showErrorArea=true;this._showMissingOtherFieldErrors()}if(this._dataSource.needsSelectedBox()){showErrorArea=true;this._setupBoxPicker()}if(showErrorArea){this._view.showErrorsAndWarnings()}this._errorsAndWarningsVisible=showErrorArea},_showRefreshingContactNotice:function(){this._view.addWarningMessage(BB.Locale.getString("mm_getting_contact_info"))},_setupRestoreButton:function(){var self=this;var restoreButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("mm_restore"),onFunction:function(){self._dataSource.restore();BB.Tracker.track("mail merge entry restored")}});this._view.showRestore(restoreButton)},_showMissingEmailFieldErrors:function(){this._view.addErrorMessage(this._dataSource.getMissingEmailFieldsErrorMessage())},_showMissingBoxFieldErrors:function(){this._view.addErrorMessage(this._dataSource.getMissingBoxFieldsErrorMessage())},_showMissingOtherFieldErrors:function(){this._view.addErrorMessage(this._dataSource.getMissingOtherFieldsErrorMessage())},_setupBoxPicker:function(){var self=this;var boxes=this._dataSource.getBoxes();var menu=BB.Widgets.Menu.create();_.each(boxes,function(box){menu.addItem(box.displayName(),function(){self._dataSource.setSelectedBox(box);menuButton.off();BB.Tracker.track("mail merge selected box chosen")})});var menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailArrow",menu:menu,isFixedPosition:true,text:BB.Locale.getString(this._dataSource.isFromCSV()?"mm_choose_a_row":"mm_choose_a_box")});this._view.showMoreThanOneBoxError(menuButton,this._dataSource.getMoreThanOneRowOrBoxMessage())},_renderFieldDetails:function(){var referencedFields=this._dataSource.getReferencedFields();if(!referencedFields){return}this._renderEmailFields(referencedFields.email);this._renderBoxFields(referencedFields.box);this._renderOtherFields(referencedFields.other)},_renderEmailFields:function(emailFields){for(var fieldKey in emailFields){this._renderEmailField(fieldKey)}},_renderEmailField:function(fieldKey){var input=BB.Widgets.SidebarTextarea.create({model:this._dataSource.getContact(),property:fieldKey,autoSave:false,useAutocomplete:false,border:"hover"});this._view.addInputField(BB.Locale.getString("mm_"+fieldKey),input);this._inputs.push(input);this._view.showFieldDetails()},_renderOtherFields:function(otherFields){for(var fieldKey in otherFields){this._renderOtherField(fieldKey)}},_renderOtherField:function(fieldKey){var input=BB.Widgets.SidebarTextarea.create({model:this._dataSource.getOtherFieldsModel(),property:fieldKey,autoSave:false,border:"hover"});this._view.addInputField(BB.Locale.getString(fieldKey),input);this._inputs.push(input);this._view.showFieldDetails()},_renderBoxFields:function(boxFields){for(var fieldKey in boxFields){this._renderBoxField(boxFields[fieldKey])}},_renderBoxField:function(boxField){var input;if(boxField.columnType==="property"){input=this._getBoxPropertyInput(boxField.value.property)
}else{input=this._getBoxFieldInput(boxField.value.fieldKey)}this._view.addInputField(boxField.name,input);this._inputs.push(input);this._view.showFieldDetails()},_getBoxPropertyInput:function(property){switch(property){case"name":return this._getBoxNameInput();case"assignedToSharingEntries":return this._getBoxAssignedToInput();case"notes":return this._getNotesInput();case"stageKey":return this._getStageInput();default:return this._getGenericBoxPropertyInput()}},_getBoxNameInput:function(){return BB.Widgets.SmartTextbox.create({model:this._dataSource.getSelectedBox(),property:"name",border:"gmailHover",autoGrow:false,allowEmpty:false})},_getBoxAssignedToInput:function(){return BB.Widgets.SidebarAssignedTo.create({box:this._dataSource.getSelectedBox(),pipeline:this._dataSource.getSelectedBox().getPipeline(),border:"hover",includeNames:true})},_getNotesInput:function(){return BB.Widgets.SidebarTextarea.create({model:this._dataSource.getSelectedBox(),property:"notes",border:"hover"})},_getStageInput:function(){return BB.Widgets.StageButton.create({pipeline:this._dataSource.getSelectedBox().getPipeline(),box:this._dataSource.getSelectedBox(),trackingContext:{widgetContext:"mailMergeSidebar"}})},_getGenericBoxPropertyInput:function(property){return BB.Widgets.SidebarTextarea.create({model:this._dataSource.getSelectedBox(),property:property,border:"gmailHover"})},_getBoxFieldInput:function(fieldKey){return BB.Models.BoxField.getMailMergeInputWidget(this._dataSource.getSelectedBox(),fieldKey)},getEntryIndex:function(){return this._entryIndex},destroy:function(){this._clearInputs();this._view.destroy();this._removeLink.destroy();this._editLink.destroy();this._doneLink.destroy()},_clearInputs:function(){for(var ii=0;ii<this._inputs.length;ii++){this._inputs[ii].destroy()}this._inputs.length=0}});BB.Modules.MailMergeEntryDetailViewController=MailMergeEntryDetailViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeInsertTagView=function(){Streak.ViewControllerBase.call(this);this._element=null;this._setupElement()};MailMergeInsertTagView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(MailMergeInsertTagView.prototype,{_setupElement:function(){this._element=HTML.get("mm_customize_each_email",true)},getElement:function(){return this._element},setInsertTagMenuButton:function(menuButton){this._element.append(menuButton.getElement())},destroy:function(){this._element.remove()}});BB.Modules.MailMergeInsertTagView=MailMergeInsertTagView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeInsertTagViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._dataSource=null;this._delegate=null;this._view=null;this._tagListViewController=null;this._tagListViewControllerDataSource=null;this._tagMenuButton=null};MailMergeInsertTagViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(MailMergeInsertTagViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},setDataSource:function(dataSource){this._dataSource=dataSource},setDelegate:function(delegate){this._delegate=delegate},aboutToProcessModification:function(){this._setup()},shouldProcessModification:function(){return this._delegate.shouldShowSidebar()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM"},getModificationElement:function(){if(this._view){return this._view.getElement()}},mailMergeStateChanged:function(){this._composeWindowViewController.reloadModification(this)},_setup:function(){this._view=new BB.Modules.MailMergeInsertTagView;this._setupTagMenu();this._setupTagMenuButton()},_setupTagMenu:function(){this._setupTagListViewDataSource();this._tagListViewController=new BB.Widgets.ListView.ListViewViewController;this._tagListViewController.setDataSource(this);this._tagListViewController.addDelegate(this);this._tagListViewController.dataChanged()},_setupTagListViewDataSource:function(){this._tagListViewControllerDataSource=[{sectionTitle:BB.Locale.getString("mm_from_email_addr"),rows:[{text:BB.Locale.getString("mm_fullName"),tag:"email_fullName"},{text:BB.Locale.getString("mm_givenName"),tag:"email_givenName"},{text:BB.Locale.getString("mm_familyName"),tag:"email_familyName"},{text:BB.Locale.getString("mm_email"),tag:"email_email"}]},{sectionTitle:BB.Locale.getString("mm_more_fields"),rows:[]}];var fieldList=this._dataSource.getFieldList();for(var ii=0;ii<fieldList.length;ii++){var field=fieldList[ii];this._tagListViewControllerDataSource[1].rows.push({text:field,tag:"field_"+field})}},getWrapperClass:function(){return"J-M uEPqDe bb_menu streak__mailMerge_insertTag"},numberOfSections:function(){return 2},numberOfRowsForSection:function(sectionIndex){return this._tagListViewControllerDataSource[sectionIndex].rows.length},sectionShouldShow:function(){return true},sectionTitle:function(sectionIndex){return this._tagListViewControllerDataSource[sectionIndex].sectionTitle},infoForRow:function(sectionIndex,rowIndex){return this._tagListViewControllerDataSource[sectionIndex].rows[rowIndex]},rowPressed:function(rowInfo){var insertedText="{{"+rowInfo.tag+"}}";var plainText=insertedText;var htmlText=insertedText;if(this._dataSource.isEntryDetailBeingEdited()){var entryDetail=this._dataSource.getCurrentlyEditedEntryDetail();plainText=BB.Services.TemplateProcessor.getCompiledString(entryDetail.getSelectedBox(),entryDetail.getContact(),insertedText,true);htmlText=BB.Services.TemplateProcessor.getCompiledString(entryDetail.getSelectedBox(),entryDetail.getContact(),insertedText)}this._composeWindowViewController.addTextAtCurrentCursorPosition(htmlText,plainText);this._tagMenuButton.off();BB.Tracker.track("mail merge tag inserted")},_setupTagMenuButton:function(){var self=this;this._tagMenuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"Text",color:"lightblue",text:BB.Locale.getString("mm_insert_tmpl"),isFixedPosition:true,isBottomAligned:true,isRightAligned:true,menu:this._tagListViewController.getView(),preOnFunction:function(){self._tagListViewController.reset();BB.Tracker.track("mail merge tag menu open")}});this._view.setInsertTagMenuButton(this._tagMenuButton)},destroy:function(){if(this._view){this._view.destroy()}if(this._tagListViewController){this._tagListViewController.destroy()}if(this._tagMenuButton){this._tagMenuButton.destroy()}this._composeWindowViewController=null}});BB.Modules.MailMergeInsertTagViewController=MailMergeInsertTagViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeSendStatsViewController=Streak.Class.subclass({className:"MailMergeSendStatsViewController",superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_dataSource",destroy:false,set:true},{name:"_delegate",destroy:false,set:true},{name:"_pipelineButton",destroy:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);return this},_setupView:function(){},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){return this._delegate.shouldShowSidebar()},aboutToProcessModification:function(){if(!this._view){this._setupTheView()}},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"RECIPIENTS_OVERLAY"},getModificationHeight:function(){return"65px"},getModificationElement:function(){if(!this._view){return null}return this._view.getElement()},mailMergeStateChanged:function(){this._composeWindowViewController.reloadModification(this)},includedEmailsModified:function(){this._renderStats()},_setupTheView:function(){this._view=Library.getInstance("BentoBox.Modules.MailMergeSendStatsView");this._renderStats();if(this._dataSource.isUsingCSVFile()){this._view.hideBoxNotice();return}this._setupPipelineButton();this._setupChooseBoxesLink()},_renderStats:function(){this._view.setStats(this._dataSource.getNumberOfEmailsExtracted(),this._dataSource.getNumberOfBoxesSelected())},_setupPipelineButton:function(){this._pipelineButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailArrow",text:this._dataSource.getPipeline().displayName()});this._pipelineButton.disable();this._view.setPipelineButton(this._pipelineButton)},_setupChooseBoxesLink:function(){var self=this;this._chooseBoxesLink=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:BB.Locale.getString("mm_choose_boxes_2"),onFunction:function(){self._delegate.pipelineChosen(self._dataSource.getPipeline());BB.Tracker.track("mail merge choose boxes",{stage:"edit template"})}});this._view.setChooseBoxesLink(this._chooseBoxesLink)}});Library.set("BentoBox.Modules.MailMergeSendStatsViewController",MailMergeSendStatsViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeSendStatsView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._setupElement();return this},_setupElement:function(){this._element=HTML.get("mailMergeSendStatsView",true)},setStats:function(numberOfEmails,numberOfBoxes){this._element.find(".streak__mailMerge_emailAddressesStat")[0].innerHTML=BB.Locale.getString("mailMerge_emailAddress_stats",{number:numberOfEmails});this._element.find(".streak__mailMerge_selectedNotice")[0].innerHTML=BB.Locale.getString("mailMerge_box_stats",{number:numberOfBoxes,pluralize:[numberOfBoxes]})},hideBoxNotice:function(){this._element.find(".streak__mailMerge_selectedNotice").hide()},setPipelineButton:function(pipelineButton){this._element.find(".streak__mailMerge_pipelineButton").append(pipelineButton.getElement())},setChooseBoxesLink:function(chooseBoxesLink){this._element.find(".streak__mailMerge_chooseBoxes").append(chooseBoxesLink.getElement())}});Library.set("BentoBox.Modules.MailMergeSendStatsView",MailMergeSendStatsView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EMAIL_DELAY=5*1e3;var TIME_PROCESSING_EMAIL=EMAIL_DELAY+10*1e3;var MailMergeSenderViewController=Streak.Class.subclass({superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_dataSource",destroy:false,set:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);return this},startSending:function(){var self=this;this._setupTheView();var emailPackages=this._generateEmailPackages();BB.MailHelper.sendMultipleEmails({emailPackages:emailPackages,delayBetweenEmails:EMAIL_DELAY,startSendingCallback:function(howManyLeft){self._emailsStartedToSend(howManyLeft)},sendingEmail:function(emailPackage){self._sendingEmail(emailPackage)},emailSentCallback:function(emailIndex,howManyLeft,timeLeft){self._emailSent(emailIndex,howManyLeft,timeLeft)},finishedSendingCallback:function(){self._delegate.finishedSending()}});var method=this._dataSource.isUsingCSVFile()?"csv":"boxes";BB.Tracker.track("mail merge sending emails",{count:emailPackages.length,method:method})},cancelClicked:function(){this._view.hide();this._delegate.cancel();BB.MailHelper.cancelSending();BB.Tracker.track("mail merge cancelled",{stage:"sending"})},_setupTheView:function(){this._view=Library.getInstance("BentoBox.Modules.MailMergeSenderView");this._view.setDelegate(this)},_emailsStartedToSend:function(howManyLeft){this._view.show();this._view.updateNumberOfEmailsSentAndLeft(0,howManyLeft)},_sendingEmail:function(emailPackage){this._view.updateSendingTo(BB.Locale.getString("mail_merge_sending_to",{address:emailPackage.toAddresses[0]}))},_emailSent:function(emailIndex,howManyLeft,timeLeft){this._dataSource.markEmailSent(emailIndex);this._renderStats(emailIndex,howManyLeft)},_renderStats:function(lastEmailSentIndex,howManyLeft){var numberOfEmailsSent=lastEmailSentIndex+1;this._view.updateNumberOfEmailsSentAndLeft(numberOfEmailsSent,numberOfEmailsSent+howManyLeft);this._view.updateTimeLeft(howManyLeft*TIME_PROCESSING_EMAIL)},_generateEmailPackages:function(){var self=this;var entryDetails=this._dataSource.getEntryDetailModels();return _.chain(entryDetails).filter(function(entryDetail){return entryDetail.isIncludedInMailMerge()}).map(function(entryDetail){return self._generateEmailPackage(entryDetail)}).value()},_generateEmailPackage:function(entryDetailModel){var boxKey;if(entryDetailModel.getSelectedBox()){boxKey=entryDetailModel.getSelectedBox().key()}var thePackage={toAddresses:[entryDetailModel.getContact().get("email")],boxKey:boxKey,body:entryDetailModel.getTemplateBody(),subject:entryDetailModel.getTemplateSubject(),snippetKeyList:this._dataSource.getSnippetKeyList(),mailMergeId:this._dataSource.getMailMergeId()};if(this._dataSource.isPixelTracked()){thePackage.pixelTrackingGuid=BB.PixelTrackingHTMLGenerator.getGuid();thePackage.body+=BB.PixelTrackingHTMLGenerator.getTrackingHTML(thePackage.pixelTrackingGuid);thePackage.isPixelTracked=true}return thePackage}});Library.set("BentoBox.Modules.MailMergeSenderViewController",MailMergeSenderViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MailMergeSenderView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[{name:"_innerElement",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._setupElement();return this},_setupElement:function(){this._innerElement=HTML.get("mm_ENDING",true);var self=this;this._element=BB.Widgets.Tour.Bar.create({html:this._innerElement,showRightButton:false,showLeftButton:false,showLink:true,cancelFunc:function(){self._delegate.cancelClicked()}})},updateNumberOfEmailsSentAndLeft:function(numberOfEmailsSent,numberOfEmailsTotal){this._innerElement.find(".__streakMMRemainder")[0].innerHTML=BB.Locale.getString("mailMerge_emailsLeft",{number:numberOfEmailsSent,total:numberOfEmailsTotal,pluralize:[numberOfEmailsSent,numberOfEmailsTotal]})},updateTimeLeft:function(timeLeft){var seconds=parseInt(timeLeft/1e3);var minutes=parseInt(seconds/60);seconds=seconds-minutes*60;var timeLeftString=null;if(minutes>0){timeLeftString=BB.Locale.getString("mm_minutes",{minutes:minutes,seconds:seconds,pluralize:[minutes,seconds]})}else{timeLeftString=BB.Locale.getString("mm_just_seconds",{seconds:seconds,pluralize:[seconds]})}this._innerElement.find(".__streakMMTimeLeft")[0].innerHTML=timeLeftString},updateSendingTo:function(sendingToString){this._innerElement.find(".streak__mailMerge_sendingTo")[0].innerHTML=sendingToString},show:function(){this._element.show()},hide:function(){this._element.hide()}});Library.set("BentoBox.Modules.MailMergeSenderView",MailMergeSenderView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,BB=Streak.BentoBox;var trackingContext={widgetContext:"headsUp"};var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};var HeadsUp={elements:{},templates:{},sectionList:[],collapsedList:[],sectionMap:{},inactive:false,initialized:false,init:function(cb){var self=this;self.inactive=false;if(!self.initialized){this.el=$(document.createElement("div"));this.el.attr("id","headsUp");this.elements.collapsed=HTML.get("headsUpCollapsed",true);this.el.append(this.elements.collapsed);this.elements.collapsed.list=this.elements.collapsed.find(".sections");this.templates.section=HTML.get("headsUpSection");this.templates.row=HTML.get("headsUpRow");this.templates.menu=HTML.get("headsUpMenu");this.templates.button=HTML.get("headsUpButton");this.templates.collapsedSection=HTML.get("headsUpCollapsedSection");try{this.firstRender()}catch(err){}var throttled=_.throttle(function(){if(!self.inactive){try{self.render(true)}catch(err){BB.logError("Error in heads up",err)}}},2e3);Gmail.observe("gmailTimer",throttled,"headsUp");Gmail.observe("viewChanged",$.proxy(self.render,self));BB.bind("logged_out",function(){self.inactive=true});BB.Data.getAllPipelines().watch("remove",function(notification){var pipeline=notification.model;self.removeSectionsForPipeline(pipeline.key())},this)}self.initialized=true;if(cb){cb()}},teardown:function(){var i;if(this.el){this.el.detach();for(i=0;i<this.sectionList.length;i++){this.sectionList[i].el.detach()}this.sectionList.length=0;for(i=0;i<this.collapsedList.length;i++){this.collapsedList[i].el.detach()}this.collapsedList.length=0;this.elements.collapsed.hide()}this.inactive=true},reup:function(){this.inactive=false;this.firstRender()},getSettings:function(){return BB.getUser().getHeadsUpSections()},getSettingsAndConvertIfNecessary:function(){var sections=this.getSettings();if(sections.length>0){if(!sections[0].viewKey){var newSections=[];BB.UserSettings.setSetting("headsUp/sections",newSections);BB.UserSettings.saveSettings();return newSections}}return sections},firstRender:function(){var i,section;var self=this;var sections=this.getSettingsAndConvertIfNecessary();var open=[],closed=[];for(i=0;i<sections.length;i++){section=sections[i];if(section.isVisible){open.push(section)}else{closed.push(section)}}for(i=0;i<open.length;i++){try{section=new self.section(open[i]);if(section&&section.el){self.elements.collapsed.before(section.el);self.sectionList.push(section)}}catch(err){}}if(closed.length===0){this.hideCollapsed()}else{this.elements.collapsed.show();for(i=0;i<closed.length;i++){section=new self.collapsedSection(closed[i]);if(section&&section.el){self.elements.collapsed.list.find("br").before(section.el);self.collapsedList.push(section)}}}Gmail.ready(function(){self.render()})},hideCollapsed:function(){if(this.elements.collapsed.list.children("div").length===0&&!Gmail.isPreviewPane()){this.elements.collapsed.hide()}},collapseSection:function(section){this.sectionList.removeVal(section);section.el.remove();var cSection=new this.collapsedSection(section.settings);this.elements.collapsed.list.prepend(cSection.el);this.collapsedList.unshift(cSection);section.settings.isVisible=false;this.updateSection(section.settings);this.elements.collapsed.show()},openSection:function(section){section.el.remove();this.collapsedList.removeVal(section);var oSection=new this.section(section.settings);this.elements.collapsed.before(oSection.el);this.sectionList.push(oSection);oSection.settings.isVisible=true;this.updateSection(oSection.settings);this.hideCollapsed()},removeSection:function(viewKey){var settings=this.getSettings();var setting=settings.find(function(aSetting){return aSetting.viewKey===viewKey});if(setting){var section=this.sectionMap[viewKey];if(section){section.destroy();section.el.remove();if(setting.isVisible){this.sectionList.removeVal(section)}else{this.collapsedList.removeVal(section);if(this.collapsedList.length===0){this.hideCollapsed()}}}settings.removeVal(setting);this.saveSections()}},removeSectionsForPipeline:function(pipelineKey){var self=this;_(this.getSettings()).chain().filter(function(aSetting){return aSetting.pipelineKey===pipelineKey}).each(function(aSetting){self.removeSection(aSetting.viewKey)})},render:function(fromTimer){if(Gmail.getLiveView()===Gmail.Constants.Inbox&&Gmail.isListView()){if(this.sectionList.length+this.collapsedList.length===0){this.el.detach()}else{if(!HeadsUp.el.isVisible()){HeadsUp.el.detach();var main=Gmail.getCurrentMain();if(main.isVisible()){HeadsUp.el.find(".ae4.iR").removeClass("lastHeadsUp");if(Gmail.isPreviewPane()){main.find(".ae4").filter(":first").before(HeadsUp.el);HeadsUp.el.find(".ae4.iR").addClass("lastHeadsUp")}else if(Gmail.isTabbedInbox()){main.find(".aKh").filter(":first").before(HeadsUp.el)}else{main.find("[gh=tl]").filter(":first").before(HeadsUp.el);main.find(".aAD").filter(":first").removeClass("aAD");main.find(".Wg").filter(":first").addClass("aAD")}}else{return}}for(var i=0;i<HeadsUp.sectionList.length;i++){if(HeadsUp.sectionList[i]&&HeadsUp.sectionList[i].getIsDirty&&HeadsUp.sectionList[i].getIsDirty()){HeadsUp.sectionList[i].refresh()}}}}else if(!fromTimer){this.el.detach()}},addSection:function(viewKey,pipelineKey){var sections=this.getSettings();var settings={viewKey:viewKey,pipelineKey:pipelineKey,isVisible:true};sections.push(settings);var section=new HeadsUp.section(settings);this.elements.collapsed.before(section.el);BB.UserSettings.setSetting("headsUp/sections",sections);BB.UserSettings.saveSettings();HeadsUp.sectionList.push(section)},collapsedSection:function(settings){var section={settings:settings,destroy:function(){el.remove()}};var pipeline=BB.Data.getPipeline(settings.pipelineKey);if(!pipeline){return section}var savedView=pipeline.getSavedView(settings.viewKey);var el=$(HeadsUp.templates.collapsedSection());el.find(".sectionTitle .streak__headsUp_name").text(savedView.name);el.find(".sectionTitle .streak__headsUp_pipeline").text("("+pipeline.displayNameText()+")");el.find(".sectionTitle").click(function(){track("expandSection");HeadsUp.openSection(section)});section.el=el;HeadsUp.sectionMap[settings.viewKey]=section;return section},section:function(settings){var section={settings:settings};var pipeline=BB.Data.getPipeline(settings.pipelineKey);if(!pipeline){return section}var savedView=pipeline.getSavedView(settings.viewKey);var boxes=BB.Data.getPipelineBoxes(pipeline.key());var headsUpBoxesDataController=new BB.Modules.HeadsUpBoxesDataController(settings.pipelineKey);var maxVisible=settings.maxVisible||5;var visible=[];var isVisible=settings.isVisible===false?false:true;var hideEmpty=settings.hideEmpty||false;var sectionEl=$(HeadsUp.templates.section());var bm=BB.Widgets.ButtonMenu.create({customButton:HeadsUp.templates.button(),menuInner:HeadsUp.templates.menu(),css:{left:"-186px",width:"200px"}});var menu=bm.menu;var button=bm.button.el;var input=menu.find(".snapshotName");var isDirty=true;sectionEl.find(".menuArea").append(bm.el);sectionEl.find(".sectionTitle").click(function(){track("collapseSection");HeadsUp.collapseSection(section)});input.delayedSave({delay:200,saveFunction:function(isEnter){if(isEnter){input.blur();bm.off()}}});input.blur(function(e){if(input.val()&&input.val()!==savedView.name){savedView.name=input.val();pipeline.updateSavedView(savedView)}});BB.Keyboard.bindChordToElement(input,"escape",function(){input.val(savedView.name);input.blur();bm.off()},true);input.click(function(e){e.stopPropagation()});input.val(savedView.name);sectionEl.find(".goToPipeline").click(function(e){track("pipelineLinkClicked");BB.UI.setURL(pipeline.link()+"?"+savedView.viewKey)});menu.find("[size]").click(function(e){track("changeHeadsUpSize");maxVisible=$(this).attr("size");settings.maxVisible=maxVisible;HeadsUp.saveSections();renderSizes();refresh()});menu.find(".hideEmpty").click(function(e){track("hideWhenEmpty");hideEmpty=!hideEmpty;settings.hideEmpty=hideEmpty;HeadsUp.updateSection(settings);renderHideEmpty();refresh()});menu.find(".removeFromInbox").click(function(e){track("removeFromInbox");HeadsUp.removeSection(settings.viewKey)});sectionEl.find(".menuArea .goToPipeline").easyHoverClass("aqi");menu.find(".J-N").easyHoverClass("J-N-JT");button.easyHoverClass("J-JN-M-I-JW");var renderHideEmpty=function(){menu.find(".hideEmpty").toggleClass("J-Ks-KO",hideEmpty);if(hideEmpty){menu.find(".hideEmpty").css({paddingLeft:"20px"})}else{menu.find(".hideEmpty").css({paddingLeft:""})}};var renderSizes=function(){menu.find("[size]").removeClass("J-Ks-KO");menu.find("[size="+maxVisible+"]").addClass("J-Ks-KO")};var renderTitle=function(){sectionEl.find(".sectionTitle .streak__headsUp_name").text(savedView.name);sectionEl.find(".sectionTitle .streak__headsUp_pipeline").text("("+pipeline.displayNameText()+")");input.val(savedView.name)};var refresh=function(force){if(!force&&!sectionEl.isVisible()){isDirty=true;return}sectionEl.find(".boxRows").empty();headsUpBoxesDataController.runDataTransforms(transformSettings);maxVisible=settings.maxVisible||5;visible=[];var transformedData=headsUpBoxesDataController.getTransformedData();_.each(transformedData.groups,function(group){if(visible.length<maxVisible){_.each(transformedData.lists[group].list,function(box){if(visible.length<maxVisible){var row=renderRow(box,transformedData.lists[group].displayNameText(),transformedData.lists[group].color);visible.push(row);sectionEl.find(".boxRows").append(row)}else{return}})}else{return}});var total=_(transformedData.lists).chain().values().pluck("list").flatten(true).value().length;sectionEl.find(".numVisible").html(visible.length);sectionEl.find(".numTotal").html(total);if(visible.length>0){sectionEl.find(".startNum").html("1")}else{sectionEl.find(".startNum").html("0")}if(visible.length===0&&hideEmpty){sectionEl.hide()}else{sectionEl.show()}isDirty=false};var renderRow=function(box,group,color){if(!color){color={backgroundColor:"#ddd",textColor:"white"}}var row=$(HeadsUp.templates.row({groupcolor:color.backgroundColor,textcolor:color.textColor}));var updateRowDetails=function(){row.find(".title").text(box.get("name"));row.find(".group").text(group);row.find(".detailsText").text(getDetailsText());row.find(".boxDate").text(Date.ccreate(box.get("lastUpdatedTimestamp")).getGmailFormatted())};var getDetailsText=function(){var dText=$.cleanText(box.get("notes")).trim()||"";var text="";var fields=pipeline.getFields();if(savedView.columnSettings&&savedView.columnSettings.columns){fields=savedView.columnSettings.columns}for(var i=0;i<fields.length;i++){text="";var tField=fields[i];var fieldKey=null;var type=null;if(tField.fieldKey){fieldKey=tField.fieldKey;text=box.getFieldDisplayTextValue(fieldKey)}else if(!tField.property){fieldKey=tField.key();text=box.getFieldDisplayTextValue(fieldKey)}else if(tField.property&&!BB.Models.Pipeline.isDefaultProperty(tField.property)){text=box.getTextValue(tField.property)}if(text&&text.trim&&text.trim().length>0){dText+=(dText.length>0?", ":"")+text}}return dText};row.click(function(e){track("boxLinkClicked");row.trigger("boxClick");e.preventDefault();e.stopPropagation();BB.UI.setURL(box.link())});updateRowDetails();return row};var transformSettings={groupByTransform:BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.convertSettings(savedView.settings.groupBySettings),sortTransform:BB.Modules.PipelineView.ViewSettings.SortSettings.convertSettings(savedView.settings.sortSettings),filterTransform:BB.Modules.PipelineView.ViewSettings.FilterSettings.convertSettings(savedView.settings.filterSettings)};renderHideEmpty();renderSizes();renderTitle();refresh(true);headsUpBoxesDataController.addDelegate({boxDataChanged:refresh});pipeline.watch("groupColorsChanged",function(){refresh(true)},this);pipeline.watch("stageChange",refresh,this);Streak.NotificationCenter.subscribe({eventName:"savedViewChanged",filterParameters:{sender:pipeline,viewKey:settings.viewKey},observer:this,functionToCall:function(notification){savedView=pipeline.getSavedView(settings.viewKey);transformSettings={groupByTransform:BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.convertSettings(savedView.settings.groupBySettings),sortTransform:BB.Modules.PipelineView.ViewSettings.SortSettings.convertSettings(savedView.settings.sortSettings),filterTransform:BB.Modules.PipelineView.ViewSettings.FilterSettings.convertSettings(savedView.settings.filterSettings)};renderTitle();refresh(true)}});section.el=sectionEl;section.refresh=refresh;section.getIsDirty=function(){return isDirty};section.destroy=function(){};HeadsUp.sectionMap[settings.viewKey]=section;return section},updateSection:function(newSectionSettings){var sections=this.getSettings();var indexOf=_.indexOfPlus(sections,function(sectionSettings){return sectionSettings.viewKey===newSectionSettings.viewKey});sections[indexOf]=newSectionSettings;BB.UserSettings.setSetting("headsUp/sections",sections);BB.UserSettings.saveSettings()},saveSections:function(){BB.getUser().saveHeadsUpSections();this.render()}};Streak.DependencyManager.addFunction({functionKey:"headsUpInitialized",functionToCall:HeadsUp.init,functionContext:HeadsUp,dependentFunctionKeys:["gmailLoaded","data.pipelines.initialized","data.boxes.initialized","htmlLoaded"]});BB.Modules.HeadsUp=HeadsUp})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HeadsUpBoxesDataController=Streak.Class.subclass({className:"HeadsUpBoxesDataController",superclass:Streak.UI.Delegator,_memberVariables:[{name:"_pipeline",destroy:false},{name:"_transformedData",destroy:false,get:true,defaultValue:{}}],runDataTransforms:function(transformSettings){this._runDataTransforms(transformSettings)},_initialize:function(pipelineKey){Streak.UI.Delegator.prototype._initialize.call(this);this._pipeline=BB.Data.getPipeline(pipelineKey);this._bindToModelChanges()},_runDataTransforms:function(transformSettings){BB.Data.getPipelineBoxes(this._pipeline.key()).sortByParameter("lastUpdatedTimestamp");this._initializedTransformedData();this._applyTransforms(transformSettings)},_initializedTransformedData:function(){this._transformedData.columns={};this._transformedData.columnOrder=[];this._transformedData.lists={novalue:{isEditable:false,groupModel:null,list:(BB.Data.getPipelineBoxes(this._pipeline.key())||[]).slice(0),color:null,isOpen:true}};this._transformedData.groups=["novalue"]},_applyTransforms:function(transformSettings){var transforms=_.flatten(_.values(BB.Modules.PipelineTransformRegister.getNamedTransforms()));if(!transforms){return}var pipeline=this._pipeline;var transformedData=this._transformedData;_.chain(transforms).sortBy(function(transform){if(!transform.priority){return 100}return transform.priority}).each(function(transform){var settings;if(transformSettings){settings=transformSettings[transform.transformName]}transform(pipeline,transformedData,null,settings)})},_bindToModelChanges:function(){this._bindToBoxCollectionChanges();this._bindToPipelineChanges()},_bindToBoxCollectionChanges:function(){var boxCollection=BB.Data.getPipelineBoxes(this._pipeline.key());var self=this;boxCollection.watch("change",this._boxChanged,this);boxCollection.watch("collectionChange",this._boxCollectionChanged,this)},_boxChanged:function(notification){if(notification.transactionId){return}var box=notification.model;var property=notification.property;var previousValue=notification.previousValue;var fieldKey=notification.property;if(property==="pipelineKey"){return}if(!box||!box.key||!box.key()){return}this._callDelegateFunction("boxDataChanged")},_boxCollectionChanged:function(notification){if(notification.transactionId){return}this._callDelegateFunction("boxDataChanged")},_bindToPipelineChanges:function(){this._pipeline.watch("calculationComplete",function(){this._callDelegateFunction("boxDataChanged")},this)}});Library.set("BentoBox.Modules.HeadsUpBoxesDataController",HeadsUpBoxesDataController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,StateMachine=Streak.StateMachine,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;
var LeftLink={el:null,previousView:null,previousLink:null,sm:null,isOpen:false,isOn:false,arePipelinesHidden:false,pipelineMap:{},savedViewMap:{},pipelineList:[],inactive:false,initialized:false,trackingContext:{widgetContext:"leftLink"},init:function(cb){var self=this;self.inactive=false;if(!self.initialized){this.templates={};this.templates.linkItem=Streak.Template.underscore("modules/leftLink/linkItem");this.el=HTML.get("leftLinkWrapper",true);this.link=this.el.find(".linkItem");this.elements={};this.initActions();this.setupPipelineMenu();this.setupSavedViewsMenu();Gmail.observe("viewChanged",this.handleViewChanged.bind(this));BB.bind("logged_out",function(){self.inactive=true});this.newModal=BB.Widgets.NewPipelineModal.create({title:BB.FirstRun.getStage()===1?BB.Locale.getString("left_link_setup_first"):BB.Locale.getString("left_link_make_new"),pipelineSavedCallback:function(pipeline){BB.UI.setURL(pipeline.link())}});this.el.find(".new, .newPipeline").hide()}if(cb){cb()}},initializeLoggedOut:function(callback){this.el.detach();if(callback){callback()}},initializeLoggedIn:function(callback){this.attachLink();if(callback){callback()}},initializePipelineLoading:function(callback){var self=this;this.attachLink();this.el.find(".new, .newPipeline").show();this.isOpen=BB.UserSettings.getSetting("leftLink/open");if(this.isOpen===false){this.close()}else{this.open()}var delayedLoadPipelines=_.delayed(function(){self.loadPipelines()},300);BB.Data.getAllPipelines().watch("collectionChange",delayedLoadPipelines,this);BB.Data.getAllPipelines().watch("keyChanged",function(notification){delayedLoadPipelines()},this);BB.Data.getAllPipelines().watch("hiddenSettingToggled",function(){delayedLoadPipelines()},this);Streak.NotificationCenter.subscribe({eventName:"savedViewsChanged",filterParameters:{collectionId:BB.Data.getAllPipelines().getId()},observer:this,functionToCall:delayedLoadPipelines});Streak.NotificationCenter.subscribe({eventName:"set",observer:this,filterParameters:{collectionId:BB.Data.getAllPipelines().getId(),property:"name"},functionToCall:function(notification){var pipeline=notification.model;if(!self.pipelineMap[pipeline.key()]){return}self.pipelineMap[pipeline.key()].listEl.find(".name")[0].innerHTML=pipeline.displayNameHTML()}});BB.Data.getAllPipelines().watch("uiSettingChanged",function(){self._hidePipelineMenu();delayedLoadPipelines()},this);BB.Data.getAllPipelines().watch("colorChanged",function(){self._hidePipelineMenu();delayedLoadPipelines()},this);Gmail.addTimerObserver(function(){self.attachLink();self.handleViewChanged()});this.loadPipelines();if(callback){callback()}},teardown:function(){if(this.el){this.el.detach();this.el.find(".linkList .pipeline").remove();this.pipelineMap={}}this.inactive=true},reup:function(){this.inactive=false;this.loadPipelines()},initActions:function(){var self=this;this.link.find(".listToggle").easyHoverClass("NQ").click(function(e){if(BB.FirstRun.getStage()==1){self.newPipelineShow()}else{if(self.isOpen){self.track("showPipelines");self.close()}else{self.track("hidePipelines");BB.Data.getAllPipelines().refresh();self.open()}BB.UserSettings.setSetting("leftLink/open",self.isOpen);BB.UserSettings.save()}});this.el.find(".new, .newPipeline").click(function(e){self.track("newPipelineClicked");e.preventDefault();e.stopPropagation();self.newPipelineShow()});var hiddenOpen=false;this.el.find(".streak__hiddenPipelines [role=button]").click(function(e){hiddenOpen=!hiddenOpen;if(hiddenOpen){self.el.find(".hiddenLinkList").show();self.el.find(".streak__hiddenPipelines [role=button]").addClass("air")}else{self.el.find(".hiddenLinkList").hide();self.el.find(".streak__hiddenPipelines [role=button]").removeClass("air")}})},initKeyboard:function(){var self=this},handleViewChanged:function(){if(BB.UI.isBentoBoxView()){this.activateLink()}else{this.deactivateLink()}},attachLink:function(){if(!this.el){return}if(this.inactive){this.el.detach();return}if(Gmail.isContacts()){this.el.detach();return}if(this.el.isVisible()){return}var leftBarLinks=Gmail.getLeftbarLinks();if(leftBarLinks){leftBarLinks.parent().find(".n3 div:first").after(this.el);this.link.append(this.elements.menu)}},activateLink:function(){if(this.isOpen){this.deactivateLink();var activeViewLink=Gmail.getActiveViewLink();activeViewLink.removeClass("nZ");activeViewLink.parent().removeClass("fy1Lpf ain");var key=Gmail.getConversationId();var type=Gmail.view;var aModel=null;switch(type){case"pipeline":aModel=BB.Data.getPipeline(key);break}if(aModel){if(Gmail.hash.query){var savedViewElement=this.savedViewMap[Gmail.hash.query];if(savedViewElement&&savedViewElement.isVisible()){savedViewElement.addClass("ain active");savedViewElement.find(".TO").addClass("nZ");return}}var leftLinkObject=this.pipelineMap[aModel.key()];if(!leftLinkObject){return}var el=leftLinkObject.listEl;el.addClass("ain active");el.find(".TO").addClass("nZ")}}else{this.link.addClass("ain active");this.link.find(".TO").addClass("nZ")}},deactivateLink:function(){this.el.find(".linkItem").removeClass("ain active");this.el.find(".linkItem .TO").removeClass("nZ")},open:function(){this.isOpen=true;this.el.find(".listToggle .expando").removeClass("aii").addClass("aih");this.el.find(".pipeline").show();this.el.find(".streak__savedViewsHolder.streak__notHidden").show();this.el.find(".streak__hiddenPipelinesWrapper").show()},close:function(){this.isOpen=false;this.el.find(".listToggle .expando").removeClass("aih").addClass("aii");this.el.find(".pipeline").hide();this.el.find(".streak__savedViewsHolder").hide();this.el.find(".streak__hiddenPipelinesWrapper").hide()},setupPipelineMenu:function(){var self=this;var pipelineMenuElement=LeftLink.PipelineMenu.getElement();this.el.bodyCloseAndStop({closeFunction:function(event){self._hidePipelineMenu()},body:Gmail.elements.body,stop:".pipeline .menuButtonAnchor"});Gmail.elements.body.append(pipelineMenuElement);pipelineMenuElement.hide()},_hidePipelineMenu:function(){var pipelineMenuElement=LeftLink.PipelineMenu.getElement();pipelineMenuElement.fastHide();var currentPipeline=LeftLink.PipelineMenu.getCurrentPipeline();if(!currentPipeline){return}var pipelineLinkItem=this.pipelineMap[currentPipeline.key()];if(!pipelineLinkItem){return}pipelineLinkItem.listEl.find(".TO").trigger("unhold")},setupSavedViewsMenu:function(){var self=this;var menuElement=LeftLink.SavedViewsMenu.getElement();menuElement.bodyCloseAndStop({closeFunction:function(){menuElement.hide()},body:Gmail.elements.body});Gmail.elements.body.append(menuElement);menuElement.hide()},loadPipelines:function(){var self=this;this.arePipelinesHidden=false;this.el.find(".linkList").empty();this.el.find(".hiddenLinkList").empty();this.pipelineMap={};this.pipelineList.length=0;var pipes=BB.Data.getAllPipelines();if(pipes.length>0){this._renderSortedVisiblePipelines();this._renderHiddenPipelines()}if(this.arePipelinesHidden){this.el.find(".streak__hiddenPipelines").show()}else{this.el.find(".streak__hiddenPipelines").hide()}},_renderSortedVisiblePipelines:function(){var self=this;var pipelines=BB.UI.getSortedVisiblePipelines();_.each(pipelines,function(pipeline){self.renderPipeline(pipeline)})},_renderHiddenPipelines:function(){var self=this;var pipelines=BB.Data.getAllPipelines();_.chain(pipelines).filter(function(pipeline){return pipeline.isHidden()}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){self.renderPipeline(pipeline);self.arePipelinesHidden=true})},renderPipeline:function(pipeline){var self=this;var listEl=this.renderLeftLinkPipelineItem(pipeline);var key=pipeline.key();this.pipelineMap[pipeline.key()]={listEl:listEl};if(!pipeline.isHidden()){this.pipelineList.push(pipeline.key())}},renderLeftLinkPipelineItem:function(pipeline){var self=this;var color=pipeline.getColor();var el=$(document.createElement("div"));el[0].setAttribute("class","aim linkItem pipeline");el[0].innerHTML=self.templates.linkItem({name:pipeline.displayNameText(),backgroundcolor:color.backgroundColor,textcolor:color.textColor});if(pipeline.isDefaultColor()){el.find(".pM").addClass("aj0")}el.find(".TO").easyHoverClass("NQ");el.find(".TO").click(function(){self.track("pipelineLinkClicked");BB.UI.setURL(pipeline.link()+"?clear")});el.find(".menuButton").click(function(e){e.stopPropagation();if(LeftLink.PipelineMenu.getElement().isVisible()){self._hidePipelineMenu();return}self._showPipelineMenu(pipeline,el.find(".menuButton"))});el[0].oncontextmenu=function(){self.track("showPipelineMenu",{action:"rightClick"});self._showPipelineMenu(pipeline,el.find(".menuButton"));return false};if(this.isOpen===false){el.hide()}var savedViewsHolder=$(document.createElement("div"));savedViewsHolder.addClass("streak__savedViewsHolder");if(pipeline.isHidden()){self.el.find(".hiddenLinkList").append(el);self.el.find(".hiddenLinkList").append(savedViewsHolder)}else{self.el.find(".linkList").append(el);self.el.find(".linkList").append(savedViewsHolder)}var updateSavedViewsDisplay=function(){savedViewsHolder.empty();var savedViews=_.sortBy(pipeline.getSavedViews(),"name");if(savedViews.length>0||pipeline.doesHaveUnsavedView()){var isOpen=BB.LocalSettings.get("leftLink/savedViewCollapseState/"+pipeline.key());if(pipeline.doesHaveUnsavedView()){var unsavedViewLinkItem=self.renderSavedView(pipeline,pipeline.getUnsavedView());savedViewsHolder.append(unsavedViewLinkItem)}_.each(savedViews,function(savedView){var savedViewLinkItem=self.renderSavedView(pipeline,savedView);savedViewsHolder.append(savedViewLinkItem)});var renderViews=function(){if(isOpen===false||self.isOpen===false){el.find(".expando").removeClass("aih").addClass("aii");savedViewsHolder.removeClass("streak__notHidden");savedViewsHolder.hide()}else{el.find(".expando").removeClass("aii").addClass("aih");savedViewsHolder.addClass("streak__notHidden");savedViewsHolder.show()}};el.find(".expando").click(function(e){BB.LocalSettings.set("leftLink/savedViewCollapseState/"+pipeline.key(),!BB.LocalSettings.get("leftLink/savedViewCollapseState/"+pipeline.key()));BB.LocalSettings.save();isOpen=BB.LocalSettings.get("leftLink/savedViewCollapseState/"+pipeline.key());renderViews();e.stopPropagation()});renderViews();if(isOpen===false||self.isOpen===false){savedViewsHolder.hide()}else{savedViewsHolder.show()}}else{el.find(".expando").hide();savedViewsHolder.hide()}};updateSavedViewsDisplay();return el},_showPipelineMenu:function(pipeline,menuAnchor){this.PipelineMenu.setCurrentPipeline(pipeline,this.pipelineList);var pipelineMenuElement=this.PipelineMenu.getElement();pipelineMenuElement.css({position:"fixed",left:menuAnchor.offset().left,top:menuAnchor.offset().top+menuAnchor.outerHeight()+"px"});pipelineMenuElement.fastShow("block");pipelineMenuElement.containByScreen(menuAnchor);var pipelineLinkItem=this.pipelineMap[pipeline.key()].listEl;pipelineLinkItem.find(".TO").trigger("hold")},renderSavedView:function(pipeline,savedView){var self=this;var color=pipeline.getColor();var el=$(document.createElement("div"));el[0].setAttribute("class","aim linkItem pipeline");el[0].innerHTML=self.templates.linkItem({name:savedView.name,backgroundcolor:color.backgroundColor,textcolor:color.textColor});el.find(".pM").addClass("aj0");el.find(".expando").remove();if(savedView.isUnsaved){el.find(".pM").remove()}else{el.find(".menuButton").click(function(e){e.stopPropagation();self._showSavedViewMenu(pipeline,savedView,el.find(".menuButton"))});el[0].oncontextmenu=function(){self.track("showSavedViewMenu",{action:"rightClick"});self._showSavedViewMenu(pipeline,savedView,el.find(".menuButton"));return false}}el.find(".TO").easyHoverClass("NQ").click(function(){self.track("activateSavedView");BB.UI.setURL(pipeline.link()+"?"+savedView.viewKey)});this.savedViewMap[savedView.viewKey]=el;return el},_showSavedViewMenu:function(pipeline,savedView,menuAnchor){this.SavedViewsMenu.setCurrentPipelineAndSavedView(pipeline,savedView);var menuElement=this.SavedViewsMenu.getElement();menuElement.css({position:"fixed",left:menuAnchor.offset().left,top:menuAnchor.offset().top+menuAnchor.outerHeight()+"px"});menuElement.show();menuElement.containByScreen(menuAnchor)},newPipelineShow:function(){if(BB.FirstRun.getStage()==1){this.newModal.show({subHeadingText:BB.Locale.getString("left_link_new_modal_text1"),cancelText:BB.Locale.getString("left_link_add_later")})}else{this.newModal.show({subHeadingText:BB.Locale.getString("left_link_new_modal_text2"),cancelText:BB.Locale.getString("modal_done")})}},currentUserOwnsPipeline:function(pipeline){return pipeline.get("creatorKey")===BB.getUser().key()},track:function(event,prop){BB.Tracker.trackStreakActive(this.trackingContext,prop,{eventName:event})}};Streak.DependencyManager.addFunction({functionKey:"leftLinkInitialized",functionToCall:LeftLink.init,functionContext:LeftLink,dependentFunctionKeys:["gmailLoaded","htmlLoaded","leftLink.pipelineMenuInitialized","leftLink.savedViewsMenuInitialized","newPipelineModalInitialized"]});Streak.DependencyManager.addFunction({functionKey:"leftLink.initializeLoggedOut",functionToCall:LeftLink.initializeLoggedOut,functionContext:LeftLink,dependentFunctionKeys:["leftLinkInitialized","userLoggedOut"]});Streak.DependencyManager.addFunction({functionKey:"leftLink.initializeLoggedIn",functionToCall:LeftLink.initializeLoggedIn,functionContext:LeftLink,dependentFunctionKeys:["leftLinkInitialized","userLoggedIn"]});Streak.DependencyManager.addFunction({functionKey:"leftLink.initializePipelineLoading",functionToCall:LeftLink.initializePipelineLoading,functionContext:LeftLink,dependentFunctionKeys:["leftLinkInitialized","data.pipelines.initialized","data.boxes.initialized","pipelineViewInitialized","userSettingsInitialized","enabledFeaturesControllerInitialized"]});BB.Modules.LeftLink=LeftLink})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Locale=Streak.Locale;var MAX_LINKED_BOXES=2;var LinkedBoxesLimiter=Streak.Class.subclass({superclass:Streak.BentoBox.Services.FeatureLimiter,_memberVariables:[],_initialize:function(){Streak.BentoBox.Services.FeatureLimiter.prototype._initialize.call(this)},_getFeatureKey:function(){return"linkedBoxes"},_getGatewayTitle:function(){return Locale.getString("linked_boxes_gateway_title")},_getGatewayBodyText:function(){return Locale.getString("linked_boxes_gateway_text")},_getLimit:function(){return MAX_LINKED_BOXES}});DependencyManager.addFunction({functionKey:"LinkedBoxesLimiterInitialized",functionReference:function(callback){Library.set("BentoBox.Services.LinkedBoxesLimiter",new LinkedBoxesLimiter)},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,Locale=Streak.Locale,BB=Streak.BentoBox;var LabelIndicators={init:function(callback){this._isTornDown=false;Gmail.InboxManipulator.addDataSource(this);BB.Data.getAllPipelines().watch("colorChanged",function(){Gmail.InboxManipulator.refreshAll()},this);if(callback){callback()}},teardown:function(){this._isTornDown=true},reup:function(){this._isTornDown=false},getRowManipulation:function(hexGmailThreadId){if(this._isTornDown){return}var boxKey=BB.Services.Threads.ThreadStorer.getBoxKey(hexGmailThreadId);if(!boxKey){return}var box=BB.Data.getBox(boxKey);if(box&&box.getPipeline&&box.getPipeline()){return new LabelIndicatorRowManipulation(box)}}};LabelIndicatorRowManipulation=function(box){Gmail.InboxManipulator.InboxRowManipulationBase.call(this);this._box=box;this._pipeline=box.getPipeline();this._element=null;this._setupElement()};LabelIndicatorRowManipulation.prototype=Object.create(Gmail.InboxManipulator.InboxRowManipulationBase.prototype);_.extend(LabelIndicatorRowManipulation.prototype,{_setupElement:function(){this._element=[];this._addBoxTag();this._addStageTag();this._addPipelineTag()},_addPipelineTag:function(){if(!this._isSettingValuePresent("default")&&!this._isSettingValuePresent("pipeline")){return}var color=this._pipeline.getColor();var pipelineTag=this._getLabelTag(this._pipeline.displayNameText(),color,"streak__pipeline_bentoBoxRow");this._element.push(pipelineTag)},_addStageTag:function(){if(!this._isSettingValuePresent("stage")){return}var stageTag=this._getLabelTag(this._box.getStage().displayNameText(),this._getStageColor(),"streak__stage_bentoBoxRow");this._element.push(stageTag)},_getStageColor:function(){var color=BB.UI.getStageColors(this._pipeline)[this._box.get("stageKey")];if(!color){return this._getDefaultOrangeColor()}return color},_addBoxTag:function(){if(!this._isSettingValuePresent("box")){return}var boxTag=this._getLabelTag(this._box.displayNameText(),this._getBoxColor(),"streak__box_bentoBoxRow");this._element.push(boxTag)},_getBoxColor:function(){return this._getDefaultOrangeColor()},_getDefaultOrangeColor:function(){return{backgroundColor:"rgb(255, 173, 71)",textColor:"rgb(0, 0, 0)"}},_getLabelTag:function(text,color,iconClass){var tag=Gmail.widgets.getLabelTag(text,color.backgroundColor,color.textColor);tag.addClass("bentoBoxRowIndicator "+iconClass);tag.find(".at").prepend($("<div/>").addClass("maskedIcon").css("background-color",color.textColor));tag[0].setAttribute("data-tooltip",text);return tag},_isSettingValuePresent:function(value){var setting=BB.Data.streakSettings.getSetting("list_indicator_setting_name");if(!setting){return false}var selectedValues=setting.selectedValues;if(!selectedValues){return false}return selectedValues.indexOf(value)>-1},getManipulationType:function(){return"PREPEND_ELEMENT"},getColumnName:function(){return"LABELS"},getElement:function(){return this._element}});Streak.DependencyManager.addFunction({functionKey:"labelIndicatorsInitialized",functionToCall:LabelIndicators.init,functionContext:LabelIndicators,dependentFunctionKeys:["inboxManipulatorInitialized","data.pipelines.initialized"]});BB.Modules.LabelIndicators=LabelIndicators})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,Locale=Streak.Locale,BB=Streak.BentoBox;var self=PixelTrackerIndicators={init:function(callback){if(!BB.Services.PixelTrackingLimiter.isTrackingEnabled()){if(callback){callback()}return}Gmail.InboxManipulator.addDataSource(self);this._isTornDown=false;if(callback){callback()}},teardown:function(){this._isTornDown=true},reup:function(){this._isTornDown=false},getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(BB.Modules.PixelTrackerUtils.isRecentViewsResultsPage()){return}if(this._isTornDown){return}var listTrackedThread=BB.Services.Threads.ThreadStorer.getTrackedThread(hexGmailThreadId);if(!listTrackedThread){return}return new PixelTrackerIndicatorRowManipulation(listTrackedThread,threadDOMRow)}};PixelTrackerIndicatorRowManipulation=function(listTrackedThread,threadDOMRow){Gmail.InboxManipulator.InboxRowManipulationBase.call(this);this._listTrackedThread=listTrackedThread;this._threadDOMRow=threadDOMRow;this._element=null;this._setupElement()};PixelTrackerIndicatorRowManipulation.prototype=Object.create(Gmail.InboxManipulator.InboxRowManipulationBase.prototype);_.extend(PixelTrackerIndicatorRowManipulation.prototype,{_setupElement:function(){if(!this._threadDOMRow||!this._threadDOMRow.starHolder){return}var tag=$("<span class='as ar streak__pt_eye_indicator'>   </span>");if(this._listTrackedThread.totalViews>0){tag.addClass("streak__pt_eye_indicator_viewed");if(this._isLastViewDateRecent(this._listTrackedThread.newestViewDate)){tag.addClass("streak__pt_eye_indicator_viewedRecently")}}else{tag.removeClass("streak__pt_eye_indicator_viewed")}if(this._threadDOMRow.type==="vertical"){tag.addClass("streak__pt_eye_indicator_verticalPreviewPane");this._threadDOMRow.starHolder.addClass("streak__pt_eye_holder")}else if(this._doesRowHaveAttachment()){tag.addClass("streak__pt_eye_indicator_withAttachment")}tag[0].setAttribute("data-tooltip",this._getViewCountString(this._listTrackedThread.totalViews));if(this._threadDOMRow.attachmentsContainer){this._threadDOMRow.attachmentsContainer.addClass("streak__pt_eye_indicator_present")}this._element=tag},_isLastViewDateRecent:function(newestViewDate){var viewDate=Streak.Date.create(newestViewDate);if(viewDate){if(viewDate.minutesAgo()<2){return true}}return false},_doesRowHaveAttachment:function(){return this._threadDOMRow.attachmentsContainer.find("img").length>0},_getViewCountString:function(totalViews){return BB.Locale.getString("pixel_track_view_count_tooltip",{number:totalViews,pluralize:[totalViews]})},getManipulationType:function(){return"PREPEND_ELEMENT"},getColumnName:function(){var columnName="ATTACHMENTS";if(this._threadDOMRow.type==="vertical"){columnName="STAR"}return columnName},getElement:function(){return this._element}});Streak.DependencyManager.addFunction({functionKey:"pixelTrackerIndicatorsInitialized",functionToCall:PixelTrackerIndicators.init,functionContext:PixelTrackerIndicators,dependentFunctionKeys:["inboxManipulatorInitialized","threadsInitialized","htmlLoaded","userLoggedIn","pixelTrackingLimiterInitialized"]});BB.Modules.PixelTrackerIndicators=PixelTrackerIndicators})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,BB=Streak.BentoBox;var NewBackButton={initialized:false,isPrevStreakView:false,init:function(cb){var self=this;self.isPrevStreakView=Streak.BentoBox.UI.isBentoBoxView();if(!self.initialized){Gmail.observe("viewChanged",function(){if(self.isPrevStreakView){if(Gmail.isGmailView()&&Gmail.isConversation()){self.render()}}else{}self.isPrevStreakView=Streak.BentoBox.UI.isBentoBoxView()})}self.initialized=true;if(cb){cb()}},render:function(){if(Gmail.getCurrentMainContainer().find("[gh=tm] .fake").length===0){var current=Gmail.getCurrentMainContainer().find("[gh=tm] [role=button]:first").parent();var fake=$($(document.createElement("div")).append(current.clone(false)).remove().html());fake.addClass("fake");fake.find("[role=button]").removeAttr("act");current.after(fake);current.hide();fake.click(function(e){BB.UI.setURL(BB.UI.fullViewHistory.last(2).first())})}}};Streak.DependencyManager.addFunction({functionKey:"newBackButtonInitialized",functionToCall:NewBackButton.init,functionContext:NewBackButton,dependentFunctionKeys:["gmailLoaded"]});BB.Modules.NewBackButton=NewBackButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var PerformanceModule={initialized:false,statistics:{},init:function(cb){var self=this;if(!self.initialized){self.setUpMemoryReporting();self.setupGmailPerformanceReporting();self.initialized=true}if(cb){cb()}},getTime:function(){var currentTimeMillis=(new Date).getTime();return currentTimeMillis},sendPipelineRenderTime:function(pipeline,time){try{var boxes=Streak.BentoBox.Data.getPipelineBoxes(pipeline.key());this.recordStat("pipelineLoadedTime",time,{numberOfBoxes:boxes.length})}catch(e){}},setUpMemoryReporting:function(){if(!(window.performance&&window.performance.memory&&window.performance.memory.usedJSHeapSize)){return}var self=this;_.repeatEvery(function(){self.recordStat("memoryUsage",window.performance.memory.usedJSHeapSize*1,{numberOfBoxes:BB.Data.getAllBoxes().length,numberOfPipelines:BB.Data.getAllPipelines().length})},1e3*60)},setupGmailPerformanceReporting:function(){var self=this;var currentTime;window.addEventListener("hashchange",function(){var hash=location.hash.substring(1);var parts=hash.split("/");if(parts.length===2&&parts[0]==="inbox"){currentTime=Date.create()}else{currentTime=null}});Gmail.observe("conversationThreadLoadedEvent",function(){if(!currentTime){return}var loadedTime=Date.create();self.recordStat("gmailConversationLoadedTime",loadedTime.millisecondsSince(currentTime))})},teardown:function(){try{window.clearInterval(this.intervalID)}catch(e){}},recordStat:function(key,value,metadata){if(!this.statistics[key]){this.statistics[key]=[]}var performanceArray=this.statistics[key];performanceArray.push(value);if(performanceArray.length>30){var sum=_.reduce(performanceArray,function(val,memo){return val+memo},0);var average=Math.round(sum/performanceArray.length);var performanceTrackObject=_.extend({},{eventName:key,value:average},metadata);BB.Tracker.trackStreakPerformance(performanceTrackObject);performanceArray.length=0}}};Streak.DependencyManager.addFunction({functionKey:"performanceModuleInitialized",functionToCall:PerformanceModule.init,functionContext:PerformanceModule,dependentFunctionKeys:["data.pipelines.initialized","data.boxes.initialized","gmailLoaded"]});BB.Modules.PerformanceModule=PerformanceModule})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var PipelineView={initialized:false,activePipelineView:null,activePipeline:null,init:function(cb){var self=this;if(!self.initialized){this.templates={};this.templates.pipelineView=HTML.get("pipelineView");Gmail.observe("viewChanged",$.proxy(self.render,self));BB.Keyboard.bindChordToEl({el:Gmail.elements.body,chord:"meta+f/ctrl+f",noBubble:true,noOnInput:false,useCapture:true,keyEvent:"keydown",cb:function(e){if(_.isReal(self.activePipeline)&&_.isReal(self.activePipelineView)&&self.activePipelineView.el.is(":FastVisible")){e.preventDefault();self.activePipelineView.showSearchBox()}}});BB.Keyboard.bindChordToEl({el:Gmail.elements.body,chord:"meta+g/ctrl+g",noBubble:true,noOnInput:false,useCapture:true,keyEvent:"keydown",cb:function(e){if(_.isReal(self.activePipeline)&&_.isReal(self.activePipelineView)&&self.activePipelineView.el.is(":FastVisible")){e.preventDefault();self.activePipelineView.showSearchBox();self.activePipelineView.findNextSearchBox()}}});self.initialized=true}if(cb){cb()}},resetActivePipelineView:function(){if(this.activePipelineView){this.activePipelineView.destroy();this.activePipelineView=null;this.activePipeline=null}},teardown:function(){if(this.activePipelineView){$.modal.close()}this.resetActivePipelineView()},render:function(){var self=this;if(!BB.UI.isBentoBoxView()){this.resetActivePipelineView();return}if(Gmail.view!==Gmail.Constants.Pipeline){this.resetActivePipelineView();return}if(!Gmail.getConversationId()){this.resetActivePipelineView();return}var pipeline=BB.Data.getPipeline(Gmail.getConversationId());if(!pipeline){this.resetActivePipelineView();return}if(this.activePipeline===pipeline){this.activePipelineView.savedViewsController.parseView();return}this.resetActivePipelineView();try{var startTime=Streak.BentoBox.Modules.PerformanceModule.getTime();this.activePipelineView=this.createPipelineView(pipeline);BB.Data.getPipelineBoxes(pipeline.key()).refresh();BB.UI.getCanvas().append(this.activePipelineView.el);this.activePipelineView.pipelineSpreadsheetViewController.runDataTransforms();this.activePipeline=pipeline;self.activePipelineView.savedViewsEditArea.firstRender();self.activePipelineView.savedViewsStatusBar.updateDisplay();Gmail.getSearchInput().val("pipeline:"+pipeline.displayName());Streak.BentoBox.trigger("pipeLoaded");var endTime=Streak.BentoBox.Modules.PerformanceModule.getTime();Streak.BentoBox.Modules.PerformanceModule.sendPipelineRenderTime(pipeline,endTime-startTime);pipeline.refresh()}catch(err){BB.logError("Pipeline View error \n Pipeline id: "+Gmail.getConversationId(),err)}},createPipelineView:function(pipe){var observer={};var pipeline=pipe,el=$(this.templates.pipelineView());var trackingContext={widgetContext:"pipelineView"};var editTrackingContext=_.extend({eventName:"PipelineDataEdited"},trackingContext);var title=BB.Widgets.SmartTextbox.create({model:pipeline,property:"name",autoGrow:true,trackingContext:_.clone(editTrackingContext)});el.find(".info").append(title.el);var pipelineLockdownWarning=new BB.Widgets.PipelineLockdownWarningViewController(pipeline);el.find(".streak__pipeline_lockdown_warning").html(pipelineLockdownWarning.getView().getElement());var savedViewsController=BB.Modules.PipelineView.SavedViewsController.create({pipeline:pipeline});var pipelineSpreadsheetViewController=new BB.Modules.PipelineSpreadsheetViewController(pipeline.key(),savedViewsController);el.find(".table").append(pipelineSpreadsheetViewController.getView().getElement());var groupbar=BB.Modules.PipelineView.GroupBar.create({pipeline:pipeline,pipelineSpreadsheetViewController:pipelineSpreadsheetViewController,groupJumper:pipelineSpreadsheetViewController,trackingContext:_.clone(trackingContext)});pipelineSpreadsheetViewController.addDelegate(groupbar);el.find(".groups").append(groupbar.el);var savedViewsEditArea=BB.Modules.PipelineView.SavedViewsEditArea.create({pipeline:pipeline,trackingContext:_.clone(trackingContext),savedViewsController:savedViewsController});var savedViewsStatusBar=BB.Modules.PipelineView.SavedViewsStatusBar.create({pipeline:pipeline,trackingContext:_.clone(trackingContext),savedViewsController:savedViewsController,savedViewsEditArea:savedViewsEditArea});el.find(".filters").append(savedViewsStatusBar.containerElement);el.find(".filters").append(savedViewsEditArea.containerElement);var summary=Library.getInstance("BentoBox.Modules.PipelineView.PipelineSummaryViewController",savedViewsController,pipelineSpreadsheetViewController);el.find(".bb_wh_right .bb_pipeline_total").html(summary.getView().getElement());pipelineSpreadsheetViewController.addDelegate(summary);var feed=new BB.Widgets.FeedListViewController({model:pipeline,closeCallback:function(){toolbar.showFeed.off()}});el.find(".feed_sidebar_inner").append(feed.getElement());BB.Data.getPipelineBoxes(pipeline.key()).watch("collectionChange",function(){feed.refresh()},observer);BB.Data.getPipelineBoxes(pipeline.key()).watch("change",function(notification){if(notification.transactionId){return}feed.refresh()},observer);var toolbar=BB.Modules.PipelineView.PipelineToolbar.create({pipeline:pipeline,pipelineSpreadsheetViewController:pipelineSpreadsheetViewController,feed:feed,groupbar:groupbar,savedViewsController:savedViewsController,trackingContext:_.clone(trackingContext)});el.find(".toolbar").append(toolbar.el);pipelineSpreadsheetViewController.addDelegate(toolbar);pipeline.watch("removedFromCollection",function(){PipelineView.removePipeline(pipeline)},observer);var searchBox=BB.Widgets.SearchBox.create({searchController:pipelineSpreadsheetViewController.getPipelineSearchController()});pipelineSpreadsheetViewController.getPipelineSearchController().addDelegate(searchBox);var searchBoxAttached=false;function showSearchBox(){if(searchBoxAttached){searchBox.el.show();searchBox.el.find(".pipelineSearchInput").select()}else{searchBoxAttached=true;Streak.Gmail.getCurrentMainContainer().append(searchBox.el);$(searchBox.el).addClass("searchBox")}$(searchBox.el).find(".pipelineSearchInput").focus();searchBox.el.addClass("showDown");searchBox.startUsing()}function findNextSearchBox(){searchBox.findNext()}function hideSearchBox(){searchBox.el.removeClass("showDown");searchBox.el.addClass("hideUp")}function destroy(){Streak.NotificationCenter.unsubscribe({observer:observer});pipelineLockdownWarning.destroy();savedViewsController.destroy();summary.destroy();toolbar.destroy();groupbar.destroy();pipelineSpreadsheetViewController.destroy();searchBox.destroy();savedViewsEditArea.destroy();feed.destroy();title.destroy();el.remove()}return{el:el,pipelineSpreadsheetViewController:pipelineSpreadsheetViewController,savedViewsController:savedViewsController,savedViewsEditArea:savedViewsEditArea,savedViewsStatusBar:savedViewsStatusBar,destroy:destroy,showSearchBox:showSearchBox,hideSearchBox:hideSearchBox,findNextSearchBox:findNextSearchBox}},removePipeline:function(pipeline){var key=pipeline.key();if(key===Gmail.getConversationId()){BB.UI.setURL("inbox")}if(this.activePipeline===pipeline){this.activePipelineView.destroy();this.activePipelineView=null;this.activePipeline=null}},getSelectedBoxes:function(){if(!this.activePipelineView){return[]}return this.activePipelineView.pipelineSpreadsheetViewController.getCheckedBoxes()}};Streak.DependencyManager.addFunction({functionKey:"pipelineViewInitialized",functionToCall:PipelineView.init,functionContext:PipelineView,dependentFunctionKeys:["keyboardInitialized","htmlLoaded","localeLoaded"]});
BB.Modules.PipelineView=PipelineView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var CONSTANTS={PREFIX:"spreadsheetSettings/pipeline/"};var ViewSettingsUtility={_getKey:function(key,pipeline){return CONSTANTS.PREFIX+pipeline.key()+"/"+key},setSharedSetting:function(key,settings,pipeline,dontSave){pipeline.setUISettings(this._getKey(key,pipeline),settings,null,dontSave)},getSharedSetting:function(key,pipeline){return pipeline.getUISettingsByPath(this._getKey(key,pipeline))},setPrivateSetting:function(key,settings,pipeline,dontSave){BB.UserSettings.set(this._getKey(key,pipeline),JSON.stringify(settings));if(!dontSave){BB.UserSettings.save()}},getPrivateSetting:function(key,pipeline){var setting=BB.UserSettings.get(this._getKey(key,pipeline));if(setting){try{return JSON.parse(setting)}catch(err){}}return null}};function convertSettings(callback){if(!BB.UserSettings.get("spreadsheetSettingsConverted")){var queuedSaves=[];_.each(BB.Data.getAllPipelines(),function(pipeline){try{var preKey=pipeline.key().replace(/\_/gi,"/")+"/pipeline/spreadsheet/";var oldColumnSettings=BB.UserSettings.get(preKey+"column/settings");if(oldColumnSettings){try{oldColumnSettings=JSON.parse(oldColumnSettings)}catch(err){oldColumnSettings=null}}var oldGroupBarSettings=pipeline.getUISettingsByPath("groupbar/stageKey");var newColumnWidthSettings=ViewSettingsUtility.getSharedSetting("columnWidth",pipeline);if(!newColumnWidthSettings&&oldColumnSettings){newColumnWidthSettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnWidthSettings.create(pipeline);_.each(oldColumnSettings.columns,function(setting){var columnKey=getColumnKey(setting);if(_.isReal(setting.width)){newColumnWidthSettings.data[columnKey]=setting.width}});BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnWidthSettings.save(newColumnWidthSettings,pipeline,true)}var newColumnOrderSettings=ViewSettingsUtility.getSharedSetting("columnOrder",pipeline);if(!newColumnOrderSettings&&oldColumnSettings){newColumnOrderSettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.create(pipeline);newColumnOrderSettings.data=_.map(oldColumnSettings.columns,getColumnKey);BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.save(newColumnOrderSettings,pipeline,true)}var newGroupColorSettings=ViewSettingsUtility.getSharedSetting("groupColors",pipeline);if(!newGroupColorSettings&&oldGroupBarSettings){newGroupColorSettings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings.create(pipeline);newGroupColorSettings.data=oldGroupBarSettings.colors;BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings.save(newGroupColorSettings,pipeline,true)}var newColumnVisibilitySettings=ViewSettingsUtility.getPrivateSetting("columnVisibility",pipeline);if(!newColumnVisibilitySettings&&oldColumnSettings){newColumnVisibilitySettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.create(pipeline);_.each(oldColumnSettings.columns,function(setting){newColumnVisibilitySettings.data[getColumnKey(setting)]=setting.isVisible});BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.save(newColumnVisibilitySettings,pipeline,true)}pipeline.setUISettings("groupbar",null,null,true);var savedViews=pipeline.getSavedViews();_.each(savedViews,function(savedView){if(savedView.settings.sortSettings){return}var sortSettings=BB.Modules.PipelineView.ViewSettings.SortSettings.create(pipeline);sortSettings.data=extractSortSettings(savedView.settings.columnSettings);var groupBySettings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.create(pipeline);groupBySettings.data=extractGroupSettings(savedView.settings.groupSettings);var newSettings={filterSettings:savedView.settings.filterSettings,sortSettings:sortSettings,groupBySettings:groupBySettings};savedView.settings=newSettings;pipeline.updateSavedView(savedView,true)});queuedSaves.push(_.bind(pipeline.save,pipeline));BB.UserSettings.set(pipeline.key(),null)}catch(err){BB.logError("can't convert settings",err)}});BB.UserSettings.set("spreadsheetSettingsConverted",true);BB.UserSettings.save();_.chainedCallbacks(queuedSaves)}if(callback){callback()}}function getColumnKey(setting){var columnKey;if(setting.systemColumnUnique){columnKey="property|"+setting.systemColumnUnique}else if(setting.property){columnKey="property|"+setting.property}else if(setting.fieldKey){columnKey="field|"+setting.fieldKey}return columnKey}function extractSortSettings(columnSettings){return _(columnSettings.columns).chain().filter(function(setting){return setting.sortOrder>0}).sortBy("sortOrder").reverse().map(function(setting){return{columnKey:getColumnKey(setting),sort:setting.sort}}).value()}function extractGroupSettings(groupSettings,pipeline){if(groupSettings.property){return"property|"+groupSettings.property}else if(groupSettings.fieldKey){return"field|"+groupSettings.fieldKey}else{return"property|stageKey"}}Streak.DependencyManager.addFunction({functionKey:"convertSettings",functionToCall:convertSettings,dependentFunctionKeys:["gmailLoaded","localeLoaded","data.pipelines.initialized","userSettingsInitialized"]});BB.Modules.PipelineView.ViewSettingsUtility=ViewSettingsUtility})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,ColumnSummary=BB.ColumnSummary,Locale=Streak.Locale;var superclass=Streak.UI.ViewController;var PipelineSummaryMenuViewController=Streak.Class.subclass({className:"PipelineSummaryMenuViewController",superclass:superclass,memberVariables:[{name:"_savedViewsController",destroy:false},{name:"_dataSource",destroy:false},{name:"_menu",destroy:true}],_initialize:function(savedViewsController,dataSource){superclass.prototype._initialize.call(this);this._savedViewsController=savedViewsController;this._dataSource=dataSource;this._menu=BB.Widgets.Menu.create({css:{position:"fixed",minWidth:"200px"}});this.hide()},_setupView:function(){},getMenu:function(){return this._menu},getElement:function(){return this._menu.getElement()},show:function(){this._configureMenu();this.getElement().show()},hide:function(){this.getElement().hide()},_setSummaryFunction:function(summaryFunctionName){if(!BB.isFeatureEnabled("formulaFields")&&BB.Services.PipelineSummaryLimiter.isLocked()){BB.Services.PipelineSummaryLimiter.showGateway();return}var settings=BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings.load(this._savedViewsController.pipeline,this._savedViewsController);settings.data.summaryFunction=summaryFunctionName;this._updateSettings(settings);BB.Services.PipelineSummaryLimiter.incrementUsage()},_setColumn:function(columnKey){if(!BB.isFeatureEnabled("formulaFields")&&BB.Services.PipelineSummaryLimiter.isLocked()){BB.Services.PipelineSummaryLimiter.showGateway();return}var settings=BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings.load(this._savedViewsController.pipeline,this._savedViewsController);settings.data.columnKey=columnKey;if(!_.has(this._dataSource.getTransformedData().columns[columnKey].summaryFunctions,settings.data.summaryFunction)){settings.data.summaryFunction=this._dataSource.getTransformedData().columns[columnKey].summaryFunctions[0]||"count"}this._updateSettings(settings)},_updateSettings:function(settings){this._savedViewsController.setSummarySettings(settings);this._configureMenu()},_configureMenu:function(){var self=this;var settings=BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings.load(this._savedViewsController.pipeline,this._savedViewsController);this._menu.empty();var chosenColumn=this._dataSource.getTransformedData().columns[settings.data.columnKey];var summaryFunctions=chosenColumn.summaryFunctions;if(settings.data.columnKey==="property|name"){summaryFunctions=["count"]}this._menu.addHeaderItem("Functions");summaryFunctions.forEach(function(summaryFunctionName){if(summaryFunctionName==="|"){self._menu.addSeparator();return}var summaryFunction=summaryFunctionName;var menuHtml=ColumnSummary.getLocalizedName(summaryFunctionName).escapeHTML();var menuItem=self._menu.addCheckItem(menuHtml,self._setSummaryFunction.bind(self,summaryFunction));menuItem.setCheckboxState(summaryFunction==settings.data.summaryFunction)});this._menu.addSeparator();this._menu.addHeaderItem("Columns");var columnKeys=this._dataSource.getTransformedData().columnOrder;_.each(columnKeys,function(columnKey){if(columnKey==="property|name"||self._dataSource.getTransformedData().columns[columnKey].isSummarizable){var columnName=self._dataSource.getTransformedData().columns[columnKey].getName();var menuItem=self._menu.addCheckItem(columnName.escapeHTML(),self._setColumn.bind(self,columnKey));menuItem.setCheckboxState(settings.data.columnKey===columnKey)}});var menuEl=this._menu.getElement();var parentEl=menuEl.parent();menuEl.css({left:parentEl.offset().left-menuEl.outerWidth()+parentEl.outerWidth(),top:parentEl.offset().top+parentEl.outerHeight()});menuEl.containByScreen(parentEl,{isRightAligned:true})}});BB.Widgets.NewSpreadsheet.PipelineSummaryMenuViewController=PipelineSummaryMenuViewController})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var PipelineSummaryView=Streak.Class.subclass({className:"PipelineSummaryView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this);this._valueEl=this._element.find(".streak__pipeline_summary_value");this._labelEl=this._element.find(".streak__pipeline_summary_label");this._buttonEl=this._element.find(".streak__pipeline_summary_button")},_setupElement:function(){this._element=HTML.getElement("streak__pipeline_summary")},setValue:function(value){this._valueEl.text(value)},setLabel:function(value){this._labelEl.text(value)},click:function(cb){this._buttonEl.click(cb)},append:function(el){this._element.append(el)}});Library.set("BentoBox.Modules.PipelineView.PipelineSummaryView",PipelineSummaryView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,Stripe=Streak.Stripe,BB=Streak.BentoBox,UI=Streak.UI,Pipeline=BB.Models.Pipeline,PipelineSummaryMenuViewController=BB.Widgets.NewSpreadsheet.PipelineSummaryMenuViewController;var superclass=UI.ViewController;function getColumnValues(columnKey,transformedData){var column=transformedData.columns[columnKey];var allBoxes=_.flatten(_.map(transformedData.lists,function(list){return list.list}),true);return _.map(allBoxes,function(box){if(column.property){return box.get(column.property)}else{return box.getFieldValue(column.getField().key())}})}function getPipelineSummary(summaryFunctionName,columnKey,transformedData,pipeline){var values=getColumnValues(columnKey,transformedData);var columnMap=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var columnInfo=columnMap[columnKey];return BB.ColumnSummary.Functions[summaryFunctionName](values,columnInfo.type,pipeline,columnInfo.fieldKey)}var PipelineSummaryViewController=Streak.Class.subclass({className:"PipelineSummaryViewController",superclass:superclass,_memberVariables:[{name:"_savedViewsController",destroy:false},{name:"_dataSource",destroy:false},{name:"_menu",destroy:true}],_initialize:function(savedViewsController,dataSource){superclass.prototype._initialize.call(this);this._savedViewsController=savedViewsController;this._dataSource=dataSource;this._view.click(this.toggleMenu.bind(this));this.update=_.throttle(this._syncUpdate.bind(this),100)},newBoxAdded:function(){this.update()},transformedDataChanged:function(){this.update()},_syncUpdate:function(){if(!this._view||!this._savedViewsController){return}var settings=BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings.load(this._savedViewsController.pipeline,this._savedViewsController);if(settings.data&&settings.data.columnKey&&settings.data.summaryFunction){this._view.setValue(getPipelineSummary(settings.data.summaryFunction,settings.data.columnKey,this._dataSource.getTransformedData(),this._savedViewsController.pipeline));this._view.setLabel(BB.ColumnSummary.getLocalizedName(settings.data.summaryFunction))}else{this._view.setValue("-");this._view.setLabel("Unconfigured");BB.logError("no pipeline summary configuration")}},toggleMenu:function(){if(this._menu){this.closeMenu()}else{this.showMenu()}},showMenu:function(){if(this._menu){return}this._menu=new PipelineSummaryMenuViewController(this._savedViewsController,this._dataSource);this._view.append(this._menu.getElement());this._menu.show();var self=this;this._menu.getElement().bodyCloseAndStop({closeFunction:function(){self.closeMenu()},body:Gmail.elements.body,stop:this._view.getElement()});BB.Tracker.track("pipeline summary menu shown")},closeMenu:function(){if(!this._menu){return}this._menu.getElement().unbindBodyCloseAndStop();this._menu.hide();this._menu.destroy();delete this._menu},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.PipelineView.PipelineSummaryView")},destroy:function(){if(this._menu){this._menu.getElement().unbindBodyCloseAndStop()}Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.PipelineView.PipelineSummaryViewController",PipelineSummaryViewController)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Template=Streak.Template,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var ThreadView={instances:{},initialized:false,activeInstance:null,init:function(cb){var self=this;if(!self.initialized){this.templates={};this.templates.threadView=Template.underscore("modules/threadView/threadView");this.templates.email=Template.underscore("modules/threadView/email");this.templates.emailName=Template.underscore("modules/threadView/emailName");Gmail.observe("viewChanged",function(){self.render()})}self.initialized=true;if(cb){cb()}},render:function(){var self=this;try{if(this.activeInstance&&this.activeInstance.destroy){this.activeInstance.destroy()}if(BB.UI.isBentoBoxView()){if(Gmail.view==Gmail.Constants.GmailThread){if(Gmail.getConversationId()){this.activeInstance=new this.impl(Gmail.getConversationId());BB.UI.getCanvas().append(this.activeInstance.el)}}}}catch(err){BB.logError("Thread view error. Thread ID: "+Gmail.getConversationId(),err)}},impl:function(threadKey){var key=threadKey,thread=null,box=null,pipeline=null,el=$(ThreadView.templates.threadView()),render=function(){el.find(".loadingThreads").show();el.find(".threadViewThreads").hide();APIRequester.get("threads/"+key+"/unifiedcontents").getPromise().then(function(res){var thread=dedupeUnifiedThreads(res.threads);el.find(".loadingThreads").hide();el.find(".threadViewThreads").fadeIn();renderThread(thread)},renderErrorMessage).catch(function(err){BB.logError("Error rendering thread",err);renderErrorMessage({message:"Error rendering thread"})});var box=BB.Data.getBox(thread.get("boxKey"));if(_.isReal(box)&&box!==""){var sidebar=BB.Modules.ConversationSidebar.BoxSidebar.create({box:box,keyboardTabs:true});el.find(".boxInfo").append(sidebar.el);sidebar.el.addClass("loaded");BB.trigger("threadViewLoaded")}},getMessageDate=function(message){var header=_.find(message.payload.headers,function(header){return header.name=="Date"});if(header){return new Date(header.value).getTime()}},getMessageId=function(message){var header=_.find(message.payload.headers,function(header){return header.name=="Message-ID"});return header&&header.value},dedupeUnifiedThreads=function(threadMetas){_.each(threadMetas,function(threadMeta){_.each(threadMeta.thread.messages,function(message){message._ownerKey=threadMeta.userKey})});var thread=_.clone(threadMetas[0].thread);thread.messages=_.flatten(_.pluck(_.pluck(threadMetas,"thread"),"messages"),true);thread.messages=_.sortBy(thread.messages,getMessageDate);thread.messages=_.uniq(thread.messages,true,getMessageId);return thread},renderThread=function(thread){if(!isContextIOThread(thread)&&!isGmailAPIThread(thread)&&!isGmailAPIMessage(thread)){BB.logError("Couldn't understand type of thread returned from server");return}if(thread.messages&&thread.messages.length>0){el.find(".subject").text(getSubjectOfThread(thread))}_.each(getMessagesInThread(thread),function(email){try{var emailEl=renderMessage(thread,email);if(_.isReal(emailEl)){el.find(".emails").append(emailEl)}}catch(err){var msg="Problem rendering email";msg+="\nemail json: "+JSON.stringify(email);BB.logError(msg,err)}})},getSubjectOfThread=function(thread){if(isContextIOThread(thread)){return thread.messages[0].subject}else if(isGmailAPIThread(thread)){return getHeaderValueFromMessage(thread.messages[0],"subject")}else if(isGmailAPIMessage(thread)){return getHeaderValueFromMessage(thread,"subject")}return""},getMessagesInThread=function(thread){if(isContextIOThread(thread)||isGmailAPIThread(thread)){return thread.messages}else if(isGmailAPIMessage(thread)){return[thread]}return[]},renderMessage=function(thread,message){if(isContextIOThread(thread)){return renderContextIOMessage(message)}else if(isGmailAPIThread(thread)){return renderGmailAPIMessage(message)}else if(isGmailAPIMessage(thread)){return renderGmailAPIMessage(message)}},isContextIOThread=function(thread){return _.isReal(thread.email_message_ids)},isGmailAPIThread=function(thread){return _.isReal(thread.historyId)&&!_.isReal(thread.threadId)},isGmailAPIMessage=function(thread){return _.isReal(thread.historyId)&&_.isReal(thread.threadId)},parseEmailAddressesFromHeaderValue=function(addresses){if(!addresses){BB.logError("couldn't parse header for email addresses",null);return[]}var retVal=[];var re=/("(?:[^\\"]|\\.)*")|([^<>\s",;:]+)|<([^>]+@[^>]+)>|(,)/g;var match,tokens=[],email;function pushContact(){if(!email){for(var i=0;i<tokens.length;i++){if(tokens[i].indexOf("@")>-1){email=tokens[i];tokens.splice(i,1);break}}}var name=tokens.join(" ");if(!name.trim()){name=email}if(email){retVal.push({name:name,email:email})}tokens=[];email=undefined}while(match=re.exec(addresses)){var quotedPart=match[1];var unquotedPart=match[2];var angleEmailPart=match[3];var commaPart=match[4];if(commaPart!==undefined){pushContact()}else if(unquotedPart){tokens.push(unquotedPart)}else if(quotedPart){tokens.push(quotedPart.slice(1,-1).replace(/\\/g,""))}else if(angleEmailPart){email=angleEmailPart}}pushContact();return retVal},getHeaderValueFromMessage=function(message,headerName){var header=_.find(message.payload.headers,function(header){return header.name.toLowerCase()==headerName.toLowerCase()});return header===null?null:header.value},renderGmailAPIMessage=function(message){var toHeaderVal=getHeaderValueFromMessage(message,"To");var toAddresses=parseEmailAddressesFromHeaderValue(toHeaderVal);var bodyHTML=getHtmlBody(message);if(!bodyHTML){if(!(message.payload&&message.payload.body&&message.payload.body.size===0)){BB.logError("no email message body found")}bodyHTML=_.escape(BB.Locale.getString("no_message_body"))}var emailList=[];_.each(toAddresses,function(toPerson){emailList.push(ThreadView.templates.emailName(toPerson))});var sendDate=new Date(getHeaderValueFromMessage(message,"Date"));var from=parseEmailAddressesFromHeaderValue(getHeaderValueFromMessage(message,"From"));var emailEl=$(ThreadView.templates.email({imageSrc:BB.Contacts.getGravatarURL(from[0].email),name:from[0].name,email:from[0].email,datetime:sendDate.toString(),gmailDate:sendDate.getGmailFormatted(),emailListHTML:emailList.join(",")}));emailEl.find(".streak__email_body").html(bodyHTML);setupEmailEl(emailEl);return emailEl},sanitizeHTML=function(html){return Streak.caja.html_sanitize(html,function urlTransformer(url){return url},function nameIdClassTransformer(name){return null})},getHtmlBody=function(message){var payload=message.payload;var bodyPart=getBodyPart(payload);if(!bodyPart){return null}else if(bodyPart.type=="text/html"){var html=bodyPart.body.replace(/<img\b([^<>]*)(\/?>)/gi,function(full,attrString,end){try{var attrs=Streak.Utils.parseTagAttributes(attrString);var cidMatch=attrs.src&&attrs.src.match(/^cid:(.*)/);if(cidMatch){var cid=cidMatch[1];attrs.src=Streak.server+"/api/v1/threads/"+encodeURIComponent(threadKey)+"/users/"+encodeURIComponent(message._ownerKey)+"/messages/"+encodeURIComponent(message.id)+"/attachments/"+encodeURIComponent(cid)+"?email="+encodeURIComponent(Streak.userEmail);return"<img "+Streak.Utils.writeTagAttributes(attrs)+end}}catch(e){console.error("failed to parse email image tag",e)}return full});return sanitizeHTML(html)}else{return'<pre class="streak__text_email">'+_.escape(bodyPart.body)+"</pre>"}},getBodyPart=function(payload){if(payload.mimeType=="text/plain"||payload.mimeType=="text/html"){return{type:payload.mimeType,body:Streak.B64.decode(payload.body.data)}}else if(payload.mimeType.indexOf("multipart/alternative")>-1){var htmlBodyPart=_.find(payload.parts,function(part){return part.mimeType=="text/html"});if(htmlBodyPart){return getBodyPart(htmlBodyPart)}var textBodyPart=_.find(payload.parts,function(part){return part.mimeType=="text/plain"});if(textBodyPart){return getBodyPart(textBodyPart)}}else if(payload.mimeType.indexOf("multipart/related")>-1||payload.mimeType.indexOf("multipart/mixed")>-1){for(var ii=0;ii<payload.parts.length;ii++){var result=getBodyPart(payload.parts[ii]);if(result){return result}}}return null},setupEmailEl=function($emailEl){function dumpQuote(){if(quoteLines.length>3){$("<div/>").addClass("streak__collapsible").html(quoteLines.join("\n")).appendTo($plainBody)}else{$plainBody.append(quoteLines.join("\n"))}quoteLines=[]}var $emailBody=$emailEl.find(".streak__email_body");var $plainBody=$emailBody.find(".streak__text_email");var quoteLines=[];if($plainBody.length){var originalLines=$plainBody.html().split("\n");$plainBody.empty();_.each(originalLines,function(line,i){if(line.match(/^&gt;/)){quoteLines.push(line)}else{dumpQuote();$plainBody.append(line+"\n")}});dumpQuote()}else{var $blockquotes=$emailBody.find("blockquote").not($emailBody.find("blockquote blockquote"));$blockquotes.each(function(){var $blockquote=$(this);if($blockquote.next().length&&$blockquote.text().length<300&&_.filter($blockquote.text().split("\n"),function(s){return s.trim()}).length<=5){return}$blockquote.wrap($("<div/>").addClass("streak__collapsible"))})}$emailBody.find(".streak__collapsible").each(function(){var $section=$(this);var $collapser=$("<button/>").addClass("streak__collapse_toggle");var shown;function setState(_shown){shown=_shown;var label=shown?BB.Locale.getString("hide_collapsed"):BB.Locale.getString("show_collapsed");$collapser.attr({"data-tooltip":label,"aria-label":label}).toggleClass("shown",shown);$section.toggle(shown)}setState(false);var $collapserContainer=$("<div/>").addClass("streak__collapse_toggle_container").append($collapser).insertBefore($section);$collapser.click(function(e){setState(!shown)}).mousedown(function(e){e.preventDefault()})})},renderContextIOMessage=function(email){var emailList=[];_.each(email.addresses.to,function(toEmail){emailList.push(ThreadView.templates.emailName({email:toEmail.email,name:toEmail.name||toEmail.email}))});var body=null;if(email.body&&email.body.length>0){body=_.find(email.body,function(aBody){return aBody.type==="text/html"});if(_.isReal(body)){body=sanitizeHTML(body.content)}else{body=_.find(email.body,function(aBody){return aBody.type==="text/plain"});if(_.isReal(body)){body='<pre class="streak__text_email">'+_.escape(body.content)+"</pre>"}}}if(!body){BB.logError("no email message body");return null}var emailEl=$(ThreadView.templates.email({imageSrc:email.person_info[email.addresses.from.email].thumbnail,name:email.addresses.from.name,email:email.addresses.from.email,datetime:new Date(email.date*1e3).toString(),gmailDate:new Date(email.date*1e3).getGmailFormatted(),emailListHTML:emailList.join(","),bodyHTML:body,endComment:"-->",beginComment:"<!--"}));setupEmailEl(emailEl);return emailEl};function renderErrorMessage(thrown){var response=thrown.response;var errors=response&&response.errors;var error=errors&&errors[0];var message=error&&error.details||thrown&&thrown.message;el.find(".loadingThreads").hide();var errorDiv=el.find(".streak__threadView_error");errorDiv.text(message);var emails=_.compact(_.pluck(errors,"userEmail"));if(emails.length){errorDiv.append(Template.underscore("modules/threadView/credentialsError")({emails:emails}))}}BB.Data.getGmailThread(key,function(aThread){thread=aThread;box=BB.Data.getBox(thread.get("boxKey"));pipeline=box.getPipeline();render()});return{el:el,destroy:function(){el.remove()}}}};Streak.DependencyManager.addFunction({functionKey:"threadViewInitialized",functionToCall:ThreadView.init,functionContext:ThreadView,dependentFunctionKeys:["gmailLoaded","data.pipelines.initialized","htmlLoaded","data.gmailThreads.initialized"]});BB.Modules.ThreadView=ThreadView})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var UnifiedMoreMenuOption={init:function(){BB.Services.MoreMenuManager.registerButton({text:BB.Locale.getString("view_unified_thread"),orderHint:2,extraCSSClasses:["unifiedMenuItem"],showFor:this._showFor.bind(this),fn:this._onclick.bind(this)})},getThread:function(){var threadId=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor)[0];if(!threadId){return null}var boxKey=BB.Services.Threads.ThreadStorer.getBoxKey(threadId);if(!boxKey){return null}var box=BB.Data.getBox(boxKey);if(!box){return null}return _.find(box.getThreads(),function(thread){return thread.get("requestingUserThreadGmailId")===threadId})},_showFor:function(view){if(!Gmail.isPreviewPaneConversation()&&view!="conversation"){return false}return!!this.getThread()},_onclick:function(){BB.UI.setURL(this.getThread().link())}};Streak.DependencyManager.addFunction({functionKey:"UnifiedMoreMenuOptionInitialized",functionReference:UnifiedMoreMenuOption.init,functionContext:UnifiedMoreMenuOption,dependentFunctionKeys:["enabledFeaturesControllerInitialized","moreMenuManagerInitialized","threadViewInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SearchResultsView=Streak.Class.subclass({className:"SearchResultsView",superclass:Streak.UI.View,_memberVariables:[{name:"_collapseWidget",destroy:true},{name:"_bodyElement",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._setupBodyElement()},setup:function(){this._setupCollapseWidget();this._element=this._collapseWidget.el},_setupBodyElement:function(){this._bodyElement=HTML.getElement("searchResultsBody")},_setupCollapseWidget:function(){var self=this;this._collapseWidget=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("streak_search_results"),bodyEl:this._bodyElement,openFunc:function(){self._delegate.searchResultsOpen()},closeFunc:function(){self._delegate.searchResultsClose()},startOpen:false,localToggleStateKey:"searchResultsOpenState"});this._collapseWidget.el.addClass("streak__searchResults");this._collapseWidget.el.find(".titleSection").addClass("Wc");this._collapseWidget.el.find(".titleSection h3").addClass("Wd")},setResultsView:function(view){this._bodyElement.find(".streak__searchResultsBody_results").append(view.getElement())},showLoading:function(){this._bodyElement.children().hide();this._bodyElement.find(".streak__searchResultsBody_loading").show()},showNoResults:function(){this._bodyElement.children().hide();this._bodyElement.find(".streak__searchResultsBody_noResults").show()},showResults:function(){this._bodyElement.children().hide();this._bodyElement.find(".streak__searchResultsBody_results").show()}});Library.set("BentoBox.Modules.SearchResultsView",SearchResultsView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Bacon=Streak.Bacon,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SearchResultsViewController=Streak.Class.subclass({className:"SearchResultsViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_searchResultsOpenStateBus",destroy:false},{name:"_searchResultsOpenStateStreamProperty",destroy:false},{name:"_elementRequiredBus",destroy:false},{name:"_elementRequiredStreamProperty",destroy:false},{name:"_searchTermViewBus",destroy:false},{name:"_searchTermViewStreamProperty",destroy:false},{name:"_inboxListViewController",destroy:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._setupStreamProperties();this._setupResultRenderingPipeline();this._view.setup();this._inboxListViewController=new BB.Widgets.InboxListViewController;this._view.setResultsView(this._inboxListViewController.getView())},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.SearchResultsView")},isViewRelevant:function(view){if(!Gmail.isSearch()){return false}var encodedSearchQuery=Gmail.label;var decodedSearchQuery=Streak.Utils.decodeGmailURLSearchString(encodedSearchQuery);if(!decodedSearchQuery||decodedSearchQuery.length===0||decodedSearchQuery.indexOf("label:all before:5")>-1||decodedSearchQuery.indexOf("from:me")>-1){return false}return true},getElement:function(){this._elementRequiredBus.push(true);var encodedSearchQuery=Gmail.label;var decodedSearchQuery=Streak.Utils.decodeGmailURLSearchString(encodedSearchQuery);this._searchTermViewBus.push(decodedSearchQuery);return this._view.getElement()},removeElement:function(){this._elementRequiredBus.push(false);this._view.getElement().detach()},searchResultsOpen:function(){this._searchResultsOpenStateBus.push(true)},searchResultsClose:function(){this._searchResultsOpenStateBus.push(false)},_setupStreamProperties:function(){this._searchResultsOpenStateBus=new Bacon.Bus;this._searchResultsOpenStateStreamProperty=this._searchResultsOpenStateBus.toProperty();this._elementRequiredBus=new Bacon.Bus;this._elementRequiredStreamProperty=this._elementRequiredBus.toProperty(false);this._searchTermViewBus=new Bacon.Bus;this._searchTermViewStreamProperty=this._searchTermViewBus.toProperty()},_setupResultRenderingPipeline:function(){var self=this;var latestSearchTerm;Gmail.getSearchEventStream().toProperty().combine(this._searchResultsOpenStateBus,function(searchTerm,isOpen){if(isOpen){return searchTerm}return null}).filter(function(searchTerm){if(!searchTerm){return false}if(latestSearchTerm===searchTerm){return false}latestSearchTerm=searchTerm;return true}).flatMapLatest(function(searchTerm){self._showLoading();return Streak.APIRequester.get("search",{query:searchTerm,limit:10}).getEventStream().toProperty()}).map(function(searchResults){searchResults.query=Streak.Utils.decodeGmailURLSearchString(searchResults.query);return searchResults}).combine(this._searchTermViewStreamProperty,function(searchResults,searchTermView){if(searchResults.query===searchTermView){return searchResults}return null}).filter(function(searchResults){return!!searchResults}).combine(this._elementRequiredStreamProperty,function(searchResults,isElementRequired){if(isElementRequired&&searchResults.query===latestSearchTerm){return searchResults}return null}).filter(function(searchResults){return!!searchResults}).onValue(this,"_renderSearchResults")},_showLoading:function(){this._view.showLoading()},_renderSearchResults:function(searchResults){if(searchResults.results.length===0){this._view.showNoResults();return}this._inboxListViewController.empty();for(var ii=0;ii<searchResults.results.length;ii++){this._renderBoxResult(searchResults.results[ii].boxKey)
}this._view.showResults()},_renderBoxResult:function(boxKey){var box=BB.Data.getBox(boxKey);if(!box){return}var pipelineText="";if(BB.Data.getAllPipelines().length>1){pipelineText=box.getPipeline().displayNameText()}this._inboxListViewController.addEntry({iconClass:"streak__boxSearchResultIcon",title:box.displayName(),snippet:BB.Services.BoxDisplayText.getDetailsText(box),extraText:pipelineText,clickCallback:function(){BB.Tracker.track("boxLinkClicked");BB.UI.setURL(box.link())}})}});Streak.DependencyManager.addFunction({functionKey:"searchResultsViewControllerInitialized",functionReference:function(){var searchResultsViewController=new SearchResultsViewController;Library.set("BentoBox.Modules.SearchResultsViewController",searchResultsViewController);Gmail.InboxSectionManager.addSection(searchResultsViewController)},dependentFunctionKeys:["htmlLoaded","userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var trackingContext={widgetContext:"searchOverride"};var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};var SearchOverride={templates:{},menu:null,initialized:false,override:false,showingPipelines:false,currentItemList:[],CONST:{PIPELINE:"pipeline",BOX:"box"},init:function(cb){var self=this;if(!self.initialized){self.initActions();self.initialized=true}if(cb){cb()}},initActions:function(){var self=this;var val=Gmail.getSearchInput().val();Gmail.getSearchInput().keyup(function(e){if(val!==Gmail.getSearchInput().val()){val=Gmail.getSearchInput().val();self.startRender()}});Gmail.getSearchInput().blur(function(){setTimeout(function(){if(self.menu){self.menu.el.hide()}if(self.cursor){self.cursor.pause()}},250)});BB.Keyboard.bindChordToEl({el:Gmail.getSearchInput(),chord:"enter",cb:function(e){var searchInputValue=Gmail.getSearchInput().val();if(!searchInputValue.startsWith(self.CONST.PIPELINE+":")&&!searchInputValue.startsWith(self.CONST.BOX+":")){return}if(self.menu&&self.menu.el.isVisible()){return}e.preventDefault();e.stopImmediatePropagation()},useCapture:true});BB.Keyboard.bindChord("w,p",function(e){Gmail.getSearchInput().val(self.CONST.PIPELINE+":");self.startRender();Gmail.getSearchAutoComplete().show();Gmail.getSearchInput().focus()},BB.Locale.getString("keyboard_go_to_pipeline"));BB.Keyboard.bindChord("w,b",function(e){Gmail.getSearchInput().val(self.CONST.BOX+":");self.startRender();Gmail.getSearchAutoComplete().show();Gmail.getSearchInput().focus()},BB.Locale.getString("keyboard_go_to_box"));BB.Keyboard.bindChordToElement(Gmail.getSearchInput(),"escape",function(){Gmail.getSearchAutoComplete().hide();Gmail.getSearchInput().blur()},true,true);BB.Keyboard.bindChordToElement(Gmail.getSearchInput(),"right",function(e){if(self.override&&self.showingPipelines){setTimeout(function(){Gmail.getSearchAutoComplete().hide()},100);if(Gmail.getSearchInput().caret().start===Gmail.getSearchInput().val().length){var position=self.cursor.getPosition();if(position<self.currentItemList.length){setTimeout(function(){Gmail.getSearchInput().val(self.CONST.PIPELINE+":"+self.currentItemList[position].displayName()+" "+self.CONST.BOX+":")},50)}}}});self.cursor=BB.Cursor.create({selectedClass:"J-N-JT",highlightOnHover:true,selectFunc:function(el){el.click()},rollOver:true,input:Gmail.getSearchInput(),aggressiveInputCapture:true})},startRender:function(){var self=this;var val=Gmail.getSearchInput().val();self.cursor.resume();Gmail.getSearchAutoComplete().css({visibility:"visible"});self.showingPipelines=false;self.currentItemList.length=0;if(val.startsWith(self.CONST.PIPELINE+":")){if(val.indexOf(self.CONST.BOX+":")>-1){var parts=val.split(self.CONST.BOX+":");var pipelineText=parts[0];var boxName=parts[1];pipelineText=pipelineText.replace(self.CONST.PIPELINE+":","").trim().toLowerCase();var boxCollection=[];var pipelines=BB.Data.getAllPipelines();for(var ii=0;ii<pipelines.length;ii++){if(pipelines[ii].displayName().toLowerCase().indexOf(pipelineText)>-1){boxCollection=boxCollection.concat(BB.Data.getPipelineBoxes(pipelines[ii].key()))}}self.renderItems(boxName,boxCollection,"name","box")}else{self.renderItems(val.replace(self.CONST.PIPELINE+":",""),BB.Data.getAllPipelines(),"name","pipeline");self.showingPipelines=true}}else if(val.startsWith(self.CONST.BOX+":")){self.renderItems(val.replace(self.CONST.BOX+":",""),BB.Data.getAllBoxes(),"name","box")}else{if(self.cursor){self.cursor.pause()}if(self.menu){self.menu.el.hide()}Gmail.getSearchInput().next().show()}},renderItems:function(query,list,field,type){var self=this;self.override=false;Gmail.getSearchAutoComplete().css({visibility:"hidden"});Gmail.getSearchInput().next().hide();if(self.menu){self.menu.el.remove()}self.menu=BB.Widgets.Menu.create({css:{position:"absolute",zIndex:"1000",width:Gmail.getSearchContainer().width(),top:Gmail.getSearchContainer().height()}});self.menu.el.addClass("searchMenu");var fList=_.filter(list,function(obj){return obj.get(field).toLowerCase().indexOf(query.toLowerCase())>-1});if(fList.length>0){self.override=true;fList.sortBy(function(obj){return-1*obj.get(field).intersectionLength(query)}).first(10).each(function(obj){var num=0;if(type==="pipeline"){num=BB.Data.getPipelineBoxes(obj.key()).length}self.renderItem(obj.get(field),obj.link(),query,type,num);self.currentItemList.push(obj)});self.cursor.setup(self.menu.el.find(".menuItem"));Gmail.getSearchContainer().append(self.menu.el)}},renderItem:function(name,link,query,type,num){name=name.escapeHTML();var lName=name.toLowerCase();var lQuery=query.toLowerCase();var index=lName.indexOf(lQuery);var msg=name.first(index);msg+='<b class="Jd-JU">'+query+"</b>";msg+=name.substring(index+query.length);if(num){msg+=" ("+num+")"}if(type){msg+='<span class="U6"> - '+type+"<span>"}this.menu.addItem(msg,function(){track("searchResultClicked");Gmail.getSearchInput().blur();BB.UI.setURL(link)})}};Streak.DependencyManager.addFunction({functionKey:"searchOverrideInitialized",functionToCall:SearchOverride.init,functionContext:SearchOverride,dependentFunctionKeys:["gmailLoaded","userLoggedIn","data.pipelines.initialized","data.boxes.initialized","keyboardInitialized","localeLoaded"]});BB.Modules.SearchOverride=SearchOverride})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Locale=Streak.Locale,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterMenu=function(){this._currentSendLaterController=null;this._sendLaterDate=null;this._menu=null;this._scheduledDateElement=null;this._dateInput=null;this._scheduledSendButton=null;this._cancelButton=null;this._setupUIComponents()};_.extend(SendLaterMenu.prototype,{setSendLaterController:function(sendLaterController){this._currentSendLaterController=sendLaterController;this._resetUIElements();if(this._currentSendLaterController.hasScheduledDate()){this._dateInput.val(this._currentSendLaterController.getScheduledDate().customFormat("long"));this._menuInner.find(".sendLaterButton").append(this._cancelButton.getElement());this._scheduledSendButton.setText(BB.Locale.getString("send_later_update_time"))}this._processDateInput()},getElement:function(){return this._menu.getElement()},nowShowing:function(){track("openSendLaterMenu");this._dateInput.focus()},_setupUIComponents:function(){this._setupMenuElements();this._setupDateInput();this._setupConvenentTimeLinks();this._setupScheduleSendLaterButton();this._setupCancelButton();this._setupTabOrder()},_setupMenuElements:function(){this._menu=BB.Widgets.Menu.create();this._menuInner=HTML.get("sendLaterMenu",true);this._menu.addSection(this._menuInner);this._dateInput=this._menuInner.find(".date");this._scheduledDateElement=this._menuInner.find(".scheduledDate")},_setupDateInput:function(){var self=this;this._dateInput.keyup(function(e){self._processDateInput()})},_processDateInput:function(){this._scheduledSendButton.disable();this._sendLaterDate=null;var dateInputValue=this._dateInput.val().trim();if(dateInputValue.isBlank()){this._scheduledDateElement.text(BB.Locale.getString("send_later_enter_date"));return}var dateObject=Date.create(dateInputValue);if(!dateObject.isValid()){this._scheduledDateElement.text(BB.Locale.getString("send_later_invalid_date"));return}if(dateObject.isBefore(Date.now())){this._scheduledDateElement.text(BB.Locale.getString("send_later_future_date"));return}this._sendLaterDate=dateObject;this._scheduledDateElement.text(dateObject.customFormat("longWithTimezone"));this._scheduledSendButton.enable()},_setupConvenentTimeLinks:function(){var self=this;this._menuInner.find("a").click(function(e){track("suggestedTimeClick");e.preventDefault();self._dateInput.val(this.title);self._processDateInput()})},_setupScheduleSendLaterButton:function(){var self=this;this._scheduledSendButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("send_later_schedule"),onFunction:function(){self._scheduleSendLaterClicked()}});this._menuInner.find(".sendLaterButton").append(this._scheduledSendButton.getElement())},_scheduleSendLaterClicked:function(){track("createSendLaterAttempt");var errorMsg=this._currentSendLaterController.getErrorMessage();if(errorMsg){BB.ButterBarManager.showError(errorMsg,{time:5e3});track("createSendLaterFail",{reason:errorMsg,userFailure:"true"});return}track("send later scheduled");this._currentSendLaterController.setScheduledDate(this._sendLaterDate)},_setupCancelButton:function(){var self=this;this._cancelButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("cancel_send_later"),onFunction:function(){track("cancelSendLater");self._currentSendLaterController.cancelSendLater()}})},_setupTabOrder:function(){$.tabChain([this._scheduledSendButton.getElement(),this._dateInput])},_resetUIElements:function(){this._dateInput.val("");this._cancelButton.getElement().detach();this._scheduledSendButton.setText(BB.Locale.getString("send_later_schedule"))}});var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Modules.SendLater={};DependencyManager.addFunction({functionKey:"sendLaterMenuInitialized",functionToCall:function(callback){BB.Modules.SendLater.SendLaterMenu=new SendLaterMenu;if(callback){callback()}},dependentFunctionKeys:["htmlLoaded","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterButtonMasterController=function(){Gmail.GmailComposeManager.registerModifierModule(this)};_.extend(SendLaterButtonMasterController.prototype,{getViewControllers:function(){return[new BB.Modules.SendLater.SendLaterButtonViewController,new BB.Modules.SendLater.SendLaterNoticeViewController]}});DependencyManager.addFunction({functionKey:"sendLaterMasterControllerInitialized",functionToCall:function(callback){BB.Modules.SendLater.SendLaterButtonMasterController=new SendLaterButtonMasterController;if(callback){callback()}},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","data.sendLaters.initialized","sendLaterMenuInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterButtonViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._menuButton=null;this._sendLaterModel=null;this._shouldLoad=true};SendLaterButtonViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(SendLaterButtonViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupSendLaterModel();this._setupMenuButton()},allModificationsInitialized:function(){if(this._isSendLaterScheduled()){this._composeWindowViewController.setModuleActive("sendLater");this._composeWindowViewController.notify("sendLaterScheduled",this._sendLaterModel)}},shouldProcessModification:function(){return this._shouldLoad},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"SEND_BUTTON"},getModificationElement:function(){return this._menuButton.getElement()},justAdded:function(){this._updateDisplay()},activeModulesChanged:function(activeModules){this._menuButton.enable();this._shouldLoad=true;if(activeModules.indexOf("threadBox")>-1){this._menuButton.disable();this._menuButton.setTooltip(BB.Locale.getString("send_later_disabled_threadBox"))}if(activeModules.indexOf("pixelTracking")>-1){this._menuButton.disable();this._menuButton.setTooltip(BB.Locale.getString("send_later_disabled_pixel_tracking"))}if(activeModules.indexOf("bumpLater")>-1){this._menuButton.disable();this._menuButton.setTooltip(BB.Locale.getString("send_later_disabled_bump_later"))}},mailMergeActive:function(){if(!this._shouldLoad){return}this._shouldLoad=false;this._composeWindowViewController.reloadModification(this)},mailMergeCancelled:function(){this._shouldLoad=true;this._composeWindowViewController.reloadModification(this)},hasScheduledDate:function(){return this._sendLaterModel&&this._sendLaterModel.get("sendDate")},getScheduledDate:function(){return Date.create(this._sendLaterModel.get("sendDate"))},getErrorMessage:function(){if(this._composeWindowViewController.getToContacts().length===0){return BB.Locale.getString("send_later_need_address")}if(this._composeWindowViewController.getSubject().length===0){return BB.Locale.getString("send_later_need_subject")}},setScheduledDate:function(dateObject){this._menuButton.off();if(!this._sendLaterModel){this._sendLaterModel=BB.Data.newSendLater()}this._sendLaterModel.set("sendDate",dateObject.getTime());this._sendLaterModel.set("subject",this._composeWindowViewController.getSubject());if(this._composeWindowViewController.getDraftId()){this._sendLaterModel.set("gmailDraftId",this._composeWindowViewController.getDraftId());this._sendLaterModel.save()}this._triggerDraftSave();this._composeWindowViewController.close();this._showScheduledMessage()},cancelSendLater:function(){this._menuButton.off();if(this._sendLaterModel){this._sendLaterModel.del()}this._sendLaterModel=null;this._updateDisplay();this._composeWindowViewController.setModuleInactive("sendLater");this._composeWindowViewController.notify("sendLaterCancelled")},shouldNotSend:function(){return this._isSendLaterScheduled()},sendCancelled:function(){this._showBlockModal()},shouldNotDiscard:function(){return this._isSendLaterScheduled()},discardCancelled:function(){this._showBlockModal()},_showBlockModal:function(){if(!this._isSendLaterScheduled()){return}BB.Widgets.Modal.simpleConfirm(BB.Locale.getString("send_later_block_title"),BB.Locale.getString("send_later_block_message"))},_showScheduledMessage:function(){var message=$(document.createElement("span"));message.html(BB.Locale.getString("send_later_scheduled"));message.find("a").click(function(e){e.preventDefault();e.stopPropagation();Gmail.setURL(Gmail.Constants.Drafts)});message.find("a").prop("href","#");BB.ButterBarManager.showMessage({message:message,priority:201})}});_.extend(SendLaterButtonViewController.prototype,{_setupSendLaterModel:function(){var draftId=this._composeWindowViewController.getDraftId();if(draftId){this._sendLaterModel=BB.Services.Threads.ThreadStorer.getSendLater(draftId)}},_setupMenuButton:function(){var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIcon",color:"blue",iconClass:"sendLaterClock",menu:BB.Modules.SendLater.SendLaterMenu,isBottomAligned:true,isFixedPosition:true,preOnFunction:function(){BB.Modules.SendLater.SendLaterMenu.setSendLaterController(self);BB.Tracker.track("send later menu open")},postOnFunction:function(){BB.Modules.SendLater.SendLaterMenu.nowShowing()}});this._menuButton.setTooltip(BB.Locale.getString("send_later"));this._menuButton.addClass("sendLaterClockWrapper")},_updateDisplay:function(){if(this._isSendLaterScheduled()){this._updateScheduledDisplay()}else{this._updateUnscheduledDisplay()}},_updateScheduledDisplay:function(){this._menuButton.addClass("scheduled")},_updateUnscheduledDisplay:function(){this._menuButton.removeClass("scheduled")},_isSendLaterScheduled:function(){return this._sendLaterModel&&this._sendLaterModel.isScheduled()},_triggerDraftSave:function(){this._composeWindowViewController.minimize();this._composeWindowViewController.restore()},draftSaved:function(){if(this._isSendLaterScheduled()){this._sendLaterModel.set("gmailDraftId",this._composeWindowViewController.getDraftId());this._sendLaterModel.save()}},emailSent:function(){if(this._isSendLaterScheduled()){this._sendLaterModel.set("status","SENT_EARLY_BY_USER");this._sendLaterModel.save()}},potentiallyDiscardedOrSent:function(){this._menuButton.off()},discarded:function(){this._menuButton.off();if(this._isSendLaterScheduled()){this._sendLaterModel.del()}},destroy:function(){if(this._menuButton){this._menuButton.off();this._menuButton.destroy()}this._composeWindowViewController=null;this._callDelegateFunction("destroy",this)}});BB.Modules.SendLater.SendLaterButtonViewController=SendLaterButtonViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterNoticeViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._element=null;this._sendLaterModel=null;this._modificationParameters=null};SendLaterNoticeViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(SendLaterNoticeViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._generateSendLaterNoticeElement()},shouldProcessModification:function(){return this._sendLaterModel!==null},aboutToProcessModification:function(){this._element.find(".sendLaterBottomMessage").html(this._getSendLaterNoticeMessage())},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM"},shouldModificationAdjustHeight:function(){return true},getModificationElement:function(){return this._element},destroy:function(){this._element.remove();this._composeWindowViewController=null},sendLaterScheduled:function(sendLaterModel,isReply){this._sendLaterModel=sendLaterModel;if(isReply){this._element.find("a").remove()}this._composeWindowViewController.reloadModification(this)},sendLaterCancelled:function(){if(!this._sendLaterModel){return}this._sendLaterModel=null;this._composeWindowViewController.reloadModification(this)},_generateSendLaterNoticeElement:function(){var self=this;this._element=$(document.createElement("div"));this._element.addClass("aDh sendLaterBottom");this._element[0].innerHTML='<div class="gD sendLaterBottomInner"><span class="exclamation"></span><div class="sendLaterBottomMessage"></div>'+'<a href="#" class="sendLaterCloseDraft">'+BB.Locale.getString("send_later_close_draft")+"</a>"+"</div>";this._element.find("a").click(function(e){self._composeWindowViewController.close();BB.Tracker.track("send later close draft")})},_getSendLaterNoticeMessage:function(){return'<span class="sendLaterMessageLabel">'+BB.Locale.getString("send_later_list_scheduled")+":</span> "+Date.create(this._sendLaterModel.get("sendDate")).customFormat("shortWithWeekday")}});BB.Modules.SendLater.SendLaterNoticeViewController=SendLaterNoticeViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterButtonReplyMasterController=function(){Gmail.GmailReplyManager.registerModifierModule(this)};_.extend(SendLaterButtonReplyMasterController.prototype,{getViewControllers:function(){return[new BB.Modules.SendLater.SendLaterButtonReplyViewController,new BB.Modules.SendLater.SendLaterNoticeViewController]}});DependencyManager.addFunction({functionKey:"sendLaterReplyMasterControllerInitialized",functionToCall:function(callback){BB.Modules.SendLater.SendLaterButtonReplyMasterController=new SendLaterButtonReplyMasterController;if(callback){callback()}},dependentFunctionKeys:["gmailReplyAreaMasterControllerInitialized","data.sendLaters.initialized","sendLaterMenuInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterButtonReplyViewController=Streak.Class.subclass({superclass:BB.Modules.SendLater.SendLaterButtonViewController,_initialize:function(){BB.Modules.SendLater.SendLaterButtonViewController.prototype._initialize.call(this)},allModificationsInitialized:function(){if(this._isSendLaterScheduled()){this._composeWindowViewController.setModuleActive("sendLater");this._composeWindowViewController.notify("sendLaterScheduled",this._sendLaterModel,true)}},shouldProcessModification:function(){return Gmail.isConversationVisible()},_setupSendLaterModel:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(!hexGmailThreadIdList||hexGmailThreadIdList.length===0){return}this._sendLaterModel=BB.Services.Threads.ThreadStorer.getSendLater(hexGmailThreadIdList[0]);if(this._sendLaterModel){var status=this._sendLaterModel.get("status");switch(status){case"SENT":case"ERROR_ON_SEND":case"SENT_EARLY_BY_USER":this._sendLaterModel=null;break}}if(!this._sendLaterModel){this._sendLaterModel=BB.Data.newSendLater();this._sendLaterModel.set("gmailDraftId",hexGmailThreadIdList[0])}var self=this;this._sendLaterModel.watch("save",function(){self._updateDisplay();if(self._isSendLaterScheduled()){self._composeWindowViewController.setModuleActive("sendLater");self._composeWindowViewController.notify("sendLaterScheduled",self._sendLaterModel,true)}},this);this._sendLaterModel.watch("delete",function(){self._setupSendLaterModel();self._updateDisplay();self._composeWindowViewController.setModuleInactive("sendLater");self._composeWindowViewController.notify("sendLaterCancelled")},this);this._sendLaterModel.watch("set",function(){self._setupSendLaterModel();self._updateDisplay();if(self._isSendLaterScheduled()){self._composeWindowViewController.setModuleActive("sendLater");self._composeWindowViewController.notify("sendLaterScheduled",self._sendLaterModel,true)}else{self._composeWindowViewController.setModuleInactive("sendLater");self._composeWindowViewController.notify("sendLaterCancelled")}},this,"status");this._sendLaterModel.incrementNumberOfReplies()},setScheduledDate:function(dateObject){this._menuButton.off();if(!this._sendLaterModel){this._setupSendLaterModel()}this._sendLaterModel.set("sendDate",dateObject.getTime());this._sendLaterModel.set("subject",this._composeWindowViewController.getSubject());this._sendLaterModel.set("sendLaterType","REPLY");var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);this._sendLaterModel.set("gmailDraftId",hexGmailThreadIdList[0]);this._sendLaterModel.save();this._updateDisplay();this._composeWindowViewController.setModuleActive("sendLater");this._composeWindowViewController.notify("sendLaterScheduled",this._sendLaterModel,true);BB.Tracker.track("send later reply scheduled")},cancelSendLater:function(){this._menuButton.off();var sendLaterModel=this._sendLaterModel;this._sendLaterModel=null;if(sendLaterModel){sendLaterModel.del()}this._updateDisplay();BB.Tracker.track("send later reply cancelled")},shouldNotSend:function(){return false},shouldNotDiscard:function(){return false},aboutToSend:function(){if(this._sendLaterModel){this._sendLaterModel.decrementNumberOfReplies()}},aboutToDiscard:function(){if(this._sendLaterModel){this._sendLaterModel.decrementNumberOfReplies()}},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});BB.Modules.SendLater.SendLaterButtonViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.SendLater.SendLaterButtonReplyViewController",SendLaterButtonReplyViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterRefreshManager=Streak.Class.subclass({className:"SendLaterRefreshManager",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._bindToEvents()},_bindToEvents:function(){var self=this;Gmail.observe("viewChanged",function(){self._handleViewChanged()});Gmail.observe("conversationThreadLoadedEvent",function(){self._handleConversationLoaded()})},_handleViewChanged:function(){if(Gmail.isDrafts()){BB.Data.getAllSendLaters().refresh()}},_handleConversationLoaded:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(!hexGmailThreadIdList||hexGmailThreadIdList.length===0){return}var hexGmailThreadId=hexGmailThreadIdList[0];var sendLater=BB.Data.getAllSendLaters().getSendLaterForHexGmailThreadId(hexGmailThreadId);if(sendLater&&sendLater.isSavedOnServer()){sendLater.refresh()}}});Library.set("BentoBox.Modules.SendLaterRefreshManager",new SendLaterRefreshManager)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Gmail.GmailThreadListViewProvider;var SendLaterListThreadListViewProvider=Streak.Class.subclass({className:"SendLaterListThreadListViewProvider",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},getRelevantRequestParameters:function(){return{search:"drafts",view:"tl"}},isCustomList:function(){return false},start:function(pageNumber){},getCrapFormatThreads:function(connection,responseText){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){resolve(self._getThreadsWithHexGmailThreadIdsAdded(responseText))})},_getThreadsWithHexGmailThreadIdsAdded:function(responseText){var currentThreads=Gmail.ThreadResponseProcessor.extractThreads(responseText);if(!currentThreads){return}for(var ii=0;ii<currentThreads.length;ii++){var thread=currentThreads[ii];thread[15]="streakthreadid "+thread[0]}return currentThreads}});Library.set("BentoBox.Modules.SendLaterListThreadListViewProvider",SendLaterListThreadListViewProvider);Gmail.GmailThreadListViewRegister.registerProvider(SendLaterListThreadListViewProvider)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterListInboxRowManipulation=Streak.Class.subclass({className:"SendLaterListInboxRowManipulation",superclass:Gmail.InboxManipulator.InboxRowManipulationBase,_memberVariables:[{name:"_sendLater",destroy:false,set:true},{name:"_hexGmailThreadId",destroy:false,set:true},{name:"_element",destroy:true},{name:"_originalDate",destroy:false}],_initialize:function(){Gmail.InboxManipulator.InboxRowManipulationBase.prototype._initialize.call(this)},setThreadDOMRow:function(threadDOMRow){this._threadDOMRow=threadDOMRow;this._originalDate=threadDOMRow.date.html()},getManipulationType:function(){return"REPLACE_CONTENT"},getColumnName:function(){return"DATE"},getElement:function(){if(this._element){return this._element}var elementHTML;if(this._sendLater.get("status")==="ERROR_ON_SEND"){elementHTML='<span class="bbSendLater errorSendLater">'+BB.Locale.getString("send_later_list_error")+"</span>"}else if(this._sendLater.get("status")==="SENT"){elementHTML='<span class="bbSendLater sendLaterSent">'+BB.Locale.getString("send_later_sent")+"</span>"}else if(this._sendLater.get("sendDate")){elementHTML='<span class="bbSendLater sendLater">'+BB.Locale.getString("send_later_list_scheduled")+": "+Date.create(this._sendLater.get("sendDate")).customFormat("shortFormat")+"</span>"}this._element=$(elementHTML);this._element[0].setAttribute("title","streakthreadid "+this._hexGmailThreadId);return this._element}});Library.set("BentoBox.Modules.SendLaterListInboxRowManipulation",SendLaterListInboxRowManipulation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterListInboxRowManipulationSource=Streak.Class.subclass({className:"SendLaterListInboxRowManipulationSource",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getTableManipulation:function(){if(!Gmail.isDrafts()){return}return{type:"COLUMN_WIDTH",columnName:"DATE",width:200}},getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(!Gmail.isDrafts()){return}var sendLater=BB.Services.Threads.ThreadStorer.getSendLater(hexGmailThreadId);if(!sendLater){return}if(!sendLater.get("sendDate")){return}var rowManipulation=Library.getInstance("BentoBox.Modules.SendLaterListInboxRowManipulation");rowManipulation.setSendLater(sendLater);rowManipulation.setHexGmailThreadId(hexGmailThreadId);return rowManipulation}});Streak.DependencyManager.addFunction({functionKey:"sendLaterListInboxRowManipulationSourceInitialized",functionReference:function(){var source=new SendLaterListInboxRowManipulationSource;Library.set("BentoBox.Modules.SendLaterListInboxRowManipulationSource",source);Gmail.InboxManipulator.addDataSource(source)},dependentFunctionKeys:["inboxManipulatorInitialized","threadsInitialized","htmlLoaded","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SendLaterListDiscardWatcher=Streak.Class.subclass({className:"SendLaterListDiscardWatcher",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);Gmail.observe("viewChanged",this._handleViewChanged.bind(this))},_handleViewChanged:function(){if(!Gmail.isDrafts()){return}this._bindToDiscardButton()},_bindToDiscardButton:function(){var discardButton=Gmail.getDiscardDraftsButton();discardButton.unbind(".streakEvents");discardButton.bind("click.streakEvents",this._handleDiscardButtonClicked.bind(this))},_handleDiscardButtonClicked:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(!hexGmailThreadIdList||hexGmailThreadIdList.length===0){return}for(var ii=0;ii<hexGmailThreadIdList.length;ii++){var sendLater=BB.Services.Threads.ThreadStorer.getSendLater(hexGmailThreadIdList[ii]);if(sendLater){sendLater.del()}}}});Streak.DependencyManager.addFunction({functionKey:"sendLaterListDiscardWatcher",functionReference:function(){Library.set("BentoBox.Modules.SendLaterListDiscardWatcher",new SendLaterListDiscardWatcher)},dependentFunctionKeys:["gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,APIRequester=Streak.APIRequester,HTML=Streak.HTML,Eventer=Streak.Eventer,BB=Streak.BentoBox;
var CONSTANTS={nonPopupVariations:["BasicModal","Modal_var1","Modal_var2","Modal_var3"],newUserVariations:["Modal_var3"],popupVariations:["SideBySide","OauthFirst"],defaultAccounts:[]};var self,SigninPrompt;self=SigninPrompt={currentOauthArgs:null,trackingContext:{widgetContext:"signinPrompt"},initLoggedOut:function(callback){if(this.isDismissedForever()){if(callback){callback()}return}this.initVariation(function(){self.trackingContext.promptVariation=self.promptVariation;self.track("startPrompt");self["start"+self.promptVariation]();if(callback){callback()}})},initVariation:function(doneCallback){var variationArray;if(Streak.debugTrackUser&&Streak.debugTrackUser.isUserFirstCall){variationArray=CONSTANTS.newUserVariations}else{variationArray=CONSTANTS.nonPopupVariations.concat(CONSTANTS.popupVariations)}if(CONSTANTS.defaultAccounts.indexOf(BB.userEmail)>-1){self.promptVariation="Default";doneCallback()}else{self.promptVariation=_.shuffle(variationArray)[_.random(0,variationArray.length-1)];if(CONSTANTS.popupVariations.indexOf(self.promptVariation)>-1){this.arePopupsDisabled(function(isDisabled){if(isDisabled){variationArray=CONSTANTS.nonPopupVariations;self.promptVariation=_.shuffle(variationArray)[_.random(0,variationArray.length-1)]}doneCallback()})}else{doneCallback()}}},arePopupsDisabled:function(doneCallback){var tempWindow=window.open("//mail.google.com/404","test popup","height="+2+",width="+2+",left="+-2+",top="+-2+",toolbar=0,resizable=0,menubar=0,location=0,status=0,scrollbars=0");if(_.isNotReal(tempWindow)){doneCallback(true);return}setTimeout(function(){if(_.isReal(tempWindow.outerHeight)&&tempWindow.outerHeight===0){doneCallback(true)}else{doneCallback(false)}try{tempWindow.close()}catch(err){}},50)},startSideBySide:function(){var width=$(window).width();var promptWidth=850;var widthDifference=Math.max(width-promptWidth,0);var sideOffset=widthDifference/2;var inner=HTML.get("signinPromptOverlay",true);var overlay=BB.Widgets.Tour.Overlay.create({infoHTML:inner,infoCss:{top:"100px",left:"auto",right:sideOffset+"px",fontSize:"120%",width:"380px"},opacity:.8,showRightButton:false,showLeftButton:false});var dismiss=inner.find("#signinPromptDismissForever");dismiss.on("click",function(e){self.track("dismissForeverClicked");e.preventDefault();self.dismissForever();overlay.destroy();self.openWindow.close()});overlay.show();this.openOauth(sideOffset,150,550,430,function(){overlay.destroy()})},startOauthFirst:function(){self.openOauth(null,null,null,null,null,function(){self.track("signinPromptPostModalShow");var inner=HTML.get("signinPromptModal",true);var modal=BB.Widgets.Modal.create({inner:inner,showCancel:true,showConfirm:false,escClose:false,close:false,showTitle:false,width:"500px",cancelText:"Not Now",cancelFunc:function(){modal.close();self.track("signingPromptPostModalCancel")}});modal.show();var promptButtonContainer=inner.find("#signinPromptButton");var promptButton=BB.Widgets.Button.create({name:"Login Now",color:"blue",onFunc:function(){self.track("signinPromptPostModalLogin");modal.close();self.openOauth()}});promptButton.el.css({margin:"50px auto 50px auto",display:"block",width:"200px",height:"40px",fontSize:"20px",paddingTop:"13px"});promptButtonContainer.append(promptButton.el);inner.find("#signinPromptHelp").html("Streak needs access to function. We don't make any changes to your account and you can remove Streak at any time.");var dismiss=inner.find("#signinPromptDismissForever");dismiss.on("click",function(e){e.preventDefault();self.dismissForever();if(modal){modal.close()}if(self.openWindow){self.openWindow.close()}})})},callShowModal2:function(){this.startModal2("_var1",{},inner)},startModalVideo:function(name,extra_options){defaults={promptButtonText:"Login Now",showCancel:false,showDismiss:false,mainImage:"videoPlayer.png",close:false};options={};$.extend(options,defaults,extra_options);self.track("signinPrompt"+name+"Show");inner=Streak.$("<div></div>");var iframeYoutube=$('<iframe width="560" height="315" src="http://www.youtube.com/embed/VsCCCshi-V0?autoplay=1" frameborder="0" allowfullscreen></iframe>');var footerImgSource=options.mainImage;var footerImg=Streak.server+Streak.combinedPath+"images/"+footerImgSource;var imageContainer=$("<div class='streak_container_modal_why_use_img'><img src='"+footerImg+"'></img></div>").appendTo(inner);imageContainer.append("<div class='streak_signin_show'>Let us show you how to use Streak in under 2 minutes! Here's an example of how a sales person may use Streak - but you can use it to manage any process. </div>");imageContainer.click(function(e){self.track("videoSigningClicked");$(imageContainer.children()).hide();iframeYoutube.appendTo(imageContainer)});inner.append("<div id='signinPromptButton'></div>");var modal=BB.Widgets.Modal.create({inner:inner,showCancel:options.showCancel,showConfirm:false,escClose:options.close,close:options.close,title:BB.Locale.getString("why_streak_goodbye_stress"),width:"560px",cancelText:options.cancelText,cancelFunc:function(){modal.close();self.track("signinPrompt"+name+"Cancel")}});modal.show();var promptButtonContainer=inner.find("#signinPromptButton");var promptButton=BB.Widgets.Button.create({name:options.promptButtonText,color:"blue",onFunc:function(){self.track("signinPrompt"+name+"Login");modal.close();self.openOauth()}});promptButton.el.css({margin:"50px auto 0px auto",display:"block",width:"200px",height:"40px",fontSize:"20px",paddingTop:"10px"});promptButtonContainer.append(promptButton.el)},startModal2:function(name,extra_options,inner){defaults={promptButtonText:"Login Now",showCancel:false,showDismiss:false,mainImage:"ver1StreakModalSignin.png",close:false};options={};$.extend(options,defaults,extra_options);self.track("signinPrompt"+name+"Show");inner=Streak.$("<div></div>");var containerMain=$("<div class='streak_container_modal_why_use'></div>").appendTo(inner);var bulletContainer01=$("<div class='streak_bulletContainer'> </div>").appendTo(containerMain);var bulletPointImg=Streak.server+Streak.combinedPath+"images/bulletPointImage.png";var img01=$("<img src='"+bulletPointImg+"'></img>");var bullet01=$("<div class='bulletStreakModal'>"+BB.Locale.getString("why_streak_bullet_01_01")+"</div>");bulletContainer01.append(img01);bulletContainer01.append(bullet01);var bulletContainer02=$("<div class='streak_bulletContainer'> </div>").appendTo(containerMain);var img02=$("<img src='"+bulletPointImg+"'></img>");var bullet02=$("<div class='bulletStreakModal'>"+BB.Locale.getString("why_streak_bullet_01_02")+"</div>");bulletContainer02.append(img02);bulletContainer02.append(bullet02);var bulletContainer03=$("<div class='streak_bulletContainer'> </div>").appendTo(containerMain);var img03=$("<img src='"+bulletPointImg+"'></img>");var bullet03=$("<div class='bulletStreakModal'>"+BB.Locale.getString("why_streak_bullet_01_03")+"</div>");bulletContainer03.append(img03);bulletContainer03.append(bullet03);var bulletContainer04=$("<div class='streak_bulletContainer'> </div>").appendTo(containerMain);var img04=$("<img src='"+bulletPointImg+"'></img>");var bullet04=$("<div class='bulletStreakModal'>"+BB.Locale.getString("why_streak_bullet_01_04")+"</div>");bulletContainer04.append(img04);bulletContainer04.append(bullet04);var footerImgSource=options.mainImage;var footerImg=Streak.server+Streak.combinedPath+"images/"+footerImgSource;var imageContainer=$("<div class='streak_container_modal_why_use_imgNormal'><img src='"+footerImg+"'></img></div>").appendTo(inner);inner.append("<div id='signinPromptButton'></div>");var modal=BB.Widgets.Modal.create({inner:inner,showCancel:options.showCancel,showConfirm:false,escClose:options.close,close:options.close,title:BB.Locale.getString("why_streak_goodbye_stress"),width:"600px",cancelText:options.cancelText,cancelFunc:function(){modal.close();self.track("signinPrompt"+name+"Cancel")}});modal.show();var promptButtonContainer=inner.find("#signinPromptButton");var promptButton=BB.Widgets.Button.create({name:options.promptButtonText,color:"blue",onFunc:function(){self.track("signinPrompt"+name+"Login");modal.close();self.openOauth()}});promptButton.el.css({margin:"50px auto 0px auto",display:"block",width:"200px",height:"40px",fontSize:"20px",paddingTop:"10px"});promptButtonContainer.append(promptButton.el)},startModal:function(name,extra_options){defaults={promptButtonText:"Continue with Streak",cancelText:"Not Now",showCancel:true,showDismiss:true,close:false};options={};$.extend(options,defaults,extra_options);self.track("signinPrompt"+name+"Show");var inner;if(options.showDismiss){inner=HTML.get("signinPromptModal",true)}else{inner=HTML.get("signinPromptModal",true);inner.find("#signinPromptDismissForever").remove()}var modal=BB.Widgets.Modal.create({inner:inner,showCancel:options.showCancel,showConfirm:false,escClose:options.close,close:options.close,showTitle:false,width:"500px",cancelText:options.cancelText,cancelFunc:function(){modal.close();self.track("signinPrompt"+name+"Cancel")}});modal.show();var promptButtonContainer=inner.find("#signinPromptButton");var promptButton=BB.Widgets.Button.create({name:options.promptButtonText,color:"blue",onFunc:function(){self.track("signinPrompt"+name+"Login");modal.close();self.openOauth()}});promptButton.el.css({margin:"50px auto 50px auto",display:"block",width:"200px",height:"40px",fontSize:"20px",paddingTop:"10px"});promptButtonContainer.append(promptButton.el);if(options.showDismiss){var dismiss=inner.find("#signinPromptDismissForever");dismiss.on("click",function(e){e.preventDefault();self.dismissForever();if(modal){modal.close()}if(self.openWindow){self.openWindow.close()}})}},startBasicModal:function(){self.startModal("Modal",{})},startModal_var1:function(){self.startModal("Modal_var1",{showCancel:false})},startModal_var2:function(){self.startModal("Modal_var2",{showCancel:false,promptButtonText:"Continue with Streak"})},startModal_var3:function(){self.startModal("Modal_var3",{showCancel:false,promptButtonText:"Continue"})},startModal_var4_new:function(){self.startModal2("Modal_var4_new",{promptButtonText:"Continue with Streak",mainImage:"ver1StreakModalSignin.png"})},startModal_var5_new:function(){self.startModal2("Modal_var5_new",{promptButtonText:"Continue with Streak",mainImage:"samplePipeline.png"})},startModal_var6_new:function(){self.startModalVideo("Modal_var6_new",{promptButtonText:"Continue with Streak"})},startDefault:function(){BB.Modules.TopNav.openMenu()},openOauth:function(left,top,height,width,closeCB,notLoggedInCB){self.currentOauthArgs=arguments;self.track("showOauth");var loadingOauth=HTML.get("loadingOauth");if(_.isNotReal(height)){height=550}if(_.isNotReal(width)){width=560}if(_.isReal(left)){left=(window.screenX||window.screenLeft||0)+(left||0)}else{left=window.screenX+(window.outerWidth/2-width/2)}if(_.isReal(top)){top=(window.screenY||window.screenTop||0)+(top||0)}else{top=window.screenY+(window.outerHeight/2-height/2)}var oauthEmail=Streak.originalEmail||BB.userEmail;var oauthLoaderHTML=loadingOauth({streakServer:Streak.server,oauthEmail:oauthEmail});oauthLoaderHTML="data:text/html;base64,"+btoa(oauthLoaderHTML);self.openWindow=window.open(oauthLoaderHTML,"Streak Authorization","height="+height+",width="+width+",left="+left+",top="+top+",toolbar=0,resizable=0,menubar=0,location=0,status=0,scrollbars=0");self.closeChecker=_.repeatEvery(function(){if(self.openWindow&&self.openWindow.closed){self.currentOauthArgs=null;self.closeChecker.stop();BB.Modules.TopNav.showLoading();if(closeCB){closeCB()}self.checkUserAuth(0,notLoggedInCB)}},500)},checkUserAuth:function(num,notLoggedInCB){APIRequester.get("users/me").getPromise().then(function(data){if(data){self.track("signinPromptComplete");BB.UserStateController.userLoggedIn(data);return}if(num<5){setTimeout(function(){self.checkUserAuth(num+1,notLoggedInCB)},500)}else{self.track("signinPromptDenied");BB.Modules.TopNav.showExclamation();if(notLoggedInCB){notLoggedInCB()}}},function(){BB.logError("error user signing in");BB.trigger("error_load");BB.isError=true;BB.Modules.TopNav.showExclamation()})},isDismissedForever:function(){return BB.LocalSettings.get("topNav/loggedOutDismissed")},dismissForever:function(){BB.LocalSettings.set("topNav/loggedOutDismissed",true)},track:function(event){var oauthEmail=Streak.originalEmail||BB.userEmail;BB.Tracker.trackStreakActive(this.trackingContext,{eventName:event,oauthEmail:oauthEmail})}};Streak.DependencyManager.addFunction({functionKey:"signinPromptInitialized",functionToCall:SigninPrompt.initLoggedOut,functionContext:SigninPrompt,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","userLoggedOut"]});BB.Modules.SigninPrompt=SigninPrompt})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsMenuView=function(){Streak.ViewControllerBase.call(this);this._menu=null;this._searchView=null;this._snippetListView=null;this._addSnippetMenuItem=null;this._manageSnippetMenuItem=null;this._emptySnippetSection=null;this._searchListSeparator=null;this._setupUIComponents()};SnippetsMenuView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SnippetsMenuView.prototype,{getElement:function(){return this._menu.getElement()},addSearchView:function(searchView){this._searchView=searchView;this._searchListSeparator=this._menu.addSeparator(true);this._menu.addSection(searchView.getElement(),true)},addSnippetListView:function(snippetListView){this._snippetListView=snippetListView;this._menu.addSection(this._snippetListView.getElement(),true)},showEmptyMessage:function(){this._searchView.getElement().hide();this._snippetListView.getEl().hide();this._searchListSeparator.hide();this._emptySnippetSection.show();this._manageSnippetMenuItem.hide()},showList:function(){this._searchView.getElement().show();this._snippetListView.getEl().show();this._searchListSeparator.show();this._emptySnippetSection.hide();this._manageSnippetMenuItem.show()},reset:function(){this._menu.reset()},destroy:function(){this._menu.destroy()}});_.extend(SnippetsMenuView.prototype,{_setupUIComponents:function(){this._menu=BB.Widgets.Menu.create({maxHeight:370});this._menu.getElement().addClass("snippetsMenuView");this._setupEmptySnippetSection();this._menu.addSeparator();this._setupAddSnippetItem();this._setupManageSnippetItem()},_setupEmptySnippetSection:function(){this._emptySnippetSection=$(document.createElement("div"));this._emptySnippetSection.addClass("streak__snippetsMenu_emptySection");this._emptySnippetSection[0].innerHTML=BB.Locale.getString("snippets_empty");this._menu.addSection(this._emptySnippetSection)},_setupAddSnippetItem:function(){var self=this;this._addSnippetMenuItem=this._menu.addItem(BB.Locale.getString("create_snippet"),function(){self._callDelegateFunction("createSnippet")});this._addSnippetMenuItem.addClass("streak__createSnippet")},_setupManageSnippetItem:function(){var self=this;this._manageSnippetMenuItem=this._menu.addItem(BB.Locale.getString("manage_snippets"),function(){self._callDelegateFunction("manageSnippets")});this._manageSnippetMenuItem.addClass("streak__manageSnippet")}});BB.Modules.Snippets={};BB.Modules.Snippets.SnippetsMenuView=SnippetsMenuView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsMenuViewController=function(){Streak.ViewControllerBase.call(this);this._searchViewController=null;this._listViewController=null;this._snippetsSearchController=null;this._snippetsMenuModel=null;this._view=null;this._snippetSelectedCallback=null;this._manageOpenCallback=null;this._dataSource=null;this._setupViewControllers();this._setupTheView();this._setupDelegates()};SnippetsMenuViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SnippetsMenuViewController.prototype,{use:function(options){this._view.reset();this._searchViewController.clearQuery();this._snippetSelectedCallback=options.snippetSelectedCallback;this._manageOpenCallback=options.manageOpenCallback;this._doesUserHaveSnippetsAndModifyDisplayAppropriately()},getElement:function(){return this._view.getElement()},setDataSource:function(dataSource){this._dataSource=dataSource;this._listViewController.reset()},destroy:function(){Streak.ViewControllerBase.prototype.destroy.call(this);this._searchViewController.destroy();this._listViewController.destroy();this._view.destroy()}});_.extend(SnippetsMenuViewController.prototype,{createSnippet:function(){if(this._manageOpenCallback){this._manageOpenCallback()}BB.Modules.Snippets.SnippetsManageViewController.use();if(!this._dataSource){return}var subject=this._dataSource.getSubject();var body=this._dataSource.getBody();BB.Modules.Snippets.SnippetsManageViewController.addNewSnippet({subject:subject,snippetText:body});BB.Tracker.track("create snippets open")},manageSnippets:function(){if(this._manageOpenCallback){this._manageOpenCallback()}BB.Modules.Snippets.SnippetsManageViewController.use();BB.Tracker.track("manage snippets open")},rowPressed:function(snippetRow){if(snippetRow&&this._snippetSelectedCallback){this._snippetSelectedCallback(snippetRow.data)}}});_.extend(SnippetsMenuViewController.prototype,{_setupViewControllers:function(){this._searchViewController=new BB.Widgets.SearchSimpleVC({placeholder:BB.Locale.getString("search_all_snippets")});this._snippetsMenuModel=new BB.Widgets.ListView.ListViewBaseModel;this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._snippetsSearchController=new BB.Modules.Snippets.SnippetsSearchController},_setupDelegates:function(){this._listViewController.setDataSource(this._snippetsMenuModel);this._snippetsSearchController.setDataSource(this._snippetsMenuModel);this._snippetsMenuModel.addDelegate(this);this._searchViewController.addDelegate(this._listViewController);this._searchViewController.addDelegate(this._snippetsSearchController);this._listViewController.addDelegate(this);this._view.addDelegate(this)},_setupTheView:function(){this._view=new BB.Modules.Snippets.SnippetsMenuView;this._view.addSnippetListView(this._listViewController.getView());this._view.addSearchView(this._searchViewController.getView())}});_.extend(SnippetsMenuViewController.prototype,{_doesUserHaveSnippetsAndModifyDisplayAppropriately:function(){if(BB.Data.getAllSnippets().length>0){this._view.showList();this._searchViewController.focus()}else{this._view.showEmptyMessage()}}});Streak.DependencyManager.addFunction({functionKey:"snippetsMenuViewControllerInitialized",functionToCall:function(callback){BB.Modules.Snippets.SnippetsMenuViewController=new SnippetsMenuViewController;if(callback){callback()}},dependentFunctionKeys:["data.snippets.initialized","localeLoaded","htmlLoaded","data.pipelines.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsSearchController=function(){Streak.ViewControllerBase.call(this);this._snippetListModel=null;this._query=null;this._delayedRenderTimeout=null;this._snippetSectionRowMap={};this._bindToSnippetCollectionChanges()};SnippetsSearchController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SnippetsSearchController.prototype,{PERSONAL_SNIPPET_KEY:"snippets_personal",_bindToSnippetCollectionChanges:function(){var self=this;var delayedQuery=_.debounce(function(){self._querySnippets(self._query)},300);BB.Data.getAllSnippets().watch("collectionChange",function(){delayedQuery()},this);var delayedUpdate=_.debounce(function(){self._updateResults()},300);BB.Data.getAllSnippets().watch("change",function(notification){if(notification.newValue&&notification.previousValue){if(notification.newValue===notification.previousValue){return}}delayedUpdate()},this)},_updateResults:function(){var self=this;clearTimeout(this._delayedRenderTimeout);this._delayedRenderTimeout=setTimeout(function(){self._querySnippets(self._query)},100)},setDataSource:function(snippetListModel){this._snippetsListModel=snippetListModel;this._querySnippets("")},queryChange:function(query){this._querySnippets(query)},destroy:function(){this._snippetsListModel=null;Streak.NotificationCenter.unsubscribe({observer:this})},_querySnippets:function(query){this._query=query;var self=this;this._snippetsListModel.removeAllSections();var groupedSnippets=_.chain(BB.Data.getAllSnippets()).filter(function(snippet){if(!query){return true}return snippet.displayName().toLowerCase().indexOf(query.toLowerCase())>-1}).sortBy(function(snippet){return snippet.displayName()}).groupBy(function(snippet){return snippet.get("pipelineKey")||self.PERSONAL_SNIPPET_KEY}).value();this._addSnippetSections(groupedSnippets);this._callDelegateFunction("snippetsRendered")},_addSnippetSections:function(groupedSnippets){this._snippetSectionRowMap={};var pipelines=[];for(var pipelineKey in groupedSnippets){if(pipelineKey!==this.PERSONAL_SNIPPET_KEY){pipelines.push(BB.Data.getPipeline(pipelineKey))}}pipelines=_.sortBy(pipelines,function(pipeline){return pipeline.displayName()});if(groupedSnippets[this.PERSONAL_SNIPPET_KEY]){this._addSnippetSection(BB.Locale.getString(this.PERSONAL_SNIPPET_KEY),groupedSnippets[this.PERSONAL_SNIPPET_KEY])}for(var ii=0;ii<pipelines.length;ii++){this._addSnippetSection(pipelines[ii].displayName(),groupedSnippets[pipelines[ii].key()])}},_addSnippetSection:function(pipelineTitle,snippets){var snippetRows=_.map(snippets,this._convertSnippetToListRow);var sectionIndex=this._snippetsListModel.addSection({name:pipelineTitle,rows:snippetRows,doesSectionToggle:true,extraHeaderText:"("+snippets.length+")"});for(var ii=0;ii<snippets.length;ii++){this._snippetSectionRowMap[snippets[ii].getId()]={sectionIndex:sectionIndex,rowIndex:ii}}},_convertSnippetToListRow:function(snippet){var snippetText=snippet.displayNameHTML();if(snippet.get("snippetKeyShortcut")){snippetText+='<span class="shortHint">('+_.escape(snippet.get("snippetKeyShortcut"))+")</span>"}return{html:snippetText,data:snippet}},getSnippetListPosition:function(snippet){return this._snippetSectionRowMap[snippet.getId()]}});BB.Modules.Snippets.SnippetsSearchController=SnippetsSearchController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsComposeMasterController=function(){Gmail.GmailComposeManager.registerModifierModule(this);Gmail.GmailReplyManager.registerModifierModule(this)};_.extend(SnippetsComposeMasterController.prototype,{getViewControllers:function(){return[new BB.Modules.Snippets.SnippetsShortcutListenerViewController,new BB.Modules.Snippets.SnippetsAutoCompleteMenuViewController,new BB.Modules.Snippets.SnippetsButtonComposeViewController]}});DependencyManager.addFunction({functionKey:"snippetsComposeMasterControllerInitialized",functionToCall:function(callback){BB.Modules.Snippets.SnippetsComposeMasterController=new SnippetsComposeMasterController;if(callback){callback()}},dependentFunctionKeys:["gmailReplyAreaMasterControllerInitialized","gmailComposeWindowMasterControllerInitialized","snippetsMenuViewControllerInitialized","data.streakSettings.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsButtonComposeViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._menuButton=null};SnippetsButtonComposeViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(SnippetsButtonComposeViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupMenuButton()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"BEFORE_FORMATTING"},getModificationPriority:function(){return 100},getModificationElement:function(){return this._menuButton.getElement()},getListenerType:function(){return"CHORD"},getListenerChord:function(){return"ctrl+."},callListenerCallback:function(){this._menuButton.on();BB.Tracker.track("snippet menu open with chord")},getSubject:function(){if(this._composeWindowViewController.isReply&&this._composeWindowViewController.isReply()){return""}return this._composeWindowViewController.getSubject()},getBody:function(){return this._composeWindowViewController.getComposeBodyHTML()},destroy:function(){this._menuButton.destroy();this._composeWindowViewController=null;this._callDelegateFunction("destroy",this);Streak.ViewControllerBase.prototype.destroy.call(this)}});_.extend(SnippetsButtonComposeViewController.prototype,{_setupMenuButton:function(){var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIcon",color:"icon",iconClass:"snippetIcon",menu:BB.Modules.Snippets.SnippetsMenuViewController,isBottomAligned:true,isFixedPosition:true,postOnFunction:function(){BB.Tracker.track("snippets menu open");self._prepareMenu()}});this._menuButton.addClass("streak__snippetButton");this._menuButton.setTooltip(BB.Locale.getString("snippets_tooltip"))},_prepareMenu:function(){var self=this;BB.Modules.Snippets.SnippetsMenuViewController.use({snippetSelectedCallback:function(snippet){self._menuButton.off();self._snippetSelected(snippet)},manageOpenCallback:function(){self._menuButton.off()}});BB.Modules.Snippets.SnippetsMenuViewController.setDataSource(this)},_snippetSelected:function(snippet){this._composeWindowViewController.addTextAtCurrentCursorPosition(snippet.getText());if(snippet.get("subject")){this._composeWindowViewController.setSubject(snippet.get("subject"))}this._composeWindowViewController.notify("snippetAdded",snippet);BB.Tracker.track("snippet inserted",{method:"snippet menu"})}});BB.Modules.Snippets.SnippetsButtonComposeViewController=SnippetsButtonComposeViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsShortcutListenerViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._characterSequenceModel=null};SnippetsShortcutListenerViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(SnippetsShortcutListenerViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupCharacterSequenceModel()},getListenerType:function(){return"CHARACTER_SEQUENCE"},getCharacterSequenceListener:function(){return this._characterSequenceModel},destroy:function(){this._characterSequenceModel.destroy();this._composeWindowViewController=null;this._callDelegateFunction("destroy",this);Streak.ViewControllerBase.prototype.destroy.call(this)},_setupCharacterSequenceModel:function(){this._characterSequenceModel=new BB.Modules.Snippets.SnippetsCharacterSequenceModel;this._characterSequenceModel.addDelegate(this)},exactMatchFound:function(sequence){var snippet=this._getSnippetWithSequence(sequence);if(!snippet){return}if(snippet.get("subject")){this._composeWindowViewController.setSubject(snippet.get("subject"))}this._composeWindowViewController.replaceLastNCharacters(sequence.length-1,snippet.getText());this._composeWindowViewController.notify("snippetAdded",snippet);BB.Tracker.track("snippet inserted",{method:"shortcut entered"})},_getSnippetWithSequence:function(sequence){var snippets=BB.Data.getAllSnippets();for(var ii=0;ii<snippets.length;ii++){if(snippets[ii].get("snippetKeyShortcut")===sequence){return snippets[ii]}}}});BB.Modules.Snippets.SnippetsShortcutListenerViewController=SnippetsShortcutListenerViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsCharacterSequenceModel=function(){BB.Controllers.CharacterSequenceController.CharacterSequenceBaseDataSource.call(this);this._sequences=[];this._setupSnippetBindings();this._setupSequences()};SnippetsCharacterSequenceModel.prototype=Object.create(BB.Controllers.CharacterSequenceController.CharacterSequenceBaseDataSource.prototype);_.extend(SnippetsCharacterSequenceModel.prototype,{getSequences:function(){return this._sequences},onMatchShouldSuppress:function(){return true},destroy:function(){BB.Controllers.CharacterSequenceController.CharacterSequenceBaseDataSource.prototype.destroy.call(this);Streak.NotificationCenter.unsubscribe({observer:this})},_setupSnippetBindings:function(){var self=this;BB.Data.getAllSnippets().watch("collectionChange",function(){self._setupSequences()},this);BB.Data.getAllSnippets().watch("change",function(notification){if(!notification.model){return}if(notification.property==="snippetKeyShortcut"){self._setupSequences()}},this)},_setupSequences:function(){this._sequences.length=0;var newSequences=_.chain(BB.Data.getAllSnippets()).map(function(snippet){return snippet.get("snippetKeyShortcut")}).compact().value();_.mutate("union",this._sequences,newSequences);this._callDelegateFunction("sequencesChanged")}});BB.Modules.Snippets.SnippetsCharacterSequenceModel=SnippetsCharacterSequenceModel})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsAutoCompleteMenuView=function(){this._element=null;this._rightPane=null;this._setupUIElements()};_.extend(SnippetsAutoCompleteMenuView.prototype,{getElement:function(){return this._element},setListView:function(listView){this._element.find(".streak_bm_container").append(listView.getElement())},setRightPaneHTML:function(html){this._rightPane[0].innerHTML=html},_setupUIElements:function(){this._element=HTML.get("snippetsAutoCompleteMenu",true);this._rightPane=this._element.find(".streak__bm_right_pane")}});_.extend(SnippetsAutoCompleteMenuView.prototype,{destroy:function(){this._element.remove()}});BB.Modules.Snippets.SnippetsAutoCompleteMenuView=SnippetsAutoCompleteMenuView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,jwerty=Streak.jwerty,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsAutoCompleteMenuViewController=function(){BB.Modules.ComposeViewControllerBase.call(this);this._view=null;this._listViewModel=null;this._listViewController=null;this._lastSeenSequence=null;this._menuActive=false;this._dontShow=false;this._characterSequenceModel=null};SnippetsAutoCompleteMenuViewController.prototype=Object.create(BB.Modules.ComposeViewControllerBase.prototype);_.extend(SnippetsAutoCompleteMenuViewController.prototype,{initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupViewControllers();this._setupDelegates();this._setupTheView()},getListenerType:function(){return"CHARACTER_SEQUENCE"},getCharacterSequenceListener:function(){return this._characterSequenceModel},composeKeydown:function(event){if(!this._isAutoCompleteEnabled()){return}if(!this._menuActive){return}if(jwerty.is("up/down/enter",event)){this._callDelegateFunction("keydown",event);event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();if(jwerty.is("enter",event)){this._callDelegateFunction("keyPressed",event.which);this._closeMenu()
}return}},escapePressed:function(event){if(!this._isAutoCompleteEnabled()){return}if(!this._menuActive){return}this._dontShow=true;event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();this._closeMenu()},partialMatchFound:function(sequence){if(!this._isAutoCompleteEnabled()){return}if(this._dontShow){return}this._lastSeenSequence=sequence;this._findSnippetsAndAddToList(sequence);this._openMenu()},noMatchFound:function(){this._lastSeenSequence=null;this._dontShow=false;this._closeMenu()},rowFocused:function(rowInfo){if(!rowInfo){return}this._view.setRightPaneHTML(rowInfo.snippet.getText())},rowPressed:function(rowInfo){if(!rowInfo){return}this._closeMenu();this._injectSnippet(rowInfo.snippet)},destroy:function(){this._listViewModel.destroy();this._listViewController.destroy();this._view.destroy();this._characterSequenceModel.destroy();this._callDelegateFunction("destroy",this);BB.Modules.ComposeViewControllerBase.prototype.destroy.call(this)}});_.extend(SnippetsAutoCompleteMenuViewController.prototype,{_openMenu:function(){this._composeWindowViewController.addElementAtCursorPosition(this._view.getElement());this._menuActive=true},_closeMenu:function(){this._view.getElement().detach();this._menuActive=false},_isAutoCompleteEnabled:function(){return BB.Data.streakSettings.settingIsEnabled("settings_snippet_autocomplete")},_findSnippetsAndAddToList:function(sequence){var snippets=BB.Data.getAllSnippets();var filteredSnippets=_.filter(snippets,function(snippet){return snippet.get("snippetKeyShortcut").indexOf(sequence)===0});this._addSnippetsToList(filteredSnippets)},_addSnippetsToList:function(filteredSnippets){this._listViewModel.removeAllSections();var snippetRows=_.map(filteredSnippets,function(snippet){return{text:snippet.displayName()+" ("+snippet.get("snippetKeyShortcut")+")",snippet:snippet}});this._listViewModel.addSection({rows:snippetRows})},_injectSnippet:function(snippet){if(snippet.get("subject")){this._composeWindowViewController.setSubject(snippet.get("subject"))}this._composeWindowViewController.replaceLastNCharacters(this._lastSeenSequence.length,snippet.getText());this._composeWindowViewController.notify("snippetAdded",snippet);BB.Tracker.track("snippet inserted",{method:"autocomplete"})}});_.extend(SnippetsAutoCompleteMenuViewController.prototype,{_setupViewControllers:function(){this._listViewModel=new BB.Widgets.ListView.ListViewBaseModel;this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._characterSequenceModel=new BB.Modules.Snippets.SnippetsCharacterSequenceModel},_setupDelegates:function(){this._listViewController.setDataSource(this._listViewModel);this._listViewController.addDelegate(this);this.addDelegate(this._listViewController);this._characterSequenceModel.addDelegate(this)},_setupView:function(){},_setupTheView:function(){this._view=new BB.Modules.Snippets.SnippetsAutoCompleteMenuView;this._view.setListView(this._listViewController.getView())}});BB.Modules.Snippets.SnippetsAutoCompleteMenuViewController=SnippetsAutoCompleteMenuViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsManageListModel=function(){BB.Widgets.ListView.ListViewBaseModel.call(this)};SnippetsManageListModel.prototype=Object.create(BB.Widgets.ListView.ListViewBaseModel.prototype);_.extend(SnippetsManageListModel.prototype,{getItemMetaClass:function(sectionIndex,rowIndex){var rowInfo=this.infoForRow(sectionIndex,rowIndex);if(!rowInfo.data){return}if(!this._canDeleteSnippet(rowInfo.data)){return}return"ar9"},_canDeleteSnippet:function(snippet){return snippet.get("userKey")===BB.getUser().key()}});BB.Modules.Snippets.SnippetsManageListModel=SnippetsManageListModel})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsManageView=function(){Streak.ViewControllerBase.call(this);this._modal=null;this._modalInner=null;this._searchContainer=null;this._listContainer=null;this._editorContainer=null;this._addNewSnippetLinkContainer=null;this._errorMessage=null;this._setupUIElements();this._setupEventBindings()};SnippetsManageView.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(SnippetsManageView.prototype,{_setupUIElements:function(){this._modalInner=HTML.get("snippetsManageView",true);this._searchContainer=this._modalInner.find(".streak__snippetManageView_searchContainer");this._listContainer=this._modalInner.find(".streak__snippetManageView_listContainer");this._noSnippetListContainer=this._modalInner.find(".streak__snippetManageView_noSnippetListContainer");this._noSnippetMainViewContainer=this._modalInner.find(".streak__snippetManageView_noSnippetsMainView");this._noSnippetSelectedMainViewContainer=this._modalInner.find(".streak__snippetManageView_noSnippetsSelected");this._editorContainer=this._modalInner.find(".streak__snippetManageView_editorContainer");this._addNewSnippetLinkContainer=this._modalInner.find(".streak__snippetManageView_addNewSnippetLinkContainer");this._errorMessage=this._modalInner.find(".streak__snippetManageView_errorMessage");this._modal=BB.Widgets.Modal.create({title:BB.Locale.getString("manage_snippets"),inner:this._modalInner,showConfirm:true,showCancel:false,confirmText:BB.Locale.getString("modal_done"),width:"800px"})},_setupEventBindings:function(){var self=this;var addNewSnippetLink=BB.Widgets.LinkButton.create({text:BB.Locale.getString("create_new_snippet"),clickFunction:function(){self._callDelegateFunction("addNewSnippet");BB.Tracker.track("create new snippet",{method:"list link"})}});this._addNewSnippetLinkContainer.append(addNewSnippetLink.getElement());var newSnippetAnchors=this._modalInner.find(".streak__snippetManageView_noSnippet a");newSnippetAnchors.attr("href","#");newSnippetAnchors.on("click",function(e){e.preventDefault();self._callDelegateFunction("addNewSnippet");BB.Tracker.track("create new snippet",{method:"manage body link"})})},show:function(){this._modal.show()},close:function(){this._modal.close()},setSearchView:function(searchView){this._searchContainer.prepend(searchView.getElement())},setListView:function(listView){this._listContainer.append(listView.getElement())},setEditorView:function(editorView){this._editorContainer.append(editorView.getElement())},setErrorMessage:function(errorMessage){this._errorMessage[0].innerHTML=errorMessage},showNoSnippetMainView:function(){this._noSnippetMainViewContainer.show();this._noSnippetSelectedMainViewContainer.hide();this._editorContainer.hide()},showNoSnippetSelectedMainView:function(){this._noSnippetMainViewContainer.hide();this._noSnippetSelectedMainViewContainer.show();this._editorContainer.hide()},showEditorView:function(){this._noSnippetMainViewContainer.hide();this._noSnippetSelectedMainViewContainer.hide();this._editorContainer.show()},showNoSnippetList:function(){this._noSnippetListContainer.show();this._listContainer.hide()},showSnippetList:function(){this._noSnippetListContainer.hide();this._listContainer.show()}});Streak.DependencyManager.addFunction({functionKey:"snippetsManageViewInitialized",functionToCall:function(callback){BB.Modules.Snippets.SnippetsManageView=new SnippetsManageView;if(callback){callback()}},dependentFunctionKeys:["data.snippets.initialized","localeLoaded","htmlLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetsManageViewController=function(){this._snippetsSearchController=null;this._searchViewController=null;this._listViewController=null;this._snippetEditorViewController=null;this._snippetsMenuModel=null;this._view=null;this._snippet=null;this._setupViewControllers();this._setupView();this._setupDelegates()};_.extend(SnippetsManageViewController.prototype,{_setupViewControllers:function(){this._searchViewController=new BB.Widgets.SearchSimpleVC({placeholder:BB.Locale.getString("search_all_snippets")});this._snippetsMenuModel=new BB.Modules.Snippets.SnippetsManageListModel;this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._snippetEditorViewController=BB.Modules.Snippets.SnippetEditorViewController;this._snippetsSearchController=new BB.Modules.Snippets.SnippetsSearchController},_setupDelegates:function(){this._listViewController.setDataSource(this._snippetsMenuModel);this._snippetsSearchController.setDataSource(this._snippetsMenuModel);this._snippetsMenuModel.addDelegate(this);this._searchViewController.addDelegate(this._listViewController);this._searchViewController.addDelegate(this._snippetsSearchController);this._snippetsSearchController.addDelegate(this);this._listViewController.addDelegate(this);this._view.addDelegate(this)},_setupView:function(){this._view=BB.Modules.Snippets.SnippetsManageView;this._view.setListView(this._listViewController.getView());this._view.setSearchView(this._searchViewController.getView());this._view.setEditorView(this._snippetEditorViewController.getView())}});_.extend(SnippetsManageViewController.prototype,{rowPressed:function(snippetRow){if(!snippetRow){return}this._snippetEditorViewController.setSnippet(snippetRow.data);this._snippet=snippetRow.data;this._view.showEditorView();this._snippetEditorViewController.focus();BB.Tracker.track("select snippet for editing")},rowMetaActionPressed:function(snippetRow){if(!snippetRow){return}var self=this;BB.Widgets.Modal.confirmDelete(snippetRow.data.displayName(),function(){self._deleteSnippet(snippetRow.data);BB.Tracker.track("delete snippet")})},_deleteSnippet:function(snippet){if(snippet===this._snippet){this._snippet=null}snippet.del();if(this._isNoMoreSnippets()){this._delayedClose()}},_isNoMoreSnippets:function(){return BB.Data.getAllSnippets().length===0},_delayedClose:function(){var self=this;setTimeout(function(){self._view.close()},10)},addNewSnippet:function(options){var snippet=BB.Models.Snippet.create({snippetName:"New Snippet "+BB.Data.getAllSnippets().length});BB.Data.getAllSnippets().add(snippet);if(options){snippet.set("snippetText",options.snippetText);snippet.set("subject",options.subject)}else{snippet.set("snippetText"," ")}snippet.save();this._snippet=snippet;var self=this;setTimeout(function(){var listPosition=self._snippetsSearchController.getSnippetListPosition(snippet);if(listPosition!=null){self._listViewController.selectPosition(listPosition);self._snippetEditorViewController.focusAndSelect()}},500);this._snippetEditorViewController.setSnippet(snippet)},use:function(){this._snippet=null;this._searchViewController.clearQuery();this._view.show();this._searchViewController.focus();this.snippetsRendered()},useForNewSnippet:function(options){this._searchViewController.clearQuery();this.addNewSnippet(options);this._view.show()},snippetsRendered:function(){if(BB.Data.getAllSnippets().length===0){this._view.showNoSnippetList();this._view.showNoSnippetMainView();return}this._view.showSnippetList();if(!this._snippet){this._listViewController.reset();this._view.showNoSnippetSelectedMainView();return}this._view.showEditorView();var listPosition=this._snippetsSearchController.getSnippetListPosition(this._snippet);if(!listPosition){return}this._listViewController.selectPosition(listPosition)}});Streak.DependencyManager.addFunction({functionKey:"snippetsManageViewControllerInitialized",functionToCall:function(callback){BB.Modules.Snippets.SnippetsManageViewController=new SnippetsManageViewController;if(callback){return callback()}},dependentFunctionKeys:["snippetsManageViewInitialized","snippetEditorViewControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,HTML=Streak.HTML,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetEditorView=function(){this._element=null;this._focusElement=null;this._setupUIElements()};_.extend(SnippetEditorView.prototype,{_setupUIElements:function(){this._element=HTML.get("snippetEditorView",true)},getElement:function(){return this._element},focus:function(){if(this._focusElement.focus){this._focusElement.focus()}},focusAndSelect:function(){if(this._focusElement.focusAndSelect){this._focusElement.focusAndSelect()}},setNameInput:function(input){this._element.find(".streak__snippetEditorView_nameInput").append(input.getElement());this._focusElement=input},setShortcutInput:function(input){this._element.find(".streak__snippetEditorView_shortcutInput").append(input.getElement())},setPipelineInput:function(input){this._element.find(".streak__snippetEditorView_pipelineInput").append(input.getElement())},setSubjectInput:function(input){this._element.find(".streak__snippetEditorView_subjectInput").append(input.getElement())},setBodyInput:function(input){this._element.find(".streak__snippetEditorView_bodyInput").append(input.getElement())},destroy:function(){this._element.remove()}});BB.Modules.Snippets.SnippetEditorView=SnippetEditorView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SnippetEditorViewController=function(){this._snippet=null;this._view=null;this._nameInput=null;this._shortcutInput=null;this._pipelineInput=null;this._bodyInput=null;this._subjectInput=null;this._tabController=null;this._setupTheView();this._setupInputs()};_.extend(SnippetEditorViewController.prototype,{_setupView:function(){},_setupTheView:function(){this._view=new BB.Modules.Snippets.SnippetEditorView},_setupInputs:function(){this._setupTabController();this._setupNameInput();this._setupShortcutInput();this._setupPipelineInput();this._setupSubjectInput();this._setupBodyInput()},_setupTabController:function(){this._tabController=new BB.Widgets.TabFocusController},_setupNameInput:function(){this._nameInput=BB.Widgets.SidebarTextarea.create({border:"alwaysGmail",isValueValidFunction:function(value){if(!value){return false}var snippets=BB.Data.getAllSnippets();for(var ii=0;ii<snippets.length;ii++){if(snippets[ii].get("snippetName")===value){return false}}return true}});this._view.setNameInput(this._nameInput);this._tabController.addView(this._nameInput)},_setupShortcutInput:function(){this._shortcutInput=BB.Widgets.SidebarTextarea.create({border:"alwaysGmail",isValueValidFunction:function(value){if(!value){return true}var snippets=BB.Data.getAllSnippets();for(var ii=0;ii<snippets.length;ii++){if(snippets[ii].get("snippetKeyShortcut")===value){return false}}return true}});this._view.setShortcutInput(this._shortcutInput);this._tabController.addView(this._shortcutInput)},_setupPipelineInput:function(){var self=this;this._pipelineInput=BB.Widgets.CustomDropdown.create({border:"alwaysGmail",changeFunc:function(pipelineListItem){self._snippet.set("pipelineKey",pipelineListItem.value);self._snippet.set("partOfPipeline",true);self._snippet.save()}});this._view.setPipelineInput(this._pipelineInput);this._tabController.addView(this._pipelineInput)},_setupSubjectInput:function(){this._subjectInput=BB.Widgets.SidebarTextarea.create({border:"alwaysGmail"});this._view.setSubjectInput(this._subjectInput);this._tabController.addView(this._subjectInput)},_setupBodyInput:function(){this._bodyInput=BB.Widgets.SmartTextarea.create({useRawHTML:true,placeholder:BB.Locale.getString("snippet_enter_text")});this._view.setBodyInput(this._bodyInput);this._tabController.addView(this._bodyInput)},setSnippet:function(snippet){this._snippet=snippet;this._nameInput.setModelAndProperty(snippet,"snippetName");this._shortcutInput.setModelAndProperty(snippet,"snippetKeyShortcut");this._bodyInput.setModelAndProperty(snippet,"snippetText");this._subjectInput.setModelAndProperty(snippet,"subject");this._setupPipelineDropdown()},_setupPipelineDropdown:function(){var list=[{name:BB.Locale.getString("snippets_no_pipelines"),value:null}];if(BB.Data.getAllPipelines().length>0){for(var i=0;i<BB.Data.getAllPipelines().length;i++){list.push({name:BB.Data.getAllPipelines()[i].displayName(),value:BB.Data.getAllPipelines()[i].key()})}}this._pipelineInput.setMenuList(list);this._pipelineInput.setSelected(this._snippet.get("pipelineKey"))},focus:function(){this._view.focus()},focusAndSelect:function(){this._view.focusAndSelect()},getView:function(){return this._view},destroy:function(){this._view.destroy();this._nameInput.destroy();this._shortcutInput.destroy();this._pipelineInput.destroy();this._bodyInput.destroy();this._subjectInput.destroy()}});Streak.DependencyManager.addFunction({functionKey:"snippetEditorViewControllerInitialized",functionToCall:function(callback){BB.Modules.Snippets.SnippetEditorViewController=new SnippetEditorViewController;if(callback){callback()}},dependentFunctionKeys:["htmlLoaded","localeLoaded","data.snippets.initialized","data.pipelines.initialized"]})})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Template=Streak.Template,Date=Streak.Date,Gmail=Streak.Gmail,BB=Streak.BentoBox;var StreakSettingsView={init:function(){var self=this;self.trackingContext={widgetContext:"streakSettigns"};self.templates={};self.templates.button=Template.underscore("modules/streakSettingsView/button");self.templates.section=Template.underscore("modules/streakSettingsView/section");self.templates.setting=Template.underscore("modules/streakSettingsView/setting");self.templates.settingParentButton=Template.underscore("modules/streakSettingsView/parentButton");self.templates.subsettingTitle=Template.underscore("modules/streakSettingsView/subsettingTitle");self.templates.comboButton=Template.underscore("modules/streakSettingsView/comboButton");self.templates.subtitle=Template.underscore("modules/streakSettingsView/subtitle");self._streakMenuButton=$(self.templates.button());self._streakMenuButton.click(function(e){e.preventDefault();Streak.BentoBox.UI.setURL("settingsStreak")});self._fromSettings=false;Gmail.observe("viewChanged",self._viewChanged.bind(self))},initApp:function(){this._usingStreakApp=true},track:function(event,prop){BB.Tracker.trackStreakActive(this.trackingContext,prop,{eventName:event})},getFirstSettingsPage:function(){var self=this;return Streak.BentoBox.Data.streakSettings.getPages()[0]},isSelected:function(selected,value){var isSelected=false;_.each(selected,function(s){if(s===value){isSelected=true}});return isSelected},constructToggle:function(savecb,possibleValues,selectedValues,subsettingWidgtets){var self=this;var radioList;if(possibleValues.length===2&&_(possibleValues).contains("enabled")){var changeCallback=function(value,dontSave){if(value==="enabled"){_.each(subsettingWidgtets,function(ww){ww.button.enable();$(ww.el).removeClass("streakDisabled")})}else{_.each(subsettingWidgtets,function(ww){ww.button.disable();$(ww.el).addClass("streakDisabled")})}if(!dontSave&&savecb){savecb([value])}};radioList=BB.Widgets.RadioList.create({changeCallback:changeCallback});for(var ii=0;ii<possibleValues.length;ii++){radioList.addOption(BB.Locale.getString(possibleValues[ii]),possibleValues[ii])}radioList.setSelected(selectedValues[0]);if(_(selectedValues).contains("enabled")){changeCallback("enabled",true)}else{changeCallback("disabled",true)}radioList.el.addClass("rS")}else{throw new Error("Unsupported toggle")}return radioList},constructComboDropDown:function(savecb,path,possibleValues,selectedValues,setting){var self=this;var menu=Streak.BentoBox.Widgets.Menu.create();var checkedCurrent=selectedValues;var button=$(self.templates.comboButton({text:Streak.Locale.getString(setting.displayName)}));var buttonEl=button.find(".streakSettingsComboButtonText");var bm=BB.Widgets.ButtonMenu.create({menu:menu.el,closeOnSelect:false,customButton:button,onFunc:function(e){self.track("openedComoboDropDown",_.extend({},path,{settingKey:setting.key}));if(e){e.stopPropagation()}},offFunc:function(e){self.track("closedComoboDropDown",_.extend({},path,{settingKey:setting.key}));if(e){e.stopPropagation()}}});if(selectedValues.length===0){selectedValues=["None"]}function updateButtonText(values){if(values.length>0){buttonEl.text(_.map(values,function(ii){return Streak.Locale.getString(ii)}).join(", "))}else{buttonEl.text(Streak.Locale.getString("none"))}}var _itemButtons=[];menu.addItem(Streak.Locale.getString("none"),function(isChecked,e){if(isChecked){checkedCurrent=[];if(savecb){savecb(checkedCurrent)}_.each(_itemButtons,function(iButton){iButton.setCheckboxState(false);$(buttonEl).text(Streak.Locale.getString("none"))})}else{}});menu.addSeparator();_.each(possibleValues,function(item){var _item=item;var contains=_.indexOf(selectedValues,_item)>=0;var itemButton=menu.addCheckItem(Streak.Locale.getString(item),function(isChecked,e){if(isChecked){checkedCurrent.push(_item)}else{checkedCurrent=_.without(checkedCurrent,_item)}updateButtonText(checkedCurrent);if(savecb){savecb(checkedCurrent)}if(checkedCurrent.indexOf("desktopNotification")>-1){self._checkDesktopNotificationPermission()}},contains);_itemButtons.push(itemButton)});updateButtonText(selectedValues);return bm},getWidget:function(path,setting,subsettingWidgtets){var self=this;var selectedValues=setting.selectedValues;if(selectedValues.length>0&&selectedValues[0]==="default"){selectedValues=setting.defaultValues}var savecb=function(values){BB.Data.streakSettings.setSelectedValues(path.pageKey,path.sectionKey,setting.key,values)};switch(setting.widgetType){case"enabled_disabled":return self.constructToggle(savecb,setting.possibleValues,selectedValues,subsettingWidgtets);case"combo_dropdown":return self.constructComboDropDown(savecb,path,setting.possibleValues,selectedValues,setting);default:throw new Error("Unsupported widgetType "+setting.widgetType)}},renderSubSetting:function(path,subsetting,settingContainer){var self=this;var subsettingTitle=$(self.templates.subsettingTitle({subsettingTitle:Streak.Locale.getString(subsetting.displayName)}));if(subsetting.subtitle){subsettingTitle.append(self.templates.subtitle({text:BB.Locale.getString(subsetting.subtitle)}))}var widget=self.getWidget(path,subsetting);settingContainer.find(".streakSettingsSubsettingList").append(subsettingTitle);settingContainer.find(".streakSettingsSubsettingWidgets").append(widget.el);return widget},renderSetting:function(path,setting){var self=this;var widget;var settingContainer=$(self.templates.setting({settingTitle:Streak.Locale.getString(setting.displayName)}));if(setting.subtitle){settingContainer.find(".streakSettingsSettingTitle").append(self.templates.subtitle({text:BB.Locale.getString(setting.subtitle)}))}var subsettingWidgtets=[];if(_.isReal(setting.subsettings)&&setting.subsettings.length>0){for(var ii=0;ii<setting.subsettings.length;ii++){try{subsettingWidgtets.push(self.renderSubSetting(path,setting.subsettings[ii],settingContainer))}catch(e){BB.logError("error rendering subsetting",e)}}}else{settingContainer.find(".streakSettingChildSetting").remove()}if(_.isReal(setting.subsettings)&&setting.subsettings.length>0){widget=self.getWidget(path,setting,subsettingWidgtets)}else{widget=self.getWidget(path,setting)}settingContainer.find(".streakSettingsSettingWidget").append(widget.el);return settingContainer},renderSettingsSection:function(settingsSection,path){var self=this;var settingsSectionContainer=$(self.templates.section({sectionTitle:Streak.Locale.getString(settingsSection.displayName)}));_.each(settingsSection.settings,function(setting){try{settingsSectionContainer.find(".streakSettingsSectionBody").append(self.renderSetting(path,setting))}catch(e){BB.logError("error rendering setting",e)}});return settingsSectionContainer},_loadStreakPlatformSettings:function(){var self=this;if(BB.LocalSettings.get("activeApps/docsend")==null&&BB.LocalSettings.get("activeApps/streak")&&(!BB.EnabledFeaturesController||!BB.EnabledFeaturesController.isFeatureEnabled("docsend"))){return null}var settingsSectionContainer=$(this.templates.section({sectionTitle:"Streak Platform"}));var platformSettings=[{name:"Use Streak CRM & Tools",key:"activeApps/streak"},{name:"Use DocSend",key:"activeApps/docsend"}];platformSettings.forEach(function(setting){var settingContainer=$(self.templates.setting({settingTitle:setting.name}));settingsSectionContainer.find(".streakSettingsSectionBody").append(settingContainer);function savecb(values){BB.LocalSettings.set(setting.key,values[0]=="enabled");BB.ButterBarManager.showMessage("Saved. Refresh to apply the changes.")}var widget=self.constructToggle(savecb,["enabled","disabled"],[BB.LocalSettings.get(setting.key)?"enabled":"disabled"]);settingContainer.find(".streakSettingsSettingWidget").append(widget.el)});return settingsSectionContainer},_loadStreakAppSettings:function(){var self=this;var $content=$("<div/>");var page=self.getFirstSettingsPage();var pageKey=page.key;_.each(page.sections,function(sectionData){var path={pageKey:pageKey,sectionKey:sectionData.key};$content.append(self.renderSettingsSection(sectionData,path))});return $content},_renderStreakSettings:function(){var self=this;Gmail.Settings.getContentBodyBlockContainer().find(".streakSettings").remove();self._streakSettingsContainer=$("<div/>").addClass("streakSettings r4 r7").append(self._loadStreakPlatformSettings());if(this._usingStreakApp){self._streakSettingsContainer.append(self._loadStreakAppSettings())}Gmail.Settings.getContentBodyBlockContainer().append(self._streakSettingsContainer)},_viewChanged:function(){var self=this;if(Gmail.view==="settings"){return Streak.Utils.waitFor(function(){return Gmail.view!="settings"||Streak.Gmail.Settings.getEndingMenuMarker().length>0},60*1e3,50).then(function(){if(Gmail.view=="settings"){self._updateGmailSettingsPage()}})}else if(Gmail.view==="settingsStreak"){if(Streak.Gmail.getCurrentMainContainer().find(".streakSettingsButton").length===0){BB.UI.setURL("settings",null,true).then(function(){if(Gmail.view=="settings"){BB.UI.setURL("settingsStreak",null,true)}})}else{this._renderStreakSettingsPage()}}},_updateGmailSettingsPage:function(){var self=this;Gmail.Settings.getContentBodyBlockContainer().find(".streakSettings").remove();if(Streak.Gmail.getCurrentMainContainer().find(".streakSettingsButton").length===0){Streak.Gmail.Settings.getEndingMenuMarker().before(self._streakMenuButton)}self._streakMenuButton.removeClass("fZ").addClass("f1");Gmail.Settings.getContentBodyBlock().show()},_renderStreakSettingsPage:function(){var self=this;self._renderStreakSettings();self._streakMenuButton.find("a").focus();if(this._usingStreakApp){var oldSettingValues=BB.Data.streakSettings.getLatestObject();BB.Data.streakSettings.refresh(function(){var newSettingValues=BB.Data.streakSettings.getLatestObject();if(!Streak.Utils.isDeepEquals(oldSettingValues,newSettingValues)){self._renderStreakSettings()}})}Gmail.Settings.getSettingTabs().off(".streak");Gmail.Settings.getSettingTabs().on("click.streak",function(e){if(Gmail.view==="settingsStreak"){var targetURL;try{targetURL=Streak.$(e.target).attr("href").split("/").last();Streak.$(e.target.parentElement).removeClass("f1").addClass("fZ")}catch(f){targetURL=null;var newTarget=$(e.target).find("a");if(newTarget.attr("href")){targetURL=Streak.$(newTarget).attr("href").split("/").last();Streak.$(e.target).removeClass("f1").addClass("fZ")}else{throw f}}Streak.BentoBox.UI.setURL("settings/"+targetURL)}self._streakMenuButton.removeClass("f1").addClass("fZ")});Gmail.Settings.getSettingTabs().removeClass("fZ").addClass("f1");self._streakMenuButton.removeClass("f1").addClass("fZ");Streak.Gmail.Settings.getContentBodyBlock().hide();self._streakSettingsContainer.show()},_checkDesktopNotificationPermission:function(){if(typeof window.Notification!=="undefined"){var permissionStatus=window.Notification.permission;if(permissionStatus==="default"){window.Notification.requestPermission()}else if(permissionStatus==="denied"){var messageBodyLink="https://support.google.com/chrome/answer/3220216?hl=en";if(Streak.isSafari){messageBodyLink="http://support.apple.com/kb/PH11949"}var modal=BB.Widgets.Modal.create({title:BB.Locale.getString("enable_browser_notifications_title"),inner:BB.Locale.getString("enable_browser_notifications_body"),showCancel:false,confirmText:BB.Locale.getString("ok"),confirmFunc:function(){}});modal.getEl().find(".inner a")[0].setAttribute("href",messageBodyLink);modal.show()}}}};Streak.DependencyManager.addFunction({functionKey:"streakSettingsViewInitialized",functionReference:StreakSettingsView.init,functionContext:StreakSettingsView,dependentFunctionKeys:["gmailLoaded","localSettingsInitialized"]});Streak.DependencyManager.addFunction({functionKey:"streakAppSettingsViewInitialized",functionReference:StreakSettingsView.initApp,functionContext:StreakSettingsView,dependentFunctionKeys:["streakSettingsViewInitialized","data.streakSettings.initialized"]});BB.Modules.StreakSettingsView=StreakSettingsView})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Library.get("Operations.AjaxRequestOperation");var ThreadBreakerOperation=Streak.Class.subclass({className:"ThreadBreakerOperation",superclass:superclass,_memberVariables:[{name:"_subthreadGroupings",destroy:false},{name:"_threadId",destroy:false}],_initialize:function(parameters){parameters=_.pick(parameters||{},["threadId","subthreadGroupings"]);this._initializeData(parameters);var body={subthreadGroupings:this._subthreadGroupings};superclass.prototype._initialize.call(this,{url:"email/threads/"+this._threadId+"/split",method:"POST",params:{json:JSON.stringify(body)},tags:["threadBreaker"],dependentTags:[]})},_initializeData:function(parameters){this._threadId=parameters.threadId;this._subthreadGroupings=parameters.subthreadGroupings;var groupHasMessageIds=function(sg){return sg.messageIds&&sg.messageIds.length>0};var allGroupsHaveMessageIds=_.every(this._subthreadGroupings,groupHasMessageIds);if(!allGroupsHaveMessageIds){throw new Error("All of the subthreadGroupings must contain at least one thread")}var hasRepeatedMessageId=_.chain(this._subthreadGroupings).pluck("messageIds").flatten().countBy().max().value()>1;if(hasRepeatedMessageId){throw new Error("Each message can only appear in one subthreadGrouping.")}},getError:function(){return new Error(this.getResponse().error)}});Library.set("BentoBox.Modules.ThreadBreaker.ThreadBreakerOperation",ThreadBreakerOperation)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,HTML=Streak.HTML,Utils=Streak.Utils,BB=Streak.BentoBox,UI=Streak.UI;var superclass=UI.Delegator;var ThreadBreakerController=Streak.Class.subclass({className:"ThreadBreakerController",superclass:superclass,memberVariables:[{name:"_activateButton",destroy:true},{name:"_cancelButton",destroy:true},{name:"_options",destroy:false},{name:"_isBreaking",destroy:false,defaultValue:false},{name:"_gmailEventKey",destroy:false}],_initialize:function(options){superclass.prototype._initialize.call(this);this._gmailEventKey=Gmail.observe("viewChanged",this._viewChanged.bind(this));this._options=_.extend({},options)},destroy:function(){Gmail.unobserve("viewChanged",this._gmailEventKey);this._cleanupPage();this._callDelegateFunction("disconnect");superclass.prototype.destroy.call(this)},_viewChanged:function(view){BB.Tracker.track("threadbreaker.abandoned");this.destroy()},start:function(){BB.Tracker.track("threadbreaker.start");this._setupPage().catch(function(e){BB.logError("error with thread breaker start",e);BB.ButterBarManager.showError(BB.Locale.getString("error_unknown"),{messageKey:"threadbreaker"})
})},activate:function(){var self=this;if(this._isBreaking){BB.ButterBarManager.showError(BB.Locale.getString("thread_breaker_already_running"),{messageKey:"threadbreaker"});return}this._isBreaking=true;BB.Tracker.track("threadbreaker.activate",{numberOfMessagesToBreak:this._getSelectedMessages().length});this._doBreaking().then(function(success){if(success){BB.Tracker.track("threadbreaker.activate.success",{numberOfMessagesToBreak:self._getSelectedMessages().length});self.destroy()}else{BB.Tracker.track("threadbreaker.activate.aborted",{numberOfMessagesToBreak:self._getSelectedMessages().length});self._isBreaking=false}},function(e){self._isBreaking=false;BB.logError("error breaking thread",e);BB.Tracker.track("threadbreaker.activate.error",{numberOfMessagesToBreak:self._getSelectedMessages().length});BB.ButterBarManager.showError(BB.Locale.getString("thread_breaker_error_unknown"),{messageKey:"threadbreaker"})})},cancel:function(){BB.Tracker.track("threadbreaker.cancel");this.destroy()},_setupPage:function(){var self=this;Streak.Gmail.getCurrentMainContainer().addClass("threadBreakerMain");this._addThreadBreakerHeading();return Gmail.expandAllEmailsInThread().then(function(){return Gmail.collapseAllEmailsInThread()}).then(function(){self._setupCheckboxes()})},_addThreadBreakerHeading:function(){var $heading=HTML.getElement("threadBreakerHeading");$(".if > .nH").first().after($heading);this._activateButton=BB.Widgets.Button.create({nameText:BB.Locale.getString("thread_breaker_activate"),color:"blue",onFunc:this.activate.bind(this)});this._cancelButton=BB.Widgets.LinkButton.create({text:BB.Locale.getString("cancel"),clickFunction:this.cancel.bind(this)});$heading.find(".threadBreakerBreak").html(this._activateButton.getElement());$heading.find(".threadBreakerCancel").html(this._cancelButton.getElement());this._refreshStatus()},_setupCheckboxes:function(){var self=this;$(".Bk").each(function(){var $email=$(this).parent();var checkboxes=[];$email.find(".aju").each(function(){var $checkbox=Gmail.widgets.getCheckbox().click(function(e){e.stopPropagation()}).change(function(e){var checked=$checkbox.prop("checked");BB.Tracker.track("threadbreaker.toggleMessage."+checked);checkboxes.forEach(function($checkbox){$checkbox.setChecked(checked)});$email.attr("data-threadbreaker-selected",checked);self._refreshStatus()});checkboxes.push($checkbox);var $checkboxContainer=$("<div/>").addClass("threadBreakerCheckboxContainer").append($checkbox).insertBefore(this)});var mid=Gmail.getMessageIdFromElement($email);if(_.contains(self._options.messageIDs,mid)){checkboxes[0].setChecked(true).change()}})},_getSelectedMessages:function(){var messages=[];$("[data-threadbreaker-selected=true]").each(function(){messages.push(Gmail.getMessageIdFromElement(this))});return messages},_refreshStatus:function(){var messageCount=this._getSelectedMessages().length;$(".threadBreakerStatus").text(BB.Locale.getString("messages_selected",{number:messageCount}))},_doBreaking:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){var messagesToBreak=self._getSelectedMessages();if(messagesToBreak.length==0){BB.ButterBarManager.showError(BB.Locale.getString("no_messages_selected"),{messageKey:"threadbreaker"});resolve(false);return}var tid=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor)[0];if(!tid){reject(new Error("Could not determine open thread"));return}var subjectPrompt=Library.getInstance("BentoBox.Modules.ThreadBreaker.ThreadBreakerSubjectPromptViewController",{defaultSubject:Gmail.getConversationSubjectHeader().find("h2").text(),numberOfMessagesToBreak:messagesToBreak.length});subjectPrompt.showPromise().then(function(subject){if(subject==null){resolve(false);return}if(!subject.trim().length){BB.ButterBarManager.showError(BB.Locale.getString("thread_breaker_need_new_subject"),{messageKey:"threadbreaker"});resolve(false);return}var tbo=new BB.Modules.ThreadBreaker.ThreadBreakerOperation({threadId:tid,subthreadGroupings:[{subject:subject,messageIds:messagesToBreak}]});var operationProgressId=Streak.Operations.OperationQueue.Singleton.addOperation(tbo);BB.ButterBarManager.showSaving({message:BB.Locale.getString("thread_breaker_running"),operationProgressId:operationProgressId,messageKey:"threadbreaker"});var oldLocation=document.location.href;var complete=function(notification){if(notification.operationHasErrors){if(notification.operation&&notification.operation.getError){var error=notification.operation.getError();if(error&&error.message){BB.ButterBarManager.showError(error.message,{messageKey:"threadbreaker"});resolve(false)}else{reject(new Error("Unknown error with thread breaker operation"))}}else{reject(new Error("Unknown error with thread breaker operation"))}}else{if(document.location.href==oldLocation){Gmail.gotoCurrentThreadFolder()}setTimeout(Gmail.triggerListRefresh.bind(Gmail),600);resolve(true)}};Streak.NotificationCenter.subscribe({observer:{},filterParameters:{operationIsComplete:true,operationProgressId:operationProgressId},unsubscribeImmediately:true,functionToCall:complete})}).catch(reject)})},_cleanupPage:function(){$(".threadBreakerCheckboxContainer, .threadBreakerHeading").remove();$("[data-threadbreaker-selected]").removeAttr("data-threadbreaker-selected");$(".threadBreakerMain").removeClass("threadBreakerMain")}});Library.set("BentoBox.Modules.ThreadBreaker.ThreadBreakerController",ThreadBreakerController)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,HTML=Streak.HTML,Utils=Streak.Utils,BB=Streak.BentoBox,UI=Streak.UI;var ThreadBreakerMasterController={_breaker:null,start:function(options){if(this._breaker){BB.ButterBarManager.showError(BB.Locale.getString("thread_breaker_already_running"),{messageKey:"threadbreaker"});return}this._breaker=new BB.Modules.ThreadBreaker.ThreadBreakerController(options);this._breaker.addDelegate({disconnect:this._breakerDisconnect.bind(this,this._breaker)});this._breaker.start()},_breakerDisconnect:function(breaker){if(this._breaker===breaker){this._breaker=null}}};Library.set("BentoBox.Modules.ThreadBreaker.ThreadBreakerMasterController",ThreadBreakerMasterController)})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var ThreadBreakerEmailMenuOption={init:function(){BB.Services.EmailOptionManager.registerButton({text:BB.Locale.getString("split_this_from_thread"),extraCSSClasses:["threadBreakerMenuItem"],showFor:this._showFor.bind(this),fn:this._onclick.bind(this)})},_showFor:function(mid){var messageDivs=$(".Bk:visible");return messageDivs.length>1},_onclick:function(mid){BB.Tracker.track("threadbreaker.start.emailMenu");BB.Modules.ThreadBreaker.ThreadBreakerMasterController.start({messageIDs:[mid]})}};Streak.DependencyManager.addFunction({functionKey:"threadBreakerEmailMenuOptionInitialized",functionReference:ThreadBreakerEmailMenuOption.init,functionContext:ThreadBreakerEmailMenuOption,dependentFunctionKeys:["enabledFeaturesControllerInitialized","emailOptionManagerInitialized","htmlLoaded"]})})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var ThreadBreakerMoreMenuOption={init:function(){Library.get("BentoBox.Services.MoreMenuManager").registerButton({text:BB.Locale.getString("split_thread"),orderHint:1,extraCSSClasses:["threadBreakerMenuItem"],showFor:this._showFor.bind(this),enableFor:this._enableFor.bind(this),fn:this._onclick.bind(this)})},_showFor:function(view){if(Gmail.isPreviewPaneConversation()){var messageDivs=$(".Bk:visible");return messageDivs.length>0}return view=="conversation"},_enableFor:function(view){var messageDivs=$(".Bk:visible");return messageDivs.length>1},_onclick:function(){BB.Tracker.track("threadbreaker.start.moreMenu");BB.Modules.ThreadBreaker.ThreadBreakerMasterController.start()}};Streak.DependencyManager.addFunction({functionKey:"threadBreakerMoreMenuOptionInitialized",functionReference:ThreadBreakerMoreMenuOption.init,functionContext:ThreadBreakerMoreMenuOption,dependentFunctionKeys:["enabledFeaturesControllerInitialized","moreMenuManagerInitialized","htmlLoaded"]})})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=UI.View;var ThreadBreakerSubjectPromptView=Streak.Class.subclass({className:"ThreadBreakerSubjectPromptView",superclass:superclass,_memberVariables:[{name:"_subjectElement",destroy:true},{name:"_subjectTextbox",destroy:true}],_initialize:function(parameters){parameters=parameters||{};superclass.prototype._initialize.call(this);this._subjectElement=this._element.find(".streak__textbox")},setTextbox:function(textbox){this._subjectTextbox=textbox;this._subjectElement.html(textbox.getElement())},setSubject:function(subject){this._subjectTextbox.setText(subject)},focus:function(){this._subjectElement.focus()},_setupElement:function(){this._element=$(HTML.getElement("threadBreakerSubjectPrompt"))}});Library.set("BentoBox.Modules.ThreadBreaker.ThreadBreakerSubjectPromptView",ThreadBreakerSubjectPromptView)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,Jwerty=Streak.jwerty,BB=Streak.BentoBox;var superclass=UI.ViewController;var ThreadBreakerSubjectPromptViewController=Streak.Class.subclass({className:"ThreadBreakerSubjectPromptViewController",superclass:superclass,_memberVariables:[{name:"_modal",destroy:true},{name:"_subject",destroy:true},{name:"_subjectTextbox",destroy:true},{name:"_defaultSubject",destroy:true},{name:"_okButton",destroy:false}],_initialize:function(parameters){parameters=parameters||{};superclass.prototype._initialize.call(this);this._defaultSubject="";if(typeof parameters.defaultSubject!=="undefined"){this._defaultSubject=parameters.defaultSubject}this._setupTextbox();if(this._defaultSubject){this._view.setSubject(this._defaultSubject);this._subject=this._defaultSubject}},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.ThreadBreaker.ThreadBreakerSubjectPromptView")},subjectChange:function(subject){this._subject=subject;this._updateEnabled()},enterPressed:function(){this._modal.confirm()},_setupTextbox:function(){var self=this;if(!this._subjectTextbox){this._subjectTextbox=Library.getInstance("BentoBox.Widgets.GmailTextareaViewController",{plainTextOnly:true,multiline:false});this._subjectTextbox.addDelegate({input:function(){self.subjectChange(self._subjectTextbox.getText())},keydown:function(event){if(Jwerty.is("enter",event)){event.preventDefault();self.enterPressed()}}})}this._view.setTextbox(this._subjectTextbox.getView())},_updateEnabled:function(){if(!this._okButton)return;if(this._confirmShouldBeEnabled()){this._okButton.enable()}else{this._okButton.disable()}},_confirmShouldBeEnabled:function(){return this._subject},showPromise:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){self._modal=BB.Widgets.Modal.create({title:BB.Locale.getString("thread_breaker_enter_new_subject"),confirmText:BB.Locale.getString("ok"),cancelFunc:function(){BB.Tracker.track("threadbreaker.subject.cancel");resolve(null)},confirmFunc:function(){BB.Tracker.track("threadbreaker.subject.confirm");resolve(self._subject)},inner:self.getView().getElement()});self._modal.show();self._okButton=self._modal.getOkButton();self._updateEnabled();setTimeout(self._subjectTextbox.focus.bind(self._subjectTextbox),100)})}});Library.set("BentoBox.Modules.ThreadBreaker.ThreadBreakerSubjectPromptViewController",ThreadBreakerSubjectPromptViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,Library=Streak.Library,APIRequester=Streak.APIRequester,HTML=Streak.HTML,RSVP=Streak.RSVP,Eventer=Streak.Eventer,BB=Streak.BentoBox;var TopNav=Eventer.create({el:null,elements:{},templates:{},halted:false,rightLinksEmpty:false,loggedOut:true,_isMessage:false,trackingContext:{widgetContext:"topNav"},PAYWALL_ICON:{ACCOUNT:1,UPGRADE:2,NONE:3},_noBlackBarGmailMenuOpenClass:null,init:function(){this.el=HTML.getElement("topNavNoBlackBarLink");this.templates.loadingOauth=HTML.get("loadingOauth");this._appendToNoBlackBar();this._getNoBlackBarGmailMenuOpenClass();this.el.find(".bbClientVersion").html("client Version: "+Streak.clientVersion);this.el.find(".bbExtVersion").html("ext Version: "+Streak.extVersion);this.parse();this.initFunctionality();this.trigger("ready")},_appendToNoBlackBar:function(){Gmail.getGooglePlusNameContainer().prepend(this.el);if(this.el.parent().is(".gb_yb")){this.el.parent().addClass("streak__topNav_margin2")}},_getNoBlackBarGmailMenuOpenClass:function(){this._noBlackBarGmailMenuOpenClass="streak__topNav_menuOpen"},parse:function(){this.elements.mainLink=$(this.el[0]);this.elements.mainLink.span=this.elements.mainLink.find("span");this.elements.mainLink.exclamation=this.elements.mainLink.find("#bentoBoxNotLoggedIn");this.elements.mainLink.loading=this.elements.mainLink.find("#bentoBoxLoggingIn");this.elements.mainLink.icon=this.elements.mainLink.find("#bentoBoxLoggedIn");this.elements.menu=this.el.find("#workflowMenu");this.elements.menu.statusText=this.elements.menu.find("#streak__topNav_statusText");this.elements.menu.refreshButton=this.elements.menu.find("#streak__topNav_refresh a");this.elements.menu.signInButton=this.elements.menu.find("#streak__topNav_signIn a")},initFunctionality:function(){this.setupMenuToggling();this.setupSignInButton();this.setupRefreshButton();this.setupHelpButton();this.setupShareButton();this.setupReleaseNotesButton();this.setupLanguageButton();this.setupDeveloperZoneLink();this.resizeSearch();var self=this;BB.bind("logged_out",function(){self.halted=false;self.initLoggedOut()});Streak.NotificationCenter.subscribe({eventName:"reauthorized",functionToCall:this.reauthorized,observer:this})},initNoCRM:function(){this.showLoaded()},showLoaded:function(){this.elements.mainLink.exclamation.hide();this.elements.mainLink.loading.hide();this.elements.mainLink.icon.show()},reauthorized:function(){this.showLoaded();this.elements.menu.find(".developerZone").show()},setupMenuToggling:function(){var self=this;self.elements.menu.on("click",function(e){e.stopPropagation()});self.elements.mainLink.click(function(e){if(self.isMenuOpen()){self.closeMenu()}else{self.track("TopNavOpened");self.openMenu()}if(!$(e.target).is("a[target]")){e.preventDefault()}}).bodyCloseAndStop({closeFunction:function(){self.closeMenu()},stop:self.elements.mainLink[0],body:Gmail.elements.body,useCapture:true})},setupSignInButton:function(){var self=this;self.elements.menu.signInButton.click(function(e){self.closeMenu();self.startOauth();e.stopPropagation()})},setupRefreshButton:function(){this.elements.menu.refreshButton.click(function(e){location.reload()})},setupHelpButton:function(){var self=this;this.elements.menu.find("#streak__topNav_menuItems_help").trackable("show help clicked",this.trackingContext).click(function(e){BB.Modules.Help.HelpLoader.getHelpViewController().show(true);self.closeMenu()})},setupShareButton:function(){var self=this;self.elements.menu.find("#streak__topNav_menuItems_share").trackable("promoteLinkClicked",self.trackingContext).click(function(e){self.closeMenu();BB.Modules.Promote.render(true);e.preventDefault();e.stopPropagation()})},setupReleaseNotesButton:function(){var self=this;this.elements.menu.find("#streak__topNav_menuItems_updates").trackable("releaseNotesClicked",self.trackingContext).click(function(e){self.closeMenu();window.open("http://blog.streak.com/search/release%20notes/")})},setupUpgradeButton:function(){var self=this;this.elements.menu.find("#streak__topNav_menuItems_upgrade").trackable("upgrade topnav clicked",this.trackingContext).click(function(){BB.UI.setURL(Gmail.Constants.Paywall);self.closeMenu()})},setupAccountButton:function(){var self=this;this.elements.menu.find("#streak__topNav_menuItems_account").trackable("account topnav clicked",this.trackingContext).click(function(){BB.UI.setURL(Gmail.Constants.PaidAccount);self.closeMenu()})},setupLanguageButton:function(){var self=this;if(BB.Locale.getGmail()==="en"){self.elements.menu.find(".languageChoice").hide()}else{var msg="";var current=BB.Locale.getCurrent();var gmail=BB.Locale.getGmail();if(current==="en"){msg=BB.Locale.convertLocaleCodeToName(gmail)}else{msg=BB.Locale.convertLocaleCodeToName("en")}msg=BB.Locale.getString("top_nav_switch_language",{language:msg});self.elements.menu.find(".languageChoice").show();self.elements.menu.find(".languageChoice")[0].innerHTML=msg;self.elements.menu.find(".languageChoice").trackable("languageChoiceChanged",self.trackingContext).click(function(e){if(current==="en"){BB.Locale.setCurrent(gmail)}else{BB.Locale.setCurrent("en")}e.preventDefault();e.stopPropagation();location.reload()})}},setupDeveloperZoneLink:function(){this.elements.menu.find(".developerZone a").trackable("developerZoneLinkClicked",this.trackingContext).click(function(e){e.preventDefault();BB.Modules.DeveloperZone.show()})},initSettingsLink:function(){var self=this;this.elements.menu.find(".settingsShortcut a").trackable("navSettingsShortcutClicked",this.trackingContext).click(function(e){e.preventDefault();BB.UI.setURL("settingsStreak");self.closeMenu()}).parent().show()},resizeSearch:function(){var self=this;if(!BB.Services.RapportiveStatusController.isEnabled()){$(window).resize(self.setIdealSearchWidth);self.setIdealSearchWidth()}},initLoggedOut:function(){if(this.halted||this.rightLinksEmpty){return}this.loggedOut=true;this.showExclamation();this.showLoggedOut()},initLoggedIn:function(){if(this.halted){return}this.loggedOut=false;this._isMessage=false;this.elements.mainLink.exclamation.hide();this.elements.mainLink.loading.hide();this.elements.mainLink.icon.show();this.elements.menu.find(".developerZone").show();this.showMainMenuItems()},initExperimentsLoaded:function(){this.setupUpgradeButton();this.setupAccountButton();this.setupInitialUpgradeOrAccount();Streak.NotificationCenter.subscribe({eventName:"streak.isUserOnPlan.changed",observer:this,functionToCall:function(notificationParameters){this._setTopNavIconToShow(notificationParameters.topNavIconToShow)}})},setupInitialUpgradeOrAccount:function(){var paywallInstance=Library.get("BentoBox.Modules.Paywall.PaywallModelInstance");var topNavIconToShow=TopNav.PAYWALL_ICON.NONE;if(paywallInstance){topNavIconToShow=paywallInstance.topNavIconToShow()}this._setTopNavIconToShow(topNavIconToShow)},gotLoggedOut:function(){this.showExclamation();this.showLoggedOut();this.openMenu()},setIdealSearchWidth:function(){var rightWidth=Gmail.$("#gbu").width()+150;var totalWidth=Gmail.$("#gbqfw").width();var diff=totalWidth-rightWidth;var minWidth=150;var width=Math.max(minWidth,diff);Gmail.$("#gbqf").width(width)},destroy:function(){if(this.el){this.el.remove()}},haltExecution:function(){this.halted=true},showExclamation:function(){this.elements.mainLink.exclamation.css({display:"inline-block"});this.elements.mainLink.loading.hide();this.elements.mainLink.icon.hide()},isMenuOpen:function(){return this.elements.menu.is(":FastVisible(noCompute)")},openMenu:function(){this.elements.menu.show();this.elements.mainLink.addClass(this._noBlackBarGmailMenuOpenClass)},closeMenu:function(){this.elements.menu.hide();this.elements.mainLink.removeClass("gbto "+this._noBlackBarGmailMenuOpenClass)},showLoading:function(){this.elements.mainLink.exclamation.hide();this.elements.mainLink.loading.show()},startOauth:function(){var self=this;self.track("showOauth");self.closeMenu();self.elements.mainLink.exclamation.hide();self.elements.mainLink.loading.css({display:"inline-block"});var height=550;var width=560;var top=window.screenY+(window.outerHeight/2-height/2);var left=window.screenX+(window.outerWidth/2-width/2);var oauthEmail=Streak.originalEmail||BB.userEmail;var oauthLoaderHTML=this.templates.loadingOauth({streakServer:Streak.server,oauthEmail:oauthEmail});oauthLoaderHTML="data:text/html;base64,"+btoa(oauthLoaderHTML);var openWindow=window.open(oauthLoaderHTML,"Streak Authorization","height="+height+",width="+width+",left="+left+",top="+top+",toolbar=0,resizable=0,menubar=0,location=0,status=0,scrollbars=0");var timer=setInterval(function(){if(openWindow.closed){clearInterval(timer);self.checkUserAuth(0)}},1e3)},checkUserAuth:function(num){var self=this;APIRequester.get("users/me").getPromise().then(function(data){if(data){self.track("signinPromptComplete");BB.UserStateController.userLoggedIn(data);Streak.NotificationCenter.postNotification({eventName:"reauthorized"});return}if(num<5){setTimeout(function(){self.checkUserAuth(num+1)},500)}else{self.track("signinPromptDenied");self.showExclamation()}},function(){BB.logError("error user signing in");BB.trigger("error_load");BB.isError=true;self.showExclamation()})},versionCheck:function(){APIRequester.get("versions/suggested").getPromise().then(function(res){if(this.isVersionLarger(res.suggestedExtVersion,Streak.extVersion)){this.showExtensionUpdateAvailable()}else if(this.isVersionLarger(res.suggestedClientVersion,Streak.clientVersion)){this.showClientUpdateAvailable()}}.bind(this))},isVersionLarger:function(serverString,clientString){var serverParts=serverString.split(".");var clientParts=clientString.split(".");var isServerLarger=false;for(var ii=0;ii<serverParts.length;ii++){if(ii>=clientParts.length){isServerLarger=true;break}var serverNum=parseInt(serverParts[ii],10);var clientNum=parseInt(clientParts[ii],10);if(serverNum>clientNum){isServerLarger=true;break}else if(serverNum<clientNum){break}}return isServerLarger},showMainMenuItems:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_menuItems");this.setStatusClass("ok");this.setStatusHTML(BB.Locale.getString("top_nav_signed_in"))},showExtensionUpdateAvailable:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_extension");this.setStatusClass("warning");this.setStatusHTML(BB.Locale.getString("top_nav_client_update_available"));var a=this.elements.menu.find("#streak__topNav_extension a");a[0].setAttribute("href","http://support.streak.com/customer/portal/articles/722076-streak-tells-me-i-need-to-update-the-extension-what-do-i-do-");a[0].setAttribute("target","_blank");this.el.find("#bentoBoxNewUpdate").show()},showExtensionUpdateNeeded:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_extension");this.setStatusClass("error");this.setStatusHTML(BB.Locale.getString("top_nav_client_update_needed"));var a=this.elements.menu.find("#streak__topNav_extension a");a[0].setAttribute("href","http://support.streak.com/customer/portal/articles/722076-streak-tells-me-i-need-to-update-the-extension-what-do-i-do-");a[0].setAttribute("target","_blank");this.el.find("#bentoBoxNewUpdate").show()},showClientUpdateAvailable:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_refresh");this.setStatusClass("warning");this.setStatusHTML(BB.Locale.getString("top_nav_client_update_available"));this.el.find("#bentoBoxNewUpdate").show()},showClientUpdateNeeded:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_refresh");this.setStatusClass("error");this.setStatusHTML(BB.Locale.getString("top_nav_client_update_needed"));this.el.find("#bentoBoxNewUpdate").show()},showLoggedOut:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_signIn");this.setStatusClass("error");this.setStatusHTML(BB.Locale.getString("top_nav_signed_out"))},showThirdPartyCookiesDisabled:function(){this.hideOtherMenuSectionsAndShow("#streak__topNav_thirdParty");this.setStatusClass("error");this.setStatusHTML("Third party cookies disabled");this.showExclamation();this.openMenu()},hideOtherMenuSectionsAndShow:function(selector){this.elements.menu.find("#workflowMenuDefaultInner > div").hide();this.elements.menu.find(selector).show()},setStatusClass:function(newClass){this.el[0].setAttribute("class","streak__topNav_status_"+newClass)},setStatusHTML:function(html){this.elements.menu.statusText.html(html)},_setTopNavIconToShow:function(icon){if(icon===TopNav.PAYWALL_ICON.ACCOUNT){this.showAccountMenuItem();this.hideUpgradeMenuItem()}else if(icon===TopNav.PAYWALL_ICON.UPGRADE){this.hideAccountMenuItem();this.showUpgradeMenuItem()}else if(icon===TopNav.PAYWALL_ICON.NONE){this.hideAccountMenuItem();this.hideUpgradeMenuItem()}else{throw new Error("Invalid icon choice in topNav:_setTopNavIconToShow")}},showAccountMenuItem:function(){this.elements.menu.find("#streak__topNav_menuItems_account").show()},hideAccountMenuItem:function(){this.elements.menu.find("#streak__topNav_menuItems_account").hide()},showUpgradeMenuItem:function(){this.elements.menu.find("#streak__topNav_menuItems_upgrade").show()},hideUpgradeMenuItem:function(){this.elements.menu.find("#streak__topNav_menuItems_upgrade").hide()},track:function(event){BB.Tracker.trackStreakActive(this.trackingContext,{eventName:event})}});Streak.DependencyManager.addFunction({functionKey:"topNavInitialized",functionReference:TopNav.init,functionContext:TopNav,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded"]});Streak.DependencyManager.addFunction({functionKey:"topNav.initLoggedOut",functionReference:TopNav.initLoggedOut,functionContext:TopNav,dependentFunctionKeys:["topNavInitialized","gmailLoaded","htmlLoaded","localeLoaded","userLoggedOut"]});Streak.DependencyManager.addFunction({functionKey:"topNav.initLoggedIn",functionReference:TopNav.initLoggedIn,functionContext:TopNav,dependentFunctionKeys:["topNavInitialized","gmailLoaded","htmlLoaded","userLoggedIn"]});Streak.DependencyManager.addFunction({functionKey:"topNav.initNoCRM",functionReference:TopNav.initNoCRM,functionContext:TopNav,dependentFunctionKeys:["topNavInitialized","noCRM"]});Streak.DependencyManager.addFunction({functionKey:"topNav.initSettingsLink",functionReference:TopNav.initSettingsLink,functionContext:TopNav,dependentFunctionKeys:["topNavInitialized","streakSettingsViewInitialized"]});Streak.DependencyManager.addFunction({functionKey:"topNav.experimentsLoaded",functionReference:TopNav.initExperimentsLoaded,functionContext:TopNav,dependentFunctionKeys:["enabledFeaturesControllerInitialized","topNav.initLoggedIn"]});BB.Modules.TopNav=TopNav})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var trackingContext={widgetContext:"topNav/developerZone"};var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};var DeveloperZone={initialized:false,show:function(){if(!this.apiModal){this.APIKeys=BB.Models.APIKey.createCollection();this.apiModal=BB.Widgets.Modal.create({title:BB.Locale.getString("streak_developer_resources"),inner:HTML.get("apiModal",true),showCancel:false,persist:false,width:"475px",trackingContext:{widgetContext:"topNav/developerZone"}});this.addModalFunctionality()}this.apiModal.show();this.showLoading();this.reset()},showLoading:function(){this.apiModal.getEl().find(".loadingKeys").show();this.apiModal.getEl().find(".apiInfo").hide()},hideLoading:function(){this.apiModal.getEl().find(".loadingKeys").hide();this.apiModal.getEl().find(".apiInfo").show()},reset:function(){var self=this;this.APIKeys.refresh(function(){self.renderAPIKeys()})},addModalFunctionality:function(){var el=this.apiModal.getEl();el.find(".createOne").on("click.developerZone",function(){track("createAPIKeyClicked");this.createKey()}.bind(this));el.find("#apiDocsLink a").on("click.developerZone",function(e){track("apiDocsLinkClicked")}).addClass("action").attr("href","//www.streak.com/api").attr("target","_blank")},renderAPIKeys:function(){if(this.APIKeys&&this.APIKeys.length>0){this.apiModal.getEl().find(".createOne").hide();var keyList=this.apiModal.getEl().find("#apiKeyList");keyList.empty();for(var i=0;i<this.APIKeys.length;i++){keyList.append(this.renderAPIKey(this.APIKeys[i]))}keyList.show()}else{this.apiModal.getEl().find("#apiKeyList").hide();this.apiModal.getEl().find(".createOne").show()}this.hideLoading()},renderAPIKey:function(apiKeyModel){var rowTemplate=HTML.get("apiRow");var creationDate=Date.create(apiKeyModel.get("creationTimestamp"));var row=$(rowTemplate({apiKey:apiKeyModel.get("apiKey"),creationTimeLong:creationDate.customFormat("longWithTimezone"),issued:BB.Locale.getString("api_key_issued",{time:creationDate.customFormat("shortDate")})}));row.addClass("apiKey");var keySpan=row.find(".bbHighlight");keySpan.selectAllOnClick();var del=$(Streak.createEl("div"));del.addClass("bbAction");del.append(Gmail.widgets.getDeleteIcon());del.append(Streak.createEl("span",BB.Locale.getString("delete")));del.click(function(e){track("deleteAPIKey");this.deleteKey(apiKeyModel)}.bind(this));row.find(".streak__apiKey_delete").append(del);return row},deleteKey:function(apiKeyModel){var self=this;BB.Widgets.Modal.confirmDelete("API Key",function(){apiKeyModel.del();self.renderAPIKeys()}.bind(this),BB.Locale.getString("api_key_delete_extra"))},createKey:function(){this.showLoading();var apiKeyModel=BB.Models.APIKey.create({});var self=this;apiKeyModel.save(function(){self.APIKeys.add(apiKeyModel);self.renderAPIKeys()},function(){BB.ButterBarManager.showError("Generating API key failed",{time:5e3})})}};BB.Modules.DeveloperZone=DeveloperZone})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,StateMachine=Streak.StateMachine,BB=Streak.BentoBox;var GroupBar={COLORS_OLD:["#AC725E","#D06B64","#F83A22","#FA573C","#FF7537","#FFAD46","#FAD165","#FBE983","#B3DC6C","#7BD148","#16A765","#42D692","#92E1C0","#9FE1E7","#9FC6E7","#4986E7"],COLORS:["#FA573C","#FFAD46","#B3DC6C","#16A765","#9FC6E7","#4986E7","#7BD148","#F83A22","#AC725E","#92E1C0","#42D692","#D06B64","#FAD165","#FF7537","#9FE1E7"],templates:{},defaults:{groupJumper:null},widgetTrackingContext:{widget:"Groupbar"},dnd:{dragThreshold:4,sm:null,proxy:null,drag:null,mouseOffset:{x:0,y:0},mousePosition:{x:0,y:0},bar:null,groups:[],widthMap:[]},init:function(cb){var self=this;this.templates={};this.templates.group=HTML.get("groupbarGroup");this.templates.groupbar=HTML.get("groupbar");this.templates.add=HTML.get("groupbarAdd");this.setupDragAndDrop();if(cb){cb()}},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)},setupDragAndDrop:function(){this.setupDragProxy();this.setupStateMachine();this.setupEventBindings()},setupDragProxy:function(){var self=this;self.dnd.proxy=$(self.templates.group({number:0,width:0,name:"&nbsp;"}));self.dnd.proxy.addClass("proxy");self.dnd.proxy.css({color:"transparent",backgroundColor:"#eee",borderColor:"#eee",height:"81px",verticalAlign:"top"})},setupStateMachine:function(){var self=this;self.dnd.sm=new StateMachine.create({initial:"start",events:[{name:"mousedown",from:["start"],to:"possibleDrag"},{name:"mouseup",from:["possibleDrag","start"],to:"start"},{name:"dragStart",from:["possibleDrag"],to:"drag"},{name:"mouseup",from:["drag"],to:"drop"},{name:"reset",from:["possibleDrag","drag","drop","start"],to:"start"}],callbacks:{onstart:function(event,from,to){if(from==="drag"&&self.dnd.bar){self.dnd.bar.render()}self.dnd.drag=null;self.dnd.bar=null;self.dnd.widthMap=[];self.dnd.proxy.detach();Gmail.elements.body.css({"-webkit-user-select":""})},ondrag:function(event,from,to){self.dnd.drag.trigger("bbDragStart");Gmail.elements.body.css({"-webkit-user-select":"none"});Gmail.elements.body[0].style.cursor="url(https://mail.google.com/mail/u/0/images/2/closedhand.cur), default !important";
var width=self.dnd.drag.width()+3;self.dnd.drag[0].style.width=width+"px";self.dnd.drag[0].style.zIndex=100;self.dnd.proxy.css({maxWidth:width,minWidth:width});self.dnd.proxy.data("group",self.dnd.drag.data("group"));self.dnd.drag[0].style.display="none";self.dnd.drag.before(self.dnd.proxy);var left=self.dnd.drag.offset().left;self.dnd.drag[0].style.position="fixed";self.dnd.drag.offset({left:left});self.dnd.drag[0].style.display="inline-block"},ondrop:function(event,from,to){self.dnd.bar.reorder(self.dnd.groups);BB.Tracker.trackStreakActive({eventName:"StageReorder"},self.widgetTrackingContext)}}})},setupEventBindings:function(){var self=this;Gmail.elements.body.mousemove(function(e){if(self.dnd.sm.is("possibleDrag")){var pixelsMoved=Math.abs(e.clientX-self.dnd.mousePosition.x)+Math.abs(e.clientY-self.dnd.mousePosition.y);if(document.activeElement.type!=="text"&&pixelsMoved>self.dnd.dragThreshold){self.dnd.sm.dragStart()}}else if(self.dnd.sm.is("drag")&&self.dnd.drag){self.renderDrag(e.clientX)}});Gmail.elements.body.mouseup(function(e){GroupBar.dnd.sm.mouseup()});BB.Keyboard.bindChord("escape",function(e){self.dnd.sm.reset()})},setupWidthMap:function(){var self=this;var children=self.dnd.bar.el.children().children(".groupBarGroup");self.dnd.widthMap=[];for(var i=0;i<children.length;i++){var child=$(children[i]);if(child.hasClass("dragged")){continue}var offset=child.offset();var width=child.width();self.dnd.widthMap.push({left:offset.left,right:offset.left+width,el:child})}},renderDrag:function(mouseX){this.setupWidthMap();this.dnd.groups=[];var pos=this.dnd.widthMap[0];var index=0;var currIndex=0;for(var i=0;i<this.dnd.widthMap.length;i++){var tempPos=this.dnd.widthMap[i];this.dnd.groups.push(tempPos.el.data("group"));if(tempPos.left<=mouseX){index=i;pos=tempPos}if(tempPos.el.hasClass("proxy")){currIndex=i}}if(this.dnd.dragGroup!==pos.el.data("group")){if(pos&&!pos.el.hasClass("proxy")){if(index<currIndex){pos.el.before(this.dnd.proxy)}else if(index===currIndex){}else{pos.el.after(this.dnd.proxy)}}}this.dnd.dragGroup=pos.el.data("group");var left=this.dnd.widthMap[0].left;var right=_.last(this.dnd.widthMap).right-this.dnd.drag.width();var renderX=Math.min(right,mouseX-this.dnd.mouseOffset.x);renderX=Math.max(left,renderX);this.dnd.drag.offset({left:renderX+3})}};GroupBar.impl=function(o){var obj={};var options=o,pipeline=options.pipeline,pipelineSpreadsheetViewController=options.pipelineSpreadsheetViewController,transformedData=pipelineSpreadsheetViewController.getTransformedData(),wrapperEl=$(GroupBar.templates.groupbar()),el=wrapperEl.find("ul"),add=$(GroupBar.templates.add()),stageBeingAdded=false,groups=[];options.trackingContext.widgetContext+="/groupBar";var render=function(list){GroupBar.dnd.sm.reset();add.detach();el.empty();el.detach();if(!BB.UI.getCanvas().is(":FastVisible(noCompute)")){setTimeout(render,200);return}groups=list||transformedData.groups;$.each(groups,function(index,group){var size=transformedData.lists[group]&&transformedData.lists[group].list?transformedData.lists[group].list.length:0;var gEl=renderGroup(group,transformedData.lists[group].displayNameHTML(),size,index);el.append(gEl)});if(transformedData.groupMeta.canEdit){wrapperEl.addClass("streak__groupBar_editable")}else{wrapperEl.removeClass("streak__groupBar_editable")}wrapperEl.append(el);renderAdd()},renderGroup=function(group,groupName,size,index,isEditable){var gEl=$(GroupBar.templates.group({number:size,name:groupName}));gEl.data("group",group);var color=transformedData.lists[group].color;gEl.css({backgroundColor:color.backgroundColor,color:color.textColor,border:"none 0 "+color.backgroundColor});gEl[0].style["-webkit-box-flex"]=Math.log(Math.max(size,2));gEl.find("a").click(function(e){e.preventDefault();if(options.groupJumper&&options.groupJumper.jumpToGroup){options.groupJumper.jumpToGroup(gEl.data("group"))}});if(transformedData.groupMeta.canEdit){var menu=BB.Widgets.Menu.create({css:{position:"fixed"},trackingContext:_.clone(options.trackingContext)});gEl[0].onselectstart=function(e){e.preventDefault();return false};gEl.easyHoverClass("hover");var origPosition,origWidth;gEl.bind({mousedown:function(e){if(stageBeingAdded){return}GroupBar.dnd.sm.mousedown();GroupBar.dnd.drag=gEl;GroupBar.dnd.bar=obj;GroupBar.dnd.mouseOffset={x:e.offsetX,y:e.offsetY};GroupBar.dnd.mousePosition={x:e.clientX,y:e.clientY}},mouseup:function(e){},bbDragStart:function(e){gEl[0].title="";gEl.addClass("dragged")},bbDragEnd:function(e){gEl[0].title=group;gEl.removeClass("dragged")}});var groupStage=pipeline.getStage(group);var input=gEl.find("input");menu.addItem(BB.Locale.getString("groupbar_rename_stage"),function(){BB.Tracker.trackStreakActive({eventName:"StageRenameStart"},GroupBar.widgetTrackingContext,options.trackingContext);gEl.find("a").hide();input.val(groupStage.displayName());input.show();input.focus()});var saveStageName=function(){BB.Tracker.trackStreakActive({eventName:"StageRenameAttempt"},GroupBar.widgetTrackingContext,options.trackingContext);var val=input.val().trim();if(val.length===0){BB.Tracker.trackStreakActive({eventName:"EmptyStageRename"},GroupBar.widgetTrackingContext,options.trackingContext);BB.ButterBarManager.showError(BB.Locale.getString("empty_stage_name"),{time:5e3});return}var stage=pipeline.getStageByName(val);if(stage&&stage.key()===group){BB.Tracker.trackStreakActive({eventName:"StageRenameSame"},GroupBar.widgetTrackingContext,options.trackingContext);input.hide();gEl.find("a").show();return}if(pipeline.getStageNamesText().indexOf(val)>-1){BB.Tracker.trackStreakActive({eventName:"AddStageFailed",reason:"duplicate stage name",userFailure:"true"},GroupBar.widgetTrackingContext,options.trackingContext);BB.ButterBarManager.showError(BB.Locale.getString("same_stage_name"),{time:5e3});return}BB.Tracker.trackStreakActive({eventName:"StageRename"},GroupBar.widgetTrackingContext,options.trackingContext);input.hide();gEl.find("a").show();groupStage.set("name",val);groupStage.save()};BB.Keyboard.bindChordToElement(input,"enter",function(){saveStageName()},true,true);input.blur(function(){saveStageName()});if(groupStage){groupStage.watch("set",function(){gEl.find(".name").text(groupStage.displayName())},obj,"name")}menu.addItem(BB.Locale.getString("groupbar_delete_stage"),function(){BB.Tracker.trackStreakActive({eventName:"DeleteStageAttempt"},GroupBar.widgetTrackingContext,options.trackingContext);if(groups&&groups.length>0){if(groups.length===1){BB.Tracker.trackStreakActive({eventName:"DeleteStageFailedOneStage",userFailure:"true"},GroupBar.widgetTrackingContext,options.trackingContext);BB.ButterBarManager.showError(BB.Locale.getString("one_stage"),{time:5e3});return}BB.Widgets.Modal.confirmDelete(groupStage.displayName(),function(){BB.Tracker.trackStreakActive({eventName:"DeleteStage"},GroupBar.widgetTrackingContext,options.trackingContext);groupStage.del();pipelineSpreadsheetViewController.runDataTransforms()},null,function(){BB.Tracker.trackStreakActive({eventName:"DeleteStageCancel"},GroupBar.widgetTrackingContext,options.trackingContext)})}});menu.addSeparator();var colorPicker=BB.Widgets.ColorPicker.create({label:BB.Locale.getString("groupbar_change_color"),previewText:groupName,colorChosenFunc:function(color){transformedData.lists[group].changeColor(color);gEl[0].style.backgroundColor=color.backgroundColor;gEl[0].style.color=color.textColor;transformedData.lists[group].color=color;pipelineSpreadsheetViewController.redraw();BB.Tracker.trackStreakActive({eventName:"GroupColorChanged"},GroupBar.widgetTrackingContext,options.trackingContext)},color:color,trackingContext:options.trackingContext});menu.addSection(colorPicker.el);var bm=BB.Widgets.ButtonMenu.create({customButton:Gmail.widgets.getSettingsIcon(),menu:menu.el,fixedPosition:true,rightAligned:index===0?false:true,css:{overflow:"visible"},onFunc:function(e){colorPicker.showMenu()}});gEl.find(".settings").append(bm.el)}return gEl},reorder=function(groupsToSave){var i=0;for(i=0;i<groupsToSave.length;i++){if(groups!==groupsToSave[i]){break}}if(i===groupsToSave.length){render();return}pipeline.setStageOrder(groupsToSave);pipeline.save();pipelineSpreadsheetViewController.runDataTransforms()},renderAdd=function(){if(transformedData.groupMeta.canEdit){resetAdd();el.append(add)}},resetAdd=function(){add.find("a").show();add.find("input").hide();add.removeClass("inputOpen");add.css({backgroundColor:"whiteSmoke"})};var addNewStage=function(e){BB.Tracker.trackStreakActive({eventName:"AddStageAttempted"},GroupBar.widgetTrackingContext,options.trackingContext);add.name=add.find("input").val().trim();if(!add.name||add.name.trim().length===0){BB.Tracker.trackStreakActive({eventName:"AddStageFailed",reason:"noText",userFailure:"true"},GroupBar.widgetTrackingContext,options.trackingContext);BB.ButterBarManager.showError(BB.Locale.getString("empty_stage_name"),{time:5e3});return}if(pipeline.getStageNamesText().indexOf(add.name)>-1){BB.Tracker.trackStreakActive({eventName:"AddStageFailed",reason:"duplicate stage name",userFailure:"true"},GroupBar.widgetTrackingContext,options.trackingContext);BB.ButterBarManager.showError(BB.Locale.getString("same_stage_name"),{time:5e3});return}BB.Tracker.trackStreakActive({eventName:"AddStage"},GroupBar.widgetTrackingContext,options.trackingContext);add.find("input").prop("disabled",true);stageBeingAdded=true;pipeline.addStage(add.name,function(){stageBeingAdded=false;add.find("input").prop("disabled",false);pipelineSpreadsheetViewController.runDataTransforms()});if(e){e.preventDefault();e.stopPropagation()}};add.click(function(e){if(stageBeingAdded){return}add.addClass("inputOpen");add.find("a").hide();add.find("input").show().focus().val("");add.color=transformedData.groupMeta.nextColor;add.css({backgroundColor:add.color});e.preventDefault();BB.Tracker.trackStreakActive({eventName:"AddStageStarted"},GroupBar.widgetTrackingContext,options.trackingContext)});BB.Keyboard.bindChordToElement(add.find("input"),"enter",function(e){addNewStage(e)},true,true);BB.Keyboard.bindChordToElement(add.find("input"),"escape",function(e){resetAdd()},true,true);add.find("input").blur(function(e){if(stageBeingAdded){return}var name=add.find("input").val().trim();if(!name){resetAdd();return}addNewStage()});obj.newBoxAdded=render;obj.transformedDataChanged=render;obj.el=wrapperEl;obj.render=render;obj.reorder=reorder;obj.destroy=function(){el.remove();Streak.NotificationCenter.unsubscribe({observer:obj})};return obj};Streak.DependencyManager.addFunction({functionKey:"pipelineView.groupBarInitialized",functionToCall:GroupBar.init,functionContext:GroupBar,dependentFunctionKeys:["keyboardInitialized","htmlLoaded","localeLoaded"]});BB.Modules.PipelineView.GroupBar=GroupBar})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var FullScreenSpreadsheetButton={defaults:{pipeline:null,color:"blue",isButton:true,isDark:false,iconAfter:false},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};var trackingContext;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};FullScreenSpreadsheetButton.impl=function(o){var self={};var options=o;options.trackingContext.widgetContext+="/fullScreenSpreadsheetButton";trackingContext=options.trackingContext;self.pipeline=options.pipeline;self._inFullMode=false;self.options=options;self.menuBar=options.pipelineToolBar;self._firstLoad=true;self._button;self._exitFullMode=function(){if(_.isDefined(self.holder)){_.each(self.options.buttonGroup,function(btn){$(btn).show()});self.menuBarParent.prepend(self.menuBar);Streak.Gmail.getCurrentMainContainer().find(".table.bb_table").prepend(options.pipelineSpreadsheetViewController.getView().getElement());options.pipelineSpreadsheetViewController.getView().getElement().css("top","0px");self._inFullMode=false;self.holder.detach();self._button.changeIconByClass("bbFullscreenExitIcon","bbFullscreenIcon")}};var buttonOptions={hasButtonToLeft:true,isToggle:false,tooltip:BB.Locale.getString("fullscreen_button_text"),iconClassName:"bbFullscreenIcon",onFunc:function(e){self._button.toggleRoundLeft();if(self._firstLoad){self._firstLoad=false;self.menuBarParent=options.pipelineToolBar.parent()}if(self._inFullMode){track("exitFullScreen");self._exitFullMode()}else{track("enterFullScreen");_.each(self.options.buttonGroup,function(btn){$(btn).hide()});if(_.isUndefined(self.holder)){self.holder=Streak.$("<div></div>")}self.holder.addClass("holderFullScreen");Streak.Gmail.getCurrentMainContainer().append(self.holder);self.holder.append(self.menuBar);self.holder.append(options.pipelineSpreadsheetViewController.getView().getElement());options.pipelineSpreadsheetViewController.getView().getElement().css("top","45px");self._inFullMode=true;self._button.changeIconByClass("bbFullscreenIcon","bbFullscreenExitIcon")}options.pipelineSpreadsheetViewController.redraw()}};var b=BB.Widgets.Button.create(buttonOptions);if(options.iconAfter){var span=b.el.find("span").detach();b.el.prepend(span)}self._button=b;return{button:b,destroy:function(){try{self._exitFullMode(true)}catch(e){}}}};BB.Modules.PipelineView.FullScreenSpreadsheetButton=FullScreenSpreadsheetButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var MoreButton={defaults:{pipeline:null},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};var trackingContext;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};MoreButton.impl=function(o){var options=o;var pipeline=options.pipeline;var pipelineSpreadsheetViewController=options.pipelineSpreadsheetViewController;var importViewController=null;var menu=BB.Widgets.Menu.create();options.trackingContext.widgetContext+="/moreButton";trackingContext=options.trackingContext;var __mailMergeItem=menu.addItem(BB.Locale.getString("mail_merge_start"),function(e){track("mm_mailMergeButtonPipelineClicked");BB.Modules.MailMergeMasterController.startMailMergeFromPipelineView(pipeline,pipelineSpreadsheetViewController.getCheckedBoxes())});__mailMergeItem.addClass("mailMergePipelineButton");menu.addSeparator();var importButton=menu.addItem(BB.Locale.getString("import_csv"),function(e){track("importCSV");if(importViewController){importViewController.destroy()}importViewController=new MoreButton.PipelineCSVImportViewController;importViewController.setPipeline(pipeline);importViewController.setDoneCallback(function(){BB.ButterBarManager.showMessage(BB.Locale.getString("import_complete"),{messageKey:"importComplete"});BB.Data.getPipelineBoxes(pipeline.key()).refresh(function(){BB.ButterBarManager.hideMessage("importComplete");if(importViewController){importViewController.destroy()}importViewController=null})});importViewController.start()});menu.addItem(BB.Locale.getString("export_to_csv"),function(e){track("exportToCSV");bm.getElement().trigger("export");if(!Streak.FileStore.isEnabled()){BB.ButterBarManager.showError("Unfortunately export does not work in Safari. You must use Chrome to export",{time:1e4});return}BB.ButterBarManager.showMessage(BB.Locale.getString("creating_csv"),{messageKey:"createExport"});var boxString="";var table=pipelineSpreadsheetViewController.getPipelineTableModel();for(var ii=0;ii<table.getNumberOfRowsIncludingCollapsed();ii++){if(table.isGroupRowIncludingCollapsed([ii,0])){continue}var row=[];for(var columnIndex=0;columnIndex<table.getTotalColumnCount();columnIndex++){row.push('"'+table.getTextValueIncludingHiddenColumns([ii,columnIndex]).replace(/\"/g,'""')+'"')}boxString+=row.join(",");boxString+="\n"}var fileName=pipeline.displayName()+"-"+Streak.Date.create().customFormat("shortFormat")+".csv";var fullPath=_getPipelineExportsDirectoryPath()+"/"+fileName;Streak.FileStore.store(fullPath,boxString,function(fileEntry){var downloadLink=$('<a href="'+fileEntry.toURL()+'" download="'+fileName+'"> </a>');downloadLink[0].addEventListener("click",function(e){e.stopImmediatePropagation();e.stopPropagation()},true);Gmail.elements.body.append(downloadLink);downloadLink.simulateRawClick();downloadLink.remove();Gmail.hideNotice()})});menu.addItem(BB.Locale.getString("export_feed"),function(e){track("exportFeed");var loading=BB.ButterBarManager.showLoading();APIRequester.get("pipelines/"+pipeline.key()+"/newsfeed/export/type").getPromise().then(function(result){if(result.NEWSFEED_EXPORT_TYPE=="DIRECT_DOWNLOAD"){loading.destroy();Streak.BentoBox.ButterBarManager.showMessage(BB.Locale.getString("creating_csv"));var src="api/v1/pipelines/"+pipeline.key()+"/newsfeed/export";var iframe=document.createElement("iframe");iframe.setAttribute("height",0);iframe.setAttribute("width",0);iframe.setAttribute("frameborder",0);iframe.setAttribute("src",BB.UI.getResourceURL(src));Streak.CSPBypass.appendChild(iframe,Gmail.elements.body[0])}else{return APIRequester.put("pipelines/"+pipeline.key()+"/newsfeed/export/full").getPromise().then(function(result){loading.destroy();BB.ButterBarManager.showMessage(BB.Locale.getString("newsfeed_export_email"))})}}).catch(function(err){BB.logError("export error",err);loading.destroy();BB.ButterBarManager.showError("Error from server")})});var moveSection={};moveSection.separator=menu.addSeparator();moveSection.pipelineMenu=BB.Widgets.Menu.create();moveSection.item=menu.addSubMenu(BB.Locale.getString("move_box"),moveSection.pipelineMenu);var renderPipelineMenu=function(){moveSection.pipelineMenu.empty();if(BB.Data.getAllPipelines().length>1){moveSection.separator.show();moveSection.item.show();_.each(BB.UI.getSortedPipelines(),function(newPipeline){if(newPipeline.key()!==pipeline.key()){moveSection.pipelineMenu.addItem(newPipeline.displayName(),function(){_moveBoxes(pipeline,newPipeline,pipelineSpreadsheetViewController.getCheckedBoxes())})}})}else{moveSection.separator.hide();moveSection.item.hide()}};renderPipelineMenu();menu.el.addClass("moreButtonMenu");var bm=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailArrow",text:BB.Locale.getString("more_button_text"),menu:menu,isRightAligned:true,isFixedPosition:true,menuClickTriggersOff:true});BB.Data.getAllPipelines().watch("change",renderPipelineMenu,bm);bm.off();bm.getElement().addClass("streak__pipelineMoreButton");if(!pipeline.getIsEditable()){importButton.setEnabled(false);moveSection.item.setEnabled(false)}var oldDestroy=bm.destroy.bind(bm);bm.destroy=function(){oldDestroy();if(importViewController){importViewController.destroy()}Streak.NotificationCenter.unsubscribe({observer:bm})};return bm};function _moveBoxes(pipeline,newPipeline,checkedBoxes){track("moveBoxesStarted");if(!checkedBoxes||checkedBoxes.length===0){Streak.BentoBox.ButterBarManager.showError(BB.Locale.getString("one_box_selected"));track("moveBoxesFailed",{userFailure:true});return}BB.MoveBoxHelper.moveBoxes(pipeline,newPipeline,checkedBoxes)}function _getPipelineExportsDirectoryPath(){return"pipelineExports"}Streak.DependencyManager.addFunction({functionKey:"emptyPipelineExportsDirectory",functionReference:function(){try{Streak.FileStore.remove(_getPipelineExportsDirectoryPath())}catch(err){}},dependentFunctionKeys:["fileStoreLoaded"]});BB.Modules.PipelineView.MoreButton=MoreButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineCSVImportView=Streak.Class.subclass({className:"PipelineCSVImportView",superclass:UI.View,_memberVariables:[{name:"_modal",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("importModal")},_showModal:function(modalOptions){if(!this._element.is(":FastVisible(noCompute)")){$.modal.close()}modalOptions.title=BB.Locale.getString("import_boxes_title");modalOptions.inner=this._element;modalOptions.persist=true;modalOptions.width="600px";this._modal=BB.Widgets.Modal.create(modalOptions);this._modal.show(true)},_hideSections:function(){this._element.find(".explanation").css({visibility:"hidden"});this._element.find(".importModal > div").hide()},_showSection:function(section){this._element.find(".importModal ."+section).show()},renderLoading:function(){this._showModal({showConfirm:false,cancelText:BB.Locale.getString("modal_cancel")});this._hideSections();this._showSection("loading");this._element.find(".explanation").css({visibility:"visible"});this._element.find(".explanation").show()},renderUpload:function(uploadUrl){var self=this;this._showModal({title:BB.Locale.getString("import_csv"),showConfirm:false,cancelText:BB.Locale.getString("modal_cancel")});this._element.find(".explanation").css({visibility:"visible"});var el=this._element.find(".iframeWrapper");el.empty();var iframe=document.createElement("iframe");iframe.src=uploadUrl;el.append(iframe);var loadedTimes=0;iframe.onload=function(){loadedTimes+=1;if(loadedTimes==1){self._hideSections();self._showSection("upload");self._element.find(".explanation").css({visibility:"visible"});self._element.find(".explanation").show()}if(loadedTimes>1){$(iframe).remove();self._callDelegateFunction("uploadComplete")}}},renderVerifying:function(){this._hideSections();this._showSection("verifying")},renderVerified:function(verifiedFields,recordsTotal){var self=this;this._showModal({showCancel:true,showConfirm:true,confirmText:BB.Locale.getString("import_verify_start"),confirmFunc:function(){self._callDelegateFunction("startProcessing");return true},cancelText:BB.Locale.getString("import_verify_cancel"),cancelFunc:function(){self._callDelegateFunction("cancelImport");return true}});this._hideSections();this._element.find(".explanation").hide();this._showSection("verified");self._element.find(".matched").empty();this._element.find(".verifiedText")[0].innerHTML=BB.Locale.getString("import_records_found",{number:recordsTotal,pluralize:[recordsTotal]});_.each(verifiedFields,function(field){self._element.find(".matched").append("<li>"+field+"</li>")})},renderProcessing:function(){var self=this;this._showModal({showConfirm:false,showCancel:true,cancelText:BB.Locale.getString("import_background"),cancelFunc:function(){self._callDelegateFunction("processInBackground")}});this._hideSections();this._element.find(".explanation").hide();this._showSection("processing")},updateLoadPercentage:function(percentage){this._element.find(".processing .percent")[0].innerHTML="("+percentage+"%)";this._element.find(".processing .loaderBar div").width(percentage+"%")},renderDone:function(){this._hideSections();this._element.find(".explanation").hide();this._showSection("done")},renderError:function(errorMessage){var self=this;this._showModal({showConfirm:true,showCancel:true,confirmText:BB.Locale.getString("import_try_again"),confirmFunc:function(){self._callDelegateFunction("tryImportAgain")},cancelText:BB.Locale.getString("import_close"),cancelFunc:function(){self._callDelegateFunction("cancelImport")}});this._hideSections();this._element.find(".explanation").hide();this._showSection("error");if(errorMessage){this._element.find(".importErrorDescription")[0].innerHTML=errorMessage}else{var desc=this._element.find(".importErrorDescription");desc[0].innerHTML=BB.Locale.getString("import_error_message_1")+"<br />"+BB.Locale.getString("import_error_message_2");desc.find("a").attr("href","mailto:support@streak.com")}}});Library.set("BentoBox.Modules.PipelineView.MoreButton.PipelineCSVImportView",PipelineCSVImportView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineCSVImportViewController=Streak.Class.subclass({className:"PipelineCSVImportViewController",superclass:UI.ViewController,_memberVariables:[{name:"_pipeline",destroy:false,set:true},{name:"_doneCallback",destroy:true,set:true},{name:"_importJobCollection",destroy:true},{name:"_currentImportJob",destroy:true},{name:"_poller",destroy:true}],_initialize:function(){UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=new BB.Modules.PipelineView.MoreButton.PipelineCSVImportView},setPipeline:function(pipeline){this._pipeline=pipeline;this._importJobCollection=BB.Models.ImportJob.createCollection(pipeline.key())},start:function(){this._stopPolling();this._importJobCollection.refresh(this._handleCollectionRefreshed.bind(this));this._view.renderLoading();BB.Tracker.track("import starting")},_handleCollectionRefreshed:function(){this._extractImportJob();if(this._currentImportJob){this._currentImportJobUpdated();return}this._setupNewImportJob()},_extractImportJob:function(){for(var ii=0;ii<this._importJobCollection.length;ii++){if(this._importJobCollection[ii]){switch(this._importJobCollection[ii].get("status")){case"UPLOADED":case"VERIFIED":case"PROCESSING":this._currentImportJob=this._importJobCollection[ii];return;break}}}return},_setupNewImportJob:function(){this._currentImportJob=BB.Models.ImportJob.create({pipelineKey:this._pipeline.key()});this._currentImportJob.save(this._currentImportJobUpdated.bind(this),this._creatingImportJobFailed.bind(this))},_creatingImportJobFailed:function(){this._view.renderError("Problem starting import job")},_currentImportJobUpdated:function(){switch(this._currentImportJob.get("status")){case"NOT_STARTED":this._renderUpload();break;case"UPLOADED":this._renderVerifying();break;case"VERIFIED":this._showVerified();break;case"PROCESSING":this.startProcessing();break;case"CLEANED_UP":this.destroy();break;default:this._renderError()}},_renderUpload:function(){var uploadUrl=this._currentImportJob.get("uploadUrl");var server=this._extractDomain(uploadUrl);uploadUrl=server+"/importUpload#"+uploadUrl;this._view.renderUpload(uploadUrl)},_extractDomain:function(url){var anchor=document.createElement("a");anchor.href=url;return anchor.origin},uploadComplete:function(){this._currentImportJob.refresh(this._currentImportJobUpdated.bind(this));BB.Tracker.track("import upload complete")},_renderVerifying:function(){this._view.renderVerifying();var self=this;this._startPolling("UPLOADED","VERIFIED",null,function(){self._showVerified()})},_showVerified:function(){this._view.renderVerified(this._currentImportJob.get("verifiedFields"),this._currentImportJob.get("recordsTotal"));BB.Tracker.track("import verified")},startProcessing:function(){this._currentImportJob.set("status","PROCESSING");this._currentImportJob.save();this._view.renderProcessing();var self=this;this._startPolling("PROCESSING","DONE",function(){var percent=(self._currentImportJob.get("percentageComplete")*100).round();self._view.updateLoadPercentage(percent)},function(){self._stopPolling();self._view.renderDone();self._doneCallback();BB.Tracker.track("import complete")})},processInBackground:function(){this.destroy()},_startPolling:function(continueStatus,doneStatus,continueFunction,doneFunction){if(this._poller){this._poller.stop();this._poller=null}var self=this;this._poller=_.repeatEvery(function(){self._refreshAndCheckAgainstStatus(continueStatus,doneStatus,continueFunction,doneFunction)},1e3)},_refreshAndCheckAgainstStatus:function(continueStatus,doneStatus,continueFunction,doneFunction){var self=this;this._currentImportJob.refresh(function(){self._checkAgainstStatus(continueStatus,doneStatus,continueFunction,doneFunction)},function(){self._renderError()})},_checkAgainstStatus:function(continueStatus,doneStatus,continueFunction,doneFunction){if(!this._currentImportJob){return}switch(this._currentImportJob.get("status")){case continueStatus:if(continueFunction){continueFunction()}break;case doneStatus:this._stopPolling();if(doneFunction){doneFunction()}break;case"INVALID_FILE":case"ERROR_IMPORTING":this._renderError();break;case"CLEANED_UP":this.start();break;default:this._renderError();break}},_renderError:function(){this._stopPolling();this._view.renderError(this._currentImportJob.get("errorMessage"))},_stopPolling:function(){if(this._poller){this._poller.stop()}this._poller=null},tryImportAgain:function(){this._currentImportJob.set("status","CANCELLED_BY_USER");this._currentImportJob.save();this._currentImportJob=null;this.start()},cancelImport:function(){this._stopPolling();BB.ButterBarManager.showMessage(BB.Locale.getString("import_cancel"),{time:5e3});this._currentImportJob.set("status","CANCELLED_BY_USER");this._currentImportJob.save();this.destroy();BB.Tracker.track("import canceled")}});Library.set("BentoBox.Modules.PipelineView.MoreButton.PipelineCSVImportViewController",PipelineCSVImportViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var PipelineSearchController=Streak.Class.subclass({className:"PipelineSpreadsheetViewController",superclass:Streak.UI.Delegator,_memberVariables:[{name:"_tableModel",destroy:false,set:true},{name:"_cursorModel",destroy:false,set:true},{name:"_pipeline",destroy:false},{name:"_resultSet",destroy:true,defaultValue:[]},{name:"_visibleResultSet",destroy:true,defaultValue:[]},{name:"_selectedIndex",destroy:true,defaultValue:-1},{name:"_searchTerm",destroy:true}],_initialize:function(pipeline){Streak.UI.Delegator.prototype._initialize.call(this);this._pipeline=pipeline},reset:function(){this._reset()},_reset:function(){this._resultSet=[];this._visibleResultSet=[];this._selectedIndex=-1;this._searchTerm=null;this._cursorModel.removeClassForAllCoordinates("searchResultsHighlightPipeline");this._callDelegateFunction("searchResultsChanged");this._delegate.redrawContentRows()},searchTriggered:function(query){this._searchTerm=query;this._cursorModel.removeClassForAllCoordinates("searchResultsHighlightPipeline");this.updateResultSet(this._searchTerm);if(this._resultSet.length>0){this._cursorModel.addClassToCoordinates("searchResultsHighlightPipeline",this._visibleResultSet);this.updateSelectedIndex();this._moveCursor()}else{this._reset()}},updateResultSet:function(query){this._resultSet=[];this._visibleResultSet=[];if(_.isNotReal(query)||query.length<2){return}query=query.toUpperCase();var numRows=this._tableModel.getNumberOfRowsIncludingCollapsed()+1;var visibleRowIndex=0;var inOpenGroup=true;for(var ii=0;ii<numRows;ii++){if(ii>0){if(this._tableModel.isGroupRowIncludingCollapsed([ii,0])){inOpenGroup=this._tableModel.isGroupIncludingCollapsedOpen(ii);visibleRowIndex++}else if(inOpenGroup){visibleRowIndex++}}var currColumns=this._tableModel.getLastColumnForCurrentRow([ii,0])+1;for(var jj=0;jj<currColumns;jj++){var coord=[ii,jj];var val=this._tableModel.getSearchValue(coord);if(!val){continue}val=val.toString().toUpperCase();if(val.indexOf(query)>-1){this._resultSet.push(coord);if(inOpenGroup){this._visibleResultSet.push([visibleRowIndex,jj])}}}}},updateSelectedIndex:function(){var currentCoord=this._cursorModel.getPosition()||[0,0];var translatedCoord=this._tableModel.translateCoordToIncludingCollapsed(currentCoord);this._selectedIndex=0;for(var ii=0;ii<this._resultSet.length;ii++){var greaterThan=this._cellIsGreaterThanOrEqualTo(this._resultSet[ii],translatedCoord);if(greaterThan){this._selectedIndex=ii;break}}},getResultState:function(){return{selectedIndex:this._selectedIndex+1,total:this._resultSet.length}},hideSearch:function(){this._reset();this._delegate.focus()},_moveCursor:function(){var selectedCoord=this._resultSet[this._selectedIndex];if(this._tableModel.isRowInCollapsedSection(selectedCoord[0])){this._tableModel.openClosestGroupIncludedCollapsed(selectedCoord[0]);this._delegate.runDataTransforms();this.searchTriggered(this.searchTerm);this.selectNext();return}var visibleCoord=this._tableModel.translateCoordToVisibleCoord(selectedCoord);
this._cursorModel.setPosition(visibleCoord);this._callDelegateFunction("searchResultsChanged");this._delegate.redrawContentRows()},_cellIsGreaterThanOrEqualTo:function(c1,c2){if(c1[0]>c2[0]){return true}if(c1[0]<c2[0]){return false}return c1[1]>=c2[1]},selectPrevious:function(){if(this._resultSet.length===0){this._reset();return}this._selectedIndex--;if(this._selectedIndex<0){this._selectedIndex=this._resultSet.length-1}this._moveCursor()},selectNext:function(){if(this._resultSet.length===0){this._reset();return}this._selectedIndex++;if(this._selectedIndex>=this._resultSet.length){this._selectedIndex=0}this._moveCursor()},updateCursorPosition:function(coord){this._cursorModel.setPosition(coord)}});BB.Modules.PipelineSearchController=PipelineSearchController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineTransformRegister=Streak.Class.subclass({className:"PipelineTransformRegister",superclass:Streak.Object,_memberVariables:[{name:"_transforms",destroy:true,get:true,defaultValue:[]},{name:"_namedTransforms",destroy:true,get:true,defaultValue:{}}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},register:function(transform,priority,name){transform.priority=priority;transform.transformName=name;this._transforms.push(transform);if(_.isReal(name)){this._registerNamedTransform(transform,name)}},_registerNamedTransform:function(transform,name){if(_.isNotReal(this._namedTransforms[name])){this._namedTransforms[name]=[]}this._namedTransforms[name].push(transform)}});Library.set("BentoBox.Modules.PipelineTransformRegister",new PipelineTransformRegister)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var _scrollPositions={};var _cursorPositionMap={};var PipelineSpreadsheetViewController=Streak.Class.subclass({className:"PipelineSpreadsheetViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_pipeline",destroy:false},{name:"_savedViewsController",destroy:false},{name:"_transformedData",destroy:false,get:true,defaultValue:{}},{name:"_pipelineTableModel",destroy:true,get:true},{name:"_cursorModel",destroy:true},{name:"_pipelineNewBox",destroy:true},{name:"_pipelineSearchController",destroy:true,get:true},{name:"_currentState",destroy:false},{name:"_unbindFunctions",destroy:true,defaultValue:[]}],cellChange:function(coord){this._view.redrawCell(coord)},rowChange:function(row){this._view.redrawRow(row)},runDataTransforms:function(){this._runDataTransforms()},redraw:function(){if(this._isRenderBlocked()){return}this._view.redrawTable()},redrawContentRows:function(){this._view.redrawContentRows()},widthChange:function(columnIndex){this._view.widthChange(columnIndex)},newBoxAdded:function(){this._callDelegateFunction("newBoxAdded")},focus:function(){this._view.focus()},resize:function(){this._view.resize()},getCheckedBoxes:function(){return this._pipelineTableModel.getCheckedBoxes()},getCursorPosition:function(){return this._cursorModel.getPosition()},updateCursorPosition:function(dir,axis){this._cursorModel.updatePosition(dir,axis);this._view.redrawContentRows();this._view.redrawGroupRows();this._view.focus()},updateCursorToEnd:function(axis){this._cursorModel.moveToEnd(axis);this._view.redrawContentRows();this._view.redrawGroupRows();this._view.focus()},updateCursorToBeginning:function(axis){this._cursorModel.moveToBeginning(axis);this._view.redrawContentRows();this._view.redrawGroupRows();this._view.focus()},unfocusCursor:function(){this._cursorModel.unfocus();_cursorPositionMap[this._getCursorPositionKey()]=null;this._view.hideCursor();this._view.redrawContentRows();this._view.redrawGroupRows()},cursorSelect:function(coord,shiftKey){var prevPosition=null;if(shiftKey&&coord){prevPosition=this._cursorModel.getPosition();if(this._pipelineTableModel.getActionType(prevPosition)!=="CHECKBOX"){prevPosition=null}}if(!coord){coord=this._cursorModel.getPosition()}if(prevPosition){if(this._pipelineTableModel.getActionType(coord)==="CHECKBOX"){this._pipelineTableModel.checkMultipleBoxes(prevPosition,coord)}}if(this._pipelineTableModel.getState(coord)!=="EDIT"){this._cursorModel.setPosition(coord);this._cursorModel.select();this._view.redrawGroupRows();this._view.redrawContentRows();return true}this._view.redrawContentRows();this._view.redrawGroupRows();return false},jumpToGroup:function(group){var index=this._pipelineTableModel.getGroupRowIndex(group);var self=this;if(index>-1){setTimeout(function(){self._cursorModel.setPosition([index,2]);self._view.focus()},1)}},registerScrollPosition:function(position){_scrollPositions[this._getCursorPositionKey()]=position},setIsMenuOpen:function(isMenuOpen){this._currentState.isMenuOpen=isMenuOpen},isMenuOpen:function(){return this._currentState.isMenuOpen},startNewBox:function(){this._pipelineNewBox.startNewBox()},startDeleteBox:function(){this._callDelegateFunction("startDeleteBox")},_initialize:function(pipelineKey,savedViewsController){this._pipeline=BB.Data.getPipeline(pipelineKey);this._savedViewsController=savedViewsController;this._currentState={hash:null,state:null,isMenuOpen:false};this._setupTableModel();this._setupCursorModel();this._setupPipelineNewBox();this._setupSearchController();Streak.UI.ViewController.prototype._initialize.call(this);this._bindToModelChanges()},_setupView:function(){this._view=new BB.Widgets.NewSpreadsheet(this._pipelineTableModel,this._cursorModel)},_setupTableModel:function(){this._pipelineTableModel=new BB.Modules.PipelineTableModel(this._pipeline);this._pipelineTableModel.setDelegate(this)},_setupCursorModel:function(){var self=this;this._cursorModel=BB.VirtualCursorModel.create({highlightFunc:function(coord){self._updateCurrentState(coord,"HIGHLIGHT")},unhighlightFunc:function(coord){self._updateCurrentState(coord,"DEFAULT")},selectFunc:function(coord){var actionType=self._pipelineTableModel.getActionType(coord);switch(actionType){case"INSTANT":case"CHECKBOX":self._pipelineTableModel.action(coord);break;case"EDIT":self._updateCurrentState(coord,"EDIT");break}}})},_setupPipelineNewBox:function(){this._pipelineNewBox=new BB.Modules.PipelineNewBox(this._pipeline,this._pipelineTableModel,this._cursorModel,this._savedViewsController);this._pipelineNewBox.setDelegate(this)},_setupSearchController:function(){this._pipelineSearchController=new BB.Modules.PipelineSearchController(this._pipeline);this._pipelineSearchController.setDelegate(this);this._pipelineSearchController.setTableModel(this._pipelineTableModel);this._pipelineSearchController.setCursorModel(this._cursorModel)},_runDataTransforms:function(){if(this._isRenderBlocked()){return}BB.Data.getPipelineBoxes(this._pipeline.key()).sortByParameter("lastUpdatedTimestamp");this._initializedTransformedData();this._applyTransforms();this._pipelineTableModel.setTransformedData(this._transformedData);this._cursorModel.setup(this._pipelineTableModel);this._pipelineNewBox.setTransformedData(this._transformedData);this._view.render();if(_.isReal(_cursorPositionMap[this._getCursorPositionKey()])){this._cursorModel.setPosition(_cursorPositionMap[this._getCursorPositionKey()])}if(_.isReal(_scrollPositions[this._getCursorPositionKey()])){this._view.setScrollPosition(_scrollPositions[this._getCursorPositionKey()])}this._callDelegateFunction("transformedDataChanged")},_initializedTransformedData:function(){this._transformedData.columns={};this._transformedData.columnOrder=[];this._transformedData.lists={novalue:{isEditable:false,groupModel:null,list:(BB.Data.getPipelineBoxes(this._pipeline.key())||[]).slice(0),color:null,isOpen:true}};this._transformedData.groups=["novalue"]},_applyTransforms:function(){var transforms=BB.Modules.PipelineTransformRegister.getTransforms();if(!transforms){return}var pipeline=this._pipeline;var transformedData=this._transformedData;var savedViewsController=this._savedViewsController;_.chain(transforms).sortBy(function(transform){if(!transform.priority){return 100}return transform.priority}).each(function(transform){transform(pipeline,transformedData,savedViewsController)})},_updateCurrentState:function(coord,state){if(state==="EDIT"&&this._pipelineTableModel.isGroup(coord)&&coord[1]!==2){coord[1]=2;this._cursorModel.setPosition(coord)}this._pipelineTableModel.updateState(coord,state);switch(state){case"DEFAULT":this._view.hideCursor();break;case"HIGHLIGHT":this._currentState.hash=this._pipelineTableModel.getRowHash(coord[0]);_cursorPositionMap[this._getCursorPositionKey()]=coord;this._view.showCursor(coord,{noHorizontalScroll:this._pipelineTableModel.isGroup(coord)});break;case"EDIT":this._currentState.hash=this._pipelineTableModel.getRowHash(coord[0]);_cursorPositionMap[this._getCursorPositionKey()]=coord;this._view.hideCursor();break}this._currentState.state=state;this._updateRowAndColumnMarker(coord,state)},_getCursorPositionKey:function(){var positionKey=this._pipeline.key();if(this._savedViewsController&&this._savedViewsController.activeView){positionKey+="_"+this._savedViewsController.activeView.viewKey}return positionKey},_updateRowAndColumnMarker:function(coord,state){var ii=0,numColumns;var totalNumColumns=this._pipelineTableModel.getNumberOfVisibleColumnsForRow([0,0]);var rawCoord=this._cursorModel.getRawPosition();for(ii=0;ii<totalNumColumns;ii++){if(ii!==coord[1]){this._cursorModel.removeCoordinateClass([0,ii],"bbActiveColumn")}}switch(state){case"DEFAULT":numColumns=this._pipelineTableModel.getNumberOfVisibleColumnsForRow(coord);for(ii=0;ii<numColumns;ii++){this._cursorModel.removeCoordinateClass([coord[0],ii],"bbActiveRow")}this._cursorModel.removeCoordinateClass([0,coord[1]],"bbActiveColumn");break;case"HIGHLIGHT":case"EDIT":if(!this._pipelineTableModel.isGroup(coord)){numColumns=this._pipelineTableModel.getNumberOfVisibleColumnsForRow(coord);for(ii=0;ii<numColumns;ii++){this._cursorModel.addCoordinateClass([coord[0],ii],"bbActiveRow");if(ii!==coord[1]){}}}this._cursorModel.addCoordinateClass([0,rawCoord[1]],"bbActiveColumn");break}},_bindToModelChanges:function(){this._bindToBoxCollectionChanges();this._bindToPipelineChanges();this._bindToSavedViewsControllerChanges()},_bindToBoxCollectionChanges:function(){var boxCollection=BB.Data.getPipelineBoxes(this._pipeline.key());var self=this;boxCollection.watch("change",this._boxChanged,this);boxCollection.watch("requestsCompleted",this._boxRequestsCompleted,this);boxCollection.watch("remove",this._throttledRunDataTransforms,this);boxCollection.watch("collectionBatchUpdated",function(){self._pipelineTableModel.updateGroupColumns();self._view.redrawGroupRows();self._view.redrawContentRows()},this);boxCollection.watch("collectionRefreshed",function(notification){self._throttledRunDataTransforms()},this)},_boxChanged:function(notification){var box=notification.model;var property=notification.property;var previousValue=notification.previousValue;var fieldKey=notification.property;if(property==="pipelineKey"){return}if(!box||!box.key||!box.key()){return}if(notification.transactionId){return}var columnKey="property|stageKey";var groupBySettings=this._savedViewsController.getGroupBySettings();if(groupBySettings&&groupBySettings.data){columnKey=groupBySettings.data}var columnProperty=null;var columnFieldKey=null;var shouldRenderTable=false;if(property==="fieldKey"){if(columnKey.indexOf("field|")>-1){columnFieldKey=columnKey.split("|")[1];var currentValue=box.getFieldValue(columnFieldKey);if(currentValue!==previousValue){shouldRenderTable=true}}}else if(columnKey.indexOf("property|")>-1){columnProperty=this._pipeline.getSystemColumn(columnKey.split("|")[1]).property;if(columnProperty===property){if(box.get(columnProperty)!==previousValue){shouldRenderTable=true}}}if(shouldRenderTable){this._throttledRunDataTransforms()}else{var boxRowIndex=this._pipelineTableModel.getBoxRowIndex(box,columnProperty,columnFieldKey);if(boxRowIndex>-1){this._view.redrawRow(boxRowIndex)}this._pipelineTableModel.updateGroupColumn(box)}},_boxRequestsCompleted:function(notification){var box=notification.model;var columnKey="property|stageKey";var groupBySettings=this._savedViewsController.getGroupBySettings();if(groupBySettings&&groupBySettings.data){columnKey=groupBySettings.data}var columnProperty=null;var columnFieldKey=null;var shouldRenderTable=false;if(columnKey.indexOf("field|")>-1){columnFieldKey=columnKey.split("|")[1]}else if(columnKey.indexOf("property|")>-1){columnProperty=this._pipeline.getSystemColumn(columnKey.split("|")[1]).property}var boxRowIndex=this._pipelineTableModel.getBoxRowIndex(box,columnProperty,columnFieldKey);this._view.redrawRow(boxRowIndex);this._pipelineTableModel.updateGroupColumn(box)},_boxCollectionChanged:function(notification){this._throttledRunDataTransforms()},_bindToPipelineChanges:function(){Streak.NotificationCenter.subscribe({eventName:"change",observer:this,filterParameters:{parentModel:this._pipeline},functionToCall:function(){this._view.redrawTable()}})},_bindToSavedViewsControllerChanges:function(){var self=this;this._unbindFunctions.push(this._savedViewsController.bind("transformSettingsChanged",function(){self._throttledRunDataTransforms()}));this._unbindFunctions.push(this._savedViewsController.bind("widthChange",function(){self._view.widthChange()}));this._unbindFunctions.push(this._savedViewsController.bind("selectColumnHeader",function(columnKey){var columnIndex=self._pipelineTableModel.getColumnIndex(columnKey);if(columnIndex===-1){return}self._cursorModel.setPosition([0,columnIndex+2]);self._cursorModel.select()}))},_isRenderBlocked:function(){return this._currentState.state==="EDIT"||this._currentState.isMenuOpen},_throttledRunDataTransforms:_.debounce(function(){this._runDataTransforms()},50),destroy:function(){NotificationCenter.unsubscribe({observer:this});Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.PipelineSpreadsheetViewController",PipelineSpreadsheetViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineTableModel=Streak.Class.subclass({className:"PipelineTableModel",superclass:Streak.UI.Delegator,_memberVariables:[{name:"_transformedData",destroy:false},{name:"_numRows",destroy:false},{name:"_numColumns",destroy:false},{name:"_groupRows",destroy:false,defaultValue:[]},{name:"_groupRowsIncludingCollapsed",destroy:false,defaultValue:[]},{name:"_numRowsIncludingCollapsed",destroy:false},{name:"_highlightCellCoord",destroy:false},{name:"_editCellCoord",destroy:false},{name:"_checkedRows",destroy:false,defaultValue:[]},{name:"_pipeline",destroy:false,get:true,set:true},{name:"_visibleColumns",destroy:false,defaultValue:[]},{name:"_areBoxClicksEnabled",destroy:false,defaultValue:true}],_initialize:function(pipeline){Streak.UI.Delegator.prototype._initialize.call(this);this._pipeline=pipeline},setTransformedData:function(transformedData){this._transformedData=transformedData;this._reset()},reset:function(){this._reset()},_reset:function(){this._numRows=1;this._numRowsIncludingCollapsed=1;this._numColumns=2;this._groupRows.length=0;this._groupRowsIncludingCollapsed.length=0;this._highlightCellCoord=[0,0];this._editCellCoord=null;this._checkedRows.length=0;this._visibleColumns.length=0;for(var i=0;i<this._transformedData.groups.length;i++){this._groupRows.push(this._numRows);this._numRows+=1;this._groupRowsIncludingCollapsed.push(this._numRowsIncludingCollapsed);this._numRowsIncludingCollapsed+=1;var groupList=this._transformedData.lists[this._transformedData.groups[i]];if(groupList.isOpen){this._numRows+=groupList.list.length}this._numRowsIncludingCollapsed+=groupList.list.length}for(i=0;i<this._transformedData.columnOrder.length;i++){var column=this._transformedData.columns[this._transformedData.columnOrder[i]];if(column.isVisible&&!column.notPresent){this._visibleColumns.push(column);this._numColumns+=1}}},getTotalColumnCount:function(){return this._transformedData.columnOrder.length},getVisibleColumnCount:function(){return this._visibleColumns.length},getRowCount:function(){return this._numRows},getNumberOfNonHeaderRows:function(){return this.getLastRowNumber()},getLastRowNumber:function(){return this._numRows-1},getLastColumnForCurrentRow:function(coord){return this._numColumns-1},getNumberOfVisibleColumnsForRow:function(coord){return this._visibleColumns.length+2},getRowOfNextGroup:function(group){var groupIndex=this._transformedData.groups.indexOf(group);if(groupIndex===this._transformedData.groups.length-1){return-1}return this._groupRows[groupIndex+1]},getCheckedBoxes:function(){var boxes=[];for(var i=0;i<this._checkedRows.length;i++){var row=this._checkedRows[i];if(row>0){if(!this._isGroupRow(row)){boxes.push(this._getBox(row))}}}return boxes},checkMultipleBoxes:function(startCoord,endCoord){var diff=endCoord[0]-startCoord[0];var step=1;if(diff<0){step=-1}var newChecked=new Array(Math.abs(diff));var num=0;for(var i=startCoord[0]+step;step*i<step*endCoord[0];i=i+step){var tempCoord=[i,startCoord[1]];if(!this.isChecked(tempCoord)&&!this._isGroupRow(i)){newChecked[num]=i}num++}var unionChecked=_.union(this._checkedRows,newChecked);this._checkedRows.length=0;for(var ii=0;ii<unionChecked.length;ii++){this._checkedRows.push(unionChecked[ii])}for(var ii=0;ii<this._checkedRows.length;ii++){this._delegate.cellChange([this._checkedRows[ii],startCoord[1]])}this.notifySelectedBoxesChanged()},notifySelectedBoxesChanged:function(){Streak.NotificationCenter.postNotification({eventName:"pipeline.selectedBoxesChanged",pipelineKey:this._pipeline.key(),selectedBoxes:this.getCheckedBoxes(),sender:this})},getNumberOfBoxes:function(){if(!this._transformedData||!this._transformedData.lists){return 0}return _(this._transformedData.lists).values().map(function(groupObject){return groupObject.list}).flatten().length},getRowHash:function(row){if(row===0){return"columnHeaders"}else if(this._isGroupRow(row)){return this._getGroupID(row)}else{var box=this._getBox(row);if(box){if(box.get("newHash")){return box.get("newHash")}return box.key()}else{return null}}},isGroup:function(coord){return this._isGroupRow(coord[0])},isGroupRowIncludingCollapsed:function(coord){return this._isGroupRowIncludingCollapsed(coord[0])},isGroupIncludingCollapsedOpen:function(row){var groupID=this._getClosestGroupIDIncludingCollapsed(row);return this._transformedData.lists[groupID].isOpen},getGroupIndex:function(rowIndex){return this._groupRows.indexOf(rowIndex)},getGroupRowIndex:function(groupID){var index=this._transformedData.groups.indexOf(groupID);if(index>-1){return this._groupRows[index]}return index},getGroupID:function(row){return this._getClosestGroupID(row)},getGroupIDIncludingCollapsed:function(row){return this._getClosestGroupIDIncludingCollapsed(row)},translateCoordToIncludingCollapsed:function(coord){if(coord[0]===0){return coord}var currentRow=coord[0];var groupID=this._getClosestGroupID(currentRow);var groupRowIndexIncludingCollapsed=this._groupRowsIncludingCollapsed[this._transformedData.groups.indexOf(groupID)];var groupRowIndex=this.getGroupRowIndex(groupID);var groupRowDiff=groupRowIndexIncludingCollapsed-groupRowIndex;var translatedRow=currentRow+groupRowDiff;return[translatedRow,coord[1]]},translateCoordToVisibleCoord:function(coord){if(coord[0]===0){return coord}var currentRow=coord[0];var groupID=this._getClosestGroupIDIncludingCollapsed(currentRow);var groupRowIndexIncludingCollapsed=this._groupRowsIncludingCollapsed[this._transformedData.groups.indexOf(groupID)];var groupRowIndex=this.getGroupRowIndex(groupID);var groupRowDiff=groupRowIndex-groupRowIndexIncludingCollapsed;var translatedRow=currentRow+groupRowDiff;return[translatedRow,coord[1]]},getBoxRowIndex:function(box,property,fieldKey,inGroupID){if(!this._transformedData){return-1}var i,j,groupList,startIndex;var groupID=inGroupID;if(!groupID){if(property){groupID=box.get(property)}else if(fieldKey){groupID=box.getFieldValue(fieldKey)}}if(groupID&&this._transformedData.lists[groupID]){groupList=this._transformedData.lists[groupID];if(groupList.isOpen){startIndex=this.getGroupRowIndex(groupID)+1;for(i=0;i<groupList.list.length;i++){if(groupList.list[i].key()===box.key()){return startIndex+i}}}}else{for(i=0;i<this._transformedData.groups.length;i++){groupID=this._transformedData.groups[i];groupList=this._transformedData.lists[groupID];if(groupList.isOpen){startIndex=this.getGroupRowIndex(groupID)+1;for(j=0;j<groupList.list.length;j++){if(groupList.list[j]&&groupList.list[j].key()===box.key()){return startIndex+j}}}}}return-1},getBox:function(coord){return this._getBox(coord[0])},isCoordTheCurrentEditCell:function(coord){return this._isCoordsEqual(this._editCellCoord,coord)},getContainingGroupID:function(coord){return this._getClosestGroupID(coord[0])},getColumnIndex:function(columnKey){for(var ii=0;ii<this._visibleColumns.length;ii++){if(this._visibleColumns[ii].columnKey===columnKey){return ii}}return-1},getColumnSummaryType:function(coord){var column=this.getGroupColumnData(coord).column;if(!column){return false}return column.chosenSummaryFunction||column.isSummarizable},doesColumnHaveSummaryType:function(columnIndex){var column=this._visibleColumns[columnIndex-2];if(!column){return false}return!!column.chosenSummaryFunction},getNumberOfGroupRows:function(){return this._groupRows.length},getGroupRowIndexes:function(){return this._groupRows},areGroupRowsFat:function(){return this._transformedData.groupMeta.areGroupRowsFat},getGroupRowColor:function(groupIndex){var groupRowIndex=this._groupRows[groupIndex];var groupID=this._getGroupID(groupRowIndex);return this._transformedData.lists[groupID].color},getCollaborationStatus:function(){return this._pipeline.getCollaborationStatus()},getNumberOfRowsIncludingCollapsed:function(){return this._numRowsIncludingCollapsed},isRowInCollapsedSection:function(row){if(row===0){return false}var groupID=this._getClosestGroupIDIncludingCollapsed(row);return!this._transformedData.lists[groupID].isOpen},openClosestGroupIncludedCollapsed:function(row){var groupID=this._getClosestGroupIDIncludingCollapsed(row);this._transformedData.lists[groupID].toggleOpen()},canGoDownOnEnter:function(coord){if(coord[0]===0){return true}if(this._isGroupRow(coord[0])){return true}if(this._isGroupRow(coord[0]+1)){return false}return true},getActionType:function(coord){if(coord[0]===0){return this._getColumnActionType(coord)}else if(this._isGroupRow(coord[0])){return this._getGroupActionType(coord)}else{return this._getBoxActionType(coord)}},getState:function(coord){if(this._isCoordsEqual(this._highlightCellCoord,coord)){return"HIGHLIGHT"}else if(this._isCoordsEqual(this._editCellCoord,coord)){return"EDIT"}else{return"DEFAULT"}},updateState:function(coord,state){switch(state){case"DEFAULT":if(this._isCoordsEqual(this._highlightCellCoord,coord)){this._highlightCellCoord=null}else if(this._isCoordsEqual(this._editCellCoord,coord)){this._editCellCoord=null}break;case"HIGHLIGHT":this._highlightCellCoord=coord;if(this._isCoordsEqual(this._editCellCoord,coord)){this._editCellCoord=null}break;case"EDIT":this._highlightCellCoord=null;this._editCellCoord=coord;break}},getHTMLValue:function(coord){var val="";if(coord[0]===0){val=this._getColumnHTMLValue(coord)}else if(this._isGroupRow(coord[0])){val=this._getGroupHTMLValue(coord)}else if(this._isBoxRow(coord[0])){val=this._getBoxHTMLValue(coord)}return val},getSearchValue:function(coord){var val="";if(coord[0]===0){val=this._getColumnSearchValue(coord)}else if(this._isGroupRowIncludingCollapsed(coord[0])){val=this._getGroupSearchValue(coord)}else if(this._isBoxRow(coord[0])){val=this._getBoxSearchValue(coord)}return val},getTextValue:function(coord){var val="";if(coord[0]===0){val=this._getColumnTextValue(coord)}else if(this._isGroupRow(coord[0])){val=this._getGroupTextValue(coord)}else if(this._isBoxRow(coord[0])){val=this._getBoxTextValue(coord)}return val},getTextValueIncludingHiddenColumns:function(coord){var val="";if(coord[0]===0){val=this._getColumnTextValueIncludingHiddenColumns(coord)}else if(this._isGroupRowIncludingCollapsed(coord[0])){val=this._getGroupTextValueIncludingHiddenColumns(coord)}else if(this._isBoxRowIncludingCollapsed(coord[0])){val=this._getBoxTextValueIncludingHiddenColumns(coord)}return val},getData:function(coord){var val="";if(coord[0]===0){val=this._getColumnData(coord)}else if(this._isGroupRow(coord[0])){val=this._getGroupData(coord)}else if(this._isBoxRow(coord[0])){val=this._getBoxData(coord)}return val},action:function(coord){var val="";if(coord[0]===0){val=this._columnAction(coord)}else if(this._isGroupRow(coord[0])){val=this._groupAction(coord)}else if(this._isBoxRow(coord[0])){val=this._boxAction(coord)}return val},shouldNotScrollX:function(coord){return this._isGroupRow(coord[0])&&coord[1]===2},isChecked:function(coord){if(coord[1]===1){return this._checkedRows.indexOf(coord[0])>-1}var column=this._getVisibleColumn(coord[1]-2);if(!column.fieldKey){return false}var box=this._getBox(coord[0]);if(!box){return false}return box.getFieldValue(column.fieldKey)},getGroupColumnData:function(coord){return{group:this._getGroup(coord[0]),column:this._visibleColumns[coord[1]-2]}},getColumnData:function(columnIndex){var column=this._visibleColumns[columnIndex-2];return column},isColumnRenameable:function(column){return this._getColumn(column-2).isRenameable},isColumnVisible:function(index){var column=this._getColumn(index-2);return column.isVisible&&!column.notPresent},isColumnNotPresent:function(column){return this._getColumn(column-2).notPresent},isColumnNew:function(column){return this._getColumn(column-2).highlight},getColumnWidth:function(column){return this._getColumn(column-2).width||150},setColumnWidth:function(column,width){this._getColumn(column-2).setWidth(width);this._delegate.widthChange(column)},saveColumnWidth:function(column){this._getColumn(column-2).saveWidth()},columnReorder:function(existingVisibleIndex,newVisibleIndex,isAfter){this._visibleColumns[existingVisibleIndex].setNewIndex(newVisibleIndex,isAfter)},isGroupColumnEditable:function(coord){if(coord[1]<2){return false}return this._transformedData.groupMeta.canEdit},isColumnSummarizable:function(coord){var column=this._visibleColumns[coord[1]-2];return column.isSummarizable},updateGroupColumn:function(box){var boxRowIndex=this.getBoxRowIndex(box);if(boxRowIndex>-1){var groupID=this._getClosestGroupID(boxRowIndex);this._transformedData.lists[groupID].updateSummaryValues();this._delegate.rowChange(this.getGroupRowIndex(groupID))}},updateGroupColumns:function(){for(var ii=0;ii<this._transformedData.groups.length;ii++){this._transformedData.lists[this._transformedData.groups[ii]].updateSummaryValues()}},_getColumnActionType:function(coord){if(coord[1]===0){return"INSTANT"}else if(coord[1]===1){return"CHECKBOX"}else if(this._visibleColumns[coord[1]-2].isRenameable){return"EDIT"}return"NONE"},_getColumnHTMLValue:function(coord){if(coord[1]===0){return'<div class="bbHand Wp '+(!this._areAllGroupsClosed()?"Wq":"Wo")+'"></div>'}if(coord[1]===1){return""}var column=this._visibleColumns[coord[1]-2];if(!column||!column.getName){this._delegate.runDataTransforms();return""}return _.escape(column.getName())},_getColumnSearchValue:function(coord){if(coord[1]<2){return""}var column=this._visibleColumns[coord[1]-2];return column.getName()},_getColumnTextValue:function(coord){return this._visibleColumns[coord[1]-2].getName()},_getColumnTextValueIncludingHiddenColumns:function(coord){return this._transformedData.columns[this._transformedData.columnOrder[coord[1]]].getName()},_getColumnData:function(coord){var column=this._visibleColumns[coord[1]-2];return{model:column.getField(),type:"TEXT",property:"name"}},_columnAction:function(coord){if(coord[1]===0){var allClosed=this._areAllGroupsClosed();var lastID=null;for(var groupID in this._transformedData.lists){lastID=groupID;this._transformedData.lists[groupID].toggleOpen(allClosed,true)}this._transformedData.lists[lastID].toggleOpen(allClosed);this._delegate.runDataTransforms();return}if(coord[1]===1){var isChecked=!this.isChecked(coord);var startCheckboxIndex=1;var endCheckboxIndex=this.getLastRowNumber()+1;this._checkedRows.length=0;if(isChecked){for(var i=0;i<endCheckboxIndex;i++){this._checkedRows[i]=i}}this._delegate.redraw();this.notifySelectedBoxesChanged();return}var column=this._getColumn(coord[1]-2);if(!column.isVisible){column.show();this._delegate.runDataTransforms()}},_getGroupActionType:function(coord){if(coord[1]===0){return"INSTANT"}else if(coord[1]===1){return"CHECKBOX"}else{if(this._transformedData.groupMeta.canEdit&&coord[1]===2){return"EDIT"}else{return"NONE"}}},_getGroupHTMLValue:function(coord){var groupID=this._getGroupID(coord[0]);if(_.isNotReal(this._transformedData.lists[groupID])){return""}if(coord[1]===0){return'<span class="pre-child" style="background-color:'+this._transformedData.lists[groupID].color.backgroundColor+';">&nbsp;</span><div class="bbHand Wp '+(this._transformedData.lists[groupID].isOpen?"Wq":"Wo")+'"></div>'}else if(coord[1]===2){return this._transformedData.lists[groupID].displayName()}else if(coord[1]>2){var column=this._visibleColumns[coord[1]-2];return this._transformedData.lists[groupID].getHTMLValue(column.columnKey)}},_getGroupSearchValue:function(coord){if(coord[1]===2){var groupID=this._getClosestGroupIDIncludingCollapsed(coord[0]);return this._transformedData.lists[groupID].displayName()}else{return undefined}},_getGroupTextValue:function(coord){return this.group.getSearchValue(coord)},_getGroupTextValueIncludingHiddenColumns:function(coord){return this.group.getSearchValue(coord)},_getGroupData:function(coord){return{model:this._transformedData.lists[this._getGroupID(coord[0])].groupModel,type:"TEXT",property:"name",validator:this._transformedData.lists[this._getGroupID(coord[0])].isPotentialValueValid,trackingContext:{isStage:true}}},_groupAction:function(coord){var groupID=this._getGroupID(coord[0]);var i;if(coord[1]===0){this._transformedData.lists[groupID].toggleOpen();this._delegate.runDataTransforms()}else if(coord[1]===1){var isChecked=!this.isChecked(coord);if(this._transformedData.lists[groupID].isOpen){var groupRowIndex=this._groupRows.indexOf(coord[0]);var startCheckboxIndex=coord[0]+1;var endCheckboxIndex=-1;if(groupRowIndex===this._groupRows.length-1){endCheckboxIndex=this._groupRows[groupRowIndex]+this._transformedData.lists[groupID].list.length+1}else{endCheckboxIndex=this._groupRows[groupRowIndex+1]}var lengthOfCheckedGroup=endCheckboxIndex-startCheckboxIndex;var newChecked=new Array(lengthOfCheckedGroup+1);newChecked[0]=coord[0];for(i=0;i<lengthOfCheckedGroup;i++){newChecked[i+1]=startCheckboxIndex+i}if(isChecked){this._checkedRows=_.chain(this._checkedRows).union(newChecked).compact().value()}else{for(i=0;i<newChecked.length;i++){this._checkedRows.removeVal(newChecked[i])}}}this._delegate.redraw();this.notifySelectedBoxesChanged()}},_getBoxActionType:function(coord){if(coord[1]===0){return"INSTANT"}else if(coord[1]===1){return"CHECKBOX"}else if(coord[1]>1){var column=this._getVisibleColumn(coord[1]-2);if(column.isEditable){return"EDIT"}else if(column.isCheckbox){return"CHECKBOX"}else{return"NONE"}}},_getBoxHTMLValue:function(coord){var box=this._getBox(coord[0]);if(!box){throw new Error("box.getHTMLValue called on a non-box coordinate")}var groupID=this._getClosestGroupID(coord[0]);if(coord[1]===0){return'<span class="pre-child" style="background-color:'+(box.key().indexOf("__new__")===-1?this._transformedData.lists[groupID].color.backgroundColor:"#ccc")+';">&nbsp;</span>'+'<span class="link" role="link">&nbsp;</span>'
}else if(coord[1]===1){}else{var columnIndex=coord[1]-2;var column=this._getVisibleColumn(columnIndex);if(!column){this._delegate.runDataTransforms();return""}if(column.fieldKey){return BB.Models.BoxField.getHTMLValue(box,column.fieldKey)}else if(column.property){return box.getProcessedHTMLValue(column.property)}}},_getBoxSearchValue:function(coord){var box=this._getBoxIncludingCollapsed(coord[0]);if(!box){return""}if(coord[1]>1){var columnIndex=coord[1]-2;var column=this._getVisibleColumn(columnIndex);if(column.fieldKey){return box.getFieldSearchValue(column.fieldKey)}else if(column.property){return box.getSearchValue(column.property)}}return""},_getBoxTextValue:function(coord){var box=this._getBox(coord[0]);if(!box){return""}if(coord[1]>1){var columnIndex=coord[1]-2;var column=this._visibleColumns[columnIndex];if(column.fieldKey){return box.getFieldTextValue(column.fieldKey)}else if(column.property){return box.getTextValue(column.property)}}return""},_getBoxTextValueIncludingHiddenColumns:function(coord){var box=this._getBoxIncludingCollapsed(coord[0]);if(!box){return""}var column=this._transformedData.columns[this._transformedData.columnOrder[coord[1]]];if(column.fieldKey){return box.getFieldTextValue(column.fieldKey)}else if(column.property){return box.getTextValue(column.property)}},_getBoxData:function(coord){var box=this._getBox(coord[0]);var column=this._getVisibleColumn(coord[1]-2);if(!column){this._delegate.runDataTransforms();return null}var data={};if(column.fieldKey){data=BB.Models.BoxField.getSpreadsheetInputOptions(box,column.fieldKey,coord,this,this._delegate)}else if(column.property){data.model=box;data.property=column.property;data.type=BB.Models.Pipeline.getPropertyType(column.property);if(column.property==="stageKey"){data.list=this._pipeline.getStagesAsListText();if(this.isChecked([coord[0],1])){data.models=this.getCheckedBoxes()}else{data.models=[box]}}else if(column.property==="assignedToSharingEntries"){data.type="ASSIGNED_TO";data.existingList=this._pipeline.getAllAssignedToValues()}else if(column.property.indexOf("linkedBoxes")>-1){data.type="LINKED_BOXES"}else if(column.property==="name"&&!box.isSavedOnServer()){data.validator=this._isEmptyBoxName;data.callOnEmptyFunction=this._delegate.runDataTransforms}}else{data=null}return data},_boxAction:function(coord){var box=this._getBox(coord[0]);if(coord[1]===0){if(box.isSavedOnServer()){if(this._areBoxClicksEnabled){BB.UI.setURL(box.link())}}return}if(coord[1]===1){if(this.isChecked(coord)){this._checkedRows.removeVal(coord[0])}else{this._checkedRows.push(coord[0])}this.notifySelectedBoxesChanged();this._delegate.cellChange(coord);return}var column=this._getVisibleColumn(coord[1]-2);if(!column.fieldKey){return}var currentCheckboxStatus=this.isChecked(coord);var checkboxField=box.getFieldModel(column.fieldKey);checkboxField.set("value",!currentCheckboxStatus);checkboxField.save()},disableBoxClicks:function(){this._areBoxClicksEnabled=false},enableBoxClicks:function(){this._areBoxClicksEnabled=true},_isCoordsEqual:function(coord1,coord2){return coord1&&coord2&&coord1[0]===coord2[0]&&coord1[1]===coord2[1]},_isGroupRow:function(row){return this._groupRows.indexOf(row)>-1},_isGroupRowIncludingCollapsed:function(row){return this._groupRowsIncludingCollapsed.indexOf(row)>-1},_getGroupID:function(row){var index=this._groupRows.indexOf(row);return this._transformedData.groups[index]},_getClosestGroupID:function(row){for(var i=0;i<this._groupRows.length;i++){if(row===this._groupRows[i]){return this._transformedData.groups[i]}else if(row<this._groupRows[i]){return this._transformedData.groups[i-1]}}return _.last(this._transformedData.groups)},_isBoxRow:function(row){var box=this._getBox(row);return!!box},_isBoxRowIncludingCollapsed:function(row){if(row===0){return false}if(this._isGroupRowIncludingCollapsed(row)){return false}var box=this._getBoxIncludingCollapsed(row);return!!box},_getBox:function(row){var groupID=this._getClosestGroupID(row);var startingPoint=-1;for(var i=0;i<this._groupRows.length;i++){if(row<this._groupRows[i]){startingPoint=this._groupRows[i-1];break}}if(startingPoint===-1){startingPoint=_.last(this._groupRows)}var indexIntoList=row-startingPoint-1;var listHolder=this._transformedData.lists[groupID];if(listHolder){return listHolder.list[indexIntoList]}return null},_getBoxIncludingCollapsed:function(row){var groupID=this._getClosestGroupIDIncludingCollapsed(row);var startingPoint=-1;for(var i=0;i<this._groupRowsIncludingCollapsed.length;i++){if(row<this._groupRowsIncludingCollapsed[i]){startingPoint=this._groupRowsIncludingCollapsed[i-1];break}}if(startingPoint===-1){startingPoint=_.last(this._groupRowsIncludingCollapsed)}var indexIntoList=row-startingPoint-1;return this._transformedData.lists[groupID].list[indexIntoList]},_getClosestGroupIDIncludingCollapsed:function(row){for(var i=0;i<this._groupRowsIncludingCollapsed.length;i++){if(row===this._groupRowsIncludingCollapsed[i]){return this._transformedData.groups[i]}else if(row<this._groupRowsIncludingCollapsed[i]){return this._transformedData.groups[i-1]}}return _.last(this._transformedData.groups)},_getVisibleColumn:function(columnIndex){for(var i=0,index=0;i<this._transformedData.columnOrder.length;i++){if(this._transformedData.columns[this._transformedData.columnOrder[i]].isVisible&&!this._transformedData.columns[this._transformedData.columnOrder[i]].notPresent){if(index===columnIndex){return this._transformedData.columns[this._transformedData.columnOrder[i]]}index+=1}}},_areAllGroupsClosed:function(){return this._transformedData.areAllGroupsClosed},_areAllGroupsOpen:function(){return this._transformedData.areAllGroupsOpen},_getColumn:function(columnIndex){return this._transformedData.columns[this._transformedData.columnOrder[columnIndex]]},_getGroup:function(rowIndex){return this._transformedData.lists[this._getGroupID(rowIndex)]},_isEmptyBoxName:function(box,value){if(value.trim().length>0){return true}BB.ButterBarManager.showError(BB.Locale.getString("empty_box_name"),{time:5e3})}});Library.set("BentoBox.Modules.PipelineTableModel",PipelineTableModel)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var addBoxKey="__new__";var PipelineNewBox=Streak.Class.subclass({className:"PipelineNewBox",superclass:Streak.UI.Delegator,_memberVariables:[{name:"_cursor",destroy:false,set:true},{name:"_pipeline",destroy:false,set:true},{name:"_tableModel",destroy:false,set:true},{name:"_savedViewsController",destroy:false,set:true},{name:"_transformedData",destroy:false,set:true},{name:"_emptyBox",destroy:false},{name:"_emptyBoxGroupID",destroy:false},{name:"_newBoxPosition",destroy:false}],_initialize:function(pipeline,tableModel,cursor,savedViewsController){Streak.UI.Delegator.prototype._initialize.call(this);this._pipeline=pipeline;this._tableModel=tableModel;this._cursor=cursor;this._savedViewsController=savedViewsController},startNewBox:function(){this._reset();this._ensureNameColumnIsVisible();this._ensureContainingGroupIsOpen();this._createEmptyBoxModel();this._updateTable();this._bindToEmptyBoxCreation()},_reset:function(){if(this._emptyBoxGroupID||this._emptyBox){var listWrapperObject=this._transformedData.lists[this._emptyBoxGroupID];if(listWrapperObject&&listWrapperObject.list){listWrapperObject.list.removeVal(this._emptyBox)}this._emptyBox=null;this._emptyBoxGroupID=null;this._cursor.setPosition(this._cursor.getPosition())}},_ensureNameColumnIsVisible:function(){var columnVisibilitySettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.load(this._pipeline);var columnOrder=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(this._pipeline).data;var columnIndex=-1;for(var i=0,visibleColumnIndex=0;i<columnOrder.length;i++){var isVisible=columnVisibilitySettings.data[columnOrder[i]];if(_.isNotReal(isVisible)){isVisible=true}if(isVisible){columnIndex=visibleColumnIndex;visibleColumnIndex+=1}if(columnOrder[i]==="property|name"){break}}if(!isVisible){columnVisibilitySettings.data["property|name"]=true;BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.save(columnVisibilitySettings,this._pipeline);this._delegate.runDataTransforms();return}},_ensureContainingGroupIsOpen:function(){var columnVisibilitySettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings.load(this._pipeline);var columnOrder=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(this._pipeline).data;var columnIndex=-1;for(var i=0,visibleColumnIndex=0;i<columnOrder.length;i++){var isVisible=columnVisibilitySettings.data[columnOrder[i]];if(_.isNotReal(isVisible)){isVisible=true}if(isVisible){columnIndex=visibleColumnIndex;visibleColumnIndex+=1}if(columnOrder[i]==="property|name"){break}}this._newBoxPosition=this._cursor.getPosition();if(this._newBoxPosition[0]===0){this._newBoxPosition[0]=2}else{this._newBoxPosition[0]+=1}this._newBoxPosition[1]=columnIndex+2;this._emptyBoxGroupID=this._tableModel.getContainingGroupID([this._newBoxPosition[0]-1,0]);if(!this._transformedData.lists[this._emptyBoxGroupID].isOpen){this._transformedData.lists[this._emptyBoxGroupID].toggleOpen();this._delegate.runDataTransforms();this._ensureContainingGroupIsOpen()}},_createEmptyBoxModel:function(){this._emptyBox=BB.Models.Box.create({name:null,stageKey:this._pipeline.getStages()[0].key(),notes:null,pipelineKey:this._pipeline.key()});this._setDefaultValueFromContainingGroup();var newHash=addBoxKey+this._emptyBox.getId();this._emptyBox.set("boxKey",newHash);this._emptyBox.set("newHash",newHash)},_setDefaultValueFromContainingGroup:function(emptyBox,emptyBoxGroupID){var groupBySettings=this._savedViewsController.getGroupBySettings();emptyBoxGroupID=emptyBoxGroupID||this._emptyBoxGroupID;if(!this._emptyBoxGroupID||this._emptyBoxGroupID==="no_value"){return}emptyBox=emptyBox||this._emptyBox;if(groupBySettings.data.indexOf("stageKey")>-1){emptyBox.set("stageKey",emptyBoxGroupID)}else if(groupBySettings.data.indexOf("field")>-1){var fieldKey=groupBySettings.data.split("|")[1];emptyBox.getFieldModel(fieldKey).set("value",emptyBoxGroupID)}else{var property=groupBySettings.data.split("|")[1];if(!BB.Models.Pipeline.isPropertyEditable(property)){return}emptyBox.set(property,emptyBoxGroupID)}},_updateTable:function(){var groupRowIndex=this._tableModel.getGroupRowIndex(this._emptyBoxGroupID);var transformedListIndex=this._newBoxPosition[0]-groupRowIndex-1;this._transformedData.lists[this._emptyBoxGroupID].list.splice(transformedListIndex,0,this._emptyBox);this._tableModel.reset();this._delegate.redraw();this._delegate.cursorSelect(this._newBoxPosition)},_bindToEmptyBoxCreation:function(){var emptyBox=this._emptyBox;var oldSaveFunction=emptyBox.save;var boxCollection=BB.Data.getPipelineBoxes(emptyBox.getPipeline().key());var self=this;emptyBox.save=function(){var progressId=oldSaveFunction.call(emptyBox);emptyBox.save=oldSaveFunction;boxCollection.startTransaction();boxCollection.add(emptyBox);boxCollection.endTransaction(true);BB.Data.getAllBoxes().add(emptyBox);if(self._emptyBox===emptyBox){self._emptyBox=null}self._delegate.newBoxAdded();Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",observer:this,filterParameters:{operationProgressId:progressId,operationIsComplete:true},functionToCall:function(notification){emptyBox.set("newHash",null);self._delegate.redraw()},unsubscribeImmediately:true});self._setDefaultValueFromContainingGroup(emptyBox);self._waitForBoxSaveAndSaveDefaultValueFromGroup(progressId,emptyBox)}},_waitForBoxSaveAndSaveDefaultValueFromGroup:function(operationProgressId,emptyBox){var groupBySettings=this._savedViewsController.getGroupBySettings();var defaultValue=this._emptyBoxGroupID;if(!defaultValue||defaultValue==="no_value"){return}Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",observer:this,filterParameters:{operationProgressId:operationProgressId,operationIsComplete:true},functionToCall:function(notification){if(groupBySettings.data.indexOf("field")>-1){var fieldKey=groupBySettings.data.split("|")[1];emptyBox.getFieldModel(fieldKey).save()}else{emptyBox.save()}},unsubscribeImmediately:true})}});Library.set("BentoBox.Modules.PipelineNewBox",PipelineNewBox)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var self,PipelineToolbar;self=PipelineToolbar={defaults:{newBoxFunc:$.noop,deleteBoxFunc:$.noop,pipeline:null},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o)},_init:function(){if(!this.templates){this.templates={};this.templates.pipelineToolbar=HTML.get("pipelineToolbar");this.templates.backButton=HTML.get("pipelineToolbarBackButton");this.templates.deleteBoxButton=HTML.get("deleteBoxButton");this.templates.addBoxButton=HTML.get("addBoxButton")}}};var trackingContext;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};PipelineToolbar.impl=function(o){var options=o,pipeline=options.pipeline,feed=options.feed,savedViewsController=options.savedViewsController;var pipelineSpreadsheetViewController=options.pipelineSpreadsheetViewController;options.trackingContext.widgetContext+="/pipelineToolbar";trackingContext=options.trackingContext;var el=$(PipelineToolbar.templates.pipelineToolbar()),navGroup=BB.Widgets.Button.createGroup(),refreshGroup=BB.Widgets.Button.createGroup(),addboxGroup=BB.Widgets.Button.createGroup(),delboxGroup=BB.Widgets.Button.createGroup(),sheetGroup=BB.Widgets.Button.createGroup(),back=BB.Widgets.Button.create({isToggle:false,name:PipelineToolbar.templates.backButton(),onFunc:function(){track("backButtonPressed");el.trigger("back");history.back()}}),refresh=BB.Widgets.Button.create({isToggle:false,isRefresh:true,onFunc:function(){BB.ButterBarManager.showLoading(BB.Locale.getString("notice_loading"),{messageKey:"loadingPipeline"});track("refreshPipelineButtonPressed");pipeline.refresh(function(){var operationProgressId=BB.Data.getPipelineBoxes(pipeline.key()).refresh();Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",filterParameters:{operationProgressId:operationProgressId,operationIsComplete:true},unsubscribeImmediately:true,functionToCall:function(){pipelineSpreadsheetViewController.runDataTransforms();BB.ButterBarManager.hideMessage("loadingPipeline")},observer:el})})},trackingContext:_.clone(options.trackingContext)}),newBox=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailTextIcon",iconClass:"bbPlus bbIcon newBoxButton",text:BB.Locale.getString("new_box"),hasButtonToRight:true,onFunction:function(e){track("newBoxButtonPressed");pipelineSpreadsheetViewController.startNewBox();if(e){e.stopPropagation()}}}),deleteBox=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailTextIcon",iconClass:"bbIcon ar9 deleteBoxButton",text:BB.Locale.getString("delete_box"),hasButtonToLeft:true,onFunction:function(){var boxes=pipelineSpreadsheetViewController.getCheckedBoxes();track("deleteBoxesAttempted");if(boxes&&boxes.length>0){track("deleteBoxesAsked",{boxCount:boxes.length});BB.Widgets.Modal.confirmDelete(boxes.length+" "+BB.Locale.getString(boxes.length==1?"box":"boxes"),function(){if(boxes){if(boxes.length===1){boxes[0].del()}else if(boxes.length>1){var deleteProgressId=Streak.Model.deleteAll(boxes);_addMessagesForDeletingProgress(deleteProgressId)}track("deleteBoxesConfirmed")}},null,function(){track("deleteBoxesCancelled")})}else{track("deleteBoxesFailed",{userFalure:true});BB.ButterBarManager.showError(BB.Locale.getString("one_box_selected"),{time:5e3})}}}),reports=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailTextIcon",text:BB.Locale.getString("reports"),iconClass:"bbIcon streak__reportsIcon",hasButtonToRight:false,onFunction:function(e){track("reportsButtonPressed");BB.UI.setURL(Streak.Gmail.Constants.PipelineReports+"/"+pipeline.key());if(e){e.stopPropagation()}}}),buttonOptions={pipeline:options.pipeline,pipelineToolBar:el,pipelineSpreadsheetViewController:pipelineSpreadsheetViewController},savedViewsButton=BB.Modules.PipelineView.SavedViewsButton.create(_.extend(buttonOptions,{savedViewsController:savedViewsController,trackingContext:_.clone(options.trackingContext)})),more=BB.Modules.PipelineView.MoreButton.create(_.extend(buttonOptions,{trackingContext:_.clone(options.trackingContext)})),share=BB.Modules.PipelineView.ShareButton.create(_.extend(buttonOptions,{trackingContext:_.clone(options.trackingContext)})),showGroupbar=BB.Modules.PipelineView.ShowHideGroupbarButton.create(_.extend(buttonOptions,{trackingContext:_.clone(options.trackingContext),hasButtonToRight:true,toggleCallback:function(){pipelineSpreadsheetViewController.redraw()}})),showFeed=BB.Modules.PipelineView.ShowHideFeedButton.create($.extend({feed:options.feed,css:{"float":"right",marginRight:"0px"},toggleCallback:function(){pipelineSpreadsheetViewController.resize()}},buttonOptions,{trackingContext:_.clone(options.trackingContext)}));buttonOptions.buttonGroup=[];buttonOptions.buttonGroup.push(showGroupbar.el);buttonOptions.buttonGroup.push(showFeed.getElement());buttonOptions.buttonGroup.push(share.el);buttonOptions.buttonGroup.push(more.getElement());buttonOptions.buttonGroup.push(back.el);var fullScreen=BB.Modules.PipelineView.FullScreenSpreadsheetButton.create(_.extend(buttonOptions,{trackingContext:_.clone(options.trackingContext)}));$(newBox.getElement()).addClass("streak__newBoxOuterButton");$(deleteBox.getElement()).addClass("streak__deleteBoxOuterButton");if(!pipeline.getIsEditable()){newBox.disable();deleteBox.disable()}navGroup.el.append(back.el);refreshGroup.el.append(refresh.el);addboxGroup.el.append(newBox.getElement());delboxGroup.el.append(deleteBox.getElement());sheetGroup.el.append(savedViewsButton.getElement());sheetGroup.el.append(reports.getElement());sheetGroup.el.append(more.getElement());el.append(navGroup.el);el.append(refreshGroup.el);el.append(addboxGroup.el);el.append(delboxGroup.el);el.append(sheetGroup.el);el.append(share.el);el.append(showFeed.getElement());fullScreen.button.el.css({"float":"right"});el.append(fullScreen.button.el);showGroupbar.el.css({"float":"right"});el.append(showGroupbar.el);return{el:el,showFeed:showFeed,startDeleteBox:function(){deleteBox.on()},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:el});share.destroy();fullScreen.destroy();el.remove();more.destroy()}}};function _addMessagesForDeletingProgress(deleteProgressId){BB.ButterBarManager.showProgress({initial:"deleting",progressSuccess:"deleted_boxes_status_update",progressError:function(notification,strParameters){strParameters.box=_.escape(notification.operation.getModel().displayName());return BB.Locale.getString("deleted_boxes_error_update",strParameters)},completeSuccess:false,completeError:"deleted_boxes_error",operationProgressId:deleteProgressId})}BB.Modules.PipelineView.PipelineToolbar=PipelineToolbar})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var CONSTANTS={currentVersion:1};var SortSettings={load:function(pipeline,savedViewsController){var settings;if(savedViewsController){settings=savedViewsController.getSortSettings()}if(!settings){settings=this.create(pipeline)}else{settings=this.validateSettings(settings,pipeline)}return settings},create:function(pipeline){return{data:[],version:CONSTANTS.currentVersion}},validateSettings:function(settings,pipeline,noSave){var changed=false;if(settings.version!==CONSTANTS.currentVersion){settings=this.convertSettings(settings,pipeline)}var columnMap=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var foundColumns=[];for(var ii=0;ii<settings.data.length;ii++){var columnKey=settings.data[ii].columnKey;var type=columnKey.split("|");if(type.length!==2){continue}if(type[0]==="property"||columnMap[columnKey]){foundColumns.push(settings.data[ii])}else{changed=true}}settings.data=foundColumns;return settings},convertSettings:function(oldSettings,pipeline){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}BB.Modules.PipelineView.ViewSettings.SortSettings=SortSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var CONSTANTS={currentVersion:3};var FilterSettings={load:function(pipeline,savedViewsController){var settings;if(savedViewsController){settings=savedViewsController.getFilterSettings()}if(!settings){settings=this.create(pipeline)}else{settings=this.validateSettings(settings,pipeline)}return settings},create:function(pipeline){return{filters:["AND",["AND"]],version:CONSTANTS.currentVersion}},validateSettings:function(settings,pipeline,noSave){var changed=false;if(settings.version!==CONSTANTS.currentVersion){settings=this.convertSettings(settings,pipeline);changed=true}var fieldKeys=_.map(pipeline.getFields(),function(field){return field.key()});if(_.isReal(settings.property)&&settings.property==="stageKey"){var stage=pipeline.getStage(settings.value);if(!_.isReal(stage)){changed=true}}else{for(var ii=1;ii<settings.filters.length;ii++){var filterGroup=settings.filters[ii];for(var jj=1;jj<filterGroup.length;jj++){var filter=filterGroup[jj];if(_.isReal(filter.fieldKey)&&fieldKeys.indexOf(filter.fieldKey)===-1){changed=true;break}}if(changed){break}}}if(changed){var newSettings=FilterSettings.create(pipeline);settings.filters=newSettings.filters}return settings},convertSettings:function(oldSettings,pipeline){if(oldSettings.version===3){return oldSettings}else if(oldSettings.version===2&&_.isArray(oldSettings.filters)&&oldSettings.filters.length>0){var newSettings=FilterSettings.create(pipeline);newSettings.filters.remove(1);for(var ii=0;ii<oldSettings.filters.length;ii++){var newGroup=["AND"];newGroup.push({property:oldSettings.filters[ii].property,fieldKey:oldSettings.filters[ii].fieldKey,comparisonOperation:oldSettings.filters[ii].op,value:null,specificValue:oldSettings.filters[ii].value});newSettings.filters.push(newGroup)}return newSettings}else{return FilterSettings.create(pipeline)}}};BB.Modules.PipelineView.ViewSettings.FilterSettings=FilterSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnSettingsUtilities={getColumns:function(pipeline){var ii=0,key;var columns=[];var systemColumns=pipeline.getActiveSystemColumns();var fields=pipeline.getFields();for(ii=0;ii<systemColumns.length;ii++){columns.push({columnKey:"property|"+(systemColumns[ii].uniqueKey||systemColumns[ii].property),systemColumn:systemColumns[ii],type:systemColumns[ii].filterAndGroupType,property:systemColumns[ii].property})}for(ii=0;ii<fields.length;ii++){key="field|"+fields[ii].key();columns.push({columnKey:key,field:fields[ii],type:fields[ii].get("type")})}return columns},getColumnMap:function(pipeline){var columns=this.getColumns(pipeline);var columnMap={};for(var ii=0;ii<columns.length;ii++){columnMap[columns[ii].columnKey]=columns[ii]}return columnMap},isColumnKeyValid:function(columnKey,pipeline){if(columnKey.indexOf("property")>-1){return true}var columns=this.getColumns(pipeline);for(var ii=0;ii<columns.length;ii++){if(columns[ii].columnKey===columnKey){return true}}return false},getColumn:function(columnKey,pipeline){var columns=this.getColumns(pipeline);for(var ii=0;ii<columns.length;ii++){if(columns[ii].columnKey===columnKey){return columns[ii]}}}};Streak.Library.set("BentoBox.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities",ColumnSettingsUtilities)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var ColumnOrderSettings={load:function(pipeline){var settings=ViewSettingsUtility.getSharedSetting("columnOrder",pipeline);if(!settings){settings=this.create(pipeline)}settings=this.validate(settings,pipeline);return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setSharedSetting("columnOrder",settings,pipeline,dontSave)},create:function(pipeline){var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumns(pipeline);var settings={data:[],version:1};for(var ii=0;ii<columns.length;ii++){settings.data.push(columns[ii].columnKey)}return settings},validate:function(settings,pipeline){if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}var allColumns=this.create(pipeline).data;var columnMap={};var columnsToRemove=[];for(var ii=0;ii<allColumns.length;ii++){columnMap[allColumns[ii]]=true}for(var ii=0;ii<settings.data.length;ii++){if(columnMap[settings.data[ii]]){delete columnMap[settings.data[ii]]}else{columnsToRemove.push(settings.data[ii])}}for(var ii=0;ii<columnsToRemove.length;ii++){settings.data.removeVal(columnsToRemove[ii])}for(var columnKey in columnMap){settings.data.push(columnKey)}return settings},convert:function(oldSettings){return oldSettings},addNewColumn:function(settings,pipeline,columnKey,afterColumnKey){var currIndex=settings.data.indexOf(afterColumnKey);settings.data.splice(currIndex+1,0,columnKey);this.save(settings,pipeline);return currIndex+1},copyColumnOrder:function(fromPipeline,newPipeline){var fromOrder=ColumnOrderSettings.load(fromPipeline);var newOrder=[];for(var ii=0;ii<fromOrder.data.length;ii++){var columnKey=fromOrder.data[ii];var columnKeyParts=columnKey.split("|");if(columnKeyParts[0]==="field"){var fieldKey=columnKeyParts[1];var fromField=fromPipeline.getField(fieldKey);if(!fromField){continue}var newField=newPipeline.getFieldByName(fromField.displayNameText());newOrder.push("field|"+newField.key())}else{var propertyKey=columnKeyParts[1];var fromSystemColumn=fromPipeline.getSystemColumn(propertyKey);if(!fromSystemColumn){continue}var newSystemColumn=newPipeline.getSystemColumn(fromSystemColumn.property);if(!newSystemColumn){continue}newOrder.push("property|"+(newSystemColumn.uniqueKey||newSystemColumn.property))}}var newSettings=ColumnOrderSettings.create(newPipeline);newSettings.data=newOrder;ColumnOrderSettings.save(newSettings,newPipeline)}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.ColumnSettings){BB.Modules.PipelineView.ViewSettings.ColumnSettings={}}BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings=ColumnOrderSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var ColumnSummarySettings={load:function(pipeline){var settings=ViewSettingsUtility.getSharedSetting("columnSummary",pipeline);if(!settings){settings=this.create(pipeline)}else if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setSharedSetting("columnSummary",settings,pipeline,dontSave)},create:function(pipeline){var settings={data:{},version:1};return settings},convert:function(oldSettings){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.ColumnSettings){BB.Modules.PipelineView.ViewSettings.ColumnSettings={}}BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSummarySettings=ColumnSummarySettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var ColumnWidthSettings={load:function(pipeline){var settings=ViewSettingsUtility.getSharedSetting("columnWidth",pipeline);if(!settings){settings=this.create(pipeline)}else if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setSharedSetting("columnWidth",settings,pipeline,dontSave)},create:function(pipeline){var settings={data:{},version:1};return settings},convert:function(oldSettings){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.ColumnSettings){BB.Modules.PipelineView.ViewSettings.ColumnSettings={}}BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnWidthSettings=ColumnWidthSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var ColumnVisibilitySettings={load:function(pipeline){var settings=ViewSettingsUtility.getPrivateSetting("columnVisibility",pipeline);if(!settings){settings=this.create(pipeline)}else if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setPrivateSetting("columnVisibility",settings,pipeline,dontSave)},create:function(pipeline){var settings={data:{},version:1};return settings},convert:function(oldSettings){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.ColumnSettings){BB.Modules.PipelineView.ViewSettings.ColumnSettings={}}BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings=ColumnVisibilitySettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,BB=Streak.BentoBox,Pipeline=BB.Models.Pipeline;var CONSTANTS={currentVersion:1};var PipelineSummarySettings={load:function(pipeline,savedViewsController){var settings;if(savedViewsController){settings=savedViewsController.getSummarySettings()}if(!settings){settings=this.create(pipeline)}else{settings=this.validateSettings(settings,pipeline)}return settings},create:function(pipeline){return{data:{columnKey:"property|name",summaryFunction:"count"},version:CONSTANTS.currentVersion}},validateSettings:function(settings,pipeline){if(settings.version!==CONSTANTS.currentVersion){settings=this.convertSettings(settings,pipeline)}var columnMap=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);if(!settings.data||!columnMap[settings.data.columnKey]||!_.has(BB.ColumnSummary.Functions,settings.data.summaryFunction)){settings=this.create(pipeline)}return settings},convertSettings:function(oldSettings,pipeline){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings=PipelineSummarySettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var CONSTANTS={currentVersion:1.5};var GroupBySettings={load:function(pipeline,savedViewsController){var settings;if(savedViewsController){settings=savedViewsController.getGroupBySettings()}if(!settings){settings=this.create(pipeline)}else{settings=this.validateSettings(settings,pipeline)}return settings},create:function(pipeline){return{data:"property|stageKey",version:CONSTANTS.currentVersion}},validateSettings:function(settings,pipeline,noSave){if(settings.version!==CONSTANTS.currentVersion){settings=this.convertSettings(settings,pipeline)}if(!BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.isColumnKeyValid(settings.data,pipeline)){settings=this.create(pipeline)
}return settings},convertSettings:function(oldSettings,pipeline){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.GroupSettings){BB.Modules.PipelineView.ViewSettings.GroupSettings={}}BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings=GroupBySettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var GroupColorSettings={load:function(pipeline){var settings=ViewSettingsUtility.getSharedSetting("groupColors",pipeline);if(!settings){settings=this.create(pipeline)}settings=this.validate(settings);return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setSharedSetting("groupColors",settings,pipeline,dontSave)},create:function(pipeline){var settings={data:{},version:1};return settings},validate:function(settings,pipeline){if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}return settings},convert:function(oldSettings){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.GroupSettings){BB.Modules.PipelineView.ViewSettings.GroupSettings={}}BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings=GroupColorSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ViewSettingsUtility=BB.Modules.PipelineView.ViewSettingsUtility;var CONSTANTS={CURRENT_VERSION:1};var GroupOpenCloseSettings={load:function(pipeline){var settings=ViewSettingsUtility.getPrivateSetting("groupOpenClose",pipeline);if(!settings){settings=this.create(pipeline)}settings=this.validate(settings);return settings},save:function(settings,pipeline,dontSave){ViewSettingsUtility.setPrivateSetting("groupOpenClose",settings,pipeline,dontSave)},create:function(pipeline){var settings={data:{},version:1};return settings},validate:function(settings,pipeline){if(settings.version!==CONSTANTS.CURRENT_VERSION){settings=this.convert(settings)}return settings},convert:function(oldSettings){return oldSettings}};if(!BB.Modules.PipelineView.ViewSettings){BB.Modules.PipelineView.ViewSettings={}}if(!BB.Modules.PipelineView.ViewSettings.GroupSettings){BB.Modules.PipelineView.ViewSettings.GroupSettings={}}BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupOpenCloseSettings=GroupOpenCloseSettings})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var FilterTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.FilterSettings.load(pipeline,savedViewsController);if(!settings.filters||settings.filters.length===0){return}_.each(transformedData.groups,function(group){transformedData.lists[group].list=_.filter(transformedData.lists[group].list,function(box){return FilterFunctions.checkBoxAgainstFilters(box,settings.filters)})})};var FilterFunctions={checkBoxValueAgainstTextFilter:function(boxValue,filter){var boxCompareValue=boxValue;var filterCompareValue=filter.specificValue;if(_.isNumeric(boxValue)&&_.isNumeric(filterCompareValue)&&filter.comparisonOperation!=="contains"&&filter.comparisonOperation!=="notContains"){boxCompareValue=parseFloat(boxValue);filterCompareValue=parseFloat(filterCompareValue)}else{boxCompareValue=(boxCompareValue+"").toLowerCase();filterCompareValue=(filterCompareValue+"").toLowerCase()}switch(filter.comparisonOperation){case"gt":return boxCompareValue>filterCompareValue;break;case"lt":return boxCompareValue<filterCompareValue;break;case"eq":return boxCompareValue===filterCompareValue;break;case"ne":return boxCompareValue!==filterCompareValue;break;case"contains":return boxCompareValue.indexOf(filterCompareValue)>-1;break;case"notContains":return boxCompareValue.indexOf(filterCompareValue)===-1;break}},checkBoxValueAgainstDateFilter:function(boxValue,filter){var boxCompareValue=Date.ccreate(boxValue);var boxCompareValueByDate=boxCompareValue.resetTime();var filterCompareValue=filter.specificValue;var lookDirectionModifier=0;var timeUnit=null;if(_.isReal(filter.value)&&_.isNotReal(filter.specificValue)){filterCompareValue=filter.value;var filterParts=filterCompareValue.split(" ");if(filterParts.length===1){filterCompareValue=Date.ccreate(filterCompareValue);if(!_.isNumeric(filter.value)){filterCompareValue.resetTime()}}else if(filterParts.length===2){var direction=filterParts[0];timeUnit=filterParts[1];if(direction==="last"){lookDirectionModifier=-1}else if(direction==="next"){lookDirectionModifier=1}filterCompareValue=Date.create();switch(timeUnit){case"week":filterCompareValue.setWeekday(0);filterCompareValue.addWeeks(lookDirectionModifier);break;case"month":filterCompareValue.setDate(1);filterCompareValue.addMonths(lookDirectionModifier);break;case"year":filterCompareValue.setMonth(0);filterCompareValue.setDate(1);filterCompareValue.addYears(lookDirectionModifier);break}filterCompareValue.resetTime()}else if(filterParts.length===3){var numberOfDaysToLook=filterParts[1];filterCompareValue=Date.create();filterCompareValue.resetTime();lookDirectionModifier=-1;if(filterParts[0]==="next"){lookDirectionModifier=1}filterCompareValue.addDays(lookDirectionModifier*numberOfDaysToLook)}}else{filterCompareValue=Date.ccreate(filterCompareValue)}switch(filter.comparisonOperation){case"before":return boxCompareValue.isBefore(filterCompareValue);break;case"after":return boxCompareValue.isAfter(filterCompareValue);break;case"on":if(_.isReal(timeUnit)){var endBound=filterCompareValue.clone();switch(timeUnit){case"day":endBound.addDays(1);break;case"week":endBound.addWeeks(1);break;case"month":endBound.addMonths(1);break;case"year":endBound.addYears(1);break}return boxCompareValue.isBetweenBeginningInclusive(filterCompareValue,endBound)}return boxCompareValue.is(filterCompareValue);break}},checkBoxValueAgainstPeopleFilter:function(boxValue,filter){var boxCompareValue=boxValue;var filterCompareValue=filter.value||filter.specificValue;if(_.isString(boxCompareValue)){boxCompareValue=JSON.parse(boxCompareValue)}if(!_.isArray(boxCompareValue)){return true}if(filterCompareValue==="me"){filterCompareValue={fullName:(BB.getUser().get("googleProfileFullName")||"").toLowerCase(),email:BB.getUser().get("email").toLowerCase()}}else if(filterCompareValue==="__specific"){filterCompareValue=filter.specificValue}var checkIfAnyPeopleMatch=function(){return _.any(boxCompareValue,function(person){if(_.isArray(filterCompareValue)){return _.any(filterCompareValue,checkIfPersonMatches.bind(null,person))}else{return checkIfPersonMatches(person,filterCompareValue)}})};var checkIfPersonMatches=function(person,compareValue){if(!_.isReal(compareValue)){return true}if(compareValue==="me"){return person.email===BB.getUser().getEmail()}if(_.isString(person.fullName)&&_.isString(compareValue.fullName)){return person.fullName.toLowerCase()===compareValue.fullName.toLowerCase()}if(_.isString(person.email)&&_.isString(compareValue.email)){return person.email.toLowerCase()===compareValue.email.toLowerCase()}};switch(filter.comparisonOperation){case"includes":case"isAny":return checkIfAnyPeopleMatch();break;case"doesNotInclude":case"isNotAny":return!checkIfAnyPeopleMatch();break;case"isOnly":if(boxCompareValue.length>1){return false}return checkIfAnyPeopleMatch();break;case"isExactly":return _.all(boxCompareValue,function(person){if(_.isArray(filterCompareValue)){return _.any(filterCompareValue,checkIfPersonMatches.bind(null,person))}else{return checkIfPersonMatches(person,filterCompareValue)}});break;case"contains":return _.any(boxCompareValue,function(person){var check=false;if(_.isString(person.fullName)&&person.fullName.length>0){check=person.fullName.toLowerCase().indexOf(filterCompareValue.toLowerCase())>-1}if(_.isString(person.email)&&person.email.length>0){check=check||person.email.toLowerCase().indexOf(filterCompareValue.toLowerCase())>-1}return check});break;case"notContains":return!_.any(boxCompareValue,function(person){var check=false;if(_.isString(person.fullName)&&person.fullName.length>0){check=person.fullName.toLowerCase().indexOf(filterCompareValue.toLowerCase())>-1}if(_.isString(person.email)&&person.email.length>0){check=check||person.email.toLowerCase().indexOf(filterCompareValue.toLowerCase())>-1}return check});break}},checkBoxValueAgainstStageFilter:function(box,filter){var pipeline=box.getPipeline();var stages=box.getPipeline().getStages();var boxValue=box.getStage();var boxStageKey=boxValue.key();var boxStageIndex=stages.indexOf(boxValue);var filterCompareValue=filter.value;var filterCompareIndex;if(!_.isArray(filter.value)){if(_.isReal(filter.specificValue)){filterCompareValue=filter.specificValue.toLowerCase()}else if(_.isReal(filter.value)){filterCompareValue=filter.value.toLowerCase()}filterCompareIndex=stages.indexOf(pipeline.getStage(filterCompareValue))}switch(filter.comparisonOperation){case"isAny":return filterCompareValue.indexOf(boxStageKey)>-1;break;case"isNotAny":return filterCompareValue.indexOf(boxStageKey)===-1;break;case"gt":return boxStageIndex>filterCompareIndex;break;case"lt":return boxStageIndex<filterCompareIndex;break;case"eq":return boxValue.key()===filterCompareValue;break;case"ne":return boxValue.key()!==filterCompareValue;break;case"contains":return boxValue.displayName().toLowerCase().indexOf(filterCompareValue)>-1;break;case"notContains":return boxValue.displayName().toLowerCase().indexOf(filterCompareValue)===-1;break}},checkBoxValueAgainstDropdownFilter:function(boxValue,filter,box){var filterCompareValue=filter.value||filter.specificValue;switch(filter.comparisonOperation){case"isAny":return filterCompareValue.indexOf(boxValue)>-1;break;case"isNotAny":return filterCompareValue.indexOf(boxValue)===-1;break;case"eq":return boxValue===filterCompareValue;break;case"ne":return boxValue!==filterCompareValue;break;case"contains":var pipelineField=box.getPipeline().getField(filter.fieldKey);var option=pipelineField.getOption(boxValue);if(option&&option.name){return option.name.toLowerCase().indexOf(filterCompareValue.toLowerCase())>-1}return false;break;case"notContains":var pipelineField=box.getPipeline().getField(filter.fieldKey);var option=pipelineField.getOption(boxValue);if(option&&option.name){return option.name.toLowerCase().indexOf(filterCompareValue.toLowerCase())===-1}break}},checkBoxValueAgainstTagFilter:function(boxValue,filter,box){var boxCompareValue=boxValue;var filterCompareValue=filter.value||filter.specificValue;switch(filter.comparisonOperation){case"isAny":if(_.isNotReal(boxCompareValue)){return false}return checkIfAnyTagsMatch();break;case"isNotAny":if(_.isNotReal(boxCompareValue)){return true}return!checkIfAnyTagsMatch();break;case"isExactly":if(_.isNotReal(boxCompareValue)){return false}return _.all(boxCompareValue,function(tagKey){return filterCompareValue.indexOf(tagKey)>-1});break;case"includes":return checkIfAnyTagsMatch();break;case"doesNotInclude":return!checkIfAnyTagsMatch();break;case"isOnly":if(!boxCompareValue||boxCompareValue.length!==1){return false}return checkIfAnyTagsMatch();break;case"contains":var textValue=box.getFieldTextValue(filter.fieldKey);return textValue.indexOf(filterCompareValue)>-1;break;case"notContains":var textValue=box.getFieldTextValue(filter.fieldKey);return textValue.indexOf(filterCompareValue)===-1;break}function checkIfAnyTagsMatch(){return _.any(boxCompareValue,function(tagKey){var check=false;if(!_.isReal(filterCompareValue)){return true}if(_.isArray(filterCompareValue)){return filterCompareValue.indexOf(tagKey)>-1}else{return filterCompareValue===tagKey}})}},checkBoxAgainstFilter:function(box,filter){var boxValue;var type=filter.columnType;if(_.isReal(filter.property)){boxValue=box.getFilterValue(filter.property);type=type||BB.Models.Pipeline.getPropertyFilterAndGroupType(filter.property)}else if(_.isReal(filter.fieldKey)){type=type||box.getPipeline().getField(filter.fieldKey).get("type");boxValue=box.getFieldFilterValue(filter.fieldKey,type)}else{return true}if(filter.comparisonOperation==="isSet"){if(_.isReal(boxValue)){if(_.isString(boxValue)||_.isArray(boxValue)){if(boxValue.length>0){return true}}else{return true}}return false}else if(filter.comparisonOperation==="notSet"){if(_.isReal(boxValue)){if(_.isString(boxValue)||_.isArray(boxValue)){if(boxValue.length>0){return false}}else{return false}}return true}else if(filter.comparisonOperation==="isChecked"){if(_.isReal(boxValue)){return boxValue===true}}else if(filter.comparisonOperation==="isUnchecked"){return!!boxValue===false}else if(filter.comparisonOperation==="isTrue"){return boxValue===true}else if(filter.comparisonOperation==="isFalse"){return boxValue===false}else if((_.isNotReal(filter.value)||filter.value.length===0)&&(_.isNotReal(filter.specificValue)||filter.specificValue.length===0)){return true}if((_.isNotReal(boxValue)||boxValue.length===0)&&type!=="TAG"){return false}if(_.isReal(filter.property)&&filter.property==="stageKey"){return this.checkBoxValueAgainstStageFilter(box,filter)}switch(type){case"TEXT":case"TEXT_INPUT":case"NUMBER":case"BASIC_TEXT":return this.checkBoxValueAgainstTextFilter(boxValue,filter);break;case"DATE":return this.checkBoxValueAgainstDateFilter(boxValue,filter);break;case"PERSON":return this.checkBoxValueAgainstPeopleFilter(boxValue,filter);break;case"DROPDOWN":return this.checkBoxValueAgainstDropdownFilter(boxValue,filter,box);break;case"TAG":return this.checkBoxValueAgainstTagFilter(boxValue,filter,box);break}return true},checkBoxAgainstFilters:function(box,filters){var self=this;if(filters.length===0){return true}else{if(_.isString(filters[0])){var joiningOperation=filters[0];var filterOperands=_.rest(filters);var results=[];for(var ii=0;ii<filterOperands.length;ii++){var operand=filterOperands[ii];if(_.isArray(operand)){results.push(self.checkBoxAgainstFilters(box,operand))}else if(_.isObject(operand)){results.push(self.checkBoxAgainstFilter(box,operand))}}if(joiningOperation==="AND"){return _.all(results,function(result){return result})}else if(joiningOperation==="OR"){return _.any(results,function(result){return result})}else if(joiningOperation==="NONE"){return!_.any(results,function(result){return result})}}else if(_.isObject(filters[0])){try{return self.checkBoxAgainstFilter(box,filters[0])}catch(err){BB.logError("Error in running filter",err)}return true}}}};BB.Modules.PipelineTransformRegister.register(FilterTransform,1,"filterTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var SortTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.SortSettings.load(pipeline,savedViewsController);var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var sorts=[];for(var ii=0;ii<settings.data.length;ii++){var column=columns[settings.data[ii].columnKey];if(!column){continue}var sortObj={sort:settings.data[ii].sort};if(_.isReal(column.field)){sortObj.fieldKey=column.field.key()}else if(_.isReal(column.systemColumn)){sortObj.property=column.systemColumn.property}sorts.push(sortObj)}for(var ii=0;ii<transformedData.groups.length;ii++){var group=transformedData.groups[ii];if(transformedData.lists[group]&&transformedData.lists[group].list){sortBoxes(sorts,transformedData.lists[group].list,pipeline)}}};var sortBoxes=function(sortSettings,boxes,pipeline){var cachedSortValues={};boxes.sort(function(a,b){for(var i=0;i<sortSettings.length;i++){var valA,valB;var sort=sortSettings[i];if(sort.property){if(!cachedSortValues[sort.property]){cachedSortValues[sort.property]={}}if(cachedSortValues[sort.property][a.getId()]){valA=cachedSortValues[sort.property][a.getId()]}else{valA=a.getSortValue(sort.property);cachedSortValues[sort.property][a.getId()]=valA}if(cachedSortValues[sort.property][b.getId()]){valB=cachedSortValues[sort.property][b.getId()]}else{valB=b.getSortValue(sort.property);cachedSortValues[sort.property][b.getId()]=valB}}else if(sort.fieldKey){if(!cachedSortValues[sort.fieldKey]){cachedSortValues[sort.fieldKey]={}}if(cachedSortValues[sort.fieldKey][a.getId()]){valA=cachedSortValues[sort.fieldKey][a.getId()]}else{valA=a.getFieldSortValue(sort.fieldKey);cachedSortValues[sort.fieldKey][a.getId()]=valA}if(cachedSortValues[sort.fieldKey][b.getId()]){valB=cachedSortValues[sort.fieldKey][b.getId()]}else{valB=b.getFieldSortValue(sort.fieldKey);cachedSortValues[sort.fieldKey][b.getId()]=valB}}if(valA!==valB){var res=0;if(_.isNumeric(valA)&&_.isNumeric(valB)){res=parseFloat(valA)-parseFloat(valB)}else if(_.isArray(valA)&&_.isArray(valB)){var j;for(j=0;j<valA.length;j++){if(valA[j]===valB[j]){continue}else{break}}if(valA.length===j){res=0}else{res=valA[j]-valB[j]}}else if(!valA||valA===""){res=1}else if(!valB||valB===""){res=-1}else if(_.isString(valA)&&_.isString(valB)){valA=valA.toLowerCase();valB=valB.toLowerCase();res=(valA>valB)-(valA<valB)}return sort.sort==="DESC"?-1*res:res}}})};BB.Modules.PipelineTransformRegister.register(SortTransform,2,"sortTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ColumnOrderSettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings;var ColumnOrderTransform=function(pipeline,transformedData,savedViewsController){var settings=ColumnOrderSettings.load(pipeline);var columnOrder=settings.data;var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);_.each(columnOrder,function(columnKey,indexOf){var column=columns[columnKey];transformedData.columns[columnKey]={};transformedData.columns[columnKey].moveLeft=function(){var visIndex;for(visIndex=indexOf-1;visIndex>-1;visIndex--){if(transformedData.columns[columnOrder[visIndex]].isVisible){break}}if(indexOf>0&&visIndex>-1){columnOrder.removeVal(columnKey);columnOrder.splice(visIndex,0,columnKey);ColumnOrderSettings.save(settings,pipeline);savedViewsController.trigger("transformSettingsChanged")}};transformedData.columns[columnKey].moveRight=function(){var visIndex;for(visIndex=indexOf+1;visIndex<columnOrder.length;visIndex++){if(transformedData.columns[columnOrder[visIndex]].isVisible){break}}if(visIndex>0&&visIndex<columnOrder.length){columnOrder.removeVal(columnKey);columnOrder.splice(visIndex,0,columnKey);ColumnOrderSettings.save(settings,pipeline);savedViewsController.trigger("transformSettingsChanged")}};transformedData.columns[columnKey].setNewIndex=function(newVisibleIndex,isAfter){var actualIndex;var visibleIndex;for(actualIndex=0,visibleIndex=0;actualIndex<columnOrder.length;actualIndex++){if(transformedData.columns[columnOrder[actualIndex]].isVisible){if(visibleIndex===newVisibleIndex){break}visibleIndex++}}if(isAfter){actualIndex+=1}if(actualIndex!==indexOf){if(actualIndex>indexOf){actualIndex=actualIndex-1}columnOrder.removeVal(columnKey);columnOrder.splice(Math.max(actualIndex,0),0,columnKey);ColumnOrderSettings.save(settings,pipeline)}};transformedData.columns[columnKey].isFirst=indexOf===0;transformedData.columns[columnKey].isLast=indexOf===columnOrder.length-1;if(_.isReal(column.systemColumn)){transformedData.columns[columnKey].property=column.systemColumn.property}else{transformedData.columns[columnKey].fieldKey=column.field.key()}});transformedData.columnOrder=columnOrder};BB.Modules.PipelineTransformRegister.register(ColumnOrderTransform,1)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnAddRemoveTransform=function(pipeline,transformedData,savedViewsController){var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var columnOrderSettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.load(pipeline);_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];if(column.systemColumn){transformedColumn.isRemovable=!column.systemColumn.isDefault}else{transformedColumn.isDeletable=true}transformedColumn.remove=function(callback){if(transformedColumn.isRemovable||transformedColumn.isDeletable){if(column.systemColumn){pipeline.removeSystemColumn(column.systemColumn)}else{pipeline.removeField(column.field.key())}columnOrderSettings.data.removeVal(columnKey)}if(savedViewsController){savedViewsController.trigger("transformSettingsChanged")}BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.save(columnOrderSettings,pipeline)};transformedColumn.addSystemColumn=function(systemColumn,callback){var uniqueKey="property|"+pipeline.addSystemColumn(systemColumn);var newIndex=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.addNewColumn(columnOrderSettings,pipeline,uniqueKey,columnKey);if(callback){callback(newIndex)}if(savedViewsController){savedViewsController.trigger("transformSettingsChanged")}};transformedColumn.addCustomColumn=function(type){var fieldNames=pipeline.getFields().map(function(field){return field.displayName()});var t=transformedData.columnOrder.length;var name="Column "+t;while(t<100){if(fieldNames.indexOf(name)===-1){break}t++;name="Column "+t}var model=BB.Models.PipelineField.create({name:name,type:type,pipelineKey:pipeline.key()},pipeline);pipeline.addField(model,function(){var uniqueKey="field|"+model.key();var newIndex=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnOrderSettings.addNewColumn(columnOrderSettings,pipeline,uniqueKey,columnKey);if(savedViewsController){savedViewsController.trigger("transformSettingsChanged");savedViewsController.trigger("selectColumnHeader",uniqueKey)}})};transformedColumn.columnKey=columnKey})};BB.Modules.PipelineTransformRegister.register(ColumnAddRemoveTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnEditStatusTransform=function(pipeline,transformedData){var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];if(!pipeline.getIsEditable()){transformedColumn.isEditable=false;transformedColumn.isRenameable=false}else if(column.systemColumn){transformedColumn.isEditable=BB.Models.Pipeline.isPropertyEditable(column.systemColumn.property);transformedColumn.isRenameable=false}else if(column.field){var fieldKey=column.field.key();_.extend(transformedColumn,BB.Models.BoxField.getColumnEditStatusTransformOptions(pipeline,fieldKey))}})};BB.Modules.PipelineTransformRegister.register(ColumnEditStatusTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnFilterTransform=function(pipeline,transformedData,savedViewsController){var settings=BB.Modules.PipelineView.ViewSettings.FilterSettings.load(pipeline,savedViewsController);var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];transformedColumn.canFilterByContains=function(){return column.type==="TEXT"||column.type==="TEXT_INPUT"||column.type==="PERSON"||column.type==="STAGE"};transformedColumn.clearFilter=function(){var matchArray=getMatchedFilters(column,settings.filters);var removeArray=null;if(matchArray.length===1){var matchedFilter=matchArray[0];for(var ii=1;ii<filterSetting.filters.length;ii++){var filterArray=settings.filters[ii];var filterIndex=filterArray.indexOf(matchedFilter);if(filterIndex>-1){filterArray.removeVal(matchedFilter);removeArray=filterArray;break}}if(_.isArray(removeArray)&&removeArray.length===1){settings.filters.removeVal(removeArray);settings.filters.push(["AND"]);savedViewsController.setFilterSettings(settings)}}};transformedColumn.setContainsFilter=function(filterValue){var filterObject={comparisonOperation:"contains",value:null,specificValue:filterValue};if(_.isReal(column.systemColumn)){filterObject.property=column.systemColumn.property}else if(_.isReal(column.field)){filterObject.fieldKey=column.field.key()}if(settings.filters.length===2&&settings.filters[1].length===1){settings.filters[1].push(filterObject)}else{var matchArray=getMatchedFilters(column,settings.filters);if(matchArray.length===1){matchArray[0].comparisonOperation="contains";matchArray[0].value=null;matchArray[0].specificValue=filterValue}else if(matchArray.length===0){settings.filters.push(["AND",filterObject])}}savedViewsController.setFilterSettings(settings)};transformedColumn.setAdvancedFilter=function(){var filterObject={comparisonOperation:null,value:null,specificValue:null};if(_.isReal(column.systemColumn)){filterObject.property=column.systemColumn.property}else if(_.isReal(column.field)){filterObject.fieldKey=column.field.key()}if(settings.filters.length===2&&settings.filters[1].length===1){settings.filters[1].push(filterObject)}else{settings.filters.push(["AND",filterObject])}savedViewsController.setFilterSettings(settings);savedViewsController.trigger("openSavedViewsEditArea")};transformedColumn.isAdvancedFiltered=function(){var matchArray=getMatchedFilters(column,settings.filters);if(matchArray.length>1){return true}else if(matchArray.length===1){return matchArray[0].comparisonOperation!=="contains"}else{return false}};transformedColumn.getContainsFilter=function(){var numMatched=0;var matchArray=getMatchedFilters(column,settings.filters);if(matchArray.length>1){return null}else if(matchArray.length===1&&matchArray[0].comparisonOperation==="contains"){return matchArray[0].specificValue}return null}})};var getMatchedFilters=function(column,filters){var matchArray=[];var checkColumnObject={};if(_.isReal(column.systemColumn)){checkColumnObject.property=column.systemColumn.property}else if(_.isReal(column.field)){checkColumnObject.fieldKey=column.field.key()}for(var ii=1;ii<filters.length;ii++){var filterArray=filters[ii];if(_.isArray(filterArray)){for(var jj=1;jj<filterArray.length;jj++){var filter=filterArray[jj];if(_.isObject(filter)){if(filter.property===checkColumnObject.property&&_.isReal(filter.property)||filter.fieldKey===checkColumnObject.fieldKey&&_.isReal(filter.fieldKey)){matchArray.push(filter)}}}}}return matchArray};BB.Modules.PipelineTransformRegister.register(ColumnFilterTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnGroupByTransform=function(pipeline,transformedData,savedViewsController){var settings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var property=null;if(settings.data.indexOf("property")>-1){var systemColumn=pipeline.getSystemColumn(settings.data.split("|")[1]);if(systemColumn){property=systemColumn.property}}_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];transformedColumn.isGroupedBy=function(){if(columnKey.indexOf("property")>-1){return property===pipeline.getSystemColumn(columnKey.split("|")[1]).property}else{return columnKey===settings.data}};transformedColumn.isDateColumn=function(){return column.type==="DATE"};transformedColumn.getGranularity=function(){return settings.granularity};transformedColumn.setGroupBy=function(granularity){settings.data=columnKey;settings.granularity=granularity;savedViewsController.setGroupBySettings(settings)};transformedColumn.unGroupBy=function(){settings.data="property|stageKey";settings.granularity=null;savedViewsController.setGroupBySettings(settings)}})};BB.Modules.PipelineTransformRegister.register(ColumnGroupByTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnNameTransform=function(pipeline,transformedData){var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];if(_.isReal(column.field)){transformedColumn.isRenameable=true;transformedColumn.getField=function(){return column.field}}transformedColumn.getName=function(){if(_.isReal(column.field)){return column.field.displayNameText()}else if(_.isReal(column.systemColumn)){return Pipeline.getPropertyName(column.systemColumn.property)}}})};BB.Modules.PipelineTransformRegister.register(ColumnNameTransform,9)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline;var ColumnSortTransform=function(pipeline,transformedData,savedViewsController){var settings=BB.Modules.PipelineView.ViewSettings.SortSettings.load(pipeline,savedViewsController);var columns=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var sortMap={};for(var ii=0;ii<settings.data.length;ii++){sortMap[settings.data[ii].columnKey]=settings.data[ii]}_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columns[columnKey];var sortObject=sortMap[columnKey];if(_.isReal(sortObject)){transformedColumn.sort=sortObject.sort}transformedColumn.changeSort=function(value){if(value==="NONE"){if(_.isReal(sortObject)){settings.data.removeVal(sortObject)}}else{if(_.isReal(sortObject)){sortObject.sort=value}else{settings.data.unshift({columnKey:columnKey,sort:value})}}savedViewsController.setSortSettings(settings)};if(column.systemColumn){transformedColumn.property=column.systemColumn.property}else if(column.field){transformedColumn.fieldKey=column.field.key()}})};BB.Modules.PipelineTransformRegister.register(ColumnSortTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,ColumnSummarySettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSummarySettings;var Pipeline=BB.Models.Pipeline;var ColumnSummaryTransform=function(pipeline,transformedData,savedViewsController){var columnMap=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline);var settings=ColumnSummarySettings.load(pipeline);_.each(transformedData.columns,function(transformedColumn,columnKey){var column=columnMap[columnKey];var columnSettings=settings.data[columnKey];var summaryType;if(column.systemColumn&&column.systemColumn.summaryType){summaryType=column.systemColumn.summaryType}else if(column.type&&_.has(BB.ColumnSummary.FieldTypesToListTypes,column.type)){summaryType=BB.ColumnSummary.FieldTypesToListTypes[column.type]}else{summaryType="BASIC"}if(_.has(BB.ColumnSummary.ListTypes,summaryType)){transformedColumn.summaryFunctions=BB.ColumnSummary.ListTypes[summaryType];if(columnSettings&&_.has(BB.ColumnSummary.Functions,columnSettings.summaryFunction)){transformedColumn.chosenSummaryFunction=columnSettings.summaryFunction}}else{transformedColumn.summaryFunctions=[]}if(transformedColumn.summaryFunctions.length!==0){transformedColumn.isSummarizable=true;transformedColumn.setSummaryFunction=function(type){settings.data[columnKey]={summaryFunction:type};ColumnSummarySettings.save(settings,pipeline)}}transformedColumn.columnKey=columnKey
})};BB.Modules.PipelineTransformRegister.register(ColumnSummaryTransform,9)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ColumnVisibilitySettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnVisibilitySettings;var ColumnVisibilityTransform=function(pipeline,transformedData,savedViewsController){var settings=ColumnVisibilitySettings.load(pipeline);var data=settings.data;_.each(transformedData.columns,function(transformedColumn,columnKey){if(_.isReal(data[columnKey])){transformedColumn.isVisible=data[columnKey]}else{transformedColumn.isVisible=true}if(transformedColumn.property&&transformedColumn.property.indexOf("linkedBoxes")>-1){var parts=transformedColumn.property.split(".");if(parts.length>1){var pipelineKey=parts[1];var linkedPipeline=BB.Data.getPipeline(pipelineKey);transformedColumn.notPresent=!linkedPipeline}}transformedColumn.hide=function(){data[columnKey]=false;ColumnVisibilitySettings.save(settings,pipeline);savedViewsController.trigger("transformSettingsChanged")};transformedColumn.show=function(){var cIndex=transformedData.columnOrder.indexOf(columnKey);for(var ii=cIndex;ii>-1;ii--){var currColumnKey=transformedData.columnOrder[ii];if(transformedData.columns[currColumnKey].isVisible){break}else{data[currColumnKey]=true}}for(ii=cIndex+1;ii<transformedData.columnOrder.length;ii++){var currColumnKey=transformedData.columnOrder[ii];if(transformedData.columns[currColumnKey].isVisible){break}else{data[currColumnKey]=true}}ColumnVisibilitySettings.save(settings,pipeline)}})};BB.Modules.PipelineTransformRegister.register(ColumnVisibilityTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Pipeline=Streak.BentoBox.Models.Pipeline,ColumnWidthSettings=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnWidthSettings;var ColumnWidthTransform=function(pipeline,transformedData,savedViewsController){var settings=ColumnWidthSettings.load(pipeline);var widthData=settings.data;_.each(transformedData.columns,function(transformedColumn,columnKey){transformedColumn.width=Math.round(widthData[columnKey]);transformedColumn.setWidth=function(newWidth){widthData[columnKey]=newWidth;transformedColumn.width=newWidth;savedViewsController.trigger("widthChange")};transformedColumn.saveWidth=function(){savedViewsController.disableTriggerOnUISettingsSet();ColumnWidthSettings.save(settings,pipeline);savedViewsController.enableTriggerOnUISettingsSet()}})};BB.Modules.PipelineTransformRegister.register(ColumnWidthTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var GroupByTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);var column=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumn(settings.data,pipeline);if(!column){column={systemColumn:BB.Models.Pipeline.getSystemProperty(settings.data.split("|")[1])}}var lists=_(transformedData.lists).chain().values().pluck("list").flatten().groupByPlus(function(box){if(column.systemColumn){if(column.systemColumn.property==="stageKey"){return box.get("stageKey")}var val=box.getGroupByValue(column.systemColumn.property);if(column.systemColumn.type!=="DATE"){return val}return[_getDateByBucket(val[0],settings.granularity)]}else if(column.field){return BB.Models.BoxField.getGroupByValue(box,column.field.key(),settings.granularity)}}).value();transformedData.lists={};transformedData.groupMeta={canEdit:settings.data==="property|stageKey"&&pipeline.getIsEditable()};if(settings.data==="property|stageKey"){var stageKeys=_.map(pipeline.getStages(),function(stage){return stage.key()});for(var ii=0;ii<stageKeys.length;ii++){transformedData.lists[stageKeys[ii]]={list:lists[stageKeys[ii]]||[]}}}else{for(var group in lists){transformedData.lists[group]={list:lists[group]}}}if(column.systemColumn&&column.systemColumn.property==="stageKey"){transformedData.groups=_.map(pipeline.getStages(),function(stage){return stage.key()})}else{var columnType=column.type;if(!columnType){if(column.systemColumn){columnType=column.systemColumn.filterAndGroupType}}transformedData.groups=_.keys(transformedData.lists).sort(function(a,b){if(columnType==="DATE"){a=a==="no_value"?Infinity:Date.ccreate(a).getTime();b=b==="no_value"?Infinity:Date.ccreate(b).getTime()}var numA=Number(a);var numB=Number(b);if(!isNaN(numA)&&!isNaN(numB)){return numA-numB}return(""+a).localeCompare(b)})}};function _getDateByBucket(dateValue,granularity){return Streak.moment(dateValue).startOf(granularity).toDate()}BB.Modules.PipelineTransformRegister.register(GroupByTransform,1,"groupByTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var CONSTANTS={COLORS:["#FA573C","#FFAD46","#B3DC6C","#16A765","#9FC6E7","#4986E7","#7BD148","#F83A22","#AC725E","#92E1C0","#42D692","#D06B64","#FAD165","#FF7537","#9FE1E7"]};var GroupColorTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings.load(pipeline);var groupBySetting=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);if(_.isNotReal(settings.data[groupBySetting.data])){settings.data[groupBySetting.data]={}}var colorMap=settings.data[groupBySetting.data];var index=0;_.each(transformedData.lists,function(groupObject,group){if(_.isReal(colorMap[group])){groupObject.color=colorMap[group]}else{groupObject.color={backgroundColor:getColor(index,colorMap),textColor:"white"}}groupObject.changeColor=function(color){colorMap[group]=color;BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupColorSettings.save(settings,pipeline)};index++});if(groupBySetting.data==="property|stageKey"){transformedData.groupMeta.nextColor=getColor(transformedData.groups.length,colorMap)}};var getColor=function(index,colorMap){var colors=_.pluck(_.values(colorMap),"backgroundColor");var maxColorLength=CONSTANTS.COLORS.length;var colorLength=colors.length;for(var ii=index;ii<100;ii++){var tempColor=CONSTANTS.COLORS[ii%CONSTANTS.COLORS.length];var cIndex=colors.indexOf(tempColor);if(cIndex===-1){return tempColor}if(Math.abs(index-cIndex)>10){return tempColor}}return CONSTANTS.COLORS[Number.random(0,CONSTANTS.COLORS.length-1)]};BB.Modules.PipelineTransformRegister.register(GroupColorTransform,11,"groupByTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox,ColumnSettingsUtilities=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities;var Pipeline=BB.Models.Pipeline;var GroupDisplayNameTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);_.each(transformedData.lists,function(groupObject,group){groupObject.displayName=displayNameHTML;groupObject.displayNameHTML=displayNameHTML;groupObject.displayNameText=displayNameText;groupObject.getSearchValue=function(columnKey){if(columnKey==="property|name"){return displayNameHTML()}return groupObject.getValue(columnKey)};function displayNameText(){if(settings.data==="property|stageKey"){var stage=pipeline.getStage(group);if(stage){return stage.displayNameText()}}else if(settings.data.indexOf("property")>-1){var column=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumn(settings.data,pipeline);if(!column){column={systemColumn:BB.Models.Pipeline.getSystemProperty(settings.data.split("|")[1])}}var type=column.systemColumn.type;switch(type){case"DATE":var d=Date.create(group);if(d.isValid()){return _getPrettyDateBucketName(d,settings.granularity)}break;default:return group}}else if(settings.data.indexOf("field")>-1){var fieldKey=settings.data.split("|")[1];return BB.Models.BoxField.getGroupByDisplayTextValue(group,pipeline,fieldKey,settings.granularity)}return"No Value"}function displayNameHTML(){return _.escape(displayNameText())}})};function _getPrettyDateBucketName(dateObject,granularity){var moment=Streak.moment(dateObject);switch(granularity){case"DAY":case"WEEK":return dateObject.prettyDate(true);break;case"MONTH":return moment.format("MMMM YYYY");break;case"QUARTER":return"Q"+moment.format("Q YYYY");break;case"YEAR":return moment.format("YYYY");break}}BB.Modules.PipelineTransformRegister.register(GroupDisplayNameTransform,10,"groupByTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox,ColumnSettingsUtilities=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities;var GroupEditingTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);_.each(transformedData.lists,function(groupObject,group){if(settings.data==="property|stageKey"){groupObject.groupModel=pipeline.getStage(group)}groupObject.isPotentialValueValid=function(model,potentialValue){if(settings.data!=="property|stageKey"){return true}if(model.displayName()===potentialValue){return true}if(potentialValue.trim().length===0){BB.ButterBarManager.showError(BB.Locale.getString("empty_stage_name"),{time:5e3});return false}var stageNames=pipeline.getStageNamesText();if(stageNames.indexOf(potentialValue)>-1){BB.ButterBarManager.showError(BB.Locale.getString("same_stage_name"),{time:5e3});return false}return true}})};BB.Modules.PipelineTransformRegister.register(GroupEditingTransform,10,"groupByTransform")})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox,ColumnSettingsUtilities=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities;var Pipeline=BB.Models.Pipeline;var GroupValueTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);var groupColumnValueMap=getGroupColumnValueMap(transformedData,pipeline);_.each(transformedData.lists,function(groupObject,group){groupObject.getHTMLValue=function(columnKey){var column=transformedData.columns[columnKey];if(column.isSummarizable){var html="";if(column.chosenSummaryFunction){html+='<span class="streak__group_summary_value">';var result=groupColumnValueMap[group][columnKey];html+=_.escape(result);html+="</span>";html+='<span class="streak__group_summary_link summaryActive">';html+='<span class="streak__group_summary_label">';html+=_.escape(BB.ColumnSummary.getLocalizedName(column.chosenSummaryFunction));html+="</span>";html+='<span class="streak__group_summary_button">▾<span>';html+="</span>"}else{html+='<span class="streak__group_summary_link">';html+='<span class="streak__group_summary_label">';html+=_.escape(BB.Locale.getString("summary_heading"));html+="</span>";html+='<span class="streak__group_summary_button">▾<span>';html+="</span>"}return html}return""};groupObject.updateSummaryValues=function(){updateSummaryValuesForGroup(group,groupColumnValueMap,transformedData,pipeline)}})};function getGroupColumnValueMap(transformedData,pipeline){var valueMap={};for(var groupID in transformedData.lists){updateSummaryValuesForGroup(groupID,valueMap,transformedData,pipeline)}return valueMap}function updateSummaryValuesForGroup(groupID,groupColumnValueMap,transformedData,pipeline){var columnValueMap={};for(var columnKey in transformedData.columns){var column=transformedData.columns[columnKey];if(!column.isSummarizable){columnValueMap[columnKey]=""}else if(column.chosenSummaryFunction){columnValueMap[columnKey]=getGroupSummary(column.chosenSummaryFunction,transformedData.lists[groupID],column,pipeline)}}groupColumnValueMap[groupID]=columnValueMap}function getGroupSummary(summaryFunctionName,groupObject,column,pipeline){var values=getGroupColumnValues(groupObject,column);var columnInfo=BB.Modules.PipelineView.ViewSettings.ColumnSettings.ColumnSettingsUtilities.getColumnMap(pipeline)[column.columnKey];return BB.ColumnSummary.Functions[summaryFunctionName](values,columnInfo.type,pipeline,column.fieldKey)}function getGroupColumnValues(groupObject,column){return _.map(groupObject.list,function(box){if(column.property){return box.get(column.property)}else{return box.getFieldValue(column.getField().key())}})}BB.Modules.PipelineTransformRegister.register(GroupValueTransform,10)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var GroupOpenCloseTransform=function(pipeline,transformedData,savedViewsController,inSettings){var settings=inSettings||BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupOpenCloseSettings.load(pipeline);var groupBySetting=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings.load(pipeline,savedViewsController);if(settings.data.columnKey!==groupBySetting.data){settings.data.openStatus={}}settings.data.columnKey=groupBySetting.data;var allOpen=true;var allClosed=true;_.each(transformedData.lists,function(groupObject,group){if(_.isReal(settings.data.openStatus[group])){groupObject.isOpen=settings.data.openStatus[group]}else{groupObject.isOpen=true}allOpen=allOpen&&groupObject.isOpen;allClosed=allClosed&&!groupObject.isOpen;groupObject.toggleOpen=function(status,dontSave){if(_.isNotReal(status)){if(_.isReal(settings.data.openStatus[group])){status=!settings.data.openStatus[group]}else{status=false}}settings.data.openStatus[group]=status;BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupOpenCloseSettings.save(settings,pipeline,dontSave)}});transformedData.areAllGroupsOpen=allOpen;transformedData.areAllGroupsClosed=allClosed};BB.Modules.PipelineTransformRegister.register(GroupOpenCloseTransform)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,FilterSettings=BB.Modules.PipelineView.ViewSettings.FilterSettings,SortSettings=BB.Modules.PipelineView.ViewSettings.SortSettings,GroupBySettings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings;var initialized=false;var defaults={};var templates={};function init(){if(!initialized){templates.container=HTML.get("savedViewsEditArea")();templates.filterSection=HTML.get("savedViewsFilterSection")();templates.advancedSection=HTML.get("savedViewsAdvancedSection")();initialized=true}}var SavedViewsEditArea=function(options){init();var self=this;this.unbindFunctions=[];this.options=options;this.pipeline=options.pipeline;this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/savedViewsEditArea";this.containerElement=$(templates.container);this.filterContainer=$(templates.filterSection);this.advancedContainer=$(templates.advancedSection);this.savedViewsController=options.savedViewsController;this.createSections();this.createButtons();this.setupBindings();this.containerElement.hide()};SavedViewsEditArea.create=function(o){var options={};$.extend(options,defaults,o);return new SavedViewsEditArea(options)};_.extend(SavedViewsEditArea.prototype,{createSections:function(){var self=this;this.filterBar=BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.create({pipeline:this.pipeline,trackingContext:_.clone(this.trackingContext)});this.filterContainer.find(".savedViewsFilters").append(this.filterBar.containerElement);this.filterCollapse=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("saved_views_filters"),bodyEl:this.filterContainer,startOpen:true});this.containerElement.find(".savedViewsEditAreaInner").append(this.filterCollapse.el);this.sortByBar=BB.Modules.PipelineView.SavedViewsEditArea.SortByBar.create({pipeline:this.pipeline,trackingContext:_.clone(this.trackingContext)});this.groupByBar=BB.Modules.PipelineView.SavedViewsEditArea.GroupByBar.create({pipeline:this.pipeline,trackingContext:_.clone(this.trackingContext)});this.advancedContainer.find(".savedViewsSortBy").append(this.sortByBar.containerElement);this.advancedContainer.find(".savedViewsGroupBy").append(this.groupByBar.containerElement);this.advancedCollapse=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("saved_views_advanced"),bodyEl:this.advancedContainer,startOpen:false});this.containerElement.find(".savedViewsEditAreaInner").append(this.advancedCollapse.el)},createButtons:function(){var self=this;this.buttons={};this.buttons.saveButton=BB.Widgets.Button.create({name:BB.Locale.getString("saved_views_apply_and_save"),color:"blue",tabIndex:0,onFunc:this.saveView.bind(this)});this.buttons.saveButton.el.addClass("streak__savedViewsSaveButton");this.buttons.cancelButton=BB.Widgets.Button.create({name:BB.Locale.getString("cancel").capitalize(),tabIndex:0,onFunc:function(){self.updateDisplay();self.savedViewsController.trigger("closeSavedViewsEditArea")}});this.buttons.applyButton=BB.Widgets.Button.create({name:BB.Locale.getString("apply"),color:"blue",tabIndex:0,onFunc:this.applySettings.bind(this)});this.buttons.applyButton.el.addClass("streak__savedViewsApplyButton");var actionButtonElement=this.containerElement.find(".savedViewsActionButtons");actionButtonElement.append(this.buttons.saveButton.el);actionButtonElement.append(this.buttons.applyButton.el);actionButtonElement.append(this.buttons.cancelButton.el)},setupBindings:function(){var self=this;this.savedViewsController.bind("transformSettingsChanged",this.updateDisplay.bind(this));this.savedViewsController.bind("openSavedViewsEditArea",this.expandArea.bind(this));this.savedViewsController.bind("closeSavedViewsEditArea",this.collapseArea.bind(this));this.savedViewsController.bind("toggleSavedViewsEditArea",this.toggleArea.bind(this))},firstRender:function(){var currentState=this.savedViewsController.getCurrentSettingsState();this.firstLoaded=true;if(currentState.isDefaultSettingsActive){this.containerElement.hide()}else{this.containerElement.show();this.collapseArea()}},updateDisplay:function(){var currentState=this.savedViewsController.getCurrentSettingsState();var filterCollapseState=this.filterCollapse.isOpen();var advancedCollapseState=this.advancedCollapse.isOpen();this.filterCollapse.toggle(true);this.advancedCollapse.toggle(true);this.filterBar.updateDisplay(JSON.deepClone(currentState.filterSettings.filters));this.sortByBar.updateDisplay(JSON.deepClone(currentState.listOfSortedColumns));this.groupByBar.updateDisplay(currentState.groupBySetting,currentState.groupByGranularity);this.filterCollapse.toggle(filterCollapseState);this.advancedCollapse.toggle(advancedCollapseState);this.buttons.applyButton.el.hide();this.buttons.saveButton.el.hide();if(currentState.isASavedViewActive){this.buttons.saveButton.el.show()}else{this.buttons.applyButton.el.show()}},collapseArea:function(){this.containerElement.hide();this.savedViewsController.trigger("savedViewsEditAreaChanged")},expandArea:function(){this.containerElement.show();this.updateDisplay();this.savedViewsController.trigger("savedViewsEditAreaChanged")},toggleArea:function(){if(this.isAreaOpen()){this.collapseArea()}else{this.expandArea()}},isAreaOpen:function(){return this.containerElement.is(":FastVisible")},toggleContainer:function(){if(!this.firstLoaded){return}this.toggleArea()},openContainer:function(){if(!this.firstLoaded){return}if(!this.containerElement.is(":FastVisible")){this.expandArea()}},applySettings:function(){this.savedViewsController.trigger("closeSavedViewsEditArea");this.savedViewsController.applyViewSettings(this.getSettings())},saveView:function(){this.savedViewsController.trigger("closeSavedViewsEditArea");this.savedViewsController.updateActiveViewWithNewSettings(this.getSettings())},createNewView:function(){var self=this;self.track("createSavedViewAttempt");BB.Widgets.Modal.textboxModal({title:BB.Locale.getString("saved_view_create_modal_title"),placeholderText:BB.Locale.getString("Set the name of the new view"),callback:function(name){self.track("createSavedViewSuccess");self.savedViewsController.saveSettingsAsView(name,self.getSettings())}})},clearSettings:function(){this.savedViewsController.setToDefaultView()},getSettings:function(){var sortSettings=SortSettings.create(this.pipeline);var filterSettings=FilterSettings.create(this.pipeline);var groupBySettings=GroupBySettings.create(this.pipeline);filterSettings.filters=this.filterBar.getStatus();sortSettings.data=this.sortByBar.getStatus();_.extend(groupBySettings,this.groupByBar.getStatus());var summarySettings=this.savedViewsController.getSummarySettings();return{filterSettings:filterSettings,sortSettings:sortSettings,groupBySettings:groupBySettings,summarySettings:summarySettings}},destroy:function(){},track:function(event,properties){BB.Tracker.trackStreakActive(this.trackingContext,properties,{eventName:event})}});BB.Modules.PipelineView.SavedViewsEditArea=SavedViewsEditArea})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var defaults={};BB.Modules.PipelineView.SavedViewsEditArea.FilterBar=function(options){var self=this;this.options=options;this.pipeline=options.pipeline;this.containerElement=HTML.get("filterBarContainer",true);this.filterGroupViews=[];this.filterBarContents=this.containerElement.find(".filterBarContents");this.filterGroupList=this.containerElement.find(".filterGroupList");this.filterBarConnectors=this.containerElement.find(".filterBarConnectors");this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/filterBar";this.settings=null;this.joiningOperator=null};BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.create=function(o){var options={};$.extend(options,defaults,o);return new BB.Modules.PipelineView.SavedViewsEditArea.FilterBar(options)};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.prototype,{updateDisplay:function(filterSettings){this.settings=filterSettings||this.settings;this.filterGroupViews.length=0;this.filterGroupList.empty();this.containerElement.removeClass("multipleFilterGroups");this.joiningOperator=this.settings[0];for(var ii=1;ii<this.settings.length;ii++){this.addFilterGroup(this.settings[ii],ii,ii===this.settings.length-1)}this.addConnectors()},addFilterGroup:function(filterStatementGroup,index,isLast){var self=this;var filterGroup=new BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatementGroup({pipeline:this.pipeline,trackingContext:_.clone(this.trackingContext),filters:filterStatementGroup,removeCallback:function(){self.settings.remove(index);if(self.settings.length===1){self.settings.push(["AND"])}self.updateDisplay()},resizeCallback:function(){self.addConnectors()}});this.filterGroupViews.push(filterGroup);this.filterGroupList.append(filterGroup.containerElement)},addConnectors:function(){this.filterBarConnectors.empty();var numGroups=this.filterGroupViews.length;var vertTop=0,vertBottom=0;for(var ii=0;ii<numGroups;ii++){var hrule=$('<div class="streak__connectorHorizontal"></div>');var currentTop=this.filterGroupViews[ii].containerElement.position().top;currentTop+=this.filterGroupViews[ii].containerElement.outerHeight()/2;hrule.css("top",currentTop+"px");this.filterBarConnectors.append(hrule);if(ii===0){vertTop=currentTop}else if(ii===numGroups-1){vertBottom=currentTop}}var verticalBar=$('<div class="streak__connectorVertical"></div>');verticalBar.css("top",vertTop+"px");this.filterBarConnectors.append(verticalBar);if(numGroups>1){this.containerElement.addClass("multipleFilterGroups");var switchButtonContainer=this.addSwitchButtons(vertTop+Math.round((vertBottom-vertTop)/2)-14);switchButtonContainer.css("top",+"px")}this.addPlusButton()},addSwitchButtons:function(top){var self=this;var connector=$('<div class="filterGroupConnector"></div>');var switchButton=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),list:[{name:"All",value:"AND"},{name:"Any",value:"OR"},{name:"None",value:"NONE"}],changeFunc:function(newOp){self.settings[0]=newOp.value;self.updateDisplay()}});switchButton.setSelected(this.joiningOperator);connector.append(switchButton.el);var hrule=$('<div class="streak__connectorHorizontal"></div>');connector.append(hrule);connector.css("top",top);this.filterBarConnectors.append(connector);return connector},addPlusButton:function(){var self=this;var addButton=BB.Widgets.Button.create({iconClassName:"bbPlus",onFunc:function(){self.settings.push(["AND"]);self.updateDisplay()}});addButton.el.css({bottom:"0",position:"absolute",marginRight:"0"});this.filterBarConnectors.append(addButton.el)},getNumberOfFilters:function(){return _(this.settings).chain().flatten().filter(function(filter){return _.isObject(filter)&&(_.isReal(filter.property)||_.isReal(filter.fieldKey))}).value().length},getStatus:function(){return this.settings},destroy:function(){},track:function(event,properties){BB.Tracker.trackStreakActive(this.trackingContext,properties,{eventName:event})}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var trackingContext;var track=function(event,props){BB.Tracker.trackStreakActive(trackingContext,props,{eventName:event})};BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatement=function(options){var self=this;this.column=null;this.columnType=null;this.operation=null;this.value=null;this.specificValue=null;this.pipeline=options.pipeline;this.options=options;this.filter=this.options.filter;if(_.isReal(this.filter)){this.column={};if(_.isReal(this.filter.fieldKey)){this.column.fieldKey=this.filter.fieldKey}else if(_.isReal(this.filter.property)){this.column.property=this.filter.property}this.columnType=this.filter.columnType;this.operation=this.filter.comparisonOperation;this.value=this.filter.value;this.specificValue=this.filter.specificValue}this.trackingContext=options.trackingContext.widgetContext+"/filterStatement";this.containerElement=HTML.get("filterStatement",true);this.columnDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(options.trackingContext),list:getFilterableColumns(this.pipeline),unselectedDisplayText:BB.Locale.getString("filter_choose_column"),maxHeight:300,changeFunc:function(column){self.column=column.value;self.operation=null;self.value=null;self.specificValue=null;self.updateStatement();self.updateDisplay()},comparisonFunction:function(listItemValue,potentialItemValue){return listItemValue.fieldKey===potentialItemValue.fieldKey&&_.isReal(listItemValue.fieldKey)||listItemValue.property===potentialItemValue.property&&_.isReal(listItemValue.property)}});this.containerElement.find(".filterColumnOptions").append(this.columnDropdown.el);this.operationsDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(options.trackingContext),unselectedDisplayText:BB.Locale.getString("filter_choose_operation"),maxHeight:300,changeFunc:function(operation){self.operation=operation.value;self.value=null;self.specificValue=null;self.updateStatement();self.updateDisplay()}});this.containerElement.find(".filterOperationOptions").append(this.operationsDropdown.el);this.valuesDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(options.trackingContext),unselectedDisplayText:BB.Locale.getString("filter_choose_value"),maxHeight:300,changeFunc:function(filterValue){self.value=filterValue.value;self.specificValue=null;self.updateStatement();self.updateDisplay()}});this.containerElement.find(".filterValueOptions").append(this.valuesDropdown.el);this.valuesMultiSelectMenuButton=BB.Widgets.Buttons.ButtonFactory.createMultiSelectMenuButton({type:"GmailArrow",defaultText:BB.Locale.getString("filter_choose_value")});this.valuesMultiSelectMenuButton.addClass("streak__valuesMultiSelect");this.valuesMultiSelectMenuButton.getEventStream().onValue(function(eventWrapper){if(eventWrapper.eventName!=="selectedValuesChanged"){return}self.value=eventWrapper.value;self.updateStatement()});this.containerElement.find(".filterValueOptions").append(this.valuesMultiSelectMenuButton.getElement());this.specificValuePeopleDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(options.trackingContext),unselectedDisplayText:BB.Locale.getString("filter_choose_specific"),maxHeight:300,changeFunc:function(filterValue){self.specificValue=filterValue.value;self.updateStatement()},comparisonFunction:function(listItemValue,potentialSelectedItemValue){if(!_.isReal(potentialSelectedItemValue)||!_.isReal(potentialSelectedItemValue.email)){return false}return listItemValue.email.toLowerCase()===potentialSelectedItemValue.email.toLowerCase()}});this.specificValueInput=$('<input type="text" />');this.specificValueInput[0].oninput=function(){self.updateStatement()};this.specificValueDateInput=$('<input type="text" class="streak__filterDateInput" />');this.specificValueDateInput.pickdate({animationDuration:0,body:Gmail.elements.body,allowEmpty:false,appendTo:this.containerElement.find(".filterValueSpecific"),format:"m/d/Y",onSelect:function(aDate){self.specificValue=aDate.getTime();self.updateStatement()}});this.specificValueDateInput.on("blur",function(e){self.updateStatement()});this.specificValueDateInput.on("focus",function(e){$(this).trigger("onfocus")});this.containerElement.find(".filterValueSpecific").append(this.specificValueInput);this.containerElement.find(".filterValueSpecific").append(this.specificValuePeopleDropdown.el);this.containerElement.find(".filterValueSpecific").append(this.specificValueDateInput);this.removeStatementElement=this.containerElement.find(".filterRemoveStatement");this.removeStatementElement.click(function(e){self.removeStatement()});this.updateDisplay()};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatement.prototype,{updateDisplay:function(){this.resetDropdowns();this.columnType=null;if(this.column.property){this.columnType=BB.Models.Pipeline.getPropertyFilterAndGroupType(this.column.property)}else if(this.column.fieldKey){this.columnType=BB.Models.BoxField.getFilterType(this.pipeline,this.column.fieldKey)}if(_.isNotReal(this.columnType)){this.columnDropdown.deselect()}else{this.columnDropdown.setSelected(this.column);var filterOperations=getFilterOperations(this.columnType,this.operation);if(isInvalidFilterOperation(this.operation,filterOperations)){this.operation=null;this.value=null}this.operationsDropdown.setMenuList(filterOperations);this.operationsDropdown.enable();if(_.isReal(this.operation)){this.operationsDropdown.setSelected(this.operation);if(doesOperationNotSupportValue(this.operation)){this.valuesDropdown.el.hide();this.specificValueInput.hide()}else{if(this.columnType==="TEXT"||this.columnType==="TEXT_INPUT"||this.columnType==="BASIC_TEXT"||this.columnType==="NUMBER"||this.operation==="contains"||this.operation==="notContains"){this.valuesDropdown.el.hide();this.value="__specific";this.specificValueInput.show();this.specificValueInput.val(this.specificValue)}else if(this.operation==="isAny"||this.operation==="isNotAny"||this.operation==="isExactly"){this.valuesDropdown.el.hide();this.valuesMultiSelectMenuButton.getElement().show();this.valuesMultiSelectMenuButton.setItemList(getFilterTextValues(this.columnType,this.operation,this.pipeline,this.column));this.valuesMultiSelectMenuButton.setCurrentlySelectedValues(this.value)}else{this.valuesDropdown.el.show();this.valuesDropdown.enable();var filterValues=getFilterTextValues(this.columnType,this.operation,this.pipeline,this.column);this.valuesDropdown.setMenuList(filterValues);
this.valuesDropdown.setSelected(this.value);if(this.value&&this.value.indexOf("__specific")>-1){switch(this.columnType){case"PERSON":var peopleValues=getSpecificValues(this.column,this.pipeline);this.specificValuePeopleDropdown.el.show();this.specificValuePeopleDropdown.setMenuList(peopleValues);this.specificValuePeopleDropdown.setSelected(this.specificValue);break;case"DATE":if(this.value==="__specific"){this.specificValueDateInput.show();var aDate=Date.create(this.specificValue);if(aDate.isValid()){this.specificValueDateInput.val(aDate.prettyDate(true));this.specificValueDateInput.data("time",aDate.getTime())}else{tthis.specificValueDateInput.val("")}}else{this.specificValueInput.show();this.specificValueInput.val(this.specificValue)}break;default:this.specificValueInput.show();this.specificValueInput.val(this.specificValue);break}}else{this.specificValueInput.hide()}}}}else{this.operationsDropdown.deselect();this.operationsDropdown.el.show();if(doAllOperationsNotSupportValues(filterOperations)){this.valuesDropdown.el.hide();this.specificValueInput.hide()}else{this.specificValueInput.hide();this.valuesDropdown.el.show();this.valuesDropdown.disable()}}}},removeStatement:function(){this.containerElement.remove();if(this.options.removeCallback){this.options.removeCallback()}},resetDropdowns:function(){this.columnDropdown.deselect();this.operationsDropdown.deselect();this.operationsDropdown.disable();this.valuesDropdown.deselect();this.valuesDropdown.el.show();this.valuesDropdown.disable();this.specificValueInput.hide();this.specificValueDateInput.hide();this.specificValuePeopleDropdown.el.hide();this.valuesMultiSelectMenuButton.getElement().hide()},updateStatement:function(){if(_.isReal(this.column)){this.filter.fieldKey=this.column.fieldKey;this.filter.property=this.column.property;this.filter.columnType=this.columnType;this.filter.comparisonOperation=this.operationsDropdown.getSelected().value;if(this.filter.comparisonOperation==="__unselected"){this.filter.comparisonOperation=null}this.filter.value=this.valuesDropdown.getSelected().value;if(this.filter.value==="__unselected"){this.filter.value=null}if(this.specificValueInput.isVisible()){this.filter.specificValue=this.specificValueInput.val()}else if(this.specificValueDateInput.isVisible()){var aDate=Date.ccreate(this.specificValueDateInput.val());if(aDate.isValid()){this.filter.specificValue=aDate.getTime()}else{this.filter.specificValue=null}}else if(this.specificValuePeopleDropdown.el.isVisible()){this.filter.specificValue=this.specificValuePeopleDropdown.getSelected().value}else if(this.valuesMultiSelectMenuButton.getElement().isVisible()){this.filter.value=this.valuesMultiSelectMenuButton.getCurrentlySelectedValues()}else{this.filter.specificValue=null}}else{this.filter.property=null;this.filter.fieldKey=null}}});function getFilterableColumns(pipeline){var returnColumns;var fieldColumns=_.map(pipeline.getFields(),function(field){return{name:field.displayName(),value:{fieldKey:field.key()}}});var filterableColumns=BB.Models.Pipeline.getFilterableSystemProperties();var activeSystemColumns=pipeline.getActiveSystemColumns();filterableColumns=_.differencePlus(filterableColumns,activeSystemColumns,function(c1,c2){return c1.property===c2.property});activeSystemColumns=_.map(activeSystemColumns,function(systemColumn){return{name:systemColumn.title,value:{property:systemColumn.property}}});filterableColumns=_.map(filterableColumns,function(systemColumn){return{name:systemColumn.title,value:{property:systemColumn.property}}});returnColumns=_.sortBy(fieldColumns.concat(activeSystemColumns),function(column){return column.name});returnColumns.push("__separator");returnColumns=returnColumns.concat(_.sortBy(filterableColumns,function(column){return column.name}));return returnColumns}function getFilterOperations(columnType,currentOperation){return BB.Models.BoxField.getFilterOperations(columnType,currentOperation)}function isInvalidFilterOperation(operationValue,operations){if(_.isNotReal(operationValue)){return true}return!_.any(operations,function(operation){return operation.value===operationValue})}function getFilterTextValues(columnType,currentOperation,pipeline,column){if(_.isReal(column.property)&&column.property==="assignedToSharingEntries"){return BB.Models.BoxField.getAssignedToFilterTextValues(pipeline)}else if(_.isReal(column.property&&column.property==="stageKey")||_.isReal(column.fieldKey)){return BB.Models.BoxField.getFilterTextValues(columnType,currentOperation,pipeline,column.fieldKey)}}function getSpecificValues(column,pipeline){if(_.isReal(column.property)&&column.property==="assignedToSharingEntries"){return pipeline.getAllAssignedToValues()}else if(_.isReal(column.fieldKey)){return BB.UI.getFieldValues(pipeline,column.fieldKey)}}function doAllOperationsNotSupportValues(operations){for(var ii=0;ii<operations.length;ii++){if(!doesOperationNotSupportValue(operations[ii].value)){return false}}return true}function doesOperationNotSupportValue(operation){return operation==="isSet"||operation==="notSet"||operation==="isChecked"||operation==="isUnchecked"}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatementGroup=function(options){var self=this;this.options=options;this.pipeline=this.options.pipeline;this.filterStatementObjects=[];this.filterStatementViews=[];this.joiningOperator=null;this.filters=this.options.filters;this.joiningOperator=this.filters[0];this.trackingContext=options.trackingContext.widgetContext+"/filterStatementGroup";this.containerElement=HTML.get("filterGroup",true);this.statementListContainer=this.containerElement.find(".filterGroupStatementList");this.connectorsArea=this.containerElement.find(".filterGroupConnectors");this.containerElement.find(".filterRemoveGroup").on("click",function(e){if(options.removeCallback){options.removeCallback()}});this.updateDisplay()};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatementGroup.prototype,{updateDisplay:function(){var self=this;this.statementListContainer.empty();this.connectorsArea.empty();this.filterStatementViews.length=0;this.joiningOperator=this.filters[0];if(this.filters.length>1){for(var ii=1;ii<this.filters.length;ii++){this.addStatement(this.filters[ii],ii)}}else{var emptyFilterObject={};this.filters.push(emptyFilterObject);this.addStatement(emptyFilterObject,0,true)}this.addConnectors()},addStatement:function(filterStatementObject,index,isLast){var self=this;var statementView=new BB.Modules.PipelineView.SavedViewsEditArea.FilterBar.FilterStatement({trackingContext:_.clone(this.trackingContext),pipeline:this.pipeline,filter:filterStatementObject,removeCallback:function(){self.removeStatement(index)}});this.statementListContainer.append(statementView.containerElement)},removeStatement:function(index){this.filters.remove(index);if(this.filters.length===1){if(this.options.removeCallback){this.options.removeCallback()}}else{this.updateDisplay();if(this.options.resizeCallback){this.options.resizeCallback()}}},addConnectors:function(){var numFilters=this.filters.length-1;if(numFilters>1){this.containerElement.addClass("multipleFilterStatements");for(var ii=0;ii<numFilters;ii++){this.connectorsArea.append('<div class="filterConnectorHorizontal"></div>')}this.connectorsArea.append('<div class="filterConnectorVertical"></div>');this.addSwitchButtons()}else{this.containerElement.removeClass("multipleFilterStatements")}this.addPlusButton(numFilters>1)},addSwitchButtons:function(){var self=this;var connector=$('<div class="filterGroupStatementConnector"></div>');var switchButton=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),list:[{name:"All",value:"AND"},{name:"Any",value:"OR"},{name:"None",value:"NONE"}],changeFunc:function(newOp){self.filters[0]=newOp.value;self.updateDisplay()}});connector.append(switchButton.el);switchButton.setSelected(this.joiningOperator);this.connectorsArea.append(connector)},addPlusButton:function(hasMultipleStatements){var self=this;var addButton=BB.Widgets.Button.create({iconClassName:"bbPlus",onFunc:function(){self.filters.push({});self.updateDisplay();if(self.options.resizeCallback){self.options.resizeCallback()}}});addButton.el.css({paddingLeft:"3px",paddingRight:"3px",position:"absolute",left:"17px",bottom:hasMultipleStatements?"-30px":"0"});this.connectorsArea.append(addButton.el)},getFilterGroupState:function(){var returnArray=[this.joiningOperator];for(var ii=0;ii<this.filterStatementViews.length;ii++){var statement=this.filterStatementViews[ii].getStatement();if(_.isReal(statement)){returnArray.push(statement)}}return returnArray},track:function(event,props){BB.Tracker.trackStreakActive(this.trackingContext,props,{eventName:event})}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var initialized=false;var defaults={};var templates={};function init(){if(!initialized){templates.container='<div class="groupByBarContainer"><span class="streak__statementConnectorText">'+BB.Locale.getString("saved_views_group_by_connector")+"</span></div>";initialized=true}}BB.Modules.PipelineView.SavedViewsEditArea.GroupByBar=function(options){init();var self=this;this.options=options;this.pipeline=options.pipeline;this.column;this.granularity;this.containerElement=$(templates.container);this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/groupByBar";this.columnDropdown=null;this.dateGranularityDropdown=null;this.dateGroupByExplanation=null};BB.Modules.PipelineView.SavedViewsEditArea.GroupByBar.create=function(o){var options={};$.extend(options,defaults,o);return new BB.Modules.PipelineView.SavedViewsEditArea.GroupByBar(options)};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.GroupByBar.prototype,{updateDisplay:function(columnKey,granularity){this.createDropdowns();this.columnDropdown.setSelected({columnKey:columnKey});this.column=this.columnDropdown.getSelected().value;this.granularity=granularity;this.updateGroupByBar()},updateGroupByBar:function(){var columnType;if(this.column.property){columnType=BB.Models.Pipeline.getPropertyFilterAndGroupType(this.column.property)}else if(this.column.fieldKey){columnType=this.pipeline.getField(this.column.fieldKey).get("type")}if(columnType!=="DATE"){this.dateGranularityDropdown.el.hide();this.dateGroupByExplanation.hide();this.granularity=null}else{this.dateGroupByExplanation.show();this.dateGranularityDropdown.el.show();this.granularity=this.granularity||"DAY";this.dateGranularityDropdown.setSelected(this.granularity)}},getStatus:function(){return{data:this.column.columnKey,granularity:this.granularity}},createDropdowns:function(){if(this.columnDropdown){return}var self=this;this.columnDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),unselectedDisplayText:BB.Locale.getString("filter_choose_column"),list:_getGroupableColumns(this.pipeline),maxHeight:300,changeFunc:function(columnListItem){self.column=columnListItem.value;self.updateGroupByBar()},comparisonFunction:function(listItemValue,potentialItemValue){if(!listItemValue||!potentialItemValue){return false}return listItemValue.columnKey===potentialItemValue.columnKey}});this.containerElement.append(this.columnDropdown.el);this.dateGroupByExplanation=$("<span>"+BB.Locale.getString("group_by_bar_date_explanation")+"</span>");this.containerElement.append(this.dateGroupByExplanation);this.dateGranularityDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),unselectedDisplayText:BB.Locale.getString("group_by_date_granularity"),maxHeight:300,list:_getDateGranularityList(),changeFunc:function(granularityListItem){self.granularity=granularityListItem.value},comparisonFunction:function(listItemValue,potentialItemValue){if(!listItemValue&&!potentialItemValue){return true}return listItemValue===potentialItemValue}});this.containerElement.append(this.dateGranularityDropdown.el)},destroy:function(){this.columnDropdown.destroy();this.dateGranularityDropdown.destroy()}});function _getGroupableColumns(pipeline){var returnColumns;var fieldColumns=_.map(pipeline.getFields(),function(field){return{name:field.displayName()||" ",columnType:"field",value:{fieldKey:field.key(),columnKey:"field|"+field.key()}}});var groupableSystemProperties=BB.Models.Pipeline.getGroupableSystemProperties();var activeSystemColumns=pipeline.getActiveSystemColumns();groupableSystemProperties=_.differencePlus(groupableSystemProperties,activeSystemColumns,function(c1,c2){return c1.property===c2.property});activeSystemColumns=_.map(activeSystemColumns,function(systemColumn){return{name:systemColumn.title,value:{property:systemColumn.property,columnKey:"property|"+(systemColumn.uniqueKey||systemColumn.property)}}});groupableSystemProperties=_.map(groupableSystemProperties,function(systemColumn){return{name:systemColumn.title,value:{property:systemColumn.property,columnKey:"property|"+(systemColumn.uniqueKey||systemColumn.property)}}});returnColumns=_.sortBy(fieldColumns.concat(activeSystemColumns),function(column){return column.name});returnColumns.push("__separator");returnColumns=returnColumns.concat(_.sortBy(groupableSystemProperties,function(column){return column.name}));return returnColumns}function _getDateGranularityList(){return[{name:BB.Locale.getString("day"),value:"DAY"},{name:BB.Locale.getString("week"),value:"WEEK"},{name:BB.Locale.getString("month"),value:"MONTH"},{name:BB.Locale.getString("quarter"),value:"QUARTER"},{name:BB.Locale.getString("year"),value:"YEAR"}]}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var initialized=false;var defaults={};var templates={};function init(){if(!initialized){templates.container=HTML.get("sortByBarContainer")();initialized=true}}BB.Modules.PipelineView.SavedViewsEditArea.SortByBar=function(options){init();var self=this;this.options=options;this.pipeline=options.pipeline;this.containerElement=$(templates.container);this.connectorsContainerElement=this.containerElement.find(".sortByBarConnectors");this.statementListContainerElement=this.containerElement.find(".sortByStatementList");this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/sortByBar";this.sortStatements=[]};BB.Modules.PipelineView.SavedViewsEditArea.SortByBar.create=function(o){var options={};$.extend(options,defaults,o);return new BB.Modules.PipelineView.SavedViewsEditArea.SortByBar(options)};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.SortByBar.prototype,{updateDisplay:function(sortedColumns){this.sortStatements.length=0;this.statementListContainerElement.empty();if(sortedColumns.length>0){for(var ii=0;ii<sortedColumns.length;ii++){this.addSortStatement(sortedColumns[ii])}}else{this.addSortStatement({property:"creationTimestamp",sort:"ASC"})}this.addConnectors()},addSortStatement:function(sortedColumn){var self=this;var sortStatement=BB.Modules.PipelineView.SavedViewsEditArea.SortByStatement.create({pipeline:this.pipeline,trackingContext:_.clone(this.trackingContext),removeCallback:function(){self.sortStatements.removeVal(sortStatement);if(self.sortStatements.length===0){self.updateDisplay([])}else{self.addConnectors()}}});sortStatement.updateDisplay(sortedColumn);this.sortStatements.push(sortStatement);this.statementListContainerElement.append(sortStatement.containerElement)},addConnectors:function(){this.connectorsContainerElement.empty();var vertTop=0,vertBottom=0;var numGroups=this.sortStatements.length;for(var ii=0;ii<numGroups;ii++){var hrule=$('<div class="streak__connectorHorizontal"></div>');var currentTop=this.sortStatements[ii].containerElement.position().top;currentTop+=this.sortStatements[ii].containerElement.outerHeight()/2;hrule.css("top",currentTop+"px");this.connectorsContainerElement.append(hrule);if(ii===0){vertTop=currentTop}else if(ii===numGroups-1){vertBottom=currentTop}this.sortStatements[ii].setIndex(ii)}var verticalBar=$('<div class="streak__connectorVertical"></div>');verticalBar.css("top",vertTop+"px");this.connectorsContainerElement.append(verticalBar);this.addPlusButton()},addPlusButton:function(){var self=this;var addButton=BB.Widgets.Button.create({iconClassName:"bbPlus",onFunc:function(){self.addSortStatement({property:"creationTimestamp",sort:"ASC"});self.addConnectors()}});addButton.el.css({bottom:"0",position:"absolute",marginRight:"0"});this.connectorsContainerElement.append(addButton.el)},getStatus:function(){return _(this.sortStatements).chain().map(function(statement){return statement.getStatus()}).filter(function(sortObject){return _.isReal(sortObject.columnKey)&&_.isReal(sortObject.sort)}).value()},destroy:function(){}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var initialized=false;var defaults={};var templates={};function init(){if(!initialized){templates.container='<div class="savedViewsSortByStatement"><span class="streak__removeElement"></span></div>';initialized=true}}BB.Modules.PipelineView.SavedViewsEditArea.SortByStatement=function(options){init();var self=this;this.options=options;this.pipeline=options.pipeline;this.containerElement=$(templates.container);this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/sortByStatement";this.columnDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),unselectedDisplayText:BB.Locale.getString("filter_choose_column"),maxHeight:300,changeFunc:function(listItem){self.directionDropdown.setMenuList(self.getSortDirectionList(listItem.value));self.directionDropdown.setSelected("ASC")},comparisonFunction:function(listItemValue,potentialItemValue){return listItemValue.columnKey===potentialItemValue.columnKey}});this.directionDropdown=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this.trackingContext),changeFunc:function(sortDirection){}});this.containerElement.find(".streak__removeElement").on("click",function(e){self.containerElement.remove();options.removeCallback()});this.connectorText=$('<span class="streak__statementConnectorText"></span>');this.containerElement.prepend(this.directionDropdown.el);this.containerElement.prepend(this.columnDropdown.el);this.containerElement.prepend(this.connectorText)};BB.Modules.PipelineView.SavedViewsEditArea.SortByStatement.create=function(o){var options={};$.extend(options,defaults,o);return new BB.Modules.PipelineView.SavedViewsEditArea.SortByStatement(options)};_.extend(BB.Modules.PipelineView.SavedViewsEditArea.SortByStatement.prototype,{updateDisplay:function(column){this.columnDropdown.setMenuList(BB.UI.getPipelineColumnList(this.pipeline,this.pipeline.getAllSystemColumns()));this.columnDropdown.setSelected(column);this.directionDropdown.setMenuList(this.getSortDirectionList(column));this.directionDropdown.setSelected(column.sort)},getSortDirectionList:function(column){var columnType;if(!column.fieldKey&&!column.property){var columnKeyParts=column.columnKey.split("|");var type=columnKeyParts[0];if(type==="property"){column.property=columnKeyParts[1]}else if(type==="fieldKey"){column.fieldKey=columnKeyParts[1]}}if(column.property){columnType=BB.Models.Pipeline.getPropertySortType(column.property)}else if(column.fieldKey){columnType=this.pipeline.getField(column.fieldKey).get("type")}var sortTextKey="sort_";switch(columnType){case"NUMBER":sortTextKey="sort_number_";break;case"DATE":sortTextKey="sort_date_";break}_sortDirections[0].name=BB.Locale.getString(sortTextKey+"asc");_sortDirections[1].name=BB.Locale.getString(sortTextKey+"desc");return _sortDirections},setIndex:function(index){if(index===0){this.connectorText[0].innerHTML=BB.Locale.getString("saved_views_sortby_first_connector")}else{this.connectorText[0].innerHTML=BB.Locale.getString("saved_views_sortby_connector")}},getStatus:function(){return{columnKey:this.columnDropdown.getSelected().value.columnKey,sort:this.directionDropdown.getSelected().value}}});var _sortDirections=[{name:null,value:"ASC"},{name:null,value:"DESC"}]})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Eventer=Streak.Eventer,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox,FilterSettings=BB.Modules.PipelineView.ViewSettings.FilterSettings,SortSettings=BB.Modules.PipelineView.ViewSettings.SortSettings,GroupBySettings=BB.Modules.PipelineView.ViewSettings.GroupSettings.GroupBySettings,PipelineSummarySettings=BB.Modules.PipelineView.ViewSettings.PipelineSummarySettings;var defaults={pipeline:null};var _lastPipelineViewKey={};var currentSavedViewController;SavedViewsController=function(options){Eventer.call(this);this.pipeline=options.pipeline;this.uiSettingsTriggerEnabled=true;this.viewSettings={filterSettings:null,sortSettings:null,groupBySettings:null,summarySettings:null};this.activeView=null;this.setupBindings();this.parseView()};SavedViewsController.create=function(options){var o=_.extend({},defaults,options);return new SavedViewsController(o)};SavedViewsController.prototype=Streak.Eventer.prototype;_.extend(SavedViewsController.prototype,{setupBindings:function(){var self=this;this.pipeline.watch("set",function(){if(self.uiSettingsTriggerEnabled){self.trigger("transformSettingsChanged")}},this,"uiSettings")},disableTriggerOnUISettingsSet:function(){this.uiSettingsTriggerEnabled=false},enableTriggerOnUISettingsSet:function(){this.uiSettingsTriggerEnabled=true},isASavedViewActive:function(){return _.isReal(this.activeView)&&!this.activeView.isUnsaved},getCurrentSettingsState:function(){var ii=0,jj=0;var filterSettings=this.viewSettings.filterSettings;var sortSettings=this.viewSettings.sortSettings;var groupBySettings=this.viewSettings.groupBySettings;var summarySettings=this.viewSettings.summarySettings;if(this.activeView&&this.activeView.viewKey){this.activeView=this.pipeline.getSavedView(this.activeView.viewKey)}var settingState={uniqueFilteredColumns:0,numberOfFilterGroups:0,numberOfFilterStatements:0,listOfSortedColumns:[],groupBySetting:null,groupByGranularity:null,isASavedViewActive:this.isASavedViewActive(),activeView:this.activeView,isInHeadsUp:false,isDefaultSettingsActive:true};var foundColumns=[];for(ii=1;ii<filterSettings.filters.length;ii++){settingState.numberOfFilterGroups+=1;var filterArray=filterSettings.filters[ii];for(jj=1;jj<filterArray.length;jj++){if(_.isReal(filterArray[jj].comparisonOperation)){settingState.numberOfFilterStatements+=1;if(_.isReal(filterArray[jj].property)){foundColumns.push(filterArray[jj].property)}else if(_.isReal(filterArray[jj].fieldKey)){foundColumns.push(filterArray[jj].fieldKey)}}}}settingState.uniqueFilteredColumns=_.unique(foundColumns).length;settingState.filterSettings=filterSettings;settingState.groupBySetting=groupBySettings.data;settingState.groupByGranularity=groupBySettings.granularity;settingState.listOfSortedColumns=sortSettings.data;if(summarySettings){settingState.summarySettings=summarySettings.data}if(settingState.isASavedViewActive){settingState.isInHeadsUp=this._isSavedViewInHeadsUp(settingState.activeView.viewKey)}settingState.isDefaultSettingsActive=settingState.uniqueFilteredColumns===0&&settingState.listOfSortedColumns.length===0&&settingState.groupBySetting==="property|stageKey"&&settingState.summarySettings.columnKey==="property|name"&&settingState.summarySettings.summaryFunction==="count"&&settingState.isASavedViewActive===false;return settingState},clearView:function(){if(this.activeView&&this.activeView.isUnsaved){this.pipeline.clearUnsavedView()}BB.UI.setURL(this.pipeline.link()+"?clear")},setToDefaultView:function(){this.viewSettings.filterSettings=FilterSettings.create(this.pipeline);this.viewSettings.sortSettings=SortSettings.create(this.pipeline);this.viewSettings.groupBySettings=GroupBySettings.create(this.pipeline);this.viewSettings.summarySettings=PipelineSummarySettings.create(this.pipeline);if(!this.activeView){return}this.activeView=null;this.trigger("transformSettingsChanged")},addCurrentSettingsToSavedViews:function(viewName){var savedView=this.pipeline.addSavedView(viewName,this.viewSettings);this.pipeline.clearUnsavedView();BB.UI.setURL(this.pipeline.link()+"?"+savedView.viewKey)},saveSettingsAsView:function(viewName,settings){var savedView=this.pipeline.addSavedView(viewName,settings);BB.UI.setURL(this.pipeline.link()+"?"+savedView.viewKey)},getCreatedSavedViews:function(){return this.pipeline.getSavedViews()},getSystemSavedViews:function(){},activateSavedView:function(viewKey){var savedView=this.pipeline.getSavedView(viewKey);BB.UI.setURL(this.pipeline.link()+"?"+savedView.viewKey)},updateSavedView:function(viewObject){this.pipeline.updateSavedView(viewObject);if(this.activeView&&this.activeView.viewKey===viewObject.viewKey){this.activeView=viewObject}this.trigger("changed")},updateActiveViewWithNewSettings:function(newSettings){if(this.activeView){this.activeView.settings=newSettings;this.pipeline.updateSavedView(this.activeView);this.viewSettings.filterSettings=this.activeView.settings.filterSettings;this.viewSettings.groupBySettings=this.activeView.settings.groupBySettings;this.viewSettings.sortSettings=this.activeView.settings.sortSettings;this.viewSettings.summarySettings=this.activeView.settings.summarySettings;this.trigger("transformSettingsChanged")}},deleteSavedView:function(savedViewKey){var savedViews=this.getCreatedSavedViews();var newSavedViews=_.filter(savedViews,function(savedView){return savedView.viewKey!==savedViewKey});this.removeFromHeadsUp(savedViewKey);this._save(newSavedViews);if(_.isReal(this.activeView)){if(this.activeView.viewKey===savedViewKey){BB.UI.setURL(this.pipeline.link()+"?clear")}}},applyViewSettings:function(settings){this.viewSettings.filterSettings=settings.filterSettings;this.viewSettings.groupBySettings=settings.groupBySettings;this.viewSettings.sortSettings=settings.sortSettings;this.viewSettings.summarySettings=settings.summarySettings;this.updateUnsavedView();this.trigger("changed");this.trigger("transformSettingsChanged")},setFilterSettings:function(settings){this.viewSettings.filterSettings=settings;this.updateUnsavedView();this.trigger("transformSettingsChanged")},getFilterSettings:function(){return this.viewSettings.filterSettings},setSortSettings:function(settings){this.viewSettings.sortSettings=settings;this.updateUnsavedView();this.trigger("transformSettingsChanged")},getSortSettings:function(){return this.viewSettings.sortSettings},setGroupBySettings:function(settings){this.viewSettings.groupBySettings=settings;this.updateUnsavedView();this.trigger("transformSettingsChanged")},getGroupBySettings:function(){return this.viewSettings.groupBySettings},setSummarySettings:function(settings){this.viewSettings.summarySettings=settings;this.updateUnsavedView();this.trigger("transformSettingsChanged")},getSummarySettings:function(){return this.viewSettings.summarySettings},updateUnsavedView:function(){if(!this.activeView){var unsavedView=this.pipeline.setUnsavedView(JSON.deepClone(this.viewSettings));BB.UI.setURL(this.pipeline.link()+"?"+unsavedView.viewKey)}else if(this.activeView.isUnsaved){this.activeView.settings=JSON.deepClone(this.viewSettings);this.pipeline.updateSavedView(this.activeView)}},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this})},parseView:function(){if(Gmail.hash.query){if(Gmail.hash.query==="clear"){this.setToDefaultView()}else{var savedView=this.pipeline.getSavedView(Gmail.hash.query);if(savedView){this.setViewSettings(Gmail.hash.query)}else{_lastPipelineViewKey[this.pipeline.key()]=null;this.setToDefaultView();BB.UI.setURL(this.pipeline.link())}}}else{if(_lastPipelineViewKey[this.pipeline.key()]){this.setViewSettings(_lastPipelineViewKey[this.pipeline.key()]);BB.UI.setURL(this.pipeline.link()+"?"+_lastPipelineViewKey[this.pipeline.key()])}else{this.setToDefaultView()}}},setViewSettings:function(viewKey){var savedView=this.pipeline.getSavedView(viewKey);if(!_.isReal(savedView)){return}this.viewSettings.filterSettings=savedView.settings.filterSettings;this.viewSettings.groupBySettings=savedView.settings.groupBySettings;this.viewSettings.sortSettings=savedView.settings.sortSettings;this.viewSettings.summarySettings=savedView.settings.summarySettings;this.activeView=savedView;this.trigger("transformSettingsChanged");_lastPipelineViewKey[this.pipeline.key()]=this.activeView.viewKey},removeFromHeadsUp:function(viewKey){if(this._isSavedViewInHeadsUp(viewKey)){BB.Modules.HeadsUp.removeSection(viewKey)}},_isSavedViewInHeadsUp:function(viewKey){return SavedViewsController.externalIsInHeadsUp(viewKey)},_save:function(savedViews){this.pipeline.setUISettings("savedViews/list",savedViews)}});SavedViewsController.externalIsInHeadsUp=function(viewKey){var headsUpSections=BB.getUser().getHeadsUpSections();for(var ii=0;ii<headsUpSections.length;ii++){if(headsUpSections[ii].viewKey===viewKey){return true}}return false};SavedViewsController.externalDeleteSavedView=function(pipeline,savedView){var savedViews=pipeline.getSavedViews();var savedViewKey=savedView.viewKey;var newSavedViews=_.filter(savedViews,function(savedView){return savedView.viewKey!==savedViewKey});BB.Modules.HeadsUp.removeSection(savedViewKey);pipeline.setUISettings("savedViews/list",newSavedViews);pipeline.postNotification("savedViewsChanged")};BB.Modules.PipelineView.SavedViewsController=SavedViewsController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,Date=Streak.Date,BB=Streak.BentoBox;var defaults={savedViewsController:null};var SavedViewsButton=function(options){this.savedViewsController=options.savedViewsController;this.createButton();this.updateMenu();this.savedViewsController.bind("changed",this.updateMenu.bind(this));this.savedViewsController.bind("transformSettingsChanged",this.updateMenu.bind(this))};SavedViewsButton.create=function(o){var options={};$.extend(options,this.defaults,o);return new SavedViewsButton(options)};_.extend(SavedViewsButton.prototype,{createButton:function(){this.menu=BB.Widgets.Menu.create();this.menu.getElement().addClass("streak__savedViewsButtonMenu_menu");var self=this;this.buttonMenu=BB.Widgets.Buttons.ButtonFactory.createSplitMenuButton({type:"GmailSplitArrow",text:BB.Locale.getString("filter_sort_group"),menu:this.menu,menuClickTriggersOff:true,isFixedPosition:true,isRightAligned:true,onFunction:function(){BB.Tracker.track("toggleSavedViewsEditArea",{source:"savedViewsButton"});self.savedViewsController.trigger("toggleSavedViewsEditArea")}});this.buttonMenu.addClass("streak__savedViewsButtonMenu")},updateMenu:function(){var self=this;this.menu.empty();var currentState=self.savedViewsController.getCurrentSettingsState();var savedViews=_.sortBy(this.savedViewsController.getCreatedSavedViews(),"name");if(savedViews.length>0){this.buttonMenu.enableMenu();_.each(savedViews,function(savedView){self.menu.addCheckItem(savedView.name,function(){BB.Tracker.track("activateSavedView");self.savedViewsController.activateSavedView(savedView.viewKey)},currentState.isASavedViewActive&&currentState.activeView.viewKey===savedView.viewKey)})}else{this.buttonMenu.disableMenu()}},getElement:function(){return this.buttonMenu.getElement()}});BB.Modules.PipelineView.SavedViewsButton=SavedViewsButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var initialized=false;var templates={};var defaults={pipeline:null,savedViewsController:null};function init(){if(!initialized){templates.container=HTML.get("statusBarContainer")();initialized=true}}var SavedViewsStatusBar=function(options){init();var self=this;this.savedViewsController=options.savedViewsController;this.pipeline=options.pipeline;this.trackingContext=options.trackingContext;this.trackingContext.widgetContext+="/savedViewsStatusBar";
this.containerElement=$(templates.container);this.messageElement=this.containerElement.find(".streak__statusBarMessage");this.linksElement=this.containerElement.find(".streak__statusBarLinks");this.viewLinks=this.containerElement.find(".streak__statusBarViewLinks");this.nonViewLinks=this.containerElement.find(".streak__statusBarNonViewLinks");this.toggleChevron=this.containerElement.find(".toggleChevron");this.savedViewsEditArea=options.savedViewsEditArea;this.unbinders=[];this.initFunctionality()};SavedViewsStatusBar.create=function(o){var options={};$.extend(options,defaults,o);return new SavedViewsStatusBar(options)};_.extend(SavedViewsStatusBar.prototype,{updateDisplay:function(){var currentState=this.savedViewsController.getCurrentSettingsState();var shouldShowBar=!currentState.isDefaultSettingsActive;if(shouldShowBar){this.containerElement.show();if(currentState.isASavedViewActive){this.renderActiveViewMessage(currentState)}else{this.renderSettingsMessage(currentState)}this.updateOpenStatus()}else{this.containerElement.hide()}this.currentState=currentState},initFunctionality:function(){var self=this;this.containerElement.on("click",function(e){self.track("toggleSavedViewsEditArea");self.savedViewsController.trigger("toggleSavedViewsEditArea")});this.containerElement.find(".streak__statusBarClearLink").on("click",function(e){self.savedViewsController.clearView();self.track("statusBarClear");self.savedViewsController.trigger("closeSavedViewsEditArea");e.stopPropagation()});this.containerElement.find(".streak__statusBarAdvancedFilters").on("click",function(e){self.savedViewsController.trigger("toggleSavedViewsEditArea");self.track("toggleFiltersArea");e.stopPropagation()});this.containerElement.find(".streak__statusBarMakeView").on("click",function(e){self.track("createSavedViewAttempt");BB.Widgets.Modal.textboxModal({title:BB.Locale.getString("saved_view_create_modal_title"),placeholderText:BB.Locale.getString("Set the name of the new view"),callback:function(name){self.track("createSavedViewSuccess");self.savedViewsController.addCurrentSettingsToSavedViews(name)}});e.stopPropagation()});this.inboxCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("saved_view_add_to_inbox"));this.viewLinks.append(this.inboxCheckbox);this.inboxCheckbox.on("change",function(e){if(self.inboxCheckbox.isChecked()){self.track("addSavedViewToInbox");BB.Modules.HeadsUp.addSection(self.currentState.activeView.viewKey,self.pipeline.key())}else{self.track("removeSavedViewFromInbox");self.savedViewsController.removeFromHeadsUp(self.currentState.activeView.viewKey)}});this.unbinders.push(this.savedViewsController.bind("transformSettingsChanged",this.updateDisplay.bind(this)));this.unbinders.push(this.savedViewsController.bind("changed",this.updateDisplay.bind(this)));this.unbinders.push(this.savedViewsController.bind("savedViewsEditAreaChanged",this.updateOpenStatus.bind(this)))},renderActiveViewMessage:function(currentState){this.viewLinks.show();this.nonViewLinks.hide();this.inboxCheckbox.setChecked(currentState.isInHeadsUp);this.messageElement.html(this.getSettingsMessageHTML(currentState));this.containerElement.addClass("streak__savedViewActive")},renderSettingsMessage:function(currentState){this.viewLinks.hide();this.nonViewLinks.show();this.messageElement.html(this.getSettingsMessageHTML(currentState));this.containerElement.removeClass("streak__savedViewActive")},updateOpenStatus:function(){if(this.savedViewsEditArea.isAreaOpen()){this.toggleChevron.removeClass("downChevron")}else{this.toggleChevron.addClass("downChevron")}},getSettingsMessageHTML:function(currentState){var viewName=BB.Locale.getString("unsaved_view");if(currentState.activeView){viewName=currentState.activeView.name}var messageHTML="<b>"+_.escape(viewName)+"</b> - ";var messageParts=[];if(currentState.uniqueFilteredColumns>0){messageParts.push(BB.Locale.getString("status_view_filter_message",{number:currentState.uniqueFilteredColumns,pluralize:[currentState.uniqueFilteredColumns]}))}if(currentState.listOfSortedColumns.length>0){messageParts.push(BB.Locale.getString("status_view_sort_message",{number:currentState.listOfSortedColumns.length,pluralize:[currentState.listOfSortedColumns.length]}))}if(_.isReal(currentState.groupBySetting)){if(currentState.groupBySetting.indexOf("field|")===-1&&currentState.groupBySetting!=="property|stageKey"){var column=this.pipeline.getSystemColumn(currentState.groupBySetting.split("|")[1]);if(!column){column=BB.Models.Pipeline.getSystemProperty(currentState.groupBySetting.split("|")[1])}messageParts.push(BB.Locale.getString("status_view_group_message",{column:column.title}))}if(currentState.groupBySetting.indexOf("field|")>-1){messageParts.push(BB.Locale.getString("status_view_group_message",{column:this.pipeline.getField(currentState.groupBySetting.split("|")[1]).displayNameText()}))}}if(_.isReal(currentState.summarySettings)&&(currentState.summarySettings.columnKey!=="property|name"||currentState.summarySettings.summaryFunction!=="count")){var columnName;if(currentState.summarySettings.columnKey.indexOf("field|")===0){columnName=this.pipeline.getField(currentState.summarySettings.columnKey.split("|")[1]).displayNameText()}else{columnName=this.pipeline.getSystemColumn(currentState.summarySettings.columnKey.split("|")[1]).title}messageParts.push(BB.Locale.getString("status_view_summary_message",{column:columnName,"function":BB.ColumnSummary.getLocalizedName(currentState.summarySettings.summaryFunction)}))}return messageHTML+_.escape(messageParts.join(", "))},track:function(event,properties){BB.Tracker.trackStreakActive(this.trackingContext,properties,{eventName:event})},destroy:function(){for(var ii=0;ii<this.unbinders.length;ii++){this.unbinders[ii]()}}});BB.Modules.PipelineView.SavedViewsStatusBar=SavedViewsStatusBar})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ShareButton={defaults:{pipeline:null,color:"blue",isButton:true,isDark:false,iconAfter:false},init:function(cb){var self=this;this.templates={};this.templates.button=HTML.get("shareButtonButton");if(cb){cb()}},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};ShareButton.impl=function(o){var options=o;var pipeline=options.pipeline;var acl=[];var unbindFunctions=[];var pipelineSharingSettingsModalViewController;var updateStatus=function(){var acl=_.clone(pipeline.get("aclEntries"));var orgWide=pipeline.get("orgWide");var isPrivate=!orgWide&&(!acl||_.filter(acl,function(person){return!person.isOwner}).length===0);b.el.find(".bbSharedIcon").hide();if(isPrivate){b.el.find(".bbSharedPrivate").show()}else{if(orgWide){b.el.find(".bbSharedGroup").show()}else{b.el.find(".bbSharedPeople").show()}}};var buttonOptions={isToggle:false,onFunc:function(){if(pipelineSharingSettingsModalViewController){pipelineSharingSettingsModalViewController.destroy()}pipelineSharingSettingsModalViewController=new BB.Services.PipelineSharingSettings.PipelineSharingSettingsModalViewController(pipeline);pipelineSharingSettingsModalViewController.show()}};if(options.isButton){buttonOptions.name=ShareButton.templates.button();buttonOptions.color=options.color}else{var buttonDiv=document.createElement("div");buttonDiv.innerHTML=ShareButton.templates.button();if(options.isDark){buttonDiv.setAttribute("class","dark")}buttonOptions.customButton=buttonDiv}var b=BB.Widgets.Button.create(buttonOptions);if(options.iconAfter){var span=b.el.find("span").detach();b.el.prepend(span)}b.setPipeline=function(newPipeline){options.pipeline=newPipeline;pipeline=newPipeline;updateStatus()};if(pipeline){pipeline.watch("set",function(){updateStatus()},b,"orgWide");pipeline.watch("set",function(){updateStatus()},b,"aclEntries");updateStatus()}b.getElement().addClass("streak__shareButton");var oldDestroy=b.destroy;b.destroy=function(){Streak.NotificationCenter.unsubscribe({observer:b});if(pipelineSharingSettingsModalViewController){pipelineSharingSettingsModalViewController.destroy()}oldDestroy()};return b};Streak.DependencyManager.addFunction({functionKey:"pipelineView.shareButtonInitialized",functionToCall:ShareButton.init,functionContext:ShareButton,dependentFunctionKeys:["htmlLoaded","pipelineViewInitialized"]});BB.Modules.PipelineView.ShareButton=ShareButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ShowHideFeedButton={defaults:{pipeline:null},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};ShowHideFeedButton.impl=function(o){var options=o,pipeline=options.pipeline,css=options.css,feed=options.feed,feedSetting=BB.UserSettings.getSetting(pipeline.key()+"/showFeed");if(typeof feedSetting==="undefined"||feedSetting===""){feedSetting=true}var toggleCallback=options.toggleCallback;var hideFeedClass="apJ",showFeedClass="apK",displayFeed=function(){button.changeIconClass("apH apJ bbIcon");var container=BB.UI.getCanvas().find(".pv_container");container=container.filter(":FastVisible");container.find(".feed_sidebar").show()},hideFeed=function(){button.changeIconClass("apH apK bbIcon");var container=BB.UI.getCanvas().find(".pv_container");container=container.filter(":FastVisible");container.find(".feed_sidebar").hide()},toggleAndSaveFeedSetting=function(){feedSetting=!feedSetting;BB.UserSettings.setSetting(pipeline.key()+"/showFeed",feedSetting);BB.UserSettings.save()},button=BB.Widgets.Buttons.ButtonFactory.createToggleButton({type:"GmailTextIcon",iconClass:"apH",hasButtonToRight:true,isOn:feedSetting,text:BB.Locale.getString("newsfeed"),noDeactivation:true,onFunction:function(){displayFeed();toggleAndSaveFeedSetting();toggleCallback()},offFunction:function(){hideFeed();toggleAndSaveFeedSetting();toggleCallback()},trackingContext:options.trackingContext});button.addClass("apF showHideFeedButton");if(css){button.getElement().css(css)}button.changeIconClass("apH");setTimeout(function(){if(feedSetting){displayFeed()}else{hideFeed()}},1);return button};BB.Modules.PipelineView.ShowHideFeedButton=ShowHideFeedButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var ShowHideGroupbarButton={defaults:{pipeline:null},create:function(o){var options={};$.extend(options,this.defaults,o);return new this.impl(options)}};ShowHideGroupbarButton.impl=function(o){var options=o,pipeline=options.pipeline,displaySetting=BB.UserSettings.getSetting(pipeline.key()+"/showGroupbar");var toggleCallback=options.toggleCallback;options.trackingContext.widgetContext+="/showHideGroupbarButton";var hideBarClass="apJ",showBarClass="apI",show=function(){innerImage.removeClass(showBarClass).addClass(hideBarClass);var container=BB.UI.getCanvas().find(".pv_container");container=container.filter(":FastVisible");container.find(".groups").show()},hide=function(){innerImage.removeClass(hideBarClass).addClass(showBarClass);var container=BB.UI.getCanvas().find(".pv_container");container=container.filter(":FastVisible");container.find(".groups").hide()},toggleAndSaveSetting=function(){if(!dontSave){displaySetting=!displaySetting;BB.UserSettings.setSetting(pipeline.key()+"/showGroupbar",displaySetting);BB.UserSettings.save()}},button=BB.Widgets.Button.create({hasButtonToRight:true,isToggle:true,enableDepressedState:false,isOn:!displaySetting,tooltip:BB.Locale.getString("groupbar"),onFunc:function(){show();toggleAndSaveSetting();toggleCallback()},offFunc:function(){hide();toggleAndSaveSetting();toggleCallback()},trackingContext:options.trackingContext});button.el.addClass("apF showHideGroupbarButton");var outerImage=$(document.createElement("div"));var innerImage=$(document.createElement("div"));outerImage.addClass("rotate180");innerImage.addClass("apH T-I-J3 J-J5-Ji");outerImage.append(innerImage);button.el.prepend(outerImage);var dontSave=true;setTimeout(function(){if(displaySetting!==false){displaySetting=true}if(displaySetting){show()}else{hide()}dontSave=false},1);return button};BB.Modules.PipelineView.ShowHideGroupbarButton=ShowHideGroupbarButton})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Promote={boxesMin:10,init:function(cb){if(this.shouldRender()){this.render()}if(cb){cb()}},shouldRender:function(){if(BB.UserSettings.getSetting("promote/hasShown")){return false}return true},render:function(force){var modal=$(HTML.get("promoteModal")());var numBoxes=_.filter(BB.Data.getAllBoxes(),function(item){return item.get("creatorKey")===BB.getUser().key()}).length;if(numBoxes<this.boxesMin&&!force){return}var numPipes=_.filter(BB.Data.getAllPipelines(),function(item){return item.get("creatorKey")===BB.getUser().key()}).length;var numSnips=_.filter(BB.Data.getAllSnippets(),function(item){return item.get("userKey")===BB.getUser().key()}).length;var numSLs=BB.Data.getAllSendLaters().length;modal.find(".number.box strong").html(numBoxes);this.renderStat(modal,numBoxes,"box","es");if(numSnips+numSLs+numPipes===0){}else if(numSnips+numSLs===0&&numBoxes>0){modal.find(".number.box").after(" "+BB.Locale.getString("and")+" ")}else if(numBoxes>0){modal.find(".number.box").after(", ")}this.renderStat(modal,numPipes,"pipeline");if(numSnips>0&&numSLs>0){modal.find(".number.pipeline").after(", ")}else if(numSnips>0||numSLs>0){modal.find(".number.pipeline").after(" "+BB.Locale.getString("and")+" ")}if(numSnips===0){modal.find(".number.snippet").hide()}else{this.renderStat(modal,numSnips,"snippet");if(numSLs>0){modal.find(".number.snippet").after(" "+BB.Locale.getString("and")+" ")}}this.renderStat(modal,numSLs,"sendlater");var promoteModal=BB.Widgets.Modal.create({title:"",confirmText:force?BB.Locale.getString("modal_done"):BB.Locale.getString("dismiss_forever"),inner:modal,confirmFunc:function(){BB.UserSettings.setSetting("promote/hasShown",true);BB.UserSettings.saveSettings()},showCancel:!force,cancelText:BB.Locale.getString("not_now"),width:"800px",minHeight:"551px",showTitle:false});promoteModal.show();BB.Services.GooglePlusOne.render();BB.Tracker.track("promoteModal.show",{isForced:force});this.addTracking(modal,force)},addTracking:function(modal,isForced){modal.find(".review a").click(function(e){BB.Tracker.track("promoteModal.reviewClicked",{isForced:isForced})});modal.find(".email a").click(function(e){BB.Tracker.track("promoteModal.emailClicked",{isForced:isForced})})},renderStat:function(modal,num,name,suffix){var el=modal.find(".number."+name);el.find("strong").html(num);if(num>0){el.find("strong").after(" "+BB.Locale.getString(name+(num>1?suffix?suffix:"s":"")).toLowerCase())}else{el.hide()}}};Streak.DependencyManager.addFunction({functionKey:"promoteInitialized",functionToCall:Promote.init,functionContext:Promote,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","userSettingsInitialized"]});BB.Modules.Promote=Promote})(Streak);(function(Streak){var $=Streak.$,_=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,HTML=Streak.HTML,Library=Streak.Library,Locale=Streak.Locale;var superclass=Streak.UI.Delegator;BB.Modules.EmailFilters={};BB.Modules.EmailFilters.EmailFilterViewController=Streak.Class.subclass({className:"EmailFilterViewController",superclass:superclass,memberVariables:[{name:"_boxKey",get:true,set:true,destroy:false,defaultValue:null},{name:"_contacts",get:true,set:true,destroy:false},{name:"_element",get:true,destroy:true},{name:"_gmailThreadCollection",destroy:false},{name:"_emailFilterBlacklists",destroy:false},{name:"_emailFilters",destroy:false},{name:"_emailFiltersInner",destroy:true},{name:"_trackingContext",destroy:true},{name:"_useLinkButtonForNewFilter",get:true,set:true,destroy:true,defaultValue:false},{name:"_fetchInfoFromServer",get:true,set:true,destroy:true,defaultValue:false},{name:"_showTitle",get:true,set:true,destroy:true,defaultValue:true},{name:"_suggestionsFromThread",get:true,set:true,destroy:true,defaultValue:true},{name:"_isButtonModal",destroy:false,defaultValue:true}],_initialize:function(options){superclass.prototype._initialize.call(this);if(!options.boxKey){throw new Error("boxKey is a mandatory argument to emailFilters._initialize")}this.setBoxKey(options.boxKey);if(options.useLinkButtonForNewFilter!==undefined){this._useLinkButtonForNewFilter=options.useLinkButtonForNewFilter}if(options.fetchInfoFromServer!==undefined){this._fetchInfoFromServer=options.fetchInfoFromServer}if(options.showTitle!==undefined){this._showTitle=options.showTitle}if(options.suggestionsFromThread!==undefined){this._suggestionsFromThread=options.suggestionsFromThread}if(options.trackingContext!==undefined){this._trackingContext=options.trackingContext}if(options.modalFromButton!==undefined){this._isButtonModal=options.modalFromButton}this._element=$(HTML.getElement("boxSidebarEmailFilters"));this._setupEmailFilterCreationModal();this._setupNewEmailFilterMenuButton();this._setupTitle();if(this._fetchInfoFromServer){this._setupCollections()}},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});superclass.prototype.destroy.call(this)},_setupCollections:function(){var self=this;var emailFilterBlacklistCollection=BB.Data.getEmailFilterBlacklistCollection(this.getBoxKey());emailFilterBlacklistCollection.refresh(function(){self.setEmailFilterBlacklists(emailFilterBlacklistCollection)});var emailFilterCollection=BB.Data.getEmailFilterCollection(this.getBoxKey());self.setEmailFilters(emailFilterCollection);emailFilterCollection.refresh(function(){self.setEmailFilters(emailFilterCollection)});if(!this._suggestionsFromThread){this._gmailThreadCollection=BB.Data.getGmailThreadCollectionForBox(this._boxKey);this._gmailThreadCollection.watch("collectionChange",function(){self._updateContacts()},this);this._updateContacts()}},_setupTitle:function(){if(!this._showTitle){this._element.find(".streak__emailFilters_title").remove()}},setEmailFilters:function(emailFilters){Streak.NotificationCenter.unsubscribe({observer:this});this._emailFilterCollection=emailFilters;if(this._emailFilterCollection){var self=this;this._emailFilterCollection.watch("collectionChange",function(){self._emailFilterCollectionUpdated()},this)}this._emailFilterCollectionUpdated()},setEmailFilterBlacklists:function(emailFilterBlacklists){this._emailFilterBlacklists=emailFilterBlacklists;this.updateEmailFilterCreationModalSuggestions()},_emailFilterCollectionUpdated:function(){this.updateEmailFilters();this.updateEmailFilterCreationModalSuggestions()},updateEmailFilters:function(){if(!this._emailFiltersInner){this._emailFiltersInner=this._element.find(".streak__emailFiltersInner")}this._emailFiltersInner.empty();var self=this;if(!this._emailFilterCollection){return}if(this._emailFilterCollection.length>0){var emailFiltersList=$(document.createElement("ul"));_.each(this._emailFilterCollection,function(emailFilter){var row=$(HTML.get("boxSidebarEmailFilter")({content:emailFilter.filterDisplayHtml()}));row.find(".ar9").on("click",function(){self.removeFilter(emailFilter)});emailFiltersList.append(row)});this._emailFiltersInner.append(emailFiltersList)}else{var empty=$(document.createElement("div"));empty.text(Locale.getString("email_suggestion_no_filters"));empty.addClass("asd ja streak__emailFilters_empty");this._emailFiltersInner.html(empty)}this._callDelegateFunction("updateEmailFilters")},getEmailFilters:function(){return this._emailFilterCollection},_setupNewEmailFilterMenuButton:function(){var self=this;var menu=BB.Widgets.Menu.create();menu.addSection(self._emailFilterCreationModal);var baseOptions={text:Locale.getString("email_filters_new_filter"),color:"blue",isFixedPosition:true,isRightAligned:true,menu:menu,postOnFunction:this._emailFilterCreationModalOn.bind(this)};if(this._useLinkButtonForNewFilter){this._newEmailFilterButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton(_.extend(baseOptions,{type:"Text",text:Locale.getString("link_create_new")}));this._newEmailFilterButton.getElement()[0].style.textDecoration="none"}else{this._newEmailFilterButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton(_.extend(baseOptions,{type:"Gmail"}))}if(BB.Data.getBox(this._boxKey).getIsEditable()){this._newEmailFilterButton.enable()}else{this._newEmailFilterButton.disable()}this._element.find(".streak__emailFilters_newFilter").html(this._newEmailFilterButton.getElement())},getNewEmailFilterButtonElement:function(){return this._newEmailFilterButton.getElement()},_setupEmailFilterCreationModalConfirmButton:function(){var self=this;if(!this._emailFilterCreationModalConfirmButton){this._emailFilterCreationModalConfirmButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:Locale.getString("email_suggestion_create_filter"),color:"blue",onFunction:function(){var elt=self._emailFilterCreationModal;var type=elt.find("input:radio:checked[name=emailFilterType]").val();if(type==="email"){var email=self._emailFilterCreationModalEmailTextbox.getText().trim();if(!email){BB.ButterBarManager.showError(BB.Locale.getString("email_filter_error_empty"));return}self.createEmailFilter(email)}else if(type==="domain"){var domain=self._emailFilterCreationModalDomainTextbox.getText().trim();if(!domain){BB.ButterBarManager.showError(BB.Locale.getString("email_filter_error_empty"));return}self.createDomainFilter(domain)}if(self._isButtonModal){self._newEmailFilterButton.off()}else{self._callDelegateFunction("close",self)}}})}this._emailFilterCreationModal.find(".streak__filter_creator_confirm_button").html(this._emailFilterCreationModalConfirmButton.getElement())},_setupEmailFilterCreationModalXButton:function(){var self=this;if(!this._isButtonModal){return}if(!this._emailFilterCreationModalXButton){this._emailFilterCreationModalXButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"X",onFunction:function(){self._newEmailFilterButton.off()}})}this._emailFilterCreationModal.find(".streak__filter_creator_cancel_button").html(this._emailFilterCreationModalXButton.getElement())},_emailFilterCreationModalOn:function(){this._emailFilterCreationModalEmailTextbox.setHTML(null);this._emailFilterCreationModalDomainTextbox.setHTML(null);this._emailFilterCreationModal.find("input:radio[name=emailFilterType][value=email]").click()},_setupEmailFilterCreationModal:function(){if(!this._emailFilterCreationModal){this._emailFilterCreationModal=$(HTML.getElement("boxSidebarEmailFilterCreator"))}this._setupEmailFilterCreationModalConfirmButton();this._setupEmailFilterCreationModalXButton();if(!this._emailFilterCreationModalEmailTextbox){this._emailFilterCreationModalEmailTextbox=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true})}this._emailFilterCreationModal.find(".emailFilterEmail").html(this._emailFilterCreationModalEmailTextbox.getView().getElement());if(!this._emailFilterCreationModalDomainTextbox){this._emailFilterCreationModalDomainTextbox=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true})}this._emailFilterCreationModal.find(".emailFilterDomain").html(this._emailFilterCreationModalDomainTextbox.getView().getElement());this.updateEmailFilterCreationModalSuggestions()},_getContacts:function(){return _.chain(this._gmailThreadCollection).map(function(gmailThread){return _.map(gmailThread.get("emailAddresses"),function(email,i){return{email:email,fullName:gmailThread.get("names")[i]}})}).flatten(true).uniq(false,function(contact){return contact.email}).sortBy("fullName").value()},_updateContacts:function(){this._contacts=this._getContacts();this.updateEmailFilterCreationModalSuggestions()},updateEmailFilterCreationModalSuggestions:function(){var self=this;var suggestionList=this._emailFilterCreationModal.find(".emailFilterCreatorSuggestions");suggestionList.empty();var suggestions=this.getEmailFilterSuggestions();if(suggestions.length===0){this._emailFilterCreationModal.find(".streak__filter_creator_suggestions").hide();return}this._emailFilterCreationModal.find(".streak__filter_creator_suggestions").show();_.each(suggestions,function(suggestion){var link=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",html:suggestion.html,color:"cornflowerblue",onFunction:function(){self._emailFilterCreationModal.find("input:radio[name=emailFilterType][value="+suggestion.type+"]").click();if(suggestion.type==="email"){self._emailFilterCreationModalEmailTextbox.setHTML(suggestion.email);self._emailFilterCreationModalDomainTextbox.setHTML(null)}else{self._emailFilterCreationModalEmailTextbox.setHTML(null);self._emailFilterCreationModalDomainTextbox.setHTML(suggestion.domain)}}});suggestionList.append($(document.createElement("li")).html(link.getElement()))})},getEmailFilterSuggestions:function(){var emails;if(this._suggestionsFromThread){emails=this.getEmailAddressesInGmailThread()}else{emails=_.pluck(this._contacts,"email")}emails.removeVal(BB.getUser().getEmail());var domains=_.chain(emails).map(function(email){return email.split("@")[1]}).uniq().value();var filters=this._emailFilterCollection;if(filters){emails=_.reject(emails,function(email){for(var i=0;i<filters.length;i++){var filter=filters[i];if(filter.get("type")==="EMAIL_ADDRESS_FILTER"&&filter.get("value")===email){return true}}return false});domains=_.reject(domains,function(domain){for(var i=0;i<filters.length;i++){var filter=filters[i];if(filter.get("type")==="DOMAIN_FILTER"&&filter.get("value")===domain){return true}}return false})}var blacklists=this._emailFilterBlacklistCollection;if(blacklists){emails=_.reject(emails,function(email){return _.some(blacklists,function(blacklists){return blacklists.get("blacklistEmail")===email})})}var emailSuggestions=_.map(emails,function(email){return{type:"email",email:email,html:Locale.getString("email_suggestion_creation_one_email",{email:_.escape(email)})}});var domainSuggestions=_.map(domains,function(domain){return{type:"domain",domain:domain,html:Locale.getString("email_suggestion_creation_one_domain",{domain:_.escape(domain)})}});return emailSuggestions.concat(domainSuggestions)},createEmailFilter:function(emailAddress){var emailFilterLimiter=Library.get("BentoBox.Services.EmailFilterLimiter");if(emailFilterLimiter.isLocked()){emailFilterLimiter.showGateway()}else{var newFilter=BB.Models.EmailFilter.create({type:"EMAIL_ADDRESS_FILTER",value:emailAddress,boxKey:this._boxKey});newFilter.save();this._emailFilterCollection.add(newFilter);emailFilterLimiter.incrementUsage()}},createDomainFilter:function(domain){var emailFilterLimiter=Library.get("BentoBox.Services.EmailFilterLimiter");if(emailFilterLimiter.isLocked()){emailFilterLimiter.showGateway()}else{var newFilter=BB.Models.EmailFilter.create({type:"DOMAIN_FILTER",value:domain,boxKey:this._boxKey});newFilter.save();this._emailFilterCollection.add(newFilter);emailFilterLimiter.incrementUsage()}},removeFilter:function(filter){filter.del()},showCreateFilterDialog:function(){var self=this;this._emailFilterCreationModalOn();return{getElement:function(){return self._emailFilterCreationModal},addDelegate:this.addDelegate.bind(this)}},getEmailAddressesInGmailThread:function(){var hexGmailThreadIDList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(hexGmailThreadIDList[0]);if(threadMetaData){return _.uniq(threadMetaData.emailAddresses)}else{return[]}}})})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Locale=Streak.Locale;var MAX_EMAIL_FILTERS=2;var EmailFilterLimiter=Streak.Class.subclass({superclass:Streak.BentoBox.Services.FeatureLimiter,_memberVariables:[],_initialize:function(){Streak.BentoBox.Services.FeatureLimiter.prototype._initialize.call(this)},_getFeatureKey:function(){return"emailFilters"},_getGatewayTitle:function(){return Locale.getString("email_filters_gateway_title")},_getGatewayBodyText:function(){return Locale.getString("email_filters_gateway_text")},_getLimit:function(){return MAX_EMAIL_FILTERS}});DependencyManager.addFunction({functionKey:"EmailFilterLimiterInitialized",functionToCall:function(callback){Library.set("BentoBox.Services.EmailFilterLimiter",new EmailFilterLimiter);if(callback){callback()}},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Gmail=Streak.Gmail;var TrackedLink=function(data){Model.call(this,data)};TrackedLink.prototype=Object.create(Model.prototype);_.extend(TrackedLink.prototype,{keyName:"trackedLinkKey",entityType:"TrackedLink",createProperties:["guid","hexGmailThreadId","subject","names","emails","snippetKeyList","isMailMerge","rfcMessageId"],apiURLs:{create:"trackedlinks"},tagEntityName:"trackedLink",shouldShowSavingMessage:function(editOperations){return false}});TrackedLink.create=function(data){return new TrackedLink(data)};TrackedLink.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"TrackedLinkKey",requestTags:["trackedLinkCollection_noKey"],requestDependentOnTags:["trackedLinkCollection_noKey"],createModelFromRawJSON:TrackedLink.create});return c};BB.Models.TrackedLink=TrackedLink})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox,Gmail=Streak.Gmail;var APIKey=function(data){Model.call(this,data)};APIKey.prototype=Object.create(Model.prototype);_.extend(APIKey.prototype,{keyName:"apiKeyKey",entityType:"APIKey",createProperties:[],apiURLs:{create:"apikeys","delete":"apikeys/<%= apiKeyKey %>"},tagEntityName:"apiKey",getRequestTags:function(requestType){var baseTags=Model.prototype.getRequestTags.call(this,requestType);switch(requestType){case"CREATE":return baseTags.concat(["apiKey_create_noKey","apiKeyCollection_noKey"]);break;case"DELETE":return baseTags.concat(["apiKey_delete_noKey","apiKeyCollection_noKey"]);break}return baseTags}});APIKey.create=function(data){return new APIKey(data)};APIKey.createCollection=function(){var c=new Collection;c.init({modelKeyPropertyName:"apiKeyKey",apiURL:"apikeys",requestTags:["apiKeyCollection_noKey"],requestDependentOnTags:["apiKeyCollection_noKey"],refreshRequeueOperationTags:["apiKey_delete_noKey","apiKey_create_noKey"],createModelFromRawJSON:APIKey.create});return c};BB.Models.APIKey=APIKey})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MAX_EMAILS=200;var INVITES_NEEDED=5;var PixelTrackingLimiter=Streak.Class.subclass({superclass:Streak.Object,_memberVariables:[{name:"_invitesSent",destroy:false},{name:"_shareModalSeen",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._shareModalSeen=false;this._getSentInvites();this._bindToSendEvents()},_getSentInvites:function(){Streak.APIRequester.get("apps/EmailTracking/invites").getPromise().then(this._processSentInvites.bind(this))},_processSentInvites:function(result){if(!result||!result.emailAddresses){this._invitesSent=false;return}if(result.emailAddresses.length>=INVITES_NEEDED){this._invitesSent=true;return}this._invitesSent=false;return},_bindToSendEvents:function(){NotificationCenter.subscribe({eventName:"trackedEmailSent",functionToCall:this._trackedEmailSent,observer:this})},_trackedEmailSent:function(number){if(!number||!_.isNumber(number)){number=1}var currentCount=BB.LocalSettings.get("trackedEmails/currentCount");var month=Date.create().getMonth();if(!currentCount){BB.LocalSettings.set("trackedEmails/currentCount",{count:number,month:month});return}if(!_.isNumber(currentCount.count)){currentCount.count=1}if(currentCount.month!==month){BB.LocalSettings.set("trackedEmails/currentCount/month",month);BB.LocalSettings.set("trackedEmails/currentCount/count",number)}else{BB.LocalSettings.set("trackedEmails/currentCount/count",currentCount.count+number)
}},_isUnderTheLimit:function(){var sentThisMonth=this._getTrackedEmailsSentThisMonth();return sentThisMonth<MAX_EMAILS},_getTrackedEmailsSentThisMonth:function(){var currentCount=BB.LocalSettings.get("trackedEmails/currentCount");var month=Date.create().getMonth();if(!currentCount){return 0}if(!_.isNumber(currentCount.count)){currentCount.count=1}if(currentCount.month===month){return currentCount.count}return 0},registerInvitesSent:function(emailAddresses){Streak.APIRequester.post("apps/EmailTracking/invites",{emails:emailAddresses});this._invitesSent=true},canTrackEmails:function(){if(this._invitesSent){return true}if(BB.isFeatureEnabled("unlimitedPixelTracking")){return true}return this._isUnderTheLimit()},isTrackingEnabled:function(){return true},hasSentInvites:function(){return this._invitesSent},shouldShowShareModalOnOpen:function(){return!this._shareModalSeen},registerSeenShareModal:function(){this._shareModalSeen=true}});Streak.DependencyManager.addFunction({functionKey:"pixelTrackingLimiterInitialized",functionToCall:function(callback){Library.set("BentoBox.Services.PixelTrackingLimiter",new PixelTrackingLimiter);if(callback){callback()}},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CONSTANTS={RECENT_VIEWS_URL_KEY:"label%3Aall+before%3A5000%2F01%2F01"};var PixelTrackerUtils={isRecentViewsResultsPage:function(){return location.hash==="#search/label%3Aall+before%3A5000%2F01%2F01"&&Gmail.getMainList()&&(Gmail.getMainList().find("[streakthreadid]").length>0||Gmail.getMainList().find("[streakhiderow]").length>0)}};Library.set("BentoBox.Modules.PixelTrackerUtils",PixelTrackerUtils)})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,Data=Streak.BentoBox.Data,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._,BLOCK_TYPES=Streak.Gmail.GmailConversationGeometryModel.BLOCK_TYPES;var PixelTrackerDetailsModel=function(messagesModel,trackedThread){this._messageBlocks=messagesModel.getMessageBlocks();this._trackedLinks=trackedThread.links;this._processedMessageBlocks=[];this._updateBlockGeometry();this._matchMessageBlocks();this._processViewInformationForBlocks()};PixelTrackerDetailsModel.MATCH_TYPES={UNMATCHED:"UNMATCHED",MATCHED:"MATCHED"};_.extend(PixelTrackerDetailsModel.prototype,{_updateBlockGeometry:function(){var containerOffset=Gmail.getCurrentMain().find("td.Bu").first().offset();var streakOffset=Streak.$("#streakSidebar .__streak_CS_body").offset();var diff=0;if(containerOffset&&streakOffset){diff=containerOffset.top-streakOffset.top}for(var ii=0;ii<this._messageBlocks.length;ii++){var messageBlock=this._messageBlocks[ii];messageBlock.sidebarGeometry={top:messageBlock.geometry.top+diff,bottom:messageBlock.geometry.bottom+diff,middle:messageBlock.geometry.middle+diff}}},_matchMessageBlocks:function(){if(!this._messageBlocks){return}var ii;var messageBlockIndex=0;var lastTrackedLinkIndex=-1;var unmatchedTrackedLinks=[];var unmatchedMessageBlocks=[];for(;messageBlockIndex<this._messageBlocks.length;messageBlockIndex++){unmatchedTrackedLinks.length=0;var messageBlock=this._messageBlocks[messageBlockIndex];var messageGuid=this._extractGuid(messageBlock);if(messageGuid){for(ii=lastTrackedLinkIndex+1;ii<this._trackedLinks.length;ii++){var trackedLink=this._trackedLinks[ii];if(messageGuid===trackedLink.guid){if(unmatchedMessageBlocks.length>0){this._processedMessageBlocks.push(this._groupMessageBlocks(unmatchedMessageBlocks,_.clone(unmatchedTrackedLinks)));unmatchedMessageBlocks.length=0}messageBlock.trackedLink=trackedLink;messageBlock.matchType=PixelTrackerDetailsModel.MATCH_TYPES.MATCHED;this._processedMessageBlocks.push(messageBlock);lastTrackedLinkIndex=ii;break}else{unmatchedTrackedLinks.push(trackedLink)}}if(ii===this._trackedLinks.length){unmatchedMessageBlocks.push(messageBlock)}}else{unmatchedMessageBlocks.push(messageBlock)}}if(unmatchedMessageBlocks.length>0){for(ii=lastTrackedLinkIndex+1;ii<this._trackedLinks.length;ii++){unmatchedTrackedLinks.push(this._trackedLinks[ii])}this._processedMessageBlocks.push(this._groupMessageBlocks(unmatchedMessageBlocks,unmatchedTrackedLinks))}},_getNextPotentialMatchBlockIndex:function(currentOpenBlockIndex){for(var ii=currentOpenBlockIndex;ii>-1;ii--){var messageBlock=this._messageBlocks[ii];if(messageBlock&&messageBlock.type===BLOCK_TYPES.EXPANDED&&messageBlock.sender.email===BB.getUser().getEmail()){return ii}}return-1},_getNextTrackedLinkIndex:function(currentTrackedLinkIndex,messageGuid){for(var ii=currentTrackedLinkIndex;ii>-1;ii--){var trackedLink=this._trackedLinks[ii];if(trackedLink&&trackedLink.guid===messageGuid){return ii}}return-1},_getUnmatchedBlocks:function(currentOpenBlockIndex,nextPotentialMatchBlockIndex){var blocks=[];for(var ii=currentOpenBlockIndex-1;ii>nextPotentialMatchBlockIndex;ii--){var messageBlock=this._messageBlocks[ii];if(messageBlock){blocks.push(messageBlock)}}return blocks.reverse()},_extractGuid:function(messageBlock){if(messageBlock.type===BLOCK_TYPES.EXPANDED&&messageBlock.sender.email===BB.getUser().getEmail()){var body=messageBlock.body;var images=body.find('> div > img[src*="'+Streak.server+'"]');images=$.merge(images,body.find("> div > div").first().find('img[src*="'+Streak.server+'"]'));var guids=[];for(var ii=0;ii<images.length;ii++){var src=images[ii].src;var index=src.indexOf("guid=");if(index>-1){guids.push(src.substring(index+5))}}guids.sort().reverse();return guids[0]}},_groupMessageBlocks:function(messageBlocks,trackedLinks){var containerOffset=Gmail.getCurrentMain().find("td.Bu").first().offset();var streakOffset=Streak.$("#streakSidebar .__streak_CS_body").offset();var diff=0;if(containerOffset&&streakOffset){diff=containerOffset.top-streakOffset.top}var firstBlock=messageBlocks[0];var lastBlock=_.last(messageBlocks);var groupedMessageBlock={el:[],matchType:PixelTrackerDetailsModel.MATCH_TYPES.UNMATCHED,trackedLinks:trackedLinks};var geometry={left:firstBlock.geometry.left,width:firstBlock.geometry.width,top:firstBlock.geometry.top,bottom:lastBlock.geometry.bottom,height:lastBlock.geometry.bottom-firstBlock.geometry.top};geometry.middle=(geometry.top+geometry.bottom)/2;groupedMessageBlock.geometry=geometry;groupedMessageBlock.sidebarGeometry={top:geometry.top+diff,bottom:geometry.bottom+diff,middle:geometry.middle+diff};for(var ii=0;ii<messageBlocks.length;ii++){groupedMessageBlock.el=groupedMessageBlock.el.concat(messageBlocks[ii].el)}return groupedMessageBlock},_processViewInformationForBlocks:function(){for(var ii=0;ii<this._processedMessageBlocks.length;ii++){this._processMessageBlockViews(this._processedMessageBlocks[ii])}},_processMessageBlockViews:function(messageBlock){var views=[];var displayNameMap={};var mostRecentView=-1;var trackedLinkArray;if(messageBlock.trackedLink){trackedLinkArray=[messageBlock.trackedLink]}else if(messageBlock.trackedLinks){trackedLinkArray=messageBlock.trackedLinks}for(var ii=0;ii<trackedLinkArray.length;ii++){views=views.concat(trackedLinkArray[ii].views)}for(var ii=0;ii<views.length;ii++){var view=views[ii];if(view.timestamp>mostRecentView){mostRecentView=view.timestamp}if(_.isNotReal(displayNameMap[view.displayName])){displayNameMap[view.displayName]={displayName:view.displayName,viewCount:1,mostRecentView:view.timestamp,requestInformation:view.requestInformation}}else{var oldView=displayNameMap[view.displayName];if(oldView.mostRecentView<view.timestamp){oldView.mostRecentView=view.timestamp;oldView.requestInformation=view.requestInformation}oldView.viewCount+=1}}messageBlock.processedViews=_(displayNameMap).chain().values(displayNameMap).sortBy(function(viewObject){return viewObject.mostRecentView}).reverse().value();messageBlock.views=views;messageBlock.identifier=views.length+"_"+mostRecentView},getMessageBlocks:function(){return this._processedMessageBlocks},fakefuxn:null});BB.Modules.PixelTrackerDetailsModel=PixelTrackerDetailsModel})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Gmail=Streak.Gmail,Date=Streak.Date,APIRequester=Streak.APIRequester,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var PixelTrackerViewsHelper=function(){var self=this};_.extend(PixelTrackerViewsHelper.prototype,{getViewsLimited:function(matches,count){var self=this;var allViews=self._getViews(matches);var sortedViews=self._mergeViewsByDisplayName(allViews);return sortedViews.splice(0,count)},_mergeViewsByDisplayName:function(views){var self=this;var viewsMap={};_.each(views,function(view){var displayName=view.displayName;if(!_.isReal(viewsMap[displayName])){viewsMap[displayName]=[]}viewsMap[displayName].push(view)});var sortedViewArray=[];_.each(viewsMap,function(views,displayName){var lastSeenView=self._getLatestTimestamp(views);var viewObj={displayName:displayName,device:lastSeenView.device,timesViewed:views.length,lastSeen:lastSeenView.timestamp};sortedViewArray.push(viewObj)});sortedViewArray=_.sortBy(sortedViewArray,function(view){return view.lastSeen});return sortedViewArray},_getLatestTimestamp:function(views){var self=this;var viewsSorted=_.sortBy(views,function(view){return view.timestamp});return viewsSorted[0]},_getViews:function(matches){var self=this;var views=[];_.each(matches,function(match){views=views.concat(match.views)});return views},ffdsfs12342132jkdjksdkjdfsfs:null});BB.Modules.PixelTrackerViewsHelper=PixelTrackerViewsHelper})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._,MATCH_TYPES=Streak.BentoBox.Modules.PixelTrackerDetailsModel.MATCH_TYPES;var PixelTrackerCircleLineView=function(){this._delegates=[];this._templates={};this._templates.circle=HTML.get("pixelTrackerCircle");this._templates.line=HTML.get("pixelTrackerLine");this._container=$("<div></div>");this._messageBlocks=null;this._singleBlock=null;this._isInSingleMode=false};_.extend(PixelTrackerCircleLineView.prototype,{addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},getElement:function(){var self=this;return self._container},destroy:function(){var self=this;self._container.remove()},refresh:function(messageBlocks){var self=this;self._messageBlocks=messageBlocks;self._setLeftPosition();self._container.height(_.last(messageBlocks).sidebarGeometry.bottom);if(self._isInSingleMode){var newSingleBlock=_.find(messageBlocks,function(messageBlock){return messageBlock.identifier===self._singleBlock.identifier});if(newSingleBlock){this._singleBlock=newSingleBlock;this._refreshDetailMode()}}else{self._container.empty();self._refreshCirclesAndLines()}},_setLeftPosition:function(){if(this._isMarginBetweenConversationAndSidebarWide()){this._container.parent().css("left","")}else{this._container.parent().css("left","-18px")}},_isMarginBetweenConversationAndSidebarWide:function(){var bodyRightMargin=Gmail.getCurrentMain().find("td.Bu").first().find("> .if").css("margin-right");try{if(parseInt(bodyRightMargin,10)<20){return false}else{return true}}catch(err){return true}},renderDetailMode:function(messageBlock){this._isInSingleMode=true;this._singleBlock=messageBlock;this._refreshDetailMode()},_refreshDetailMode:function(){this._container.empty();this._renderCircle(this._singleBlock);this._renderVerticalLine(this._getTopMostPosition(),this._singleBlock.sidebarGeometry.middle);this._renderVerticalLine(this._singleBlock.sidebarGeometry.middle,this._getBottomMostPosition())},_getTopMostPosition:function(){var firstBlock=_.first(this._messageBlocks);if(firstBlock){return firstBlock.sidebarGeometry.top}return 0},_getBottomMostPosition:function(){var lastBlock=_.last(this._messageBlocks);if(lastBlock){return lastBlock.sidebarGeometry.bottom}return 0},renderListMode:function(){this._isInSingleMode=false;this._container.empty();this._refreshCirclesAndLines()},_refreshCirclesAndLines:function(){this._renderCircles();this._renderLines()},_renderCircles:function(){for(var ii=0;ii<this._messageBlocks.length;ii++){this._renderCircle(this._messageBlocks[ii])}},_renderCircle:function(messageBlock,inTop){var self=this;var top=inTop||messageBlock.sidebarGeometry.middle;var el=$(self._templates.circle());el.css({top:top+"px",left:0+"px"});if(messageBlock.matchType===MATCH_TYPES.UNMATCHED){if(messageBlock.trackedLinks&&messageBlock.trackedLinks.length>0){el.addClass("streak__pt_unmatchedCircle")}else{el=null}}if(el){el.click(function(){if(self._isInSingleMode){self._callZoomOutDelegates(messageBlock)}else{self._callZoomInDelegates(messageBlock)}});this._container.append(el);return el}},_renderLines:function(){var lastTracked=false;var lastTrackedStart=0;for(var ii=0;ii<this._messageBlocks.length;ii++){var messageBlock=this._messageBlocks[ii];if(messageBlock.matchType===MATCH_TYPES.MATCHED){if(lastTracked){this._renderVerticalLine(lastTrackedStart,messageBlock.sidebarGeometry.middle)}else{this._renderVerticalLine(messageBlock.sidebarGeometry.top,messageBlock.sidebarGeometry.middle)}if(ii>0||ii===this._messageBlocks.length-1){this._renderVerticalLine(messageBlock.sidebarGeometry.middle,messageBlock.sidebarGeometry.bottom);lastTrackedStart=messageBlock.sidebarGeometry.bottom}else{lastTrackedStart=messageBlock.sidebarGeometry.middle}lastTracked=true}else{if(lastTracked){this._renderVerticalLine(lastTrackedStart,messageBlock.sidebarGeometry.top)}this._renderVerticalLine(messageBlock.sidebarGeometry.top,messageBlock.sidebarGeometry.bottom,true);this._renderHorizontalLine(messageBlock.sidebarGeometry.top);this._renderHorizontalLine(messageBlock.sidebarGeometry.bottom);lastTracked=false}}},_renderVerticalLine:function(top,bottom,isDashed){var el=$(this._templates.line());el.css({top:top+"px",height:bottom-top+"px"});if(isDashed){el.addClass("streak__pt_dashedBorder")}this._container.append(el);return el},_renderHorizontalLine:function(top){var el=$(this._templates.line());el.css({top:top+"px"});el.addClass("streak__pt_horizontalBorder");this._container.append(el)},_callZoomOutDelegates:function(selecteMessageBlock){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.circleDidZoomOut)){delegate.circleDidZoomOut(selecteMessageBlock,true)}});track("pixel_track_show_overview",{source:"circleLine"})},_callZoomInDelegates:function(selecteMessageBlock){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.circleDidZoomIn)){delegate.circleDidZoomIn(selecteMessageBlock,true)}});track("pixel_track_show_detail",{source:"circleLine"})}});var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Modules.PixelTrackerCircleLineView=PixelTrackerCircleLineView})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Gmail=Streak.Gmail,Date=Streak.Date,APIRequester=Streak.APIRequester,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var ConversationCircleLineViewController=function(){var self=this;self._delegates=[];self._view=new BB.Modules.PixelTrackerCircleLineView;self._view.addDelegate(self)};_.extend(ConversationCircleLineViewController.prototype,{addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},_callDelegatesForCricleZoomOut:function(){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.circleDidZoomOut)){delegate.circleDidZoomOut()}})},_callDelegatesForCricleZoomIn:function(selectedMessageBlock){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.circleDidZoomIn)){delegate.circleDidZoomIn(selectedMessageBlock)}})},gmailThreadRowsChanged:function(circlesGeometry){var self=this;self._view.refresh(circlesGeometry)},lessDetailsLinkClick:function(){var self=this;self._view.renderListMode();BB.Tracker.track("pixel tracking less details clicked")},moreDetailsLinkClick:function(messageBlock){var self=this;self._view.renderDetailMode(messageBlock);BB.Tracker.track("pixel tracking more details clicked")},circleDidZoomOut:function(){var self=this;self._callDelegatesForCricleZoomOut();self.lessDetailsLinkClick();BB.Tracker.track("pixel tracking circle zoom out")},circleDidZoomIn:function(selectedMessageBlock){if(!selectedMessageBlock.processedViews||selectedMessageBlock.processedViews.length===0){return}var self=this;self._callDelegatesForCricleZoomIn(selectedMessageBlock);self.moreDetailsLinkClick(selectedMessageBlock);BB.Tracker.track("pixel tracking circle zoom in")},destroy:function(){var self=this;self._view.destroy()}});BB.Modules.ConversationCircleLineViewController=ConversationCircleLineViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Gmail=Streak.Gmail,Locale=Streak.Locale,HTML=Streak.HTML,Data=Streak.BentoBox.Data,BB=Streak.BentoBox;var PixelTrackerSidebarViewController=function(trackedThread){Streak.ViewControllerBase.call(this);this._view=new BB.Modules.PixelTrackerSidebarView;this._circleSidebarController=null;this._infoSidebarController=null;this._trackedLinkMatchController=null;this._trackedThread=trackedThread;this._setupSubViewControllers()};PixelTrackerSidebarViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(PixelTrackerSidebarViewController.prototype,{getElement:function(){return this._view.getElement()},_setupSubViewControllers:function(){this._view.removeLoading();this._circleSidebarController=new BB.Modules.ConversationCircleLineViewController;this._view.addCircleLineSubView(this._circleSidebarController._view);this._infoSidebarController=new BB.Modules.TrackedLinkInformationViewController;this._view.addTrackedInfoView(this._infoSidebarController._view);this._trackedLinkMatchController=new BB.Modules.TrackedLinkMatchController(this._trackedThread);this._trackedLinkMatchController.addDelegate(this._circleSidebarController);this._trackedLinkMatchController.addDelegate(this._infoSidebarController);this._infoSidebarController.addDelegate(this._circleSidebarController);this._circleSidebarController.addDelegate(this._infoSidebarController);BB.Tracker.track("pixelTrackerSidebarShown")},matchLinksToMessages:function(){this._trackedLinkMatchController.matchLinksToMessages()},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});if(this._view){this._view.destroy()}if(this._circleSidebarController){this._circleSidebarController.destroy();this._circleSidebarController=null}if(this._infoSidebarController){this._infoSidebarController.destroy();this._infoSidebarController=null}if(this._trackedLinkMatchController){this._trackedLinkMatchController.destroy();this._trackedLinkMatchController=null}Streak.ViewControllerBase.prototype.destroy.call(this)}});BB.Modules.PixelTrackerSidebarViewController=PixelTrackerSidebarViewController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var PixelTrackerSidebarView=function(){var self=this;var container=$(HTML.get("pixelTrackerContainer")());self._container=container;self._circleContainer=container.find(".streak_circle_container");self._infoContainer=container.find(".streak_info_container");self._addSpaceToConversationHeader()};_.extend(PixelTrackerSidebarView.prototype,{getElement:function(){var self=this;return self._container},removeLoading:function(){this._container.find(".pt_info_main_loading").remove()},addCircleLineSubView:function(view){var self=this;self._circleView=view;self._circleContainer.append(view.getElement())},destroy:function(){var self=this},addTrackedInfoView:function(view){var self=this;self._infoView=view;self._infoContainer.append(view.getElement())},_addSpaceToConversationHeader:function(){Gmail.getConversationSubjectHeader().addClass("streak__pixelTrackConversationSubject")}});BB.Modules.PixelTrackerSidebarView=PixelTrackerSidebarView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,_=Streak._;var TrackedLinkMatchController=function(trackedThread){this._trackedThread=trackedThread;this._unbindFunctions=[];this._delegates=[];this._conversationWatcher=new Gmail.GmailConversationWatchController;this._conversationWatcher.addDelegate(this)};_.extend(TrackedLinkMatchController.prototype,{matchLinksToMessages:function(){this._conversationWatcher.processConversation()},gmailThreadRowsChanged:function(gmailMessagesModel){this._gmailMessagesModel=gmailMessagesModel;this._callDelegatesForGmailMessagesChange()},_callDelegatesForGmailMessagesChange:function(){if(!_.isReal(this._trackedThread)||!_.isReal(this._gmailMessagesModel)){return}var detailsModel=new BB.Modules.PixelTrackerDetailsModel(this._gmailMessagesModel,this._trackedThread);var gmailMessages=detailsModel.getMessageBlocks();for(var ii=0;ii<this._delegates.length;ii++){var delegate=this._delegates[ii];if(delegate.gmailThreadRowsChanged){delegate.gmailThreadRowsChanged(gmailMessages)}}},addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},destroy:function(){this._conversationWatcher.destroy();this._delegates.length=0;this._delegates=null}});BB.Modules.TrackedLinkMatchController=TrackedLinkMatchController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkDetailsView=function(){var self=this;self._delegates=[];self._templates={};self._templates.entry=HTML.get("pt_overview_view_entry");self._templates.viewsHeader=HTML.get("pt_views");self._el=$(HTML.get("pt_detail_block")());self._blockContainer=self._el.find(".streak__pt_detail_container");self._mapContainer=self._el.find(".streak__pt_map_container");self._graphContainer=self._el.find(".streak__pt_graph_container");self._viewCountContainer=self._el.find(".streak__pt_view_count_container");self._barChartView=null;self._mapFrame=null;self._bindButtonEvent(self._el.find(".button"));self._setupIFrames()};_.extend(TrackedLinkDetailsView.prototype,{_setupIFrames:function(){this._barChartView=Streak.Library.get("UI.ChartFactory").createChart({type:"columnChart",chartArea:{left:20,top:10,width:190,height:100},hAxis:{format:"EEE",gridlines:{color:"white"}},vAxis:{gridlines:{color:"white"}},legend:{position:"none"},width:190,height:125});this._mapFrame=new BB.Widgets.IframeBridge({path:"mapiFrame",cssClass:"__streak_PT_mapiFrame"});this._graphContainer.append(this._barChartView.getElement());this._mapContainer.append(this._mapFrame.getFrameElement())},refresh:function(block){var self=this;self._blockContainer.empty();var viewCount=self._getViewCount(block.processedViews);var uniqueViews=self._getUniqueViewCount(block);var viewsHeader=$(self._templates.viewsHeader({viewCount:viewCount,uniqueViews:uniqueViews}));var helpLinkButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:"?",onFunction:function(){BB.Modules.Help.HelpLoader.getHelpViewController().startChapter("Email Tracking FAQ")}});viewsHeader.append(helpLinkButton.getElement());self._viewCountContainer.empty();self._viewCountContainer.append(viewsHeader);self._blockContainer.empty();self._renderGraph(block.views);self._renderMap(block.views);self._renderViewEntries(_.first(block.views,100))},getElement:function(){var self=this;return self._el},_getViewCount:function(processedViews){var totalViewCount=0;_.each(processedViews,function(view){totalViewCount+=view.viewCount});return totalViewCount},_getUniqueViewCount:function(block){return block.processedViews.length},_renderGraph:function(views){var points=this._getViewPoints(views);for(var ii=1;ii<points.length;ii++){points[ii][0]=Streak.Date.create(points[ii][0])}if(points.length===2){var date=points[1][0];points=points.concat([[Streak.Date.create(date).addDays(-1),0],[Streak.Date.create(date).addDays(1),0]])}this._barChartView.setData(points)},_getViewPoints:function(views){var self=this;var viewPointsMap={};_.each(views,function(view){var date=Date.create(view.timestamp);date.resetTime();date=date.getTime();if(!_.isReal(viewPointsMap[date])){viewPointsMap[date]=0}viewPointsMap[date]++});var viewArray=[];_.each(viewPointsMap,function(pointValue,date){viewArray.push([date,pointValue])});viewArray=_.sortBy(viewArray,function(view){return view[0]});var viewPoints=[["Date","Views"]];return viewPoints.concat(viewArray)},_renderMap:function(views){var points=this._getLatPoints(views);if(points&&points.length>0){this._mapFrame.sendMessage("loadMap",points);this._mapContainer.show()}else{this._mapContainer.hide()}},_getLatPoints:function(views){var self=this;return _.chain(views).filter(function(view){return view.requestInformation&&view.requestInformation.latLong&&(view.requestInformation.latLong.latitude!==0||view.requestInformation.latLong.longitude!==0)}).map(function(view){return{lat:view.requestInformation.latLong.latitude,lon:view.requestInformation.latLong.longitude}}).value()},_renderViewEntries:function(views){var self=this;views.reverse();for(var ii=0;ii<views.length;ii++){var renderedMatch=self._renderViewEntry(views[ii]);self._blockContainer.append(renderedMatch)}},_renderViewEntry:function(viewObj){var self=this;var dateTime=self._getDate(viewObj);var relativeTime=Streak.moment(viewObj.timestamp).fromNow();return $(self._templates.entry({name:viewObj.displayName,dateTime:dateTime,longDateTime:relativeTime,location:self._getLocation(viewObj),iconClass:CONSTANTS.DEVICE_MAP[viewObj.requestInformation.device],deviceName:BB.Locale.getString(CONSTANTS.TRANSLATION_MAP[viewObj.requestInformation.device])}))},_getDate:function(viewObj){var timeString="<b>"+Date.create(viewObj.timestamp).customFormat("pixelTrack")+"</b>";return timeString},_getLocation:function(viewObj){var city=viewObj.requestInformation.city;var region=viewObj.requestInformation.region;var regionText;if(city&&city!=="?"){regionText=city.capitalize(true);if(region){regionText+=", "+region.toUpperCase()}}else if(region&&region!=="?"){regionText=region.toUpperCase()}else{regionText=""}return regionText},_bindButtonEvent:function(button){var self=this;button.click(function(){self._callClickDelegates()})},_callClickDelegates:function(){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.lessDetailsLinkClick)){delegate.lessDetailsLinkClick()}});track("pixel_track_show_overview",{source:"detailView"})},destroy:function(){this._mapFrame.destroy();this._blockContainer.remove()},addDelegate:function(delegate){var self=this;self._delegates.push(delegate)}});var CONSTANTS={DEVICE_MAP:{MAC:"streak__macIcon",WINDOWS_PC:"streak__windowsIcon",IPAD:"streak__ipadIcon",IPHONE:"streak__iphoneIcon",ANDROID_PHONE:"streak__androidPhoneIcon",ANDROID_TABLET:"streak__androidTabletIcon",OTHER:"streak__otherDeviceIcon",GMAIL_PROXY:"streak__gmailProxyIcon"},TRANSLATION_MAP:{MAC:"device_mac",WINDOWS_PC:"device_windows_pc",IPAD:"device_ipad",IPHONE:"device_iphone",ANDROID_PHONE:"device_android_phone",ANDROID_TABLET:"device_android_tablet",OTHER:"device_other",GMAIL_PROXY:"device_gmail_proxy"}};var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Modules.TrackedLinkDetailsView=TrackedLinkDetailsView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkDetailsViewController=function(){var self=this;self._delegates=[];self._view=new BB.Modules.TrackedLinkDetailsView;self._view.addDelegate(self)};_.extend(TrackedLinkDetailsViewController.prototype,{addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},getView:function(){var self=this;return self._view},update:function(messageBlock){var self=this;self._view.refresh(messageBlock)},lessDetailsLinkClick:function(){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.lessDetailsLinkClick)){delegate.lessDetailsLinkClick()}})},destroy:function(){this._view.destroy()}});BB.Modules.TrackedLinkDetailsViewController=TrackedLinkDetailsViewController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkOverviewView=function(){var self=this;self._templates={};self._templates.block=HTML.get("pt_overview_block");self._templates.emptyBlock=HTML.get("pt_overview_emptyBlock");self._templates.entry=HTML.get("pt_overview_view_entry");self._templates.viewsHeader=HTML.get("pt_views");self._el=$(HTML.get("pt_overview_block_container")());self._delegates=[]};_.extend(TrackedLinkOverviewView.prototype,{_callDelegatesForClick:function(block){var self=this;_.each(self._delegates,function(delegate){if(_.isReal(delegate.moreDetailsLinkClick)){delegate.moreDetailsLinkClick(block)}})},addDelegate:function(delegate){var self=this;self._delegates.push(delegate)},getElement:function(){var self=this;return self._el},_getProcessedViewCount:function(processedViews){var totalViewCount=0;_.each(processedViews,function(view){totalViewCount+=view.viewCount});return totalViewCount},_getViewCount:function(messageBlocks){var self=this;var total=0;_.each(messageBlocks,function(block){total+=self._getProcessedViewCount(block.processedViews)});return total},_getUniqueViewCount:function(messageBlocks){var self=this;var total=0;_.each(messageBlocks,function(block){total+=block.processedViews.length});return total},refresh:function(messageBlocks){var self=this;self._el.empty();var viewCount=self._getViewCount(messageBlocks);var uniqueViews=self._getUniqueViewCount(messageBlocks);var viewsHeader=$(self._templates.viewsHeader({viewCount:viewCount,uniqueViews:uniqueViews}));var helpLinkButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:"?",onFunction:function(){BB.Modules.Help.HelpLoader.getHelpViewController().startChapter("Email Tracking FAQ")}});viewsHeader.append(helpLinkButton.getElement());self._el.append(viewsHeader);_.each(messageBlocks,function(messageBlock){if(messageBlock.processedViews&&messageBlock.processedViews.length>0){self._renderBlock(messageBlock)}else if(_.isReal(messageBlock).trackedLinks&&messageBlock.trackedLinks.length>0||_.isReal(messageBlock.trackedLink)){self._renderEmptyBlock(messageBlock)}})},_renderEmptyBlock:function(messageBlock){var blockContainer=$(this._templates.emptyBlock());var blockHeight=messageBlock.sidebarGeometry.bottom-messageBlock.sidebarGeometry.top;blockContainer.css({top:messageBlock.sidebarGeometry.top+"px",height:blockHeight+"px"});this._el.append(blockContainer)},_renderBlock:function(messageBlock){var self=this;var blockContainer=$(self._templates.block());var blockHeight=messageBlock.sidebarGeometry.bottom-messageBlock.sidebarGeometry.top;blockContainer.css({top:messageBlock.sidebarGeometry.top+"px",height:blockHeight+"px"});var maxViewsToRender=Math.max(Math.floor((blockHeight-20)/50),0);self._renderViewEntries(blockContainer.find(".streak__pt_viewEntries"),messageBlock.processedViews,maxViewsToRender);blockContainer.find(".streak__pt_detailsLink").click(function(){self._callDelegatesForClick(messageBlock)});this._el.append(blockContainer)},_renderViewEntries:function(parentEl,processedViews,maxViewsToRender){var self=this;for(var ii=0;ii<Math.min(processedViews.length,maxViewsToRender);ii++){var renderedView=self._renderViewEntry(processedViews[ii]);parentEl.append(renderedView)}},_renderViewEntry:function(viewObj){var self=this;var dateTime=self._getDate(viewObj);var longDateTime=Date.create(viewObj.mostRecentView).customFormat("longDateTime");return $(self._templates.entry({name:viewObj.displayName,dateTime:dateTime,longDateTime:longDateTime,location:self._getLocation(viewObj),iconClass:CONSTANTS.DEVICE_MAP[viewObj.requestInformation.device],deviceName:BB.Locale.getString(CONSTANTS.TRANSLATION_MAP[viewObj.requestInformation.device])}))},_getDate:function(viewObj){var timeSummary=Streak.moment(viewObj.mostRecentView).fromNow();
var viewed=Locale.getString("pt_viewed");var timeString=viewed+"<b>"+timeSummary+"</b>";return timeString},_getLocation:function(viewObj){var city=viewObj.requestInformation.city;var region=viewObj.requestInformation.region;var regionText;if(city&&city!=="?"){regionText=city.capitalize(true);if(region){regionText+=", "+region.toUpperCase()}}else if(region&&region!=="?"){regionText=region.toUpperCase()}else{regionText=""}return regionText},refreshingTrackedThread:function(){this._el.find(".pt_views_refreshing").show()},destroy:function(){this._el.remove()}});var CONSTANTS={DEVICE_MAP:{MAC:"streak__macIcon",WINDOWS_PC:"streak__windowsIcon",IPAD:"streak__ipadIcon",IPHONE:"streak__iphoneIcon",ANDROID_PHONE:"streak__androidPhoneIcon",ANDROID_TABLET:"streak__androidTabletIcon",OTHER:"streak__otherDeviceIcon",GMAIL_PROXY:"streak__gmailProxyIcon"},TRANSLATION_MAP:{MAC:"device_mac",WINDOWS_PC:"device_windows_pc",IPAD:"device_ipad",IPHONE:"device_iphone",ANDROID_PHONE:"device_android_phone",ANDROID_TABLET:"device_android_tablet",OTHER:"device_other",GMAIL_PROXY:"device_gmail_proxy"}};BB.Modules.TrackedLinkOverviewView=TrackedLinkOverviewView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkOverviewViewController=function(){var self=this;Streak.ViewControllerBase.call(this);self._view=new BB.Modules.TrackedLinkOverviewView;self._view.addDelegate(self)};TrackedLinkOverviewViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(TrackedLinkOverviewViewController.prototype,{getView:function(){var self=this;return self._view},destroy:function(){var self=this;if(_.isReal(self._view)){self._view.destroy()}},gmailThreadRowsChanged:function(messageBlocks){this._view.refresh(messageBlocks)},moreDetailsLinkClick:function(selectedMessageBlock){this._callDelegateFunction("moreDetailsLinkClick",selectedMessageBlock)},refreshingTrackedThread:function(){this._view.refreshingTrackedThread()},trackedThreadRefreshed:function(){this._view.trackedThreadRefreshed()}});BB.Modules.TrackedLinkOverviewViewController=TrackedLinkOverviewViewController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkInformationView=function(){var self=this;self._delegates=[];self._el=$(HTML.get("pt_info_main_container")());self._activeView=null;self._detailView=null;self._overviewView=null;self._isDetailView=false;self._messageBlocks=null};_.extend(TrackedLinkInformationView.prototype,{setOverviewView:function(view){var self=this;self._overviewView=view;view.getElement().smallHide();self._el.append(view.getElement())},setDetailView:function(view){var self=this;self._detailView=view;view.getElement().smallHide();self._el.append(view.getElement())},detailsDidShow:function(){var self=this;if(_.isReal(self._activeView)){self._activeView.getElement().smallHide()}self._activeView=self._detailView;self._activateNewActiveView();self._isDetailView=true;self._setDetailViewHeight()},overviewDidShow:function(){var self=this;if(_.isReal(self._activeView)){self._activeView.getElement().smallHide()}self._activeView=self._overviewView;self._activateNewActiveView();self._isDetailView=false;self._setOverviewHeight()},gmailThreadRowsChanged:function(messageBlocks){this._messageBlocks=messageBlocks;if(this._isDetailView){this._setDetailViewHeight()}else{this._setOverviewHeight()}},_setOverviewHeight:function(){if(!this._messageBlocks){return}var lastBlock=_.last(this._messageBlocks);this._el.height(lastBlock.geometry.bottom);this._el.removeClass("pt_info_main_container__detailView")},_setDetailViewHeight:function(){if(!this._messageBlocks){return}var lastBlock=_.last(this._messageBlocks);this._el.css("height","");this._el.addClass("pt_info_main_container__detailView")},_activateNewActiveView:function(){var self=this;self._activeView.getElement().smallShow()},getElement:function(){var self=this;return self._el},refresh:function(){var self=this;self._activeView.refresh()},destroy:function(){var self=this;if(_.isReal(self._view)&&_.isReal(self._view.remove)){self._el.remove()}}});var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Modules.TrackedLinkInformationView=TrackedLinkInformationView})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var TrackedLinkInformationViewController=function(){var self=this;Streak.ViewControllerBase.call(this);self._view=new BB.Modules.TrackedLinkInformationView;self._overviewController=new BB.Modules.TrackedLinkOverviewViewController;self._overviewController.addDelegate(self);self._view.setOverviewView(self._overviewController.getView());self._detailsController=new BB.Modules.TrackedLinkDetailsViewController;self._detailsController.addDelegate(self);self._view.setDetailView(self._detailsController.getView());self._viewRefreshCallback=$.noop();self._view.overviewDidShow()};TrackedLinkInformationViewController.prototype=Object.create(Streak.ViewControllerBase.prototype);_.extend(TrackedLinkInformationViewController.prototype,{gmailThreadRowsChanged:function(gmailMessageBlocks){var self=this;self._overviewController.gmailThreadRowsChanged(gmailMessageBlocks);self._view.gmailThreadRowsChanged(gmailMessageBlocks)},moreDetailsLinkClick:function(selectedMessageBlock){var self=this;self._detailsController.update(selectedMessageBlock);self._view.detailsDidShow();self._callDelegateFunction("moreDetailsLinkClick",selectedMessageBlock)},circleDidZoomIn:function(selectedMessageBlock){var self=this;self._detailsController.update(selectedMessageBlock);self._view.detailsDidShow()},circleDidZoomOut:function(){var self=this;self._view.overviewDidShow()},lessDetailsLinkClick:function(){var self=this;self._view.overviewDidShow();self._callDelegateFunction("lessDetailsLinkClick")},refreshingTrackedThread:function(){this._callDelegateFunction("refreshingTrackedThread")},destroy:function(){var self=this;this._overviewController.destroy();this._detailsController.destroy();this._view.destroy()}});BB.Modules.TrackedLinkInformationViewController=TrackedLinkInformationViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Eventer=Streak.Eventer,Gmail=Streak.Gmail,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var PixelTrackerSidebarMasterController={_tabbedSidebarId:null,_trackedThreadSidebar:null,_currentTrackedThread:null,init:function(){this._reset();Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"trackedThread"},functionToCall:this._handleTrackedThreadSet});Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this),null)},_reset:function(){if(this._tabbedSidebarId){BB.Modules.TabbedSidebarMaster.removeSidebar(this._tabbedSidebarId)}if(this._trackedThreadSidebar){this._trackedThreadSidebar.destroy()}this._tabbedSidebarId=null;this._trackedThreadSidebar=null;this._currentBox=null},_handleViewChanged:function(){if(!Gmail.isConversation()){this._reset()}},_handleConversationLoaded:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}var trackedThread=BB.Services.Threads.ThreadStorer.getTrackedThread(hexGmailThreadIdList[0]);if(trackedThread){this._loadTrackedThreadSidebar(trackedThread)}else{this._reset()}},_handleTrackedThreadSet:function(notification){if(!Gmail.isConversationVisible()){return}var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}if(notification.hexGmailThreadId!==hexGmailThreadIdList[0]){return}if(notification.value){var trackedThread=notification.value;if(trackedThread){this._loadTrackedThreadSidebar(trackedThread);return}}this._reset()},_loadTrackedThreadSidebar:function(trackedThread){if(!trackedThread){return}if(!trackedThread.links){return}this._reset();this._currentTrackedThread=trackedThread;this._trackedThreadSidebar=new BB.Modules.PixelTrackerSidebarViewController(trackedThread);this._tabbedSidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:BB.Locale.getString("pixel_track_sidebar_tab_title"),iconClass:this._getTabIconClass(trackedThread),sidebar:this._trackedThreadSidebar,tabIdentifier:"pixelTrackerSidebar"});this._trackedThreadSidebar.matchLinksToMessages()},_getTabIconClass:function(trackedThread){var returnClass="openEyeIcon";if(trackedThread.totalViews){returnClass+=" openEyeIconViewed"}return returnClass}};Streak.DependencyManager.addFunction({functionKey:"pixelTrackerSidebarMasterControllerInitialized",functionReference:PixelTrackerSidebarMasterController.init,functionContext:PixelTrackerSidebarMasterController,dependentFunctionKeys:["tabbedSidebarMasterInitialized","chartsInitialized"]});BB.Controllers.PixelTrackerSidebarMasterController=PixelTrackerSidebarMasterController})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var PixelTrackerOnComposeViewController=Streak.Class.subclass({superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_usedSnippets",destroy:false},{name:"_isTrackedSend",destroy:true},{name:"_shareModal",destroy:true},{name:"_button",destroy:true},{name:"_backupContacts",destroy:false}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this);this._usedSnippets=[];this._guid=null;this._isTrackedSend=false;this._shareModal=null;this._button=null},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupTrackingToggleButton();return this},shouldProcessModification:function(){return BB.Services.PixelTrackingLimiter.isTrackingEnabled()},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"BEFORE_FORMATTING"},getModificationPriority:function(){return 5},getModificationElement:function(){return this._button.getElement()},allModificationsInitialized:function(){if(!this._button){this._setupTrackingToggleButton()}this._isTrackedSend=this._shouldTrackByDefault()&&BB.Services.PixelTrackingLimiter.isTrackingEnabled();if(this._shouldTrack()&&this._overLimit()){this._setCurrentTrackingStatusOff(BB.Locale.getString("tracking_over_limit"));this._showShareModalOnOpen();return}if(this._shouldTrack()){this._setCurrentTrackingStatusOn()}else{this._setCurrentTrackingStatusOff()}},_overLimit:function(){return!BB.Services.PixelTrackingLimiter.canTrackEmails()},turnOffTracking:function(){this._setCurrentTrackingStatusOff();this._composeWindowViewController.setModuleInactive("pixelTracking");this._composeWindowViewController.notify("pixelTrackingOff")},sendLaterScheduled:function(){this._button.disable();this._setCurrentTrackingStatusOff(BB.Locale.getString("tracking_off_because_send_later"))},sendLaterCancelled:function(){this._button.enable()},_setupTrackingToggleButton:function(){var self=this;this._button=BB.Widgets.Buttons.ButtonFactory.createButton({type:"GmailIcon",color:"icon",iconClass:"streak__pixelTrackerIconOnCompose",onFunction:function(){self._toggleTracking()}});this._button.addClass("streak__pixelTrackerOnComposeButton");Streak.NotificationCenter.subscribe({eventName:"defaultTrackingSettingChanged",functionToCall:this._notificationToggleTracking,observer:this})},_notificationToggleTracking:function(){if(this._shouldTrackByDefault()){this._setCurrentTrackingStatusOn()}else{this._setCurrentTrackingStatusOff()}},_toggleTracking:function(){if(!BB.Services.PixelTrackingLimiter.canTrackEmails()){this._showShareModal();return}if(this._shouldTrack()){this._setTrackingOff();BB.Tracker.track("pixel tracking toggled on")}else{this._setTrackingOn();BB.Tracker.track("pixel tracking toggled off")}},_setTrackingOn:function(){track("pixel_track_disable");this._setCurrentTrackingStatusOn();this._composeWindowViewController.setModuleActive("pixelTracking");this._composeWindowViewController.notify("pixelTrackingOn")},_setTrackingOff:function(){track("pixel_track_enable");this._setCurrentTrackingStatusOff();this._composeWindowViewController.setModuleInactive("pixelTracking");this._composeWindowViewController.notify("pixelTrackingOff")},_setCurrentTrackingStatusOn:function(){this._isTrackedSend=true;this._button.removeClass("streak__pixelTrackerIcon_unselected");this._button.addClass("streak__pixelTrackerIcon_selected");this._button.setTooltip(BB.Locale.getString("pixel_track_current_on"));if(this._composeWindowViewController){this._composeWindowViewController.setModuleActive("pixelTracking");this._composeWindowViewController.notify("pixelTrackingOn")}},_setCurrentTrackingStatusOff:function(tooltip){this._isTrackedSend=false;this._button.removeClass("streak__pixelTrackerIcon_selected");this._button.addClass("streak__pixelTrackerIcon_unselected");if(tooltip){this._button.setTooltip(tooltip)}else{this._button.setTooltip(BB.Locale.getString("pixel_track_current_off"))}if(this._composeWindowViewController){this._composeWindowViewController.setModuleInactive("pixelTracking");this._composeWindowViewController.notify("pixelTrackingOff")}},_setSavedTrackingStatus:function(value){BB.UserSettings.set("pixelTracker/shouldTrack",value);BB.UserSettings.saveSettings()},_shouldTrackByDefault:function(){return BB.Data.streakSettings.settingIsEnabled("tracking_default_on_setting")},_shouldTrack:function(){return this._isTrackedSend&&this._composeWindowViewController.getActiveModules().indexOf("sendLater")===-1},aboutToSend:function(){if(this._shouldTrack()){this._injectTrackingHTML();this._backupContacts=this._composeWindowViewController.getToContacts();Streak.NotificationCenter.subscribe({eventName:"rfcMessageIdForSentEmailFound",filterParameters:{composeid:this._composeWindowViewController.getComposeid()},observer:this,functionToCall:function(notification){this._createTrackedLink(this._guid,notification.threadMetaData,this._getUsedSnippetKeys())}})}},_showShareModalOnOpen:function(){if(BB.Services.PixelTrackingLimiter.shouldShowShareModalOnOpen()){}},_showShareModal:function(){this._shareModal=Streak.Library.getInstance("BentoBox.Modules.PixelTrackingShareModalViewController");this._shareModal.show(function(){});BB.Services.PixelTrackingLimiter.registerSeenShareModal()},_injectTrackingHTML:function(){this._guid=BB.PixelTrackingHTMLGenerator.injectTrackingHTML(this._composeWindowViewController)},_createTrackedLink:function(guid,threadMetaData,snippetKeyList){var threadId=threadMetaData.hexGmailThreadId;var rfcMessageId=threadMetaData.rfcMessageId;var subject=threadMetaData.subject;var emails=threadMetaData.emailAddresses;var names=threadMetaData.names;if(!emails||!names||emails.length===0||names.length===0){emails=this._getBackupEmailAddresses();names=this._getBackupNames()}var trackedLink=new Streak.BentoBox.Models.TrackedLink({guid:guid,hexGmailThreadId:threadId,subject:subject,names:names,emails:emails,snippetKeyList:snippetKeyList,isMailMerge:false,rfcMessageId:rfcMessageId});trackedLink.save();Streak.NotificationCenter.postNotification({eventName:"trackedEmailSent",sender:this});BB.Modules.PixelTrackerConversationImageFixer.sendIgnoreImageRequest(guid);track("pixel_track_email_sent")},snippetAdded:function(snippet){this._usedSnippets.push(snippet)},mailHelperSendingEmails:function(){this._isTrackedSend=false},_getUsedSnippetKeys:function(){return _.map(this._usedSnippets,function(snippet){return snippet.key()})},_getBackupEmailAddresses:function(){if(!this._backupContacts){return[]}return _.pluck(this._backupContacts,"emailAddress")},_getBackupNames:function(){if(!this._backupContacts){return[]}return _.pluck(this._backupContacts,"name")},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});BB.Modules.ComposeViewControllerBase.prototype.destroy.call(this)}});var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};BB.Modules.PixelTrackerOnComposeViewController=PixelTrackerOnComposeViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackerOnComposeMasterController=function(){Gmail.GmailComposeManager.registerModifierModule(this)};_.extend(PixelTrackerOnComposeMasterController.prototype,{getViewControllers:function(){return new BB.Modules.PixelTrackerOnComposeViewController}});DependencyManager.addFunction({functionKey:"pixelTrackerOnComposeMasterControllerInitialized",functionToCall:function(callback){if(!BB.Modules.PixelTrackerOnComposeMasterController){BB.Modules.PixelTrackerOnComposeMasterController=new PixelTrackerOnComposeMasterController}if(callback){callback()}},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","gmailLoaded","userLoggedIn","pixelTrackingLimiterInitialized","data.streakSettings.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,Gmail=Streak.Gmail,HTML=Streak.HTML,Locale=Streak.Locale,BB=Streak.BentoBox,_=Streak._;var PixelTrackerOnReplyViewController=Streak.Class.subclass({superclass:BB.Modules.PixelTrackerOnComposeViewController,_memberVariables:[{name:"_threadId",destroy:false}],initialize:function(composeWindowViewController){BB.Modules.PixelTrackerOnComposeViewController.prototype.initialize.call(this,composeWindowViewController)},_showShareModalOnOpen:function(){},aboutToSend:function(){if(!this._shouldTrack()){return}this._injectTrackingHTML();var threadMetaData=this._getReplyThreadMetaData();var guid=this._guid;var snippetKeyList=this._getUsedSnippetKeys();var self=this;Gmail.RFCMessageIdExtractor.getRFCMessageIdForThread(threadMetaData.hexGmailThreadId,function(rfcMessageId){if(!rfcMessageId){return}threadMetaData.rfcMessageId=rfcMessageId;self._createTrackedLink(guid,threadMetaData,snippetKeyList)});BB.Tracker.track("pixel tracking send tracked reply")},_getReplyThreadMetaData:function(){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(!hexGmailThreadIdList||hexGmailThreadIdList.length===0){return}var threadMetaData=this._composeWindowViewController.getThreadMetaData();threadMetaData.hexGmailThreadId=hexGmailThreadIdList[0];return threadMetaData}});BB.Modules.PixelTrackerOnReplyViewController=PixelTrackerOnReplyViewController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackerOnReplyMasterController=function(){Gmail.GmailReplyManager.registerModifierModule(this)};_.extend(PixelTrackerOnReplyMasterController.prototype,{getViewControllers:function(){return[new BB.Modules.PixelTrackerOnReplyViewController]}});DependencyManager.addFunction({functionKey:"pixelTrackerOnReplyMasterControllerInitialized",functionToCall:function(callback){if(!BB.Modules.PixelTrackerOnReplyMasterController){BB.Modules.PixelTrackerOnReplyMasterController=new PixelTrackerOnReplyMasterController}if(callback){callback()}},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","gmailLoaded","userLoggedIn","pixelTrackingLimiterInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,Locale=Streak.Locale,HTML=Streak.HTML,Data=Streak.BentoBox.Data,BB=Streak.BentoBox;var CONSTANTS={TRACKED_KEY:"ᐧ",URL_KEY:"%E1%90%A7",SEARCH_URL:"%E1%90%A7+from%3Ame",SEARCH_REPLACEMENT:"has:tracking"};CONSTANTS.TRACKED_KEY_REGEX=new RegExp('"?'+CONSTANTS.TRACKED_KEY+'"?',"img");CONSTANTS.REPLACE_KEY_REGEX=new RegExp(CONSTANTS.SEARCH_REPLACEMENT,"img");var PixelTrackerSearch={CONSTANTS:CONSTANTS,_sentMailLink:null,_searchLink:null,_expando:null,init:function(callback){if(!BB.Services.PixelTrackingLimiter.isTrackingEnabled()){if(callback){callback()}return}if(!this._isSentMailLinkValid()){BB.logError("sent mail left link not found")}else{this._setupSearchLink();this._setupSearchButtonObserver()}if(callback){callback()}},_isSentMailLinkValid:function(){var sentMailLink=Gmail.getSentMailLink();if(!sentMailLink||sentMailLink.length===0){return false}return true},_setupSearchLink:function(){Gmail.GmailLeftNavManipulator.addNewLink({getUrl:function(){return"search/"+CONSTANTS.SEARCH_URL},getNavRelativeLabel:function(){return"sent"},getNavRelativeLocation:function(){return"NESTED"},getNavLinkName:function(){return BB.Locale.getString("pixel_track_left_link")},getClass:function(){return"streak__pixelTrackerSearchLink"}})},_setupSearchButtonObserver:function(){Gmail.GmailSearchBarContentReplacer.addManipulation({applyDisplayManipulation:function(searchText){return searchText.replace(CONSTANTS.TRACKED_KEY_REGEX,CONSTANTS.SEARCH_REPLACEMENT)},applyValueManipulation:function(searchText){return searchText.replace(CONSTANTS.REPLACE_KEY_REGEX,'"'+CONSTANTS.TRACKED_KEY+'"')}})}};Streak.DependencyManager.addFunction({functionKey:"pixelTrackerSearchInitialized",functionToCall:PixelTrackerSearch.init,functionContext:PixelTrackerSearch,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","userLoggedIn","pixelTrackingLimiterInitialized","userSettingsInitialized"]});BB.Modules.PixelTrackerSearch=PixelTrackerSearch;var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,APIRequester=Streak.APIRequester,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var IGNORE_IMAGE_WAIT_TIME=5*1e3;var PixelTrackerConversationImageFixer=Streak.Class.subclass({className:"PixelTrackerConversationImageFixer",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);Streak.DomWatcher.watchForNewSelector("[role=main] .h7 .Bk > div",this._handleConversationMessageLoaded.bind(this));Streak.DomWatcher.watchForNewSelector("[contenteditable=true]",this._handleEditorLoaded.bind(this));Streak.DomWatcher.watchForNewSelector("[contenteditable=true] > .gmail_extra",this._handleConversationMessageLoaded.bind(this));NotificationCenter.subscribe({eventName:"newReplyArea",functionToCall:this._newReplyArea,observer:this})},_handleEditorLoaded:function(editorNode){this._handleConversationMessageLoaded(editorNode);$(editorNode).find('[hspace="streak-pt-mark"]').remove()},_handleConversationMessageLoaded:function(messageNode){var markerNodes=$(messageNode).find('[hspace="streak-pt-mark"]');for(var ii=0;ii<markerNodes.length;ii++){this._processMarkerNode(markerNodes[ii])}},_processMarkerNode:function(markerNode){var node=$(markerNode);var guid=this._extractGuid(node);if(!guid){return}this.sendIgnoreImageRequest(guid)},_extractGuid:function(node){var img=node.find("img");if(!img||img.length===0){return null}return this._extractGuidFromURL(img[0].src)},_newReplyArea:function(eventParameters){var replyAreaViewController=eventParameters.replyAreaController;var draftValue=replyAreaViewController.getHiddenDraftValue();if(draftValue.indexOf("guid=")===-1){return}if(draftValue.indexOf("<img")===-1){return}draftValue=draftValue.replace(/\<img/gim,"<fakeimage");var div=Streak.$(document.createElement("div"));div[0].innerHTML=draftValue;var fakeImages=div.find("fakeimage");for(var ii=0;ii<fakeImages.length;ii++){this._processFakeImage(fakeImages[ii])}},_processFakeImage:function(fakeImageNode){var node=$(fakeImageNode);var guid=this._extractGuidFromURL(node.attr("src"));if(!guid){return}this.sendIgnoreImageRequest(guid)},_extractGuidFromURL:function(src){if(!src){return}var parts=src.split("#");var unproxiedURL=parts[0];if(parts.length>1){unproxiedURL=parts[1]}if(unproxiedURL.indexOf("mailfoo")===-1&&unproxiedURL.indexOf("streak")===-1){return}if(unproxiedURL.indexOf("sender=")>-1){if(this._doesNotContainUserEmail(unproxiedURL)){return}}var index=src.indexOf("guid=");if(index===-1){return}return src.substring(index+5)},_doesNotContainUserEmail:function(unproxiedURL){var encodedEmail=encodeURIComponent(BB.getUser().getEmail());var base64EncodedEmail=BB.PixelTrackingHTMLGenerator.getEncodedEmailAddress();return unproxiedURL.indexOf("sender="+encodedEmail)===-1&&unproxiedURL.indexOf("sender="+BB.getUser().getEmail())===-1&&unproxiedURL.indexOf("sender="+base64EncodedEmail)===-1},sendIgnoreImageRequest:function(guid){var self=this;setTimeout(function(){APIRequester.put("trackedlinks/"+guid+"/ignoredviews")},IGNORE_IMAGE_WAIT_TIME)}});Streak.DependencyManager.addFunction({functionKey:"pixelTrackerConversationImageFixerInitialized",functionToCall:function(callback){Library.set("BentoBox.Modules.PixelTrackerConversationImageFixer",new PixelTrackerConversationImageFixer);if(callback){callback()}},dependentFunctionKeys:["gmailLoaded","userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Bar={defaults:{showLeft:true,showRight:true,cancelFunc:$.noop,leftButtonFunction:$.noop,rightButtonFunction:$.noop,leftButtonText:"Previous",rightButtonText:"Next",rightButtonHTML:null,leftButtonHTML:null,leftButtonColor:"blue",rightButtonColor:"blue",showRightButton:true,showLeftButton:true,hideLeftButton:true,html:"",customClasses:"",linkText:"Exit Tour",showLink:true},templates:{},create:function(options){this._init();var o={};$.extend(o,this.defaults,options);return new this.impl(o,this.defaults)},_init:function(){if(!this.templates.Bar){this.templates.Bar=HTML.get("TourBar")}}};Bar.impl=function(_options,defaults){var htmlElements=[];var _bar=null;var self=this;self.options=_options;self.defaults=defaults;var reuse=function(_options){var o={};$.extend(o,self.defaults,_options);self.options=o;refresh()};var refresh=function(){self._barHTML.children(".barContent").append(self.options.html);$(self._barHTML).addClass(self.options.customClasses);self._rButton.setOnFunc(self.options.rightButtonFunction);$(self._rButton.el).html(self.options.rightButtonText);var rDisplay=self.options.showRightButton?"visible":"hidden";$(self._rButton.el).css("visibility",rDisplay);self._lButton.setOnFunc(self.options.leftButtonFunction);$(self._lButton.el).html(self.options.leftButtonText);var lDisplay=self.options.showLeftButton?"visible":"hidden";$(self._lButton.el).css("visibility",lDisplay);if(self.options.hideLeftButton){$(self._lButton.el).hide()}};var show=function(){var barHTMLString=Bar.templates.Bar({content:""});var barHTML=$(barHTMLString);barHTML.append(self.options.html);self._barHTML=barHTML;var lButton=BB.Widgets.Button.create({name:self.options.leftButtonText,color:self.options.leftButtonColor,onFunc:self.options.leftButtonFunction});barHTML.addClass(self.options.customClasses);barHTML.children(".__streak_barLeftButton").append($(lButton.el));if(!self.options.showLeftButton){$(lButton.el).css("visibility","hidden")}self._lButton=lButton;var rButton=BB.Widgets.Button.create({name:self.options.rightButtonText,color:self.options.rightButtonColor,onFunc:function(){self.options.rightButtonFunction()}});barHTML.children(".barRightButton").append($(rButton.el));self._rButton=rButton;if(!self.options.showRightButton){rButton.el.css("visibility","hidden")}if(self.options.showLink){if(!self.options.showLeftButton&&!self.options.showRightButton){barHTML.find(".__streak_barLeftButton").hide();barHTML.find(".barRightButton").hide();barHTML.find(".streakTourBarOr").hide()}var link=barHTML.find(".streakTourBarExit");link.click(self.options.cancelFunc)}barHTML.appendTo(Streak.Gmail.elements.body);htmlElements.push(barHTML);_bar=barHTML},hide=function(){_.each(htmlElements,function(element){$(element).hide()})};unhide=function(){_.each(htmlElements,function(element){$(element).show()})};destroy=function(){_.each(htmlElements,function(element){$(element).remove()})};return{show:show,hide:hide,unhide:unhide,destroy:destroy,reuse:reuse,getType:function(){return"BAR"}}};BB.Widgets.Tour=BB.Widgets.Tour||{};BB.Widgets.Tour.Bar=Bar})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Highlight={defaults:{targetElement:null,clickCallback:$.noop,buffer:5},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};Highlight.impl=function(options){var uiElements={};var createDiv=function(css,id,borderHighlight){var div=uiElements[id];if(!div){div=$("<div> </div>");div.addClass("tour_highlight");if(borderHighlight){div.addClass("tour_highlight_border tour_highlight_border_"+borderHighlight)}if(_.isReal(options.backgroundOpacity)){div.css({opacity:options.backgroundOpacity})}$(Streak.Gmail.elements.body).append(div)}div.unbind("click").click(function(){options.clickCallback()});div.css(css);uiElements[id]=div};var createTopLeft=function(el){createDiv({left:0,width:Math.max(elementCoordinates.topLeft.x,0)+"px",top:0,height:Math.max(elementCoordinates.topLeft.y,0)+"px"},"topLeft")};var createTop=function(el){createDiv({left:elementCoordinates.topLeft.x+"px",top:0,width:Math.max(elementCoordinates.width,0)+"px",height:Math.max(elementCoordinates.topLeft.y,0)+"px"},"top","bottom")};var createTopRight=function(el){createDiv({left:elementCoordinates.bottomRight.x+"px",right:0,top:0,height:Math.max(elementCoordinates.topLeft.y,0)+"px"},"topRight")};var createLeft=function(el){createDiv({left:0,width:Math.max(elementCoordinates.topLeft.x,0)+"px",top:0,bottom:0},"left","right")};var createRight=function(el){createDiv({left:elementCoordinates.bottomRight.x+"px",right:0,top:0,bottom:0},"right","left")};var createBottomLeft=function(){createDiv({bottom:0,top:elementCoordinates.bottomRight.y+"px",left:0,width:Math.max(elementCoordinates.topLeft.x,0)+"px"},"bottomLeft")};var createBottom=function(el){createDiv({top:elementCoordinates.bottomRight.y+"px",left:elementCoordinates.topLeft.x+"px",width:Math.max(elementCoordinates.width,0)+"px",bottom:0},"bottom","top")};var createBottomRight=function(){createDiv({top:elementCoordinates.bottomRight.y+"px",left:elementCoordinates.bottomRight.x+"px",right:0,bottom:0},"bottomRight")};var elementCoordinates={topLeft:{x:0,y:0},bottomRight:{x:0,y:0}};var interval=null;var destroyed=false;var show=function(){destroyed=false;$(window).unbind("resize",position);$(window).bind("resize",position);interval=_.repeatEvery(position,2e3)};var position=function(){var buffer=options.buffer;var target=$(options.targetElement||options.targetSelector);if(target.length===0||destroyed){destroy();return}elementCoordinates.topLeft.x=target.offset().left-buffer;elementCoordinates.topLeft.y=target.offset().top-buffer;elementCoordinates.bottomRight.x=target.offset().left+target.outerWidth()+buffer;elementCoordinates.bottomRight.y=target.offset().top+target.outerHeight()+buffer;elementCoordinates.width=target.outerWidth()+2*buffer;elementCoordinates.height=target.outerHeight()+2*buffer;createTop();createLeft();createRight();createBottom()};var hide=function(){for(var key in uiElements){uiElements[key].hide()}};var unhide=function(){for(var key in uiElements){uiElements[key].show()}};var destroy=function(){destroyed=true;if(interval){interval.stop()}for(var key in uiElements){uiElements[key].remove()}uiElements={};$(window).unbind("resize",position)};var reuse=function(newOptions){_.extend(options,newOptions)};return{show:show,hide:hide,unhide:unhide,destroy:destroy,reuse:reuse,getType:function(){return"HIGHLIGHT"}}};BB.Widgets.Tour=BB.Widgets.Tour||{};BB.Widgets.Tour.Highlight=Highlight
})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var TourModal=function(options){BB.Widgets.Widget.call(this,options);for(var key in this.options){this.options[key]=BB.UI.processString(this.options[key])}var options={inner:options.html,escClose:false,showCancel:options.showLeftButton,cancelText:options.leftButtonText,cancelButtonColor:options.leftButtonColor,showConfirm:options.showRightButton,confirmText:options.rightButtonText,close:false,force:true,overlayCss:{backgroundColor:"black"},opacity:65,dontStack:true};this.options=_.extend({},TourModal.prototype.defaults,options,this.options);this._modal=BB.Widgets.Modal.create(this.options)};TourModal.prototype=Object.create(BB.Widgets.Widget.prototype);_.extend(TourModal.prototype,{show:function(){return this._modal.show()},destroy:function(){if(this._modal.getEl().is(":FastVisible")){$.modal.close()}},defaults:{showLink:false,linkText:"Exit",linkFunction:$.noop}});TourModal.create=function(options){return new TourModal(options)};BB.Widgets.Tour=BB.Widgets.Tour||{};BB.Widgets.Tour.TourModal=TourModal})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var Overlay={defaults:{tips:[],infoCss:{},infoTop:"50%",infoLeft:"50%",infoHTML:"",infoDescription:"",showRightButton:true,showLeftButton:true,leftButtonFunction:$.noop,rightButtonFunction:$.noop,leftButtonText:"Previous",rightButtonText:"Next",rightButtonHTML:null,leftButtonHTML:null,leftButtonColor:"blue",rightButtonColor:"blue",showInfo:true,overlayColor:"black",opacity:.65},create:function(options){var o={};$.extend(o,this.defaults,options);return new this.impl(o)}};Overlay.impl=function(options){var dirtyUIElements=[];var miniTips=[];var self=this;var bgBlackout;var reuse=function(_options){var o={};$.extend(o,self.defaults,_options);self.options=o;refresh()};var refresh=function(){destroyElements(miniTips);generateMiniTips(self.options.tips)};var generateMiniTips=function(tips){try{_.each(tips,function(tip){var minitip=createMiniTooltip(tip);dirtyUIElements.push(minitip);miniTips.push(minitip)})}catch(e){}};var showOverlay=function(){bgBlackout=createShadowBackground(options.overlayColor,9997,options.opacity);dirtyUIElements.push(bgBlackout);if(options.showInfo){var infoContainer=$("<div> </div>");infoContainer.append(options.infoHTML);infoContainer.append('<div class="overlayButtons"></div>');infoContainer.css({position:"fixed",top:options.infoTop,left:options.infoLeft,zIndex:9998,color:"white"});infoContainer.css(options.infoCss);dirtyUIElements.push(infoContainer);Streak.Gmail.elements.body.append(infoContainer);if(options.showLeftButton){var lButton=BB.Widgets.Button.create({name:options.leftButtonText,color:options.leftButtonColor,onFunc:options.leftButtonFunction});$(infoContainer).children(".overlayButtons").append($(lButton.el))}if(options.showRightButton){var rButton=BB.Widgets.Button.create({name:options.rightButtonText,color:options.rightButtonColor,onFunc:function(){options.rightButtonFunction()}});$(infoContainer).children(".overlayButtons").append($(rButton.el))}}generateMiniTips(options.tips)},createShadowBackground=function(color,zIndex,opacity){var blackout=$(Streak.document.createElement("div"));blackout.addClass("tour-overlay");blackout.css("zIndex",zIndex||9997);blackout.css("opacity",opacity||.5);blackout.css("background",color);Streak.Gmail.elements.body.append(blackout);dirtyUIElements.push(blackout);return blackout},createMiniTooltip=function(tip){jqueryObj=$(tip.targetElement);var zIndex=tip.zIndex||9999;var stickyRight=tip.stickyRight;var offset=jqueryObj.offset();var blankDiv=$(document.createElement("div"));blankDiv.addClass("bbOverlayTip");blankDiv.html(tip.description);if(jqueryObj.length>0){var topBuffer=15;var leftBuffer=0;var rightBuffer=10;var newTop=offset.top+topBuffer+jqueryObj.height();var newLeft=offset.left+leftBuffer;var newRight=offset.left-rightBuffer+jqueryObj.width();newRight=$(Gmail.elements.body).width()-newRight;if(stickyRight){blankDiv.css("right",newRight+"px")}else{blankDiv.css("left",newLeft+"px")}blankDiv.css("position","fixed");blankDiv.css("color","white");blankDiv.css("zIndex",zIndex);blankDiv.css("top",newTop+"px");var underline=$(document.createElement("div"));underline.css("width",jqueryObj.width()+"px");underline.css("height","2px");underline.css("position","fixed");underline.css("background","white");underline.css("zIndex",zIndex||9999);underline.css("top",newTop-topBuffer+"px");$(blankDiv).append(underline);if(stickyRight){underline.css("right",newRight+"px")}else{underline.css("left",newLeft+"px")}var verticalLine=$(document.createElement("div"));verticalLine.css("width","2px");verticalLine.css("height","14px");verticalLine.css("position","fixed");verticalLine.css("background","white");verticalLine.css("zIndex",zIndex);verticalLine.css("top",newTop-topBuffer+"px");$(blankDiv).append(verticalLine);if(stickyRight){verticalLine.css("right",newRight+10+"px")}else{verticalLine.css("left",newLeft+10+"px")}}if(tip.buttons&&tip.buttons.length>0){var buttonOverlay=$('<div class="overlayButtons"></div>');for(var i=0;i<tip.buttons.length;i++){var button=BB.Widgets.Button.create({name:tip.buttons[i].name,color:tip.buttons[i].color||"blue",onFunc:tip.buttons[i]["function"]});buttonOverlay.append(button.el)}blankDiv.append(buttonOverlay)}$(Streak.Gmail.elements.body).append(blankDiv);return blankDiv};var destroyElements=function(elements){_.each(elements,function(domElement){$(domElement).remove()});elements=[]};var cleanUpUIElements=function(){destroyElements(dirtyUIElements)};return{show:showOverlay,reuse:reuse,destroy:cleanUpUIElements,getType:function(){return"OVERLAY"}}};BB.Widgets.Tour=BB.Widgets.Tour||{};BB.Widgets.Tour.Overlay=Overlay})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var jQuery=$;var Tooltip={create:function(o){return new this.impl(o)}};Tooltip.impl=function(o){var options=o;return guiders.createGuider(options)};var guiders=function($){var guiders={};guiders.version="1.3.0";guiders._defaultSettings={attachTo:null,autoFocus:false,buttons:[{name:"Close"}],buttonCustomHTML:"",classString:null,closeOnEscape:false,description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.",highlight:null,isHashable:true,offset:{top:null,left:null},onClose:null,onHide:null,onShow:null,overlay:false,position:0,shouldSkip:function(){},title:null,width:400,xButton:false,bottomLink:null};guiders._htmlSkeleton=["<div class='guider'>","  <div class='guiders_content'>","    <div class='guiders_title Kj-JD-K7'></div>","    <div class='guiders_close'></div>","    <p class='guiders_description'></p>","    <div class='guiders_buttons_container'>","    </div>","    <div class='guiders_link'>","    </div>","  </div>","  <div class='guiders_arrow'>","    <div class='guiders_arrow_inner'>","    </div>","  </div>","</div>"].join("");guiders._arrowSize=42;guiders._backButtonTitle="Back";guiders._buttonAttributes={href:"#"};guiders._buttonClassName="guiders_button";guiders._buttonClickEvent="click touch";guiders._buttonElement="<a></a>";guiders._closeButtonTitle="Close";guiders._currentGuiderID=null;guiders._fixedOrAbsolute="fixed";guiders._guiders=[];guiders._lastCreatedGuiderID=null;guiders._nextButtonTitle="Next";guiders._offsetNameMapping={topLeft:11,top:12,topRight:1,rightTop:2,right:3,rightBottom:4,bottomRight:5,bottom:6,bottomLeft:7,leftBottom:8,left:9,leftTop:10};guiders._windowHeight=0;var ieBrowserMatch=navigator.userAgent.match("MSIE (.)");guiders._isIE=ieBrowserMatch&&ieBrowserMatch.length>1;guiders._ieVersion=ieBrowserMatch&&ieBrowserMatch.length>1?Number(ieBrowserMatch[1]):-1;guiders._addButtons=function(myGuider){var guiderButtonsContainer=myGuider.elem.find(".guiders_buttons_container");if(myGuider.buttons===null||myGuider.buttons.length===0){guiderButtonsContainer.remove();return}myGuider.buttons=myGuider.buttons.reverse();for(var i=myGuider.buttons.length-1;i>=0;i--){var button=myGuider.buttons[i];var rButton=BB.Widgets.Button.create({name:button.name,color:button.color||"blue",onFunc:button.onclick||button.function});guiderButtonsContainer.append($(rButton.el))}if(myGuider.bottomLink&&myGuider.bottomLink.visible){var bottomLink=$('<a href="#">'+myGuider.bottomLink.text+"</a>");myGuider.elem.find(".guiders_link").append(bottomLink);bottomLink.click(function(e){if(myGuider.bottomLink["function"]){myGuider.bottomLink["function"]()}e.preventDefault();e.stopPropagation()})}else{myGuider.elem.find(".guiders_link").hide()}if(myGuider.buttonCustomHTML!==""){var myCustomHTML=$(myGuider.buttonCustomHTML);myGuider.elem.find(".guiders_buttons_container").append(myCustomHTML)}if(myGuider.buttons.length===0){guiderButtonsContainer.remove()}};guiders._addXButton=function(myGuider){var xButtonContainer=myGuider.elem.find(".guiders_close");var xButton=$("<div></div>",{"class":"guiders_x_button",role:"button"});xButtonContainer.append(xButton);xButton.click(function(){guiders.hideAll();if(myGuider.onClose){myGuider.onClose(myGuider,true)}})};guiders._attach=function(myGuider){if(typeof myGuider!=="object"){return}var attachTo=$(myGuider.attachTo);var myHeight=myGuider.elem.innerHeight();var myWidth=myGuider.elem.innerWidth();if(myGuider.position===0||attachTo.length===0){var fixedOrAbsolute="fixed";if(guiders._isIE&&guiders._ieVersion<9){fixedOrAbsolute="absolute"}myGuider.elem.css("position",fixedOrAbsolute);myGuider.elem.css("top",($(window).height()-myHeight)/3+"px");myGuider.elem.css("left",($(window).width()-myWidth)/2+"px");return}var base=attachTo.offset();var top=base.top;var left=base.left;var topMarginOfBody=$("body").outerHeight(true)-$("body").outerHeight(false);top-=topMarginOfBody;if(guiders._offsetNameMapping[myGuider.position]){myGuider.position=guiders._offsetNameMapping[myGuider.position]}var attachToHeight=attachTo.innerHeight();var attachToWidth=attachTo.innerWidth();var bufferOffset=.9*guiders._arrowSize;var offsetMap={1:[-bufferOffset-myHeight,attachToWidth-myWidth],2:[0,bufferOffset+attachToWidth],3:[attachToHeight/2-myHeight/2,bufferOffset+attachToWidth],4:[attachToHeight-myHeight,bufferOffset+attachToWidth],5:[bufferOffset+attachToHeight,attachToWidth-myWidth],6:[bufferOffset+attachToHeight,attachToWidth/2-myWidth/2],7:[bufferOffset+attachToHeight,0],8:[attachToHeight-myHeight,-myWidth-bufferOffset],9:[attachToHeight/2-myHeight/2,-myWidth-bufferOffset],10:[0,-myWidth-bufferOffset],11:[-bufferOffset-myHeight,0],12:[-bufferOffset-myHeight,attachToWidth/2-myWidth/2]};var offset=offsetMap[myGuider.position];top+=offset[0];left+=offset[1];var positionType="absolute";if(attachTo.css("position")==="fixed"&&guiders._fixedOrAbsolute==="fixed"){positionType="fixed";top-=$(window).scrollTop();left-=$(window).scrollLeft()}if(myGuider.offset.top!==null){top+=myGuider.offset.top}if(myGuider.offset.left!==null){left+=myGuider.offset.left}guiders._styleArrow(myGuider);myGuider.elem.css({position:positionType,top:top,left:left});return myGuider};guiders._styleArrow=function(myGuider){var position=myGuider.position||0;if(!position){return}var myGuiderArrow=$(myGuider.elem.find(".guiders_arrow"));var newClass={1:"guiders_arrow_down",2:"guiders_arrow_left",3:"guiders_arrow_left",4:"guiders_arrow_left",5:"guiders_arrow_up",6:"guiders_arrow_up",7:"guiders_arrow_up",8:"guiders_arrow_right",9:"guiders_arrow_right",10:"guiders_arrow_right",11:"guiders_arrow_down",12:"guiders_arrow_down"};myGuiderArrow.addClass(newClass[position]);var myHeight=myGuider.elem.innerHeight();var myWidth=myGuider.elem.innerWidth();var arrowOffset=guiders._arrowSize/2;var positionMap={1:["right",arrowOffset],2:["top",arrowOffset],3:["top",myHeight/2-arrowOffset-20],4:["bottom",arrowOffset],5:["right",arrowOffset],6:["left",myWidth/2-arrowOffset-20],7:["left",arrowOffset],8:["bottom",arrowOffset],9:["top",myHeight/2-arrowOffset-20],10:["top",arrowOffset],11:["left",arrowOffset],12:["left",myWidth/2-arrowOffset-20]};var position=positionMap[myGuider.position];myGuiderArrow.css(position[0],position[1]+"px")};guiders._showIfHashed=function(myGuider){var GUIDER_HASH_TAG="guider=";var hashIndex=window.location.hash.indexOf(GUIDER_HASH_TAG);if(hashIndex!==-1){var hashGuiderId=window.location.hash.substr(hashIndex+GUIDER_HASH_TAG.length);if(myGuider.id.toLowerCase()===hashGuiderId.toLowerCase()){guiders.show(myGuider.id)}}};guiders.reposition=function(){for(var i=0;i<guiders._guiders.length;i++){guiders._attach(guiders._guiders[i])}};guiders.createGuider=function(passedSettings){if(passedSettings===null||passedSettings===undefined){passedSettings={}}var myGuider=$.extend({},guiders._defaultSettings,passedSettings);myGuider.id=myGuider.id||String(Math.floor(Math.random()*1e3));var guiderElement=$(guiders._htmlSkeleton);myGuider.elem=guiderElement;if(typeof myGuider.classString!=="undefined"&&myGuider.classString!==null){myGuider.elem.addClass(myGuider.classString)}myGuider.elem.css("width",myGuider.width+"px");var guiderTitleContainer=guiderElement.find(".guiders_title");if(myGuider.title){guiderTitleContainer.html(myGuider.title)}else{guiderTitleContainer.hide()}guiderElement.find(".guiders_description").html(myGuider.description);guiders._addButtons(myGuider);if(myGuider.xButton){guiders._addXButton(myGuider)}else{myGuider.elem.find(".guiders_close").hide()}guiderElement.hide();guiderElement.appendTo("body");guiderElement.attr("id",myGuider.id);if(typeof myGuider.attachTo!=="undefined"&&myGuider!==null){guiders._attach(myGuider)}guiders._guiders.push(myGuider);myGuider.show=function(){guiders.show(myGuider);return myGuider};myGuider.destroy=function(){guiderElement.remove();guiders._guiders.removeVal(myGuider)};return myGuider};guiders.show=function(myGuider){if(myGuider.onShow){myGuider.onShow(myGuider)}guiders._attach(myGuider);myGuider.elem.fadeIn("fast").data("locked",false);var windowHeight=guiders._windowHeight=$(window).height();var scrollHeight=$(window).scrollTop();var guiderOffset=myGuider.elem.offset();var guiderElemHeight=myGuider.elem.height();var isGuiderBelow=scrollHeight+windowHeight<guiderOffset.top+guiderElemHeight;var isGuiderAbove=guiderOffset.top<scrollHeight;if(myGuider.autoFocus&&(isGuiderBelow||isGuiderAbove)){setTimeout(guiders.scrollToCurrent,10)}$(myGuider.elem).trigger("guiders.show");if(myGuider.elem.position().left+myGuider.elem.width()>Streak.$(window).width()){myGuider.elem.css("left",Streak.$(window).width()-(myGuider.elem.width()+10)+"px")}guiders.getType=function(){return"TOOLTIP"};return guiders};var _resizing=undefined;$(window).resize(function(){if(typeof _resizing!=="undefined"){clearTimeout(_resizing)}_resizing=setTimeout(function(){_resizing=undefined;if(typeof guiders!=="undefined"){guiders.reposition()}},20)});return guiders}.call(this,jQuery);BB.Widgets.Tour=BB.Widgets.Tour||{};BB.Widgets.Tour.Tooltip=Tooltip})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var WaitForClick=Streak.Class.subclass({className:"WaitForClick",superclass:Streak.Object,_memberVariables:[{name:"_boundElement",destroy:false},{name:"_boundFunction",destroy:false},{name:"_options",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setup:function(options){this._options=options},show:function(){this._boundElement=$("body");this._boundFunction=this._elementClicked.bind(this);this._options.clickEvent=this._options.clickEvent||"click";this._boundElement[0].addEventListener(this._options.clickEvent,this._boundFunction,true)},getType:function(){return"WAIT_FOR_CLICK"},_elementClicked:function(e){if(!$(this._options.targetSelector).isAncestor(e.target)&&!$(this._options.rawTargetSelector).isAncestor(e.target)){return}if(this._options.suppressClick){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()}if(this._options.function){this._options.function()}},destroy:function(){if(this._boundElement&&this._boundElement.length>0){this._boundElement[0].removeEventListener(this._options.clickEvent,this._boundFunction,true)}Streak.Object.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.Tour.WaitForClick",WaitForClick)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var WaitForEvent=Streak.Class.subclass({className:"WaitForEvent",superclass:Streak.Object,_memberVariables:[{name:"_boundElement",destroy:false},{name:"_boundFunction",destroy:false},{name:"_options",destroy:false}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setup:function(options){this._options=options},show:function(){this._boundElement=$("body");this._boundFunction=this._eventHappened.bind(this);this._boundElement[0].addEventListener(this._options.event,this._boundFunction,true)},getType:function(){return"WAIT_FOR_EVENT"},_eventHappened:function(e){if(!$(this._options.targetSelector).isAncestor(e.target)&&!$(this._options.rawTargetSelector).isAncestor(e.target)){return}if(this._options.function){this._options.function()}},destroy:function(){this._boundElement[0].removeEventListener(this._options.event,this._boundFunction,true);Streak.Object.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.Tour.WaitForEvent",WaitForEvent)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BottomModal=Streak.Class.subclass({className:"BottomModal",superclass:Streak.Object,_memberVariables:[{name:"_options",destroy:false},{name:"_helpModalViewController",destroy:true},{name:"_helpModalWrapper",destroy:false},{name:"_leftButton",destroy:true},{name:"_rightButton",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setup:function(options){this._options=options||{}},show:function(){this._helpModalViewController=Library.getInstance("BentoBox.Widgets.HelpModalViewController");this._helpModalViewController.addDelegate(this);this._helpModalViewController.setTitleText(this._options.title);this._helpModalViewController.setContentHTML(this._options.body);if(!this._options.displayAlone){this._helpModalViewController.showBackButton();this._helpModalViewController.setTopClickable(false)}if(this._options.width){this._helpModalViewController.setWidth(options.width)}this._addLeftButton();this._addRightButton();this._addToBody()},_addLeftButton:function(){if(!this._options.leftButton){return}this._leftButton=BB.Widgets.ButtonFactory.createButton({type:"Gmail",color:"blue",text:this._options.leftButton.name,onFunction:this._options.leftButton.function});this._helpModalViewController.addLeftButton(this._leftButton)},_addRightButton:function(){if(!this._options.rightButton){return}this._rightButton=BB.Widgets.ButtonFactory.createButton({type:"Gmail",color:"blue",text:this._options.rightButton.name,onFunction:this._options.rightButton.function});this._helpModalViewController.addRightButton(this._RightButton)},_addToBody:function(){this._helpModalViewController.getView().getElement().addClass("streak__bottomModal");this._helpModalWrapper=Gmail.addToComposeArea(this._helpModalViewController.getView().getElement())},backButtonClicked:function(){this._options.backButtonFunction()},closeClicked:function(){this._options.closeClicked();this._options.finishFunction()},getType:function(){return"BOTTOM_MODAL"},destroy:function(){if(this._helpModalWrapper){Gmail.removeFromComposeArea(this._helpModalWrapper);this._helpModalWrapper.remove()}Streak.Object.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.Tour.BottomModal",BottomModal)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Date=Streak.Date;var TourBaseCore=function(options){};_.extend(TourBaseCore.prototype,{init:function(options,forceRun,cb){var self=this;self._totalPagesSeen=0;self._options=options;self._name=options.tourBookName;self._forceRun=forceRun;self._isNotPersistant=options._isNotPersistant;self.resetDataStructs();if(!self.cssFile){self.cssFile=Streak.server+this.getResourceURL("css");Streak.$("body").append('<link rel="stylesheet" type="text/css" href="'+self.cssFile+'">')}var after=_.onceAfter(3,function(){if(cb){cb()}});if(this._localeClone){after()}else{this._localeClone=Streak.Locale.getClone();this._localeClone.override(this.getResourceURL("locale"),after)}if(this._html){after()}else{self._html=BB.Modules.OverridableHTML.create({fileName:this.getResourceURL("html"),Locale:this._localeClone});self._html.loadHTML(after)}self.setUpTour();after()},setUpTour:function(){var self=this;self._currentViewURL=null;self._inTour=false;self._initialViewUrl=Gmail.hash.partsString},resetDataStructs:function(){var self=this;self._state={};self._previousTransitions=[];self._seenPages=[];self._oldWidgets={};self._newWidgets={}},reset:function(forceRun,isManualTrigger){var self=this;if(forceRun&&!isManualTrigger){var state=self.getSavedState();if(Streak._.isReal(state)){self._previousTransitions=state._previousTransitions;self._currentIndex=state._currentIndex;self._seenPages=state._seenPages;self.loadInstanceSettings(state._instanceSettings)}else{self._currentIndex=0}}if(self._pages){if(!forceRun||isManualTrigger){self._currentIndex=0}self._currentPage=self._pages[self._currentIndex]||self._pages[0]}if(self._currentPage&&self._currentPage.onEnter){self._currentViewURL=null}else{self._currentViewURL=Gmail.hash.partsString}self._inTour=false},startTour:function(triggered){var self=this;this._inTour=true;if(triggered){this.recordEvent("startedTour")}self.recordChaptersActive(self._currentChapter);if(self.getPausedState()||!triggered){self._currentViewURL=Gmail.hash.partsString;self._softExitTour();self.showReturnToTourPopUp()}else{self._oldWidgets=self._newWidgets;self.cleanUp();this.loadPage(this._currentPage)}},_clearActiveTour:function(){BB.UserSettings.setSetting("tour/activeTour/"+this._name,null);BB.UserSettings.saveSettings()},recordChaptersActive:function(chapterName){if(this._isNotPersistant){return}BB.UserSettings.setSetting("tour/activeTour/"+this._name,chapterName);BB.UserSettings.saveSettings()},getResourceURL:function(extension){return"/tours/"+this._name+"/"+this._name+"."+extension},setChapter:function(chapterName,pageNumber,forceRun,source){var self=this;if(forceRun){}else{self._previousTransitions.push({index:self._currentIndex,pages:self._pages,chapterName:self._currentChapter});self._currentIndex=pageNumber}self._currentChapter=chapterName;var Chapter=self._options.Chapters[chapterName];var options={};if(source){options.source=source}else{if(forceRun){options.source="refresh"}else{options.source="trigger"}}self.recordEvent("changeChapterTo",options);self._pages=Chapter.pages},shouldHandleViewChange:function(){var self=this;return self._inTour&&self._currentViewURL},viewChanged:function(viewName){var self=this;if(self._currentViewURL&&self._currentViewURL!==Gmail.hash.partsString){self._softExitTour();self.showReturnToTourPopUp();self.recordPausedState(true)}},recordEvent:function(eventName,optionalObj){var self=this;var trackerObj={category:"TourPassive",eventName:eventName,tour:self._name,page:this._currentChapter+"-"+this._currentIndex,totalPagesSeen:self._totalPagesSeen};_.extend(trackerObj,optionalObj);Streak.BentoBox.Tracker.recordEvent(trackerObj)},recordExitEvent:function(){var self=this;Streak.BentoBox.Tracker.recordEvent({category:"tourExit",eventName:"Exit "+this._name,page:this._currentChapter+"-"+this._currentIndex,totalPagesSeen:self._totalPagesSeen})},convertHTMLandTranslations:function(options){var self=this;var newOptions={};_.each(options,function(value,key){newOptions[key]=self.determineTypeOfValue(value).processed});return newOptions},determineTypeOfValue:function(value){var self=this;if(_.isArray(value)){var newArray=[];for(var i=0;i<value.length;i++){newArray.push(self.determineTypeOfValue(value[i]).processed)}return{type:typeof value,original:value,processed:newArray}}if(_.isObject(value)){var newObject={};for(var aKey in value){newObject[aKey]=self.determineTypeOfValue(value[aKey]).processed}return{type:typeof value,original:value,processed:newObject}}if(typeof value!=="string"){return{type:typeof value,original:value,processed:value}}if(value&&value.length>2){var valueLength=value.length;var type;var processed;var original=value;if(value[0]==="%"&&value[valueLength-1]==="%"){type="TRANSLATION"}else if(value[0]==="*"&&value[valueLength-1]==="*"){type="HTML"}else{type="STRING"}processed=BB.UI.processString(value,self._localeClone,self._html);return{type:type,processed:processed,original:original}}else{return{type:"STRING",original:value,processed:value}}},cleanUpDataCreatedByTour:function(self){},showReturnToTourPopUp:function(){var self=this;var buttons=[{name:"Exit",onclick:function(){self.recordEvent("exitTourTooltip");self.cleanUp.call(self,true);self.cleanUpDataCreatedByTour(self);self.notifyDependenciesOfExit();self.recordPausedState(false)}},{name:"Continue",onclick:function(){self.recordEvent("resumeTour");self.recordPausedState(false);self.cleanUp.call(self,true);self.startTour(true);self._inTour=true}}];var exitToolTipOptions={buttons:buttons,attachTo:"#workflowStatusText",description:"If you would like to return to the tour click below",position:"left",title:"Back to tour",width:220};if(this._options.returnToTourTooltip){_.extend(exitToolTipOptions,this._options.returnToTourTooltip);if(this._options.returnToTourTooltip.exitButtonText){exitToolTipOptions.buttons[0].name=this._options.returnToTourTooltip.exitButtonText}if(this._options.returnToTourTooltip.continueButtonText){exitToolTipOptions.buttons[1].name=this._options.returnToTourTooltip.continueButtonText}}var tooltip=BB.Widgets.Tour.Tooltip.create(exitToolTipOptions);if(!self._newWidgets["TOOLTIP"]){self._newWidgets["TOOLTIP"]=[]}self._newWidgets["TOOLTIP"].push(tooltip);tooltip.show()},notifyDependenciesOfExit:function(){if(this._options.exitCallback){this._options.exitCallback()}this._clearActiveTour();this.recordPausedState(false)},_softExitTour:function(){this._inTour=false;this.recordEvent("_softExitTour");this.cleanUp()},getFunction:function(fxn,extraArguments){if(!fxn){return null}var self=this;var convertedFunction;extraArguments=extraArguments||[];if(typeof fxn==="string"){convertedFunction=function(){self[fxn].apply(self,[].concat(extraArguments))}}else{fxn.args=fxn.args||[];convertedFunction=function(){self[fxn.functionName].apply(self,fxn.args.concat(extraArguments))}}return function(){if(typeof fxn==="string"){self.recordEvent(fxn)}else{self.recordEvent(fxn.functionName)}convertedFunction()}},getSavedState:function(){return Streak.BentoBox.UserSettings.get("tour/activeTourState/"+this._name)},getPausedState:function(){return BB.UserSettings.get("tour/activeTourExitState/")},recordPausedState:function(state){if(this._isNotPersistant){return}if(state){BB.UserSettings.setSetting("tour/activeTourExitState/",true);BB.UserSettings.saveSettings()}else{BB.UserSettings.setSetting("tour/activeTourExitState/",null);BB.UserSettings.saveSettings()}},_clearOutState:function(){var self=this;BB.UserSettings.setSetting("tour/activeTourState/"+this._name,null);BB.UserSettings.saveSettings()},_recordState:function(){var self=this;if(this._isNotPersistant){return}BB.UserSettings.setSetting("tour/activeTourState/"+this._name,{_seenPages:self._seenPages,_currentIndex:self._currentIndex,_previousTransitions:self._previousTransitions,_instanceSettings:self.getInstanceSettings()});BB.UserSettings.saveSettings()},loadPage:function(page){var self=this;if(!_.isReal(self._seenPages)){self._seenPages=[]}self._seenPages.push(page);self._recordState();self.recordEvent("pageEnter");self.cleanUpNonReusedItems();if(page.onEnter){var onEnterFunction=self.getFunction(page.onEnter,function(){self.loadItems()});onEnterFunction()}else{self.loadItems()}},loadItems:function(){var self=this;var items=self._currentPage.itemsOnScreen;setTimeout(function(){self._newWidgets={};_.each(items,function(item){self.loadItem(item)});self.cleanUp();self._oldWidgets=_.clone(self._newWidgets)},5)},loadItem:function(item){var self=this;var widget=null;item=self.convertHTMLandTranslations(item);widget=self.getItem(item.type);var options;switch(item.type){case"MODAL":options={};$.extend(options,item,{cancelFunc:self.getFunction(item.leftButtonFunction),confirmFunc:self.getFunction(item.rightButtonFunction),linkFunc:self.getFunction(item.linkFunction)});if(widget&&widget.reuse){widget.reuse(options)}else{widget=BB.Widgets.Tour.TourModal.create(options)}widget.show();break;case"FUNCTION":var fxn=self[item.name];var callbacks=_.extend({next:"next",previous:"previous"},item.callbacks);for(var callbackName in callbacks){callbacks[callbackName]=self.getFunction(callbacks[callbackName])}var args=[callbacks];if(item.args){args=args.concat(item.args)}fxn.apply(self,args);var destroy=self[item.name+"Destroy"];if(destroy){widget={destroy:destroy.bind(self)}}break;case"HIGHLIGHT":if(widget&&widget.reuse){widget.reuse(item)}else{widget=BB.Widgets.Tour.Highlight.create(item)}widget.show();break;case"OVERLAY":item.leftButtonFunction=self.getFunction(item.leftButtonFunction);item.rightButtonFunction=self.getFunction(item.rightButtonFunction);if(item.tips&&item.tips.length>0){for(var i=0;i<item.tips.length;i++){if(item.tips[i].buttons&&item.tips[i].buttons.length>0){for(var j=0;j<item.tips[i].buttons.length;j++){item.tips[i].buttons[j]["function"]=self.getFunction(item.tips[i].buttons[j]["function"])}}}}if(widget&&widget.reuse){widget.reuse(item)}else{widget=BB.Widgets.Tour.Overlay.create(item)}widget.show();break;case"TOOLTIP":if(!item.buttons){item.buttons=[{name:self._localeClone.getString("tour_previous"),"function":"previous"},{name:self._localeClone.getString("tour_next"),"function":"next"}]}item.offset=item.offset||{};options={title:item.title,body:item.html,targetSelector:item.targetID,placement:{position:item.position,left:item.offset.left,top:item.offset.top},earlyExitTourFunction:self.getFunction("exitTourAndRedirect")};if(item.buttons.length===1){options.rightButton={name:item.buttons[0].name,"function":self.getFunction(item.buttons[0]["function"])}}else if(item.buttons.length===2){options.leftButton={name:item.buttons[0].name,"function":self.getFunction(item.buttons[0]["function"])};options.rightButton={name:item.buttons[1].name,"function":self.getFunction(item.buttons[1]["function"])}}widget=new BB.Widgets.Tour.GmailTooltip;widget.setup(options);widget.show();break;case"WAIT_FOR_CLICK":options={targetSelector:item.targetSelector,"function":self.getFunction(item.function),suppressClick:item.suppressClick};widget=new BB.Widgets.Tour.WaitForClick;widget.setup(options);widget.show();break;case"BAR":options=$.extend({},item,{leftButtonFunction:self.getFunction(item.leftButtonFunction),rightButtonFunction:self.getFunction(item.rightButtonFunction),exitTourFunction:function(){self.exitTourAndRedirect()}});if(widget&&widget.reuse){widget.reuse(options)}else{widget=BB.Widgets.Tour.Bar.create(options)}widget.show();break;default:break}if(widget){if(!self._newWidgets[item.type]){self._newWidgets[item.type]=[]
}self._newWidgets[item.type].push(widget)}return widget},getItem:function(type){if(this._oldWidgets[type]&&this._oldWidgets[type].length>0){if(this._oldWidgets[type][0].reuse){return this._oldWidgets[type].pop()}}return null},cleanUp:function(isFull){var self=this;var i;var key;for(key in self._oldWidgets){for(i=0;i<self._oldWidgets[key].length;i++){if(self._oldWidgets[key][i].destroy){self._oldWidgets[key][i].destroy()}}}if(isFull){for(key in self._newWidgets){for(i=0;i<self._newWidgets[key].length;i++){if(self._newWidgets[key][i].destroy){self._newWidgets[key][i].destroy()}}}}},cleanUpNonReusedItems:function(){if(!this._oldWidgets){return}var keys=Object.keys(this._oldWidgets);for(var ii=0;ii<keys.length;ii++){var widgets=this._oldWidgets[keys[ii]];var newWidgets=[];if(widgets){for(var jj=0;jj<widgets.length;jj++){var widget=widgets[jj];if(!widget){continue}else if(widget.reuse){newWidgets.push(widget)}else{widget.destroy()}}}this._oldWidgets[keys[ii]]=newWidgets}}});BB.Modules.Tour=BB.Modules.Tour||{};BB.Modules.TourBaseCore=TourBaseCore})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Date=Streak.Date;var TourBase=function(options){};TourBase.prototype=Object.create(BB.Modules.TourBaseCore.prototype);_.extend(TourBase.prototype,{exit:function(exitFrom){this.recordLeavingChapter(exitFrom);this.recordExitEvent();this.notifyDependenciesOfExit();this.cleanUpDataCreatedByTour();this._softExitTour();this.recordPausedState(false)},exitTourAndRedirect:function(){this.exit("exitTourAndRedirect");BB.UI.setURL(this._initialViewUrl)},finish:function(){this.exit("finish")},next:function(){var self=this;self._currentIndex++;self._totalPagesSeen++;self._currentViewURL=null;self.recordEvent("pageExit");if(self._currentIndex<self._pages.length){if(self._currentPage.onExit&&self[self._currentPage.onExit]){self[self._currentPage.onExit]()}self._currentPage=self._pages[self._currentIndex];self.loadPage.call(self,self._currentPage)}else{self._currentIndex--}self._recordState()},previous:function(){var self=this;var page;self._currentIndex--;self._totalPagesSeen++;self.recordEvent("pageExit");if(self._currentIndex>=0||self._previousTransitions.length>0){if(self._currentIndex<0){var transition=self._previousTransitions.pop();self._pages=transition.pages;self._currentIndex=transition.index;self.recordChaptersActive(transition.chapterName)}else{if(self._currentPage.onExit&&self[self._currentPage.onExit]){self[self._currentPage.onExit]()}}self._currentPage=self._pages[self._currentIndex];if(self._currentPage.noHistory){self.previous();self._recordState();return}self.loadPage.call(self,self._currentPage)}else{self._currentIndex++}self._recordState()},recordLeavingChapter:function(destination){if(this._currentChapter){this.recordEvent("leavingChapter",{pagesLeft:this._pages.length-this._currentIndex,destination:destination,chapterAndPage:this._currentChapter+"/"+this._currentIndex});this.recordEvent("pageExit",{destination:destination,chapterAndPage:this._currentChapter+"/"+this._currentIndex})}},changeChapterTo:function(chapterName){this.recordLeavingChapter(chapterName);var pageNumber=0;this.setChapter(chapterName,pageNumber-1,false,"jsonFile");this.next();this.recordChaptersActive(chapterName)},sampleCustomFunction:function(){console.log("Sample share custom fxn!")},sampleCustomFunctionDestroy:function(){console.log("destroying sample..")},loadPipelineView:function(callback){this._currentViewURL=Streak.BentoBox.Data.getAllPipelines()[0].link();BB.UI.setURL(Streak.BentoBox.Data.getAllPipelines()[0].link());if(callback){callback()}},loadBoxView:function(callback){this._currentViewURL=Streak.BentoBox.Data.getAllBoxes()[0].link();BB.UI.setURL(Streak.BentoBox.Data.getAllBoxes()[0].link());if(callback){callback()}},condition:function(callbacks,expression){if(this.evaluateWithContext(expression)){callbacks["true"]()}else{callbacks["false"]()}},evaluateWithContext:function(code){return Streak.newFunction("TourBase","$","_","Gmail","BB","Date","context","return ("+code+");")(TourBase,$,_,Gmail,BB,Date,this)},intervalCondition:function(callbacks,expression,intervalCheck,maxInterval){var self=this;var delay=Math.max(500,intervalCheck||500);var maxDelay=maxInterval||1e4;var delayCounter=0;var checkFunc=function(){delayCounter+=delay;var result=self.evaluateWithContext(expression);if(result){callbacks.next()}else{if(delayCounter>maxDelay){setTimeout(function(){self.exit()},500);self.recordEvent("failedintervalCondition",{expression:expression,delay:delay,maxDelay:maxDelay})}else{setTimeout(checkFunc,delay)}}};checkFunc()},waitForSelector:function(selector,callback){_.checkAndThenRun(function(){return Gmail.$(selector).length>0},callback,300)},getInstanceSettings:function(){return{}},loadInstanceSettings:function(settings){}});BB.Modules.Tour=BB.Modules.Tour||{};BB.Modules.TourBase=TourBase})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox,Date=Streak.Date;var TourRunner={_tour:null,_tourOptions:null,initialized:false,init:function(cb){var self=this;if(!self.initialized){Streak.Gmail.observe("viewChanged",function(viewName){if(self._tour&&self._tour.shouldHandleViewChange()){self._tour.viewChanged()}else{self.setOffViewTrigger(viewName);self.setOffViewExpressionTrigger()}},null,1e3);Streak.NotificationCenter.subscribe({eventName:"newComposeWindow",functionToCall:this.setOffComposeTrigger,observer:this});Streak.NotificationCenter.subscribe({eventName:"newReplyArea",functionToCall:this.setOffReplyTrigger,observer:this});self.initialized=true}if(cb){cb()}},initRunTour:function(callback){var tourBook=BB.getUser().get("tourId");if(tourBook){this.runTour(tourBook,null,callback)}else if(callback){callback()}},runTour:function(tourBookName,activeChapter,callback){var self=this;this.getOptions(tourBookName,function(options){self._tourOptions=options;self._tourOptions.tourBookName=tourBookName;var isManualTrigger=false;if(activeChapter){isManualTrigger=true}else{activeChapter=self.getActiveChapter(tourBookName)}if(activeChapter){self._tourRunning=true;self._notifyTourRunning()}self.parseTriggers();options._isNotPersistant=false;if(activeChapter){self.startTourChapter(options,activeChapter,true,isManualTrigger)}if(callback){callback()}})},_notifyTourRunning:function(){BB.trigger("tourRunning");Streak.NotificationCenter.postNotification({eventName:"tourStarting",sender:this})},_notifyTourStopped:function(){BB.trigger("tourStoppedRunning");Streak.NotificationCenter.postNotification({eventName:"tourFinished",sender:this})},getOptions:function(tourBook,callback){new Streak.Request("GET",Streak.server,"/tours/"+tourBook+"/"+tourBook+".json",{isAnonymous:true}).getPromise().then(callback)},getActiveChapter:function(tourBookName){return BB.UserSettings.get("tour/activeTour/"+tourBookName)},parseTriggers:function(){this._initializeChapterTypeArrays();for(var chapterName in this._tourOptions.Chapters){this._processTriggerForChapterName(chapterName)}this.checkStateTriggers();this.setOffViewExpressionTrigger();this.setOffFirstLoadExpressionTrigger()},_initializeChapterTypeArrays:function(){this._viewExpressionChapters=[];this._composeChapters=[];this._replyChapters=[];this._firstLoadExpressionChapters=[];this._tourRunning=false},_processTriggerForChapterName:function(chapterName){var chapter=this._tourOptions.Chapters[chapterName];chapter.name=chapterName;var trigger=chapter.trigger;if(!trigger){return}this._processTriggerForChapter(chapter)},_processTriggerForChapter:function(chapter){var flattenedTriggers=[];this._flattenChapterTriggers(chapter.trigger,flattenedTriggers);for(var ii=0;ii<flattenedTriggers.length;ii++){this._registerChapterByTriggerType(flattenedTriggers[ii],chapter)}},_flattenChapterTriggers:function(trigger,currentList){if(trigger.type==="OR"||trigger.type==="AND"){var triggerList=trigger.list;for(var ii=0;ii<triggerList.length;ii++){this._flattenChapterTriggers(triggerList[ii],currentList)}}else if(trigger.type){currentList.push(trigger)}},_registerChapterByTriggerType:function(trigger,chapter){var type=trigger.type.toUpperCase();switch(type){case"VIEW_CHANGE":this._registerViewTrigger(trigger,chapter);break;case"VIEW_CHANGE_EXPRESSION":this._registerViewExpressionTrigger(trigger,chapter);break;case"USER_DATA":break;case"DATA":this._registerDataTrigger(trigger,chapter);break;case"DATA_STATE":this._registerDataStateTrigger(trigger,chapter);break;case"GMAIL_STATE":this._registerGmailStateTrigger(trigger,chapter);break;case"FIRST_LOAD_EXPRESSION":this._registerFirstLoadExpression(trigger,chapter);break}},_registerViewExpressionTrigger:function(trigger,chapter){this._viewExpressionChapters.push(chapter)},_registerDataStateTrigger:function(trigger,chapter){},_registerDataTrigger:function(trigger,chapter){},_registerGmailStateTrigger:function(trigger,chapter){switch(trigger.params){case"NEW_COMPOSE":this._composeChapters.push(chapter);break;case"NEW_REPLY":this._replyChapters.push(chapter);break}},_registerFirstLoadExpression:function(trigger,chapter){this._firstLoadExpressionChapters.push(chapter)},startTourChapter:function(options,chapterName,forceRun,isManualTrigger){var self=this;if(!forceRun&&(self._tourRunning||self.seenChapterBefore(options,chapterName))){return}self.markChapterAsSeen(options,chapterName);var tour=new BB.Modules.Tours[options.className](options);options.exitCallback=function(){self._tourRunning=false;self._notifyTourStopped()};self.forceRun=forceRun;tour.init(options,forceRun,function(){self._tourRunning=true;self._notifyTourRunning();tour.setChapter(chapterName,0,self.forceRun);tour.reset(self.forceRun,isManualTrigger);tour.startTour(!forceRun||isManualTrigger)});this._tour=tour},markChapterAsSeen:function(options,chapterName){BB.UserSettings.setSetting("tour/seenTours/"+options.id+"/"+chapterName,true);BB.UserSettings.saveSettings()},checkBoxesTrigger:function(params){if(params.condition==="==="){return Streak.BentoBox.Data.getAllBoxes()===parseInt(params.param,10)}return false},seenChapterBefore:function(options,chapterName){var result=BB.UserSettings.get("tour/seenTours/"+options.id+"/"+chapterName)===true;return result},hasSeenChapterBefore:function(chapterName){return BB.UserSettings.get("tour/seenTours/"+this._tourOptions.id+"/"+chapterName)===true},forceStartTourChapter:function(chapterName){var options=this._helpTourOptions;var self=this;if(self._tourRunning||self._tourHelpRunning){return}self._tourHelpRunning=true;self._notifyTourRunning();var tour=new BB.Modules.Tours[options.className](options);options.exitCallback=function(){self._tourHelpRunning=false;self._notifyTourStopped()};self.forceRun=true;tour.init(options,true,function(){tour.setChapter(chapterName,0,self.forceRun);tour.reset(true,null);tour.startTour(true)})},setOffViewTrigger:function(){if(this._viewTriggers){this.checkAndRunTour(this._viewTriggers)}},setOffViewExpressionTrigger:function(){this.checkAndRunTour(this._viewExpressionChapters)},setOffDataTrigger:function(){},setupPipelineTrigger:function(){},setOffComposeTrigger:function(){this.checkAndRunTour(this._composeChapters)},setOffReplyTrigger:function(){this.checkAndRunTour(this._replyChapters)},setOffFirstLoadExpressionTrigger:function(){this.checkAndRunTour(this._firstLoadExpressionChapters)},checkAndRunTour:function(chapters){if(chapters&&chapters.length>0){for(var ii=0;ii<chapters.length;ii++){var chapter=chapters[ii];var shouldRunTour=this.shouldRunTour(chapter);if(shouldRunTour){this.startTourChapter(this._tourOptions,chapter.name,false);return}}}},shouldRunTour:function(chapter){var trigger=chapter.trigger;if(!trigger){return false}if(this._tourRunning){return false}if(this.seenChapterBefore(this._tourOptions,chapter.name)){return false}return this.evaluateList(chapter.trigger)},evaluateList:function(trigger){var result=true;var list=trigger.list;if(trigger.type==="OR"){for(var ii=0;ii<list.length;ii++){result=this.evaluateList(list[ii]);if(result){break}}}else if(trigger.type==="AND"){for(var ii=0;ii<list.length;ii++){result=this.evaluateList(list[ii]);if(!result){break}}}else{result=this._evaluateTrigger(trigger)}return result},_evaluateTrigger:function(trigger){var type=trigger.type.toUpperCase();switch(type){case"VIEW_CHANGE":return this._evaluateView(trigger.params);case"VIEW_CHANGE_EXPRESSION":return this._evaluateViewExpression(trigger.params);case"FIRST_LOAD_EXPRESSION":return this._evaluateViewExpression(trigger.params);case"GMAIL_STATE":return this._evaluateGmailState(trigger.params);case"DATA_STATE":return this._evaluateDataState(trigger.params);case"EXTRA_CONDITION_EXPRESSION":return this._evaluateViewExpression(trigger.params)}return false},_evaluateView:function(params){return params.toLowerCase()===Streak.Gmail.hash.parts[0].toLowerCase()},_evaluateViewExpression:function(code){return Streak.newFunction("TourRunner","$","_","Gmail","BB","Date","context","return ("+code+");")(TourRunner,$,_,Gmail,BB,Date,this)},_evaluateDataState:function(params){if(params.collectionType.toUpperCase()==="BOX"){if(params.property.toUpperCase()==="COUNT"){var boxes=Streak.BentoBox.Data.getAllBoxes();if(params.created){boxes=_.filter(boxes,function(box){return box.get("creatorKey")===BB.getUser().key()})}var variableValue=typeof variableValue==="string"?parseInt(params.variableValue,10):params.variableValue;var operator=_.has(Streak.Utils.Operators,params.comparisonOperator)&&Streak.Utils.Operators[params.comparisonOperator];var result;if(operator){try{result=operator(boxes.length,variableValue)}catch(e){Streak.BentoBox.logError("evaluateDataState error",e,{params:params})}}else{Streak.BentoBox.logError("evaluateDataState unknown operator",null,{params:params})}return result}}return false},_evaluateGmailState:function(){return true},checkStateTriggers:function(){var self=this;_.each(this._dataStateTriggers,function(triggersArray){self.checkAndRunTour(triggersArray)})},teardown:function(){if(this._tour&&this._tourRunning){this._tour._softExitTour();this._tour.recordPausedState(true)}},reup:function(){if(this._tour&&this._tourRunning){this._tour.showReturnToTourPopUp()}},isTourRunning:function(){return this._tourRunning||this._tourHelpRunning}};Streak.DependencyManager.addFunction({functionKey:"tourRunnerInitialized",functionToCall:TourRunner.init,functionContext:TourRunner,dependentFunctionKeys:["gmailLoaded","htmlLoaded","userSettingsInitialized","bentoBox.triggerFirstGmailViewChange"]});Streak.DependencyManager.addFunction({functionKey:"tourRunner.initRunTour",functionToCall:TourRunner.initRunTour,functionContext:TourRunner,dependentFunctionKeys:["tourRunnerInitialized"]});BB.Modules.TourRunner=TourRunner})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var FirstRunTour=function(options){BB.Modules.TourBase.call(this,options);this.useCase="default";this.tourData=options.tourData};FirstRunTour.prototype=Object.create(BB.Modules.TourBase.prototype);_.extend(FirstRunTour.prototype,{newPipelineModal:null,createdPipelines:[],fakeBoxes:[],createdBoxes:[],modifiedCollections:[],preload:function(cb){this.getShareModal();if(cb){cb()}},getShareModal:function(){if(!this.shareStreakModal){this.shareStreakModal=BB.Widgets.ShareStreak.create({modalOptions:{close:false,escClose:false,title:this._localeClone.getString("share_streak_modal_title"),confirmText:this._localeClone.getString("tour_next"),cancelText:this._localeClone.getString("tour_skip")},modalDescription:this._localeClone.getString("share_streak_modal_description")})}return this.shareStreakModal},loadPipelineView:function(callback){var self=this;if(BB.UI.isPipelineView()){this._currentViewURL=Gmail.hash.partsString;this.currentPipeline=BB.Data.getPipeline(Gmail.getConversationId());callback();return}this._currentViewURL=this.currentPipeline.link();BB.UI.setURL(this._currentViewURL,callback)},setupPipeline:function(){var boxes=BB.Data.getPipelineBoxes(this.currentPipeline.key());if(boxes.length<2){boxes._refresh=boxes.refresh;boxes.refresh=function(cb){if(cb){cb()}};this.modifiedCollections.push(boxes);var nameKey=null;for(var key in this.tourData.fakeBoxInformation.mapping){if(this._localeClone.getString(key)===this.currentPipeline.displayName()){nameKey=key;break}}if(nameKey){var names=this.tourData.fakeBoxInformation.data.names[this.tourData.fakeBoxInformation.mapping[nameKey]];for(var i=1;i<names.length;i++){var box=this.createFakeBox(this.currentPipeline,names[i]);boxes.add(box)}}}if(this._options.tourData){if(this._options.tourData.stringModeMapping){var mapping=this._options.tourData.stringModeMapping;for(var key in mapping){var aKey=BB.UI.processString(key);if(aKey===this.currentPipeline.displayName()){var mode=mapping[key];this.useCase=mode;this._localeClone.setMode(this.useCase);this._html.setMode(this.useCase);break}}}}},createFakeBox:function(pipeline,name){var box=BB.Models.Box.create({name:name,pipelineKey:pipeline.key()});box.save=function(cb){cb()};box.link=function(){return pipeline.link()};var randomNote=this.tourData.fakeBoxInformation.data.notes[_.random(0,this.tourData.fakeBoxInformation.data.notes.length-1)];box.set("notes",randomNote);var stages=pipeline.get("stageOrder");var randomStage=stages[_.random(0,stages.length-1)];box.set("stageKey",randomStage);box.set("boxKey","__new__"+Streak.Date.create().getTime()*Math.random());var fields=box.getFieldModels();for(var j=0;j<fields.length;j++){var field=fields[j];field.save=function(cb){if(cb){cb()}};switch(field.get("type")){case"TEXT_INPUT":for(var fieldName in this.tourData.fakeBoxInformation.data.fields){if(this._localeClone.getString(fieldName)===pipeline.getField(field.key()).displayName()){var fieldValues=this.tourData.fakeBoxInformation.data.fields[fieldName];var randomText=fieldValues[_.random(0,fieldValues.length-1)];field.set("value",randomText);break}}break;case"DATE":var randomDate=_.random(0,30);field.set("value",Streak.Date.create().addDays(-1*randomDate).getTime()+"");break;case"PERSON":break}}this.fakeBoxes.push(box);return box},createBox:function(){var self=this;var nameKey=null;for(var key in self.tourData.fakeBoxInformation.mapping){if(self._localeClone.getString(key)===self.currentPipeline.displayName()){nameKey=key;break}}var names;if(nameKey){names=self.tourData.fakeBoxInformation.data.names[self.tourData.fakeBoxInformation.mapping[nameKey]]}if(!names||names.length===0){names=["Mike Roberts"]}var box=BB.Models.Box.create({name:names[0],pipelineKey:this.currentPipeline.key(),stageKey:this.currentPipeline.getStages()[0].key()});BB.Data.getPipelineBoxes(this.currentPipeline.key()).add(box);var operationProgressId=box.save();Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",observer:this,filterParameters:{operationProgressId:operationProgressId,operationIsComplete:true},functionToCall:function(){this.createdBoxes.push(box);this.currentBox=box;this.setupBox();this._recordState()}})},setupBox:function(){var self=this;if(this.currentBox.get("notes").length===0){this.currentBox.set("notes",self._localeClone.getString("tour_sample_box_notes"))}var fields=this.currentBox.getFieldModels();for(var j=0;j<fields.length;j++){var field=fields[j];field.save=function(cb){if(cb){cb()}};switch(field.get("type")){case"TEXT_INPUT":for(var fieldName in this.tourData.fakeBoxInformation.data.fields){if(this._localeClone.getString(fieldName)===this.currentPipeline.getField(field.key()).displayName()){var fieldValues=this.tourData.fakeBoxInformation.data.fields[fieldName];var randomText=fieldValues[_.random(0,fieldValues.length-1)];field.set("value",randomText);break}}break;case"DATE":var randomDate=_.random(0,30);field.set("value",Streak.Date.create().addDays(-1*randomDate).getTime()+"");break;case"PERSON":break}}var threads=BB.Data.getGmailThreadCollectionForBox(this.currentBox.key(),null,true);if(threads){if(threads.length===0){var thread1=BB.Models.GmailThread.create({subject:self._localeClone.getString("tour_sample_email_1_subject"),names:[self._localeClone.getString("tour_sample_email_1_name")],emailAddresses:[self._localeClone.getString("tour_sample_email_1_address")],lastEmailTimestamp:Streak.Date.ccreate().getTime()});thread1.link=function(){return self.currentBox.link()};thread1.save=function(cb){if(cb){cb()}};threads.add(thread1);var thread2=BB.Models.GmailThread.create({subject:self._localeClone.getString("tour_sample_email_2_subject"),names:[self._localeClone.getString("tour_sample_email_2_name")],emailAddresses:[self._localeClone.getString("tour_sample_email_2_address")],lastEmailTimestamp:Streak.Date.ccreate("yesterday at 9pm").getTime()});thread2.link=function(){return self.currentBox.link()};thread2.save=function(cb){if(cb){cb()}};threads.add(thread2);var thread3=BB.Models.GmailThread.create({subject:self._localeClone.getString("tour_sample_email_3_subject"),names:[self._localeClone.getString("tour_sample_email_3_name")],emailAddresses:[self._localeClone.getString("tour_sample_email_3_address")],lastEmailTimestamp:Streak.Date.ccreate("yesterday at 8am").getTime()});thread3.link=function(){return self.currentBox.link()};thread3.save=function(cb){if(cb){cb()}};threads.add(thread3)}}this.currentBox.refresh=function(cb){if(cb){cb()}};threads.refresh=function(cb){if(cb){cb()}}},loadBoxView:function(callback){var self=this;if(BB.UI.isBoxView()){this._currentViewURL=Gmail.hash.partsString;callback();return}this._currentViewURL=this.currentBox.link();BB.UI.setURL(this._currentViewURL);callback()},loadInbox:function(callback){this._currentViewURL=Gmail.Constants.Inbox;if(!Gmail.isInboxView()){BB.UI.setURL(Gmail.Constants.Inbox,callback)}else{callback()}},pickPipeline:function(callbacks){var self=this;this.newModalPipeline=BB.Widgets.NewPipelineModal.create({title:"How Can Streak Help You?",subHeadingText:"Don't worry, you can change this later",showCancel:false,close:false,escClose:false,showConfirm:false,noPipelineChosenCallback:this.noPipelinePicked.bind(this),pipelineChosenCallback:callbacks.next,pipelinePrecreateCallback:function(operationProgressId){self.pipelinePicked(operationProgressId)}});this.newModalPipeline.show()},pickPipelineDestroy:function(){this.newModalPipeline.close()},pipelinePicked:function(operationProgressId){var self=this;this.recordEvent("pipelineCreated");this.currentPipeline=BB.Data.getAllPipelines()[0];this.getShareModal().setPipelines([this.currentPipeline]);Streak.NotificationCenter.subscribe({eventName:"operationProgressUpdate",observer:this,filterParameters:{operationProgressId:operationProgressId,operationIsComplete:true},unsubscribeImmediately:true,functionToCall:function(){this.createBox();this.setupPipeline()}})},noPipelinePicked:function(){this.changeChapterTo("noPipelineChosen")},shareStreak:function(callbacks){var self=this;this.getShareModal().show({cancelFunction:function(){self.recordEvent("streakNotShared");self.recordEvent("streakShareModalClosed");callbacks.next()},onPresave:function(acl){self.recordEvent("streakShared",{value:acl.length});self.recordEvent("streakShareModalClosed");callbacks.next()}})},shareStreakDestroy:function(){this.getShareModal().close()},setupExistingPipeline:function(callback){this.currentPipeline=_.max(BB.Data.getAllPipelines(),function(pipeline){return BB.Data.getPipelineBoxes(pipeline.key()).length});var boxes=BB.Data.getPipelineBoxes(this.currentPipeline.key());if(boxes.length===0){this.createBox();this.setupPipeline()}else{this.currentBox=boxes[0]}if(callback){callback()}},cleanUpDataCreatedByTour:function(){for(var i=0;i<this.fakeBoxes.length;i++){this.fakeBoxes[i].postNotification("delete")}this.fakeBoxes.length=0;for(var i=0;i<this.createdBoxes.length;i++){this.createdBoxes[i].del()}this.createdBoxes.length=0;for(var i=0;i<this.modifiedCollections.length;i++){this.modifiedCollections[i].refresh=this.modifiedCollections[i]._refresh}this.modifiedCollections.length=0},getInstanceSettings:function(){var ret={};if(this.createdPipelines&&this.createdPipelines.length>0){ret.pipelineKeys=_.map(this.createdPipelines,function(pipeline){return pipeline.key()})}if(this.createdBoxes&&this.createdBoxes.length>0){ret.boxKeys=_.map(this.createdBoxes,function(box){return box.key()})}if(this.currentPipeline){ret.currentPipelineKey=this.currentPipeline.key()}if(this.currentBox){ret.currentBoxKey=this.currentBox.key()}return ret},loadInstanceSettings:function(settings){if(settings){this.createdPipelines=[];if(settings.pipelineKeys&&settings.pipelineKeys.length>0){for(var i=0;i<settings.pipelineKeys.length;i++){var pipeline=BB.Data.getPipeline(settings.pipelineKeys[i]);if(pipeline){this.createdPipelines.push(pipeline)}}}this.createdBoxes=[];if(settings.boxKeys&&settings.boxKeys.length>0){for(var i=0;i<settings.boxKeys.length;i++){var box=BB.Data.getBox(settings.boxKeys[i]);if(box){this.createdBoxes.push(box)}}}if(settings.currentPipelineKey){var pipeline=BB.Data.getPipeline(settings.currentPipelineKey);if(pipeline){this.currentPipeline=pipeline}else{this.currentPipeline=BB.Data.getAllPipelines()[0]}}else{if(BB.Data.getAllPipelines().length>0){this.currentPipeline=BB.Data.getAllPipelines()[0]}}if(settings.currentBoxKey){var box=BB.Data.getBox(settings.currentBoxKey);if(box){this.currentBox=box}else if(this.createdBoxes.length>0){this.currentBox=this.createdBoxes[0]}else if(this.currentPipeline){var madeBoxes=_.filter(BB.Data.getPipelineBoxes(this.currentPipeline.key()),function(aBox){return aBox.isSavedOnServer()});if(madeBoxes.length>0){this.currentBox=madeBoxes[0]}}}else{if(BB.Data.getAllBoxes().length>0){this.currentBox=BB.Data.getAllBoxes()[0];if(this.currentBox.getPipeline().key()!==this.currentPipeline.key()){this.currentPipeline=this.currentBox.getPipeline()}}}if(this.currentPipeline){this.setupPipeline();if(!this.currentBox){this.createBox()}}if(this.currentBox){this.setupBox()}}}});BB.Modules.Tours=BB.Modules.Tours||{};BB.Modules.Tours.FirstRunTour=FirstRunTour})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,HTML=Streak.HTML,APIRequester=Streak.APIRequester,BB=Streak.BentoBox;var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})};var ExtendedTour=function(options){BB.Modules.Tours.FirstRunTour.call(this,options)};ExtendedTour.prototype=Object.create(BB.Modules.Tours.FirstRunTour.prototype);_.extend(ExtendedTour.prototype,{showIOSModal:function(callbacks){var inner=$(this._html.get("extendedTouriPhoneModalInner")());var inputWrapper=inner.find(".extendedTourIPhoneModalInput");var input=inputWrapper.find("input");var inputStatus=inner.find(".extendedTourIPhoneModalInputStatus");var submitButton=BB.Widgets.Button.create({name:"Send To My Phone",color:"blue",onFunc:function(e){track("send_ios_link_attempt");submitButton.disable();modal.getOkButton().disable();submitButton.el.html("<div>Sending...</div>");var phoneNumber=input.val();APIRequester.post("promos/ioslink",null,{phoneNumber:phoneNumber}).getPromise().then(function(res){if(res.success){track("send_ios_link_successful");submitButton.el.html("<div>Sent!</div>");setTimeout(function(){modal.close();callbacks.next()},2*1e3)}else{track("send_ios_link_failure");modal.getOkButton().enable();submitButton.enable();submitButton.el.html("<div>Send To My Phone</div>");inputStatus.css("color","red");inputStatus.html("Sorry there was an error. Please go to www.streak.com/iphone on your iPhone.");inputStatus.show()}},function(){inputStatus.css("color","red");inputStatus.html("Sorry there was an error. Please go to www.streak.com/iphone on your iPhone.");inputStatus.show()},null,null,true)}});inputWrapper.find(".extendedTourIPhoneModalInputButton").append(submitButton.el);input.on("keydown",function(e){if(e.which===13){submitButton.on()}});input.on("focus",function(e){inputWrapper.addClass("acm")});input.on("blur",function(e){inputWrapper.removeClass("acm")});$.tabChain([input,submitButton.el]);var modal=BB.Widgets.Modal.create({title:"Get Streak for your iPhone",width:"550px",inner:inner,showConfirm:true,showCancel:false,confirmText:"No thanks",doneButtonColor:"normal",onClose:callbacks.next});modal.show();setTimeout(function(){input.focus()},50)}});BB.Modules.Tours=BB.Modules.Tours||{};BB.Modules.Tours.ExtendedTour=ExtendedTour})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HelpLoader={_downloadHelpFile:function(){var self=this;return new Streak.Request("GET",Streak.server,"/tours/help/help.json",{isAnonymous:true}).getPromise().then(function(helpFile){self._helpFile=helpFile})},_defaultAction:function(){if(this._isHelpVisibleByDefault()){this.getHelpViewController().show()}},_isHelpVisibleByDefault:function(){return!BB.UserSettings.get("help/defaultHidden")},getHelpViewController:function(){if(!this._helpViewController){this._helpViewController=Library.getInstance("BentoBox.Modules.Help.HelpViewController");this._helpViewController.setHelpFile(this._helpFile)}return this._helpViewController},startWatchingForTourClicks:function(){var self=this;Gmail.elements.body[0].addEventListener("mousedown",function(e){if(e.target.tagName!=="A"){return}var href=e.target.href;if(href.indexOf("streakhelp://")===-1){return}var chapterName=href.split("//")[1];if(!chapterName){return}self.getHelpViewController().startChapter(chapterName);e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()},true)}};Library.set("BentoBox.Modules.Help.HelpLoader",HelpLoader);DependencyManager.addFunction({functionKey:"helpFileLoaded",functionReference:function(){return HelpLoader._downloadHelpFile()},dependentFunctionKeys:[]});DependencyManager.addFunction({functionKey:"helpLoaderInitialized",functionReference:function(){},dependentFunctionKeys:["helpFileLoaded","htmlLoaded","localeLoaded"]});DependencyManager.addFunction({functionKey:"helpLoaderDefaultActionTriggered",functionReference:function(){return HelpLoader._defaultAction()},dependentFunctionKeys:["helpLoaderInitialized","userSettingsInitialized"]});DependencyManager.addFunction({functionKey:"helpLoaderTourClickWatcher",functionReference:function(){return HelpLoader.startWatchingForTourClicks()},dependentFunctionKeys:["helpLoaderInitialized","gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HelpView=Streak.Class.subclass({className:"HelpView",superclass:UI.View,_memberVariables:[{name:"_modalView",destroy:true},{name:"_modalWrapper",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){},setModalView:function(modalView){this._modalView=modalView;this.getElement().addClass("streak__helpView")},getElement:function(){return this._modalView&&this._modalView.getElement()},show:function(){if(this._modalWrapper){Gmail.readdToComposeArea(this._modalWrapper);return}this._modalWrapper=Gmail.addToComposeArea(this.getElement(),350)},hide:function(){Gmail.removeFromComposeArea(this._modalWrapper)}});Library.set("BentoBox.Modules.Help.HelpView",HelpView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HelpViewController=Streak.Class.subclass({className:"HelpViewController",superclass:UI.ViewController,_memberVariables:[{name:"_helpFile",destroy:false,set:true},{name:"_helpModalViewController",destroy:true},{name:"_searchableListViewController",destroy:true},{name:"_trackQueryDebouncer",destroy:false},{name:"_savedScrollPosition",destroy:true},{name:"_viewState",destroy:true},{name:"_currentTourChapterController",destroy:true}],_initialize:function(){UI.ViewController.prototype._initialize.call(this);
this._setupSearchableListViewController();this._setupHelpModalViewController();this._view.setModalView(this._helpModalViewController.getView());this._trackQueryDebouncer=_.debounce(this._trackQuery.bind(this),500)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Help.HelpView")},_setupSearchableListViewController:function(){this._searchableListViewController=Library.getInstance("BentoBox.Widgets.SearchableListViewController");this._searchableListViewController.setPlaceholder(BB.Locale.getString("search_help"));this._searchableListViewController.setShouldLockSelection(false);this._setupNoSearchResultsMessage();this._searchableListViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="rowSelected"}).map(function(eventWrapper){return eventWrapper.rowData}).onValue(this,"_rowSelected")},_setupNoSearchResultsMessage:function(){var noSearchResultsMessage=HTML.getElement("helpMenuNoSearchResults");var self=this;noSearchResultsMessage.find("a").click(function(e){self.closeClicked();Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){composeWindowViewController.setToAddresses(["support@streak.com"]);composeWindowViewController.setSubject("Help Topic Suggestion")});e.stopImmediatePropagation();e.preventDefault()});this._searchableListViewController.setEmptyViewMessage(noSearchResultsMessage)},_setupHelpModalViewController:function(){this._helpModalViewController=Library.getInstance("BentoBox.Widgets.HelpModalViewController");this._helpModalViewController.addDelegate(this);this._helpModalViewController.hideBackButton();this._helpModalViewController.setContentViewController(this._searchableListViewController);var searchViewController=this._searchableListViewController.getSearchInputViewController();this._helpModalViewController.setTitleViewController(searchViewController);this._helpModalViewController.setTitleText("Streak Help")},setHelpFile:function(helpFile){this._helpFile=helpFile;this._searchableListViewController.addDelegate(this);this._searchableListViewController.setDataSource(this)},_bindToTourEvents:function(){var self=this;NotificationCenter.subscribe({eventName:"tourStarting",functionToCall:function(){self._savedScrollPosition=self._searchableListViewController.getScrollPosition();self._view.hide()},observer:this});NotificationCenter.subscribe({eventName:"tourFinished",functionToCall:function(){self._view.show();self._searchableListViewController.focus();self._searchableListViewController.setScrollPosition(self._savedScrollPosition);self._currentTourChapterController=null},observer:this});NotificationCenter.subscribe({eventName:"tourHelpCloseClicked",functionToCall:function(){if(!self._currentTourChapterController){return}self.closeClicked()},observer:this})},_unbindFromTourEvents:function(){Streak.NotificationCenter.unsubscribe({observer:this})},show:function(shouldRestore){this._bindToTourEvents();this._searchableListViewController.reset();this._view.show();if(shouldRestore){this._helpModalViewController.restore()}this._searchableListViewController.focus();this._viewState="VISIBLE";BB.UserSettings.set("help/defaultHidden",false);BB.UserSettings.save()},getState:function(){return{searchText:this._searchableListViewController.getSearchText(),scrollPosition:this._searchableListViewController.getScrollPosition(),viewState:this._viewState}},setState:function(state){this._searchableListViewController.setSearchText(state.searchText);this._searchableListViewController.setScrollPosition(state.scrollPosition);switch(state.viewState){case"VISIBLE":this.show(true);break;case"HIDDEN":this.closeClicked();break;case"MINIMIZED":this._helpModalViewController.minimize();break}},closeClicked:function(){BB.Tracker.track("help menu closed");this._view.hide();BB.UserSettings.set("help/defaultHidden",true);if(this._hasNotSeenTopMenuTooltip()){this._showTopMenuTooltip()}this._unbindFromTourEvents();BB.UserSettings.save();this._eventStream.push({eventName:"closeClicked"});this._viewState="HIDDEN"},minimizeClicked:function(){BB.Tracker.track("help menu minimized");this._helpModalViewController.setIconClass("streak__helpView_icon");this._viewState="MINIMIZED"},restoreClicked:function(){BB.Tracker.track("help menu restored");this._helpModalViewController.setIconClass("");this._searchableListViewController.focus();this._viewState="VISIBLE"},getNumberOfSections:function(){return this._helpFile.HelpMenu.length},getSectionTitle:function(sectionIndex){return this._helpFile.HelpMenu[sectionIndex].name},getNumberOfRows:function(sectionIndex){return this._helpFile.HelpMenu[sectionIndex].chapters.length},getRowData:function(sectionIndex,rowIndex){return{text:this._helpFile.HelpMenu[sectionIndex].chapters[rowIndex],chapterName:this._helpFile.HelpMenu[sectionIndex].chapters[rowIndex]}},getRowSearchString:function(sectionIndex,rowIndex){return this._helpFile.HelpMenu[sectionIndex].chapters[rowIndex]+";"+this._helpFile.HelpMenu[sectionIndex].name},keydown:function(event){if(Streak.jwerty.is("escape",event)){this.closeClicked()}},queryChange:function(query){this._trackQueryDebouncer(query)},_trackQuery:function(query){if(query){BB.Tracker.track("help queried",{query:query})}},rowSelected:function(rowData){this._currentTourChapterController=this.startChapter(rowData.chapterName)},doesChapterExist:function(chapterName){return!!this._getChapterDefinition(chapterName)},startChapter:function(chapterName){var chapterDefinition=this._getChapterDefinition(chapterName);if(!chapterDefinition){return}var tourChapterViewController=new BB.Tour.TourChapterViewController;tourChapterViewController.run(chapterDefinition,this._helpFile.Chapters);return tourChapterViewController},getChapterNames:function(){return _.map(this._helpFile.Chapters,function(chapter){return chapter.name})},_getChapterDefinition:function(chapterName){return JSON.deepClone(_.find(this._helpFile.Chapters,function(chapter){return chapter.name.toUpperCase()===chapterName.toUpperCase()}))},_hasNotSeenTopMenuTooltip:function(){return!BB.UserSettings.get("help/seenTopMenuTooltip")},_showTopMenuTooltip:function(){this.startChapter("How to access Streak Help");BB.UserSettings.set("help/seenTopMenuTooltip",true)},destroy:function(){this._unbindFromTourEvents();UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.Help.HelpViewController",HelpViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,StateMachine=Streak.StateMachine,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var PipelineMenu=function(){this._menu=BB.Widgets.Menu.create({maxHeight:450});this._shareButton=null;this._colorPicker=null;this._menuItems={rename:null,createSimilar:null,hide:null,show:null,deleteSeparator:null,"delete":null};this._currentPipeline=null;this._currentPipelineList=null;this._setup()};_.extend(PipelineMenu.prototype,{_setup:function(){this._createShareButton();this._menu.addSeparator();this._createColorPicker();this._menu.addSeparator();this._addModifyItems();this._menu.addSeparator();this._addMovePositionItems();this._addShowHideItems();this._addDeleteItems()},_createShareButton:function(){this._shareButton=BB.Modules.PipelineView.ShareButton.create({isButton:false,isDark:true,iconAfter:false});this._menu.addItem(this._shareButton.el)},_createColorPicker:function(){var self=this;this._colorPicker=BB.Widgets.ColorPicker.create({label:BB.Locale.getString("color_pipeline"),colorChosenFunc:function(newColor){isDefault=false;color=newColor;self._currentPipeline.setColor(color);self._currentPipeline.postNotification("colorChanged");self.track("pipelineColorChanged")},showRemove:true,removeColorFunc:function(){color={backgroundColor:"rgb(255, 173, 71)",textColor:"rgb(0, 0, 0)"};isDefault=true;self._currentPipeline.setColor(null);self._currentPipeline.postNotification("colorChanged");self.track("pipelineColorRemoved")}});this._menu.addSection(this._colorPicker.el)},_addModifyItems:function(){var self=this;this._addRenameItem();this._addCreateSimilarItem()},_addRenameItem:function(){var self=this;this._menuItems.rename=this._menu.addItem(BB.Locale.getString("rename_pipeline"),function(){self.track("renamePipeline");BB.Widgets.Modal.textboxModal({title:BB.Locale.getString("rename_pipeline"),allowEmpty:false,startingText:self._currentPipeline.displayName(),callback:function(newName){self._currentPipeline.set("name",newName);self._currentPipeline.save()}})})},_addCreateSimilarItem:function(){var self=this;this._menuItems.createSimilar=this._menu.addItem(BB.Locale.getString("create_similar_pipeline"),function(){BB.Data.createSimilarPipeline(self._currentPipeline);self.track("createSimilarPipeline")})},_addMovePositionItems:function(){var self=this;this._menuItems.moveUp=this._menu.addItem(BB.Locale.getString("move_up"),function(){var currentPosition=self._currentPipelineList.indexOf(self._currentPipeline.key());var temp=self._currentPipelineList[currentPosition-1];self._currentPipelineList[currentPosition-1]=self._currentPipeline.key();self._currentPipelineList[currentPosition]=temp;BB.UserSettings.set("leftLink/pipelineSort",_.clone(self._currentPipelineList));BB.UserSettings.save(true);BB.Data.getAllPipelines().postNotification("uiSettingChanged")});this._menuItems.moveDown=this._menu.addItem(BB.Locale.getString("move_down"),function(){var currentPosition=self._currentPipelineList.indexOf(self._currentPipeline.key());var temp=self._currentPipelineList[currentPosition+1];self._currentPipelineList[currentPosition+1]=self._currentPipeline.key();self._currentPipelineList[currentPosition]=temp;BB.UserSettings.set("leftLink/pipelineSort",_.clone(self._currentPipelineList));BB.UserSettings.save(true);BB.Data.getAllPipelines().postNotification("uiSettingChanged")})},_addShowHideItems:function(){this._addShowItem();this._addHideItem()},_addShowItem:function(){var self=this;this._menuItems.show=this._menu.addItem(BB.Locale.getString("unhide_pipeline"),function(){self._currentPipeline.setHidden(false);self.track("showPipeline")})},_addHideItem:function(){var self=this;this._menuItems.hide=this._menu.addItem(BB.Locale.getString("hide_pipeline"),function(){self._currentPipeline.setHidden(true);self.track("hidePipeline")})},_addDeleteItems:function(){var self=this;this._menuItems.deleteSeparator=this._menu.addSeparator();this._menuItems["delete"]=this._menu.addItem(BB.Locale.getString("delete_pipeline"),function(){self._deletePipeline(self._currentPipeline);self.track("deletePipeline")})},_doesUserOwnPipeline:function(){return this._currentPipeline.get("creatorKey")===BB.getUser().key()},_deletePipeline:function(pipeline){if(!this._doesUserOwnPipeline(pipeline)){BB.ButterBarManager.showError(BB.Locale.getString("no_permission"),{time:7e3})}var boxes=BB.Data.getPipelineBoxes(pipeline.key());if(boxes.length>0){this._showCantDeletePipelineBecauseBoxes(pipeline);return}var message="";var acl=pipeline.get("aclEntries");if(acl&&acl.length>0){message+=" This pipeline is shared with <strong>"+acl.length+" collaborator"+(acl.length>1?"s":"")+"</strong>";if(pipeline.get("orgWide")){message+=" and the <strong>"+pipeline.get("organization").organizationId+" organization</strong>"}}else{message='Press "OK" to delete this pipeline'}var delTitle=BB.Locale.getString("confirm_delete_pipeline")+pipeline.displayName()+"?";BB.Widgets.Modal.confirm(delTitle,message,function(){pipeline.del()})},_showCantDeletePipelineBecauseBoxes:function(pipeline){var message=BB.Locale.getString("boxes_cannot_delete_pipeline_body",{pipeline:pipeline.displayNameText()});if(pipeline.isHidden()){BB.Widgets.Modal.create({title:BB.Locale.getString("cannot_delete_pipeline"),inner:message,showConfirm:false}).show()}else{message+="<br /><br />"+BB.Locale.getString("considered_hiding_pipeline");BB.Widgets.Modal.create({title:BB.Locale.getString("cannot_delete_pipeline"),inner:message,confirmText:BB.Locale.getString("hide_pipeline_instead"),confirmFunc:function(){pipeline.setHidden(true);BB.ButterBarManager.showMessage(BB.Locale.getString("pipeline_hidden"))}}).show()}},setCurrentPipeline:function(pipeline,pipelineList){this._currentPipeline=pipeline;this._currentPipelineList=pipelineList;if(!pipeline){return}this._updateShareButton();this._updateColorPicker();this._updateShowHideItems();this._updateDeleteItems();this._updateMoveItems()},getElement:function(){return this._menu.el},getCurrentPipeline:function(){return this._currentPipeline},_updateShareButton:function(){this._shareButton.setPipeline(this._currentPipeline)},_updateColorPicker:function(){this._colorPicker.updateColor(this._currentPipeline.getColor(),this._currentPipeline.displayName());this._colorPicker.showMenu()},_updateShowHideItems:function(){this._menuItems.show.hide();this._menuItems.hide.hide();if(this._currentPipeline.isHidden()){this._menuItems.show.show()}else{this._menuItems.hide.show()}},_updateDeleteItems:function(){if(this._doesUserOwnPipeline(this._currentPipeline)){this._menuItems.deleteSeparator.show();this._menuItems["delete"].show()}else{this._menuItems.deleteSeparator.hide();this._menuItems["delete"].hide()}},_updateMoveItems:function(){this._menuItems.moveUp.hide();this._menuItems.moveDown.hide();if(this._currentPipeline.isHidden()){return}var currentIndex=this._currentPipelineList.indexOf(this._currentPipeline.key());if(currentIndex>0){this._menuItems.moveUp.show()}if(currentIndex!==this._currentPipelineList.length-1){this._menuItems.moveDown.show()}},track:function(event,prop){BB.Tracker.trackStreakActive(this.trackingContext,prop,{eventName:event})}});function init(callback){BB.Modules.LeftLink.PipelineMenu=new PipelineMenu;if(callback){callback()}}Streak.DependencyManager.addFunction({functionKey:"leftLink.pipelineMenuInitialized",functionToCall:init,dependentFunctionKeys:["pipelineView.shareButtonInitialized","menuInitialized","widgets.colorPicker.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,StateMachine=Streak.StateMachine,Gmail=Streak.Gmail,HTML=Streak.HTML,BB=Streak.BentoBox;var SavedViewsMenu=function(){this._menu=BB.Widgets.Menu.create();this._menuItems={showInInbox:null,rename:null,duplicate:null,"delete":null};this._currentPipeline=null;this._currentSavedView=null;this._setup()};_.extend(SavedViewsMenu.prototype,{_setup:function(){this._addShowInInboxItem();this._menu.addSeparator();this._addRenameItem();this._addDuplicateItem();this._addDeleteItem()},_addShowInInboxItem:function(){var self=this;this._menuItems.showInInbox=this._menu.addCheckItem(BB.Locale.getString("saved_view_add_to_inbox"),function(isChecked){if(isChecked){self.track("addSavedViewToInbox");BB.Modules.HeadsUp.addSection(self._currentSavedView.viewKey,self._currentPipeline.key())}else{self.track("removeSavedViewFromInbox");BB.Modules.HeadsUp.removeSection(self._currentSavedView.viewKey)}})},_updateShowInInboxItem:function(){this._menuItems.showInInbox.setCheckboxState(BB.Modules.PipelineView.SavedViewsController.externalIsInHeadsUp(this._currentSavedView.viewKey))},_addRenameItem:function(){var self=this;this._menuItems.rename=this._menu.addItem(BB.Locale.getString("saved_view_rename"),function(){self.track("renameSavedView");BB.Widgets.Modal.textboxModal({title:BB.Locale.getString("saved_view_rename"),allowEmpty:false,startingText:self._currentSavedView.name,callback:function(newName){self._currentSavedView.name=newName;self._currentPipeline.updateSavedView(self._currentSavedView)}})})},_addDuplicateItem:function(){var self=this;this._menuItems.duplicate=this._menu.addItem(BB.Locale.getString("saved_view_duplicate"),function(){self.track("duplicateSavedView");self._currentPipeline.addSavedView(self._currentSavedView.name+"*",self._currentSavedView.settings)})},_addDeleteItem:function(){var self=this;this._menuItems["delete"]=this._menu.addItem(BB.Locale.getString("saved_view_delete"),function(){self.track("deleteSavedViewAttempt");BB.Widgets.Modal.confirmDelete(self._currentSavedView.name,function(){self.track("deleteSavedViewSuccess");BB.Modules.PipelineView.SavedViewsController.externalDeleteSavedView(self._currentPipeline,self._currentSavedView)})})},setCurrentPipelineAndSavedView:function(pipeline,savedView){this._currentPipeline=pipeline;this._currentSavedView=savedView;if(!pipeline||!savedView){return}this._updateShowInInboxItem()},getElement:function(){return this._menu.el},track:function(event,prop){BB.Tracker.trackStreakActive(this.trackingContext,prop,{eventName:event})}});function init(callback){BB.Modules.LeftLink.SavedViewsMenu=new SavedViewsMenu;if(callback){callback()}}Streak.DependencyManager.addFunction({functionKey:"leftLink.savedViewsMenuInitialized",functionToCall:init,dependentFunctionKeys:["menuInitialized","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superClass=Streak.UI.ViewController;var superPrototype=Streak.UI.ViewController.prototype;SimpleBoxesMenuViewController=Streak.Class.subclass({className:"SimpleBoxesMenuViewController",superclass:superClass,_memberVariables:[{name:"_listViewController",destroy:true},{name:"_boxDetailViewController",destroy:true},{name:"_searchBoxViewController",destroy:true},{name:"_listModel",destroy:true},{name:"_excludedBoxKeys",destroy:true},{name:"_boxFilterFunction",destroy:false},{name:"_isMenuOpen",destroy:true}],_initialize:function(){superPrototype._initialize.call(this);this._listModel=Library.getInstance("BentoBox.Widgets.ListView.ListViewBaseModel");this._listViewController=Library.getInstance("BentoBox.Widgets.ListView.ListViewViewController");this._listViewController.addDelegate(this);this._listViewController.setDataSource(this._listModel);this._listModel.addDelegate(this._listViewController);this._searchBoxViewController=new BB.Widgets.SearchSimpleVC;this._searchBoxViewController.addDelegate(this._listViewController);this._searchBoxViewController.addDelegate(this);this._searchBoxViewController.setPlaceholder(BB.Locale.getString("add_linked_box"));this._boxDetailViewController=new BB.Widgets.BoxesDetailsVC;this._view.setListView(this._listViewController.getView());this._view.setSearchBox(this._searchBoxViewController.getView());this._view.setBoxDetailPane(this._boxDetailViewController.getView());this._view.hideListContainer();this._blurTimeout},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuView")},setExcludedBoxKeys:function(excludedBoxKeys){this._excludedBoxKeys={};if(!excludedBoxKeys||!_.isArray(excludedBoxKeys)){return}for(var ii=0;ii<excludedBoxKeys.length;ii++){this._excludedBoxKeys[excludedBoxKeys[ii]]=true}},getFocusElement:function(){return this._searchBoxViewController.getFocusElement()},setBoxFilterFunction:function(boxFilterFunction){this._boxFilterFunction=boxFilterFunction},setEnabled:function(enabled){this._searchBoxViewController.setEnabled(enabled)},inputFocus:function(){clearTimeout(this._blurTimeout)},inputBlur:function(){var self=this;clearTimeout(this._blurTimeout);this._blurTimeout=setTimeout(function(){if(self._view){self._view.hideListContainer()}},250)},queryChange:function(query){this._listModel.removeAllSections();if(query.length===0){this._isMenuOpen=false;this._view.hideListContainer();return}this._isMenuOpen=true;this._view.showListContainer();var existingBoxes=BB.Services.BoxSearcher.searchNameByQuery(query,50);var self=this;existingBoxes=_.filter(existingBoxes,function(box){return!self._excludedBoxKeys[box.key()]});if(this._boxFilterFunction){existingBoxes=_.filter(existingBoxes,this._boxFilterFunction)}if(existingBoxes.length===0){this._isMenuOpen=false;this._view.hideListContainer();return}this._listModel.addSection({rows:_.map(existingBoxes,function(box){return{html:BB.UI.getBoxListDisplayHTML(box),displayClass:"streak__boxListRow",data:box}})})},rowFocused:function(rowInfo){if(!rowInfo||!rowInfo.data){return}this._boxDetailViewController.setModel(rowInfo.data)},rowPressed:function(rowInfo){if(!rowInfo||!rowInfo.data){return}this._callDelegateFunction("boxChosen",rowInfo.data);this._searchBoxViewController.clearQuery();BB.Tracker.track("simple boxes menu box chosen");this.inputFocus();this.focus()},emptyPressed:function(){this._callDelegateFunction("emptyPressed")},reset:function(){this._listModel.removeAllSections()},focus:function(){this._searchBoxViewController.focus()},setQuery:function(query){this._searchBoxViewController.setQuery(query)},getSearchBoxViewController:function(){return this._searchBoxViewController},isMenuOpen:function(){return this._isMenuOpen}});Library.set("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuViewController",SimpleBoxesMenuViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SimpleBoxesMenuView=Streak.Class.subclass({superclass:Streak.UI.View,_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("simpleBoxesMenu");this._listContainer=this._element.find(".streak__simpleBoxesMenu_listContainer");this._listContainer.detach()},setListView:function(listView){this._listContainer.find(".streak__simpleBoxesMenu_list").html(listView.getElement())},setSearchBox:function(searchView){this._element.find(".streak__simpleBoxesMenu_search").html(searchView.getElement())},setBoxDetailPane:function(boxDetailView){this._listContainer.find(".streak__simpleBoxesMenu_boxDetails").html(boxDetailView.getElement())},hideListContainer:function(){this._listContainer.detach()},showListContainer:function(){Gmail.elements.body.append(this._listContainer);this._listContainer.containByScreen(this._element.find(".streak__simpleBoxesMenu_search"))},hideList:function(){this._element.find(".streak__simpleBoxesMenu_list").hide()},showList:function(){this._element.find(".streak__simpleBoxesMenu_list").show()}});Library.set("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuView",SimpleBoxesMenuView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetLinkedBoxesView=Streak.Class.subclass({superclass:UI.View,_memberVariables:[{name:"_inputView",destroy:false}],_initialize:function(){UI.View.prototype._initialize.call(this);this._element=HTML.get("spreadsheetLinkedBoxes",true);return this},addLinkedBoxView:function(linkedBoxView){this._inputView.getElement().before(linkedBoxView.getElement())},setAddBoxInputView:function(inputView){this._inputView=inputView;this._element.append(inputView.getElement())}});Library.set("BentoBox.Widgets.SpreadsheetLinkedBoxesView",SpreadsheetLinkedBoxesView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,jwerty=Streak.jwerty,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetLinkedBoxesViewController=Streak.Class.subclass({superclass:UI.ViewController,_memberVariables:[{name:"_box",destroy:false},{name:"_property",destroy:false},{name:"_simpleBoxesMenu",destroy:true},{name:"_pipelineKey",destroy:false},{name:"_temporaryBoxKeys",destroy:true},{name:"_linkedBoxViewControllers",destroy:true},{name:"_searchBoxViewController",destroy:false},{name:"_trackingContext",destroy:true}],_initialize:function(options){UI.ViewController.prototype._initialize.call(this);this._simpleBoxesMenu=Library.getInstance("BentoBox.Modules.SimpleBoxesMenu.SimpleBoxesMenuViewController");this._simpleBoxesMenu.setBoxFilterFunction(_.bind(this._boxFilterFunction,this));this._simpleBoxesMenu.addDelegate(this);this._searchBoxViewController=this._simpleBoxesMenu.getSearchBoxViewController();this._setupSearchBoxViewController();this._view.setAddBoxInputView(this._simpleBoxesMenu.getView());this._linkedBoxViewControllers=[];this._trackingContext=options.trackingContext;return this},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.SpreadsheetLinkedBoxesView")},setup:function(options){for(var ii=0;ii<this._linkedBoxViewControllers.length;ii++){this._linkedBoxViewControllers[ii].destroy()}this._linkedBoxViewControllers.length=0;this._setBox(options.model);this._setProperty(options.property)},_setBox:function(box){this._box=box;this._temporaryBoxKeys=_.clone(this._box.get("linkedBoxKeys")||[])},_setProperty:function(property){this._property=property;var parts=property.split(".");if(parts.length>0){this._pipelineKey=parts[1]}else{this._pipelineKey=null}this._simpleBoxesMenu.setExcludedBoxKeys(this._temporaryBoxKeys.concat(this._box.key()));this._renderLinkedBoxesInPipeline()},updateValue:function(){var boxKeys=this._box.get("linkedBoxKeys")||[];if(!JSON.isEqual(boxKeys,this._temporaryBoxKeys)){var linkedBoxesLimiter=Library.get("BentoBox.Services.LinkedBoxesLimiter");if(this._temporaryBoxKeys.length>boxKeys){if(linkedBoxesLimiter.isLocked()){linkedBoxesLimiter.showGateway();this._temporaryBoxKeys=_.clone(this._box.get("linkedBoxKeys")||[]);return}}this.updateBoxes();BB.Tracker.track("spreadsheet linked boxes updated");linkedBoxesLimiter.incrementUsage()}},updateBoxes:function(){var boxesToSave=[this._box];var removedBoxKeys=[];var addedBoxKeys=[];var boxKeys=this._box.get("linkedBoxKeys")||[];for(var ii=0;ii<this._temporaryBoxKeys.length;ii++){var boxKey=this._temporaryBoxKeys[ii];if(boxKeys.indexOf(boxKey)===-1){addedBoxKeys.push(boxKey)}}for(var ii=0;ii<boxKeys.length;ii++){var boxKey=boxKeys[ii];if(this._temporaryBoxKeys.indexOf(boxKey)===-1){removedBoxKeys.push(boxKey)}}this._box.set("linkedBoxKeys",this._temporaryBoxKeys);for(var ii=0;ii<removedBoxKeys.length;ii++){var box=BB.Data.getBox(removedBoxKeys[ii]);if(!box){continue}boxKeys=box.get("linkedBoxKeys")||[];boxKeys.removeVal(this._box.key());box.set("linkedBoxKeys",boxKeys);boxesToSave.push(box)}for(var ii=0;ii<addedBoxKeys.length;ii++){var box=BB.Data.getBox(addedBoxKeys[ii]);if(!box){continue}boxKeys=box.get("linkedBoxKeys")||[];boxKeys.push(this._box.key());box.set("linkedBoxKeys",boxKeys);boxesToSave.push(box)}Streak.Model.saveAll(boxesToSave)},_boxFilterFunction:function(box){return!this._pipelineKey||box.getPipeline().key()===this._pipelineKey},_renderLinkedBoxesInPipeline:function(){var linkedBoxes=this._getLinkedBoxKeysInPipeline();for(var ii=0;ii<linkedBoxes.length;ii++){this._renderBoxInList(linkedBoxes[ii])}},_getLinkedBoxKeysInPipeline:function(){var boxKeys=this._box.get("linkedBoxKeys");if(!boxKeys){return[]}var pipelineKey=this._pipelineKey;return _.chain(boxKeys).map(function(boxKey){return BB.Data.getBox(boxKey)}).filter(function(box){return box&&(!pipelineKey||box.getPipeline().key()===pipelineKey)}).value()},_renderBoxInList:function(box){var linkedBoxViewController=Library.getInstance("BentoBox.Widgets.SpreadsheetLinkedBoxViewController");linkedBoxViewController.setBox(box);linkedBoxViewController.addDelegate(this);this._linkedBoxViewControllers.push(linkedBoxViewController);this._view.addLinkedBoxView(linkedBoxViewController.getView())},_setupSearchBoxViewController:function(){this._searchBoxViewController.setPlaceholder("");this._searchBoxViewController.addDelegate(this)},keydown:function(event){if(jwerty.is("escape",event)){this._temporaryBoxKeys=this._box.get("linkedBoxKeys");this._searchBoxViewController.getView().getElement().trigger("escapePressed");return}if(jwerty.is("backspace",event)){if(!this._searchBoxViewController.isEmpty()){return}if(!this._linkedBoxViewControllers||this._linkedBoxViewControllers.length===0){return}var lastBoxViewController=_.last(this._linkedBoxViewControllers);this.boxRemoved(lastBoxViewController.getBox(),lastBoxViewController);return}},boxChosen:function(box){_.mutate("union",this._temporaryBoxKeys,[box.key()]);this._simpleBoxesMenu.setExcludedBoxKeys(this._temporaryBoxKeys);this._renderBoxInList(box)},boxClicked:function(box){BB.UI.setURL(box.link())},boxRemoved:function(box,linkedBoxViewController){this._temporaryBoxKeys.removeVal(box.key());linkedBoxViewController.destroy();this._linkedBoxViewControllers.removeVal(linkedBoxViewController)},emptyPressed:function(){this._searchBoxViewController.getView().getElement().trigger("enterPressed")},getElement:function(){return this._view.getElement()},focus:function(isFromRedraw){if(!isFromRedraw){this._simpleBoxesMenu.reset()}this._simpleBoxesMenu.focus()},set:function(query){this._simpleBoxesMenu.reset();this._simpleBoxesMenu.setQuery(query)},preDetach:function(){for(var ii=0;ii<this._linkedBoxViewControllers.length;ii++){this._linkedBoxViewControllers[ii].destroy()}this._linkedBoxViewControllers.length=0}});Streak.Library.set("BentoBox.Widgets.SpreadsheetLinkedBoxesViewController",SpreadsheetLinkedBoxesViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetLinkedBoxView=Streak.Class.subclass({superclass:UI.View,_initialize:function(){UI.View.prototype._initialize.call(this);this._element=HTML.get("spreadsheetLinkedBox",true);this._setupBindings();return this},setText:function(text){this._element.find(".streak__spreadsheetLinkedBox_text").html(text);this._element[0].setAttribute("title",text)},_setupBindings:function(){var self=this;this._element.find(".streak__spreadsheetLinkedBox_text").on("click",function(e){self._callDelegateFunction("textClicked")});this._element.find(".streak__spreadsheetLinkedBox_x").on("click",function(e){self._callDelegateFunction("xClicked");e.stopPropagation()})}});Library.set("BentoBox.Widgets.SpreadsheetLinkedBoxView",SpreadsheetLinkedBoxView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetLinkedBoxViewController=Streak.Class.subclass({superclass:UI.ViewController,_memberVariables:[{name:"_box",destroy:false}],_initialize:function(){UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.SpreadsheetLinkedBoxView")},setBox:function(box){this._box=box;this._view.setText(box.displayName())},getBox:function(){return this._box},textClicked:function(){this._callDelegateFunction("boxClicked",this._box);BB.Tracker.track("spreadsheet linked box link clicked")},xClicked:function(){this._callDelegateFunction("boxRemoved",this._box,this);BB.Tracker.track("spreadsheet linked box x clicked")}});Library.set("BentoBox.Widgets.SpreadsheetLinkedBoxViewController",SpreadsheetLinkedBoxViewController)})(Streak);Streak.BentoBox.Modules.Reports={};Streak.BentoBox.Modules.Reports.Constants={ANY_USER:"ANY_USER",ALL_USERS:"ALL_USERS",HOURLY:"HOURLY",DAILY:"DAILY",WEEKLY:"WEEKLY",MONTHLY:"MONTHLY",YEARLY:"YEARLY",LAST_SIXTY_MINUTES:"LAST_SIXTY_MINUTES",TODAY:"TODAY",THIS_WEEK:"THIS_WEEK",THIS_MONTH:"THIS_MONTH",THIS_YEAR:"THIS_YEAR",INTO_STAGE_COLOR:"rgb(68, 185, 132)",OUT_OF_STAGE_COLOR:"rgb(230, 101, 80)",ALL_STAGES:"ALL_STAGES",KNOWN_DEALSIZE_COLUMNS:["Deal Size","Investment Amount","Amount","Cost","Rent"],DEALSIZE_COLUMN_BLACKLIST:["Stage","Assigned To"],GATEWAY_DELAY:5e3};(function(Streak){var $=Streak.$,_=Streak._,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,Date=Streak.Date,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports;var Constants=Reports.Constants;Reports.Utils={timeRangeToLocaleKey:function(timeRange){if(timeRange===Reports.Constants.LAST_SIXTY_MINUTES){return"time_range_last_sixty_minutes"
}if(timeRange===Reports.Constants.TODAY){return"time_range_this_day"}if(timeRange===Reports.Constants.THIS_WEEK){return"time_range_this_week"}if(timeRange===Reports.Constants.THIS_MONTH){return"time_range_this_month"}if(timeRange===Reports.Constants.THIS_YEAR){return"time_range_this_year"}},timeGranularityToLocaleKey:function(timeGranularity){if(timeGranularity===Reports.Constants.HOURLY){return"time_granularity_hour"}if(timeGranularity===Reports.Constants.DAILY){return"time_granularity_day"}if(timeGranularity===Reports.Constants.WEEKLY){return"time_granularity_week"}if(timeGranularity===Reports.Constants.MONTHLY){return"time_granularity_month"}if(timeGranularity===Reports.Constants.YEARLY){return"time_granularity_year"}},bestUnitForDurationInSeconds:function(seconds){var unitLowerBound=5;var units=[{sizeInSeconds:1,nameTranslationKey:"seconds",numberAbbreviationTranslationKey:"number_seconds_abbreviated"},{sizeInSeconds:60,nameTranslationKey:"minutes",numberAbbreviationTranslationKey:"number_minutes_abbreviated"},{sizeInSeconds:60*60,nameTranslationKey:"hours",numberAbbreviationTranslationKey:"number_hours_abbreviated"},{sizeInSeconds:60*60*24,nameTranslationKey:"days",numberAbbreviationTranslationKey:"number_days_abbreviated"}];for(var i=0;i<units.length;i++){var unit=units[units.length-i-1];if(unit.sizeInSeconds*unitLowerBound<seconds){return unit}}return units[0]},round:function(x,places){var convert=Math.pow(10,places);return Math.round(x*convert)/convert},containsUser:function(parameters){if(_.contains(parameters.userFilter,Reports.Constants.ANY_USER)&&parameters.user!==Reports.Constants.ALL_USERS){return true}if(_.contains(parameters.userFilter,parameters.user)){return true}return false},shouldShowUserColumn:function(userFilter){return!_.contains(userFilter,Reports.Constants.ALL_USERS)},filterJsonParts:function(parameters){var parts=parameters.parts;var filteredParts=[];for(var i=0;i<parts.length;i++){var part=parts[i];if(parameters.timeGranularity&&part.timeGranularity!==parameters.timeGranularity){continue}if(parameters.timeRange&&part.timeRange!==parameters.timeRange){continue}if(parameters.stageKey&&part.stageKey!==parameters.stageKey){continue}if(parameters.userFilter&&!Reports.Utils.containsUser({user:part.userKey,userFilter:parameters.userFilter})){continue}filteredParts.push(part)}return filteredParts},addUserNameToJsonParts:function(parameters){var parts=parameters.parts;var users=parameters.users;for(var i=0;i<parts.length;i++){var part=parts[i];if(part.userKey==="ALL_USERS"){part.userName=Locale.getString("reports_all_users")}else{var user=users[part.userKey];if(user){part.userName=user.displayName}}}},usersFromPipeline:function(parameters){var pipeline=parameters.pipeline;var users={};var boxes=BB.Data.getPipelineBoxes(pipeline.key());for(var i=0;i<boxes.length;i++){var box=boxes[i];var sharingEntries=box.getAssignedToSharingEntries();for(var j=0;j<sharingEntries.length;j++){var sharingEntry=sharingEntries[j];users[sharingEntry.userKey]={userKey:sharingEntry.userKey,displayName:sharingEntry.displayName}}}return users},timeRangeLocalization:function(timeRange){var timeRangeLocaleKey=this.timeRangeToLocaleKey(timeRange);return Locale.getString(timeRangeLocaleKey)},timeGranularityLocalization:function(timeGranularity){var timeGranularityLocaleKey=Reports.Utils.timeGranularityToLocaleKey(timeGranularity);return Locale.getString(timeGranularityLocaleKey)},getBoxValueForColumn:function(parameters){var box=parameters.box;var column=parameters.column;var pipeline=parameters.pipeline;if(column.columnType==="property"){return box.getGroupByValue(column.value.property)}else if(column.columnType==="field"){return box.getFieldGroupByValue(column.value.fieldKey)}},getBoxValueDisplayText:function(parameters){var column=parameters.column;var settings=column.value.columnKey;var group=parameters.key;var pipeline=parameters.pipeline;var name="no_value";if(settings==="property|stageKey"){var stage=pipeline.getStage(group);if(stage){name=pipeline.getStage(group).displayNameText()}}else if(settings.indexOf("property")>-1){var type=BB.Models.Pipeline.getPropertyFilterAndGroupType(column.value.property);switch(type){case"DATE":var d=Date.ccreate(group);if(d.isValid()){name=d.prettyDate(true)}break;default:name=group;break}}else if(settings.indexOf("field")>-1){var fieldKey=settings.split("|")[1];return BB.Models.BoxField.getGroupByDisplayTextValue(group,pipeline,fieldKey,settings.granularity)}if(name==="no_value"){return"No Value"}return name},isColumnDate:function(parameters){var column=parameters.column;var pipeline=parameters.pipeline;if(column.value.columnKey.indexOf("property")>-1){return BB.Models.Pipeline.getPropertyFilterAndGroupType(column.value.property)==="DATE"}else{return pipeline.getField(column.value.columnKey.split("|")[1])==="DATE"}},countWithSplitCredit:function(list,hashFunction){var results={};_.each(list,function(elt){var hashes=hashFunction(elt);var credit=1/hashes.length;_.each(hashes,function(hash){results[hash]=(results[hash]||0)+credit})});return results},sumWithSplitCredit:function(list,parameters){var results={};_.each(list,function(elt){var hashes=parameters.groupBy(elt);var credit=parameters.valueBy(elt)/hashes.length;_.each(hashes,function(hash){results[hash]=(results[hash]||0)+credit})});return results},_getOrderedColumnsForPipeline:function(pipeline){return BB.UI.getPipelineColumnList(pipeline,pipeline.getGroupableSystemColumns())},_isStageColumn:function(column){return column.columnType==="property"&&column.value.property==="stageKey"},_isAssignedToColumn:function(column){return column.columnType==="property"&&column.value.property==="assignedToSharingEntries"},_isLinkedBoxColumn:function(column){return column.columnType==="property"&&column.value.property.indexOf("linkedBoxes")>-1},getOrderedColumnKeysForPipeline_exceptStageAndAssignedTo:function(pipeline){var columns=this._getOrderedColumnsForPipeline(pipeline);var self=this;columns=_.reject(columns,function(column){return self._isStageColumn(column)||self._isAssignedToColumn(column)||self._isLinkedBoxColumn(column)});var columnKeys=[];for(var i=0;i<columns.length;i++){var column=columns[i];columnKeys.push(column.value.columnKey)}return columnKeys},getOrderedColumnKeysForPipeline:function(pipeline){var columns=this._getOrderedColumnsForPipeline(pipeline);var columnKeys=[];for(var i=0;i<columns.length;i++){var column=columns[i];columnKeys.push(column.value.columnKey)}return columnKeys},getStageColumnKeyForPipeline:function(pipeline){var self=this;var stageColumn=_.find(this.getColumnsForPipeline(pipeline),function(column){return self._isStageColumn(column)});if(!stageColumn){return null}return stageColumn.value.columnKey},getAssignedToColumnKeyForPipeline:function(pipeline){var self=this;var assignedToColumn=_.find(this.getColumnsForPipeline(pipeline),function(column){return self._isAssignedToColumn(column)});if(!assignedToColumn){return null}return assignedToColumn.value.columnKey},getAllColumnsForPipeline:function(pipeline){var orderedColumns=BB.UI.getPipelineColumnList(pipeline,pipeline.getAllSystemColumns().concat(BB.Models.Pipeline.getGroupableSystemProperties()));var columns={};for(var i=0;i<orderedColumns.length;i++){var column=orderedColumns[i];columns[column.value.columnKey]=column}return columns},getColumnsForPipeline:function(pipeline){var orderedColumns=BB.UI.getPipelineColumnList(pipeline,BB.Models.Pipeline.getGroupableSystemProperties());var columns={};for(var i=0;i<orderedColumns.length;i++){var column=orderedColumns[i];columns[column.value.columnKey]=column}return columns},getPrettyDateTimeStringFromSeconds:function(seconds){var timeString,shortTimeString;var days=seconds/(60*60*24);if(days<1){var hours=seconds/(60*60);if(hours<1){var minutes=seconds/60;if(minutes<1){var prettySeconds=Math.round(seconds);shortTimeString=Locale.getString("number_seconds_abbreviated",{number:prettySeconds});timeString=Locale.getString("number_seconds",{number:prettySeconds})}else{var prettyMinutes=this._prettifyNumber(minutes);shortTimeString=Locale.getString("number_minutes_abbreviated",{number:prettyMinutes});timeString=Locale.getString("number_minutes",{number:prettyMinutes})}}else{var prettyHours=this._prettifyNumber(hours);shortTimeString=Locale.getString("number_hours_abbreviated",{number:prettyHours});timeString=Locale.getString("number_hours",{number:prettyHours})}}else{var prettyDays=this._prettifyNumber(days);shortTimeString=Locale.getString("number_days_abbreviated",{number:prettyDays});timeString=Locale.getString("number_days",{number:prettyDays})}return{shortTimeString:shortTimeString,timeString:timeString}},_prettifyNumber:function(number){if(number>5){return Math.round(number)}else{return number.toFixed(1)}},unformatCurrency:function(value){var FAILURE=null;if(value==null)return FAILURE;if(typeof value==="number")return value;var stripped=(""+value).replace(/\((.*)\)/,"-$1").replace(/[^0-9-.,]/g,"");var validationRegex=/^-?(\d{1,3}(?:\.\d{3})*)(,\d{2}|-+)?$|^-?(\d{1,3}(?:,\d{3})*)(\.\d{2}|-+)?$|^-?(\d+)(\.\d+|-+)?$/;var match=validationRegex.exec(stripped);if(match){if(match[1]){var unformatted=parseFloat(match[1].replace(/[^0-9]/,"")+"."+(match[2]||"").replace(/[^0-9]/,""))}else{if(match[3]){var unformatted=parseFloat(match[3].replace(/[^0-9]/,"")+"."+(match[4]||"").replace(/[^0-9]/,""))}else{var unformatted=parseFloat(match[5].replace(/[^0-9]/,"")+"."+(match[6]||"").replace(/[^0-9]/,""))}}return!isNaN(unformatted)?unformatted:FAILURE}else{return FAILURE}return!isNaN(unformatted)?unformatted:0},formatCurrency:function(number,currencySymbol){if(!_.isFinite(number)){return"?"}if(!currencySymbol){currencySymbol="$"}var usePrecision=2,opts={thousand:",",decimal:"."};var negative=number<0?"-":"",base=parseInt(Math.abs(number).toFixed(usePrecision),10)+"",mod=base.length>3?base.length%3:0;return negative+currencySymbol+(mod?base.substr(0,mod)+opts.thousand:"")+base.substr(mod).replace(/(\d{3})(?=\d)/g,"$1"+opts.thousand)+(usePrecision?opts.decimal+Math.abs(number).toFixed(usePrecision).split(".")[1]:"")},deletePipelineSettings:function(pipelineKey){var pipeline=Data.getPipeline(pipelineKey);pipeline.setUISettings("reporting",null)},delegateUnfoundMethods:function(facade,backup){return _.extend(this.bindAll(backup),facade)},guessDealsizeColumn:function(columns){var res=_.find(columns,function(column){for(var i=0;i<Reports.Constants.KNOWN_DEALSIZE_COLUMNS.length;i++){if(Reports.Constants.KNOWN_DEALSIZE_COLUMNS[i]===column.name){return true}}return false});return res},possibleDealsizeColumns:function(pipeline,columns){return _.filter(columns,function(column){var blacklist=Reports.Constants.DEALSIZE_COLUMN_BLACKLIST;for(var i=0;i<blacklist.length;i++){if(column.name===blacklist[i]){return false}}return true})}}})(Streak);(function(Streak){var _=Streak._;var Reports=Streak.BentoBox.Modules.Reports;var Constants=Reports.Constants;var superclass=Streak.Object;Reports.TimeseriesData=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_users",destroy:false},{name:"_userColumns",destroy:false},{name:"_timestamps",destroy:false},{name:"_timeColumns",destroy:false},{name:"_timeColumnIndex",destroy:false},{name:"_data",destroy:false},{name:"_seriesStyles",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._data=new google.visualization.DataTable;this._users=[];this._userColumns={};this._timestamps=[];this._timeColumns={};this._seriesStyles={};this._timeColumnIndex=this._data.addColumn("datetime","Time")},addPoint:function(point){var userColumn=this._ensureUserColumnExists(point.series,point.tooltip);var timestampRow=this._ensureTimestampRowExists(point.time,point.tooltip);this._setPoint({rowIndex:timestampRow,columnIndex:userColumn,value:point.value});if(_.isReal(point.tooltip)){this._setPoint({rowIndex:timestampRow,columnIndex:userColumn+1,value:point.tooltip})}},setSeriesStyle:function(parameters){this._seriesStyles[parameters.series]=parameters.style},_setPoint:function(point){this._data.setCell(point.rowIndex,point.columnIndex,point.value)},_ensureUserColumnExists:function(user,withTooltip){if(!_.contains(this._users,user)){var userColumnIndex=this._data.addColumn("number",user);this._userColumns[user]=userColumnIndex;this._users.push(user);if(_.isReal(withTooltip)){this._data.addColumn({type:"string",role:"tooltip",p:{html:true}})}}return this._userColumns[user]},_ensureTimestampRowExists:function(timestamp,withTooltip){var normalizedTimestamp=this._hashTimestamp(timestamp);if(!_.contains(this._timestamps,normalizedTimestamp)){var timeRowsIndex=this._data.addRow();this._setPoint({rowIndex:timeRowsIndex,columnIndex:this._timeColumnIndex,value:timestamp});this._timestamps.push(normalizedTimestamp);this._timeColumns[normalizedTimestamp]=timeRowsIndex}return this._timeColumns[normalizedTimestamp]},_hashTimestamp:function(raw_timestamp){return raw_timestamp.getTime()},getVisualizationDataTable:function(){return this._data},getSeriesChartFormatter:function(){var styles=[];for(i=0;i<this._users.length;i++){var user=this._users[i];var style=this._seriesStyles[user];if(style){this.styles.push(style)}else{this.styles.push({})}}}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineReportSettingsGlobalController=Streak.Class.subclass({className:"PipelineReportSettingsGlobalController",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);this._bindToEvents()},_bindToEvents:function(){var self=this;BB.Data.getAllPipelines().watch("set",function(notification){var property=notification.property;var pipeline=notification.model;if(property!=="uiSettings"){return}NotificationCenter.postNotification({eventName:"pipelineReportSettings.changed",pipelineKey:pipeline.key(),sender:this})},this)}});Streak.DependencyManager.addFunction({functionKey:"pipelineReportSettingsGlobalControllerInitialized",functionToCall:function(callback){Library.set("BentoBox.PipelineReportSettingsGlobalController",new PipelineReportSettingsGlobalController);if(callback){callback()}},dependentFunctionKeys:["data.pipelines.initialized"]})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,HTML=Streak.HTML,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports,Tracker=Streak.BentoBox.Tracker,UI=Streak.UI;var superclass=UI.View;Reports.YellowConfigureBarView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_text",destroy:false},{name:"_title",destroy:false},{name:"_button",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._text=this._element.find(".streak__reports_configure_text");this._title=this._element.find(".streak__reports_configure_text_title");this._button=this._element.find(".streak__reports_configure_button");var self=this;this._confirmButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:BB.Locale.getString("reports_configure").capitalize(),color:"blue",onFunction:function(){self._callDelegateFunction("configureButtonPressed")}});this._button.html(this._confirmButton.getElement())},_setupElement:function(){this._element=HTML.getElement("streak_reports__yellow_configure_bar")},setText:function(text){this._text.text(text)},setHTML:function(html){this._text.html(html)},setTitle:function(text){this._title.text(text)}})})(Streak);(function(Streak){var _=Streak._,$=Streak.$,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports,Tracker=Streak.BentoBox.Tracker,UI=Streak.UI;var superclass=UI.ViewController;Reports.YellowConfigureBarViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_configureViewController",get:true,set:true,destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._view.addDelegate(this);this._view.setText(Locale.getString("reports_no_deal_size_columns_text"));this._view.setTitle(Locale.getString("reports_no_deal_size_columns_title"))},_setupView:function(){this._view=new Reports.YellowConfigureBarView},configureButtonPressed:function(){this.showConfigureView()},showConfigureView:function(){var modalInner=this._configureViewController.getView().getElement();var self=this;var modal=BB.Widgets.Modal.create({title:Locale.getString("reports_configure_title"),inner:modalInner,showConfirm:true,showCancel:false,width:475,confirmFunc:function(){self._configureViewController.save()},confirmText:Locale.getString("save")});modal.show()}})})(Streak);Streak.BentoBox.Modules.Reports.Charts={};(function(Streak){var _=Streak._,UI=Streak.UI,Reports=Streak.BentoBox.Modules.Reports,Locale=Streak.Locale,Utils=Streak.Utils,HTML=Streak.HTML;var superclass=Streak.UI.View;var CONSTANTS={BAR_HEIGHT:70};Reports.InOutView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_data",destroy:false},{name:"_backgroundColor",destroy:false},{name:"_textColor",destroy:false},{name:"_mainBox",destroy:false},{name:"_netBox",destroy:false},{name:"_inBar",destroy:false},{name:"_outBar",destroy:false},{name:"_inBarSpacer",destroy:false},{name:"_outBarSpacer",destroy:false}],_setupElement:function(){this._element=HTML.getElement("streak__reports_stage_report_in_out_box")},_initialize:function(){superclass.prototype._initialize.call(this);this._mainBox=this._element.find(".streak__reports_main_box");this._netBox=this._element.find(".streak__reports_net_label");this._inBar=this._element.find(".streak__inArrow .streak__reports_bar");this._outBar=this._element.find(".streak__outArrow .streak__reports_bar");this._inBarSpacer=this._element.find(".streak__inArrow .streak__reports_bar_spacer");this._outBarSpacer=this._element.find(".streak__outArrow .streak__reports_bar_spacer");this._data={};this._isSelected=false},setData:function(data){this._data=data;if(data){this._element.find(".streak__reports_inText").text(data.in);this._netBox.text(Utils.signedNumber(data.net));var netText=this._element.find(".streak__reports_net_label");if(data.net>0){netText.removeClass("streak__reports_none_color");netText.removeClass("streak__reports_out_of_color");netText.addClass("streak__reports_into_color")}else if(data.net<0){netText.removeClass("streak__reports_none_color");netText.removeClass("streak__reports_into_color");netText.addClass("streak__reports_out_of_color")}else{netText.addClass("streak__reports_none_color");netText.removeClass("streak__reports_into_color");netText.removeClass("streak__reports_out_of_color")}this._element.find(".streak__reports_outText").text(data.out);this._element.find(".streak__reports_inout_label").text(data.label);this._element.find(".streak__reports_inout_label").attr("data-tooltip",data.label);var inHeight=this._barHeight(data.in,data.max);var outHeight=this._barHeight(data.out,data.max);var inSpacerHeight=CONSTANTS.BAR_HEIGHT-inHeight;var outSpacerHeight=CONSTANTS.BAR_HEIGHT-outHeight;this._inBar.css({height:inHeight+"px"});this._outBar.css({height:outHeight+"px"});this._inBarSpacer.css({height:inSpacerHeight+"px"});this._outBarSpacer.css({height:outSpacerHeight+"px"})}else{this._element.find(".streak__reports_inText").text("");this._element.find(".streak__reports_outText").text("");this._element.find(".streak__reports_net").text("");this._element.find(".streak__reports_inout_label").text("")}this._redraw()},_barHeight:function(count,max){if(count==0){return 0}var logCount=Math.log(count)+1;var logMax=Math.log(max)+1;return logCount/logMax*CONSTANTS.BAR_HEIGHT},setBackgroundColor:function(backgroundColor){this._backgroundColor=backgroundColor;this._mainBox.css("background-color",backgroundColor);this._netBox.css("border-color",backgroundColor)},setTextColor:function(textColor){this._textColor=textColor;this._mainBox.css("color",textColor)},getZoomElement:function(){return this._mainBox},setZoomElementClickHandler:function(handler){this.getZoomElement().click(handler)},setSelected:function(){this._element.addClass("streak__reports_inout_selected")},setUnselected:function(){this._element.removeClass("streak__reports_inout_selected")},_redraw:function(){}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,UI=Streak.UI,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports;var superclass=Streak.Class.mixin(UI.ChartViewController);Reports.Charts.StageInOutViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_data",destroy:false},{name:"_stageKey",get:true,destroy:false},{name:"_pipeline",get:true,destroy:false}],_setupView:function(){this._view=new Reports.InOutView},_retrieveData:function(){this._data=this._dataSource.getSummaryData(this._stageKey);this._view.setData(this._data)},setPipeline:function(pipeline){this._pipeline=pipeline;this._setupColors()},_setupColors:function(){var backgroundColor="black";var textColor="white";if(this._stageKey&&this._pipeline){var stageColors=BB.UI.getStageColors(this._pipeline);backgroundColor=stageColors[this._stageKey].backgroundColor;textColor=stageColors[this._stageKey].textColor}this._view.setBackgroundColor(backgroundColor);this._view.setTextColor(textColor)},selectStageKey:function(stageKey){var self=this;this._stageKey=stageKey;this._setupColors();this._view.setZoomElementClickHandler(function(){self._notifySelected(stageKey)})},_notifySelected:function(stageKey){var parameters={view:this,stageKey:stageKey};this._callDelegateFunction("stageInOutMainViewSelected",parameters)},select:function(){this._view.setSelected()},unselect:function(){this._view.setUnselected()}})})(Streak);(function(Streak){var _=Streak._,HTML=Streak.HTML,Reports=Streak.BentoBox.Modules.Reports;var superclass=Streak.UI.ChartView;Reports.SummaryDetailChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_selection",destroy:false,get:true},{name:"_detailer",destroy:false,set:true},{name:"_summaryElements",destroy:false}],_setupElement:function(){this._element=HTML.getElement("streak__reports_summarydetail_view")},_initialize:function(){superclass.prototype._initialize.call(this);var self=this;this._summaryElements={};this._element.find(".streak__reports_summarydetail_summary")[0].onscroll=function(){self._summaryAreaScrolled()}},_getBoxInParent:function(childBox,parentBox){var parentLeft=parentBox.offset().left;var parentTop=parentBox.offset().top;var childLeft=childBox.offset().left;var childTop=childBox.offset().top;var childWidth=childBox.outerWidth();var childHeight=childBox.innerHeight();var left=childLeft-parentLeft;var top=childTop-parentTop;var right=left+childWidth;var bottom=top+childHeight;return{left:left,top:top,right:right,bottom:bottom,bottomLeft:{x:left,y:bottom},bottomRight:{x:right,y:bottom},topLeft:{x:left,y:top},topRight:{x:right,y:top}}},_redrawBackground:function(){var zoomQuadralateral=this._element.find(".streak__detail_zoom polygon");if(this.anySelected()){var index=this._selection;var summaryZoomBox=this.getSummaryZoomElement(index);var backgroundElement=this.getBackgroundElement();var summaryBoxPositionInBackgroundCoordinates=this._getBoxInParent(summaryZoomBox,backgroundElement);var detailBox=this.getDetailElement();var detailBoxPositionInBackgroundCoordinates=this._getBoxInParent(detailBox,backgroundElement);var topLeftPoint=summaryBoxPositionInBackgroundCoordinates.bottomLeft;var topRightPoint=summaryBoxPositionInBackgroundCoordinates.bottomRight;var bottomLeftPoint=detailBoxPositionInBackgroundCoordinates.topLeft;var bottomRightPoint=detailBoxPositionInBackgroundCoordinates.topRight;var polygonPointObjects=[topLeftPoint,topRightPoint,bottomRightPoint,bottomLeftPoint,topLeftPoint];var polygonPointsString="";for(var i=0;i<polygonPointObjects.length;i++){if(i>0){polygonPointsString+=" "}polygonPointsString+=polygonPointObjects[i].x+","+polygonPointObjects[i].y}zoomQuadralateral.attr("points",polygonPointsString);zoomQuadralateral.attr("visibility","visible")}else{zoomQuadralateral.attr("visibility","hidden")}},_summaryAreaScrolled:function(){this._redrawBackground()},setUnselected:function(){this._element.removeClass("streak__reports_summarydetail_selected")},setSelection:function(index){this._selection=index;this._loadDetailView();this._redrawBackground();this._element.addClass("streak__reports_summarydetail_selected")},anySelected:function(index){return this._selection!==null},addSummaryElement:function(view){var summary=this._element.find(".streak__reports_summarydetail_summary");var index=_.size(this._summaryElements);if(index>0){var spacer=HTML.getElement("streak__reports_sumamrydetail_spacer");summary.append(spacer)}summary.append(view.getElement());this._summaryElements[index]=view;return index},getSummaryZoomElement:function(index){return this._summaryElements[index].getZoomElement()},getDetailElement:function(){return this._element.find(".streak__reports_summarydetail_detail")},getBackgroundElement:function(){return this._element.find(".streak__reports_summarydetail_background")},windowResized:function(){superclass.prototype.windowResized.call(this);this._redrawBackground()},_notifySelected:function(index){var parameters={view:this,index:index};this._callDelegateFunction("summarySelectionChanged",parameters)},_loadDetailView:function(){if(this.anySelected()){var detailView=this._detailer.getDetailViewForIndex(this.getSelection());this._element.find(".streak__reports_summarydetail_detail").html(detailView.getElement())}else{this._element.find(".streak__reports_summarydetail_detail").html("")}}})})(Streak);(function(Streak){var _=Streak._,HTML=Streak.HTML,Reports=Streak.BentoBox.Modules.Reports;var superclass=Streak.UI.ChartViewController;Reports.SummaryDetailChartViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_summaryDetailData",destroy:false},{name:"_currentDetailIndex",destroy:false}],_setupView:function(){this._view=new Reports.SummaryDetailChartView},_initialize:function(){superclass.prototype._initialize.call(this);this._summaryDetailData={};this._view.setDetailer(this)},getDetailViewForIndex:function(index){return this._summaryDetailData[index].detailViewController.getView()},_makeDetailViewFor:function(key){throw new Error("Implement _makeDetailViewFor")},_makeSummaryViewFor:function(key){throw new Error("Implement _makeSummaryViewFor")},setSelectedChart:function(chart){this._selectedChart=chart;this._redrawBackground()},addSummaryElement:function(parameters){var key=parameters.key;parameters.summaryViewController=this._makeSummaryViewFor(key);parameters.detailViewController=this._makeDetailViewFor(key);var index=this._view.addSummaryElement(parameters.summaryViewController.getView());parameters.index=index;this._summaryDetailData[index]=parameters},select:function(key){if(_.isReal(this._currentDetailIndex)){this._summaryDetailData[this._currentDetailIndex].summaryViewController.unselect()}if(key===null){this._view.setSelection(null);this._currentDetailIndex=null;this._view.setUnselected();return}var item=_.find(_.values(this._summaryDetailData),function(item){return item.key===key});if(item){this._view.setSelection(item.index);this._summaryDetailData[item.index].summaryViewController.select();this._currentDetailIndex=item.index}},_destroy:function(){for(var i=0;i<this._summaryDetailData.length;i++){var datum=this._summaryDetailData[i];datum.summaryViewController.destroy();datum.summaryViewController.destroy()}superclass.prototype.destroy.call(this)}})})(Streak);Streak.BentoBox.Modules.Reports.ReportCards={};(function(Streak){var $=Streak.$,HTML=Streak.HTML,Locale=Streak.Locale,UI=Streak.UI,Reports=Streak.BentoBox.Modules.Reports;var superclass=UI.View;Reports.ReportCards.ReportCardView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_titleContainer",destroy:false},{name:"_toolbarContainer",destroy:false},{name:"_bodyContainer",destroy:false},{name:"_messageContainer",destroy:false},{name:"_numberOfMenuElementsInSection",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._titleContainer=this._element.find(".streak__reportCard_title");this._toolbarContainer=this._element.find(".streak__reportCard_toolbar");this._bodyContainer=this._element.find(".streak__reportCard_body");this._messageContainer=this._element.find(".streak__reportCard_message");this._explanationElement=this._element.find(".streak__reportCard_explanation");this._numberOfMenuElementsInSection={}},_setupElement:function(){this._element=HTML.getElement("streak__reportCard")},setTitle:function(title){this._titleContainer.html(title)},setBody:function(body){this.hideMessage();this._bodyContainer.html(body.getElement())},hideMessage:function(){this._messageContainer.hide();this._bodyContainer.show()},setMessage:function(message){this._bodyContainer.hide();this._messageContainer.show();this._messageContainer.html('<div class="streak__reports_message">'+message+"</div>")},showExplanation:function(text){this._explanationElement.attr("data-tooltip",text);this._explanationElement.show()},hideExplanation:function(){this._explanationElement.hide()},addMenu:function(menu){if(!menu.view){menu.view=menu}if(!menu.position){this.position=0}var insertPos=0;for(var positionKey in this._numberOfMenuElementsInSection){if(positionKey<=menu.position){var numberOfElementsInPosition=this._numberOfMenuElementsInSection[positionKey];insertPos=insertPos+numberOfElementsInPosition}}if(this._toolbarContainer.length>0){if(insertPos){var child=this._toolbarContainer.child(":nth-child("+insertPos+")");child.after(menu.view.getElement())}else{this._toolbarContainer.prepend(menu.view.getElement())}}else{this._toolbarContainer.append(menu.view.getElement())}this._numberOfMenuElementsInSection[menu.position]=(this._numberOfMenuElementsInSection[menu.position]||0)+1},showMenus:function(){this._toolbarContainer.show()},hideMenus:function(){this._toolbarContainer.hide()}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,Locale=Streak.Locale,BB=Streak.BentoBox,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports;var superclass=UI.ViewController;Reports.ReportCardViewController=Streak.Class.subclass({className:"ReportCardViewController",superclass:superclass,memberVariables:[{name:"_users",destroy:false},{name:"_titleLocaleKey",destroy:false},{name:"_relevantUserKeys",destroy:false},{name:"_bodyChartViewController",destroy:true},{name:"_userFilterMenu",destroy:true},{name:"_selectedUsers",get:true,destroy:false},{name:"_columnKey",destroy:false},{name:"_orderedColumnList",destroy:false},{name:"_orderedStageKeys",destroy:false},{name:"_pipeline",destroy:false},{name:"_reportName",destroy:false},{name:"_stageKey",destroy:false},{name:"_stageMenu",destroy:true},{name:"_stageMultipleSelectMenu",destroy:true},{name:"_selectedStageKeys",get:true,destroy:true},{name:"_allColumns",destroy:false}],_setupView:function(){this._view=new Reports.ReportCards.ReportCardView},_initialize:function(){superclass.prototype._initialize.call(this);this._selectedUsers=[Reports.Constants.ANY_USER];this._setupTrackingContext();this._gotReportData=false;this._view.setMessage(Locale.getString("notice_loading"));this.setupReportExplanation();this._view.hideMenus()},setupReportExplanation:function(){if(this._hasReportExplanation()){this._view.showExplanation(this._getReportExplanation())}else{this._view.hideExplanation()}},_hasUserFilterMenu:function(){return false},_setupTrackingContext:function(){this._trackingContext={widgetContext:"reportCard"}},_setupUserFilterMenu:function(){var self=this;if(!this._hasUserFilterMenu()){return}if(this._userFilterMenu){return}var userItems=this._getSortedUserFilterMenuItems();if(userItems.length){this._userFilterMenu=(new BB.Widgets.CollapsibleMultiselectMenuViewController).create({buttonOptions:{type:"GmailIconArrow",color:"default",hasButtonToLeft:true,isFixedPosition:true,text:Locale.getString("people"),postOffFunction:function(){}},buttonPrefixHTML:'<span style="font-weight:normal">'+Locale.getString("people")+": </span>",collapseItem:{label:Locale.getString("reports_all_people"),value:[Reports.Constants.ANY_USER]},expandItem:{label:Locale.getString("reports_select_people")},selectAllItem:{label:Locale.getString("menu_select_all")},selectNoneItem:{label:Locale.getString("menu_select_none")},items:userItems});
this._userFilterMenu.addDelegate(this);this._view.addMenu(this._userFilterMenu.getView())}},_getSortedUserFilterMenuItems:function(){this._relevantUserKeys=this._findRelevantUserKeys();var sortedUserKeys=this._getSortedRelevantUserKeys();var items=[];for(var i=0;i<sortedUserKeys.length;i++){var userKey=sortedUserKeys[i];items.push({value:userKey,label:this._users[userKey].displayName,selected:Reports.Utils.containsUser({user:userKey,userFilter:this._selectedUsers})})}return items},_getSortedRelevantUserKeys:function(){var users=this._users;return _.chain(this._relevantUserKeys).filter(function(userKey){return!!users[userKey]}).sortBy(function(userKey){return users[userKey].displayName}).value()},_findRelevantUserKeys:function(){throw new Error("_findRelevantUserKeys must be defined to use a menu of people")},_getUserNameForPart:function(part){if(part.userKey!==Reports.Constants.ALL_USERS){var userData=this._users[part.userKey];return userData.displayName}else{return Locale.getString("reports_all_users")}},getTitle:function(){return Locale.getString(this._titleLocaleKey)},setBodyChartViewController:function(chartViewController){this._bodyChartViewController=chartViewController},windowResized:function(){if(this._bodyChartViewController&&this._bodyChartViewController.windowResized){this._bodyChartViewController.windowResized()}},multiselectMenuSelectionsChanged:function(parameters){if(parameters.delegator===this._userFilterMenu){Tracker.trackStreakActive(this._trackingContext,{eventName:"userMenuChanged"});this.setSelectedUsers(parameters.selections)}if(parameters.delegator===this._stageMultipleSelectMenu){this.stageKeysSelectionChanged(parameters.selections)}if(this._refreshData){this._refreshData()}},setSelectedUsers:function(selectedUsers){this._selectedUsers=selectedUsers},_getPeopleSummary:function(){if(!this._selectedUsers){return""}if(this._selectedUsers.length===0){return Locale.getString("number_people",{number:this._selectedUsers.length})}if(this._selectedUsers[0]===Reports.Constants.ALL_USERS){return Locale.getString("reports_all_people")}if(this._selectedUsers[0]===Reports.Constants.ANY_USER){return Locale.getString("reports_all_people")}if(this._selectedUsers.length===1){return this._users[this._selectedUsers[0]].displayName}return Locale.getString("number_people",{number:this._selectedUsers.length})},_getReportExplanation:function(){return null},_hasReportExplanation:function(){return this._getReportExplanation()!==null},setPipeline:function(pipeline){this._pipeline=pipeline;this._orderedStageKeys=_.map(pipeline.getStages(),function(stage){return stage.key()});this._columns=Reports.Utils.getColumnsForPipeline(this._pipeline);this._allColumns=Reports.Utils.getAllColumnsForPipeline(this._pipeline);this._setupColumnMenu();this._setupStageMenu();this._setupStageMultipleSelectMenu()},_hasStageMenu:function(){return false},_hasStageMultipleSelectMenu:function(){return false},_hasColumnMenu:function(){return false},_setupColumnMenu:function(){if(this._hasColumnMenu()&&!this._columnMenu){this._columnMenu=this._createColumnMenu();this._view.addMenu(this._columnMenu)}},_createColumnMenu:function(){var self=this;var columnMenu=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this._trackingContext),prefixHTML:'<span style="font-weight:normal">'+Locale.getString("column")+": </span>",list:this._getColumnMenuItems(),changeFunc:function(menuItem){self.columnSelectionChanged(menuItem.value);Tracker.trackStreakActive(self._trackingContext,{eventName:"columnMenuChanged"})},hasButtonToRight:true});return columnMenu},_getColumnMenuItems:function(){var menuItems=[];for(var columnKey in this._columns){var columnValue=this._columns[columnKey];menuItems.push({name:columnValue.name,value:columnKey})}return menuItems},_setupStageMenu:function(){if(this._hasStageMenu()&&!this._stageMenu){this._stageMenu=this._createStageMenu();this._view.addMenu(this._stageMenu)}},_createStageMenu:function(){var self=this;var stageMenu=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this._trackingContext),prefixHTML:'<span style="font-weight:normal">'+Locale.getString("stage")+": </span>",list:this._getStageMenuItems(),changeFunc:function(menuItem){self.stageKeySelectionChanged(menuItem.value);Tracker.trackStreakActive(self._trackingContext,{eventName:"stageMenuChanged"})},hasButtonToRight:true});return stageMenu},_getStageMenuItems:function(){var menuItems=[];var stageKeys=this._orderedStageKeys;menuItems.push({name:Locale.getString("none_selected"),value:null});for(var i=0;i<stageKeys.length;i++){var stageKey=stageKeys[i];menuItems.push({name:this._pipeline.getStage(stageKey).displayName(),value:stageKey})}return menuItems},_setupStageMultipleSelectMenu:function(){if(this._hasStageMultipleSelectMenu()&&!this._stageMultipleSelectMenu){this._createStageMultipleSelectMenu();this._view.addMenu(this._stageMultipleSelectMenu.getView())}},_createStageMultipleSelectMenu:function(){var self=this;this._stageMultipleSelectMenu=(new BB.Widgets.CollapsibleMultiselectMenuViewController).create({buttonOptions:{type:"GmailIconArrow",color:"default",hasButtonToLeft:true,isFixedPosition:true,text:Locale.getString("stage"),postOffFunction:function(){}},buttonPrefix:'<span style="font-weight:normal">'+Locale.getString("stage")+": </span>",collapseItem:{label:Locale.getString("reports_all_stages"),value:[Reports.Constants.ALL_STAGES]},expandItem:{label:Locale.getString("reports_select_stages")},selectAllItem:{label:Locale.getString("menu_select_all")},selectNoneItem:{label:Locale.getString("menu_select_none")},items:this._getOrderedStageItems()});this._stageMultipleSelectMenu.addDelegate(this)},_getOrderedStageItems:function(){var stages=this._pipeline.getStages();var self=this;return _.map(stages,function(stage){return{value:stage.key(),label:stage.displayName(),selected:self._selectedStageKeys&&self._selectedStageKeys.indexOf(stage.key())>-1}})},columnSelectionChanged:function(column){this._columnKey=column;if(this._columnMenu){this._columnMenu.setSelected(column)}},stageKeySelectionChanged:function(stageKey){this._stageKey=stageKey;this._stageMenu.setSelected(stageKey)},stageKeysSelectionChanged:function(stageKeys){this._selectedStageKeys=stageKeys},selectStageKey:function(stageKey){this._stageMenu.setSelected(stageKey);this.stageKeySelectionChanged(stageKey)}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,Locale=Streak.Locale,BB=Streak.BentoBox,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports;var superclass=Reports.ReportCardViewController;Reports.ServerReportCardViewController=Streak.Class.subclass({className:"ServerReportCardViewController",superclass:superclass,memberVariables:[{name:"_json",destroy:false},{name:"_data",destroy:false},{name:"_gotReportData",destroy:false}],_handleReportDataSuccess:function(json){this._json=json;this._users=json.users;this._gotReportData=true;this._view.setBody(this._bodyChartViewController.getView());this._view.showMenus();this._refreshData({refreshUserFilterMenu:true,skipHandleReportDataSucessCallback:true})},_refreshData:function(parameters){this._view.setTitle(this.getTitle());if(!this._gotReportData){return}if(this._relevantUserKeys&&this._relevantUserKeys.length>0&&this.getSelectedUsers().length==0){this._view.setMessage(Locale.getString("reports_no_users_selected"))}else{this._view.hideMessage()}this._data=this._getFilteredDataFromJSON();if(this._hasUserFilterMenu()&&parameters&&parameters.refreshUserFilterMenu){this._setupUserFilterMenu()}this._callDelegateFunction("handleDataUpdated",this)},_getFilteredDataFromJSON:function(){throw new Error("_getFilteredDataFromJSON must be defined")},_handleReportDataFailure:function(){Tracker.trackStreakActive(this._trackingContext,{eventName:"reportLoadFailed"});this._view.setMessage(Locale.getString("reports_load_failed"));this._callDelegateFunction("handleReportFailed",this)},multiselectMenuSelectionsChanged:function(parameters){superclass.prototype.multiselectMenuSelectionsChanged.call(this,parameters);if(parameters.delegator===this._userFilterMenu){this._refreshData({causedByUserSelectionChange:true})}else if(parameters.delegator===this._stageMultipleSelectMenu){this._refreshData()}},_findRelevantUserKeys:function(){return Object.keys(this._json.users)},_getReportData:function(){Streak.APIRequester.get("pipelines/"+this._pipeline.key()+"/reports/"+this._reportName).getPromise().then(_.bind(this._handleReportDataSuccess,this),_.bind(this._handleReportDataFailure,this))},getChartData:function(){return this._data},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._getReportData()},columnSelectionChanged:function(column){superclass.prototype.columnSelectionChanged.call(this,column);this._refreshData()},stageKeySelectionChanged:function(stageKey){superclass.prototype.stageKeySelectionChanged.call(this,stageKey);this._refreshData()},setBodyChartViewController:function(chartViewController){superclass.prototype.setBodyChartViewController.call(this,chartViewController);this._bodyChartViewController.setDataSource(this)}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports,Locale=Streak.Locale;var superclass=Reports.ServerReportCardViewController;Reports.ReportCards.TimeRangeReportCardViewController=Streak.Class.subclass({className:"TimeRangeReportCardViewController",superclass:superclass,memberVariables:[{name:"_timeRange",destroy:false},{name:"_timeRangeMenu",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this.setTimeRange(Reports.Constants.THIS_WEEK);this._setupTimeRangeMenu()},getTitle:function(){if(!this._titleLocaleKey){return null}var timeRangeString=Reports.Utils.timeRangeLocalization(this._timeRange);return Locale.getString(this._titleLocaleKey,{timeRange:timeRangeString,people:this._getPeopleSummary()})},_setupTimeRangeMenu:function(){var self=this;this._timeRangeMenu=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this._trackingContext),prefixHTML:'<span style="font-weight:normal">'+Locale.getString("time_range")+": </span>",list:[{name:Locale.getString("time_range_this_day"),value:Reports.Constants.TODAY},{name:Locale.getString("time_range_this_week"),value:Reports.Constants.THIS_WEEK},{name:Locale.getString("time_range_this_month"),value:Reports.Constants.THIS_MONTH},{name:Locale.getString("time_range_this_year"),value:Reports.Constants.THIS_YEAR}],changeFunc:function(timeRange){self.setTimeRange(timeRange.value);Tracker.trackStreakActive(self._trackingContext,{eventName:"timeRangeMenuChanged"})},hasButtonToRight:true});if(this._timeRangeMenu){this._timeRangeMenu.setSelected(this._timeRange);this._view.addMenu(this._timeRangeMenu)}},setTimeRange:function(timeRange){this._timeRange=timeRange;this._refreshData({refreshUserFilterMenu:true})},_getFilteredDataFromJSON:function(){if(!this._json){return null}var filteredParts=Reports.Utils.filterJsonParts({parts:this._json.parts,timeRange:this._timeRange,userFilter:this.getSelectedUsers()});Reports.Utils.addUserNameToJsonParts({parts:filteredParts,users:this._json.users});return filteredParts}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports;var CONSTANTS={CHART_ITEM_HEIGHT:60,CHART_PADDING:0};var superclass=UI.ChartViewController;Reports.Charts.StageChangeStageDetailViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_inColor",destroy:false},{name:"_outColor",destroy:false},{name:"_stageKey",set:true,destroy:false},{name:"_pipeline",set:true,destroy:false}],_setupView:function(){this._view=new UI.BarChartView},_initialize:function(){superclass.prototype._initialize.call(this);this._view.setMinimum(0);this._view.setSeriesColors([Reports.Constants.INTO_STAGE_COLOR,Reports.Constants.OUT_OF_STAGE_COLOR]);this._view.setLegendWidth(250)},_retrieveData:function(){this._data=this._dataSource.getDetailData(this._stageKey);if(this._data){this._view.setHeight(CONSTANTS.CHART_ITEM_HEIGHT*this._data.length+CONSTANTS.CHART_PADDING);if(this._data.length>=15){this._view.setChartHeightPercentage(90)}else if(this._data.length>5){this._view.setChartHeightPercentage(80)}else{this._view.setChartHeightPercentage(null)}if(this._data.length===1){this._data.push(["",0,0])}}this._view.setData(this._data)}})})(Streak);(function(Streak){var _=Streak._,$=Streak.$,HTML=Streak.HTML,Reports=Streak.BentoBox.Modules.Reports;var superclass=Reports.SummaryDetailChartView;Reports.StageEventsTimeRangeSummaryDetailChartView=Streak.Class.subclass({superclass:superclass,_initialize:function(){superclass.prototype._initialize.call(this);var bar=$(document.createElement("div"));bar.addClass("streak__reports_yaxis_bar");this._element.find(".streak__reports_summarydetail_background").prepend(bar)}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,Locale=Streak.Locale,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports;var superclass=Reports.SummaryDetailChartViewController;Reports.Charts.StageChangeSummaryDetailChartViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_data",destroy:false},{name:"_summaryData",destroy:false},{name:"_pipeline",destroy:false},{name:"_stages",destroy:false},{name:"_stageKeys",destroy:false},{name:"_detailViewControllers",destroy:true},{name:"_summaryViewControllers",destroy:true},{name:"_setupSummaryViewIsSetUp",destroy:false},{name:"_filterInactiveUsers",destroy:true,get:true,set:true}],_setupView:function(){this._view=new Reports.StageEventsTimeRangeSummaryDetailChartView},_initialize:function(){superclass.prototype._initialize.call(this);this._setupTrackingContext();this._detailViewControllers={};this._summaryViewControllers={};this._setupSummaryViewIsSetUp=false;this._filterInactiveUsers=false},_setupTrackingContext:function(){this._trackingContext={widgetContext:"stageEventsSummaryDetail"}},setPipeline:function(pipeline){this._pipeline=pipeline;this._stages=pipeline.getStages();this._stageKeys=_.map(this._stages,function(stage){return stage.key()});this._setupSummaryView()},_retrieveData:function(){superclass.prototype._retrieveData.call(this);this._callDelegateFunction("handleDataUpdated",this)},getDetailData:function(stageKey){if(!this._data){return null}return this._getSingleStageDataSplitByUserFromParts(stageKey)},getSummaryData:function(stageKey){if(!this._data){return null}var data=this._getSummaryDataForSingleStageFromParts(stageKey);data.label=this._pipeline.getStage(stageKey).displayName();return data},_getSingleStageDataSplitByUserFromParts:function(stageKey){var parts;if(this._filterInactiveUsers){parts=this._data.sortBy(function(part){return-(part.in+part.out)})}else{parts=this._data.sortBy("userName")}var data=[];var headers=this._getHeaders();data.push(headers);for(var i=0;i<parts.length;i++){var part=parts[i];if(stageKey===part.stageKey){if(!(this._filterInactiveUsers&&part.in===0&&part.out===0)){data.push([part.userName,part.in,part.out])}}}return data},_getSummaryDataForSingleStageFromParts:function(stageKey){var data=this._getSummaryDataForAllStagesFromParts();return{"in":data.in[stageKey],out:data.out[stageKey],net:data.net[stageKey],max:data.max}},_getSummaryDataForAllStagesFromParts:function(){if(!this._data){return}var parts=this._data;var inCounts={};var outCounts={};var netCounts={};for(var i=0;i<parts.length;i++){var part=parts[i];var stageKey=part.stageKey;inCounts[stageKey]=(inCounts[stageKey]||0)+part.in;outCounts[stageKey]=(outCounts[stageKey]||0)+part.out;netCounts[stageKey]=(netCounts[stageKey]||0)+part.netChange}return{"in":inCounts,out:outCounts,net:netCounts,max:Math.max(_.max(_.values(inCounts)),_.max(_.values(outCounts)))}},_getHeaders:function(){var headerKeys=["reports_user","reports_stage_in","reports_stage_out"];return Locale.getStrings(headerKeys)},_makeDetailViewFor:function(stageKey){if(_.isUndefined(this._detailViewControllers[stageKey])){var viewController=new Reports.Charts.StageChangeStageDetailViewController;viewController.setDataSource(this);viewController.setPipeline(this._pipeline);viewController.setStageKey(stageKey);this._detailViewControllers[stageKey]=viewController}return viewController},_makeSummaryViewFor:function(stageKey){var viewController=new Reports.Charts.StageInOutViewController;viewController.setPipeline(this._pipeline);viewController.selectStageKey(stageKey);viewController.setDataSource(this);viewController.addDelegate(this);return viewController},handleDataUpdated:function(dataSource){superclass.prototype.handleDataUpdated.call(this,dataSource);this._setupSummaryView()},windowResized:function(){superclass.prototype.windowResized.call(this);_.each(this._detailViewControllers,function(subviewController){subviewController.windowResized()});_.each(this._summaryViewControllers,function(subviewController){subviewController.windowResized()})},_setupSummaryView:function(){if(!this._pipeline){return}if(!this._setupSummaryViewIsSetUp){this._setupSummaryViewIsSetUp=true;var self=this;_.each(this._stageKeys,function(stagekey){self.addSummaryElement({key:stagekey})})}},stageInOutMainViewSelected:function(parameters){Tracker.trackStreakActive(this._trackingContext,{eventName:"stageEventsStageToggled"});this._callDelegateFunction("selectedStageKeyToggled",this,parameters.stageKey)}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Reports=Streak.BentoBox.Modules.Reports,Locale=Streak.Locale;var superclass=Reports.ReportCards.TimeRangeReportCardViewController;Reports.ReportCards.StageChangeViewController=Streak.Class.subclass({className:"StageChangeViewController",superclass:superclass,memberVariables:[{name:"_inColor",destroy:false},{name:"_outColor",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupTrackingContext();this._reportName="StageEventsTimeRange";this._titleLocaleKey="report_title_stage_change";this.setBodyChartViewController(new Reports.Charts.StageChangeSummaryDetailChartViewController);this.configureBodyChartViewController();this._bodyChartViewController.addDelegate(this);this._view.setTitle(this.getTitle())},_hasStageMenu:function(){return true},_hasUserFilterMenu:function(){return true},_setupTrackingContext:function(){this._trackingContext={widgetContext:"stageChangeReportCard"}},configureBodyChartViewController:function(){if(this._selectedUsers&&this._selectedUsers[0]==="ANY_USER"){this._bodyChartViewController.setFilterInactiveUsers(true)}else{this._bodyChartViewController.setFilterInactiveUsers(false)}},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._bodyChartViewController.setPipeline(pipeline)},selectedStageKeyToggled:function(controller,stageKey){if(this._stageKey===stageKey){this.stageKeySelectionChanged(null)}else{this.stageKeySelectionChanged(stageKey)}},selectedUsersChanged:function(selectedUsers){superclass.prototype.selectedUsersChanged.call(this,selectedUsers);this.configureBodyChartViewController()},selectStageKey:function(controller,stageKey){superclass.prototype.selectStageKey.call(this,stageKey)},stageKeySelectionChanged:function(stageKey){this._bodyChartViewController.select(stageKey);superclass.prototype.stageKeySelectionChanged.call(this,stageKey)},_findRelevantUserKeys:function(){var parts=Reports.Utils.filterJsonParts({parts:this._json.parts,timeRange:this._timeRange});var userKeys={};for(var i=0;i<parts.length;i++){var part=parts[i];if(part.userKey=="ALL_USERS"){continue}if(part.in!==0||part.out!==0){userKeys[part.userKey]=true}}return Object.keys(userKeys)},_getReportExplanation:function(){return Locale.getString("stage_change_report_explanation")}})})(Streak);(function(Streak){var _=Streak._,$=Streak.$,UI=Streak.UI,HTML=Streak.HTML,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports;var CONSTANTS={MIN_STAGE_WIDTH:110};var superclass=UI.ChartView;Reports.TimeInStageChartView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_chartElement",destroy:false},{name:"_messageElement",destroy:false}],_setupElement:function(){this._element=HTML.getElement("streak__reports_timeInStage")},_initialize:function(){superclass.prototype._initialize.call(this);this._chartElement=this._element.find(".streak__reports_timeInStage_chart");this._messageElement=this._element.find(".streak__reports_timeInStage_message")},setStageConfigurations:function(stages){this.reset();this._chartElement.css("minWidth",stages.length*CONSTANTS.MIN_STAGE_WIDTH+"px");for(var i=0;i<stages.length;i++){this._addStage(stages[i])}},_addStage:function(parameters){var stageElement=HTML.getElement("streak__reports_timeInStage_stage");stageElement.css("background-color",parameters.backgroundColor);stageElement.css("minWidth",CONSTANTS.MIN_STAGE_WIDTH+"px");stageElement.css("color",parameters.textColor);stageElement.find(".streak__reports_timeInStage_stage_name").text(parameters.name);var timeStrings=this._getTimeStrings(parameters.seconds);var boxString=Locale.getString("number_boxes",{number:parameters.boxes,pluralize:[parameters.boxes]});stageElement.find(".streak__reports_timeInStage_stage_time").text(timeStrings.shortTimeString);stageElement.css("width",parameters.percentage+"%");stageElement.attr("data-tooltip",parameters.name+"\n"+timeStrings.timeString+"\n"+boxString);this._chartElement.append(stageElement)},_getTimeStrings:function(seconds){var timeString,shortTimeString;var days=seconds/(60*60*24);if(days<1){var hours=seconds/(60*60);if(hours<1){var minutes=seconds/60;if(minutes<1){var prettySeconds=Math.round(seconds);shortTimeString=Locale.getString("number_seconds_abbreviated",{number:prettySeconds});timeString=Locale.getString("number_seconds",{number:prettySeconds})}else{var prettyMinutes=this._prettifyNumber(minutes);shortTimeString=Locale.getString("number_minutes_abbreviated",{number:prettyMinutes});timeString=Locale.getString("number_minutes",{number:prettyMinutes})}}else{var prettyHours=this._prettifyNumber(hours);shortTimeString=Locale.getString("number_hours_abbreviated",{number:prettyHours});timeString=Locale.getString("number_hours",{number:prettyHours})}}else{var prettyDays=this._prettifyNumber(days);shortTimeString=Locale.getString("number_days_abbreviated",{number:prettyDays});timeString=Locale.getString("number_days",{number:prettyDays})}return{shortTimeString:shortTimeString,timeString:timeString}},_prettifyNumber:function(number){if(number>5){return Math.round(number)}else{return number.toFixed(1)}},reset:function(){this._chartElement.empty();this._chartElement.show();this._messageElement.empty();this._messageElement.hide()},showMessage:function(message){this._chartElement.hide();this._messageElement.show();this._messageElement.html(message)}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,BB=Streak.BentoBox,Locale=Streak.Locale,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports;var superclass=UI.ChartViewController;Reports.ReportCards.TimeInStageChartViewController=Streak.Class.subclass({className:"TimeInStageChartViewController",superclass:superclass,memberVariables:[{name:"_pipeline",destroy:false},{name:"_stages",destroy:false},{name:"_stageKeys",destroy:false},{name:"_stageColors",destroy:false},{name:"_totalSecondsInStage",destroy:false},{name:"_timeRange",destroy:false,get:true,set:true}],_setupView:function(){this._view=new Reports.TimeInStageChartView},_initialize:function(){superclass.prototype._initialize.call(this);this._setupTrackingContext()},_setupTrackingContext:function(){this._trackingContext={widgetContext:"timeInStageChart"}},setPipeline:function(pipeline){this._pipeline=pipeline;this._stages=pipeline.getStages();this._stageKeys=_.map(this._stages,function(stage){return stage.key()});this._stageColors=BB.UI.getStageColors(this._pipeline);this._setupChart()},_setupChart:function(){if(!this._data){return}this._populateStageTimePercentages();if(this._totalSecondsInStage===0){var timeRange=Reports.Utils.timeRangeLocalization(this._timeRange).toLowerCase();this._view.showMessage(Locale.getString("time_in_stage_no_data",{timeRange:timeRange}));return}var stages=[];for(var i=0;i<this._stageKeys.length;i++){var stageKey=this._stageKeys[i];var stageData=_.find(this._data,function(stageData){return stageData.stageKey===stageKey});if(!_.isUndefined(stageData)){var stage=this._pipeline.getStage(stageData.stageKey);var stageColor=this._stageColors[stageData.stageKey];var backgroundColor=stageColor.backgroundColor;var textColor=stageColor.textColor;if(stageData.averageSecondsInStage>0){stages.push({name:stage.displayName(),backgroundColor:backgroundColor,textColor:textColor,seconds:stageData.averageSecondsInStage,percentage:stageData.percentage,boxes:stageData.boxesExitingStage})}}}this._view.setStageConfigurations(stages)},_populateStageTimePercentages:function(){this._totalSecondsInStage=0;for(var i=0;i<this._data.length;i++){var stageData=this._data[i];if(stageData.averageSecondsInStage){this._totalSecondsInStage+=stageData.averageSecondsInStage}}for(var i=0;i<this._data.length;i++){var stageData=this._data[i];if(stageData.averageSecondsInStage){stageData.percentage=100*(stageData.averageSecondsInStage/this._totalSecondsInStage)}else{stageData.percentage=0}}},handleDataUpdated:function(dataSource){superclass.prototype.handleDataUpdated.call(this,dataSource);this._setupChart()},windowResized:function(){this._setupChart()}})})(Streak);(function(Streak){var _=Streak._,Reports=Streak.BentoBox.Modules.Reports,UI=Streak.UI,Locale=Streak.Locale;var superclass=Reports.ReportCards.TimeRangeReportCardViewController;Reports.ReportCards.TimeInStageViewController=Streak.Class.subclass({className:"TimeInStageViewController",superclass:superclass,_initialize:function(){superclass.prototype._initialize.call(this);this._selectedUsers=[Reports.Constants.ALL_USERS];this._setupTrackingContext();this._reportName="StageTimeTimeRange";this._titleLocaleKey="report_title_time_in_stage";this._view.setTitle(this.getTitle());this.setBodyChartViewController(new Reports.ReportCards.TimeInStageChartViewController)},setBodyChartViewController:function(bodyChartViewController){superclass.prototype.setBodyChartViewController.call(this,bodyChartViewController);bodyChartViewController.setTimeRange(this._timeRange)},_setupTrackingContext:function(){this._trackingContext={widgetContext:"timeInStageReportCard"}},setTimeRange:function(timeRange){superclass.prototype.setTimeRange.call(this,timeRange);if(this._bodyChartViewController){this._bodyChartViewController.setTimeRange(timeRange)}},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._bodyChartViewController.setPipeline(pipeline)},_hasUserFilterMenu:function(){return false},_getFilteredDataFromJSON:function(){var parts=superclass.prototype._getFilteredDataFromJSON.call(this);var data=[];for(var i=0;i<parts.length;i++){var part=parts[i];var averageSecondsInStage=part.averageSecondsInStage==="undefined"?0:part.averageSecondsInStage;data.push({stageKey:part.stageKey,averageSecondsInStage:averageSecondsInStage,boxesExitingStage:part.boxesExitingStage})}return data},_getReportExplanation:function(){return Locale.getString("time_in_stage_report_explanation")}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,Date=Streak.Date,Reports=Streak.BentoBox.Modules.Reports,UI=Streak.UI,Locale=Streak.Locale;var superclass=Reports.ServerReportCardViewController;Reports.ReportCards.ColumnSpecificChartViewController=Streak.Class.subclass({className:"ColumnSpecificChartViewController",superclass:superclass,memberVariables:[{name:"_chartView",destroy:false},{name:"_defaultColumn",get:true,set:true,destroy:false},{name:"_lastSelectedColumn",destroy:false},{name:"_lastSelectedUsers",destroy:false},{name:"_lastSelectedStageKeys",destroy:false},{name:"_totalBoxes",destroy:true}],_initialize:function(parameters){superclass.prototype._initialize.call(this);this._selectedUsers=[Reports.Constants.ALL_USERS];this._setupTrackingContext();this._reportName="ColumnSpecificRingChart";this._titleLocaleKey="report_title_column_specific_over_time";this._view.setTitle(this.getTitle());this._configureChartView();this.defaultColumn=null},getTitle:function(){if(!this._titleLocaleKey){return null}return Locale.getString(this._titleLocaleKey,{column:this.getColumnName(),people:this._getPeopleSummary()})},_setupTrackingContext:function(){this._trackingContext={widgetContext:"columnSpecificReportCard"}},setTotalBoxes:function(totalBoxes){this._totalBoxes=totalBoxes;this._chartView.setCenterLabelValue(this._totalBoxes);this._chartView.setCenterLabelUnit(Locale.getString("boxes").toLowerCase())},_hasStageMultipleSelectMenu:function(){return true},_hasUserFilterMenu:function(){return true},_hasColumnMenu:function(){return true},getColumnName:function(){if(this.getColumn()){return this.getColumn().name}else{return""}},_configureChartView:function(){this.setBodyChartViewController(new UI.ChartViewController);var chartView=UI.ChartFactory.createChart({type:"RING_CHART",height:300,chartArea:{width:"70%",height:"90%"},sliceVisibilityThreshold:1/72,pieHole:.5});this._chartView=chartView;this._bodyChartViewController.setView(chartView)},_getReportData:function(parameters){this._loadUserDataForPipeline();var selectedColumn=this.getColumn();var data=[this._getHeaders()];var pipeline=this._pipeline;if(selectedColumn){var boxes=Data.getPipelineBoxes(this._pipeline.key());var selectedStageKeys=this.getSelectedStageKeys();if(selectedStageKeys){boxes=_.filter(boxes,function(box){var stageKey=box.get("stageKey");return _.contains(selectedStageKeys,stageKey)})}var userFilter=this.getSelectedUsers();if(userFilter&&!_.contains(userFilter,Reports.Constants.ALL_USERS)){boxes=_.filter(boxes,function(box){var assignedTos=box.getAssignedToSharingEntries();if(Reports.Utils.containsUser({userFilter:userFilter,user:box.get("creatorKey")})){return true}for(var i=0;i<assignedTos.length;i++){var user=assignedTos[i];if(Reports.Utils.containsUser({userFilter:userFilter,user:user.userKey})){return true}}return false})}this.setTotalBoxes(boxes.length);var grouped=Reports.Utils.countWithSplitCredit(boxes,function(box){return Reports.Utils.getBoxValueForColumn({box:box,column:selectedColumn,pipeline:pipeline})});_.each(grouped,function(value,key){data.push([Reports.Utils.getBoxValueDisplayText({column:selectedColumn,key:key,pipeline:pipeline}),value])})}var json={users:this._users,data:data};var handleSuccessParams={refreshUserFilterMenu:!(parameters&&parameters.causedByUserSelectionChange)};this._handleReportDataSuccess(json,handleSuccessParams)},reportWorthShowing:function(){if(Reports.Utils.isColumnDate({column:this._allColumns[this._defaultColumn],pipeline:this._pipeline})){return false}var data=this._json.data;return!(data.length<=1||data.length==2&&data[1][0]!=="No Value")},_handleReportDataSuccess:function(json,parameters){this._json=json;this._users=json.users;this._gotReportData=true;this._view.setBody(this._bodyChartViewController.getView());this._view.showMenus();this._refreshData({refreshUserFilterMenu:parameters&&parameters.refreshUserFilterMenu,skipHandleReportDataSucessCallback:true})},_loadUserDataForPipeline:function(){this._users=Reports.Utils.usersFromPipeline({pipeline:this._pipeline})},_refreshData:function(parameters){if(this._filterOptionsChanged()){this._setLastFilterOptions();this._getReportData(parameters)}superclass.prototype._refreshData.call(this,parameters)},_getFilteredDataFromJSON:function(){return google.visualization.arrayToDataTable(this._json.data)},_filterOptionsChanged:function(){if(this.getSelectedStageKeys()!==this._lastSelectedStageKeys){return true}if(this.getSelectedUsers()!==this._lastSelectedUsers){return true}if(this._columnKey!==this._lastSelectedColumn){return true}return false},_setLastFilterOptions:function(){this._lastSelectedStageKeys=this.getSelectedStageKeys();
this._lastSelectedUsers=this.getSelectedUsers();this._lastSelectedColumn=this._columnKey},_getHeaders:function(sortedStageKeys){return["Value","Number of Boxes"]},_getReportExplanation:function(){return Locale.getString("column_specific_report_explanation",{column:this.getColumnName()})},getColumn:function(){if(this._columnKey){return this._columns[this._columnKey]}else{return null}},columnSelectionChanged:function(column){superclass.prototype.columnSelectionChanged.call(this,column);this.setupReportExplanation()},setPipeline:function(pipeline){var ret=superclass.prototype.setPipeline.call(this,pipeline);if(this.getDefaultColumn()&&!this._columnKey){this.columnSelectionChanged(this.getDefaultColumn())}return ret}})})(Streak);(function(Streak){var Reports=Streak.BentoBox.Modules.Reports;var superclass=Reports.ReportCards.ColumnSpecificChartViewController;Reports.ReportCards.AssignedToColumnChartViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_hasColumnMenu:function(){return false},_hasUserFilterMenu:function(){return false}})})(Streak);(function(Streak){var Reports=Streak.BentoBox.Modules.Reports;var superclass=Reports.ReportCards.ColumnSpecificChartViewController;Reports.ReportCards.StageColumnChartViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_hasColumnMenu:function(){return false},_hasStageMultipleSelectMenu:function(){return false}})})(Streak);Streak.BentoBox.Modules.Reports.PipelineReports={};(function(Streak){var HTML=Streak.HTML,BB=Streak.BentoBox;var superclass=Streak.UI.View;BB.Modules.Reports.PipelineReports.PipelineReportsView=Streak.Class.subclass({superclass:superclass,_setupElement:function(){this._element=HTML.getElement("streak__pipelineReports")},setPipelineName:function(pipelineName){this._element.find(".streak__reports_title").html(pipelineName)},setBackButton:function(backButton){this._element.find(".streak__reports_backButton").html(backButton.el)},addMenu:function(menu){this._element.find(".streak__reports_toolbarButtons").append(menu.getElement())},setReportCollectionView:function(view){this._element.find(".streak__reports_reportCollectionContainer").html(view.getElement())}})})(Streak);(function(Streak){var _=Streak._,$=Streak.$,BB=Streak.BentoBox,Locale=Streak.Locale,HTML=Streak.HTML,UI=Streak.UI,Reports=Streak.BentoBox.Modules.Reports;var ReportCards=Reports.ReportCards;var superclass=Streak.UI.ViewController;Reports.PipelineReports.PipelineReportsViewController=Streak.Class.subclass({className:"PipelineReportsViewController",superclass:superclass,memberVariables:[{name:"_pipeline",destroy:false},{name:"_reportCardCollectionViewController",destroy:true},{name:"_reportCardViewControllers",destroy:true},{name:"_trackingContext",destroy:false},{name:"_windowResizeListener",destroy:false},{name:"_reportsReady",destroy:false},{name:"_specialColumnsRow",destroy:false},{name:"_gateway",destroy:true}],_setupView:function(){this._view=new Reports.PipelineReports.PipelineReportsView},_initialize:function(){superclass.prototype._initialize.call(this);this._reportCardViewControllers=[];this._reportsReady=[];this._setupTrackingContext();this._attachView();this._beginGateway();this._setupBackButton();this._setupReportsCollection();this._addWindowResizeListener();return this},_setupTrackingContext:function(){this._trackingContext={widgetContext:"pipelineReports"}},_attachView:function(){BB.UI.getCanvas().append(this._view.getElement())},_beginGateway:function(){if(BB.isFeatureEnabled("reports")){return}this._gateway=new BB.Widgets.PaywallGatewayViewController({title:Locale.getString("reports_gateway_title"),text:Locale.getString("reports_gateway_text")});setTimeout(this._showGateway.bind(this),Reports.Constants.GATEWAY_DELAY)},_showGateway:function(){var self=this;BB.Tracker.trackStreakActive({eventName:"reportsGatewayShown"},this._trackingContext);this._gateway.show({closed:function(upgradeClicked){if(!upgradeClicked){BB.Tracker.trackStreakActive({eventName:"reportsGatewayCancelPressed"},self._trackingContext);history.back()}else{BB.Tracker.trackStreakActive({eventName:"reportsGatewayUpgradePressed"},self._trackingContext)}}})},_setupBackButton:function(){var self=this;var backButton=BB.Widgets.Button.create({isToggle:false,name:HTML.get("pipelineToolbarBackButton"),onFunc:function(){BB.Tracker.trackStreakActive({eventName:"backButtonPressed"},self._trackingContext);history.back()}});this._view.setBackButton(backButton)},_setupReportsCollection:function(){this._reportCardCollectionViewController=new UI.SplitRowsCollectionViewController;this._view.setReportCollectionView(this._reportCardCollectionViewController.getView());this._setupReportViews()},_setupReportViews:function(){this._specialColumnsRow=this._reportCardCollectionViewController.addRow();var viewControllerClasses=[[ReportCards.TotalValueReportCardViewController,ReportCards.TotalValueByPersonReportCardViewController],[ReportCards.StageChangeViewController],[ReportCards.TimeInStageViewController]];for(var i=0;i<viewControllerClasses.length;i++){var viewControllerClassRow=viewControllerClasses[i];for(var j=0;j<viewControllerClassRow.length;j++){var reportCardViewControllerClass=viewControllerClassRow[j];this._setupCardViewController({reportCardViewControllerClass:reportCardViewControllerClass,newRow:j==0})}}},_setupCardViewController:function(parameters){var reportCardViewController=new parameters.reportCardViewControllerClass;reportCardViewController.addDelegate(this);this.addDelegate(reportCardViewController);if(parameters.newRow){var row=this._reportCardCollectionViewController.addRow()}else{var row=this._reportCardCollectionViewController.getLastRow()}this._reportCardCollectionViewController.addViewControllerToRow(reportCardViewController,row);this._reportCardViewControllers.push(reportCardViewController);return reportCardViewController},_addWindowResizeListener:function(){this._windowResizeListener=_.bind(_.debounce(this._handleWindowResize,100),this);window.addEventListener("resize",this._windowResizeListener)},_handleWindowResize:function(){this._callDelegateFunction("windowResized")},setPipeline:function(pipeline){this._pipeline=pipeline;this._setupTitle();this._setupColumnReports();this._callDelegateFunction("setPipeline",this._pipeline)},_setupTitle:function(){this._view.setPipelineName(BB.Locale.getString("pipeline_reports_title",{pipeline:this._pipeline.displayName()}))},_setupColumnReports:function(){var stageColumnKey=Reports.Utils.getStageColumnKeyForPipeline(this._pipeline);if(stageColumnKey){var stageColumnReport=new ReportCards.StageColumnChartViewController;stageColumnReport.addDelegate(this);this.addDelegate(stageColumnReport);stageColumnReport.setDefaultColumn(stageColumnKey);stageColumnReport.setPipeline(this._pipeline);this._reportCardCollectionViewController.addViewControllerToRow(stageColumnReport,this._specialColumnsRow)}var assignedToColumnKey=Reports.Utils.getAssignedToColumnKeyForPipeline(this._pipeline);if(assignedToColumnKey){var assignedToColumnReport=new ReportCards.AssignedToColumnChartViewController;assignedToColumnReport.addDelegate(this);this.addDelegate(assignedToColumnReport);assignedToColumnReport.setDefaultColumn(assignedToColumnKey);assignedToColumnReport.setPipeline(this._pipeline);this._reportCardCollectionViewController.addViewControllerToRow(assignedToColumnReport,this._specialColumnsRow)}var columnKeys=Reports.Utils.getOrderedColumnKeysForPipeline_exceptStageAndAssignedTo(this._pipeline);var reportsWorthShowing=[];for(var i=0;i<columnKeys.length&&reportsWorthShowing.length<2;i++){var columnKey=columnKeys[i];var cardController=new ReportCards.ColumnSpecificChartViewController;cardController.addDelegate(this);this.addDelegate(cardController);cardController.setDefaultColumn(columnKey);cardController.setPipeline(this._pipeline);if(cardController.reportWorthShowing()){reportsWorthShowing.push(cardController)}}var row=null;for(var i=0;i<reportsWorthShowing.length;i++){var cardController=reportsWorthShowing[i];if(i%2==0){row=this._reportCardCollectionViewController.addRow()}this._reportCardCollectionViewController.addViewControllerToRow(cardController,row)}},handleReportFailed:function(reportViewController){this._handleReportReady(reportViewController)},_handleReportReady:function(reportViewController){if(this._reportsReady.indexOf(reportViewController)===-1){this._reportsReady.push(reportViewController)}},destroy:function(){this._removeWindowResizeListener();superclass.prototype.destroy.call(this)},_removeWindowResizeListener:function(){window.removeEventListener("resize",this._windowResizeListener)}})})(Streak);(function(Streak){var _=Streak._,Gmail=Streak.Gmail,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports;var superclass=Streak.Object;Reports.PipelineReports.PipelineReportsMasterController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_pipelineReportsViewController",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._bindToGmail();this._viewChanged()},_bindToGmail:function(){var self=this;Gmail.observe("viewChanged",function(view){self._viewChanged()})},_viewChanged:function(){if(this._pipelineReportsViewController){this._pipelineReportsViewController.destroy();this._pipelineReportsViewController=null}if(BB.UI.isPipelineReportsView()){this._pipelineReportsViewController=new Reports.PipelineReports.PipelineReportsViewController;Tracker.trackStreakActive({eventName:"goToPipelineReports"});this._pipelineReportsViewController.setPipeline(BB.Data.getPipeline(Gmail.getConversationId()))}}});Streak.DependencyManager.addFunction({functionKey:"pipelineReportsInitialized",functionToCall:function(callback){Reports.PipelineReports.PipelineReportsMasterControllerInstance=new Reports.PipelineReports.PipelineReportsMasterController;if(callback){callback()}},dependentFunctionKeys:["htmlLoaded","localeLoaded","chartsInitialized"]})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,DependencyManager=Streak.DependencyManager,Gmail=Streak.Gmail,Library=Streak.Library,Utils=Streak.Utils;var superclass=Streak.Object;var initialLocationHash=Messenger.getData("originalLocation")||location.hash;var DeepLinkLoaderMasterController=Streak.Class.subclass({superclass:superclass,_memberVariables:[{name:"_deepLinkFunction",destroy:true},{name:"_deepLinkKey",destroy:true},{name:"_deepLinkLoadingViewController",destroy:true},{name:"_initialLocationHash",get:true,destroy:true},{name:"_viewChangedBindingGUID",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this.setInitialLocationHash(initialLocationHash);if(BB.UI.isBentoBoxView(this.getInitialView())){this._bindAll()}},destroy:function(){superclass.prototype.destroy.call(this);this._unbindAll()},_bindAll:function(){this._bindToViewChanged();this._bindToGmailLoaded();this._bindToBentoBoxLoaded()},_unbindAll:function(){this._unbindToViewChanged();Streak.NotificationCenter.unsubscribe({observer:this})},setInitialLocationHash:function(complicatedHash){if(complicatedHash.indexOf("#")===-1){this._initialLocationHash="";return}var hash=Utils.removePrefix(complicatedHash,"#");while(hash.startsWith("loading/")){hash=Utils.removePrefix(hash,"loading/")}this._initialLocationHash=hash},getInitialView:function(){return Gmail.getStoredView(this.getInitialLocationHash().split("/"))},_bindToViewChanged:function(){var self=this;if(!this._viewChangedBindingGUID){this._viewChangedBindingGUID=Streak.guid();Gmail.observe("viewChanged",this._viewChanged.bind(this),this._viewChangedBindingGUID)}},_unbindToViewChanged:function(){if(this._viewChangedBindingGUID){Gmail.unobserve("viewChanged",this._viewChangedBindingGUID);this._viewChangedBindingGUID=null}},_bindToGmailLoaded:function(){Streak.NotificationCenter.subscribe({eventName:"gmailLoaded",functionToCall:this._gmailLoaded,observer:this})},_bindToBentoBoxLoaded:function(){Streak.NotificationCenter.subscribe({eventName:"bentoBoxIsReady",functionToCall:this._bentoBoxLoaded,observer:this})},_viewChanged:function(newView){if(!this._deepLinkLoadingEverShown){this.showDeepLinkLoading()}else if(BB.UI.isDeepLinkLoadingView()){}else{this.hideDeepLinkLoading()}},_gmailLoaded:function(){this.showDeepLinkLoading()},_bentoBoxLoaded:function(){if(!this._deepLinkLoadingHidden){this.hideDeepLinkLoading()}},showDeepLinkLoading:function(){if(this._deepLinkLoadingHidden){return}this._deepLinkLoadingEverShown=true;if(!BB.UI.isDeepLinkLoadingView()){BB.UI.setURL(Gmail.Constants.DeepLinkLoading+"/"+this.getInitialLocationHash())}},hideDeepLinkLoading:function(){this._deepLinkLoadingHidden=true;if(BB.UI.isDeepLinkLoadingView()){this.goToInitiallyLoadedLocation()}},goToInitiallyLoadedLocation:function(){BB.UI.setURL(this.getInitialLocationHash())},getLoadingViewTarget:function(){return Gmail.hash.parts[1]}});Library.set("BentoBox.Modules.DeepLinkLoader.DeepLinkLoaderMasterController",DeepLinkLoaderMasterController);Streak.DependencyManager.addFunction({functionKey:"deepLinkLoaderMasterControllerInitialized",functionToCall:function(callback){try{Library.set("BentoBox.Modules.DeepLinkLoader.DeepLinkLoaderMasterControllerInstance",new DeepLinkLoaderMasterController)}catch(e){BB.logError("Problem in deepLinkLoader constructor",e)}if(callback){callback()}}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,HTML=Streak.HTML,Library=Streak.Library,UI=Streak.UI;var superclass=Streak.UI.ViewController;var DeepLinkLoadingViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_loadingViewTarget",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);Gmail.validateAndCorrectURLHash();this._bindToViewChanged();this.checkShouldShow();this.setLoadedPercentage(1)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.DeepLinkLoader.DeepLinkLoadingView")},_bindToViewChanged:function(){Gmail.observe("viewChanged",this._viewChanged.bind(this))},_viewChanged:function(){this.checkShouldShow()},checkShouldShow:function(){if(BB.UI.isDeepLinkLoadingView()){var masterControllerInstance=Library.get("BentoBox.Modules.DeepLinkLoader.DeepLinkLoaderMasterControllerInstance");this._loadingViewTarget=masterControllerInstance.getLoadingViewTarget();this._view.setLoadingTarget(this._loadingViewTarget);BB.UI.getCanvas().append(this._view.getElement());BB.Tracker.track("deepLinkLoading",{target:this._loadingViewTarget})}else{this._loadingViewTarget=null;this._view.setLoadingTarget(null);this._view.getElement().remove()}},setLoadedPercentage:function(percentage){this._view.setLoadedPercentage(percentage)}});Library.set("BentoBox.Modules.DeepLinkLoader.DeepLinkLoadingViewController",DeepLinkLoadingViewController);Streak.DependencyManager.addFunction({functionKey:"deepLinkLoaderViewControllerInitialized",functionToCall:function(callback){Library.set("BentoBox.Modules.DeepLinkLoader.DeepLinkLoaderViewControllerInstance",new DeepLinkLoadingViewController);if(callback){callback()}},dependentFunctionKeys:["htmlLoaded","localeLoaded"]})})(Streak);(function(Streak){var HTML=Streak.HTML,BB=Streak.BentoBox,Library=Streak.Library,Locale=BB.Locale;var superclass=Streak.UI.View;var DeepLinkLoadingView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_targetView",destroy:true},{name:"_loadingText",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._element=HTML.getElement("streak__deepLinkLoading");this._loadingText=this._element.find(".streak__loadingText");this._loaderBar=this._element.find(".streak__loaderBar");return this},setLoadingTarget:function(targetView){this._targetView=targetView;var defaultLoadingMessage=Locale.getString("loading");var text=defaultLoadingMessage;if(targetView){var specificLoadingKey="loading_"+targetView;var specificLoadingMessage=Locale.getString(specificLoadingKey);if(specificLoadingKey!==specificLoadingMessage){text=specificLoadingMessage}}this._loadingText.text(text)},setLoadedPercentage:function(percentage){percentage=percentage*100;this._loaderBar.find("div").css("width",percentage+"%")}});Library.set("BentoBox.Modules.DeepLinkLoader.DeepLinkLoadingView",DeepLinkLoadingView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailTextareaViewController=Streak.Class.subclass({superclass:Streak.UI.ViewController,memberVariables:[{name:"_plainTextOnly",defaultValue:true,destroy:true},{name:"_isMultiline",defaultValue:true,destroy:true}],_initialize:function(options){Streak.UI.ViewController.prototype._initialize.call(this);if(options&&options.plainTextOnly!==undefined){this._plainTextOnly=options.plainTextOnly}if(this._plainTextOnly){this._view.addClass("streak__gmailTextarea_textOnly")}if(options&&_.isReal(options.multiline)){this._isMultiline=options.multiline}if(!this._isMultiline){this._view.setAsSingleLine()}if(options&&options.noBorder){this._view.addClass("streak__gmailTextarea_noBorder")}},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.GmailTextareaView")},focus:function(){this._view.focus()},setTabIndex:function(tabIndex){this._view.setTabIndex(tabIndex)},getHTML:function(){return this._view.getHTML()},setHTML:function(html){return this._view.setHTML(html)},getText:function(){return this._view.getText()},setText:function(text){return this._view.setText(text)},insertTextAtCursor:function(text){this._view.insertTextAtCursor(text)},keydown:function(event){if(event.which===13&&!this._isMultiline){event.preventDefault()}this._callDelegateFunction("keydown",event)},keypress:function(event){this._callDelegateFunction("keypress",event)},keyup:function(event){this._callDelegateFunction("keyup",event)},input:function(event){this._callDelegateFunction("input",event)},getEventStream:function(){return this._view.getEventStream()},selectAllText:function(){this._view.selectAllText()},setCursorToEnd:function(){this._view.setCursorToEnd()},isCursorAtEnd:function(){return this._view.isCursorAtEnd()},isCursorAtStart:function(){return this._view.isCursorAtStart()},setEnabled:function(isEnabled){if(isEnabled){this._view.enable()}else{this._view.disable()}},setPlaceholderText:function(text){this._view.setPlaceholderText(text)}});Library.set("BentoBox.Widgets.GmailTextareaViewController",GmailTextareaViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailTextareaView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[{name:"_innerElement",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=$('<div class="streak__gmailTextarea" tabindex="-1"></div>');this._innerElement=$('<div class="R5 streak__placeholder" contenteditable="true"></div>');this._element.html(this._innerElement);this._element.addClass("aco");var self=this;this._element.val=function(value){if(value){self.setHTML(value);return this}else{return self.getHTML()}};this._innerElement.val=this._element.val;this._setupBindings()},_setupBindings:function(){var self=this;this._element.focus(function(){self._innerElement.focus()});this._innerElement.focus(function(){self._element.removeClass("aco");self._element.addClass("acm");self._eventStream.push({eventName:"focus",html:self.getHTML(),text:self.getText()})});this._innerElement.blur(function(){self._element.removeClass("acm");self._element.addClass("aco");self._eventStream.push({eventName:"blur",html:self.getHTML(),text:self.getText()})});this._innerElement[0].addEventListener("keydown",function(e){self._callDelegateFunction("keydown",e);self._eventStream.push({eventName:"keydown",event:e})},true);this._innerElement[0].addEventListener("keypress",function(e){self._callDelegateFunction("keypress",e);self._eventStream.push({eventName:"keypress",event:e,html:self.getHTML(),text:self.getText()})},true);this._innerElement[0].addEventListener("keyup",function(e){self._callDelegateFunction("keyup",e);self._eventStream.push({eventName:"keyup",event:e,html:self.getHTML(),text:self.getText()})},true);this._innerElement[0].addEventListener("input",function(e){self._callDelegateFunction("input",e);self._eventStream.push({eventName:"input",event:e,html:self.getHTML(),text:self.getText()})},true);this._innerElement[0].addEventListener("click",function(e){self._callDelegateFunction("click",e);self._eventStream.push({eventName:"click",event:e,html:self.getHTML(),text:self.getText()})});this._innerElement[0].addEventListener("mouseover",function(e){self._callDelegateFunction("mouseover",e);self._eventStream.push({eventName:"mouseover",event:e})});this._innerElement[0].addEventListener("mouseleave",function(e){self._callDelegateFunction("mouseleave",e);self._eventStream.push({eventName:"mouseleave",event:e})})},getTextInput:function(){return this._innerElement},getHTML:function(){return this._innerElement[0].innerHTML},setHTML:function(html){this._innerElement[0].innerHTML=html},getText:function(){return this._innerElement.plainText()},setText:function(text){this._innerElement.text(text)},insertTextAtCursor:function(text){this._innerElement.insertTextAtCaret(text)},focus:function(){this._innerElement.focus();this._innerElement.caret().goToEnd()},blur:function(){this._innerElement.blur()},setTabIndex:function(tabIndex){this._innerElement[0].setAttribute("tabindex",tabIndex)},selectAllText:function(){this._innerElement.selectContents()},setCursorToEnd:function(){this._innerElement.caret().goToEnd()},isCursorAtEnd:function(){return this._innerElement.caret().start>=this.getText().length},isCursorAtStart:function(){return this._innerElement.caret().start===0},setAsSingleLine:function(){this._innerElement.addClass("streak__gmailTextarea_singleLine")},showBorder:function(){this._element.removeClass("streak__gmailTextarea_noToggleBorder");if(this._element.hasClass("acm")||this._element.hasClass("aco")){return}this._element.addClass("aco")},hideBorder:function(){this._element.addClass("streak__gmailTextarea_noToggleBorder");this._element.removeClass("aco")},disable:function(){this._innerElement.prop("contenteditable",false)},enable:function(){this._innerElement.prop("contenteditable",true)},setPlaceholderText:function(text){this._innerElement.attr("data-placeholder",text)}});Library.set("BentoBox.Widgets.GmailTextareaView",GmailTextareaView)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var CreditCardFormView=Streak.Class.subclass({className:"CreditCardFormView",superclass:superclass,_memberVariables:[{name:"_cardNumberElement",destroy:true},{name:"_expirationDateElement",destroy:true},{name:"_securityCodeElement",destroy:true},{name:"_nameElement",destroy:true},{name:"_agreementElement",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak__credit_card_form")},setCardNumberInput:function(input){this._cardNumberElement=input.getElement();this._element.find(".streak__credit_card_number_wrapper").html(this._cardNumberElement)},setExpiryInput:function(input){this._expirationDateElement=input.getElement();this._element.find(".streak__expiration_date_wrapper").html(this._expirationDateElement)},setSecurityCodeInput:function(input){this._securityCodeElement=input.getElement();this._element.find(".streak__security_code_wrapper").html(this._securityCodeElement)},setNameInput:function(input){this._nameElement=input.getElement();this._element.find(".streak__full_name_wrapper").html(this._nameElement)},setTermsOfServiceAgreementInput:function(input){this._agreementElement=input.getElement();this._element.find(".streak__terms_of_service_wrapper").html(this._agreementElement)}});Library.set("BentoBox.Widgets.CreditCardFormView",CreditCardFormView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,Stripe=Streak.Stripe,UI=Streak.UI;var superclass=UI.ViewController;var CreditCardFormViewController=Streak.Class.subclass({className:"CreditCardFormViewController",superclass:superclass,_memberVariables:[{name:"_creditCardInput",destroy:true},{name:"_expiryInput",destroy:true},{name:"_securityCodeInput",destroy:true},{name:"_nameInput",destroy:true},{name:"_agreement",destroy:true}],_initialize:function(options){superclass.prototype._initialize.call(this);this._setupCreditCardInput();this._setupExpiryInput();this._setupSecurityCodeInput();this._setupNameInput();this._setupTermsOfServiceAgreementInput()},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.CreditCardFormView")},_setupCreditCardInput:function(){if(!this._creditCardInput){this._creditCardInput=Library.getInstance("BentoBox.Widgets.CreditCardViewController")}this._view.setCardNumberInput(this._creditCardInput.getView())},_setupExpiryInput:function(){if(!this._expiryInput){this._expiryInput=Library.getInstance("BentoBox.Widgets.ExpirationDateViewController")}this._view.setExpiryInput(this._expiryInput.getView())},_setupSecurityCodeInput:function(){if(!this._securityCodeInput){this._securityCodeInput=Library.getInstance("BentoBox.Widgets.SecurityCodeViewController")}this._view.setSecurityCodeInput(this._securityCodeInput.getView())},_setupNameInput:function(){if(!this._nameInput){this._nameInput=Library.getInstance("BentoBox.Widgets.NameViewController")}this._view.setNameInput(this._nameInput.getView())},_setupTermsOfServiceAgreementInput:function(){if(!this._agreement){this._agreement=Library.getInstance("BentoBox.Widgets.TermsOfServiceAgreementViewController")}this._view.setTermsOfServiceAgreementInput(this._agreement.getView())},focus:function(){this._creditCardInput.focus()},isFormValid:function(){return this._creditCardInput.isCreditCard()&&this._expiryInput.isExpirationDate()&&this._securityCodeInput.isSecurityCode()&&this._nameInput.isName()&&this._agreement.agreesToTerms()},updateFormValidity:function(){this._creditCardInput.highlightEmptyOrInvalid();this._expiryInput.highlightEmptyOrInvalid();this._securityCodeInput.highlightEmptyOrInvalid();this._nameInput.highlightEmptyOrInvalid();this._agreement.highlightHasNotAgreed()},getPaymentFormInformation:function(){return{number:this._creditCardInput.getCard(),cvc:this._securityCodeInput.getSecurityCode(),exp_month:this._expiryInput.getExpirationMonth(),exp_year:this._expiryInput.getExpirationYear(),name:this._nameInput.getName()}}});Library.set("BentoBox.Widgets.CreditCardFormViewController",CreditCardFormViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var CreditCardView=Streak.Class.subclass({className:"CreditCardView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak_credit_card_input")},getInput:function(){return this._element.find("input")},setValid:function(valid){this.getInput().toggleClass("invalid",!valid)},hideCardType:function(){this._element.find(".streak__creditCard_backgroundLogos").show();this._element.find(".streak__creditCard_logo").hide()},setCardType:function(type){this._element.find(".streak__creditCard_logo").show();this._element.find(".streak__creditCard_logo")[0].setAttribute("class","streak__creditCard_logo streak__creditCardLogo_"+type)},hideCardLogos:function(){this._element.find(".streak__creditCard_backgroundLogos").hide()},focus:function(){this.getInput().focus()}});Library.set("BentoBox.Widgets.CreditCardView",CreditCardView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,Stripe=Streak.Stripe,UI=Streak.UI;var superclass=UI.ViewController;var CreditCardViewController=Streak.Class.subclass({className:"CreditCardViewController",superclass:superclass,_memberVariables:[{name:"_card",get:true,destroy:true},{name:"_highlightInvalidWhileTyping",defaultValue:false,destroy:true}],_initialize:function(options){options=options||{};superclass.prototype._initialize.call(this);this._setupStripeFormatting();this._bindInput();if(typeof options.highlightInvalidWhileTyping!=="undefined"){this._highlightInvalidWhileTyping=options._highlightInvalidWhileTyping}},highlightEmptyOrInvalid:function(){this._view.setValid(!this.isEmpty()&&this.isCreditCard())},_highlightInvalidOnly:function(){this._view.setValid(this.isEmpty()||this.isCreditCard())},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.CreditCardView")},isEmpty:function(){return!this._card},getCardType:function(){return $.payment.cardType(this._card)},isCreditCard:function(){return Stripe.card.validateCardNumber(this._card)&&$.payment.validateCardNumber(this._card,this.getCardType())},focus:function(){this._view.focus()},_setupStripeFormatting:function(){this._view.getInput().payment("formatCardNumber")},_bindInput:function(){var self=this;this._view.getInput().on("input",function(){self._card=self._view.getInput().val();if(self._highlightInvalidWhileTyping){self._highlightInvalidOnly()}var type=self.getCardType();if(type){self._view.setCardType(type);self._view.hideCardLogos()}else{self._view.hideCardType()}if(self._card.length>4){self._view.hideCardLogos()}})}});Library.set("BentoBox.Widgets.CreditCardViewController",CreditCardViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var ExpirationDateView=Streak.Class.subclass({className:"ExpirationDateView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak__expiration_date")},setValid:function(valid){this._element.toggleClass("invalid",!valid)}});Library.set("BentoBox.Widgets.ExpirationDateView",ExpirationDateView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,UI=Streak.UI;var superclass=UI.ViewController;var ExpirationDateViewController=Streak.Class.subclass({className:"ExpirationDateViewController",superclass:superclass,_memberVariables:[{name:"_expiry",get:true,destroy:true},{name:"_highlightInvalidWhileTyping",defaultValue:false,destroy:true}],_initialize:function(options){options=options||{};superclass.prototype._initialize.call(this);this._setupStripeFormatting();this._bindInput();if(typeof options.highlightInvalidWhileTyping!=="undefined"){this._highlightInvalidWhileTyping=options._highlightInvalidWhileTyping}},highlightEmptyOrInvalid:function(){this._view.setValid(!this.isEmpty()&&this.isExpirationDate())},_highlightInvalidOnly:function(){this._view.setValid(this.isEmpty()||this.isExpirationDate())},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.ExpirationDateView")},isEmpty:function(){return!this._expiry},isExpirationDate:function(){return $.payment.validateCardExpiry(this._expiry)},getExpirationMonth:function(){return this.getExpiry().month},getExpirationYear:function(){return this.getExpiry().year},_setupStripeFormatting:function(){this._view.getElement().payment("formatCardExpiry")},_bindInput:function(){var self=this;this._view.getElement().on("input",function(){self._expiry=self._view.getElement().payment("cardExpiryVal");if(self._highlightInvalidWhileTyping){self._highlightInvalidOnly()}})}});Library.set("BentoBox.Widgets.ExpirationDateViewController",ExpirationDateViewController)
})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var NameView=Streak.Class.subclass({className:"NameView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak__full_name")},setValid:function(valid){this._element.toggleClass("invalid",!valid)}});Library.set("BentoBox.Widgets.NameView",NameView)})(Streak);(function(Streak){var Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,UI=Streak.UI;var superclass=UI.ViewController;var NameViewController=Streak.Class.subclass({className:"NameViewController",superclass:superclass,_memberVariables:[{name:"_name",get:true,destroy:true},{name:"_highlightInvalidWhileTyping",defaultValue:false,destroy:true}],_initialize:function(options){options=options||{};superclass.prototype._initialize.call(this);this._bindInput();if(typeof options.highlightInvalidWhileTyping!=="undefined"){this._highlightInvalidWhileTyping=options._highlightInvalidWhileTyping}},highlightEmptyOrInvalid:function(){this._view.setValid(!this.isEmpty()&&this.isName())},_highlightInvalidOnly:function(){this._view.setValid(this.isEmpty()||this.isName())},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.NameView")},isEmpty:function(){return!this._name},isName:function(){return!this.isEmpty()},_bindInput:function(){var self=this;this._view.getElement().on("input",function(){self._name=self._view.getElement().val();if(self._highlightInvalidWhileTyping){self._highlightInvalidOnly()}})}});Library.set("BentoBox.Widgets.NameViewController",NameViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var SecurityCodeView=Streak.Class.subclass({className:"SecurityCodeView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak__security_code")},setValid:function(valid){this._element.toggleClass("invalid",!valid)}});Library.set("BentoBox.Widgets.SecurityCodeView",SecurityCodeView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,UI=Streak.UI;var superclass=UI.ViewController;var SecurityCodeViewController=Streak.Class.subclass({className:"SecurityCodeViewController",superclass:superclass,_memberVariables:[{name:"_securityCode",get:true,destroy:true},{name:"_highlightInvalidWhileTyping",defaultValue:false,destroy:true}],_initialize:function(options){options=options||{};superclass.prototype._initialize.call(this);this._setupStripeFormatting();this._bindInput();if(typeof options.highlightInvalidWhileTyping!=="undefined"){this._highlightInvalidWhileTyping=options._highlightInvalidWhileTyping}},highlightEmptyOrInvalid:function(){this._view.setValid(!this.isEmpty()&&this.isSecurityCode())},_highlightInvalidOnly:function(){this._view.setValid(this.isEmpty()||this.isSecurityCode())},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.SecurityCodeView")},isEmpty:function(){return!this._securityCode},isSecurityCode:function(){return $.payment.validateCardCVC(this._securityCode)},_setupStripeFormatting:function(){this._view.getElement().payment("formatCardCVC")},_bindInput:function(){var self=this;this._view.getElement().on("input",function(){self._securityCode=self._view.getElement().val();if(self._highlightInvalidWhileTyping){self._highlightInvalidOnly()}})}});Library.set("BentoBox.Widgets.SecurityCodeViewController",SecurityCodeViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var TermsOfServiceAgreementView=Streak.Class.subclass({className:"TermsOfServiceAgreementView",superclass:superclass,_memberVariables:[{name:"_checkbox",destroy:true,get:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._checkbox=this._element.find("input[type=checkbox]")},_setupElement:function(){this._element=HTML.getElement("streak__terms_of_service_agreement")},setValid:function(valid){this._element.toggleClass("invalid",!valid)},isChecked:function(){return this._checkbox[0].checked}});Library.set("BentoBox.Widgets.TermsOfServiceAgreementView",TermsOfServiceAgreementView)})(Streak);(function(Streak){var Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,UI=Streak.UI;var superclass=UI.ViewController;var TermsOfServiceAgreementViewController=Streak.Class.subclass({className:"TermsOfServiceAgreementViewController",superclass:superclass,_memberVariables:[{name:"_checked",destroy:true},{name:"_highlightHasNotAgreedOnToggle",defaultValue:true,destroy:true}],_initialize:function(options){options=options||{};superclass.prototype._initialize.call(this);this._setupStripeFormatting();this._bindInput();if(typeof options.highlightHasNotAgreedOnToggle!=="undefined"){this._highlightHasNotAgreedOnToggle=options.highlightHasNotAgreedOnToggle}},highlightHasNotAgreed:function(){this._view.setValid(this.agreesToTerms())},agreesToTerms:function(){return this._checked},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.TermsOfServiceAgreementView")},_setupStripeFormatting:function(){this._view.getElement().payment("formatCardCVC")},_bindInput:function(){var self=this;this._view.getCheckbox().click(function(){self._checked=self._view.isChecked();if(self._highlightHasNotAgreedOnToggle){self.highlightHasNotAgreed()}})}});Library.set("BentoBox.Widgets.TermsOfServiceAgreementViewController",TermsOfServiceAgreementViewController)})(Streak);(function(Streak){var HTML=Streak.HTML,BB=Streak.BentoBox,Library=Streak.Library;var superclass=Streak.UI.View;var PaywallView=Streak.Class.subclass({superclass:superclass,className:"PaywallView",memberVariables:[{name:"_backButtonElement",destroy:true},{name:"_sections",destroy:true},{name:"_selectedSectionName",get:true,set:true,destroy:true},{name:"_planElements",destroy:true},{name:"_personPicker",get:true,destroy:true},{name:"_teamEmails",destroy:true},{name:"_teamEmailsMore",destroy:true},{name:"_numberOfTeamMembers",destroy:true},{name:"_planName",destroy:true},{name:"_planCostPerUserPerMonth",destroy:true},{name:"_planFeatures",destroy:true},{name:"_planMore",destroy:true},{name:"_totalCost",destroy:true},{name:"_planContainer",destroy:true},{name:"_hasDiscount",destroy:true,defaultValue:false},{name:"_hasTotalOriginalCost",destroy:true,defaultValue:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._backButtonElement=this._element.find(".streak__backButton");this._sections={plan:{topElement:this._element.find(".streak__paywall_topnav .streak__paywall_topnav_select_plan"),bottomElement:this._element.find(".streak__paywall_bottom .streak__paywall_select_plan")},team:{topElement:this._element.find(".streak__paywall_topnav .streak__paywall_topnav_select_users"),bottomElement:this._element.find(".streak__paywall_bottom .streak__paywall_select_users")},payment:{topElement:this._element.find(".streak__paywall_topnav .streak__paywall_topnav_payment_info"),bottomElement:this._element.find(".streak__paywall_bottom .streak__paywall_payment_info")}};this._teamEmails=this._element.find(".streak__paywall_topnav_emails");this._teamEmailsMore=this._element.find(".streak__paywall_topnav_select_users .streak__paywall_topnav_more");this._numberOfTeamMembers=this._element.find(".streak__paywall_numberOfTeamMembers");this._planName=this._element.find(".streak__paywall_selected_plan_name");this._planCostPerUserPerMonth=this._element.find(".streak__paywall_plan_cost_per_user");this._planFeatures=this._element.find(".streak__paywall_topnav_features");this._planMore=this._element.find(".streak__paywall_topnav_select_plan .streak__paywall_topnav_more");this._planDiscountWrapper=this._element.find(".streak__paywall_topnav_select_plan .streak__discount_area");this._totalDiscountWrapper=this._element.find(".streak__paywall_topnav_payment_info .streak__discount_area");this._planDiscountPercentage=this._element.find(".streak__paywall_topnav .streak__discount_percentage");this._planOriginalCost=this._element.find(".streak__paywall_topnav .streak__original_cost_per_user");this._totalOriginalCost=this._element.find(".streak__paywall_topnav .streak__original_cost_total");this._totalCost=this._element.find(".streak__paywall_total_price");this._setupBackButton();this.markSectionCompleted("team",false);this.markSectionCompleted("plan",false);this.markSectionCompleted("payment",false);this._setupTopNavigationClickEvents()},_setupBackButton:function(){if(!this._backButton){var backButtonTemplate=HTML.get("pipelineToolbarBackButton");this._backButton=BB.Widgets.Button.create({isToggle:false,name:backButtonTemplate,onFunc:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.upgrade.backButton.pressed");history.back()}});this._backButtonElement.html(this._backButton.el)}},setTeamView:function(view){var teamViewElement=this._element.find(".streak__paywall_select_users");teamViewElement.html(view.getElement())},setPlansView:function(view){var plansViewElement=this._element.find(".streak__paywall_select_plan");plansViewElement.html(view.getElement())},setPaymentView:function(view){var paymentViewElement=this._element.find(".streak__paywall_payment_info");paymentViewElement.html(view.getElement())},selectSection:function(sectionName,options){var oldSectionName=this.getSelectedSectionName();if(!this._sections[sectionName]){throw new Error("Invalid section selected")}else if(oldSectionName===sectionName){return}Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.section."+sectionName+".selected",{oldSection:this.getSelectedSectionName()});if(oldSectionName){var oldSection=this._sections[this.getSelectedSectionName()];oldSection.topElement.removeClass("selected");oldSection.bottomElement.removeClass("selected")}var newSection=this._sections[sectionName];this.setSelectedSectionName(sectionName);newSection.topElement.addClass("selected");newSection.bottomElement.addClass("selected");this._callDelegateFunction("sectionChanged",sectionName,oldSectionName,options)},_isSectionComplete:function(sectionName){if(!this._sections[sectionName]){throw new Error("Invalid section selected")}var section=this._sections[sectionName];return section.topElement.hasClass("complete")},markSectionCompleted:function(sectionName,complete){if(!this._sections[sectionName]){throw new Error("Invalid section selected")}else if(typeof complete==="undefined"){throw new Error("Complete not passed into markSectionCompleted")}var section=this._sections[sectionName];if(complete){section.topElement.addClass("complete");section.bottomElement.addClass("complete")}else{section.topElement.removeClass("complete");section.bottomElement.removeClass("complete")}},_setupTopNavigationClickEvents:function(){for(var sectionName in this._sections){this._setupTopNavigationClickEvent(sectionName,this._sections[sectionName])}},_setupTopNavigationClickEvent:function(sectionName,section){var self=this;section.topElement.click(function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.topNav.clicked",{sectionName:sectionName});self.selectSection(sectionName)})},_setupElement:function(){this._element=HTML.getElement("streak__paywall")},setTeamEmailAddresses:function(emails){var numberOfEmailsToShow=3;var numberOfHiddenEmails=Math.max(emails.length-numberOfEmailsToShow,0);var shownEmails=emails.slice(0,numberOfEmailsToShow);this._teamEmails.text(shownEmails.join(", "));this._teamEmailsMore.text("+ "+numberOfHiddenEmails+" more");this._numberOfTeamMembers.text(BB.Locale.getString("payment_users_selected",{users:emails.length}));if(numberOfHiddenEmails>0){this._teamEmailsMore.show()}else{this._teamEmailsMore.hide()}},showTeamLoading:function(isLoading){this._sections.team.topElement.toggleClass("streak__loading",isLoading)},setSelectedPlanName:function(planName){this._planName.text(planName)},setSelectedPlanCostPerUserPerMonth:function(planPrice){if(planPrice)planPrice=this.formatMoney(planPrice);this._planCostPerUserPerMonth.text(planPrice)},setPlanDiscountPercentage:function(percentage){if(percentage)percentage=percentage.toFixed(0);this._planDiscountPercentage.text(percentage);this._hasDiscount=percentage&&percentage!==0;this._checkHidePlanDiscount();this._checkHideTotalDiscount()},setPlanOriginalCostPerUserPerMonth:function(planOriginalCost){if(planOriginalCost)planOriginalCost=this.formatMoney(planOriginalCost);this._planOriginalCost.text(planOriginalCost);this._checkHidePlanDiscount()},setTotalOriginalCost:function(totalOriginalCost){if(totalOriginalCost)totalOriginalCost=this.formatMoney(totalOriginalCost);this._totalOriginalCost.text(totalOriginalCost);this._hasTotalOriginalCost=totalOriginalCost&&totalOriginalCost!==0;this._checkHideTotalDiscount()},_checkHidePlanDiscount:function(){if(this._hasDiscount){this._planDiscountWrapper.show().css("display","")}else{this._planDiscountWrapper.hide()}},_checkHideTotalDiscount:function(){if(this._hasDiscount&&this._hasTotalOriginalCost){this._totalDiscountWrapper.show().css("display","")}else{this._totalDiscountWrapper.hide()}},setPlanFeatureSummary:function(features){var numberOfFeaturesToShow=4;var numberOfHiddenFeatures=Math.max(features.length-numberOfFeaturesToShow,0);var shownFeatures=features.slice(0,numberOfFeaturesToShow);this._planFeatures.text(shownFeatures.join(", "));this._planMore.text("+ "+numberOfHiddenFeatures+" more");if(numberOfHiddenFeatures>0){this._planMore.show()}else{this._planMore.hide()}},setTotalCost:function(cost){if(cost)cost=this.formatMoney(cost);this._totalCost.text(cost)},formatMoney:function(price){if(typeof price==="undefined"||price===null){return price}if(price.toString()===price.toFixed(0)){return price.toFixed(0)}else{return price.toFixed(2)}}});Library.set("BentoBox.Modules.Paywall.PaywallView",PaywallView)})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Gmail=Streak.Gmail,Library=Streak.Library,Locale=BB.Locale,UI=BB.UI,NotificationCenter=Streak.NotificationCenter;var MINIMUM_ENTERPRISE_USERS=5;var ENTERPRISE_PLAN="enterprise";var superclass=Streak.UI.ViewController;var PaywallViewController=Streak.Class.subclass({superclass:superclass,className:"PaywallViewController",memberVariables:[{name:"_loadingViewTarget",destroy:true},{name:"_model",destroy:false},{name:"_teamViewController",destroy:true},{name:"_plansViewController",destroy:true},{name:"_paymentViewController",destroy:true},{name:"_visible",destroy:true},{name:"_watchViewChangeID",destroy:true}],_initialize:function(params){superclass.prototype._initialize.call(this);this._model=params.model;this._bindToViewChanged();this._checkShouldShow();this._setupTeamViewController();this._setupPlansViewController();this._model.addDelegate(this)},destroy:function(){this._unbindToViewChanged()},teamChanged:function(){var teamEmailAddresses=this._model.getTeamEmailAddresses();this._view.setTeamEmailAddresses(teamEmailAddresses);var isTeamSet=this._model.isTeamSet();this._view.markSectionCompleted("team",isTeamSet)},planChanged:function(){var planKey=this._model.getSelectedPlanKey();var isPlanSet=this._model.isPlanSet();this._view.markSectionCompleted("plan",isPlanSet);if(isPlanSet){var planName=this._model.getPlanName(planKey);this._view.setSelectedPlanName(planName);var planPrice=this._model.getPlanCostPerUserPerMonth(planKey);this._view.setSelectedPlanCostPerUserPerMonth(planPrice);var planFeatureSummary=this._model.getPlanFeatureSummary(planKey);this._view.setPlanFeatureSummary(planFeatureSummary);var planDiscountPercentage=this._model.getDiscountPercentage(planKey);this._view.setPlanDiscountPercentage(planDiscountPercentage);var planOriginalCost=this._model.getBasePlanCostPerUserPerMonth(planKey);this._view.setPlanOriginalCostPerUserPerMonth(planOriginalCost);var totalOriginalCost=this._model.getBaseTotalCostPerMonth(planKey);this._view.setTotalOriginalCost(totalOriginalCost)}else{this._view.setSelectedPlanName(null);this._view.setSelectedPlanCostPerUserPerMonth(null);this._view.setPlanFeatureSummary([]);this._view.setPlanDiscountPercentage(null);this._view.setPlanOriginalCostPerUserPerMonth(null);this._view.setTotalOriginalCost(null)}},discountChanged:function(){if(this._model.isPlanSet()){this._view.setTotalOriginalCost(this._model.getBaseTotalCostPerMonth());this._view.setSelectedPlanCostPerUserPerMonth(this._model.getPlanCostPerUserPerMonth());this._view.setPlanDiscountPercentage(this._model.getDiscountPercentage());this._view.setPlanOriginalCostPerUserPerMonth(this._model.getBasePlanCostPerUserPerMonth())}else{this._view.setPlanDiscountPercentage(null);this._view.setPlanOriginalCostPerUserPerMonth(null);this._view.setTotalOriginalCost(null);this._view.setSelectedPlanCostPerUserPerMonth(null)}},totalPaymentChanged:function(){this._view.setTotalCost(this._model.getPaymentTotalPerMonth());this._view.setTotalOriginalCost(this._model.getBaseTotalCostPerMonth())},planUpgradeClicked:function(){this._view.selectSection("team")},teamContinueButtonPressed:function(){this._view.selectSection("payment")},subscribeWithBillingComplete:function(parameters){var self=this;return this._createAndActivatePlanInstance().then(function(){BB.Data.getParticipatingPlans().refresh();BB.Data.getBillingPlanInstances().refresh();self._planSubscriptionSuccessful();NotificationCenter.postNotification({eventName:"streak.isUserOnPlan.changed",topNavIconToShow:BB.Modules.TopNav.PAYWALL_ICON.ACCOUNT,sender:self})})},planInstanceChanged:function(planInstance){if(this._initiallySelectedSection){this._view.selectSection(this._initiallySelectedSection);return}if(!planInstance){this._view.selectSection("plan")}else if(!planInstance.getPlanId()){this._view.selectSection("plan")}else if(!planInstance.isActive()){this._view.selectSection("payment",{overrideCheck:true})}else{this._view.selectSection("team")}},sectionChanged:function(sectionName,prevSection,parameters){parameters=parameters||{};if(sectionName==="payment"){this._ensurePaymentControllerExists();var errmsg;var planKey=this._model.getSelectedPlanKey();var teamCount=this._model.getTeam().length;if(planKey==null){errmsg=Locale.getString("payment_plan_not_set")}else if(teamCount===0){if(!this._teamViewController.hasLoadedSuggestions()){errmsg=Locale.getString("payment_team_not_loaded")}else{errmsg=Locale.getString("payment_team_not_set")}}else if(!this._planRequirementsCheck(planKey,teamCount)){errmsg=true}if(errmsg&&!parameters.overrideCheck){if(errmsg!==true){BB.ButterBarManager.showError(errmsg,{messageKey:"paywall-error"})}this._view.selectSection(prevSection);return}this._paymentViewController.focus()}var teamViewHasFocus=sectionName==="team";this._teamViewController.focus(teamViewHasFocus)},switchToViewToUpgradePlan:function(parameters){var peopleToAdd=parameters.peopleToAdd||[];var numberOfPeopleNeededOnNewPlan=parameters.numberOfPeopleNeededOnNewPlan;var self=this;var billingPlanInstances=BB.Data.getBillingPlanInstances();billingPlanInstances.afterLoad().then(function(){var activeBillingPlanInstances=_.filter(billingPlanInstances,function(planInstance){return planInstance.isActive()});var currentPlanInstance=activeBillingPlanInstances[0];var initialSection=peopleToAdd.length>0?"team":"plan";UI.setURL(Gmail.Constants.Paywall+"/"+(currentPlanInstance?currentPlanInstance.get("key"):"")+"/"+initialSection,function(){if(numberOfPeopleNeededOnNewPlan){var planIneligible=function(plan){return plan.getCollaboratorLimit()&&plan.getCollaboratorLimit()<numberOfPeopleNeededOnNewPlan};var plans=BB.Data.getPlanCollection();plans.afterLoad().then(function(){if(currentPlanInstance){var currentPlan=_.find(plans,function(plan){return plan.getPlanId()===currentPlanInstance.getPlanId()});if(!planIneligible(currentPlan)){return}}var eligiblePlans=_.filter(_.reject(plans,planIneligible),function(plan){return plan.get("visibleToUsers")});if(eligiblePlans.length>0){var cheapestEligiblePlan=_.min(eligiblePlans,function(plan){return plan.get("price")});self._model.setSelectedPlanKey(cheapestEligiblePlan.getPlanId())}else{BB.logError("no eligible plans found",null,{numberOfPeopleNeededOnNewPlan:numberOfPeopleNeededOnNewPlan})}})}if(peopleToAdd.length>0){self._teamViewController.whenDefaultTeamSuggestionsLoaded().then(function(){for(var i=0;i<peopleToAdd.length;i++){var personToAdd=peopleToAdd[i];self._model.addTeamMember({email:personToAdd.user.email})}})}})})},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PaywallView")},_setupTeamViewController:function(){this._teamViewController=Library.getInstance("BentoBox.Modules.Paywall.TeamViewController",{model:this._model});this._teamViewController.addDelegate(this);this._view.setTeamView(this._teamViewController.getView())},_setupPlansViewController:function(){this._plansViewController=Library.getInstance("BentoBox.Modules.Paywall.PlansViewController",{model:this._model});this._plansViewController.addDelegate(this);this._view.setPlansView(this._plansViewController.getView())},_setupPaymentViewController:function(){this._paymentViewController=Library.getInstance("BentoBox.Modules.Paywall.PaymentViewController",{model:this._model});this._paymentViewController.setDelegate(this);this._view.setPaymentView(this._paymentViewController.getView())},_bindToViewChanged:function(){this._watchViewChangeID=Gmail.observe("viewChanged",this._viewChanged.bind(this))},_unbindToViewChanged:function(){if(this._watchViewChangeID){Gmail.unobserve("viewChanged",this._watchViewChangeID)}delete this._watchViewChangeID},_viewChanged:function(){this._checkShouldShow()},_checkShouldShow:function(){if(BB.UI.isPaywallView()){BB.UI.getCanvas().append(this._view.getElement());var planInstanceKey=Gmail.hash.parts[1];if(planInstanceKey==="")planInstanceKey=null;this._initiallySelectedSection=null;if(Gmail.hash.parts.length>=3){this._initiallySelectedSection=Gmail.hash.parts[2]}Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").startSession();Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.upgrade.loaded",{planInstanceKey:planInstanceKey});if(planInstanceKey){this._model.setPlanInstanceByKey(planInstanceKey)}else{this._model.setPlanInstance()}this._ensurePaymentControllerExists();this._model.refreshPlans();this._visible=true}else{if(this._visible){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.upgrade.unloaded")}Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").endSession();this._view.getElement().detach();this._visible=false}},_ensurePaymentControllerExists:function(){if(!this._paymentViewController){this._setupPaymentViewController()}},_planSubscriptionSuccessful:function(){UI.setURL(Gmail.Constants.PaidAccount)},_createAndActivatePlanInstance:function(){var self=this;if(!this._model.getPlanInstance()||this._model.isPlanInstanceDirty()){return this._createPlanInstance({emailAddresses:this._model.getTeamEmailAddresses(),planId:this._model.getSelectedPlanKey(),existingPlanInstance:this._model.getPlanInstance()}).then(function(planInstance){return planInstance.activate()})}else{return this._model.getPlanInstance().activate()}},_planRequirementsCheck:function(planId,teamCount){if(planId==ENTERPRISE_PLAN&&teamCount<MINIMUM_ENTERPRISE_USERS){BB.ButterBarManager.showError(BB.Locale.getString("payment_subscribe_minimum",{minimum_users:MINIMUM_ENTERPRISE_USERS,plan:this._model.getPlanName(planId)}),{messageKey:"paywall-error"});return false}return true},_createPlanInstance:function(parameters){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){if(!self._planRequirementsCheck(parameters.planId,parameters.emailAddresses.length)){var error=new Error("Minimum number of users not met.");error.errorMessage="Minimum number of users not met.";reject(error);return}var createParameters={userEmailList:parameters.emailAddresses,planId:parameters.planId};if(parameters.existingPlanInstance){var propertiesToCopy=["trialPeriodDays","enrollmentType","discountPercentage"];_.each(propertiesToCopy,function(propertyKey){var propertyValue=parameters.existingPlanInstance.get(propertyKey);if(_.isReal(propertyValue)){createParameters[propertyKey]=propertyValue}})}var createdPlanInstance=new BB.Models.PlanInstance(createParameters);createdPlanInstance.save(resolve.bind(null,createdPlanInstance),reject)})},hasDefaultTeamSuggestionLoaded:function(hasLoaded){this._view.showTeamLoading(!hasLoaded)}});Library.set("BentoBox.Modules.Paywall.PaywallViewController",PaywallViewController);Streak.DependencyManager.addFunction({functionKey:"paywallViewControllerInitialized",functionReference:function(){var model=Library.getInstance("BentoBox.Modules.Paywall.PaywallModel");var viewController=new PaywallViewController({model:model});Library.set("BentoBox.Modules.Paywall.PaywallViewControllerInstance",viewController);Library.set("BentoBox.Modules.Paywall.PaywallModelInstance",model)},dependentFunctionKeys:["htmlLoaded","localeLoaded","enabledFeaturesControllerInitialized","helpLoaderInitialized"]})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Library=Streak.Library;var superclass=Streak.UI.Delegator;var PaywallModel=Streak.Class.subclass({superclass:superclass,className:"PaywallModel",memberVariables:[{name:"_selectedPlanKey",get:true,destroy:true},{name:"_team",get:true,destroy:true},{name:"_userHasCard",destroy:true,set:true,get:true},{name:"_planInstance",destroy:false,get:true},{name:"_plans",destroy:true},{name:"_participatingPlans",destroy:true},{name:"_billingAdminPlanInstances",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._team=[];this.refreshPlans();this.setPlanInstance()},setPlanInstance:function(planInstance){if(planInstance&&planInstance.get("endDate")){BB.ButterBarManager.showError("Can not edit already completed plan instance");BB.logError("User tried to edit expired plan",null,planInstance.key());planInstance=null}this._planInstance=planInstance;if(planInstance&&planInstance.getPlanId()){this.setSelectedPlanKey(planInstance.getPlanId())}else{this.setSelectedPlanKey()}if(planInstance&&planInstance.getPlanId()){if(this.getPlanForKey(planInstance.getPlanId())){this._callDelegateFunction("plansChanged",this)}else{this._loadAllPlans()}}this._setTeam([]);this._callDelegateFunction("planInstanceChanged",planInstance);this._callDelegateFunction("discountChanged",this);this._callDelegateFunction("trialPeriodDaysChanged",this);this._callDelegateFunction("totalPaymentChanged",this)},setPlanInstanceByKey:function(planInstanceKey,errorCallback){var planInstance=this._billingAdminPlanInstances.getByKey(planInstanceKey);if(planInstance&&this.getPlanForKey(planInstance.getPlanId())){this.setPlanInstance(planInstance)}else{var self=this;this._startLoadingPlanInstance();var secondLoadTry=_.after(2,function(){var planInstance=self._billingAdminPlanInstances.getByKey(planInstanceKey);if(planInstance){self.setPlanInstance(planInstance)}else{if(errorCallback)errorCallback();console.error("Couldn't load planInstance with key "+planInstanceKey)}});this._loadAllPlans(secondLoadTry);this._loadUserPlans(secondLoadTry)}},addTeamMember:function(contact){if(!this._team){this._team=[]}if(_.find(this._team,function(teamMember){return teamMember.email===contact.email})){return}this._team.push(contact);this._callDelegateFunction("teamChanged",this);this._callDelegateFunction("totalPaymentChanged",this)},removeTeamMember:function(contact){if(this._team){var oldLength=this._team.length;this._team=_.filter(this._team,function(teamMember){return contact.email!==teamMember.email});if(oldLength!=this._team.length){this._callDelegateFunction("teamChanged",this);this._callDelegateFunction("totalPaymentChanged",this)}}},isTeamSet:function(){return this._team&&this._team.length>0},getTeamEmailAddresses:function(){var emails=[];for(var i=0;i<this._team.length;i++){emails.push(this._team[i].email)}return emails},getPlanForKey:function(planKey){planKey=planKey||this.getSelectedPlanKey();return _.find(this._plans,function(plan){return plan.get("planId")===planKey})},getPlanName:function(planKey){return this.getPlanForKey(planKey).getLocalizedName()},getPlanCostPerUserPerMonth:function(planKey){var basePrice=this.getBasePlanCostPerUserPerMonth(planKey);var discount=this.getDiscountPercentage(planKey);if(discount){return basePrice*((100-discount)/100)}else{return basePrice}},getDiscountPercentage:function(planKey){planKey=planKey||this.getSelectedPlanKey();var planDiscount=this.getPlanForKey(planKey).get("defaultDiscountPercentage");if(this._planInstance&&this._planInstance.getPlanId()===planKey){var planInstanceDiscount=this._planInstance.get("discountPercentage");if(planInstanceDiscount)return planInstanceDiscount}if(planDiscount)return planDiscount;return 0},getTrialPeriodDays:function(planKey){planKey=planKey||this.getSelectedPlanKey();var planTrialPeriod=this.getPlanForKey(planKey).get("defaultTrialPeriodDays");if(this._planInstance&&this._planInstance.getPlanId()===planKey){var planInstanceTrialPeriod=this._planInstance.get("trialPeriodDays");if(planInstanceTrialPeriod)return planInstanceTrialPeriod}if(planTrialPeriod)return planTrialPeriod;return 0},getBasePlanCostPerUserPerMonth:function(planKey){return this.getPlanForKey(planKey).get("price")},getPlanFeatureSummary:function(planKey){return this.getPlanForKey(planKey).getSummaryFeatures()},getPlanFeatureDescription:function(planKey){return this.getPlanForKey(planKey).getDescriptionFeatures()},getPlanLearnMoreText:function(planKey){return this.getPlanForKey(planKey).getLearnMoreText()},getCollaboratorLimit:function(planKey){return this.getPlanForKey(planKey).getCollaboratorLimit()},getPlanKeys:function(){var visiblePlans=_.map(_.filter(this._plans,function(plan){return plan.get("visibleToUsers")}),function(plan){return plan.get("planId")});if(this._planInstance&&this._planInstance.getPlanId()&&!_.contains(visiblePlans,this._planInstance.getPlanId())){return visiblePlans.concat([this._planInstance.getPlanId()])}else{return visiblePlans}},isPlanSet:function(){return!!this._selectedPlanKey},setSelectedPlanKey:function(planKey){this._selectedPlanKey=planKey;this._callDelegateFunction("planChanged",this,{planKey:planKey});this._callDelegateFunction("totalPaymentChanged",this)},isPaymentTotalSet:function(){return this.isPlanSet()&&this.isTeamSet()},getPaymentTotalPerMonth:function(){return this.isPaymentTotalSet()?this._getNumberOfTeamMembers()*this.getPlanCostPerUserPerMonth():0},getBaseTotalCostPerMonth:function(){return this.isPaymentTotalSet()?this._getNumberOfTeamMembers()*this.getBasePlanCostPerUserPerMonth():0},topNavIconToShow:function(){if(!this._participatingPlans||!this._billingAdminPlanInstances){return BB.Modules.TopNav.PAYWALL_ICON.NONE}var activeBillingInstances=_.filter(this._billingAdminPlanInstances,function(planInstance){return planInstance.isActive()});var hasPlanInstance=this._participatingPlans.length>0||activeBillingInstances.length>0;if(hasPlanInstance){return BB.Modules.TopNav.PAYWALL_ICON.ACCOUNT}else{return BB.Modules.TopNav.PAYWALL_ICON.UPGRADE}},isPlanInstanceDirty:function(){if(!this._planInstance)throw new Error("isPlanInstanceDirty can only be called if paywallModel.getPlanInstance() exists");var oldPlanId=this._planInstance.getPlanId();var oldTeam=this._planInstance.get("emails")||[];oldTeam=oldTeam.sort();var newPlanId=this.getSelectedPlanKey();if(!this.getTeamEmailAddresses())throw new Error("team email addresses were missing in isPlanInstanceDirty");var newTeam=this.getTeamEmailAddresses().sort();return!_.isEqual(oldPlanId,newPlanId)||!_.isEqual(oldTeam,newTeam)},shouldAcceptDefaultTeamAutomatically:function(){return this._planInstance&&!this._planInstance.isActive()},addDelegate:function(delegate){superclass.prototype.addDelegate.call(this,delegate);this._callDelegateFunctionOnDelegate("teamChanged",delegate);
this._callDelegateFunctionOnDelegate("planChanged",delegate,{planKey:this._selectedPlanKey});this._callDelegateFunction("discountChanged",delegate,this);this._callDelegateFunction("trialPeriodDaysChanged",delegate,this);this._callDelegateFunctionOnDelegate("totalPaymentChanged",delegate,this);this._callDelegateFunctionOnDelegate("planInstanceChanged",delegate,this.getPlanInstance())},_startLoadingPlanInstance:function(){this._setTeam([]);this._callDelegateFunction("planInstanceCleared")},refreshPlans:function(callback){var step=function(){};if(callback){step=_.after(2,callback)}this._loadAllPlans(step);this._loadUserPlans(step)},_loadAllPlans:function(callback){this._plans=BB.Data.getPlanCollection();var self=this;this._plans.refresh(function(){self._callDelegateFunction("plansChanged",this);if(callback)callback()})},_loadUserPlans:function(callback){var self=this;var combinedCallback=_.after(2,function(){self._isUserOnPlanChanged();if(callback)callback()});this._loadUserParticipatingPlans(combinedCallback);this._loadUserBillingPlanInstances(combinedCallback)},_isUserOnPlanChanged:function(){Streak.NotificationCenter.postNotification({eventName:"streak.isUserOnPlan.changed",topNavIconToShow:this.topNavIconToShow()})},_loadUserParticipatingPlans:function(cb){this._participatingPlans=BB.Data.getParticipatingPlans();this._participatingPlans.refresh(cb)},_loadUserBillingPlanInstances:function(cb){this._billingAdminPlanInstances=BB.Data.getBillingPlanInstances();this._billingAdminPlanInstances.refresh(cb)},_setTeam:function(contacts){this._team=contacts;this._callDelegateFunction("teamChanged",this);this._callDelegateFunction("totalPaymentChanged",this)},_getNumberOfTeamMembers:function(){return this.isTeamSet()?this._team.length:0}});Library.set("BentoBox.Modules.Paywall.PaywallModel",PaywallModel)})(Streak);(function(Streak){var Library=Streak.Library,Tracker=Streak.BentoBox.Tracker;var superclass=Streak.UI.Delegator;var PaywallTracker=Streak.Class.subclass({className:"PaywallTracker",superclass:superclass,_memberVariables:[{name:"_currentSession",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this)},track:function(event,params){if(typeof params!=="undefined"&&typeof params!=="object"){console.error("params is bad in PaywallTracker.track")}params=params||{};params.session=this._currentSession;Tracker.track(event,params)},startSession:function(){this._currentSession=Streak.guid()},endSession:function(){delete this._currentSession}});Library.set("BentoBox.Modules.Paywall.PaywallTracker",PaywallTracker);Library.set("BentoBox.Modules.Paywall.PaywallTrackerInstance",new PaywallTracker)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var AccountPlanView=Streak.Class.subclass({className:"AccountPlanView",superclass:superclass,_memberVariables:[{name:"_upgradeButton",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._upgradePlanButton=this._element.find(".streak__account_upgrade_plan");this._changeTeamButton=this._element.find(".streak__account_change_team");this._featureList=this._element.find(".streak__plan_feature_list");this._pricePerUser=this._element.find(".streak__account_plan_cost");this._name=this._element.find(".streak__account_plan_name");this._numberOfUsers=this._element.find(".streak__account_user_count");this._userList=this._element.find(".streak__plan_user_list")},_setupElement:function(){this._element=HTML.getElement("streak__account_plan")},setUpgradePlanButton:function(button){this._upgradePlanButton.html(button.getElement())},setChangeTeamButton:function(button){this._changeTeamButton.html(button.getElement())},setFeatures:function(features){this._featureList.text(features.join(", "))},setPricePerUser:function(price){this._pricePerUser.text(price)},setName:function(name){this._name.text(name)},setUsers:function(users){this._numberOfUsers.text(users.length);if(users.length!==0){this._userList.show().css("display","");this._userList.text(users.join(", "))}else{this._userList.hide()}},setNoUsers:function(){this._element.addClass("streak__no_users")},setIsParticipant:function(isParticipant){if(!isParticipant){this._element.find(".streak__hide_if_participating").remove()}}});Library.set("BentoBox.Modules.Paywall.AccountPlanView",AccountPlanView)})(Streak);(function(Streak){var BB=Streak.BentoBox,Library=Streak.Library,Locale=BB.Locale;var superclass=Streak.UI.ViewController;var AccountPlanViewController=Streak.Class.subclass({className:"AccountPlanViewController",superclass:superclass,memberVariables:[{name:"_plan",destroy:true,get:true},{name:"_planInstance",destroy:true},{name:"_upgradePlanButton",destroy:true},{name:"_changeTeamButton",destroy:true}],_initialize:function(parameters){superclass.prototype._initialize.call(this);this._plan=parameters.plan;this._planInstance=parameters.planInstance;var isParticipant=!this._planInstance;if(parameters&&typeof parameters.isParticipant!=="undefined"){isParticipant=parameters.isParticipant}this._view.setIsParticipant(isParticipant);this._setupUpgradePlanButton();this._setupChangeTeamButton();this._setupPlanFeatures();this._setupPlanInstanceUsers();this._setupPlanCost();this._setupPlanName()},setIsParticipant:function(isParticipant){this._view.setIsParticipant(isParticipant)},_setupUpgradePlanButton:function(){if(!this._planInstance){return}if(!this._upgradePlanButton){this._upgradePlanButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("account_upgrade_plan"),color:"blue",onFunction:this.upgradePlanButtonClicked.bind(this)})}this._view.setUpgradePlanButton(this._upgradePlanButton)},_setupChangeTeamButton:function(){if(!this._planInstance){return}if(!this._upgradeButton){this._upgradeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("account_change_team"),color:"blue",onFunction:this.changeTeamButtonClicked.bind(this)})}this._view.setChangeTeamButton(this._upgradeButton)},_setupPlanFeatures:function(){this._view.setFeatures(this._plan.getSummaryFeatures())},_setupPlanInstanceUsers:function(){if(this._planInstance){var userEmails=this._planInstance.get("emails")||[];this._view.setUsers(userEmails)}else{this._view.setNoUsers()}},_setupPlanCost:function(){if(!this._planInstance){return}var perUserCost=this._planInstance.get("totalPrice")/this._planInstance.get("numUsers");var formattedPerUserCost=BB.Modules.Reports.Utils.formatCurrency(perUserCost,"$");this._view.setPricePerUser(formattedPerUserCost)},_setupPlanName:function(){this._view.setName(this._plan.getLocalizedName())},upgradePlanButtonClicked:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.account.upgrade.clicked",{planInstanceKey:this._planInstance.get("key")});this._callDelegateFunction("upgradePlanButtonClicked",this._planInstance)},changeTeamButtonClicked:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.account.changeTeam.clicked",{planInstanceKey:this._planInstance.get("key")});this._callDelegateFunction("changeTeamButtonClicked",this._planInstance)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.AccountPlanView")}});Library.set("BentoBox.Modules.Paywall.AccountPlanViewController",AccountPlanViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI,BB=Streak.BentoBox;var superclass=UI.View;var AccountView=Streak.Class.subclass({className:"AccountView",superclass:superclass,_memberVariables:[{name:"_participatingPlans",destroy:true},{name:"_billingPlans",destroy:true},{name:"_participatingPlansSection",destroy:true},{name:"_billingPlansSection",destroy:true},{name:"_paymentChanger",destroy:true},{name:"_invoices",destroy:true},{name:"_invoicesSection",destroy:true},{name:"_loadingIndicator",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._participatingPlans=this._element.find(".streak__participating_plans");this._participatingPlansSection=this._element.find(".streak__participating_plans_section");this._billingPlans=this._element.find(".streak__billing_plans");this._billingPlansSection=this._element.find(".streak__billing_plans_section");this._paymentChanger=this._element.find(".streak__payment_changer");this._invoices=this._element.find(".streak__account_invoices");this._invoicesSection=this._element.find(".streak__billing_history_section")},destroy:function(){this.setLoading(false)},_setupElement:function(){this._element=HTML.getElement("streak__account_page")},addParticipatingPlanView:function(view){this._participatingPlansSection.show().css("display","");this._participatingPlans.append(view.getElement())},addBillingPlanView:function(view){this._billingPlansSection.show().css("display","");this._billingPlans.append(view.getElement())},setPaymentChangerView:function(view){this._paymentChanger.html(view.getElement())},hideParticipatingPlans:function(){this._participatingPlansSection.hide()},hideBillingPlans:function(){this._billingPlansSection.hide()},removeAllParticipatingPlanViews:function(){this._participatingPlans.html(null)},removeAllBillingPlanViews:function(){this._billingPlans.html(null)},hideSharingSettings:function(){this._element.find(".streak__account_restrictedSharing").hide()},showSharingSettings:function(){this._element.find(".streak__account_restrictedSharing").fastShow("-webkit-flex")},setSharingToggleElement:function(element){this._element.find(".streak__account_restictedSharing_toggle").html(element)},setSecurityReportToggleElement:function(element){this._element.find(".streak__account_securityReport_toggle").html(element)},setAutomaticInvoiceEmailToggleElement:function(element){this._element.find(".streak__account_automaticInvoiceEmail_toggle").html(element)},showInvoiceSettings:function(){this._element.find(".streak__account_invoiceSettings").fastShow("-webkit-flex")},hideInvoiceSettings:function(){this._element.find(".streak__account_invoiceSettings").hide()},showInvoices:function(shouldShow){if(shouldShow){this._invoicesSection.toggle(shouldShow).css("display","")}else{this._invoicesSection.toggle(shouldShow)}},setLoading:function(isLoading){if(isLoading){if(this._loadingIndicator){this.setLoading(false)}this._loadingIndicator=BB.ButterBarManager.showLoading();return this._loadingIndicator.destroy.bind(this._loadingIndicator)}else{this._loadingIndicator.destroy();this._loadingIndicator=null}},setInvoices:function(invoicesView){this._invoices.html(invoicesView.getElement())}});Library.set("BentoBox.Modules.Paywall.AccountView",AccountView)})(Streak);(function(Streak){var _=Streak._,$=Streak.$,BB=Streak.BentoBox,Gmail=Streak.Gmail,Library=Streak.Library,UI=BB.UI;var superclass=Streak.UI.ViewController;var AccountViewController=Streak.Class.subclass({className:"AccountViewController",superclass:superclass,memberVariables:[{name:"_plans",destroy:false},{name:"_participatingPlans",destroy:false},{name:"_billingAdminPlanInstances",destroy:false},{name:"_participatingPlanViewControllers",destroy:true},{name:"_billingPlanViewControllers",destroy:true},{name:"_invoiceCollectionViewController",destroy:true},{name:"_paymentChangerViewController",destroy:true},{name:"_viewVisible",destroy:true,defaultValue:false},{name:"_restrictSharing",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._bindToViewChanged();this.checkShouldShow();this._participatingPlanViewControllers=[];this._billingPlanViewControllers=[];this._setupPaymentChangerViewController();this._view.hideSharingSettings();this._view.hideInvoiceSettings();this._setupPlans();this._refreshPlans();this._setupInvoices()},_setupPaymentChangerViewController:function(){this._paymentChangerViewController=Library.getInstance("BentoBox.Modules.Paywall.PaymentChangerViewController");this._view.setPaymentChangerView(this._paymentChangerViewController.getView())},_setupPlans:function(){if(!this._plans){this._plans=BB.Data.getPlanCollection()}if(!this._participatingPlans){this._participatingPlans=BB.Data.getParticipatingPlans();this._participatingPlans.watch("collectionChange",this._participatingPlansChanged,this)}if(!this._billingAdminPlanInstances){this._billingAdminPlanInstances=BB.Data.getBillingPlanInstances();this._billingAdminPlanInstances.watch("collectionChange",this._billingAdminPlanInstancesChanged,this)}},_setupInvoices:function(){if(!this._invoiceCollectionViewController){this._invoiceCollectionViewController=Library.getInstance("BentoBox.Modules.Paywall.InvoiceCollectionViewController");this._invoiceCollectionViewController.addDelegate(this)}this._view.setInvoices(this._invoiceCollectionViewController.getView())},_refreshPlans:function(){var loaded=$.noop;var showLoading=this._viewVisible;if(showLoading){var removeLoadingMessage=this._view.setLoading(true);loaded=_.after(3,removeLoadingMessage)}var self=this;this._plans.refresh(function(){self._participatingPlansChanged();self._billingAdminPlanInstancesChanged();loaded()});this._participatingPlans.refresh(loaded);this._billingAdminPlanInstances.refresh(loaded)},_participatingPlansChanged:function(){this._removeAllParticipatingPlans();if(this._participatingPlans.length===0||this._plans.length===0){this._view.hideParticipatingPlans();return}for(var i=0;i<this._participatingPlans.length;i++){var participatingPlan=this._participatingPlans[i];this._addParticipatingPlan(participatingPlan)}},_billingAdminPlanInstancesChanged:function(){var activeBillingPlanInstances=this.getActiveBillingPlanInstances();this._removeAllBillingPlans();if(activeBillingPlanInstances.length===0||this._plans.length===0){this._view.hideBillingPlans();return}for(var i=0;i<activeBillingPlanInstances.length;i++){var billingAdminPlanInstance=activeBillingPlanInstances[i];var billingAdminPlanId=billingAdminPlanInstance.getPlanId();var billingAdminPlan=_.find(this._plans,function(plan){return plan.get("planId")===billingAdminPlanId});this._addBillingPlan(billingAdminPlanInstance,billingAdminPlan);var matchingParticipatingPlanViewController=_.find(this._participatingPlanViewControllers,function(participatingPlanViewController){var participatingPlan=participatingPlanViewController.getPlan();var participatingPlanId=participatingPlan.get("planId");return participatingPlanId===billingAdminPlanId});if(matchingParticipatingPlanViewController){matchingParticipatingPlanViewController.setIsParticipant(false)}}this._setupSharingSettings();this._setupInvoiceSettings()},getActiveBillingPlanInstances:function(){var activeBillingPlanInstances=[];if(!this._billingAdminPlanInstances){return[]}for(var i=0;i<this._billingAdminPlanInstances.length;i++){var billingAdminPlanInstance=this._billingAdminPlanInstances[i];if(billingAdminPlanInstance.isActive()){activeBillingPlanInstances.push(billingAdminPlanInstance)}}return activeBillingPlanInstances},_addParticipatingPlan:function(plan){var planViewController=Library.getInstance("BentoBox.Modules.Paywall.AccountPlanViewController",{plan:plan,isParticipant:!this._isBillingAdmin(plan)});this._participatingPlanViewControllers.push(planViewController);planViewController.addDelegate(this);this._view.addParticipatingPlanView(planViewController.getView())},_addBillingPlan:function(planInstance,plan){var planViewController=Library.getInstance("BentoBox.Modules.Paywall.AccountPlanViewController",{plan:plan,planInstance:planInstance,isParticipant:false});this._billingPlanViewControllers.push(planViewController);planViewController.addDelegate(this);this._view.addBillingPlanView(planViewController.getView())},_isBillingAdmin:function(plan){var planId=plan.get("planId");var activeBillingPlanInstances=this.getActiveBillingPlanInstances();return!!_.find(activeBillingPlanInstances,function(planInstance){return planInstance.getPlanId()===planId})},_removeAllBillingPlans:function(){this._view.removeAllBillingPlanViews();this._billingPlanViewControllers=[]},_removeAllParticipatingPlans:function(){this._view.removeAllParticipatingPlanViews();this._participatingPlanViewControllers=[]},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.AccountView")},_bindToViewChanged:function(){Gmail.observe("viewChanged",this._viewChanged.bind(this))},_viewChanged:function(){this.checkShouldShow()},_viewShown:function(){if(this._invoiceCollectionViewController){this._invoiceCollectionViewController.refresh()}this._refreshPlans();this._paymentChangerViewController.cleanup()},_setupSharingSettings:function(){var user=BB.getUser();if(!this.isBillingAdminForAnyPlan()){this._view.hideSharingSettings();return}if(BB.Constants.EMAIL_BLACK_LIST.indexOf(user.getDomain())>-1){this._view.hideSharingSettings();return}this._view.showSharingSettings();var self=this;var restrictedCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("restrict_sharing_checkbox"),user.isExternalSharingRestricted());restrictedCheckbox.bind("change",function(){if(!BB.isFeatureEnabled("accountRestrictions")){self._showSecurityPaywall();restrictedCheckbox.setChecked(false);BB.Tracker.track("restrictedSharingPaywall");return}var isChecked=restrictedCheckbox.isChecked();user.setIsExternalSharingRestricted(isChecked);user.save()});this._view.setSharingToggleElement(restrictedCheckbox);var securityReportCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("security_report_checkbox"),user.isSecurityReportEnabled());securityReportCheckbox.bind("change",function(){if(!BB.isFeatureEnabled("accountRestrictions")){self._showSecurityPaywall();securityReportCheckbox.setChecked(false);BB.Tracker.track("securityReportPaywall");return}var isChecked=securityReportCheckbox.isChecked();user.setIsSecurityReportEnabled(isChecked);user.save()});this._view.setSecurityReportToggleElement(securityReportCheckbox)},_setupInvoiceSettings:function(){var user=BB.getUser();if(!this.isBillingAdminForAnyPlan()){this._view.hideInvoiceSettings();return}if(!BB.isFeatureEnabled("AutoInvoiceMailing")){this._view.hideInvoiceSettings();return}this._view.showInvoiceSettings();var automaticInvoiceEmailSettingCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("invoice_email_checkbox"),user.isAutomaticInvoiceEmailEnabled());automaticInvoiceEmailSettingCheckbox.bind("change",function(){var isChecked=automaticInvoiceEmailSettingCheckbox.isChecked();user.setAutomaticInvoiceEmailEnabled(isChecked);user.save()});this._view.setAutomaticInvoiceEmailToggleElement(automaticInvoiceEmailSettingCheckbox)},isBillingAdminForAnyPlan:function(){return this.getActiveBillingPlanInstances().length>0},_showSecurityPaywall:function(){new BB.Widgets.PaywallGatewayViewController({title:"Feature Not Available",text:"This feature is not available on your current plan. Please upgrade to a higher tier plan to enable this feature."}).show()},upgradePlanButtonClicked:function(planInstance){UI.setURL(Gmail.Constants.Paywall+"/"+planInstance.get("key")+"/plan")},changeTeamButtonClicked:function(planInstance){UI.setURL(Gmail.Constants.Paywall+"/"+planInstance.get("key")+"/team")},checkShouldShow:function(){if(UI.isAccountView()){UI.getCanvas().append(this._view.getElement());this._viewVisible=true;this._viewShown()}else{if(this._view.getElement()){this._view.getElement().detach()}this._viewVisible=false}},invoicesPresent:function(present){this._view.showInvoices(present)},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.Paywall.AccountViewController",AccountViewController);Streak.DependencyManager.addFunction({functionKey:"accountViewControllerInitialized",functionReference:function(){Library.set("BentoBox.Modules.Paywall.AccountViewControllerInstance",new AccountViewController)},dependentFunctionKeys:["htmlLoaded","localeLoaded","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var Library=Streak.Library,_=Streak._,HTML=Streak.HTML,UI=Streak.UI,BB=Streak.BentoBox;var superclass=UI.View;var cardTypeToStarsMap={};cardTypeToStarsMap["MasterCard"]=cardTypeToStarsMap["Discover"]="**** **** **** ";cardTypeToStarsMap["American Express"]="**** ****** *";cardTypeToStarsMap["Diners Club"]="**** ****** ";var cardDefaultStars="****";var PaymentChangerView=Streak.Class.subclass({className:"PaymentChangerView",superclass:superclass,_memberVariables:[{name:"_cardNo",destroy:true},{name:"_cardExpiration",destroy:true},{name:"_changeButton",destroy:true},{name:"_changeScreen",destroy:true},{name:"_updateButton",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._cardNo=this._element.find(".streak__plan_card_no");this._cardName=this._element.find(".streak__plan_card_name");this._cardType=this._element.find(".streak__plan_card_type");this._cardExpiration=this._element.find(".streak__plan_card_expiry");this._changeButton=this._element.find(".streak__plan_card_change_btn");this._changeScreen=this._element.find(".streak__plan_card_change_screen");this._creditCardForm=this._element.find(".streak__changer_credit_card_form");this._updateButton=this._element.find(".streak__changer_update_button")},_setupElement:function(){this._element=HTML.getElement("streak__payment_changer")},hide:function(){this._element.hide()},show:function(){this._element.show().css("display","")},setCard:function(card){this._cardNo.text(this._getStarsForCard(card)+card.last4);this._cardName.text(card.name);this._cardType.text(card.type);this._cardExpiration.text(this._formatExpiration(card.expMonth,card.expYear))},setCreditCardFormView:function(view){this._creditCardForm.html(view.getElement())},_getStarsForCard:function(card){if(_.has(cardTypeToStarsMap,card.type)){return cardTypeToStarsMap[card.type]}else{return cardDefaultStars}},_formatExpiration:function(month,year){var sMonth=""+month;var monthPrefix=sMonth.length<2?"0":"";return monthPrefix+sMonth+"/"+year},setChangeButton:function(button){this._changeButton.html(button.getElement())},setUpdateButton:function(button){this._updateButton.html(button.getElement())},showChangeScreen:function(){this._changeScreen.show()},hideChangeScreen:function(){this._changeScreen.hide()},toggleChangeScreen:function(){this._changeScreen.toggle()}});Library.set("BentoBox.Modules.Paywall.PaymentChangerView",PaymentChangerView)})(Streak);(function(Streak){var _=Streak._,$=Streak.$,BB=Streak.BentoBox,Locale=BB.Locale,Gmail=Streak.Gmail,Stripe=Streak.Stripe,Library=Streak.Library,UI=BB.UI;var superclass=Streak.UI.ViewController;var PaymentChangerViewController=Streak.Class.subclass({className:"AccountViewController",superclass:superclass,memberVariables:[{name:"_changeButton",destroy:true},{name:"_changeScreenVisible",destroy:true},{name:"_creditCardForm",destroy:true},{name:"_updateButton",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._hide();this._setupChangeButton();this._setupUpdateButton();this.cleanup()},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PaymentChangerView")},cleanup:function(){this._hideChangeScreen();this._setUpdateButtonBusy(false);this.loadCard()},loadCard:function(){var self=this;Streak.APIRequester.get("users/me/cards").getPromise().then(function(cards){if(cards.length>0){var card=cards[0];self._setCard(card);self._show()}else{self._hide()}},function(){BB.ButterBarManager.showError("Failed to load card information")})},_setCard:function(card){this._view.setCard(card)},_setupChangeButton:function(){var self=this;if(!this._changeButton){this._changeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("change"),color:"blue",onFunction:function(){self._toggleChangeScreen();BB.Tracker.track("change card clicked")}})}this._view.setChangeButton(this._changeButton)},_setupCreditCardForm:function(){if(!this._creditCardForm){var self=this;this._creditCardForm=Library.getInstance("BentoBox.Widgets.CreditCardFormViewController")}this._view.setCreditCardFormView(this._creditCardForm.getView())},_destroyCreditCardForm:function(){if(this._creditCardForm){this._creditCardForm.destroy();this._creditCardForm=null}},_setupUpdateButton:function(){var self=this;if(!this._updateButton){this._updateButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:Locale.getString("payment_change_card"),color:"blue",onFunction:function(){self._updateButtonClicked();BB.Tracker.track("update card attempted")}})}this._view.setUpdateButton(this._updateButton)},_setUpdateButtonBusy:function(busy){if(busy){this._updateButton.disable()}else{this._updateButton.enable()}},_updateButtonClicked:function(){var self=this;this._updateFormValidity();if(!this._isFormValid()){return}this._setUpdateButtonBusy(true);var saving=BB.ButterBarManager.showSaving();var errorCallback=function(err){saving.reject();self._setUpdateButtonBusy(false);BB.ButterBarManager.showError({message:(err?err.message||err.error||err:false)||Locale.getString("error_unknown")})};self._makeNewStripeToken().then(function(stripeToken){self._setUserStripeCardToken(stripeToken).then(function(){saving.resolve();self.cleanup()},errorCallback)},errorCallback)},_makeNewStripeToken:function(){var self=this;return new Streak.Promise(function(resolve,reject){Stripe.card.createToken(self._getPaymentFormInformation(),function(status,response){if(response.error){console.error("Error with Stripe response",response);reject(response.error)}else{console.log("Card confirmed with Stripe");resolve(response.id)}})})},_show:function(){this._view.show()},_hide:function(){this._view.hide()},_showChangeScreen:function(){this._changeScreenVisible=true;this._view.showChangeScreen();this._setupCreditCardForm()},_hideChangeScreen:function(){this._changeScreenVisible=false;this._view.hideChangeScreen();this._destroyCreditCardForm()},_toggleChangeScreen:function(){if(this._changeScreenVisible){this._hideChangeScreen()}else{this._showChangeScreen()}},_updateFormValidity:function(){this._creditCardForm.updateFormValidity()},_isFormValid:function(){return this._creditCardForm.isFormValid()},_setUserStripeCardToken:function(token){return Streak.APIRequester.put("users/me/cards",null,{cardToken:token}).getPromise()},_getPaymentFormInformation:function(){return this._creditCardForm.getPaymentFormInformation()}});Library.set("BentoBox.Modules.Paywall.PaymentChangerViewController",PaymentChangerViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,BB=Streak.BentoBox;var PaymentContactsChooserEntryView=Streak.Class.subclass({className:"PaymentContactsChooserEntryView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("paymentContactsChooserContact")},setContent:function(imageUrl,name,tag){var suggestionElement=$(BB.Contacts.suggestionTemplate({image:imageUrl,name:name,tag:tag})).children().unwrap();this._element.find(".aclRowContent").append(suggestionElement)},setButton:function(buttonView){var buttonElement=this._element.find(".streak__paywall_contact_selectButton");buttonElement.html(buttonView.getElement())}});Library.set("BentoBox.Widgets.PaymentContactsChooserEntryView",PaymentContactsChooserEntryView)})(Streak);(function(Streak){var Library=Streak.Library,BB=Streak.BentoBox;var PaymentContactsChooserEntryViewController=Streak.Class.subclass({className:"PaymentContactsChooserEntryViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_person",destroy:true,get:true},{name:"_button",destroy:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.PaymentContactsChooserEntryView");this._setupButton()},setPerson:function(person){var image=person.imageUrl?person.imageUrl:Streak.server+Streak.combinedPath+"images/unknownContact.png";var name=person.fullName||person.email;var tag=person.fullName?person.email:"&nbsp;";this._view.setContent(image,name,tag);this._person=person},_setupButton:function(){var self=this;var button=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("payment_add_to_team"),color:"default",onFunction:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.team.memberAdded",{person:self._person.email});self._callDelegateFunction("addTeamMember",self._person)}});this._view.setButton(button)}});Library.set("BentoBox.Widgets.PaymentContactsChooserEntryViewController",PaymentContactsChooserEntryViewController)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox;var PaymentContactsChooserViewController=Streak.Class.subclass({className:"PaymentContactsChooserViewController",superclass:UI.ViewController,_memberVariables:[{name:"_contactEntryViewControllers",destroy:true},{name:"_model",destroy:true},{name:"_autosuggestedContacts",destroy:true},{name:"_visibleAutosuggestions",destroy:true},{name:"_loadingContacts",destroy:true}],_initialize:function(params){UI.ViewController.prototype._initialize.call(this);this._model=params.model;this._contactEntryViewControllers=[];this._visibleAutosuggestions=[];this.startContactLoading();this._model.addDelegate(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PaymentContactsChooserView")},startContactLoading:function(){var self=this;this._view.showLoading();this._loadingContacts=true;BB.Contacts.getTopContacts(function(results){this._loadingContacts=false;results=results||[];if(results.length===0){self._autosuggestedContacts=[];self._view.setAreThereAutosuggestedContacts(false)}else{self._autosuggestedContacts=_(results).chain().filter(function(person){return person.email!==BB.getUser().get("email")&&person.fullName!==person.email}).value()}self.updateAutosuggestedContacts()},30)},_addAutosuggestedContact:function(person){var contactEntry=Library.getInstance("BentoBox.Widgets.PaymentContactsChooserEntryViewController");contactEntry.setPerson(person);contactEntry.addDelegate(this);this._view.addSuggestedContactEntryView(contactEntry.getView());this._contactEntryViewControllers[person.email]=contactEntry;this._visibleAutosuggestions.push(person);this._view.setAreThereAutosuggestedContacts(this._visibleAutosuggestions.length>0)},_removeAutosuggestedContact:function(person){this._view.removeSuggestedContactEntryView(this._contactEntryViewControllers[person.email].getView());this._visibleAutosuggestions=_.without(this._visibleAutosuggestions,person);this._contactEntryViewControllers[person.email]=undefined;this._view.setAreThereAutosuggestedContacts(this._visibleAutosuggestions.length>0)},addTeamMember:function(teamMember){this._model.addTeamMember(teamMember)},teamChanged:function(){this.updateAutosuggestedContacts()},updateAutosuggestedContacts:function(){if(this._autosuggestedContacts){var teamEmails=_.pluck(this._model.getTeam(),"email");var newAutosuggestions=_.filter(this._autosuggestedContacts,function(contact){return teamEmails.indexOf(contact.email)==-1});var newAutosuggestionEmails=_.pluck(newAutosuggestions,"email");var visibleAutosuggestionEmails=_.pluck(this._visibleAutosuggestions,"email");var newlyVisibleAutosuggestions=_.filter(newAutosuggestions,function(contact){return visibleAutosuggestionEmails.indexOf(contact.email)==-1});var newlyInvisibleAutosuggestions=_.filter(this._visibleAutosuggestions,function(contact){return newAutosuggestionEmails.indexOf(contact.email)==-1});var self=this;_.each(newlyVisibleAutosuggestions,function(person){self._addAutosuggestedContact(person)});_.each(newlyInvisibleAutosuggestions,function(person){self._removeAutosuggestedContact(person)})}if(this._loadingContacts){return}this._view.setAreThereAutosuggestedContacts(this._visibleAutosuggestions.length>0)}});Library.set("BentoBox.Modules.Paywall.PaymentContactsChooserViewController",PaymentContactsChooserViewController)
})(Streak);(function(Streak){var Library=Streak.Library,UI=Streak.UI,HTML=Streak.HTML;var PaymentContactsChooserView=Streak.Class.subclass({className:"PaymentContactsChooserView",superclass:UI.View,_memberVariables:[{name:"_empty",destroy:true},{name:"_listElement",destroy:true},{name:"_loadingElement",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("streak__paymentContactsChooserContact_list");this._listElement=this._element.find(".streak__list");this._loadingElement=this._element.find(".streak__loading");this._empty=this._element.find(".streak__empty")},setAreThereAutosuggestedContacts:function(areThereAutosuggestedContacts){this.hideLoading();if(areThereAutosuggestedContacts){this._empty.hide();this._listElement.show()}else{this._listElement.hide();this._empty.show()}},showLoading:function(){this._listElement.hide();this._empty.hide();this._loadingElement.show()},hideLoading:function(){this._loadingElement.hide()},addSubView:function(subview){this._listElement.append(subview.getElement())},addSuggestedContactEntryView:function(view){this.addSubView(view)},removeSuggestedContactEntryView:function(subview){subview.getElement().remove()}});Library.set("BentoBox.Modules.Paywall.PaymentContactsChooserView",PaymentContactsChooserView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,BB=Streak.BentoBox;var PaymentContactsChosenEntryView=Streak.Class.subclass({className:"PaymentContactsChosenEntryView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("paymentContactsChosenContact")},clickRemove:function(cb){this._element.find(".ar9").click(cb)},setContent:function(imageUrl,name,tag){var suggestionElement=$(BB.Contacts.suggestionTemplate({image:imageUrl,name:name,tag:tag})).children().unwrap();this._element.find(".streak__contactContent").append(suggestionElement)}});Library.set("BentoBox.Widgets.PaymentContactsChosenEntryView",PaymentContactsChosenEntryView)})(Streak);(function(Streak){var Library=Streak.Library;var PaymentContactsChosenEntryViewController=Streak.Class.subclass({className:"PaymentContactsChosenEntryViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_person",destroy:true,get:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);var self=this;this._view.clickRemove(function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.team.memberRemoved",{person:self._person.email});self._callDelegateFunction("removeTeamMember",self._person)})},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.PaymentContactsChosenEntryView")},setPerson:function(person){var image=person.imageUrl||person.image||Streak.server+Streak.combinedPath+"images/unknownContact.png";var name=person.fullName||person.email;var tag=person.fullName?person.email:"&nbsp;";this._view.setContent(image,name,tag);this._person=person},removeTeamMember:function(teamMember){this._callDelegateFunction("removeTeamMember",teamMember)}});Library.set("BentoBox.Widgets.PaymentContactsChosenEntryViewController",PaymentContactsChosenEntryViewController)})(Streak);(function(Streak){var Library=Streak.Library,UI=Streak.UI;var PaymentContactsChosenView=Streak.Class.subclass({className:"PaymentContactsChosenView",superclass:UI.View,_memberVariables:[{name:"_noTeamElement",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this)},addChosenContactView:function(view){this.prependSubView(view);this._noTeamElement.hide()},removeChosenContactView:function(view){this.removeSubview(view);if(this._element.children().length<=1){this._noTeamElement.show()}},setElement:function(element){this._element=element;this._noTeamElement=this._element.find(".streak__no_team")},removeSubview:function(subview){subview.getElement().remove()}});Library.set("BentoBox.Modules.Paywall.PaymentContactsChosenView",PaymentContactsChosenView)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,BB=Streak.BentoBox,UI=Streak.UI;var PaymentContactsChosenViewController=Streak.Class.subclass({className:"PaymentContactsChosenViewController",superclass:UI.ViewController,_memberVariables:[{name:"_model",destroy:false},{name:"_chosenContacts",destroy:true},{name:"_chosenContactEntryViewControllers",destroy:true},{name:"_teamSuggestions",destroy:true},{name:"_teamSuggestionsAlreadyAdded",destroy:true,defaultValue:false},{name:"_hasFocus",destroy:true,defaultValue:false},{name:"_acceptDefaultTeamSuggestionsAutomatically",destroy:true,defaultValue:false},{name:"_defaultTeamSuggestionsDeferred",destroy:true}],_initialize:function(params){UI.ViewController.prototype._initialize.call(this);this._model=params.model;this._chosenContacts=[];this._chosenContactEntryViewControllers={};this._model.addDelegate(this);this.hasDefaultTeamSuggestionLoaded(false)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PaymentContactsChosenView")},planInstanceCleared:function(){this._clearTeam();this._acceptDefaultTeamSuggestionsAutomatically=false;this._defaultTeamSuggestionsDeferred=null},initializeTeam:function(planInstance){this._clearTeam();this._teamSuggestions=null;this._defaultTeamSuggestionsDeferred=Streak.Promise.defer();var self=this;this.getTeamSuggestions({planInstance:planInstance}).then(function(teamSuggestions){self._teamSuggestions=teamSuggestions;self._addTeamSuggestions();self.hasDefaultTeamSuggestionLoaded(true);self._defaultTeamSuggestionsDeferred.resolve()},function(err){self._teamSuggestions=[];console.error("Error retrieving suggestions",err);self.hasDefaultTeamSuggestionLoaded(true);self._defaultTeamSuggestionsDeferred.resolve()})},whenDefaultTeamSuggestionsLoaded:function(){if(this._defaultTeamSuggestionsDeferred){return this._defaultTeamSuggestionsDeferred.promise}throw new Error("whenDefaultTeamSuggestionsLoaded called in between planInstanceCleared clear and initializeTeam")},addChosenContact:function(contact){if(this._chosenContactEntryViewControllers[contact.email]){return}var contactEntry=Library.getInstance("BentoBox.Widgets.PaymentContactsChosenEntryViewController");contactEntry.setPerson(contact);contactEntry.addDelegate(this);this._view.addChosenContactView(contactEntry.getView());this._chosenContacts.push(contact);this._chosenContactEntryViewControllers[contact.email]=contactEntry;BB.ButterBarManager.hideMessage("paywall-error")},removeChosenContact:function(contact){var removedContactViewController=this._chosenContactEntryViewControllers[contact.email];this._view.removeChosenContactView(removedContactViewController.getView());this._chosenContacts=_.without(this._chosenContacts,contact);this._chosenContactEntryViewControllers[contact.email]=undefined},hasLoadedSuggestions:function(){return this._teamSuggestions!=null},_addTeamSuggestions:function(){if(this._teamSuggestionsAlreadyAdded){return}if(!(this._hasFocus||this._acceptDefaultTeamSuggestionsAutomatically)){return}if(!this._teamSuggestions){return}if(this._model.isTeamSet()){this._teamSuggestionsAlreadyAdded=true;return}this._teamSuggestionsAlreadyAdded=true;for(var i=0;i<this._teamSuggestions.length;i++){this._model.addTeamMember(this._teamSuggestions[i])}},teamChanged:function(){this._updateDisplayedContacts()},_clearTeam:function(){this._teamSuggestionsAlreadyAdded=false;this.hasDefaultTeamSuggestionLoaded(false)},_updateDisplayedContacts:function(){var newTeam=this._model.getTeam();var oldTeam=this._chosenContacts;var removed=_.difference(oldTeam,newTeam);var added=_.difference(newTeam,oldTeam);for(var i=0;i<removed.length;i++){var removedContact=removed[i];this.removeChosenContact(removedContact)}for(i=0;i<added.length;i++){var addedContact=added[i];this.addChosenContact(addedContact)}},removeTeamMember:function(teamMember){this._model.removeTeamMember(teamMember)},getTeamSuggestions:function(parameters){var queryParameters={};if(parameters.planInstance){queryParameters.planInstanceKey=parameters.planInstance.get("key")}return Streak.APIRequester.get("users/me/teamsuggestion",queryParameters).getPromise()},hasDefaultTeamSuggestionLoaded:function(hasLoaded){this._callDelegateFunction("hasDefaultTeamSuggestionLoaded",hasLoaded)},focus:function(hasFocus){this._hasFocus=hasFocus;this._addTeamSuggestions()},acceptDefaultTeamAutomatically:function(){this._acceptDefaultTeamSuggestionsAutomatically=true;this._addTeamSuggestions()}});Library.set("BentoBox.Modules.Paywall.PaymentContactsChosenViewController",PaymentContactsChosenViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI,BB=Streak.BentoBox;var TeamView=Streak.Class.subclass({className:"TeamView",superclass:UI.View,_memberVariables:[{name:"_teamPicker",destroy:true},{name:"_chosenTeam",destroy:true},{name:"_numberOfTeamMembersElement",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this);this._teamPicker=this._element.find(".streak__paywall_team_picker_list");this._chosenTeam=this._element.find(".streak__team_summary");this._numberOfTeamMembersElement=this._element.find(".streak__team_numberOfMembers")},_setupElement:function(){this._element=HTML.getElement("streak__paywall_select_users")},setAddPersonButton:function(button){var addPersonButtonElement=this._element.find(".streak__add_more_button");addPersonButtonElement.html(button.getElement())},setPersonPicker:function(picker){var personPickerElement=this._element.find(".streak__add_more_textbox");personPickerElement.html(picker.getElement())},setTeamContinueButton:function(button){var continueButtonElement=this._element.find(".streak__team_continue_button");continueButtonElement.html(button.getElement())},getChosenContactListElement:function(){return this._chosenTeam},setContactChooser:function(view){this._teamPicker.html(view.getElement())},setNumberOfTeamMembers:function(numberOfTeamMembers){this._numberOfTeamMembersElement.text(BB.Locale.getString("payment_your_team",{teamsize:numberOfTeamMembers}))}});Library.set("BentoBox.Modules.Paywall.TeamView",TeamView)})(Streak);(function(Streak){var Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox;var TeamViewController=Streak.Class.subclass({className:"TeamViewController",superclass:UI.ViewController,_memberVariables:[{name:"_teamContinueButton",destroy:true},{name:"_personPicker",get:true,destroy:true},{name:"_addPersonButton",destroy:true},{name:"_model",destroy:true},{name:"_chosenContactsViewController",destroy:true},{name:"_contactChooserViewController",destroy:true}],_initialize:function(params){UI.ViewController.prototype._initialize.call(this);this._model=params.model;this._setupContinueTeamButton();this._setupPersonPicker();this._setupChosenContactViewController();this._model.addDelegate(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.TeamView")},_setupContinueTeamButton:function(){if(!this._teamContinueButton){var self=this;this._teamContinueButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",html:BB.Locale.getString("continue_to_next_step")+" &#x279c;",color:"blue",onFunction:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.team.continueButton.clicked");self._callDelegateFunction("teamContinueButtonPressed")}})}this._view.setTeamContinueButton(this._teamContinueButton)},_setupPersonPicker:function(){if(!this._personPicker){var self=this;this._personPicker=new BB.Widgets.PersonPickerViewController({contactSelectedCallback:function(person){self.addTeamMember(person)}})}this._view.setPersonPicker(this._personPicker.getView())},_setupAddPersonButton:function(){if(!this._addPersonButton){var self=this;this._addPersonButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("add"),onFunction:function(){self._personPicker.selectItem()}})}this._view.setAddPersonButton(this._addPersonButton)},_setupContactChooserViewController:function(){this._contactChooserViewController=Library.getInstance("BentoBox.Modules.Paywall.PaymentContactsChooserViewController",{model:this._model});this._view.setContactChooser(this._contactChooserViewController.getView())},_setupChosenContactViewController:function(){this._chosenContactsViewController=Library.getInstance("BentoBox.Modules.Paywall.PaymentContactsChosenViewController",{model:this._model});this._chosenContactsViewController.addDelegate(this);this._chosenContactsViewController.getView().setElement(this._view.getChosenContactListElement())},addTeamMember:function(teamMember){this._model.addTeamMember(teamMember)},teamChanged:function(){this._updateExcludedPeople();this._view.setNumberOfTeamMembers(this._model.getTeamEmailAddresses().length)},hasLoadedSuggestions:function(){return this._chosenContactsViewController.hasLoadedSuggestions()},whenDefaultTeamSuggestionsLoaded:function(){return this._chosenContactsViewController.whenDefaultTeamSuggestionsLoaded()},focus:function(hasFocus){if(!this._contactChooserViewController&&hasFocus){this._setupContactChooserViewController()}this._chosenContactsViewController.focus(hasFocus)},_updateExcludedPeople:function(){var excluded=this._model.getTeam();this.getPersonPicker().setExcluded(excluded)},planInstanceChanged:function(planInstance){this._chosenContactsViewController.initializeTeam(planInstance);if(this._model.shouldAcceptDefaultTeamAutomatically()){this._chosenContactsViewController.acceptDefaultTeamAutomatically()}},hasDefaultTeamSuggestionLoaded:function(hasLoaded){this._callDelegateFunction("hasDefaultTeamSuggestionLoaded",hasLoaded)}});Library.set("BentoBox.Modules.Paywall.TeamViewController",TeamViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var PlanView=Streak.Class.subclass({className:"PlanView",superclass:UI.View,_memberVariables:[{name:"_plan",destroy:true,get:true},{name:"_upgradeButton",destroy:true,get:true},{name:"_emailSupport",destroy:true,defaultValue:false},{name:"_phoneSupport",destroy:true,defaultValue:false}],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=$(HTML.getElement("streak__paywall_plan"))},setPlanName:function(planName){this._element.find(".streak__plan_name").text(planName)},setPlanCost:function(planCost){this._element.find(".streak__cost").text(planCost)},setTopColor:function(topColor){if(topColor){var topColorElement=this._element.find(".streak__plan_summary_color_bar");topColorElement.css("background-color",topColor);topColorElement.show()}},addFeatureKey:function(featureKey){if(featureKey=="emailSupport"){this._emailSupport=true;this.updateSupportLevel()}else if(featureKey=="phoneSupport"){this._phoneSupport=true;this.updateSupportLevel()}else{this.showFeature(featureKey,true)}},removeFeatureKey:function(featureKey){if(featureKey=="emailSupport"){this._emailSupport=false;this.updateSupportLevel()}else if(featureKey=="phoneSupport"){this._phoneSupport=false;this.updateSupportLevel()}else{this.showFeature(featureKey,false)}},showFeature:function(featureKey,visible){if(visible){this._element.find(".streak__plan_feature_description_"+featureKey).show();this._element.find(".streak__plan_feature_description_no_"+featureKey).hide()}else{this._element.find(".streak__plan_feature_description_"+featureKey).hide();this._element.find(".streak__plan_feature_description_no_"+featureKey).show()}},updateSupportLevel:function(){if(this._phoneSupport){this._element.find(".streak__plan_feature_description_no_emailSupport").hide();this._element.find(".streak__plan_feature_description_emailSupport").hide();this._element.find(".streak__plan_feature_description_phoneSupport").show()}else if(this._emailSupport){this._element.find(".streak__plan_feature_description_no_emailSupport").hide();this._element.find(".streak__plan_feature_description_emailSupport").show();this._element.find(".streak__plan_feature_description_phoneSupport").hide()}else{this._element.find(".streak__plan_feature_description_no_emailSupport").show();this._element.find(".streak__plan_feature_description_emailSupport").hide();this._element.find(".streak__plan_feature_description_phoneSupport").hide()}},setLearnMore:function(learnMoreText){if(learnMoreText){var learnMoreElement=this._element.find(".streak__learn_more");learnMoreElement.attr("data-tooltip",learnMoreText);learnMoreElement.css("visibility","visible")}},showDiscount:function(){this._element.find(".streak__plan_discount").show().css("display","")},hideDiscount:function(){this._element.find(".streak__plan_discount").hide()},setDiscountPercentage:function(discountPercentage){this._element.find(".streak__plan_discount .streak__discount_percentage").text(discountPercentage)},setOriginalCost:function(costPerUser){this._element.find(".streak__plan_discount .streak__original_cost_per_user").text(costPerUser)},setTrialPeriod:function(trialPeriodDays){var refundElement=this._element.find(".streak__refund_text");var trialPeriodDaysElement=this._element.find(".streak__trialPeriodDays");var trialPeriodElementText=this._element.find(".streak__trialPeriod_text");trialPeriodDaysElement.text(trialPeriodDays);if(trialPeriodDays===0){refundElement.show().css("display","");trialPeriodElementText.hide()}else{refundElement.hide();trialPeriodElementText.show().css("display","")}},setUpgradeButton:function(button){this._upgradeButton=button;var buttonElement=this._element.find(".streak__upgrade_button");buttonElement.html(this._upgradeButton.getElement())},setCollaboratorLimit:function(limit){var hasLimit;if(typeof limit==="number"){hasLimit=true}else if(limit===null){hasLimit=false}else{throw new Error("setCollaboratorLimit got invalid limit")}this._element.find(".streak__plan_feature_description_unlimitedCollaborators").toggle(!hasLimit);this._element.find(".streak__plan_feature_description_limitedCollaborators").text(limit).toggle(hasLimit)}});Library.set("BentoBox.Modules.Paywall.PlanView",PlanView)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox,Locale=BB.Locale;var superclass=UI.ViewController;var PlanViewController=Streak.Class.subclass({className:"PlanViewController",superclass:superclass,_memberVariables:[{name:"_upgradeButton",destroy:true},{name:"_planKey",destroy:true},{name:"_topColor",destroy:true},{name:"_model",destroy:true}],_initialize:function(params){superclass.prototype._initialize.call(this);this._model=params.model;this._planKey=params.planKey;this._topColor=params.topColor;this._view.setTopColor(this._topColor);var planName=this._model.getPlanName(this._planKey);this._view.setPlanName(planName);var planCost=this._model.getPlanCostPerUserPerMonth(this._planKey);this._view.setPlanCost(planCost);var planCollaboratorLimit=this._model.getCollaboratorLimit(this._planKey);this._view.setCollaboratorLimit(planCollaboratorLimit);this._refreshDiscount();var featureKeys=this._model.getPlanFeatureDescription(this._planKey);if(featureKeys){for(var i=0;i<featureKeys.length;i++){var featureKey=featureKeys[i];this._view.addFeatureKey(featureKey)}}var learnMoreText=this._model.getPlanLearnMoreText(this._planKey);this._view.setLearnMore(learnMoreText);this._refreshTrialPeriod();this._setupUpgradeButton();this._model.addDelegate(this)},_setupUpgradeButton:function(){var self=this;this._upgradeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:this.getButtonTextForPlan(),color:this.getButtonColorForPlan(),onFunction:function(){self.planUpgradeClicked()}});this._view.setUpgradeButton(this._upgradeButton)},planUpgradeClicked:function(){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.plan.continue.clicked",{planKey:this._planKey});this._model.setSelectedPlanKey(this._planKey);this._callDelegateFunction("planUpgradeClicked")},planChanged:function(){BB.ButterBarManager.hideMessage("paywall-error");this._upgradeButton.setHTML(this.getButtonTextForPlan()+" &#x279c;");this._upgradeButton.setColor(this.getButtonColorForPlan())},discountChanged:function(){this._refreshDiscount()},trialPeriodDaysChanged:function(){this._refreshTrialPeriod()},_refreshDiscount:function(){var discountPercentage=this._model.getDiscountPercentage(this._planKey);var originalCost=this._model.getBasePlanCostPerUserPerMonth(this._planKey);if(discountPercentage&&discountPercentage!==0){this._view.showDiscount();this._view.setDiscountPercentage(discountPercentage);this._view.setOriginalCost(originalCost)}else{this._view.hideDiscount()}},_refreshTrialPeriod:function(){var trialPeriodDays=this._model.getTrialPeriodDays(this._planKey)||0;this._view.setTrialPeriod(trialPeriodDays)},getButtonTextForPlan:function(){if(!this._model){return Locale.getString("payment_upgrade")}var selectedPlanKey=this._model.getSelectedPlanKey();if(!selectedPlanKey){return Locale.getString("payment_upgrade")}var planCost=this._model.getPlanCostPerUserPerMonth(this._planKey);if(this._planKey===selectedPlanKey){return Locale.getString("payment_keep_plan")}else if(planCost<this._model.getPlanCostPerUserPerMonth(selectedPlanKey)){return Locale.getString("payment_downgrade")}else{return Locale.getString("payment_upgrade")}},getButtonColorForPlan:function(){if(!this._model){return"blue"}var selectedPlanKey=this._model.getSelectedPlanKey();if(this._planKey===selectedPlanKey){return"green"}else{return"blue"}},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PlanView")}});Library.set("BentoBox.Modules.Paywall.PlanViewController",PlanViewController)})(Streak);(function(Streak){var $=Streak.$,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI,Locale=Streak.Locale;var superclass=UI.View;var PlansView=Streak.Class.subclass({className:"PlansView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this);this._plansWrapper=this._element.find(".streak__plans_wrapper")},_setupElement:function(){this._element=$(HTML.getElement("streak__paywall_plans"))},addPlan:function(planView){this._plansWrapper.append(planView.getElement())},clearPlans:function(){this._plansWrapper.html(null)},setHelpButton:function(feature,button){this._element.find(".streak__"+feature+"_description").html(button.getElement())},getTextForHelpButton:function(feature){return Locale.getString("feature_description_"+feature)},showCurrentFreePlan:function(){this._element.find(".streak__plans_currentFreePlan").show()},hideCurrentFreePlan:function(){this._element.find(".streak__plans_currentFreePlan").hide()}});Library.set("BentoBox.Modules.Paywall.PlansView",PlansView)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox;var CONSTANTS={BEST_COLOR:"#00a551",WORST_COLOR:"#ee4036",DEFAULT_COLOR:"#fff100"};var PlansViewController=Streak.Class.subclass({className:"PlansViewController",superclass:UI.ViewController,_memberVariables:[{name:"_colorForPlan",destroy:true},{name:"_model",destroy:false},{name:"_planViews",destroy:true}],_initialize:function(params){UI.ViewController.prototype._initialize.call(this);this._model=params.model;this._colorForPlan={};this._planViewControllers=[];this._setupHelpLinks();this._model.addDelegate(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PlansView")},planUpgradeClicked:function(){this._callDelegateFunction("planUpgradeClicked")},plansChanged:function(){var planKeys=this._model.getPlanKeys();var self=this;planKeys=_.sortBy(planKeys,function(planKey){return self._model.getPlanCostPerUserPerMonth(planKey)});this._removeAllPlans();for(var i=0;i<planKeys.length;i++){var planKey=planKeys[i];var topColor=this.colorForPlan(i,planKeys.length);this._addPlan({planKey:planKey,topColor:topColor})}this._setupCurrentFreePlan()},colorForPlan:function(position,outOf){var bestPlan=outOf>=3?outOf-2:outOf;var worstPlan=outOf>=3?outOf-1:-1;if(position==bestPlan){return CONSTANTS.BEST_COLOR}else if(position==worstPlan){return CONSTANTS.WORST_COLOR}else{return CONSTANTS.DEFAULT_COLOR}},_addPlan:function(params){params=_.extend(params,{model:this._model});var planViewController=Library.getInstance("BentoBox.Modules.Paywall.PlanViewController",params);planViewController.addDelegate(this);this._planViewControllers.push(planViewController);this._view.addPlan(planViewController.getView())},_removeAllPlans:function(){this._planViews=[];this._view.clearPlans()},_setupHelpLinks:function(){var links=[{feature:"collaboratorLimits",helpChapter:"Limits on Streak Collaborators"},{feature:"unlimitedBoxes",helpChapter:"Limits on Streak Data"},{feature:"linkedBoxes",helpChapter:"What are Linked Boxes?"},{feature:"emailFilters",helpChapter:"What are Email Filters?"},{feature:"formulaFields",helpChapter:"What are Formulas?"},{feature:"reports",helpChapter:"What are Reports?"},{feature:"granularPermissions",helpChapter:"What are Granular Permissions?"},{feature:"unlimitedEmailTools",helpChapter:"What Are The Email Tool Limits?"},{feature:"support",helpChapter:"What is Premium Support?"}];_.each(links,this._setupHelpLink.bind(this))},_setupHelpLink:function(parameters){var self=this;var button=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:self._view.getTextForHelpButton(parameters.feature),onFunction:function(){var HelpLoader=Library.get("BentoBox.Modules.Help.HelpLoader");HelpLoader.getHelpViewController().startChapter(parameters.helpChapter)}});this._view.setHelpButton(parameters.feature,button)},_setupCurrentFreePlan:function(){if(!this._model||!this._model.getSelectedPlanKey()){this._view.showCurrentFreePlan()}else{this._view.hideCurrentFreePlan()}}});Library.set("BentoBox.Modules.Paywall.PlansViewController",PlansViewController)})(Streak);(function(Streak){var Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var PaymentView=Streak.Class.subclass({className:"PaymentView",superclass:UI.View,_memberVariables:[{name:"_creditCardForm",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this);this._stripeAlert=this._element.find(".streak__stripe_error");this._creditCardForm=this._element.find(".streak__payment_credit_card_form")},_setupElement:function(){this._element=HTML.getElement("streak__paywall_payment")},setContinueButton:function(button){var subscribeButtonElement=this._element.find(".streak__subscribe_button");subscribeButtonElement.html(button.getElement())},setCreditCardFormView:function(view){this._creditCardForm.html(view.getElement())},setStripeError:function(text){this._stripeAlert.text(text)},setChangeCardButton:function(button){this._element.find(".streak__payment_changeCard").html("or, ");this._element.find(".streak__payment_changeCard").append(button.getElement())},showLoading:function(){this._element.find(".streak__payment_loading").show();this._creditCardForm.hide();this._element.find(".streak__card_filled_in").hide();this._element.find(".streak__payment_changeCard").hide()},showThereIsAnExistingCreditCard:function(){this._element.find(".streak__payment_loading").hide();this._creditCardForm.hide();this._element.find(".streak__card_filled_in").show();this._element.find(".streak__payment_changeCard").show()},showCreditCardForm:function(){this._element.find(".streak__payment_loading").hide();this._element.find(".streak__card_filled_in").hide();this._creditCardForm.show();this._element.find(".streak__payment_changeCard").hide()}});Library.set("BentoBox.Modules.Paywall.PaymentView",PaymentView)})(Streak);(function(Streak){var _=Streak._,$=Streak.$,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox,Locale=BB.Locale,Stripe=Streak.Stripe,ButterBarManager=BB.ButterBarManager;var PaymentViewController=Streak.Class.subclass({className:"PaymentViewController",superclass:UI.ViewController,_memberVariables:[{name:"_model",destroy:true},{name:"_continueButton",destroy:true},{name:"_userHasBillingInfo",destroy:true},{name:"_changeCardButton",destroy:true},{name:"_shouldOverrideCard",destroy:true,defaultValue:false}],_initialize:function(params){UI.ViewController.prototype._initialize.call(this);this._model=params.model;this._setupContinueButton();this._setupCreditCardForm();this._setupChangeCardButton();this._model.addDelegate(this);this._updateButtonEnabled();this._view.showLoading()},planInstanceChanged:function(){this._view.showLoading();var self=this;this._doesUserHaveExistingCard().then(function(hasCard){self._model.setUserHasCard(hasCard);self._setUserHasBillingInfo(hasCard);if(hasCard){self._view.showThereIsAnExistingCreditCard()}else{self._view.showCreditCardForm()}})},teamChanged:function(){this._updateButtonEnabled()},planChanged:function(){this._updateButtonEnabled()},focus:function(){if(this._userHasBillingInfo){this._shouldOverrideCard=false;this._view.showThereIsAnExistingCreditCard();return}this._creditCardForm.focus()},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.PaymentView")},_setupCreditCardForm:function(){if(!this._creditCardForm){var self=this;this._creditCardForm=Library.getInstance("BentoBox.Widgets.CreditCardFormViewController")}this._view.setCreditCardFormView(this._creditCardForm.getView())},_setupContinueButton:function(){if(!this._continueButton){var self=this;this._continueButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:Locale.getString("payment_subscribe"),color:"blue",onFunction:function(){self._buyPlanButtonClicked()}});this._continueButton.getElement().attr("tabindex",0);this._updateButtonEnabled()}this._view.setContinueButton(this._continueButton)},_setupChangeCardButton:function(){var self=this;this._changeCardButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:Locale.getString("payment_change_card"),onFunction:function(){self._view.showCreditCardForm();self._shouldOverrideCard=true}});this._view.setChangeCardButton(this._changeCardButton)},_isFormValid:function(){return this._creditCardForm.isFormValid()},_setUserHasBillingInfo:function(hasBillingInfo){this._userHasBillingInfo=hasBillingInfo;this._updateButtonEnabled()},_updateButtonEnabled:function(){var buttonEnabled=this._continueButtonShouldBeEnabled();if(buttonEnabled){this._continueButton.enable()}else{this._continueButton.disable()}},_continueButtonShouldBeEnabled:function(){if(!this._model)return false;return this._model.isPlanSet()&&this._model.isTeamSet()&&this._userHasBillingInfo!==null},_buyPlanButtonClicked:function(){this._updateFormValidity({emptyIsValid:false});if(!this._continueButtonShouldBeEnabled()){return}if(this._userHasBillingInfo&&!this._shouldOverrideCard){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.payment.subscribe.clicked",{valid:true,hasBillingInfo:true});this._showSubscribingMessage();this._setButtonToPaying(true);this._delegate.subscribeWithBillingComplete().then(this._subscribedSuccessfully.bind(this),this._problemWithSubscribing.bind(this))}else if(this._isFormValid({emptyIsValid:false})){Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.payment.subscribe.clicked",{valid:true,hasBillingInfo:false});this._showSubscribingMessage();this._setButtonToPaying(true);this._setupBillingForUser().then(this._delegate.subscribeWithBillingComplete.bind(this._delegate)).then(this._subscribedSuccessfully.bind(this)).catch(this._problemWithSubscribing.bind(this))}else{Library.get("BentoBox.Modules.Paywall.PaywallTrackerInstance").track("paywall.payment.subscribe.clicked",{valid:false,hasBillingInfo:false})}},_setupBillingForUser:function(){return this._makeNewStripeToken().then(this._setUserStripeCardToken)},_doesUserHaveExistingCard:function(){return Streak.APIRequester.get("users/me/cards").getPromise().then(function(cardResponse){var hasCard=cardResponse.length>0&&cardResponse[0].id!==undefined;return hasCard})},_setUserStripeCardToken:function(token){return Streak.APIRequester.put("users/me/cards",{cardToken:token}).getPromise()
},_updateFormValidity:function(){return this._creditCardForm.updateFormValidity()},_isFormValid:function(){return this._creditCardForm.isFormValid()},_showSubscribingMessage:function(){ButterBarManager.showMessage(Locale.getString("payment_subscribing"),{priority:1,time:ButterBarManager.FOREVER,messageKey:"paywall"})},_subscribedSuccessfully:function(){this._setButtonToPaying(false);ButterBarManager.showMessage(Locale.getString("payment_subscribed"),{priority:100,messageKey:"paywall"})},_problemWithSubscribing:function(errorObject){this._setButtonToPaying(false);var errorMessage=Locale.getString("payment_subscription_failed");if(!errorObject){ButterBarManager.showError(errorMessage,{messageKey:"paywall"});BB.logError("Problem with subscription payment\nerror: no error object")}else{errorMessage=BB.Locale.getString(errorObject.errorMessage||errorObject.stripeMessage||errorMessage);ButterBarManager.showError(errorMessage,{messageKey:"paywall"});BB.logError("Problem with subscription payment\nerror:"+errorMessage,errorObject)}},_setButtonToPaying:function(isPaying){if(isPaying){this._continueButton.disable();this._continueButton.setText(Locale.getString("payment_purchasing"))}else{this._continueButton.setText(Locale.getString("payment_subscribe"));this._continueButton.enable()}},_makeNewStripeToken:function(){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){Stripe.card.createToken(self._getPaymentFormInformation(),function(status,response){if(response.error){var error=new Error("Bad response from server");error.response=response;error.details={response:response};if(response.error.type==="card_error"){self._stripeError(response)}reject(error)}else{resolve(response.id)}})})},_getPaymentFormInformation:function(){return this._creditCardForm.getPaymentFormInformation()},_stripeError:function(response){this._view.setStripeError(response.error.message)}});Library.set("BentoBox.Modules.Paywall.PaymentViewController",PaymentViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var InvoiceView=Streak.Class.subclass({className:"InvoiceView",superclass:superclass,_memberVariables:[{name:"_amount",destroy:true},{name:"_users",destroy:true},{name:"_description",destroy:true},{name:"_dateRange",destroy:true},{name:"_seeDetails",destroy:true},{name:"_lineItemElements",destroy:true},{name:"_lineItemElementsVisible",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._amount=this._element.find(".streak__invoice_amount");this._users=this._element.find(".streak__invoice_users");this._description=this._element.find(".streak__invoice_description");this._dateRange=this._element.find(".streak__invoice_date_range");this._seeDetails=this._element.find(".streak__invoice_see_details");this._emailInvoice=this._element.find(".streak__invoice_email_invoice");this._lineItemElements=$()},_setupElement:function(){this._element=$(HTML.getElement("streak__invoice_view"))},addInvoiceLineItem:function(lineItemView){var lineItemElement=lineItemView.getElement();if(this._lineItemElementsVisible){this._element.append(lineItemElement)}this._lineItemElements=this._lineItemElements.add(lineItemElement)},showSeeLessDetails:function(show){if(show){this._seeDetails.toggle(show).css("display","")}else{this._seeDetails.toggle(show)}},setSeeDetailsButton:function(buttonView){this._seeDetails.html(buttonView.getElement())},setEmailInvoiceButton:function(buttonView){this._emailInvoice.html(buttonView.getElement())},clearLineItems:function(){this._lineItemElements.remove();this._lineItemElements=$()},setUsers:function(usersText){this._users.html(usersText)},setPlan:function(planText){this._description.html(planText)},setDateRange:function(dateRangeText){this._dateRange.html(dateRangeText)},setCost:function(costText){this._amount.html(costText)},setLineItemsVisibility:function(visible){if(visible&&!this._lineItemElementsVisible){this._element.append(this._lineItemElements)}else if(!visible&&this._lineItemElementsVisible){this._lineItemElements.detach()}this._lineItemElementsVisible=visible}});Library.set("BentoBox.Modules.Paywall.InvoiceView",InvoiceView)})(Streak);(function(Streak){var _=Streak._,Date=Streak.Date,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox,Locale=BB.Locale;var superclass=UI.ViewController;var InvoiceViewController=Streak.Class.subclass({className:"InvoiceViewController",superclass:superclass,_memberVariables:[{name:"_invoice",destroy:true},{name:"_lineItemViewControllers",destroy:true},{name:"_seeDetailsButton",destroy:true},{name:"_hideDetailsButton",destroy:true}],_initialize:function(invoice){superclass.prototype._initialize.call(this);this._lineItemViewControllers=[];this._invoice=invoice;this._setupHeaderRow();this._setupSeeDetailsButton();this._setupHideDetailsButton();this._setupEmailInvoiceButton();this._view.showSeeLessDetails(this._hasMultipleLineItems());this._view.setLineItemsVisibility(false)},initializeInDOM:function(){this._setupLineItems()},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.InvoiceView")},_setupLineItems:function(){var self=this;_.each(this._invoice.lines.data.slice(0,1),function(headerLineItem){self._addInvoiceLineItem(headerLineItem,{isHeader:true})});_.each(this._invoice.lines.data.slice(1),function(lineItem){self._addInvoiceLineItem(lineItem,{isHeader:false})})},_setupSeeDetailsButton:function(){if(!this._seeDetailsButton){var self=this;this._seeDetailsButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("see_details"),color:"blue",onFunction:function(){self._seeDetailsButtonPressed();BB.Tracker.track("display invoice details")}})}this._view.setSeeDetailsButton(this._seeDetailsButton)},_setupHideDetailsButton:function(){if(!this._hideDetailsButton){var self=this;this._hideDetailsButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:Locale.getString("hide_details"),color:"blue",onFunction:function(){self._hideDetailsButtonPressed()}})}},_setupEmailInvoiceButton:function(){if(!this._emailInvoiceButton&&this._invoice&&this._invoice.id){this._emailInvoiceButton=Library.getInstance("BentoBox.Widgets.EmailInvoiceButtonController",this._invoice.id)}this._view.setEmailInvoiceButton(this._emailInvoiceButton.getButton())},_seeDetailsButtonPressed:function(){this._view.setSeeDetailsButton(this._hideDetailsButton);this._view.setLineItemsVisibility(true)},_hideDetailsButtonPressed:function(){this._view.setSeeDetailsButton(this._seeDetailsButton);this._view.setLineItemsVisibility(false)},_setupHeaderRow:function(){var amount;if(this._hasMultipleLineItems()){this._view.setUsers(Locale.getString("invoice_multiple_users"));this._view.setPlan(Locale.getString("invoice_multiple_plans"));this._view.setDateRange(this.getDateRange());amount=Locale.getString('<span class="streak__actualCost"><afterDiscount></span>',{afterDiscount:this.getAmountAfterDiscount()});this._view.setCost(amount)}else{var lineItem;if(this._invoice&&this._invoice.lines&&this._invoice.lines.data&&this._invoice.lines.data.length>0){lineItem=this._invoice.lines.data[0]}else{return}this._view.setUsers(Locale.getString("invoice_users",{users:lineItem.quantity}));if(lineItem.plan&&lineItem.plan.name){var plan=lineItem.plan.name;this._view.setPlan(plan)}this._view.setDateRange(this.getDateRange());if(!this.hasDiscount()){amount=Locale.getString('<span class="streak__actualCost"><afterDiscount></span>',{afterDiscount:this.getAmountAfterDiscount()});this._view.setCost(amount)}else{var beforeDiscount=this.getAmountBeforeDiscount();var discountPercentage=this.getDiscountPercentage();var afterDiscount=this.getAmountAfterDiscount();amount=Locale.getString('<span class="streak__originalCost"><beforeDiscount></span> <span class="streak__actualCost"><afterDiscount></span> (<discountPercentage>% discount)',{beforeDiscount:beforeDiscount,discountPercentage:discountPercentage,afterDiscount:afterDiscount});this._view.setCost(amount)}}},getStartDate:function(){if(this._invoice&&this._invoice.periodStart){return new Date(this._invoice.periodStart*1e3)}return null},getEndDate:function(){if(this._invoice&&this._invoice.lines){var lastLine=_.last(this._invoice.lines.data);return Date.create(lastLine.period.end*1e3)}return null},getDateRange:function(){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");var startDate=this.getStartDate();var endDate=this.getEndDate();return InvoiceUtils.displayDateRange(startDate,endDate)},hasDiscount:function(){return this._invoice&&this._invoice.discount},getAmountBeforeDiscount:function(){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");if(this._invoice.subtotal){return InvoiceUtils.displayStripeCurrency(this._invoice.subtotal,this._invoice.currency||"usd")}return""},getAmountAfterDiscount:function(){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");if(this._invoice.total){return InvoiceUtils.displayStripeCurrency(this._invoice.total,this._invoice.currency||"usd")}return""},getDiscountPercentage:function(){if(this._invoice&&this._invoice.discount&&this._invoice.discount.coupon){return this._invoice.discount.coupon.percentOff}return null},_hasMultipleLineItems:function(){return this._invoice.lines.data.length>1},_addInvoiceLineItem:function(lineItem,options){var invoiceLineItemViewController=Library.getInstance("BentoBox.Modules.Paywall.InvoiceLineItemViewController",lineItem,options);this._lineItemViewControllers.push(invoiceLineItemViewController);this._view.addInvoiceLineItem(invoiceLineItemViewController.getView())}});Library.set("BentoBox.Modules.Paywall.InvoiceViewController",InvoiceViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var InvoiceCollectionView=Streak.Class.subclass({className:"InvoiceCollectionView",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},_setupElement:function(){this._element=$(HTML.getElement("streak__invoice_collection_view"))},addInvoice:function(invoiceView){this._element.append(invoiceView.getElement())},removeAllInvoices:function(){this._element.find(".streak__invoice").remove()}});Library.set("BentoBox.Modules.Paywall.InvoiceCollectionView",InvoiceCollectionView)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,UI=Streak.UI;var superclass=UI.ViewController;var InvoiceCollectionViewController=Streak.Class.subclass({className:"InvoiceCollectionViewController",superclass:superclass,_memberVariables:[{name:"_invoices",destroy:true},{name:"_invoiceViewControllers",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._invoices=[];this._invoiceViewControllers=[];this.refresh()},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.InvoiceCollectionView")},refresh:function(){Streak.APIRequester.get("users/me/invoices").getPromise().then(this._invoicesChanged.bind(this))},_addInvoices:function(invoices){_.each(invoices,this._addInvoice.bind(this))},_addInvoice:function(invoice){if(invoice.paid||_.all(invoice.lines.data,"paid")){var invoiceViewController=Library.getInstance("BentoBox.Modules.Paywall.InvoiceViewController",invoice);this._invoiceViewControllers.push(invoiceViewController);this._view.addInvoice(invoiceViewController.getView());invoiceViewController.initializeInDOM()}},_invoicesChanged:function(invoices){this._invoices=invoices;this._removeAllInvoices();this._addInvoices(invoices);var invoicesPresent=invoices&&invoices.length>0;this._callDelegateFunction("invoicesPresent",invoicesPresent)},_removeAllInvoices:function(){this._view.removeAllInvoices()}});Library.set("BentoBox.Modules.Paywall.InvoiceCollectionViewController",InvoiceCollectionViewController)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var InvoiceLineItemView=Streak.Class.subclass({className:"InvoiceLineItemView",superclass:superclass,_memberVariables:[{name:"_amount",destroy:true},{name:"_users",destroy:true},{name:"_description",destroy:true},{name:"_dateRange",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._amount=this._element.find(".streak__invoice_amount");this._users=this._element.find(".streak__invoice_users");this._description=this._element.find(".streak__invoice_description");this._dateRange=this._element.find(".streak__invoice_date_range")},_setupElement:function(){this._element=$(HTML.getElement("streak__invoice_line_item_view"))},setDescription:function(descriptionText){this._description.html(descriptionText)},setDateRange:function(dateRangeText){this._dateRange.html(dateRangeText)},setAmount:function(amountText){this._amount.html(amountText)},setUsers:function(usersText){this._users.html(usersText)}});Library.set("BentoBox.Modules.Paywall.InvoiceLineItemView",InvoiceLineItemView)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,Date=Streak.Date,UI=Streak.UI,Locale=Streak.BentoBox.Locale;var superclass=UI.ViewController;var InvoiceLineItemViewController=Streak.Class.subclass({className:"InvoiceLineItemViewController",superclass:superclass,_memberVariables:[],_initialize:function(lineItem,options){superclass.prototype._initialize.call(this);options=options||{};_.defaults(options,{isHeader:true});this._lineItem=lineItem;this._view.setDescription(this.getDescription());this._view.setDateRange(this.getDateRange());this._view.setAmount(Locale.getString('<span class="streak__actualCost"><afterDiscount></span>',{afterDiscount:this.getAmount()}));var users=this.getUsers();if(users){this._view.setUsers(Locale.getString("invoice_users",{users:users}))}},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.Paywall.InvoiceLineItemView")},getDescription:function(){if(this._lineItem&&this._lineItem.description){return this._lineItem.description}else if(this._lineItem&&this._lineItem.quantity&&this._lineItem.plan){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");var amount=InvoiceUtils.displayStripeCurrency(this._lineItem.plan.amount,this._lineItem.plan.currency||"usd");var description=Locale.getString("subscription_to_plan_description",{users:this._lineItem.quantity,plan:this._lineItem.plan.name,amount:amount});return description}return""},getStartDate:function(){if(this._lineItem&&this._lineItem.period&&this._lineItem.period.start){return new Date(this._lineItem.period.start*1e3)}return null},getEndDate:function(){if(this._lineItem&&this._lineItem.period&&this._lineItem.period.end){return new Date(this._lineItem.period.end*1e3)}return null},getDateRange:function(){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");var startDate=this.getStartDate();var endDate=this.getEndDate();return InvoiceUtils.displayDateRange(startDate,endDate)},getAmount:function(){var InvoiceUtils=Library.get("BentoBox.Modules.Paywall.InvoiceUtils");if(this._lineItem.amount){return InvoiceUtils.displayStripeCurrency(this._lineItem.amount,this._lineItem.currency||"usd")}return""},getUsers:function(){if(!this.isHeader){return""}else if(this._lineItem.quantity){return this._lineItem.quantity}return""}});Library.set("BentoBox.Modules.Paywall.InvoiceLineItemViewController",InvoiceLineItemViewController)})(Streak);(function(Streak){var Library=Streak.Library,BB=Streak.BentoBox;var InvoiceUtils={displayStripeCurrency:function(amount,currency){if(currency!=="usd"){BB.logError("Currency from Stripe was not in USD");return amount+" "+currency}var cents=amount;var dollars=cents/100;return"$"+dollars},displayDateRange:function(startDate,endDate){if(startDate)startDate=startDate.customFormat("shortDate");if(endDate)endDate=endDate.customFormat("shortDate");if(startDate&&endDate){return startDate+" - "+endDate}else if(startDate&&!endDate){return startDate+" - "}else if(!startDate&&endDate){return" - "+endDate}else if(!startDate&&!endDate){return""}}};BB.Modules.Paywall=BB.Modules.Paywall||{};BB.Modules.Paywall.InvoiceUtils=InvoiceUtils;Library.set("BentoBox.Modules.Paywall.InvoiceUtils",InvoiceUtils)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Library.get("Operations.AjaxRequestOperation");var EmailInvoiceOperation=Streak.Class.subclass({className:"EmailInvoiceOperation",superclass:superclass,_memberVariables:[],_initialize:function(parameters){superclass.prototype._initialize.call(this,{url:"users/me/invoices/"+parameters.invoiceId+"/email",method:"POST",params:{json:""},tags:["emailInvoice"],dependentTags:[]})}});Library.set("BentoBox.Modules.Paywall.EmailInvoiceOperation",EmailInvoiceOperation)})(Streak);(function(Streak){var BB=Streak.BentoBox,HTML=Streak.HTML,Reports=Streak.BentoBox.Modules.Reports,UI=Streak.UI;var superclass=UI.View;Reports.DealSizeSelectionMenuView=Streak.Class.subclass({className:"DealSizeSelectionMenuView",superclass:superclass,memberVariables:[{name:"_dropdown",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._dropdown=this._element.find(".streak__reports_deal_size_dropdown")},_setupElement:function(){this._element=HTML.getElement("streak__reports_deal_size_selection_menu")},setDropdown:function(view){var element=view.getElement();element.addClass("streak__reports_deal_size_dropdown");this._dropdown.html(element)}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,UI=Streak.UI,HTML=Streak.HTML,Reports=Streak.BentoBox.Modules.Reports,Tracker=Streak.BentoBox.Tracker;var superclass=UI.ViewController;Reports.DealSizeSelectionMenuViewController=Streak.Class.subclass({className:"DealSizeSelectionMenuViewController",superclass:superclass,memberVariables:[{name:"_confirmButton",destroy:false},{name:"_columns",destroy:false},{name:"_dealSizeColumnMenu",destroy:false},{name:"_dataSource",destroy:false},{name:"_trackingContext",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupTrackingContext()},_setupView:function(){this._view=new Reports.DealSizeSelectionMenuView},setColumns:function(columns){this._columns=[this.getDefaultColumn()].concat(_.map(columns,function(column){return{name:column.name,value:column}}));this._setupDealSizeColumn()},getDefaultColumn:function(){return{name:"No Column",value:null}},_setupDealSizeColumn:function(){var self=this;this._dealSizeColumnMenu=BB.Widgets.ButtonCustomDropdown.create({trackingContext:_.clone(this._trackingContext),list:this._columns,changeFunc:function(menuItem){self.dealSizeColumnChanged(menuItem.value);Tracker.trackStreakActive(self._trackingContext,{eventName:"dealSizeColumnMenuChanged"})},comparisonFunction:function(listItemValue,potentialSelectedItemValue){if(_.isNotReal(listItemValue)){return _.isNotReal(potentialSelectedItemValue)}if(_.isNotReal(potentialSelectedItemValue)){return false}return listItemValue.value.columnKey===potentialSelectedItemValue.value.columnKey},hasButtonToRight:true});this._view.setDropdown(this._dealSizeColumnMenu)},setDataSource:function(dataSource){this._dataSource=dataSource},save:function(){this._callDelegateFunction("confirmButtonPressed")},dealSizeColumnChanged:function(dealSizeColumn){this._callDelegateFunction("dealSizeColumnChanged",dealSizeColumn)},setSelectedDealSizeColumn:function(dealSizeColumn){this._dealSizeColumnMenu.setSelected(dealSizeColumn)},getSelectedDealSizeColumn:function(){return this._dealSizeColumnMenu.getSelected()},_setupTrackingContext:function(){this._trackingContext={widgetContext:"reportCard"}}})})(Streak);(function(Streak){var $=Streak.$,BB=Streak.BentoBox,HTML=Streak.HTML,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports,UI=Streak.UI;var superclass=Reports.ReportCards.ReportCardView;Reports.ReportCards.DealSizeBasedReportCardView=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_bottomView",destroy:false},{name:"_topView",destroy:false},{name:"_transparent",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._topView=this._element.find(".streak__reports_top_view");this._bottomView=this._element.find(".streak__reports_bottom_view")},_setupElement:function(){this._reportCard=HTML.getElement("streak__reportCard");this._element=HTML.getElement("streak_dealSizeBasedReportCard");this._element.find(".streak__reports_bottom_view").append(this._reportCard);this._element.find("* .streak__reportCard").removeClass("streak__reportCard")},hideTopView:function(){this._topView.hide();this._bottomView.fadeTo("fast",1)},showTopView:function(){this._topView.show();this._bottomView.fadeTo("fast",.2)},setTopView:function(view){this._topView.html(view.getElement())}})})(Streak);(function(Streak){var _=Streak._,UI=Streak.UI,Locale=Streak.Locale,BB=Streak.BentoBox,Tracker=Streak.BentoBox.Tracker,Reports=Streak.BentoBox.Modules.Reports,NotificationCenter=Streak.NotificationCenter;var superclass=Reports.ReportCardViewController;Reports.ReportCards.DealSizeBasedReportCardViewController=Streak.Class.subclass({superclass:superclass,memberVariables:[{name:"_configureWarning",destroy:true},{name:"_dealSizeColumnKey",destroy:false},{name:"_dealSizeSelectionMenuViewController",destroy:true},{name:"_mainBodyViewController",destroy:true},{name:"_pipelineSettingListenUnbinder",destroy:true},{name:"_possibleDealsizeColumns",destroy:false},{name:"_reportRealBodyView",destroy:false},{name:"_yellowConfigureBarViewController",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupValueColumnSelection();this._setupConfigureWarning();this._view.setTitle(this.getTitle());this.showDealSizeSelectionView();this._setupXButton()},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._possibleDealsizeColumns=Reports.Utils.possibleDealsizeColumns(this._pipeline,BB.UI.getPipelineColumnList(this._pipeline,null,true));this._dealSizeSelectionMenuViewController.setColumns(this._possibleDealsizeColumns);NotificationCenter.unsubscribe({observer:this});NotificationCenter.subscribe({eventName:"pipelineReportSettings.changed",filterParameters:{pipelineKey:pipeline.key()},functionToCall:this.pipelineSettingsUpdated,observer:this});this.pipelineSettingsUpdated()},destroy:function(){superclass.prototype._initialize.call(this);if(this._pipelineSettingListenUnbinder){this._pipelineSettingListenUnbinder()}},_setupView:function(){this._view=new Reports.ReportCards.DealSizeBasedReportCardView},_setupValueColumnSelection:function(){this._dealSizeSelectionMenuViewController=new Reports.DealSizeSelectionMenuViewController;this._dealSizeSelectionMenuViewController.addDelegate(this)},_setupConfigureWarning:function(){this._yellowConfigureBarViewController=new Reports.YellowConfigureBarViewController;this._yellowConfigureBarViewController.setConfigureViewController(this._dealSizeSelectionMenuViewController);this._view.setTopView(this._yellowConfigureBarViewController.getView())},showMainView:function(){this._view.hideTopView();this._view.hideMessage();this._view.showMenus()},showDealSizeSelectionView:function(){this._view.showTopView();this._view.hideMessage();this._view.hideMenus()},_setupXButton:function(){if(!this._xButton){this._xButton=this._createXButton();this._view.addMenu({view:this._xButton,position:1})}},_createXButton:function(){var self=this;var xbutton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:"X",onFunction:function(){self.xButtonPressed()}});return xbutton},setGlobalDealSizeColumnKey:function(columnKey){if(this._pipeline){this._pipeline.setUISettings("reporting/dealSizeColumn",columnKey)}},getGlobalDealSizeColumnKey:function(){if(this._pipeline){return this._pipeline.getUISettingsByPath("reporting/dealSizeColumn")}},confirmButtonPressed:function(){this.setGlobalDealSizeColumnKey(this._dealSizeColumnKey);this._inColumnSelectionMenu=this._dealSizeColumnKey===null;this.updateMode()},dealSizeColumnChanged:function(dealSizeColumn){this._dealSizeColumnKey=dealSizeColumn?dealSizeColumn.value.columnKey:null},xButtonPressed:function(){if(this._pipeline){this._pipeline.setUISettings("reporting/dealSizeColumn",null)}},updateMode:function(){if(this._inColumnSelectionMenu){this.showDealSizeSelectionView()}else{if(this._dealSizeColumnKey===null){}else{this.showMainView()}}},pipelineSettingsUpdated:function(){var dealSizeColumnKey=this.getGlobalDealSizeColumnKey();var selectedColumn;if(dealSizeColumnKey){selectedColumn=this._allColumns[dealSizeColumnKey]}else{selectedColumn=Reports.Utils.guessDealsizeColumn(this._possibleDealsizeColumns);if(!selectedColumn&&this._possibleDealsizeColumns.length>0){selectedColumn=this._possibleDealsizeColumns[0]}}this._dealSizeSelectionMenuViewController.setSelectedDealSizeColumn(selectedColumn);var selectedDropdownColumn=this._dealSizeSelectionMenuViewController.getSelectedDealSizeColumn();this._dealSizeColumnKey=selectedDropdownColumn.value?selectedDropdownColumn.value.value.columnKey:null;this._inColumnSelectionMenu=!dealSizeColumnKey;this.updateMode()}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports,Tracker=Streak.BentoBox.Tracker,UI=Streak.UI;var superclass=Reports.ReportCards.DealSizeBasedReportCardViewController;Reports.ReportCards.TotalValueByPersonReportCardViewController=Streak.Class.subclass({className:"TotalValueByPersonReportCardViewController",superclass:superclass,memberVariables:[{name:"_totalMoney",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupFakeData();this._configureChartView()},_configureChartView:function(){var chartViewController=new UI.ChartViewController;var chartView=UI.ChartFactory.createChart({type:"RING_CHART",height:300,chartArea:{width:"70%",height:"90%"},pieSliceText:"value",sliceVisibilityThreshold:1/72,pieHole:.5});this._chartView=chartView;chartViewController.setView(chartView);chartViewController.setDataSource(this);this.setBodyChartViewController(chartViewController);this._view.setBody(chartView)},getTitle:function(){return Locale.getString("report_title_total_value_by_person")},getChartData:function(){if(this._pipeline&&this.getGlobalDealSizeColumnKey()!==null){return this._data}else{return this._fakeData}},_updateChartData:function(){var dealSizeColumn=this._columns[this.getGlobalDealSizeColumnKey()];var data=[this._getHeaders()];if(!dealSizeColumn){return data}var boxes=Data.getPipelineBoxes(this._pipeline.key());var assignedToColumn=this._columns[Reports.Utils.getAssignedToColumnKeyForPipeline(this._pipeline)];var pipeline=this._pipeline;var selectedStageKeys=this.getSelectedStageKeys();if(selectedStageKeys){boxes=_.filter(boxes,function(box){var stageKey=box.get("stageKey");return _.contains(selectedStageKeys,stageKey)})}var grouped=Reports.Utils.sumWithSplitCredit(boxes,{valueBy:function(box){return Reports.Utils.unformatCurrency(Reports.Utils.getBoxValueForColumn({box:box,column:dealSizeColumn,pipeline:pipeline}))||0},groupBy:function(box){return Reports.Utils.getBoxValueForColumn({box:box,column:assignedToColumn,pipeline:pipeline})}});_.each(grouped,function(value,key){var displayName=Reports.Utils.getBoxValueDisplayText({column:dealSizeColumn,key:key,pipeline:pipeline});if(displayName==="No Value"){displayName="Not Assigned"}data.push([displayName,value])});var total=_.chain(boxes).map(function(box){return Reports.Utils.unformatCurrency(Reports.Utils.getBoxValueForColumn({box:box,column:dealSizeColumn,pipeline:pipeline}))||0}).value().sum();this.setTotalMoney(total);data=google.visualization.arrayToDataTable(data);var formatter=new google.visualization.NumberFormat({prefix:"$",negativeColor:"red",negativeParens:true});formatter.format(data,1);this._data=data;return this._data},_getHeaders:function(){return["Value","Value"]},setTotalMoney:function(total){this._totalMoney=total;this._chartView.setCenterLabelValue(Reports.Utils.formatCurrency(this._totalMoney));this._chartView.setCenterLabelUnit(null)},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._updateChartData();this._callDelegateFunction("handleDataUpdated")},pipelineSettingsUpdated:function(parameters){superclass.prototype.pipelineSettingsUpdated.call(this,parameters);this._updateChartData();this._callDelegateFunction("handleDataUpdated")},stageKeysSelectionChanged:function(stageKeys){superclass.prototype.stageKeysSelectionChanged.call(this,stageKeys);this._updateChartData();this._callDelegateFunction("handleDataUpdated")},_setupFakeData:function(){this._fakeData=[["",""],["Foo",1/6],["Bar",1/3],["Baz",1/2]];this._totalMoney=null},_hasStageMultipleSelectMenu:function(){return true}})})(Streak);(function(Streak){var _=Streak._,BB=Streak.BentoBox,Data=Streak.BentoBox.Data,Locale=Streak.Locale,Reports=Streak.BentoBox.Modules.Reports,Tracker=Streak.BentoBox.Tracker,UI=Streak.UI;var superclass=Reports.ReportCards.DealSizeBasedReportCardViewController;Reports.ReportCards.TotalValueReportCardViewController=Streak.Class.subclass({className:"TotalValueReportCardViewController",superclass:superclass,memberVariables:[{name:"_chartViewController",destroy:false}],_initialize:function(){superclass.prototype._initialize.call(this);this._setupFakeData();this._setupChartViewController()},getTitle:function(){return Locale.getString("report_title_total_value")},getChartData:function(){if(this._pipeline&&this.getGlobalDealSizeColumnKey()!==null){return this._data}else{return this._fakeData}},_setupChartViewController:function(){this._chartViewController=new UI.ViewController;this._chartViewController.getView().addClass("streak__reports_total_value_report_dollar_amount");this.setBodyChartViewController(this._chartViewController);this._view.setBody(this._chartViewController.getView())},_updateChartData:function(){var dealSizeColumn=this._columns[this.getGlobalDealSizeColumnKey()];if(!dealSizeColumn){return this._fakeData}var boxes=Data.getPipelineBoxes(this._pipeline.key());var pipeline=this._pipeline;var selectedStageKeys=this.getSelectedStageKeys();if(selectedStageKeys&&_.contains(selectedStageKeys,Reports.Constants.ALL_STAGES)){}else if(selectedStageKeys){boxes=_.filter(boxes,function(box){var stageKey=box.get("stageKey");return _.contains(selectedStageKeys,stageKey)})}var total=_.chain(boxes).map(function(box){return Reports.Utils.unformatCurrency(Reports.Utils.getBoxValueForColumn({box:box,column:dealSizeColumn,pipeline:pipeline}))||0}).value().sum();this._data=total;return this._data},_updateView:function(){this._chartViewController.getView().getElement().html(Reports.Utils.formatCurrency(this.getChartData()))},_getHeaders:function(){return["Value","Value"]},setPipeline:function(pipeline){superclass.prototype.setPipeline.call(this,pipeline);this._updateChartData();this._updateView()},pipelineSettingsUpdated:function(parameters){superclass.prototype.pipelineSettingsUpdated.call(this,parameters);this._updateChartData();this._updateView()},stageKeysSelectionChanged:function(stageKeys){superclass.prototype.stageKeysSelectionChanged.call(this,stageKeys);this._updateChartData();this._updateView()},_setupFakeData:function(){this._fakeData="?"},_hasStageMultipleSelectMenu:function(){return true}})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackingTour=function(options){BB.Modules.Tours.ExtendedTour.call(this,options);this._composeWindowViewController=null;this._searchValue=null;this._shareModal=Library.getInstance("BentoBox.Modules.PixelTrackingShareModalViewController")
};PixelTrackingTour.prototype=Object.create(BB.Modules.Tours.ExtendedTour.prototype);_.extend(PixelTrackingTour.prototype,{openComposeWindow:function(callback){var self=this;Gmail.GmailComposeWindowRequester.requestNewComposeWindow(function(composeWindowViewController){self._composeWindowViewController=composeWindowViewController;callback()})},closeComposeWindow:function(){if(!this._composeWindowViewController.isDestroyed()){try{this._composeWindowViewController.close()}catch(err){}}},ensureTrackedSearchLinkVisible:function(callback){if(!Streak.$(".streak__leftNav_sentNested .streak__leftNavLink_nested").is(":visible")){Streak.$(".streak__leftNav_sentExpando").simulateRawClick()}setTimeout(function(){callback()},100)},showHasTrackingInSearch:function(callback){this._searchValue=Gmail.getSearchInput().val();Gmail.getSearchInput().val("has:tracking");callback()},restoreSearch:function(){Gmail.getSearchInput().val(this._searchValue)},showPixelTrackingShareModal:function(callbacks){this._shareModal.show(function(){callbacks.next()})},setDefaultTrackingStatusOn:function(){this._setDefaultTrackingStatus("enabled")},setDefaultTrackingStatusOff:function(){this._setDefaultTrackingStatus("disabled")},_setDefaultTrackingStatus:function(value){BB.Data.streakSettings.setSettingValue("tracking_default_on_setting",[value]);this.exit();NotificationCenter.postNotification({eventName:"defaultTrackingSettingChanged",sender:this})}});Library.set("BentoBox.Modules.Tours.PixelTrackingTour",PixelTrackingTour)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackingShareModalViewController=Streak.Class.subclass({superclass:Streak.UI.ViewController,_memberVariables:[{name:"_doneButton",destroy:false},{name:"_contactsChooserViewController",destroy:true},{name:"_emailBodyTextarea",destroy:true},{name:"_selectedContacts",destroy:false},{name:"_doneCallback",destroy:false}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.PixelTrackingShareModalView");this._setupElements()},_setupElements:function(){this._setupContactsChooser();this._setupEmailBody();this._setupModal()},_setupContactsChooser:function(){this._contactsChooserViewController=Library.getInstance("BentoBox.Widgets.ContactsChooserViewController");this._contactsChooserViewController.addDelegate(this);this._view.setContactsChooserView(this._contactsChooserViewController.getView())},_setupEmailBody:function(){this._emailBodyTextarea=Library.getInstance("BentoBox.Widgets.GmailTextareaViewController",{plainTextOnly:false});this._view.setEmailBodyView(this._emailBodyTextarea.getView());this._emailBodyTextarea.setHTML("Hey there, <br><br>I just started using Streak's awesome extension for tracking emails. It lets you know when people open the emails you send. I'm using it and you should too! <a href=\"https://www.streak.com/email-tracking-in-gmail\">Download it here.</a>")},_setupModal:function(){var self=this;this._view.setupModal(_.bind(this._sendEmails,this),_.bind(this._cancel,this))},_cancel:function(){this._doneCallback()},_sendEmails:function(){this._view.showSending();var emailPackages=this._createEmailPackages();var packageLength=emailPackages.length;var self=this;BB.Services.PixelTrackingLimiter.registerInvitesSent(this._getSelectedEmailAddresses());BB.MailHelper.sendMultipleEmails({emailPackages:emailPackages,finishedSendingCallback:function(){self._doneCallback();self.destroy()}});BB.Tracker.track("sharing pixel tracking",{numberOfEmails:packageLength});self._view.hideModalButtons();return true},_getSelectedEmailAddresses:function(){return _.pluck(this._selectedContacts,"email")},_createEmailPackages:function(){var bodyText=this._emailBodyTextarea.getHTML();return _.map(this._selectedContacts,function(contact){return{toAddresses:[contact.email],body:bodyText,subject:"Try out Streak's Email Tracking extension!"}})},selectedContactsChanged:function(selectedContacts){this._selectedContacts=selectedContacts;if(selectedContacts.length>=5){this._doneButton.enable()}else{this._doneButton.disable()}},show:function(doneCallback){this._doneCallback=doneCallback;this._doneButton=this._view.show();this._doneButton.disable();BB.Tracker.track("share pixel tracking prompt")}});Library.set("BentoBox.Modules.PixelTrackingShareModalViewController",PixelTrackingShareModalViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackingShareModalView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[{name:"_modal",destroy:true},{name:"_doneButton",destroy:false},{name:"_cancelButton",destroy:false}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("pixelTrackingShareModal");this._element.find(".streak__pixelTrackingShareModal_setup").show();this._element.find(".streak__pixelTrackingShareModal_sending").hide()},setupModal:function(confirmFunction,cancelFunction){this._modal=BB.Widgets.Modal.create({title:"Unlock Unlimited Email Tracking",inner:this._element,confirmFunc:confirmFunction,confirmText:"Unlock Unlimited",cancelFunc:cancelFunction,width:"510px"})},setContactsChooserView:function(contactsChooserView){this._element.find(".streak__pixelTrackingShareModal_chooseContacts").html(contactsChooserView.getElement())},setEmailBodyView:function(emailBodyView){this._element.find(".streak__pixelTrackingShareModal_emailBodyInput").html(emailBodyView.getElement())},show:function(){this._modal.show();return this._modal.getOkButton()},showSending:function(){this._element.find(".streak__pixelTrackingShareModal_setup").hide();this._element.find(".streak__pixelTrackingShareModal_sending").show()},hideModalButtons:function(){this._modal.getOkButton().getElement().hide();this._modal.getCancelButton().getElement().hide()}});Library.set("BentoBox.Modules.PixelTrackingShareModalView",PixelTrackingShareModalView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ContactsChooserEntryView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("contactsChooserContact")},setContent:function(imageUrl,name,tag){var suggestionElement=$(BB.Contacts.suggestionTemplate({image:imageUrl,name:name,tag:tag})).children().unwrap();this._element.find(".aclRowContent").append(suggestionElement)},setCheckbox:function(checkbox){this._element.find(".selectionCheckbox").html(checkbox)},setChecked:function(value){this._element.toggleClass("bbChecked",value)}});Library.set("BentoBox.Widgets.ContactsChooserEntryView",ContactsChooserEntryView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ContactsChooserEntryViewController=Streak.Class.subclass({superclass:Streak.UI.ViewController,_memberVariables:[{name:"_checkbox",destroy:true},{name:"_person",destroy:true,get:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.ContactsChooserEntryView");this._setupCheckbox();this._bindEvents()},_setupCheckbox:function(){this._checkbox=Gmail.widgets.getCheckbox("");this._view.setCheckbox(this._checkbox);var self=this;this._checkbox.bind("change",function(){self._view.setChecked(self.isChecked());self._callDelegateFunction("entryCheckStateChanged")})},_bindEvents:function(){var self=this;this._view.getElement().on("click",function(){self._checkbox.click()})},setChecked:function(value){this._checkbox.setChecked(value);this._view.setChecked(value)},isChecked:function(){return this._checkbox.isChecked()},setPerson:function(person){var image=person.imageUrl;var name=person.fullName||person.email;var tag=person.fullName?person.email:"&nbsp;";this._view.setContent(image,name,tag);this._person=person}});Library.set("BentoBox.Widgets.ContactsChooserEntryViewController",ContactsChooserEntryViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ContactsChooserView=Streak.Class.subclass({superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("contactsChooser")},showIndexingMessage:function(){this._element.find(".streak__contactsChooser_list").hide();this._element.find(".streak__contactsChooser_indexing").show();this._element.find(".streak__contactsChooser_noContacts").hide()},showNoContacts:function(){this._element.find(".streak__contactsChooser_list").hide();this._element.find(".streak__contactsChooser_indexing").hide();this._element.find(".streak__contactsChooser_noContacts").show()},addContactEntryView:function(contactEntryView,prepend){this._element.find(".streak__contactsChooser_list").show();this._element.find(".streak__contactsChooser_indexing").fastHide();this._element.find(".streak__contactsChooser_noContacts").fastHide();var addFunction="append";if(prepend){addFunction="prepend"}this._element.find(".streak__contactsChooser_list")[addFunction](contactEntryView.getElement())},setPersonPickerView:function(personPickerView){this._element.find(".streak__contactsChooser_input").append(personPickerView.getElement())},setAddButtonView:function(addButtonView){this._element.find(".streak__contactsChooser_input").append(addButtonView.getElement())}});Library.set("BentoBox.Widgets.ContactsChooserView",ContactsChooserView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ContactsChooserViewController=Streak.Class.subclass({superclass:Streak.UI.ViewController,_memberVariables:[{name:"_personPicker",destroy:true},{name:"_addPersonButton",destroy:true},{name:"_excludedPeople",destroy:true},{name:"_contactEntryViewControllers",destroy:true}],_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.ContactsChooserView")},_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._contactEntryViewControllers=[];this._excludedPeople=[];this._view.showIndexingMessage();this._setupPersonPicker();this._setupAddPersonButton();this._setupTopContacts()},_setupPersonPicker:function(){var self=this;this._personPicker=BB.Widgets.PersonPicker.create({selectFunc:function(person){self._renderContact(person,true);self.entryCheckStateChanged()},allowName:false});this._view.setPersonPickerView(this._personPicker)},_setupAddPersonButton:function(){var self=this;this._addPersonButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("add"),onFunction:function(){self._personPicker.selectItem()}});this._view.setAddButtonView(this._addPersonButton)},_setupTopContacts:function(){var self=this;BB.Contacts.getTopContacts(function(results){results=results||[];if(results.length===0){self._view.showNoContacts()}else{_(results).chain().filter(function(person){return person.email!==BB.getUser().get("email")&&person.fullName!==person.email}).each(function(person){self._renderContact(person,false)})}},50)},_renderContact:function(person,isChecked){var contactEntry=Library.getInstance("BentoBox.Widgets.ContactsChooserEntryViewController");contactEntry.setPerson(person);contactEntry.setChecked(isChecked);contactEntry.addDelegate(this);this._view.addContactEntryView(contactEntry.getView(),isChecked);this._contactEntryViewControllers.push(contactEntry);this._excludedPeople.push(person.email);this._updateExcludedPeople()},_updateExcludedPeople:function(){this._personPicker.setExcluded(this._excludedPeople)},entryCheckStateChanged:function(){this._callDelegateFunction("selectedContactsChanged",this.getSelectedContacts())},getSelectedContacts:function(){return _.chain(this._contactEntryViewControllers).filter(function(entry){return entry.isChecked()}).map(function(entry){return entry.getPerson()}).value()}});Library.set("BentoBox.Widgets.ContactsChooserViewController",ContactsChooserViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RapportiveSidebarMasterController=Streak.Class.subclass({className:"RapportiveSidebarMasterController",superclass:Streak.Object,_memberVariables:[{name:"_activeSidebar",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this);Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this))},_handleConversationLoaded:function(){if(!BB.Services.RapportiveStatusController.isEnabled()){return}if(this._activeSidebar){this._activeSidebar.destroy()}this._activeSidebar=Library.getInstance("BentoBox.Modules.RapportiveSidebarViewController")}});Streak.DependencyManager.addFunction({functionKey:"rapportiveSidebarMasterControllerInitialized",functionToCall:function(callback){Library.set("BentoBox.Modules.RapportiveSidebarMasterController",new RapportiveSidebarMasterController);if(callback){callback()}},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var _hideRapportiveCSSRule;var RapportiveSidebarViewController=Streak.Class.subclass({className:"RapportiveSidebarViewController",superclass:UI.ViewController,_memberVariables:[{name:"_sidebarId",destroy:true}],_initialize:function(){UI.ViewController.prototype._initialize.call(this);var view=this._view;this._sidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:"rapportive",sidebar:this,priority:2,dontShowIfOnlyTab:true,iconClass:"streak__rapportive_icon",dependentTabIdentifiers:["pixelTrackerSidebar"]})},getElement:function(){return this._view.getElement()},sidebarShown:function(){this._removeHideRapportiveCSSRule()},sidebarHidden:function(){this._addHideRapportiveCSSRule()},addedToSidebar:function(){this._addHideRapportiveCSSRule()},notAddedToSidebar:function(){this._removeHideRapportiveCSSRule()},_addHideRapportiveCSSRule:function(){if(_hideRapportiveCSSRule){return}_hideRapportiveCSSRule=Streak.CSSStyleManipulator.addRule("#rapportive-sidebar {visibility: hidden;}")},_removeHideRapportiveCSSRule:function(){if(_hideRapportiveCSSRule){_hideRapportiveCSSRule.destroy();_hideRapportiveCSSRule=null}},destroy:function(){if(_hideRapportiveCSSRule){_hideRapportiveCSSRule.destroy();_hideRapportiveCSSRule=null}BB.Modules.TabbedSidebarMaster.removeSidebar(this._sidebarId);UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.RapportiveSidebarViewController",RapportiveSidebarViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SearchableListViewController=Streak.Class.subclass({className:"SearchableListViewController",superclass:UI.ViewController,_memberVariables:[{name:"_dataSource",destroy:false,set:true},{name:"_searchViewController",destroy:true},{name:"_listViewController",destroy:true},{name:"_visibleSectionsAndRows",destroy:true},{name:"_shouldLockSelection",destroy:false,set:true},{name:"_emptyViewMessage",destroy:true,set:true,get:true},{name:"_noSearchResults",destroy:true}],_initialize:function(){UI.ViewController.prototype._initialize.call(this);this._shouldLockSelection=true;this._view.addClass("streak__searchableList");this._visibleSectionsAndRows=[];this._setupSearchController();this._setupListController();this._searchViewController.addDelegate(this._listViewController)},_setupSearchController:function(){this._searchViewController=new BB.Widgets.SearchSimpleVC;this._searchViewController.addDelegate(this);this._view.addSubView(this._searchViewController.getView())},_setupListController:function(){this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._listViewController.addDelegate(this);this.addDelegate(this._listViewController);this._view.addSubView(this._listViewController.getView())},setPlaceholder:function(placeholder){this._searchViewController.setPlaceholder(placeholder)},setDataSource:function(dataSource){this._dataSource=dataSource;this._listViewController.setDataSource(this);this.queryChange()},_setupVisibleSectionsAndRows:function(){var query=this._searchViewController.getQuery().toLowerCase();this._visibleSectionsAndRows.length=0;var numberOfSections=this._dataSource.getNumberOfSections();for(var sectionIndex=0;sectionIndex<numberOfSections;sectionIndex++){var numberOfRows=this._dataSource.getNumberOfRows(sectionIndex);var matchingRowIndexes=[];for(var rowIndex=0;rowIndex<numberOfRows;rowIndex++){var searchString=this._dataSource.getRowSearchString(sectionIndex,rowIndex);if(this._doesQueryMatchSearchString(query,searchString)){matchingRowIndexes.push(rowIndex)}}if(matchingRowIndexes.length>0){this._addVisibleSection(sectionIndex,matchingRowIndexes)}}this._noSearchResults=this._visibleSectionsAndRows.length===0;if(this._noSearchResults&&!!this._emptyViewMessage){this._addVisibleSection(0,[])}},_doesQueryMatchSearchString:function(query,searchString){return!query||searchString&&searchString.toLowerCase().indexOf(query)>-1},_addVisibleSection:function(sectionIndex,matchingRowIndexes){this._visibleSectionsAndRows.push({sectionIndex:sectionIndex,matchingRowIndexes:matchingRowIndexes})},getSearchInputViewController:function(){return this._searchViewController},numberOfSections:function(){return this._visibleSectionsAndRows.length},sectionShouldShow:function(sectionIndex){return true},numberOfRowsForSection:function(sectionIndex){if(sectionIndex<0){return 0}var visibleSectionObject=this._visibleSectionsAndRows[sectionIndex];return visibleSectionObject.matchingRowIndexes.length},infoForRow:function(sectionIndex,rowIndex){var visibleSectionObject=this._visibleSectionsAndRows[sectionIndex];var realSectionIndex=visibleSectionObject.sectionIndex;var realRowIndex=visibleSectionObject.matchingRowIndexes[rowIndex];return this._dataSource.getRowData(realSectionIndex,realRowIndex)},sectionTitle:function(sectionIndex){var visibleSectionObject=this._visibleSectionsAndRows[sectionIndex];return this._dataSource.getSectionTitle(visibleSectionObject.sectionIndex)},sectionAfterTitleIconClass:function(sectionIndex){var visibleSectionObject=this._visibleSectionsAndRows[sectionIndex];if(this._dataSource.getSectionAfterTitleIconClass){return this._dataSource.getSectionAfterTitleIconClass(visibleSectionObject.sectionIndex)}return null},doesSectionToggle:function(){return true},focus:function(){this._searchViewController.focus()},reset:function(){this._listViewController.reset()},dataUpdated:function(){this.queryChange()},rowFocused:function(rowData){this._callDelegateFunction("rowHighlighted",rowData);this._eventStream.push({eventName:"rowHighlighted",rowData:rowData})},rowPressed:function(rowData){this._callDelegateFunction("rowSelected",rowData);this._eventStream.push({eventName:"rowSelected",rowData:rowData});if(!this._shouldLockSelection){this._listViewController.reset()}},dontHighlightOnDataChange:function(){if(this._dataSource&&this._dataSource.dontHighlightOnDataChange){return this._dataSource.dontHighlightOnDataChange()}return false},queryChange:function(){this._setupVisibleSectionsAndRows();this._callDelegateFunction("dataChanged");this._eventStream.push({eventName:"dataChanged"});this._callDelegateFunction("queryChange",this._searchViewController.getQuery());this._eventStream.push({eventName:"queryChange",query:this._searchViewController.getQuery()})},keydown:function(event){this._callDelegateFunction("keydown",event);this._eventStream.push({eventName:"keydown",event:event})},isSectionFreeForm:function(sectionIndex){return!!this._emptyViewMessage&&this._noSearchResults},getSectionFreeFormElement:function(sectionIndex){return this._emptyViewMessage.clone(true)},getScrollPosition:function(){return this._listViewController.getScrollPosition()},setScrollPosition:function(scrollAmount){this._listViewController.setScrollPosition(scrollAmount)},dontHighlightOnDataChange:function(){return this._dataSource&&this._dataSource.dontHighlightOnDataChange&&this._dataSource.dontHighlightOnDataChange()},clearQuery:function(){this._searchViewController.clearQuery()},getSearchText:function(){return this._searchViewController.getQuery()},setSearchText:function(text){this._searchViewController.setQuery(text)}});Library.set("BentoBox.Widgets.SearchableListViewController",SearchableListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var NoticeView=Streak.Class.subclass({className:"NoticeView",superclass:UI.View,_memberVariables:[{name:"_innerMessage",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){UI.View.prototype._setupElement.call(this);this._element.addClass("b8 streak__notice");this._innerMessage=$(document.createElement("div"));this._innerMessage.addClass("vh");this._element.html(this._innerMessage)},setMessage:function(message){this._innerMessage[0].innerHTML=message},show:function(){Gmail.elements.body.append(this._element)},hide:function(){this._element.detach()}});Library.set("BentoBox.UI.NoticeView",NoticeView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var NoticeViewController=Streak.Class.subclass({className:"NoticeViewController",superclass:UI.ViewController,_memberVariables:[{name:"_currentlyShowing",destroy:false},{name:"_currentTimeout",destroy:false}],_initialize:function(){UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.UI.NoticeView")},show:function(message,delay){clearTimeout(this._currentTimeout);this._view.setMessage(message);this._view.show();if(delay){this._currentTimeout=setTimeout(this.hide.bind(this),delay)}},hide:function(){this._view.hide()}});Library.set("BentoBox.UI.NoticeViewController",new NoticeViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HelpModalView=Streak.Class.subclass({className:"HelpModalView",superclass:UI.View,_memberVariables:[],_initialize:function(){UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.getElement("helpModal");this._bindToElements()},_bindToElements:function(){this._bindToTopClick();this._bindToBackButton();this._bindToMinimize();this._bindToRestore();this._bindToClose()},_bindToTopClick:function(){var self=this;this._element.find(".streak__helpModal_top").on("click",function(e){if(e.target.tagName==="INPUT"||$(e.target).parents("input").length>0){return}self._callDelegateFunction("topClicked")})},toggleTopClickableClass:function(value){this._element.find(".streak__helpModal_top").toggleClass("streak__helpModal_topClickable",value)},_bindToBackButton:function(){var self=this;this._element.find(".streak__helpModal_top_backButton").on("click",function(e){self._callDelegateFunction("backButtonClicked");e.stopPropagation()})},_bindToMinimize:function(){var self=this;this._element.find(".streak__helpModal_top_buttons_minimize").on("click",function(e){self._callDelegateFunction("minimizeClicked");e.stopPropagation()})},_bindToRestore:function(){var self=this;this._element.find(".streak__helpModal_top_buttons_restore").on("click",function(e){self._callDelegateFunction("restoreClicked");e.stopPropagation()})},_bindToClose:function(){var self=this;this._element.find(".streak__helpModal_top_buttons_close").on("click",function(e){self._callDelegateFunction("closeClicked");e.stopPropagation()})},showBackButton:function(){this._element.find(".streak__helpModal_top_backButton").show()},hideBackButton:function(){this._element.find(".streak__helpModal_top_backButton").hide()},setIconClass:function(className){this._element.find("[role=streak__icon]")[0].setAttribute("class",className)},setTitleText:function(text){this._element.find(".streak__helpModal_top_main").html(text)},setTitleView:function(view){this._element.find(".streak__helpModal_top_main").html(view.getElement())},hideContent:function(){this._element.find(".streak__helpModal_content").hide()},showContent:function(){this._element.find(".streak__helpModal_content").show()},showMinimize:function(){this._element.find(".streak__helpModal_top_buttons_minimize").show()},hideMinimize:function(){this._element.find(".streak__helpModal_top_buttons_minimize").hide()},showRestore:function(){this._element.find(".streak__helpModal_top_buttons_restore").show()},hideRestore:function(){this._element.find(".streak__helpModal_top_buttons_restore").hide()},showClose:function(){this._element.find(".streak__helpModal_top_buttons_close").show()},hideClose:function(){this._element.find(".streak__helpModal_top_buttons_close").hide()},setContentHTML:function(html){this._element.find(".streak__helpModal_content").html(html)},setContentView:function(view){this._element.find(".streak__helpModal_content").html(view.getElement())},addClass:function(className){this._element.addClass(className)},removeClass:function(className){this._element.removeClass(className)},hideLowerButtonArea:function(){this._element.find(".streak__helpModal_buttonArea").hide()},showLowerButtonArea:function(){this._element.find(".streak__helpModal_buttonArea").show()},addLeftButton:function(button){this._element.find(".streak__helpModal_buttonArea_left").html(button.getElement())},addRightButton:function(button){this._element.find(".streak__helpModal_buttonArea_right").html(button.getElement())},setWidth:function(width){this._element.width(width)}});Library.set("BentoBox.Widgets.HelpModalView",HelpModalView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var HelpModalViewController=Streak.Class.subclass({className:"HelpModalViewController",superclass:UI.ViewController,_memberVariables:[{name:"_titleText",destroy:false},{name:"_titleViewController",destroy:false},{name:"_isTopClickable",destroy:false,defaultValue:true},{name:"_isMinimized",destroy:false,defaultValue:false}],_initialize:function(){UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.HelpModalView");this._view.hideBackButton();this._view.showMinimize();this._view.hideRestore();this._view.hideLowerButtonArea();this._view.toggleTopClickableClass(this._isTopClickable)},topClicked:function(){if(!this._isTopClickable){return}if(this._isMinimized){this.restoreClicked();return}this.minimizeClicked()},minimize:function(){this.minimizeClicked()},minimizeClicked:function(){if(this._isMinimized){return}this._view.hideContent();this._view.showRestore();this._view.hideMinimize();if(this._titleViewController){this._titleViewController.getView().getElement().detach()}if(this._titleText){this._view.setTitleText(this._titleText)}this._isMinimized=true;this._view.addClass("streak__helpModal_minimized");this._callDelegateFunction("minimizeClicked")},restore:function(){this.restoreClicked()},restoreClicked:function(){if(!this._isMinimized){return}this._view.showContent();this._view.hideRestore();this._view.showMinimize();this._view.removeClass("streak__helpModal_minimized");if(this._titleViewController){this._view.setTitleView(this._titleViewController.getView())}this._isMinimized=false;this._callDelegateFunction("restoreClicked")},closeClicked:function(){this._callDelegateFunction("closeClicked")},backButtonClicked:function(){this._callDelegateFunction("backButtonClicked")},showBackButton:function(){this._view.showBackButton()},hideBackButton:function(){this._view.hideBackButton()},setIconClass:function(className){this._view.setIconClass(className)},setTitleText:function(text){this._titleText=text;if(!this._titleViewController){this._view.setTitleText(text)}},setTitleViewController:function(titleViewController){this._titleViewController=titleViewController;this._view.setTitleView(titleViewController.getView())},setContentHTML:function(html){this._view.setContentHTML(html)},setContentViewController:function(contentViewController){this._view.setContentView(contentViewController.getView())},setTopClickable:function(value){this._isTopClickable=value;this._view.toggleTopClickableClass(value)},showMinimize:function(){this._view.showMinimize()},hideMinimize:function(){this._view.hideMinimize()},showClose:function(){this._view.showClose()},hideClose:function(){this._view.hideClose()},addLeftButton:function(leftButton){this._view.showLowerButtonArea();this._view.addLeftButton(leftButton)},addRightButton:function(rightButton){this._view.showLowerButtonArea();this._view.addRightButton()},setWidth:function(width){this._view.setWidth(width)}});Library.set("BentoBox.Widgets.HelpModalViewController",HelpModalViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var ARROW_HORIZONTAL_HEIGHT=15,ARROW_HORIZONTAL_WIDTH=32,ARROW_VERTICAL_HEIGHT=32,ARROW_VERTICAL_WIDTH=15;var TooltipViewController=Streak.Class.subclass({className:"TooltipViewController",superclass:UI.ViewController,_memberVariables:[{name:"_leftButton",destroy:true},{name:"_rightButton",destroy:true},{name:"_target",destroy:false},{name:"_targetSelector",destroy:false},{name:"_placement",destroy:false},{name:"_elementChecker",destroy:true}],_initialize:function(){UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.TooltipView")},setTitle:function(title){this._view.setTitle(title)},setContent:function(content){this._view.setContent(content)},setActionContent:function(content){this._view.showActionBox();this._view.setActionContent(content)},addLeftButton:function(name,callback){this._view.showActionBox();
this._leftButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:name,onFunction:callback});this._view.addLeftButton(this._leftButton)},addRightButton:function(name,callback){this._view.showActionBox();this._rightButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:name,onFunction:callback});this._view.addRightButton(this._rightButton)},removeLeftButton:function(){if(this._leftButton){this._leftButton.destroy()}if(this._rightButton){return}this._view.hideActionBox()},removeRightButton:function(){if(this._RightButton){this._RightButton.destroy()}if(this._leftButton){return}this._view.hideActionBox()},setTarget:function(selector){this._target=$(selector);this._targetSelector=selector},setPlacement:function(placement){this._placement=placement},closeClicked:function(){this._callDelegateFunction("closeClicked")},hideClose:function(){this._view.hideClose()},show:function(){this._view.hideArrow();this._view.show();if(this._target.length===0){this._target=$(this._targetSelector)}if(this._target.length===0){BB.logError("tooltip: failed to find element",null,{targetSelector:this._targetSelector});this._callDelegateFunction("elementNotFound");return}var targetBoundingBox=this._target.getBoundingBox(true);var tipBoundingBox=this._view.getElement().getBoundingBox(true);var theBoundingBoxWrapperToUse;if(this._placement){theBoundingBoxWrapperToUse=this._getPlacementBoundingBox(targetBoundingBox,tipBoundingBox)}else{theBoundingBoxWrapperToUse=this._getAutomaticPlacementBoundingBox(targetBoundingBox,tipBoundingBox)}var containedBoundingBox=this._containBoundingBox(theBoundingBoxWrapperToUse.value);this._setPositionAtBoundingBox(containedBoundingBox);this._setArrowPosition(theBoundingBoxWrapperToUse.type,containedBoundingBox,targetBoundingBox);this._startCheckingForTarget()},addArrowClass:function(className){this._view.addArrowClass(className)},_getPlacementBoundingBox:function(targetBoundingBox,tipBoundingBox){var boundingBox=this["_get"+this._placement.position.capitalize()+"PositionBoundingBox"](targetBoundingBox,tipBoundingBox);if(this._placement.top){var topOffset=0;if(this._placement.tipOffsetFromArrow&&this._placement.tipOffsetFromArrow.top){topOffset=this._placement.tipOffsetFromArrow.top}boundingBox[0].y=targetBoundingBox[0].y-tipBoundingBox.height/2+this._placement.top+topOffset;boundingBox[1].y=boundingBox[0].y+tipBoundingBox.height}if(this._placement.left){var leftOffset=0;if(this._placement.tipOffsetFromArrow&&this._placement.tipOffsetFromArrow.left){leftOffset=this._placement.tipOffsetFromArrow.left}boundingBox[0].x=targetBoundingBox[0].x-tipBoundingBox.width/2+this._placement.left+leftOffset;boundingBox[1].x=boundingBox[0].x+tipBoundingBox.width}return{type:this._placement.position,value:boundingBox}},_getAutomaticPlacementBoundingBox:function(targetBoundingBox,tipBoundingBox){var boundingBoxWrappers=[{type:"top",value:this._getTopPositionBoundingBox(targetBoundingBox,tipBoundingBox)},{type:"left",value:this._getLeftPositionBoundingBox(targetBoundingBox,tipBoundingBox)},{type:"right",value:this._getRightPositionBoundingBox(targetBoundingBox,tipBoundingBox)},{type:"bottom",value:this._getBottomPositionBoundingBox(targetBoundingBox,tipBoundingBox)}];var bestBoundingBoxWrapper=this._figureOutBestBoundingBox(boundingBoxWrappers);return bestBoundingBoxWrapper},_getTopPositionBoundingBox:function(targetBoundingBox,tipBoundingBox){var top=targetBoundingBox[0].y-tipBoundingBox.height-ARROW_HORIZONTAL_HEIGHT;var left=targetBoundingBox[0].x+targetBoundingBox.width/2-tipBoundingBox.width/2;return[{x:left,y:top},{x:left+tipBoundingBox.width,y:top+tipBoundingBox.height}]},_getRightPositionBoundingBox:function(targetBoundingBox,tipBoundingBox){var left=targetBoundingBox[1].x+ARROW_VERTICAL_WIDTH;var top=targetBoundingBox[0].y+targetBoundingBox.height/2-tipBoundingBox.height/2;return[{x:left,y:top},{x:left+tipBoundingBox.width,y:top+tipBoundingBox.height}]},_getBottomPositionBoundingBox:function(targetBoundingBox,tipBoundingBox){var top=targetBoundingBox[1].y+ARROW_HORIZONTAL_HEIGHT;var left=targetBoundingBox[0].x+targetBoundingBox.width/2-tipBoundingBox.width/2;return[{x:left,y:top},{x:left+tipBoundingBox.width,y:top+tipBoundingBox.height}]},_getLeftPositionBoundingBox:function(targetBoundingBox,tipBoundingBox){var left=targetBoundingBox[0].x-ARROW_VERTICAL_WIDTH-tipBoundingBox.width;var top=targetBoundingBox[0].y+targetBoundingBox.height/2-tipBoundingBox.height/2;return[{x:left,y:top},{x:left+tipBoundingBox.width,y:top+tipBoundingBox.height}]},_figureOutBestBoundingBox:function(boundingBoxWrappers){for(var ii=0;ii<boundingBoxWrappers.length;ii++){boundingBoxWrappers[ii].smallestDistance=this._getSmallestDistance(boundingBoxWrappers[ii])}return _.sortBy(boundingBoxWrappers,function(boundingBoxWrapper){return boundingBoxWrapper.smallestDistance}).reverse()[0]},_getSmallestDistance:function(boundingBoxWrapper){var distances=[boundingBoxWrapper.value[0].y,boundingBoxWrapper.value[0].x,document.body.clientWidth-boundingBoxWrapper.value[1].x,document.body.clientHeight-boundingBoxWrapper.value[1].y];return _.sortBy(distances,function(distance){return distance})[0]},_containBoundingBox:function(boundingBox){var boundingBoxHeight=boundingBox[1].y-boundingBox[0].y;var boundingBoxWidth=boundingBox[1].x-boundingBox[0].x;if(boundingBox[0].y<-1){boundingBox[0].y=0;boundingBox[1].y=boundingBox[0].y+boundingBoxHeight}else if(boundingBox[1].y>document.body.clientHeight){boundingBox[0].y=document.body.clientHeight-boundingBoxHeight;boundingBox[1].y=boundingBox[0].y+boundingBoxHeight}if(boundingBox[0].x<-1){boundingBox[0].x=0;boundingBox[1].x=boundingBox[0].x+boundingBoxWidth}else if(boundingBox[1].x>document.body.clientWidth){boundingBox[0].x=document.body.clientWidth-boundingBoxWidth-20;boundingBox[1].x=boundingBox[0].x+boundingBoxWidth}return boundingBox},_setPositionAtBoundingBox:function(boundingBox){this._view.setPosition({top:boundingBox[0].y,left:boundingBox[0].x})},_setArrowPosition:function(type,containedBoundingBox,targetBoundingBox){var position={};if(this._placement&&this._placement.tipOffsetFromArrow){this._setArrowPositionWithPlacement(type,containedBoundingBox);return}switch(type){case"top":position.top=containedBoundingBox[1].y;position.left=(containedBoundingBox[0].x+containedBoundingBox[1].x)/2-ARROW_HORIZONTAL_WIDTH/2;break;case"left":position.top=(containedBoundingBox[0].y+containedBoundingBox[1].y)/2-ARROW_VERTICAL_HEIGHT/2;position.left=containedBoundingBox[1].x;break;case"right":position.top=(containedBoundingBox[0].y+containedBoundingBox[1].y)/2-ARROW_VERTICAL_HEIGHT/2;position.left=containedBoundingBox[0].x-ARROW_HORIZONTAL_WIDTH/2+1;break;case"bottom":position.top=containedBoundingBox[0].y-ARROW_HORIZONTAL_HEIGHT+1;position.left=(containedBoundingBox[0].x+containedBoundingBox[1].x)/2-(ARROW_HORIZONTAL_WIDTH-2)/2;break}this._view.showArrow(type,position)},_setArrowPositionWithPlacement:function(type,containedBoundingBox){var position={};switch(type){case"top":position.top=containedBoundingBox[1].y;position.left=(containedBoundingBox[0].x+containedBoundingBox[1].x)/2-ARROW_HORIZONTAL_WIDTH/2;break;case"left":position.top=(containedBoundingBox[0].y+containedBoundingBox[1].y)/2-ARROW_VERTICAL_HEIGHT/2;position.left=containedBoundingBox[1].x;break;case"right":position.top=(containedBoundingBox[0].y+containedBoundingBox[1].y)/2-ARROW_VERTICAL_HEIGHT/2;position.left=containedBoundingBox[0].x-ARROW_VERTICAL_WIDTH;break;case"bottom":position.top=containedBoundingBox[0].y-ARROW_HORIZONTAL_HEIGHT+1;position.left=(containedBoundingBox[0].x+containedBoundingBox[1].x)/2-(ARROW_HORIZONTAL_WIDTH-2)/2;break}if(this._placement.tipOffsetFromArrow){if(this._placement.tipOffsetFromArrow.top){position.top-=this._placement.tipOffsetFromArrow.top}if(this._placement.tipOffsetFromArrow.left){position.left-=this._placement.tipOffsetFromArrow.left}}this._view.showArrow(type,position)},_startCheckingForTarget:function(){var self=this;this._elementChecker=_.repeatEvery(function(){if(self._target.isVisible()){return}self._callDelegateFunction("elementNoLongerFound");self.destroy()},500,true)}});Library.set("BentoBox.Widgets.TooltipViewController",TooltipViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TooltipView=Streak.Class.subclass({className:"TooltipView",superclass:UI.View,_memberVariables:[{name:"_tooltipArrow",destroy:true}],_initialize:function(){UI.View.prototype._initialize.call(this);this._bindToClose()},_setupElement:function(){this._element=HTML.getElement("tooltip");this._tooltipArrow=HTML.getElement("tooltip_arrow")},_bindToClose:function(){var self=this;this._element.find(".streak__tooltip_close").on("click",function(e){self._callDelegateFunction("closeClicked")})},setTitle:function(title){this._element.find(".streak__tooltip_header_title")[0].innerHTML=title},setContent:function(content){this._element.find(".streak__tooltip_main_content").html(content)},setActionContent:function(content){this._element.find(".streak__tooltip_main_actionBox_content").html(content)},hideClose:function(){this._element.find(".streak__tooltip_close").hide()},addLeftButton:function(button){this._element.find(".streak__tooltip_main_actionBox_left").html(button.getElement())},addRightButton:function(button){this._element.find(".streak__tooltip_main_actionBox_right").html(button.getElement())},showActionBox:function(){this._element.find(".streak__tooltip_main_content").addClass("streak__tooltip_main_content_withActionBox");this._element.find(".streak__tooltip_main_actionBox")[0].style.display="flex"},hideActionBox:function(){this._element.find(".streak__tooltip_main_content").removeClass("streak__tooltip_main_content_withActionBox");this._element.find(".streak__tooltip_main_actionBox")[0].style.display="none"},show:function(){Gmail.elements.body.append(this._element)},setPosition:function(positionObject){this._element.css(positionObject)},showArrow:function(type,position){Gmail.elements.body.append(this._tooltipArrow);this._tooltipArrow[0].setAttribute("class","streak__tooltip_arrow streak__tooltip_arrow_"+type);this._tooltipArrow.css(position);this._tooltipArrow.show()},hideArrow:function(){this._tooltipArrow.hide()},addArrowClass:function(className){this._tooltipArrow.addClass(className)}});Library.set("BentoBox.Widgets.TooltipView",TooltipView)})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var PaywallGatewayView=Streak.Class.subclass({className:"PaywallGatewayView",superclass:superclass,_memberVariables:[{name:"_text",destroy:true},{name:"_upgradeButton",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._text=this._element.find(".streak__paywallGateway_text");this._upgradeButton=this._element.find(".streak__paywallGateway_upgradeButton")},_setupElement:function(){this._element=$(HTML.getElement("streak__paywallGateway"))},setText:function(html){this._text.html(html)},setUpgradeButton:function(buttonDiv){this._upgradeButton.html(buttonDiv.getElement())}});Library.set("BentoBox.Widgets.PaywallGatewayView",PaywallGatewayView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,UI=Streak.UI,BB=Streak.BentoBox;var superclass=UI.ViewController;var PaywallGatewayViewController=Streak.Class.subclass({className:"PaywallGatewayViewController",superclass:superclass,_memberVariables:[{name:"_onUpgradeClick",destroy:true},{name:"_modal",destroy:true},{name:"_options",destroy:true}],_initialize:function(options){this._options=_.defaults(options||{},{text:BB.Locale.getString("paywall_gateway_default_text"),title:BB.Locale.getString("paywall_gateway_default_title")});superclass.prototype._initialize.call(this);this._view.setText(this._options.text);this._setupButton()},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.PaywallGatewayView")},_setupButton:function(){if(!this._upgradeButton){var self=this;this._upgradeButton=Library.getInstance("BentoBox.Widgets.PaywallUpgradeButtonViewController",{onClick:function(){self.upgradeClicked()}})}this._view.setUpgradeButton(this._upgradeButton.getView())},upgradeClicked:function(){this._modal.wasUpgradeClicked=true;this._modal.close()},show:function(parameters){parameters=_.defaults(parameters||{},{closed:$.noop});var self=this;this._modal=BB.Widgets.Modal.create({title:this._options.title,onClose:function(){parameters.closed(self._modal.wasUpgradeClicked)},inner:this._view.getElement(),showConfirm:false,showCancel:false});this._modal.show()}});Streak.DependencyManager.addFunction({functionKey:"PaywallGatewayViewControllerReady",functionToCall:function(cb){Library.set("BentoBox.Widgets.PaywallGatewayViewController",PaywallGatewayViewController);cb()},dependentFunctionKeys:["htmlLoaded","localeLoaded","userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,Library=Streak.Library,HTML=Streak.HTML,UI=Streak.UI;var superclass=UI.View;var PaywallUpgradeButtonView=Streak.Class.subclass({className:"PaywallUpgradeButtonView",superclass:superclass,_memberVariables:[{name:"_upgradeDiv",destroy:true},{name:"_contactBillingAdmin",destroy:true},{name:"_loading",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this);this._contactBillingAdmin=this._element.find(".streak__contactBillingAdmin");this._upgradeDiv=this._element.find(".streak__upgradeButton");this._loading=this._element.find(".streak__paywall_upgrade_button_loading");this._upgradeDiv.hide();this._contactBillingAdmin.hide()},_setupElement:function(){this._element=$(HTML.getElement("paywallUpgradeButton"))},setUpgradeButton:function(button){this._upgradeDiv.html(button.getElement())},showUpgradeButton:function(show){if(show){this._upgradeDiv.show().css("display","");this._contactBillingAdmin.hide()}else{this._contactBillingAdmin.show().css("display","");this._upgradeDiv.hide()}this._loading.hide()}});Library.set("BentoBox.Widgets.PaywallUpgradeButtonView",PaywallUpgradeButtonView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,BB=Streak.BentoBox;var superclass=Streak.UI.ViewController;var PaywallUpgradeButtonViewController=Streak.Class.subclass({className:"PaywallUpgradeButtonViewController",superclass:superclass,_memberVariables:[{name:"_options",destroy:false},{name:"_participatingPlans",destroy:false},{name:"_billingAdminPlanInstances",destroy:false},{name:"_billingAdminPlanInstance",destroy:false}],_initialize:function(options){this._options=_.defaults(options,{onClick:$.noop});superclass.prototype._initialize.call(this);this._setupButton();this._loadPlanInformation()},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.PaywallUpgradeButtonView")},_setupButton:function(){if(!this._upgradeButton){var self=this;this._upgradeButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:BB.Locale.getString("paywall_upgrade_button"),onFunction:function(){self.buttonClicked();self._options.onClick()}});this._upgradeButton.addClass("streak__bigButton")}this._view.setUpgradeButton(this._upgradeButton)},_loadPlanInformation:function(){this._participatingPlans=BB.Data.getParticipatingPlans();this._billingAdminPlanInstances=BB.Data.getBillingPlanInstances();if(!this._participatingPlans.getHasLoaded())this._participatingPlans.refresh(this._setupPlanInformation.bind(this));if(!this._billingAdminPlanInstances.getHasLoaded())this._billingAdminPlanInstances.refresh(this._setupPlanInformation.bind(this));if(this._participatingPlans.getHasLoaded()&&this._billingAdminPlanInstances.getHasLoaded()){this._setupPlanInformation();return}},_setupPlanInformation:function(){if(!this._participatingPlans.getHasLoaded())return;if(!this._billingAdminPlanInstances.getHasLoaded())return;this._billingAdminPlanInstance=_.filter(this._billingAdminPlanInstances,function(planInstance){return planInstance.isActive()})[0];if(this._billingAdminPlanInstance){this._view.showUpgradeButton(true)}else{if(this._participatingPlans.length>0){this._view.showUpgradeButton(false)}else{this._view.showUpgradeButton(true)}}},buttonClicked:function(){if(this._billingAdminPlanInstance){BB.UI.setURL(Gmail.Constants.Paywall+"/"+this._billingAdminPlanInstance.get("key")+"/"+"plan")}else{BB.UI.setURL(Gmail.Constants.Paywall)}}});Library.set("BentoBox.Widgets.PaywallUpgradeButtonViewController",PaywallUpgradeButtonViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailTooltip=Streak.Class.subclass({className:"GmailTooltip",superclass:Streak.Object,_memberVariables:[{name:"_options",destroy:false},{name:"_tooltipViewController",destroy:true}],_initialize:function(){Streak.Object.prototype._initialize.call(this)},setup:function(options){this._options=options;this._tooltipViewController=Library.getInstance("BentoBox.Widgets.TooltipViewController")},show:function(){this._tooltipViewController.setTitle(this._options.title);this._tooltipViewController.setContent(this._options.body);this._tooltipViewController.setTarget(this._options.targetSelector);if(this._options.actionContent){this._tooltipViewController.setActionContent(this._options.actionContent)}if(this._options.leftButton){this._tooltipViewController.addLeftButton(this._options.leftButton.name,this._options.leftButton.function)}if(this._options.rightButton){this._tooltipViewController.addRightButton(this._options.rightButton.name,this._options.rightButton.function)}if(this._options.placement){this._tooltipViewController.setPlacement(this._options.placement)}this._tooltipViewController.addDelegate(this);this._tooltipViewController.show()},closeClicked:function(){this._options.earlyExitTourFunction("tooltip close clicked")},elementNotFound:function(){this._options.earlyExitTourFunction("tooltip element not found")},elementNoLongerFound:function(){this._options.earlyExitTourFunction("tooltip element disappeared")},getType:function(){return"GMAIL_TOOLTIP"}});Library.set("BentoBox.Widgets.Tour.GmailTooltip",GmailTooltip)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BAD_EXTENSIONS=["demimoohidhmolhbphaklnmokjhjgjlf","fmdomiplhgolgpibfdjjhgbcbkdcfkmk","gakklmehjhhdfjjgnmpkjoemjmeomnli","dheionainndbbpoacpnopgmnihkcmnkl","iffdacemhfpnchinokehhnppllonacfj","kdadialhpiikehpdeejjeiikopddkjem","mlomiejdfkolichcflejclcbmpeaniij","bmihblnpomgpjkfddepdpdafhhepdbek","hpioniioecjjbhbnnbhcifmgmoiibalo","coibnogmjcpbccgjofoiklnfpbbjbapo","gighmmpiobklfepjocnamgkkbiglidom"];var BadExtensionNotifierGlobalController=Streak.Class.subclass({className:"BadExtensionNotifierGlobalController",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);if(this._checkDisabled()){return}var self=this;Messenger.sendMessage("extensionListRequest",null,"extensionListResponse",this._checkExtensions.bind(this))},_checkDisabled:function(){return BB.LocalSettings.get("warnings/extensionConflictNoticeDisabled")},_disableCheck:function(){BB.LocalSettings.set("warnings/extensionConflictNoticeDisabled",true)},_checkExtensions:function(appsAndExtensions){var extensions=_.chain(appsAndExtensions).filter(function(appOrExtension){return!appOrExtension.isApp&&appOrExtension.mayDisable&&appOrExtension.enabled}).filter(function(extension){return BAD_EXTENSIONS.indexOf(extension.id)>-1}).pluck("name").value();if(extensions.length===0){return}this._showWarning(extensions)},_showWarning:function(extensions){var inner=$(document.createElement("div"));inner[0].innerHTML=HTML.getString("badExtensionNotifier");var ul=$(document.createElement("ul"));for(var ii=0;ii<extensions.length;ii++){ul.append("<li><b>"+extensions[ii]+"</b></li>")}inner.append(ul);var self=this;var modal=BB.Widgets.Modal.create({title:"Streak Extension Conflicts Found",inner:inner,showCancel:false,showLink:true,linkText:"Don't show me this again",linkFunc:function(){self._disableCheck();modal.close()}});modal.show()}});Streak.DependencyManager.addFunction({functionKey:"badExtensionNotifierGlobalControllerInitialized",functionReference:function(){Library.set("BentoBox.Services.BadExtensionNotifierGlobalController",new BadExtensionNotifierGlobalController)},dependentFunctionKeys:["htmlLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Gmail.GmailThreadListViewProvider;var PixelTrackerRecentViewsThreadListProvider=Streak.Class.subclass({className:"PixelTrackerRecentViewsThreadListProvider",superclass:superclass,_memberVariables:[{name:"_trackedThreads",destroy:false},{name:"_defer",destroy:true}],_initialize:function(){superclass.prototype._initialize.call(this)},getRelevantRequestParameters:function(){return{q:"label:all before:5000/01/01",view:"tl"}},start:function(pageNumber){this._defer=Streak.RSVP.defer();this._getListOfRecentlyReadTrackedThreads()},getCrapFormatThreads:function(connection,responseText){return this._defer.promise},_getListOfRecentlyReadTrackedThreads:function(){Streak.APIRequester.get("trackedthreads/recent").getPromise().then(this._handleListOfRecentlyReadTrackedThreads.bind(this),this._defer.reject.bind(this._defer))},_handleListOfRecentlyReadTrackedThreads:function(trackedThreads){this._trackedThreads=_filterTrackedThreadsWithNoViewDate(trackedThreads);this._registerTrackedThreads();var rfcMessageIds=_extractMessageIdsFromTrackedThreads(this._trackedThreads);this._defer.resolve(Gmail.GmailThreadRequester.getGmailThreadsForRFCMessageIds(rfcMessageIds).then(this._handleGmailThreads.bind(this)))},_registerTrackedThreads:function(){for(var ii=0;ii<this._trackedThreads.length;ii++){var trackedThread=this._trackedThreads[ii];BB.Services.Threads.ThreadInfoOperationManager.updateThreadStorerTrackedThreadFor(trackedThread.hexGmailThreadId,trackedThread)}},_handleGmailThreads:function(recentlyViewedThreads){BB.Services.Threads.ThreadMetaDataCreator.processCrapFormatThreads(recentlyViewedThreads);recentlyViewedThreads=this._sortGmailThreadsBasedOnTrackedThreads(recentlyViewedThreads);this._addThreadIdToSubjectSpan(recentlyViewedThreads);recentlyViewedThreads.reverse();return recentlyViewedThreads},_sortGmailThreadsBasedOnTrackedThreads:function(recentlyViewedThreads){var map={};for(var ii=0;ii<recentlyViewedThreads.length;ii++){map[recentlyViewedThreads[ii][0]]=recentlyViewedThreads[ii]}var sortedTrackedThreads=_.sortBy(this._trackedThreads,function(trackedThread){return trackedThread.newestViewDate});var sortedThreads=[];for(ii=0;ii<sortedTrackedThreads.length;ii++){var trackedThread=sortedTrackedThreads[ii];var gmailThread=map[trackedThread.hexGmailThreadId];if(gmailThread){sortedThreads.push(gmailThread)}}return sortedThreads},_addThreadIdToSubjectSpan:function(recentlyViewedThreads){for(var ii=0;ii<recentlyViewedThreads.length;ii++){recentlyViewedThreads[ii][7]=recentlyViewedThreads[ii][7].replace("<span",'<span streakthreadid="'+_.escape(recentlyViewedThreads[ii][0])+'"')}}});function _filterTrackedThreadsWithNoViewDate(trackedThreads){return _.filter(trackedThreads,function(trackedThread){return!!trackedThread.mostRecentLinkFirstViewDate&&!!trackedThread.mostRecentRfcMessageId})}function _extractMessageIdsFromTrackedThreads(trackedThreads){var rfcMessageIds=[];if(!trackedThreads){return rfcMessageIds}for(var ii=0;ii<trackedThreads.length;ii++){var trackedThread=trackedThreads[ii];if(trackedThread.mostRecentRfcMessageId){rfcMessageIds.push(trackedThread.mostRecentRfcMessageId)}}return rfcMessageIds}Library.set("BentoBox.Modules.PixelTrackerRecentViewsThreadListProvider",PixelTrackerRecentViewsThreadListProvider);Gmail.GmailThreadListViewRegister.registerProvider(PixelTrackerRecentViewsThreadListProvider)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,Locale=Streak.Locale,HTML=Streak.HTML,Data=Streak.BentoBox.Data,BB=Streak.BentoBox;var CONSTANTS={TRACKED_KEY:"label:all before:5000/01/01",URL_KEY:"label%3Aall+before%3A5000%2F01%2F01",SEARCH_URL:"label%3Aall+before%3A5000%2F01%2F01",SEARCH_REPLACEMENT:"is:recentlyviewed"};CONSTANTS.TRACKED_KEY_REGEX=new RegExp(CONSTANTS.TRACKED_KEY,"img");CONSTANTS.REPLACE_KEY_REGEX=new RegExp(CONSTANTS.SEARCH_REPLACEMENT,"img");var PixelTrackerRecentViewsSearch={CONSTANTS:CONSTANTS,_sentMailLink:null,_searchLink:null,_expando:null,init:function(){if(this._isSentMailLinkValid()){this._setupSearchLink();this._setupSearchBarOverride()}},_isSentMailLinkValid:function(){var sentMailLink=Gmail.getSentMailLink();if(!sentMailLink||sentMailLink.length===0){return false}return true},_setupSearchLink:function(){var self=this;Gmail.GmailLeftNavManipulator.addNewLink({getUrl:function(){return"search/"+CONSTANTS.SEARCH_URL},getNavRelativeLabel:function(){return"sent"},getNavRelativeLocation:function(){return"NESTED"},getNavLinkName:function(){return BB.Locale.getString("pixel_track_recent_views_link")},shouldPrepend:true})},_setupSearchBarOverride:function(){var self=this;Gmail.GmailSearchBarContentReplacer.addManipulation({applyDisplayManipulation:function(searchText){return searchText.replace(CONSTANTS.TRACKED_KEY_REGEX,CONSTANTS.SEARCH_REPLACEMENT)},applyValueManipulation:function(searchText){return searchText.replace(CONSTANTS.REPLACE_KEY_REGEX,'"'+CONSTANTS.TRACKED_KEY+'"')}})},_doesURLHaveTrackingSearch:function(){return location.hash.indexOf(CONSTANTS.URL_KEY)>-1}};Streak.DependencyManager.addFunction({functionKey:"pixelTrackerRecentViewsSearchInitialized",functionReference:PixelTrackerRecentViewsSearch.init,functionContext:PixelTrackerRecentViewsSearch,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","enabledFeaturesControllerInitialized","pixelTrackerSearchInitialized","threadInfoOperationManagerInitialized"]});BB.Modules.PixelTrackerRecentViewsSearch=PixelTrackerRecentViewsSearch;var track=function(event,props){BB.Tracker.trackStreakActive(props,{eventName:event})}})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackerRecentViewsInboxRowManipulationSource=Streak.Class.subclass({className:"PixelTrackerRecentViewsInboxRowManipulationSource",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this)},getTableManipulation:function(){if(!BB.Modules.PixelTrackerUtils.isRecentViewsResultsPage()){return}if(Gmail.isVerticalSplitPreviewPane()){return}return{type:"COLUMN_WIDTH",columnName:"DATE",width:125}},getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(!BB.Modules.PixelTrackerUtils.isRecentViewsResultsPage()){return}var trackedThread=BB.Services.Threads.ThreadStorer.getTrackedThread(hexGmailThreadId);if(!trackedThread){return}var rowManipulation=Library.getInstance("BentoBox.Modules.PixelTrackerRecentViewsInboxRowManipulation");rowManipulation.setTrackedThread(trackedThread);return rowManipulation}});Streak.DependencyManager.addFunction({functionKey:"pixelTrackerRecentViewsInboxRowManipulationSourceInitialized",functionReference:function(){var source=new PixelTrackerRecentViewsInboxRowManipulationSource;Library.set("BentoBox.Modules.PixelTrackerRecentViewsInboxRowManipulationSource",source);Gmail.InboxManipulator.addDataSource(source)},dependentFunctionKeys:["inboxManipulatorInitialized","threadsInitialized","htmlLoaded","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PixelTrackerRecentViewsInboxRowManipulation=Streak.Class.subclass({className:"PixelTrackerRecentViewsInboxRowManipulation",superclass:Gmail.InboxManipulator.InboxRowManipulationBase,_memberVariables:[{name:"_trackedThread",destroy:false,set:true},{name:"_element",destroy:true},{name:"_originalDate",destroy:false}],_initialize:function(){Gmail.InboxManipulator.InboxRowManipulationBase.prototype._initialize.call(this)},setThreadDOMRow:function(threadDOMRow){this._threadDOMRow=threadDOMRow;this._originalDate=threadDOMRow.date.html()},getManipulationType:function(){return"REPLACE_CONTENT"},getColumnName:function(){return"DATE"},getElement:function(){if(this._element){return this._element}this._element=$(document.createElement("span"));var inner;var momentDate=Streak.moment(this._trackedThread.newestViewDate);var dateString=momentDate.fromNow();inner='<span class="streak__pixelTrackerRecentViews_readDate" title="'+momentDate.format()+'">'+dateString+"</span>";if(this._threadDOMRow.isUnread){inner="<b>"+inner+"</b>"}this._element[0].innerHTML=inner;return this._element}});Library.set("BentoBox.Modules.PixelTrackerRecentViewsInboxRowManipulation",PixelTrackerRecentViewsInboxRowManipulation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SchedulerView=Streak.Class.subclass({className:"SchedulerView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.get("scheduler",true)},setTitleText:function(text){this._element.find(".streak__scheduler_title").text(text)},setDateInputView:function(view){this._element.find(".streak__scheduler_dateInputWrapper").html(view.getElement())},addFrequentlyUsedTime:function(timeText,callback){var listElement=$(document.createElement("li"));listElement.text(timeText);listElement.click(callback);this._element.find(".streak__scheduler_frequentlyUsed_list").append(listElement)},setConfirmTimeLabelText:function(text){this._element.find(".streak__scheduler_confirmTime strong").text(text+":")},setConfirmTimeStringText:function(text){this._element.find(".streak__scheduler_confirmTimeString").text(text)},addActionButton:function(button){this._element.find(".streak__scheduler_buttons").append(button.getElement())},setHintText:function(text){this._element.find(".streak__scheduler_hint").text(text)},insertElementBeforeConfirmTime:function(htmlContents){var wrapper=$(document.createElement("div"));wrapper.addClass("streak__scheduler_addedSection");wrapper.append(htmlContents);this._element.find(".streak__scheduler_confirmTime").before(wrapper)}});Library.set("BentoBox.Widgets.SchedulerView",SchedulerView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SchedulerViewController=Streak.Class.subclass({className:"SchedulerViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_model",destroy:false,set:true},{name:"_dateProperty",destroy:false,set:true},{name:"_dateInputViewController",destroy:true},{name:"_confirmButton",destroy:true},{name:"_cancelButton",destroy:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);
this._setupDateInput();this._setupFrequentlyUsedTimes();this._setupButtons()},_setupView:function(){this._view=new BB.Widgets.SchedulerView},focus:function(){this._dateInputViewController.focus()},setTitleText:function(text){this._view.setTitleText(text);return this},insertElementBeforeConfirmTime:function(element){this._view.insertElementBeforeConfirmTime(element);return this},setConfirmTimeLabelText:function(text){this._view.setConfirmTimeLabelText(text);return this},setConfirmCallback:function(callback){this._confirmButton.setOnFunction(callback);return this},setCancelCallback:function(callback){this._cancelButton.setOnFunction(callback);return this},setConfirmText:function(text){this._confirmButton.setText(text);return this},setHintText:function(text){this._view.setHintText(text);return this},setCancelText:function(text){this._cancelButton.setText(text);return this},showCancelButton:function(){this._cancelButton.getElement().fastShow("inline-block");return this},hideCancelButton:function(){this._cancelButton.getElement().hide();return this},setModel:function(model){this._model=model;this._updateView();this._updateDateInput();return this},setDateProperty:function(dateProperty){this._dateProperty=dateProperty;this._updateView();this._updateDateInput();return this},disable:function(){this._confirmButton.disable();this._cancelButton.disable()},enable:function(){this._confirmButton.enable();this._cancelButton.enable()},_setupDateInput:function(){this._dateInputViewController=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true});this._view.setDateInputView(this._dateInputViewController.getView());this._dateInputViewController.addDelegate({keydown:this._dateInputKeydown.bind(this),keyup:this._dateInputKeyUp.bind(this)});this._dateInputViewController.setTabIndex(1)},_dateInputKeydown:function(event){if(Streak.jwerty.is("enter",event)){event.preventDefault();this._confirmButton.on()}},_dateInputKeyUp:function(event){if(Streak.jwerty.is("enter",event)){return}var date=this._dateInputViewController.getText();var dateObject=Streak.Date.create(date);if(dateObject.isValid()){this._model.set(this._dateProperty,dateObject.getTime())}this._updateView(dateObject)},_setupFrequentlyUsedTimes:function(){var times=[{text:BB.Locale.getString("send_later_one_hour"),dateText:"one hour from now"},{text:BB.Locale.getString("send_later_tomorrow_8"),dateText:"tomorrow at 8am"},{text:BB.Locale.getString("send_later_monday"),dateText:"next monday at 8am"},{text:BB.Locale.getString("send_later_week"),dateText:"one week from today at 8am"},{text:BB.Locale.getString("send_later_month"),dateText:"beginning of next month at 8am"},{text:BB.Locale.getString("send_later_six"),dateText:"six months from now at 8am"}];for(var ii=0;ii<times.length;ii++){this._addFrequentyUsedTime(times[ii])}},_addFrequentyUsedTime:function(time){var self=this;this._view.addFrequentlyUsedTime(time.text,function(){BB.Tracker.track("scheduler.frequentlyUsedTimeClicked",{time:time.dateText});var dateObject=Date.create(time.dateText);self._model.set(self._dateProperty,dateObject.getTime());self._updateView();self._updateDateInput()})},_setupButtons:function(){this._setupCancelButton();this._setupConfirmButton()},_setupConfirmButton:function(){this._confirmButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"red",text:BB.Locale.getString("save"),onFunction:$.noop});this._view.addActionButton(this._confirmButton);this._confirmButton.setTabIndex(1)},_setupCancelButton:function(){this._cancelButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",text:BB.Locale.getString("cancel"),onFunction:$.noop});this._view.addActionButton(this._cancelButton);this._cancelButton.setTabIndex(1)},_updateView:function(dateObject){if(!this._model||!this._dateProperty){return}var date=this._model.get(this._dateProperty);dateObject=dateObject||Date.create(date);this._confirmButton.disable();if(!dateObject.isValid()){this._view.setConfirmTimeStringText(BB.Locale.getString("send_later_invalid_date"));return}if(dateObject.isBefore(Date.now())){this._view.setConfirmTimeStringText(BB.Locale.getString("send_later_future_date"));return}this._view.setConfirmTimeStringText(dateObject.customFormat("longWithTimezone"));this._confirmButton.enable()},_updateDateInput:function(){if(!this._model||!this._dateProperty){return}var date=this._model.get(this._dateProperty);var dateObject=Date.create(date);if(dateObject.isValid()){this._dateInputViewController.setHTML(dateObject.customFormat("long"))}else{this._dateInputViewController.setHTML("")}}});Streak.DependencyManager.addFunction({functionKey:"schedulerViewControllerInitialized",functionReference:function(){Library.set("BentoBox.Widgets.SchedulerViewController",SchedulerViewController)},dependentFunctionKeys:["htmlLoaded","localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterOnComposeMenuViewController=Streak.Class.subclass({className:"BumpLaterOnComposeMenuViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_schedulerViewController",destroy:true},{name:"_replyConditionalCheckbox",destroy:true},{name:"_bumpLaterModel",destroy:false},{name:"_bumpLaterPatch",destroy:false},{name:"_stateNotifier",destroy:false}],use:function(bumpLaterModel,stateNotifier){this._bumpLaterModel=bumpLaterModel;this._bumpLaterPatch=this._bumpLaterModel.createPatch();this._stateNotifier=stateNotifier;if(this._bumpLaterModel.get("bumpDate")){this._schedulerViewController.showCancelButton();this._schedulerViewController.setCancelText(BB.Locale.getString("cancel_bump_later"));this._schedulerViewController.setConfirmText(BB.Locale.getString("save"))}else{this._bumpLaterPatch.set("onlyBumpIfNoResponse",true);this._schedulerViewController.hideCancelButton();this._schedulerViewController.setConfirmText(BB.Locale.getString("bump_later"))}this._replyConditionalCheckbox.setChecked(!!this._bumpLaterPatch.get("onlyBumpIfNoResponse"));this._schedulerViewController.setModel(this._bumpLaterPatch)},focus:function(){this._schedulerViewController.focus()},getElement:function(){return this._view.getElement()},_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=BB.Widgets.Menu.create();this._view.getElement().addClass("streak__bumpLaterMenu");this._setupSchedulerViewController();this._setupReplyConditionalCheckbox()},_setupSchedulerViewController:function(){this._schedulerViewController=new BB.Widgets.SchedulerViewController;this._schedulerViewController.setTitleText(BB.Locale.getString("bump_later_scheduler_title")).setConfirmTimeLabelText(BB.Locale.getString("bump_later_confirm_label")).setHintText(BB.Locale.getString("bump_later_scheduler_hint")).showCancelButton().setDateProperty("bumpDate").setConfirmCallback(this._saveBumpLater.bind(this)).setCancelCallback(this._cancelBumpLater.bind(this));this._view.addSection(this._schedulerViewController.getView().getElement())},_setupReplyConditionalCheckbox:function(){this._replyConditionalCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("bump_later_reply_condition"));var self=this;var checkbox=this._replyConditionalCheckbox;this._replyConditionalCheckbox.on("change",function(){self._bumpLaterPatch.set("onlyBumpIfNoResponse",checkbox.isChecked())});this._schedulerViewController.insertElementBeforeConfirmTime(this._replyConditionalCheckbox);this._replyConditionalCheckbox[0].setAttribute("tabindex",1)},_saveBumpLater:function(){this._bumpLaterPatch.commit();if(this._bumpLaterModel.isSavedOnServer()){this._bumpLaterModel.save()}this._stateNotifier.saved();BB.Tracker.track("bumpLaterCreated",{widget:"compose"});BB.Tracker.track("bumpLaterSaved",{widget:"compose"})},_cancelBumpLater:function(){this._bumpLaterPatch.destroy();if(this._bumpLaterModel.isSavedOnServer()){this._bumpLaterModel.del()}BB.Tracker.track("bumpLaterCanceled",{widget:"compose"});this._stateNotifier.canceled()}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterOnComposeMenuViewControllerInitialized",functionReference:function(){Library.set("BentoBox.Modules.BumpLaterOnComposeMenuViewController",new BumpLaterOnComposeMenuViewController)},dependentFunctionKeys:["schedulerViewControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var CONFLICTING_MODULES=["sendLater"];var BumpLaterOnComposeButton=Streak.Class.subclass({className:"BumpLaterOnComposeButton",superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_bumpLaterModel",destroy:false},{name:"_shouldLoad",destroy:false,defaultValue:true},{name:"_isBumpLaterScheduled",destroy:false,defaultValue:false},{name:"_menuButton",destroy:true},{name:"_sending",destroy:true,defaultValue:false}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.apply(this,_.toArray(arguments))},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupBumpLaterModel();this._setupMenuButton();return this},_setupBumpLaterModel:function(){this._bumpLaterModel=new BB.Models.BumpLater},_setupMenuButton:function(){var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIcon",color:"icon",iconClass:"streak__snoozeIcon",menu:BB.Modules.BumpLaterOnComposeMenuViewController,isBottomAligned:true,isFixedPosition:true,preOnFunction:function(){BB.Modules.BumpLaterOnComposeMenuViewController.use(self._bumpLaterModel,self);BB.Tracker.track("bumpLaterMenuShown",{widget:"compose"})},postOnFunction:function(){BB.Modules.BumpLaterOnComposeMenuViewController.focus()}});this._menuButton.setTooltip(BB.Locale.getString("bump_later_compose_button_tooltip"))},saved:function(){this._menuButton.off();this._isBumpLaterScheduled=true;this._menuButton.addClass("streak__snoozeIcon_active");this._composeWindowViewController.setModuleActive("bumpLater");this._menuButton.setTooltip(BB.Locale.getString("bump_later_indicator_tooltip",{date:this._bumpLaterModel.getBumpDateObject().customFormat("pixelTrack")}))},canceled:function(){this._menuButton.off();this._bumpLaterModel.set("bumpDate",null);this._bumpLaterModel.set("onlyBumpIfNoResponse",null);this._isBumpLaterScheduled=false;this._menuButton.removeClass("streak__snoozeIcon_active");this._composeWindowViewController.setModuleInactive("bumpLater");this._menuButton.setTooltip(BB.Locale.getString("bump_later_compose_button_tooltip"))},shouldProcessModification:function(){return this._shouldLoad},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"BEFORE_FORMATTING"},getModificationPriority:function(){return 1},getModificationElement:function(){return this._menuButton.getElement()},activeModulesChanged:function(activeModules){this._menuButton.enable();if(activeModules.indexOf("sendLater")>-1){this._menuButton.disable();this._disableBumpLaterButton(BB.Locale.getString("bump_later_off_because_send_later"));return}},mailMergeActive:function(){if(!this._shouldLoad){return}this._shouldLoad=false;this._composeWindowViewController.reloadModification(this)},mailMergeCancelled:function(){if(this._shouldLoad){return}this._shouldLoad=true;this._composeWindowViewController.reloadModification(this)},composeClose:function(){if(!this._sending&&this._isBumpLaterScheduled){BB.ButterBarManager.showMessage(BB.Locale.getString("bump_later_canceled_message"))}},_disableBumpLaterButton:function(tooltip){if(tooltip){this._menuButton.setTooltip(tooltip)}},aboutToSend:function(){if(!this._isBumpLaterScheduled){return}this._sending=true;var bumpLaterModel=this._bumpLaterModel;Streak.NotificationCenter.subscribe({eventName:"rfcMessageIdForSentEmailFound",filterParameters:{composeid:this._composeWindowViewController.getComposeid()},observer:this,functionToCall:function(notification){this._createBumpLater(bumpLaterModel,notification.threadMetaData)}})},_createBumpLater:function(bumpLaterModel,threadMetaData){var threadId=threadMetaData.hexGmailThreadId;var rfcMessageId=threadMetaData.rfcMessageId;var subject=threadMetaData.subject;bumpLaterModel.set("gmailThreadId",threadId);bumpLaterModel.set("subject",subject);bumpLaterModel.set("rfcMessageId",rfcMessageId);bumpLaterModel.save();BB.Data.getAllBumpLaters().add(bumpLaterModel);Streak.NotificationCenter.postNotification({eventName:"snoozedEmailSent",sender:this})},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});BB.Modules.ComposeViewControllerBase.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.BumpLaterOnComposeButton",BumpLaterOnComposeButton);DependencyManager.addFunction({functionKey:"bumpLaterOnComposeButtonInitialized",functionReference:function(callback){Gmail.GmailComposeManager.registerModifierModule({getViewControllers:function(){return new BumpLaterOnComposeButton}})},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","gmailLoaded","userLoggedIn","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){"use strict";var $=Streak.$,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,BB=Streak.BentoBox;var BumpLaterButton=Streak.Class.subclass({className:"BumpLaterButton",superclass:Streak.Object,memberVariables:[{name:"_menuButton",destroy:true}],_initialize:function(){var self=this;Streak.Object.prototype._initialize.call(this);this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIconArrow",iconClass:"streak__snoozeIcon",text:BB.Locale.getString("bump_later"),isFixedPosition:true,menu:BB.Modules.BumpLaterOnThreadsMenuViewController,useCapture:false,preOnFunction:function(){BB.Modules.BumpLaterOnThreadsMenuViewController.use(self);BB.Tracker.track("bumpLaterMenuShown",{widget:"bumpLaterButton"})},postOnFunction:function(){BB.Modules.BumpLaterOnThreadsMenuViewController.focus()}});this._menuButton.addClass("streak__bumpLaterButton");BB.Keyboard.bindChord("w,s",function(){if(self._menuButton.getElement().is(":visible")){setTimeout(function(){self._menuButton.on()},10);BB.Tracker.track("bumpLaterMenuShown",{widget:"bumpLaterButton"})}},BB.Locale.getString("keyboard_bump_later_button_description"))},getElement:function(){return this._menuButton.getElement()},saved:function(error){this._menuButton.off();if(!error){Gmail.getArchiveButton().simulateRawClick();setTimeout(function(){BB.ButterBarManager.showMessage(BB.Locale.getString("bump_later_archive_message"),{hideOnViewChanged:false})},50)}},canceled:function(){this._menuButton.off()}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterButtonInitialized",functionReference:function(){var button=new BumpLaterButton;BB.Services.ToolbarManager.registerButton({element:button.getElement(),showFor:"threadSelection",placement:"archiveGroup",orderHint:1})},dependentFunctionKeys:["threadsInitialized","localeLoaded","gmailLoaded","userLoggedIn","bumpLaterOnThreadsMenuViewControllerInitialized","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterOnThreadsMenuViewController=Streak.Class.subclass({className:"BumpLaterOnThreadsMenuViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_schedulerViewController",destroy:true},{name:"_replyConditionalCheckbox",destroy:true},{name:"_removeMenuItem",destroy:true},{name:"_hexGmailThreadIdList",destroy:true},{name:"_bumpLaterModel",destroy:false},{name:"_bumpLaterPatch",destroy:false},{name:"_stateNotifier",destroy:false}],use:function(stateNotifier){this._stateNotifier=stateNotifier;if(this._removeMenuItem){this._removeMenuItem.remove();this._removeMenuItem=null}this._schedulerViewController.getView().getElement().show();this._hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);var bumpLaterCollectionList=BB.Services.Threads.ThreadStorer.getBumpLaterCollectionList(this._hexGmailThreadIdList);var activeBumpLaters=_(bumpLaterCollectionList).chain().compact().map(function(bumpLaterCollection){return bumpLaterCollection.getActiveBumpLater()}).compact().value();if(this._bumpLatersShouldBeRemoved(bumpLaterCollectionList,activeBumpLaters)){this._setupMenuForRemove(bumpLaterCollectionList,activeBumpLaters);return}this._setupMenuForUpdatingOrCreatingBumpLater(activeBumpLaters)},focus:function(){this._schedulerViewController.focus()},getElement:function(){return this._view.getElement()},_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=BB.Widgets.Menu.create();this._view.getElement().addClass("streak__bumpLaterMenu");this._setupSchedulerViewController();this._setupReplyConditionalCheckbox()},_setupSchedulerViewController:function(){this._schedulerViewController=new BB.Widgets.SchedulerViewController;this._schedulerViewController.setTitleText(BB.Locale.getString("bump_later_scheduler_title")).setConfirmTimeLabelText(BB.Locale.getString("bump_later_confirm_label")).setHintText(BB.Locale.getString("bump_later_scheduler_hint")).showCancelButton().setDateProperty("bumpDate").setConfirmCallback(this._scheduledConfirmed.bind(this)).setCancelCallback(this._cancelBumpLater.bind(this));this._view.addSection(this._schedulerViewController.getView().getElement())},_setupReplyConditionalCheckbox:function(){this._replyConditionalCheckbox=Gmail.widgets.getCheckbox(BB.Locale.getString("bump_later_reply_condition"));var self=this;var checkbox=this._replyConditionalCheckbox;this._replyConditionalCheckbox.on("change",function(){self._bumpLaterPatch.set("onlyBumpIfNoResponse",checkbox.isChecked())});this._schedulerViewController.insertElementBeforeConfirmTime(this._replyConditionalCheckbox);this._replyConditionalCheckbox[0].setAttribute("tabindex",1)},_bumpLatersShouldBeRemoved:function(bumpLaterCollectionList,activeBumpLaters){return bumpLaterCollectionList.length>1&&activeBumpLaters.length>0},_setupMenuForRemove:function(bumpLaterCollectionList,activeBumpLaters){this._schedulerViewController.getView().getElement().hide();var text=BB.Locale.getString(this._hexGmailThreadIdList.length===1?"cancel_bump_later":"cancel_multiple_bump_laters");var self=this;this._removeMenuItem=this._view.addItem(text,function(){Streak.Model.deleteAll(activeBumpLaters);self._stateNotifier.canceled()})},_setupMenuForUpdatingOrCreatingBumpLater:function(activeBumpLaters){if(this._hexGmailThreadIdList.length===1){if(activeBumpLaters.length===1){this._bumpLaterModel=activeBumpLaters[0]}else{this._bumpLaterModel=BB.Models.BumpLater.create()}}else{this._bumpLaterModel=BB.Models.BumpLater.create()}this._bumpLaterPatch=this._bumpLaterModel.createPatch();this._replyConditionalCheckbox.setChecked(!!this._bumpLaterPatch.get("onlyBumpIfNoResponse"));this._schedulerViewController.setModel(this._bumpLaterPatch);if(this._bumpLaterModel.isSavedOnServer()){this._schedulerViewController.showCancelButton();this._schedulerViewController.setCancelText(BB.Locale.getString("cancel_bump_later"));this._schedulerViewController.setConfirmText(BB.Locale.getString("save"))}else{this._schedulerViewController.hideCancelButton();this._schedulerViewController.setConfirmText(BB.Locale.getString("bump_later"))}},_scheduledConfirmed:function(){var self=this;this._bumpLaterPatch.commit();this._schedulerViewController.disable();if(this._bumpLaterModel.isSavedOnServer()){this._bumpLaterModel.save(function(){self._schedulerViewController.enable();self._stateNotifier.saved(false)},function(e){self._schedulerViewController.enable();self._stateNotifier.saved(true)});BB.Tracker.track("bumpLaterUpdated",{widget:"bumpLaterButton"})}if(this._hexGmailThreadIdList.length===1){this._saveBumpLater(this._bumpLaterModel,this._hexGmailThreadIdList[0]).then(function(){self._schedulerViewController.enable();self._stateNotifier.saved(false)},function(e){self._schedulerViewController.enable();self._stateNotifier.saved(true)});BB.Tracker.track("bumpLaterCreated",{widget:"bumpLaterButton",numberOfThreads:this._hexGmailThreadIdList.length})}if(this._hexGmailThreadIdList.length>1){this._createMultipleBumpLaters().then(function(){self._schedulerViewController.enable();self._stateNotifier.saved(false)},function(e){self._schedulerViewController.enable();self._stateNotifier.saved(true)});BB.Tracker.track("bumpLaterCreated",{widget:"bumpLaterButton",numberOfThreads:this._hexGmailThreadIdList.length})}BB.Tracker.track("bumpLaterSaved",{widget:"bumpLaterButton"})},_createMultipleBumpLaters:function(){var promises=[];for(var ii=0;ii<this._hexGmailThreadIdList.length;ii++){var hexGmailThreadId=this._hexGmailThreadIdList[ii];if(!hexGmailThreadId){continue}var bumpLaterModel=BB.Models.BumpLater.create();bumpLaterModel.set("bumpDate",this._bumpLaterModel.get("bumpDate"));bumpLaterModel.set("onlyBumpIfNoResponse",this._bumpLaterModel.get("onlyBumpIfNoResponse"));promises.push(this._saveBumpLater(bumpLaterModel,hexGmailThreadId))}return Streak.RSVP.all(promises)},_saveBumpLater:function(bumpLaterModel,hexGmailThreadId){return new Streak.Promise(function(resolve,reject){var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(hexGmailThreadId);bumpLaterModel.set("gmailThreadId",hexGmailThreadId);bumpLaterModel.set("subject",threadMetaData.subject);var messageIdToUse=hexGmailThreadId;if(threadMetaData.messageIds&&threadMetaData.messageIds.length>1){messageIdToUse=threadMetaData.messageIds[1]}Gmail.RFCMessageIdExtractor.getRFCMessageIdForThread(messageIdToUse,function(rfcMessageId){bumpLaterModel.set("rfcMessageId",rfcMessageId);bumpLaterModel.save(resolve,reject)});BB.Data.getAllBumpLaters().add(bumpLaterModel)})},_cancelBumpLater:function(){this._bumpLaterPatch.destroy();if(this._bumpLaterModel.isSavedOnServer()){this._bumpLaterModel.del()}this._stateNotifier.canceled();BB.Tracker.track("bumpLaterCanceled",{widget:"bumpLaterButton"});return}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterOnThreadsMenuViewControllerInitialized",functionReference:function(){Library.set("BentoBox.Modules.BumpLaterOnThreadsMenuViewController",new BumpLaterOnThreadsMenuViewController)},dependentFunctionKeys:["schedulerViewControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterIndicatorInboxRowManipulation=Streak.Class.subclass({className:"BumpLaterIndicatorInboxRowManipulation",superclass:Gmail.InboxManipulator.InboxRowManipulationBase,_memberVariables:[{name:"_bumpLaterModel",destroy:false,set:true},{name:"_threadDOMRow",destroy:false,set:true},{name:"_element",destroy:true}],_initialize:function(bumpLaterModel,threadDOMRow){Gmail.InboxManipulator.InboxRowManipulationBase.prototype._initialize.call(this);this._bumpLaterModel=bumpLaterModel;this._threadDOMRow=threadDOMRow;this._setupElement()},_setupElement:function(){if(!this._threadDOMRow||!this._threadDOMRow.starHolder){return}var tag=$("<span class='as ar streak__snoozeIcon'></span>");if(this._bumpLaterModel){tag.removeClass("streak__snoozeIcon_scheduled")}else{tag.addClass("streak__snoozeIcon_scheduled")}if(this._threadDOMRow.type==="vertical"){tag.addClass("streak__snoozeIcon_indicator_verticalPreviewPane");this._threadDOMRow.starHolder.addClass("streak__snoozeIcon_holder")}else if(this._doesRowHaveAttachment()){tag.addClass("streak__snoozeIcon_withAttachment")}if(this._bumpLaterModel){tag[0].setAttribute("data-tooltip",BB.Locale.getString("bump_later_indicator_tooltip",{date:this._bumpLaterModel.getBumpDateObject().customFormat("long")}))}if(this._threadDOMRow.attachmentsContainer){this._threadDOMRow.attachmentsContainer.addClass("streak__snoozeIcon_present")}this._element=tag},_doesRowHaveAttachment:function(){return this._threadDOMRow.attachmentsContainer.find("img").length>0||this._threadDOMRow.attachmentsContainer.find(".streak__pt_eye_indicator").length>0},getManipulationType:function(){return"PREPEND_ELEMENT"},getColumnName:function(){var columnName="ATTACHMENTS";if(this._threadDOMRow.type==="vertical"){columnName="STAR"}return columnName},getElement:function(){return this._element}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterIndicatorInboxRowManipulationInitialized",functionReference:function(){Gmail.InboxManipulator.addDataSource({getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(BB.Modules.BumpLaterThreadListSearch.isYourView()){return null}var bumpLaterCollection=BB.Services.Threads.ThreadStorer.getBumpLaterCollection(hexGmailThreadId);if(!bumpLaterCollection||bumpLaterCollection.length===0){return null}var activeBumpLater=bumpLaterCollection.getActiveBumpLater();var rowManipulation=new BumpLaterIndicatorInboxRowManipulation(activeBumpLater,threadDOMRow);return rowManipulation}})},dependentFunctionKeys:["inboxManipulatorInitialized","threadsInitialized","htmlLoaded","enabledFeaturesControllerInitialized"]});Library.set("BentoBox.Modules.BumpLaterIndicatorInboxRowManipulation",BumpLaterIndicatorInboxRowManipulation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterThreadListProvider=Streak.Class.subclass({className:"BumpLaterThreadListProvider",superclass:Gmail.GmailThreadListViewProvider,_memberVariables:[{name:"_defer",destroy:true}],_initialize:function(){Gmail.GmailThreadListViewProvider.prototype._initialize.call(this)},getRelevantRequestParameters:function(){return{q:"label:all before:5001/01/01",view:"tl"}},start:function(pageNumber){this._defer=Streak.RSVP.defer();this._refreshAllBumpLaters()},getCrapFormatThreads:function(connection,responseText){return this._defer.promise},_refreshAllBumpLaters:function(){BB.Data.getAllBumpLaters().refresh(_.bind(this._handleBumpLatersRefreshed,this))},_handleBumpLatersRefreshed:function(){var activeBumpLaters=this._getActiveBumpLaters();var rfcMessageIds=_.map(activeBumpLaters,function(bumpLater){return bumpLater.get("firstRecentRfcMessageId")});this._defer.resolve(Gmail.GmailThreadRequester.getGmailThreadsForRFCMessageIds(rfcMessageIds).then(this._handleGmailThreads.bind(this)))},_getActiveBumpLaters:function(){return _(BB.Services.Threads.ThreadStorer.getAllBumpLaterCollections()).chain().compact().map(function(bumpLaterCollection){return bumpLaterCollection.getActiveBumpLater()}).compact().value()},_handleGmailThreads:function(bumpLaterThreads){BB.Services.Threads.ThreadMetaDataCreator.processCrapFormatThreads(bumpLaterThreads);var sortedGmailThreads=this._sortGmailThreadsBasedOnBumpLaterTime(bumpLaterThreads);this._addThreadIdToSubjectSpan(sortedGmailThreads);return sortedGmailThreads},_sortGmailThreadsBasedOnBumpLaterTime:function(bumpLaterThreads){var map={};for(var ii=0;ii<bumpLaterThreads.length;ii++){map[bumpLaterThreads[ii][0]]=bumpLaterThreads[ii]}var activeBumpLaters=this._getActiveBumpLaters();var sortedActiveBumpLaters=_.sortBy(activeBumpLaters,function(bumpLater){return bumpLater.getBumpDateObject().getTime()});var sortedThreads=[];for(ii=0;ii<sortedActiveBumpLaters.length;ii++){var hexGmailThreadId=sortedActiveBumpLaters[ii].get("gmailThreadId");var gmailThread=map[hexGmailThreadId];if(gmailThread){sortedThreads.push(gmailThread)}}return sortedThreads},_addThreadIdToSubjectSpan:function(gmailThreads){for(var ii=0;ii<gmailThreads.length;ii++){gmailThreads[ii][7]=gmailThreads[ii][7].replace("<span",'<span streakthreadid="'+_.escape(gmailThreads[ii][0])+'"')}}});Library.set("BentoBox.Modules.BumpLaterThreadListProvider",BumpLaterThreadListProvider);Streak.DependencyManager.addFunction({functionKey:"bumpLaterThreadListProviderInitialized",functionReference:function(){Gmail.GmailThreadListViewRegister.registerProvider(BumpLaterThreadListProvider)},dependentFunctionKeys:["userLoggedIn","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,Locale=Streak.Locale,HTML=Streak.HTML,Data=Streak.BentoBox.Data,BB=Streak.BentoBox;var CONSTANTS={BUMP_LATER_KEY:"label:all before:5001/01/01",URL_KEY:"label%3Aall+before%3A5001%2F01%2F01",SEARCH_URL:"label%3Aall+before%3A5001%2F01%2F01",SEARCH_REPLACEMENT:"is:snoozed"};CONSTANTS.BUMP_LATER_KEY_REGEX=new RegExp(CONSTANTS.BUMP_LATER_KEY,"img");CONSTANTS.REPLACE_KEY_REGEX=new RegExp(CONSTANTS.SEARCH_REPLACEMENT,"img");var BumpLaterThreadListSearch={CONSTANTS:CONSTANTS,_sentMailLink:null,_searchLink:null,_expando:null,init:function(){if(this._isSentMailLinkValid()){this._setupSearchLink();this._setupSearchBarOverride()}},isYourView:function(){return location.hash==="#search/label%3Aall+before%3A5001%2F01%2F01"&&Gmail.getMainList()&&(Gmail.getMainList().find("[streakthreadid]").length>0||Gmail.getMainList().find("[streakhiderow]").length>0)},_isSentMailLinkValid:function(){var sentMailLink=Gmail.getSentMailLink();if(!sentMailLink||sentMailLink.length===0){return false}return true},_setupSearchLink:function(){var self=this;Gmail.GmailLeftNavManipulator.addNewLink({getUrl:function(){return"search/"+CONSTANTS.SEARCH_URL},getNavRelativeLabel:function(){return"sent"},getNavRelativeLocation:function(){return"BEFORE"},getNavLinkName:function(){return BB.Locale.getString("bump_later_link")}})},_setupSearchBarOverride:function(){var self=this;Gmail.GmailSearchBarContentReplacer.addManipulation({applyDisplayManipulation:function(searchText){return searchText.replace(CONSTANTS.BUMP_LATER_KEY_REGEX,CONSTANTS.SEARCH_REPLACEMENT)},applyValueManipulation:function(searchText){return searchText.replace(CONSTANTS.REPLACE_KEY_REGEX,'"'+CONSTANTS.BUMP_LATER_KEY+'"')}})},_doesURLHaveTrackingSearch:function(){return location.hash.indexOf(CONSTANTS.URL_KEY)>-1}};Streak.DependencyManager.addFunction({functionKey:"bumpLaterThreadListSearchInitialized",functionReference:BumpLaterThreadListSearch.init,functionContext:BumpLaterThreadListSearch,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","enabledFeaturesControllerInitialized"]});BB.Modules.BumpLaterThreadListSearch=BumpLaterThreadListSearch})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterThreadListInboxRowManipulation=Streak.Class.subclass({className:"BumpLaterThreadListInboxRowManipulation",superclass:Gmail.InboxManipulator.InboxRowManipulationBase,_memberVariables:[{name:"_bumpLater",destroy:false},{name:"_threadDOMRow",destroy:false},{name:"_element",destroy:true},{name:"_originalDate",destroy:false}],_initialize:function(bumpLater,threadDOMRow){Gmail.InboxManipulator.InboxRowManipulationBase.prototype._initialize.call(this);this._bumpLater=bumpLater;this._threadDOMRow=threadDOMRow},getManipulationType:function(){return"REPLACE_CONTENT"},getColumnName:function(){return"DATE"},getElement:function(){if(this._element){return this._element}this._element=$(document.createElement("span"));var inner;var momentDate=Streak.moment(this._bumpLater.get("bumpDate"));var titleDate=this._bumpLater.getBumpDateObject().customFormat("pixelTrack");
var dateString=BB.Locale.getString("returning_in",{date:momentDate.fromNow(true)});if(this._bumpLater.getBumpDateObject().isPast()){dateString=BB.Locale.getString("returning_in",{date:BB.Locale.getString("any_second_now")})}inner='<span class="streak__pixelTrackerRecentViews_readDate" title="'+titleDate+'">'+dateString+"</span>";if(this._threadDOMRow.isUnread){inner="<b>"+inner+"</b>"}this._element[0].innerHTML=inner;return this._element}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterThreadListInboxRowManipulationInitialized",functionReference:function(){Gmail.InboxManipulator.addDataSource({getTableManipulation:function(){if(!BB.Modules.BumpLaterThreadListSearch.isYourView()){return null}if(Gmail.isVerticalSplitPreviewPane()){return null}return{type:"COLUMN_WIDTH",columnName:"DATE",width:175}},getRowManipulation:function(hexGmailThreadId,threadDOMRow){if(!BB.Modules.BumpLaterThreadListSearch.isYourView()){return null}var bumpLaterCollection=BB.Services.Threads.ThreadStorer.getBumpLaterCollection(hexGmailThreadId);if(!bumpLaterCollection){return null}var activeBumpLater=bumpLaterCollection.getActiveBumpLater();if(!activeBumpLater){return null}var rowManipulation=new BumpLaterThreadListInboxRowManipulation(activeBumpLater,threadDOMRow);return rowManipulation}})},dependentFunctionKeys:["inboxManipulatorInitialized","threadsInitialized","htmlLoaded","enabledFeaturesControllerInitialized"]});Library.set("BentoBox.Modules.BumpLaterThreadListInboxRowManipulation",BumpLaterThreadListInboxRowManipulation)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterSidebarView=Streak.Class.subclass({className:"BumpLaterSidebarView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=HTML.get("bumpLaterSidebar",true)},hideActiveBumpLater:function(){this._element.find(".streak__bumpLaterSidebar_active").hide()},showActiveBumpLater:function(){this._element.find(".streak__bumpLaterSidebar_active").show()},setActiveBumpLaterView:function(view){this._element.find(".streak__bumpLaterSidebar_activeEntry").html(view.getElement())},setEditActiveBumpLaterButton:function(button){this._element.find(".streak__bumpLaterSidebar_editButton").html(button.getElement())},setDeleteActiveBumpLaterButton:function(button){this._element.find(".streak__bumpLaterSidebar_deleteButton").html(button.getElement())},clearPastBumpLaters:function(){this._element.find(".streak__bumpLaterSidebar_pastEntries").empty()},addBumpLaterView:function(view){this._element.find(".streak__bumpLaterSidebar_pastEntries").append(view.getElement())},hidePastBumpLaterList:function(){this._element.find(".streak__bumpLaterSidebar_past").hide()},showPastBumpLaterList:function(){this._element.find(".streak__bumpLaterSidebar_past").show()}});Library.set("BentoBox.Modules.BumpLaterSidebarView",BumpLaterSidebarView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BumpLaterSidebarViewController=Streak.Class.subclass({className:"BumpLaterSidebarViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_bumpLaterCollection",destroy:false,set:true},{name:"_threadMetaData",destroy:false},{name:"_bumpLaterModel",destroy:false},{name:"_editBumpLaterButton",destroy:true},{name:"_deleteBumpLaterButton",destroy:true}],_initialize:function(bumpLaterCollection,threadMetaData){Streak.UI.ViewController.prototype._initialize.call(this);this._setupEditBumpLaterButton();this._setupDeleteBumpLaterButton();this._threadMetaData=threadMetaData;this.setBumpLaterCollection(bumpLaterCollection)},_setupView:function(){this._view=new BB.Modules.BumpLaterSidebarView},setBumpLaterCollection:function(bumpLaterCollection){this._bumpLaterModel=null;this._bumpLaterCollection=bumpLaterCollection;this._render()},_setupEditBumpLaterButton:function(){var self=this;this._editBumpLaterButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"Text",color:"blue",text:BB.Locale.getString("edit_bump_later"),isFixedPosition:true,isRightAligned:true,menu:BB.Modules.BumpLaterOnThreadsMenuViewController,preOnFunction:function(){BB.Modules.BumpLaterOnThreadsMenuViewController.use(self);BB.Tracker.track("bumpLaterMenuShow",{widget:"sidebar"})},postOnFunction:function(){BB.Modules.BumpLaterOnThreadsMenuViewController.focus()}});this._view.setEditActiveBumpLaterButton(this._editBumpLaterButton)},saved:function(){this._editBumpLaterButton.off();this._renderActiveBumpLater()},canceled:function(){this._editBumpLaterButton.off()},_setupDeleteBumpLaterButton:function(){var self=this;this._deleteBumpLaterButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:BB.Locale.getString("cancel"),onFunction:function(){if(self._bumpLaterModel&&self._bumpLaterModel.isSavedOnServer()){self._bumpLaterModel.del()}}});this._view.setDeleteActiveBumpLaterButton(this._deleteBumpLaterButton)},_render:function(){if(this._bumpLaterCollection){this._bumpLaterModel=this._bumpLaterCollection.getActiveBumpLater()}else{this.destroy();return}this._renderPastBumpLaters();if(this._bumpLaterModel){this._renderActiveBumpLater()}else{this._view.hideActiveBumpLater()}},_renderPastBumpLaters:function(){var pastSnoozeRendered=false;this._view.clearPastBumpLaters();for(var ii=0;ii<this._bumpLaterCollection.length;ii++){var bumpLater=this._bumpLaterCollection[ii];if(bumpLater.isActive()){continue}var detailListEntryView=this._renderBumpLater(bumpLater);this._view.addBumpLaterView(detailListEntryView);pastSnoozeRendered=true}if(pastSnoozeRendered){this._view.showPastBumpLaterList()}else{this._view.hidePastBumpLaterList()}},_renderActiveBumpLater:function(){this._view.showActiveBumpLater();var detailListEntryView=this._renderBumpLater(this._bumpLaterModel);this._view.setActiveBumpLaterView(detailListEntryView)},_renderBumpLater:function(bumpLater){var detailListEntryView=new BB.Widgets.DetailListEntryView;detailListEntryView.addIconClass("streak__snoozeIcon").setText(Streak.moment(bumpLater.getBumpDateObject()).fromNow()).setTextTooltip(bumpLater.getBumpDateObject().customFormat("pixelTrack"));if(bumpLater.get("onlyBumpIfNoResponse")){detailListEntryView.setExtraDetailsText(BB.Locale.getString("bump_later_reply_condition"))}return detailListEntryView}});Streak.DependencyManager.addFunction({functionKey:"bumpLaterSidebarViewControllerInitialized",functionReference:function(){Library.set("BentoBox.Modules.BumpLaterSidebarViewController",BumpLaterSidebarViewController)},dependentFunctionKeys:["schedulerViewControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Date=Streak.Date,Eventer=Streak.Eventer,Gmail=Streak.Gmail,Model=Streak.Model,Collection=Streak.Collection,BB=Streak.BentoBox;var BumpLaterSidebarController={_tabbedSidebarId:null,_bumpLaterSidebarViewController:null,init:function(){this._reset();Streak.NotificationCenter.subscribe({eventName:"threadStorerDataChanged",observer:this,filterParameters:{valueType:"bumpLaterCollection"},functionToCall:this._handleBumpLaterCollectionSet});Gmail.observe("viewChanged",this._handleViewChanged.bind(this));Gmail.observe("conversationThreadLoadedEvent",this._handleConversationLoaded.bind(this),null)},_reset:function(){if(this._tabbedSidebarId){BB.Modules.TabbedSidebarMaster.removeSidebar(this._tabbedSidebarId)}if(this._bumpLaterSidebarViewController){this._bumpLaterSidebarViewController.destroy()}this._tabbedSidebarId=null;this._bumpLaterSidebarViewController=null},_handleViewChanged:function(){if(!Gmail.isConversation()){this._reset()}},_handleConversationLoaded:function(){this._reset();var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}var bumpLaterCollection=BB.Services.Threads.ThreadStorer.getBumpLaterCollection(hexGmailThreadIdList[0]);if(bumpLaterCollection&&bumpLaterCollection.length>0){this._loadBumpLaterSidebarViewController(bumpLaterCollection,hexGmailThreadIdList[0])}else{this._reset()}},_handleBumpLaterCollectionSet:function(notification){if(!Gmail.isConversationVisible()){return}var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length===0){return}if(notification.hexGmailThreadId!==hexGmailThreadIdList[0]){return}var bumpLaterCollection=notification.value;if(bumpLaterCollection&&bumpLaterCollection.length>0){this._loadBumpLaterSidebarViewController(notification.value,hexGmailThreadIdList[0]);return}this._reset()},_loadBumpLaterSidebarViewController:function(bumpLaterCollection,hexGmailThreadId){var threadMetaData=BB.Services.Threads.ThreadStorer.getThreadMetaData(hexGmailThreadId);if(this._bumpLaterSidebarViewController){this._bumpLaterSidebarViewController.setBumpLaterCollection(bumpLaterCollection);return}this._bumpLaterSidebarViewController=new BB.Modules.BumpLaterSidebarViewController(bumpLaterCollection,threadMetaData);this._tabbedSidebarId=BB.Modules.TabbedSidebarMaster.registerNewSidebar({prettyTitle:BB.Locale.getString("bump_later"),iconClass:"streak__snoozeIcon",sidebar:this._bumpLaterSidebarViewController.getView()})}};Streak.DependencyManager.addFunction({functionKey:"bumpLaterSidebarControllerInitialized",functionReference:BumpLaterSidebarController.init,functionContext:BumpLaterSidebarController,dependentFunctionKeys:["tabbedSidebarMasterInitialized","enabledFeaturesControllerInitialized"]});BB.Controllers.BumpLaterSidebarController=BumpLaterSidebarController})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DetailListEntryView=Streak.Class.subclass({className:"DetailListEntryView",superclass:Streak.UI.View,_memberVariables:[],addIconClass:function(iconClass){this._element.find(".streak__detailListEntry_icon").addClass(iconClass);return this},addIconTooltip:function(iconTooltip){this._element.find(".streak__detailListEntry_icon")[0].setAttribute("data-tooltip",iconTooltip);return this},setText:function(text){this._element.find(".streak__detailListEntry_text").text(text);return this},setTextTooltip:function(text){this._element.find(".streak__detailListEntry_text")[0].setAttribute("data-tooltip",text);return this},setExtraDetailsText:function(text){this._element.find(".streak__detailListEntry_extraDetailsText").text(text);return this},_initialize:function(options){if(!DetailListEntryView.prototype.template){DetailListEntryView.prototype.template=HTML.get("detailListEntry")}Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("streak__detailListEntry");this._element[0].innerHTML=DetailListEntryView.prototype.template()}});Library.set("BentoBox.Widgets.DetailListEntryView",DetailListEntryView)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Gmail.GmailThreadListViewProvider;var AwaitingReplyThreadListProvider=Streak.Class.subclass({className:"AwaitingReplyThreadListProvider",superclass:superclass,_memberVariables:[{name:"_promise",destroy:true}],getRelevantRequestParameters:function(){return{q:"label:all before:5002/01/01",view:"tl"}},start:function(pageNumber){var self=this;this._promise=Streak.APIRequester.get("email/awaitingreply").getPromise().then(function(rfcMessageIds){return Gmail.GmailThreadRequester.getGmailThreadsForRFCMessageIds(rfcMessageIds)}).then(function(awaitingReplyThreads){BB.Services.Threads.ThreadMetaDataCreator.processCrapFormatThreads(awaitingReplyThreads);self._addThreadIdToSubjectSpan(awaitingReplyThreads);return awaitingReplyThreads})},getCrapFormatThreads:function(connection,responseText){return this._promise},_addThreadIdToSubjectSpan:function(gmailThreads){for(var ii=0;ii<gmailThreads.length;ii++){gmailThreads[ii][7]=gmailThreads[ii][7].replace("<span",'<span streakthreadid="'+_.escape(gmailThreads[ii][0])+'"')}}});Library.set("BentoBox.Modules.AwaitingReplyThreadListProvider",AwaitingReplyThreadListProvider);Streak.DependencyManager.addFunction({functionKey:"awaitingReplyThreadListProviderInitialized",functionReference:function(){Gmail.GmailThreadListViewRegister.registerProvider(AwaitingReplyThreadListProvider)},dependentFunctionKeys:["userLoggedIn","enabledFeaturesControllerInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Date=Streak.Date,Gmail=Streak.Gmail,Locale=Streak.Locale,HTML=Streak.HTML,Data=Streak.BentoBox.Data,BB=Streak.BentoBox;var CONSTANTS={AWAITING_REPLY_KEY:"label:all before:5002/01/01",URL_KEY:"label%3Aall+before%3A5002%2F01%2F01",SEARCH_URL:"label%3Aall+before%3A5002%2F01%2F01",SEARCH_REPLACEMENT:"is:awaiting"};CONSTANTS.AWAITING_REPLY_KEY_REGEX=new RegExp(CONSTANTS.AWAITING_REPLY_KEY,"img");CONSTANTS.REPLACE_KEY_REGEX=new RegExp(CONSTANTS.SEARCH_REPLACEMENT,"img");var AwaitingReplyThreadListSearch={CONSTANTS:CONSTANTS,_sentMailLink:null,_searchLink:null,_expando:null,init:function(){if(this._isSentMailLinkValid()){this._setupSearchLink();this._setupSearchBarOverride()}},_isSentMailLinkValid:function(){var sentMailLink=Gmail.getSentMailLink();if(!sentMailLink||sentMailLink.length===0){return false}return true},_setupSearchLink:function(){var self=this;Gmail.GmailLeftNavManipulator.addNewLink({getUrl:function(){return"search/"+CONSTANTS.SEARCH_URL},getNavRelativeLabel:function(){return"sent"},getNavRelativeLocation:function(){return"NESTED"},getNavLinkName:function(){return BB.Locale.getString("awaiting_reply_link")}})},_setupSearchBarOverride:function(){var self=this;Gmail.GmailSearchBarContentReplacer.addManipulation({applyDisplayManipulation:function(searchText){return searchText.replace(CONSTANTS.AWAITING_REPLY_KEY_REGEX,CONSTANTS.SEARCH_REPLACEMENT)},applyValueManipulation:function(searchText){return searchText.replace(CONSTANTS.REPLACE_KEY_REGEX,'"'+CONSTANTS.AWAITING_REPLY_KEY+'"')}})},_doesURLHaveTrackingSearch:function(){return location.hash.indexOf(CONSTANTS.URL_KEY)>-1}};Streak.DependencyManager.addFunction({functionKey:"awaitingReplyThreadListSearchInitialized",functionReference:AwaitingReplyThreadListSearch.init,functionContext:AwaitingReplyThreadListSearch,dependentFunctionKeys:["gmailLoaded","htmlLoaded","localeLoaded","enabledFeaturesControllerInitialized","pixelTrackerSearchInitialized"]});BB.Modules.AwaitingReplyThreadListSearch=AwaitingReplyThreadListSearch})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailBodySpanLinkFixer=Streak.Class.subclass({className:"EmailBodySpanLinkFixer",superclass:Gmail.GmailEmailBodyManipulation,_memberVariables:[],_initialize:function(){Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},applyBodyManipulation:function(emailBodies){var relevantSpans=emailBodies.find('span[hspace*="streak-'+this._getSpanType()+'"]');if(relevantSpans.length===0){return}for(var ii=0;ii<relevantSpans.length;ii++){var span=relevantSpans[ii];var key=this._getSpanKey(span);if(!this._isKeyValid(key)){continue}this._replaceSpanWithClickableLink($(span),key)}},_getSpanType:function(){throw new Error("must define span type")},_getSpanKey:function(span){var identifierString=span.getAttribute("hspace");var parts=identifierString.split("-");if(parts.length<3){return null}if(parts.length>3){var keyParts=[];for(var ii=2;ii<parts.length;ii++){keyParts.push(parts[ii])}return keyParts.join("-")}else{return parts[2]}},_replaceSpanWithClickableLink:function(span,key){if(!this._isKeyValid(key)){return}var anchor=$(document.createElement("a"));anchor[0].setAttribute("href","#");span.before(anchor);span.detach();anchor.append(span);var self=this;anchor.click(function(e){self._linkClicked(key);e.preventDefault();e.stopPropagation()})}});Library.set("BentoBox.Modules.EmailBodySpanLinkFixer",EmailBodySpanLinkFixer)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailBodyBoxLinkFixer=Streak.Class.subclass({className:"EmailBodyBoxLinkFixer",superclass:BB.Modules.EmailBodySpanLinkFixer,_memberVariables:[],_initialize:function(){Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},_getSpanType:function(){return"box"},_isKeyValid:function(key){var box=BB.Data.getBox(key);if(!box){return false}this._associateReminderBoxKeyWithThreadId(key);return true},_associateReminderBoxKeyWithThreadId:function(boxKey){var hexGmailThreadIdList=Gmail.getActiveHexGmailThreadIdList(BB.Services.Threads.HexGmailThreadIdExtractor);if(hexGmailThreadIdList.length>0){BB.Services.Threads.ThreadStorer.setReminderBoxKey(hexGmailThreadIdList[0],boxKey)}},_linkClicked:function(key){var box=BB.Data.getBox(key);BB.UI.setURL(box.link())}});Library.set("BentoBox.Modules.EmailBodyBoxLinkFixer",EmailBodyBoxLinkFixer);Gmail.GmailEmailBodyManipulator.registerManipulation(new EmailBodyBoxLinkFixer)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailBodyHelpTourLinkFixer=Streak.Class.subclass({className:"EmailBodyHelpTourLinkFixer",superclass:BB.Modules.EmailBodySpanLinkFixer,_memberVariables:[],_initialize:function(){Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},_getSpanType:function(){return"helpChapter"},applyBodyManipulation:function(emailBodies){BB.Modules.EmailBodySpanLinkFixer.prototype.applyBodyManipulation.call(this,emailBodies);this._findAndReplaceHelpChaptersInText(emailBodies)},_findAndReplaceHelpChaptersInText:function(emailBodies){_.each(emailBodies,this._findAndReplaceTourNames.bind(this))},_tourNameRegex:/(tour:\s?)"([^"\n]*)"/gi,_findAndReplaceTourNames:function(node){if(node.nodeType===Node.TEXT_NODE&&this._tourNameRegex.test(node.data)){this._breakTourNamesFromTextNode(node)}else{_.each(node.childNodes,this._findAndReplaceTourNames.bind(this))}},_breakTourNamesFromTextNode:function(node){var $node=$(node);var nodeText=node.data;var lastRegexMatchIndex=0;var currentRegexMatch;var lastTextNodeAdded=null;var addTextBeforeNode=function(text){if(text.length==0)return;if(lastTextNodeAdded){lastTextNodeAdded.data+=text}else{lastTextNodeAdded=document.createTextNode(text);$node.before(lastTextNodeAdded)}};this._tourNameRegex.lastIndex=0;while(currentRegexMatch=this._tourNameRegex.exec(nodeText)){addTextBeforeNode(nodeText.slice(lastRegexMatchIndex,currentRegexMatch.index));lastRegexMatchIndex=this._tourNameRegex.lastIndex;var delimiter=currentRegexMatch[1];var tourName=currentRegexMatch[2];if(this._isKeyValid(tourName)){addTextBeforeNode(delimiter);$node.before(this._newClickableLinkOfTour(tourName));lastTextNodeAdded=null}else{addTextBeforeNode(currentRegexMatch[0])}}addTextBeforeNode(nodeText.slice(lastRegexMatchIndex));$node.remove()},_isKeyValid:function(key){return BB.Modules.Help.HelpLoader.getHelpViewController().doesChapterExist(key)},_newClickableLinkOfTour:function(tour){var anchor=$("<a href='#' />").text(tour);var self=this;anchor.click(function(e){BB.Tracker.track("tourTextLinkClicked",{tourName:tour});self._linkClicked(tour);e.preventDefault();e.stopPropagation()});return anchor},_linkClicked:function(key){BB.Modules.Help.HelpLoader.getHelpViewController().startChapter(key)}});Streak.DependencyManager.addFunction({functionKey:"emailBodyHelpTourLinkFixerInitialized",functionReference:function(){Library.set("BentoBox.Modules.EmailBodyHelpTourLinkFixer",EmailBodyHelpTourLinkFixer);Gmail.GmailEmailBodyManipulator.registerManipulation(new EmailBodyHelpTourLinkFixer)},dependentFunctionKeys:["helpLoaderInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailBodyPipelineLinkFixer=Streak.Class.subclass({className:"EmailBodyPipelineLinkFixer",superclass:BB.Modules.EmailBodySpanLinkFixer,_memberVariables:[],_initialize:function(){Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},_getSpanType:function(){return"pipeline"},_isKeyValid:function(key){var pipeline=BB.Data.getPipeline(key);return!!pipeline},_linkClicked:function(key){var pipeline=BB.Data.getPipeline(key);BB.UI.setURL(pipeline.link())}});Library.set("BentoBox.Modules.EmailBodyPipelineLinkFixer",EmailBodyPipelineLinkFixer);Gmail.GmailEmailBodyManipulator.registerManipulation(new EmailBodyPipelineLinkFixer)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var StreakLinkFixer=Streak.Class.subclass({className:"StreakLinkFixer",superclass:Gmail.GmailEmailBodyManipulation,_memberVariables:[],_initialize:function(){Streak.Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},applyBodyManipulation:function(emailBodies){var internalLinks=emailBodies.find('a[href*="mail.google.com"]');for(var ii=0;ii<internalLinks.length;ii++){var linkElement=$(internalLinks[ii]);if(!this.isElementRelevant(linkElement)){continue}this._overrideClickEvent(linkElement)}},isElementRelevant:function(linkElement){var href=linkElement.plainText();if(!href){return false}var hrefParts=href.split("#");if(hrefParts.length<2){return false}var urlNoHash=hrefParts[0];if(urlNoHash.indexOf("mail.google.com")===-1){return false}var hash=href.split("#")[1];return BB.UI.isBentoBoxView(Gmail.getStoredView(hash.split("/")))},_overrideClickEvent:function(linkElement){var href=linkElement.plainText();linkElement.click(function(e){BB.UI.setURL(href.split("#")[1]);e.preventDefault();e.stopPropagation()})}});Library.set("BentoBox.Modules.StreakLinkFixer",StreakLinkFixer);Gmail.GmailEmailBodyManipulator.registerManipulation(new StreakLinkFixer)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var EmailBodyInlineImageResizer=Streak.Class.subclass({className:"EmailBodyInlineImageResizer",superclass:Gmail.GmailEmailBodyManipulation,_memberVariables:[],_initialize:function(){Streak.Gmail.GmailEmailBodyManipulation.prototype._initialize.call(this)},applyBodyManipulation:function(emailBodies){var imgs=emailBodies.find("img");var incompleteImages=[];for(var ii=0;ii<imgs.length;ii++){var img=$(imgs[ii]);if(!img[0].complete){incompleteImages.push(img);continue}if(!this._isImgElementRelevant(img)){continue}this._addResizeToImg(img)}if(incompleteImages.length>0){this._waitForIncompleteImages(incompleteImages)}},_isImgElementRelevant:function(img){if(img[0].naturalWidth>img[0].width||img[0].naturalHeight>img[0].height){return img.parent(".streak__imageResizeWrapper").length===0}},_waitForIncompleteImages:function(incompleteImages){var self=this;_.each(incompleteImages,function(img){img[0].addEventListener("load",function(){if(self._isImgElementRelevant(img)&&img.isInBody()){self._addResizeToImg(img)}})})},_addResizeToImg:function(img){var resizeWrapper=$(document.createElement("span"));resizeWrapper.addClass("streak__imageResizeWrapper");var resizeButton=$('<span class="GI T-I T-I-awv GJ streak__imgeResizeButton">'+BB.Locale.getString("expand")+"</span>");resizeButton.easyHoverClass("GK");resizeButton.hide();resizeWrapper.hover(function(){resizeButton.show()},function(){resizeButton.hide()});var renderedDimensions={height:img[0].height,width:img[0].width};var naturalDimensions={height:img[0].naturalHeight,width:img[0].naturalWidth};var isNatural=false;resizeButton.click(function(e){isNatural=!isNatural;var dimensions=isNatural?naturalDimensions:renderedDimensions;img[0].width=dimensions.width;img[0].height=dimensions.height;resizeButton.text(BB.Locale.getString(isNatural?"mm_restore":"expand"));e.stopImmediatePropagation();e.preventDefault()});img.before(resizeWrapper);resizeWrapper.append(img);resizeWrapper.append(resizeButton)}});Streak.DependencyManager.addFunction({functionKey:"EmailBodyInlineImageResizerInitialized",functionReference:function(){Library.set("BentoBox.Modules.EmailBodyInlineImageResizer",EmailBodyInlineImageResizer);Gmail.GmailEmailBodyManipulator.registerManipulation(new EmailBodyInlineImageResizer)},dependentFunctionKeys:["localeLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetFormulaView=Streak.Class.subclass({className:"SpreadsheetFormulaView",superclass:Streak.UI.View,_memberVariables:[{name:"_scopeChooserElement",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this.addClass("streak__spreadsheetFormula");this._setupScopeChooser();this.getElement().append(this._scopeChooserElement)},_setupScopeChooser:function(){this._scopeChooserElement=HTML.getElement("formulaScopeChooser");this._bindHelpLink();this._bindScopeLinks()},_bindHelpLink:function(){var self=this;this._scopeChooserElement.find(".streak__formulaScopeChooser_helpButton")[0].addEventListener("click",function(e){self._delegate.helpButtonClicked()},true)},_bindScopeLinks:function(){var self=this;this._scopeChooserElement.find(".streak__formulaScopeChooser_all")[0].addEventListener("click",function(e){self._delegate.allScopeClicked()},true);this._scopeChooserElement.find(".streak__formulaScopeChooser_stage")[0].addEventListener("click",function(e){self._delegate.stageScopeClicked()},true);this._scopeChooserElement.find(".streak__formulaScopeChooser_box")[0].addEventListener("click",function(e){self._delegate.boxScopeClicked()},true)},setTextInputView:function(textInputView){this.prependSubView(textInputView)},showAllScopeActive:function(){this._resetActiveScope();this._scopeChooserElement.find(".streak__formulaScopeChooser_all").addClass("streak__formulaScopeChooser_active")},showStageScopeActive:function(){this._resetActiveScope();this._scopeChooserElement.find(".streak__formulaScopeChooser_stage").addClass("streak__formulaScopeChooser_active")},showBoxScopeActive:function(){this._resetActiveScope();this._scopeChooserElement.find(".streak__formulaScopeChooser_box").addClass("streak__formulaScopeChooser_active")},_resetActiveScope:function(){this._scopeChooserElement.find(".streak__formulaScopeChooser_links > span").removeClass("streak__formulaScopeChooser_active")}});Library.set("BentoBox.Widgets.SpreadsheetFormulaView",SpreadsheetFormulaView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetFormulaViewController=Streak.Class.subclass({className:"SpreadsheetFormulaViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_scope",destroy:false},{name:"_stageKey",destroy:false},{name:"_gmailTextareaViewController",destroy:true},{name:"_formulaHelpViewController",destroy:true},{name:"_options",destroy:false},{name:"_model",destroy:false},{name:"_property",destroy:false},{name:"_currentValue",destroy:false}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._formulaHelpViewController=new BB.Widgets.FormulaHelpViewController},_setupView:function(){this._view=new BB.Widgets.SpreadsheetFormulaView;this._setupTextInput()},_setupTextInput:function(){this._gmailTextareaViewController=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true,multiline:true,noBorder:true});this._view.setTextInputView(this._gmailTextareaViewController.getView());this._gmailTextareaViewController.getEventStream().onValue(this,"_gmailTextareaEvent")},_gmailTextareaEvent:function(eventWrapper){if(eventWrapper.eventName!=="keydown"){return}var self=this;var event=eventWrapper.event;var triggerElement=this.getElement();if(jwerty.is("escape",event)){self._gmailTextareaViewController.setText(self._currentValue);triggerElement.trigger("escapePressed")}else if(jwerty.is("ctrl+enter/cmd+enter/meta+enter",event)){this._gmailTextareaViewController.insertTextAtCursor("\n")}else if(jwerty.is("enter",event)){triggerElement.trigger("enterPressed")}},setup:function(options){this._pipeline=options.pipeline;this._box=options.box;this._stageKey=options.stageKey;this._scope=null;this._initialScope=null;this._options=options;this._model=options.model;this._property=options.property;this._determineScope()},focus:function(){var self=this;setTimeout(function(){self._formulaHelpViewController.activate();self._focus()},100);this._focus()},_focus:function(){this._currentValue=this.getValue();this._gmailTextareaViewController.focus();this._gmailTextareaViewController.setCursorToEnd()},set:function(val){this._gmailTextareaViewController.setText(val);this.focus()},getValue:function(){return this._currentValue},updateValue:function(){this._formulaHelpViewController.deactivate();try{if(!this._gmailTextareaViewController.getText()&&!this._currentValue){return}}catch(e){return}var formulaColumnLimiter=Library.get("BentoBox.Services.FormulaColumnLimiter");if(formulaColumnLimiter.isLocked()){formulaColumnLimiter.showGateway();return}formulaColumnLimiter.incrementUsage();this.track();var newValue=this._stripEqualSign();if(this._scope===this._initialScope){if(this._gmailTextareaViewController.getText()===(this._currentValue||"").trim()){return}}var currentValue=this._model.getRelevantFormula(this._scope,this._stageKey,this._box);this._markBoxesUpdating(newValue,currentValue);this._model.setAndSaveFormulaSection(this._scope,this._stageKey,this._box,newValue)},allScopeClicked:function(){this._setScopeToAll()},stageScopeClicked:function(){this._setScopeToStage()},boxScopeClicked:function(){this._setScopeToBox()},_determineScope:function(){if(this._model.doesFormulaSectionExistForBox(this._box)){this._setScopeToBox()}else if(this._model.doesFormulaSectionExistForStage(this._stageKey)){this._setScopeToStage()}else{this._setScopeToAll()}this._initialScope=this._scope},_setScopeToAll:function(){this._scope="ALL";this._updateDisplay()},_setScopeToStage:function(){this._scope="STAGE";this._updateDisplay()},_setScopeToBox:function(){this._scope="BOX";this._updateDisplay()},_updateDisplay:function(){if(this._scope==="ALL"){this._view.showAllScopeActive()}else if(this._scope==="STAGE"){this._view.showStageScopeActive()}else if(this._scope==="BOX"){this._view.showBoxScopeActive()}this._setupCursorOutline();this._setCurrentValue();this._gmailTextareaViewController.focus()
},_setupCursorOutline:function(){this._options.cursor.removeCursorRange("streak__cursorAffect");switch(this._scope){case"ALL":this._options.cursor.addCursorRange({startCoord:[1,this._options.coord[1]],endCoord:[this._options.tableModel.getNumberOfNonHeaderRows(),this._options.coord[1]],cssClass:"streak__cursorAffect"});break;case"STAGE":var rowOfNextGroup=this._options.tableModel.getRowOfNextGroup(this._stageKey);if(rowOfNextGroup===-1){this._options.spreadsheetRedrawFunction();return}this._options.cursor.addCursorRange({startCoord:[this._options.coord[0]+1,this._options.coord[1]],endCoord:[rowOfNextGroup-1,this._options.coord[1]],cssClass:"streak__cursorAffect"});break}this._options.spreadsheetRedrawFunction()},_setCurrentValue:function(){this._currentValue="= "+this._model.getRelevantFormula(this._scope,this._stageKey,this._box);this._gmailTextareaViewController.setText(this._currentValue)},_stripEqualSign:function(){var value=this._gmailTextareaViewController.getText();if(!value.match(/\s*\=.*/)){return value}return value.replace(/\s*\=\s*(.*)/,"$1")},_markBoxesUpdating:function(newValue,currentValue){var updatingScope;if(this._scope===this._initialScope){updatingScope=this._scope}else{if(newValue===currentValue){updatingScope=this._initialScope}else{updatingScope=this._scope}}this._box.markFieldCalculating(this._model.key());var self=this;switch(updatingScope){case"STAGE":_.chain(BB.Data.getPipelineBoxes(this._pipeline.key())).filter(function(box){return box.get("stageKey")===self._stageKey}).each(function(box){box.markFieldCalculating(self._model.key())});break;case"ALL":_.chain(BB.Data.getPipelineBoxes(this._pipeline.key())).filter(function(box){if(self._model.doesFormulaSectionExistForBox(box)){return false}if(self._model.doesFormulaSectionExistForStage(box.get("stageKey"))){return false}return true}).each(function(box){box.markFieldCalculating(self._model.key())});break}this._options.spreadsheetRedrawFunction()},helpButtonClicked:function(){this._formulaHelpViewController.forceOpen()},preDetach:function(){this._options.cursor.removeCursorRange("streak__cursorAffect");this._options.spreadsheetRedrawFunction()},getElement:function(){return this._view.getElement()},track:function(){BB.Tracker.trackStreakActive({property:this._property,widget:"spreadsheetFormula"})}});Library.set("BentoBox.Widgets.SpreadsheetFormulaViewController",SpreadsheetFormulaViewController)})(Streak);(function(Streak){var _=Streak._,Library=Streak.Library,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox,Locale=Streak.Locale;var MAX_FORMULA_FIELDS=1;var FormulaColumnLimiter=Streak.Class.subclass({superclass:Streak.BentoBox.Services.FeatureLimiter,_memberVariables:[],_initialize:function(){Streak.BentoBox.Services.FeatureLimiter.prototype._initialize.call(this)},_getFeatureKey:function(){return"formulaFields"},_getGatewayTitle:function(){return Locale.getString("formula_column_gateway_title")},_getGatewayBodyText:function(){return Locale.getString("formula_column_gateway_text")},_getLimit:function(){return MAX_FORMULA_FIELDS}});DependencyManager.addFunction({functionKey:"FormulaColumnLimiterInitialized",functionReference:function(callback){Library.set("BentoBox.Services.FormulaColumnLimiter",new FormulaColumnLimiter)},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var InboxListView=Streak.Class.subclass({className:"InboxListView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._rowTemplate=HTML.get("inboxListRow")},_setupElement:function(){this._element=HTML.getElement("inboxList")},empty:function(){this._element.find(".streak__inboxListEntries").empty()},addEntry:function(options){var row=$(this._rowTemplate(options));this._element.find(".streak__inboxListEntries").append(row);if(options.clickCallback){row.click(options.clickCallback)}}});Library.set("BentoBox.Widgets.InboxListView",InboxListView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var InboxListViewController=Streak.Class.subclass({className:"InboxListViewController",superclass:Streak.UI.ViewController,_memberVariables:[],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.InboxListView")},empty:function(){this._view.empty()},addEntry:function(options){this._view.addEntry(options)}});Library.set("BentoBox.Widgets.InboxListViewController",InboxListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Gmail.GmailThreadListViewProvider;var HexGmailThreadIdAdderThreadListProvider=Streak.Class.subclass({className:"HexGmailThreadIdAdderThreadListProvider",superclass:superclass,_memberVariables:[],_initialize:function(){superclass.prototype._initialize.call(this)},getRelevantRequestParameters:function(){return{view:"tl"}},isCustomList:function(){return false},start:function(pageNumber){},getCrapFormatThreads:function(connection,responseText){var self=this;return new Streak.RSVP.Promise(function(resolve,reject){resolve(self._getThreadsWithHexGmailThreadIdsAdded(responseText))})},_getThreadsWithHexGmailThreadIdsAdded:function(responseText){var currentThreads=Gmail.ThreadResponseProcessor.extractThreads(responseText);if(!currentThreads){return null}for(var ii=0;ii<currentThreads.length;ii++){var thread=currentThreads[ii];thread[15]="streakthreadid "+thread[0]}return currentThreads}});Streak.DependencyManager.addFunction({functionKey:"hexGmailThreadIdAdderThreadListProviderInitialized",functionReference:function(){if(!BB.isFeatureEnabled("hexGmailThreadIdAdder")&&!Gmail.isVerticalSplitPreviewPane()){return}Library.set("BentoBox.HexGmailThreadIdAdderThreadListProvider",HexGmailThreadIdAdderThreadListProvider);Gmail.GmailThreadListViewRegister.registerProvider(HexGmailThreadIdAdderThreadListProvider)},dependentFunctionKeys:["enabledFeaturesControllerInitialized","gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartCheckboxViewController=Streak.Class.subclass({className:"SmartCheckboxViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_model",destroy:false},{name:"_property",destroy:false},{name:"_unsubscribeFunction",destroy:false}],_initialize:function(options){Streak.UI.ViewController.prototype._initialize.call(this);this._model=options.model;this._property=options.property;this._subscribeToModelEventStream();this._subscribeToViewEventStream();this._view.setIsChecked(!!this._model.get(this._property))},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.GmailCheckboxView");this._view.addClass("smartInput")},_subscribeToModelEventStream:function(){var self=this;this._unsubscribeFunction=this._model.getEventStream().filter(function(notification){return notification.property===self._property&&notification.eventName==="set"}).map(function(notification){return!!notification.newValue}).onValue(function(value){self._view.setIsChecked(value)})},_subscribeToViewEventStream:function(){var self=this;this._view.getEventStream().onValue(function(eventWrapper){var value=eventWrapper.isChecked;self._model.set(self._property,value);self._model.save();BB.Tracker.track("boxDataEdited",{widget:"smartCheckbox"})})},focus:function(){this._view.focus()},getElement:function(){return this._view.getElement()},destroy:function(){if(this._unsubscribeFunction){this._unsubscribeFunction()}Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.SmartCheckboxViewController",SmartCheckboxViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTextDropdownModel=Streak.Class.subclass({className:"SmartTextDropdownModel",superclass:BB.Widgets.ListView.ListViewBaseModel,_memberVariables:[{name:"_text",destroy:false},{name:"_currentlySelectedKey",destroy:false},{name:"_optionSource",destroy:false,set:true},{name:"_listRows",destroy:true},{name:"_shouldHighlight",destroy:true,defaultValue:false}],_initialize:function(){BB.Widgets.ListView.ListViewBaseModel.prototype._initialize.call(this)},setText:function(text){this._text=text.trim();this._refresh()},setCurrentlySelectedKey:function(key){this._currentlySelectedKey=key;this._refresh()},_refresh:function(){this._sections=[];var selectedKey=this._currentlySelectedKey;this._text=this._text||"";var originalText=this._text;var searchText=this._text.toLowerCase();var hasExactMatch=false;var self=this;this._shouldHighlight=false;this._listRows=_.chain(this._optionSource.getOptions()).map(function(option){hasExactMatch=hasExactMatch||option.name===originalText;var isHighlighted=searchText.length>0&&option.name.toLowerCase().indexOf(searchText)===0;self._shouldHighlight=self._shouldHighlight||isHighlighted;return{text:option.name,option:option,isHighlighted:isHighlighted,isSelected:option.key===selectedKey}}).value();if(this._listRows.length===0&&!this._text){this._addNoOptionsMessageSection();this._sections.push({isSeparator:true})}else if(this._listRows.length>0){this._sections.push({rows:this._listRows});this._sections.push({isSeparator:true})}var isDisabled=hasExactMatch||!searchText;this._addCreateOptionSection(isDisabled);this._callDelegateFunction("dataChanged")},_addNoOptionsMessageSection:function(){this._sections.push({isFreeForm:true,element:'<div class="streak__listViewRow_disabled streak__dropdown_noOptions">'+BB.Locale.getString("dropdown_no_options")+"</div>"})},_addCreateOptionSection:function(isDisabled){var buttonText;if(this._text&&!isDisabled){buttonText=BB.Locale.getString("dropdown_create_text_option",{option:this._text})}else{buttonText=BB.Locale.getString("dropdown_create_option")}this._sections.push({rows:[{text:buttonText,isCreateNew:true,isDisabled:isDisabled,optionName:this._text,displayClass:isDisabled?"streak__listViewRow_disabled":null}]})},isSectionSeparator:function(sectionIndex){return this._sections[sectionIndex].isSeparator},isSectionFreeForm:function(sectionIndex){return this._sections[sectionIndex].isFreeForm},getSectionFreeFormElement:function(sectionIndex){return this._sections[sectionIndex].element},dontHighlightOnDataChange:function(){return!this._shouldHighlight}});Library.set("BentoBox.Widgets.SmartTextDropdownModel",SmartTextDropdownModel)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTextDropdownViewController=Streak.Class.subclass({className:"SmartTextDropdownViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_model",destroy:false},{name:"_property",destroy:false},{name:"_optionSource",destroy:false},{name:"_unsubscribeFunction",destroy:true},{name:"_gmailTextareaViewController",destroy:true},{name:"_listViewController",destroy:true},{name:"_menuListWrapper",destroy:true},{name:"_smartTextDropdownModel",destroy:true}],_initialize:function(options){Streak.UI.ViewController.prototype._initialize.call(this);this._view.getElement().addClass("smartInput streak__smartTextDropdown");this._model=options.model;this._property=options.property;this._optionSource=options.optionSource;this._smartTextDropdownModel=new BB.Widgets.SmartTextDropdownModel;this._smartTextDropdownModel.setOptionSource(this._optionSource);this._setupViewControllers();this._subscribeToViewControllerEventStreams();this._subscribeToModelEventStream();this._bindToViewEvents();this._displayValue(this._model.get(this._property))},_setupViewControllers:function(){this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._listViewController.setDataSource(this._smartTextDropdownModel);this._menuListWrapper=BB.Widgets.Menu.create();this._menuListWrapper.addSection(this._listViewController.getView().getElement());this._menuListWrapper.getElement().addClass("streak__smartTextDropdown_menu");this._gmailTextareaViewController=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true,multiline:false});this._gmailTextareaViewController.addDelegate(this._listViewController);this._view.addSubView(this._gmailTextareaViewController.getView())},_subscribeToViewControllerEventStreams:function(){var self=this;var focusStreamProperty=this._gmailTextareaViewController.getEventStream().filter(function(event){return event.eventName==="focus"||event.eventName==="blur"}).toProperty();var blurStream=this._gmailTextareaViewController.getEventStream().filter(function(event){return event.eventName==="blur"}).delay(150);var sampledFocusStreamProperty=focusStreamProperty.sampledBy(blurStream);blurStream.combine(sampledFocusStreamProperty,function(blurEvent,sampledFocusEvent){return blurEvent.eventName===sampledFocusEvent.eventName}).filter(function(stillBlurred){return stillBlurred}).onValue(function(){self._detachMenu();var currentOption=self._optionSource.getOption(self._model.get(self._property));if(currentOption){self._gmailTextareaViewController.setText(currentOption.name)}else{self._gmailTextareaViewController.setText("")}});this._gmailTextareaViewController.getEventStream().filter(function(event){return event.eventName==="focus"}).delay(10).onValue(function(){self._selectAllText()});this._gmailTextareaViewController.getEventStream().filter(function(event){return event.eventName==="focus"||event.eventName==="click"}).onValue(function(event){self._displayMenu();self._smartTextDropdownModel.setText(event.text)});this._gmailTextareaViewController.getEventStream().filter(function(event){return event.eventName==="input"}).onValue(function(event){self._displayMenu();self._smartTextDropdownModel.setText(event.text)});this._gmailTextareaViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="keydown"&&eventWrapper.event.which===Streak.jwerty.KEYS.keys.tab}).onValue(function(eventWrapper){if(self._listViewController.isRowHighlighted()){var rowData=self._listViewController.getHighlightedRowData();if(rowData){self._tryToSetValueBasedOnKey(rowData.option.key,true)}}else{self._tryToSetValueBasedOnText(true)}});this._gmailTextareaViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="keydown"&&eventWrapper.event.which===Streak.jwerty.KEYS.keys.right&&self._gmailTextareaViewController.isCursorAtEnd()}).onValue(function(eventWrapper){eventWrapper.event.preventDefault()});this._gmailTextareaViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="keydown"&&eventWrapper.event.which===Streak.jwerty.KEYS.keys.left&&self._gmailTextareaViewController.isCursorAtStart()}).onValue(function(eventWrapper){eventWrapper.event.preventDefault()});this._listViewController.getEventStream().filter(function(event){return event.eventName==="rowPressed"&&event.rowData.isCreateNew===true}).onValue(function(event){if(event.rowData.isDisabled){self._listViewController.refresh()}else{self._createNewOption(event.rowData.optionName);self._detachMenu()}});this._listViewController.getEventStream().filter(function(event){return event.eventName==="rowPressed"&&!event.rowData.isCreateNew}).map(function(event){return event.rowData.option.key}).onValue(function(key){self._tryToSetValueBasedOnKey(key)});this._listViewController.getEventStream().filter(function(event){return event.eventName==="movedRow"}).onValue(function(event){if(event.rowData.isCreateNew){self._gmailTextareaViewController.setText(event.rowData.optionName)}else{self._gmailTextareaViewController.setText(event.rowData.option.name)}self._gmailTextareaViewController.selectAllText()})},_subscribeToModelEventStream:function(){var self=this;this._unsubscribeFunction=this._model.getEventStream().filter(function(notification){return notification.property===self._property&&notification.eventName==="set"}).map(function(notification){return notification.newValue}).onValue(function(value){self._displayValue(value)})},_bindToViewEvents:function(){var self=this;this._view.getElement()[0].setAttribute("tabindex",-1);this._view.getElement().bind("focus",function(e){self._gmailTextareaViewController.focus()})},_selectAllText:function(){this._gmailTextareaViewController.selectAllText()},_displayMenu:function(){if(!this._menuListWrapper){return}var menuElement=this._menuListWrapper.getElement();if(menuElement.isVisible()){return}Gmail.elements.body.append(menuElement);menuElement[0].style.position="fixed";menuElement.containByScreen(this._gmailTextareaViewController.getView().getElement())},_tryToSetValueBasedOnText:function(fromTab){var text=this._gmailTextareaViewController.getText().trim();if(text){this._showNoSelectionError();return}if(this._model.get(this._property)){this._model.set(this._property,"");this._model.save();BB.Tracker.track("columnDropdown.setValue")}this._detachMenu(fromTab)},_tryToSetValueBasedOnKey:function(key,fromTab){if(this._model.get(this._property)===key){this._detachMenu(fromTab);return}var option=this._optionSource.getOption(key);if(!option.key){BB.ButterBarManager.showError({message:BB.Locale.getString("option_not_available_yet"),time:6*1e3});return}this._model.set(this._property,key);this._model.save();this._detachMenu(fromTab);BB.Tracker.track("columnDropdown.setValue")},_showNoSelectionError:function(){BB.ButterBarManager.showError({message:BB.Locale.getString("dropdown_option_error"),time:6*1e3})},_setValue:function(value){var option=this._optionSource.getOption(value);if(value&&option){this._gmailTextareaViewController.setText(option.name);this._smartTextDropdownModel.setText(option.name);this._smartTextDropdownModel.setCurrentlySelectedKey(option.key)}else{this._gmailTextareaViewController.setText("");this._smartTextDropdownModel.setText("");this._smartTextDropdownModel.setCurrentlySelectedKey("")}},_displayValue:function(value){var option=this._optionSource.getOption(value);if(value&&option){this._gmailTextareaViewController.setText(option.name);this._smartTextDropdownModel.setText(option.name);this._smartTextDropdownModel.setCurrentlySelectedKey(option.key)}else{this._gmailTextareaViewController.setText("");this._smartTextDropdownModel.setText("");this._smartTextDropdownModel.setCurrentlySelectedKey("")}},_detachMenu:function(fromTab){if(this._menuListWrapper){this._menuListWrapper.getElement().detach()}},_createNewOption:function(optionName){if(!optionName){return}this._optionSource.addOptionAndSet(optionName,this._model);BB.Tracker.track("columnDropdown.addNewOption")},getElement:function(){return this._view.getElement()}});Library.set("BentoBox.Widgets.SmartTextDropdownViewController",SmartTextDropdownViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SpreadsheetSmartTextDropdownViewController=Streak.Class.subclass({className:"SpreadsheetSmartTextDropdownViewController",superclass:BB.Widgets.SmartTextDropdownViewController,_memberVariables:[],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._smartTextDropdownModel=new BB.Widgets.SmartTextDropdownModel;this._setupViewControllers();this._subscribeToViewControllerEventStreams();this._bindToViewEvents()},focus:function(){this._gmailTextareaViewController.focus()},set:function(value){this.focus();var self=this;setTimeout(function(){self._gmailTextareaViewController.setText(value);self._smartTextDropdownModel.setText(value);self._gmailTextareaViewController.setCursorToEnd()},20)},setup:function(options){if(this._unsubscribeFunction){this._unsubscribeFunction()}this._model=options.model;this._property=options.property;this._optionSource=options.optionSource;this._smartTextDropdownModel.setOptionSource(this._optionSource);this._subscribeToModelEventStream();this._setValue(this._model.get(this._property));this._gmailTextareaViewController.focus()},updateValue:function(){},_subscribeToViewControllerEventStreams:function(){BB.Widgets.SmartTextDropdownViewController.prototype._subscribeToViewControllerEventStreams.call(this);var self=this;this._gmailTextareaViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="keydown"&&eventWrapper.event.which===Streak.jwerty.KEYS.keys.escape}).onValue(function(){self._triggerEvent("escapePressed")})},_displayMenu:function(){if(!this._menuListWrapper){return}var menuElement=this._menuListWrapper.getElement();menuElement.addClass("streak__spreadsheetSmartTextDropdown_menu");Gmail.elements.body.append(menuElement);menuElement[0].style.position="fixed";menuElement.containByScreen(this._gmailTextareaViewController.getView().getElement())},_detachMenu:function(fromTab){BB.Widgets.SmartTextDropdownViewController.prototype._detachMenu.call(this);if(fromTab){return}this._triggerEvent("enterPressed")},_triggerEvent:function(eventName){this._view.getElement().trigger(eventName)}});Library.set("BentoBox.Widgets.SpreadsheetSmartTextDropdownViewController",SpreadsheetSmartTextDropdownViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GroupedLinkListView=Streak.Class.subclass({className:"GroupedLinkListView",superclass:Streak.UI.View,_memberVariables:[{name:"_currentList",destroy:false}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element.addClass("streak__groupedLinkList")},startNewSection:function(sectionName){var h3=$(document.createElement("h3"));h3.text(sectionName);this._element.append(h3);this._currentList=$(document.createElement("ul"));this._element.append(this._currentList)},addItem:function(text,options){var listItem=$(document.createElement("li"));var textSpan=$(document.createElement("span"));textSpan[0].setAttribute("title",text);textSpan.text(text);listItem.append(textSpan);if(options.clickCallback){listItem.click(options.clickCallback)}if(options.actionClass){var actionSpan=$(document.createElement("span"));actionSpan[0].setAttribute("class",options.actionClass);if(options.actionClickCallback){actionSpan.click(options.actionClickCallback)}}this._currentList.append(listItem)},addView:function(view){this._currentList.append(view.getElement())}});Library.set("BentoBox.Widgets.GroupedLinkListView",GroupedLinkListView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GroupedLinkListViewController=Streak.Class.subclass({className:"GroupedLinkListViewController",superclass:Streak.UI.ViewController,_memberVariables:[],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.GroupedLinkListView")},startNewSection:function(sectionName){this._view.startNewSection(sectionName)},addItem:function(text,options){this._view.addItem(text,options)}});Library.set("BentoBox.Widgets.GroupedLinkListViewController",GroupedLinkListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxesGroupedLinkListViewController=Streak.Class.subclass({className:"BoxesGroupedLinkListViewController",superclass:BB.Widgets.GroupedLinkListViewController,_memberVariables:[{name:"_widgetName",destroy:false,set:true}],_initialize:function(boxes){BB.Widgets.GroupedLinkListViewController.prototype._initialize.call(this);if(boxes){this._renderBoxes(boxes)}},setBoxes:function(boxes){this._view.empty();this._renderBoxes(boxes)},_renderBoxes:function(boxes){var self=this;var groupedBoxes;_.chain(boxes).sortBy(function(box){return box.get("lastUpdatedTimestamp")}).sortBy(function(box){return box.displayName()}).sortBy(function(box){var stageOrder=box.getPipeline().get("stageOrder");return stageOrder.indexOf(box.get("stageKey"))}).groupBy(function(box){return box.getPipeline().key()}).tap(function(intermediateResults){groupedBoxes=intermediateResults}).keys().map(function(pipelineKey){return BB.Data.getPipeline(pipelineKey)}).sortBy(function(pipeline){return pipeline.displayName()}).each(function(pipeline){self._view.startNewSection(pipeline.displayName());self._renderPipelineBoxes(groupedBoxes[pipeline.key()])})},_renderPipelineBoxes:function(boxes){for(var ii=0;ii<boxes.length;ii++){this._renderBox(boxes[ii])}},_renderBox:function(box){var self=this;var self=this;this._view.addItem(box.displayName(),{clickCallback:function(){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName})}})}});Library.set("BentoBox.Widgets.BoxesGroupedLinkListViewController",BoxesGroupedLinkListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MultipleActionBoxesGroupedLinkListViewController=Streak.Class.subclass({className:"MultipleActionBoxesGroupedLinkListViewController",superclass:BB.Widgets.BoxesGroupedLinkListViewController,_memberVariables:[{name:"_actions",destroy:true,set:true},{name:"_mainActionCallback",destroy:false,set:true},{name:"_actionMenu",destroy:true},{name:"_currentBox",destroy:false},{name:"_listItems",destroy:true,defaultValue:[]}],_initialize:function(){BB.Widgets.BoxesGroupedLinkListViewController.prototype._initialize.call(this);this._setupActionMenu()},_setupActionMenu:function(){this._actionMenu=BB.Widgets.Menu.create()},setActions:function(actions){this._actionMenu.empty();if(!actions){return}for(var ii=0;ii<actions.length;ii++){this._addMenuAction(actions[ii])}},_addMenuAction:function(action){var self=this;this._actionMenu.addItem(action.text,function(){action.callback(self._currentBox)})},_renderBox:function(box){var self=this;var boxSplitMenuButton=BB.Widgets.Buttons.ButtonFactory.createSplitMenuButton({type:"TextArrow",color:"blue",text:box.displayNameText(),menu:this._actionMenu,isRightAligned:true,menuClickTriggersOff:true,onFunction:function(){self._mainActionCallback(box)},preOnFunction:function(){self._currentBox=box}});this._view.addView(boxSplitMenuButton);this._listItems.push(boxSplitMenuButton)}});Library.set("BentoBox.Widgets.MultipleActionBoxesGroupedLinkListViewController",MultipleActionBoxesGroupedLinkListViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RelatedBoxesView=Streak.Class.subclass({className:"RelatedBoxesView",superclass:Streak.UI.View,_memberVariables:[{name:"_collapseWidget",destroy:true},{name:"_bodyElement",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._bodyElement=$(document.createElement("div"));this._collapseWidget=BB.Widgets.CollapseSection.create({title:BB.Locale.getString("related_boxes"),bodyEl:this._bodyElement,startOpen:true,localToggleStateKey:"sidebarRelatedBoxes"});this._collapseWidget.el.addClass("streak__sidebar_relatedBoxes");this._element=this._collapseWidget.el},setListOfBoxesView:function(view){this._bodyElement.append(view.getElement())}});Library.set("BentoBox.Modules.RelatedBoxesView",RelatedBoxesView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RelatedBoxesViewController=Streak.Class.subclass({className:"RelatedBoxesViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_multipleActionBoxesGroupedLinkListViewController",destroy:true}],_initialize:function(relatedBoxes){Streak.UI.ViewController.prototype._initialize.call(this);this._setupListViewController();this._multipleActionBoxesGroupedLinkListViewController.setBoxes(relatedBoxes);this._view.setListOfBoxesView(this._multipleActionBoxesGroupedLinkListViewController.getView());this._widgetName="relatedBoxes"},_setupView:function(){this._view=new BB.Modules.RelatedBoxesView},_setupListViewController:function(){this._multipleActionBoxesGroupedLinkListViewController=new BB.Widgets.MultipleActionBoxesGroupedLinkListViewController;this._multipleActionBoxesGroupedLinkListViewController.setActions([{text:BB.Locale.getString("go_to_box"),callback:function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,actionArea:"menuAction"})}},{text:BB.Locale.getString("add_current_thread_to_box"),callback:function(box){var threadMetaDataList=BB.Services.Threads.ThreadMetaDataCreator.getActiveThreadMetaDataList();BB.Modules.BoxesMenu.BoxAndGmailThreadCreator.createGmailThreads(box.key(),threadMetaDataList);BB.Tracker.track("addThreadsToBox",{threadCount:threadMetaDataList.length,context:"relatedBoxes",actionArea:"menuAction"})}}]);this._multipleActionBoxesGroupedLinkListViewController.setMainActionCallback(function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,actionArea:"mainLink"})})}});Library.set("BentoBox.Modules.RelatedBoxesViewController",RelatedBoxesViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var BoxSidebarRelatedBoxesViewController=Streak.Class.subclass({className:"BoxSidebarRelatedBoxesViewController",superclass:BB.Modules.RelatedBoxesViewController,_memberVariables:[{name:"_currentBox",destroy:false,set:true}],_initialize:function(relatedBoxes,currentBox){BB.Modules.RelatedBoxesViewController.prototype._initialize.call(this,relatedBoxes);this._currentBox=currentBox;this._widgetName="boxSidebarRelatedBoxes"},_setupListViewController:function(){this._multipleActionBoxesGroupedLinkListViewController=new BB.Widgets.MultipleActionBoxesGroupedLinkListViewController;var self=this;this._multipleActionBoxesGroupedLinkListViewController.setActions([{text:BB.Locale.getString("go_to_box"),callback:function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,actionArea:"menuAction"})
}},{text:BB.Locale.getString("add_to_linked_boxes"),callback:function(box){self._currentBox.addLinkedBox(box);BB.Tracker.track("addLinkedBox",{widget:"boxSidebarRelatedBoxes",context:"boxSidebarRelatedBoxes"})}}]);this._multipleActionBoxesGroupedLinkListViewController.setMainActionCallback(function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,actionArea:"mainLink"})})}});Library.set("BentoBox.Modules.BoxSidebarRelatedBoxesViewController",BoxSidebarRelatedBoxesViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RelatedBoxesOnComposeViewController=Streak.Class.subclass({className:"RelatedBoxesOnComposeViewController",superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_element",destroy:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this)},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){var relatedBoxes=this._composeWindowViewController.getModuleStorageValue("relatedBoxes");return relatedBoxes&&relatedBoxes.length>0&&this._composeWindowViewController.getActiveModules().indexOf("mailMerge")===-1},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"NEW_RECIPIENT_ROW"},getModificationElement:function(){this._setupElement();return this._element},activeModulesChanged:function(activeModules){if(activeModules.indexOf("mailMerge")>-1){this._composeWindowViewController.reloadModification(this);return}},addressesChanged:function(){this._recomputeRelatedBoxes();this._composeWindowViewController.reloadModification(this)},moduleStorageValueChanged:function(key,value){if(key==="threadBox"){this._recomputeRelatedBoxes();this._composeWindowViewController.reloadModification(this)}},_recomputeRelatedBoxes:function(){var toContacts=this._composeWindowViewController.getToContacts();var emailAddresses=_.pluck(toContacts,"emailAddress");var relatedBoxes=BB.Services.BoxSearcher.getBoxesWithOverlappingEmailAddresses(emailAddresses,this._composeWindowViewController.getModuleStorageValue("threadBox"));this._composeWindowViewController.setModuleStorageValue("relatedBoxes",relatedBoxes);if(relatedBoxes.length>0&&BB.LocalSettings.get("relatedBoxes/isComposeSidebarVisible")){this._composeWindowViewController.setModuleActive("relatedBoxes")}else{this._composeWindowViewController.setModuleInactive("relatedBoxes")}},_setupElement:function(){var relatedBoxes=this._composeWindowViewController.getModuleStorageValue("relatedBoxes");if(!this._element){if(!relatedBoxes||relatedBoxes.length===0){return}this._element=$(document.createElement("div"));this._element.addClass("streak__composeRelatedBoxes")}this._element.text(BB.Locale.getString("compose_related_boxes",{number:relatedBoxes.length}));var isComposeSidebarVisible=BB.LocalSettings.get("relatedBoxes/isComposeSidebarVisible");var linkText=BB.Locale.getString(isComposeSidebarVisible?"hide":"show");var self=this;var linkButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",text:linkText,onFunction:function(){isComposeSidebarVisible=!isComposeSidebarVisible;BB.LocalSettings.set("relatedBoxes/isComposeSidebarVisible",isComposeSidebarVisible);if(isComposeSidebarVisible){self._composeWindowViewController.setModuleActive("relatedBoxes");linkButton.setText(BB.Locale.getString("hide"));BB.Tracker.track("showComposeRelatedBoxes")}else{self._composeWindowViewController.setModuleInactive("relatedBoxes");linkButton.setText(BB.Locale.getString("show"));BB.Tracker.track("hideComposeRelatedBoxes")}}});this._element.append(linkButton.getElement())}});Library.set("BentoBox.Modules.RelatedBoxesOnComposeViewController",RelatedBoxesOnComposeViewController);DependencyManager.addFunction({functionKey:"relatedBoxesOnComposeViewController",functionReference:function(){Gmail.GmailComposeManager.registerModifierModule({getViewControllers:function(){return[new RelatedBoxesOnComposeViewController]}})},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","data.boxes.initialized","data.pipelines.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RelatedBoxesOnComposeSidebarViewController=Streak.Class.subclass({className:"RelatedBoxesOnComposeSidebarViewController",superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_multipleActionBoxesGroupedLinkListViewController",destroy:true},{name:"_isVisible",destroy:false,defaultValue:false}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.call(this)},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController},shouldProcessModification:function(){var relatedBoxes=this._composeWindowViewController.getModuleStorageValue("relatedBoxes");this._isVisible=relatedBoxes&&relatedBoxes.length>0&&this._composeWindowViewController.getActiveModules().indexOf("mailMerge")===-1&&this._composeWindowViewController.getActiveModules().indexOf("relatedBoxes")>-1;return this._isVisible},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"EXTERNAL_SIDEBAR"},getModificationElement:function(){this._setupGroupedLinkListViewController();return this._multipleActionBoxesGroupedLinkListViewController.getView().getElement()},getWidth:function(){return 220},getModificationTitle:function(){return BB.Locale.getString("related_boxes")},activeModulesChanged:function(activeModules){if(activeModules.indexOf("mailMerge")>-1){this._composeWindowViewController.reloadModification(this);return}if(activeModules.indexOf("relatedBoxes")>-1){this._composeWindowViewController.reloadModification(this);return}if(activeModules.indexOf("relatedBoxes")===-1&&this._isVisible){this._composeWindowViewController.reloadModification(this);return}},moduleStorageValueChanged:function(key,value){if(key==="relatedBoxes"){this._composeWindowViewController.reloadModification(this)}},_setupGroupedLinkListViewController:function(){var self=this;if(!this._multipleActionBoxesGroupedLinkListViewController){this._multipleActionBoxesGroupedLinkListViewController=new BB.Widgets.MultipleActionBoxesGroupedLinkListViewController;this._multipleActionBoxesGroupedLinkListViewController.setMainActionCallback(function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,context:"mainLink"})});this._multipleActionBoxesGroupedLinkListViewController.setWidgetName("relatedBoxesOnComposeSidebar")}var actions=[{text:BB.Locale.getString("go_to_box"),callback:function(box){BB.UI.setURL(box.link());BB.Tracker.track("boxesGroupedLinkListClicked",{widget:self._widgetName,context:"menuAction"})}}];if(this._composeWindowViewController.getModuleStorageValue("threadBox")){actions.push({text:BB.Locale.getString("add_to_linked_boxes"),callback:function(box){self._composeWindowViewController.getModuleStorageValue("threadBox").addLinkedBox(box);BB.Tracker.track("addLinkedBox",{context:"relatedBoxesComposeSidebar"})}})}else{actions.push({text:BB.Locale.getString("add_current_email_to_box"),callback:function(box){self._composeWindowViewController.setModuleStorageValue("threadBox",box);self._composeWindowViewController.setModuleActive("threadBox");self._composeWindowViewController.notify("threadAddedToBox",box);BB.Tracker.track("addBoxToCompose",{context:"relatedBoxesComposeSidebar"})}})}this._multipleActionBoxesGroupedLinkListViewController.setActions(actions);this._multipleActionBoxesGroupedLinkListViewController.setBoxes(this._composeWindowViewController.getModuleStorageValue("relatedBoxes"))}});Library.set("BentoBox.Modules.RelatedBoxesOnComposeSidebarViewController",RelatedBoxesOnComposeSidebarViewController);DependencyManager.addFunction({functionKey:"relatedBoxesOnComposeSidebarViewController",functionReference:function(){Gmail.GmailComposeManager.registerModifierModule({getViewControllers:function(){return[new RelatedBoxesOnComposeSidebarViewController]}})},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","data.boxes.initialized","data.pipelines.initialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MultipleActionListItemView=Streak.Class.subclass({className:"MultipleActionListItemView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this)},_setupElement:function(){this._element=$(document.createElement("div"));this._element.addClass("streak__multipleActionListItem");this._element[0].innerHTML='<div class="streak__multipleActionListItem_text"></div><div class="streak__multipleActionListItem_actions"></div>'},setText:function(text){this._element.find(".streak__multipleActionListItem_text").text(text)},addActionLink:function(linkButton){this._element.find(".streak__multipleActionListItem_actions").append(linkButton.getElement())}});Library.set("BentoBox.Widgets.MultipleActionListItemView",MultipleActionListItemView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var MultipleActionListItemViewController=Streak.Class.subclass({className:"MultipleActionListItemViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_mainText",destroy:false},{name:"_actionLinks",destroy:true,defaultValue:[]}],_initialize:function(mainText){Streak.UI.ViewController.prototype._initialize.call(this);this._view.setText(mainText)},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.MultipleActionListItemView")},addActionLink:function(linkButton){this._view.addActionLink(linkButton);this._actionLinks.push(linkButton)}});Library.set("BentoBox.Widgets.MultipleActionListItemViewController",MultipleActionListItemViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineSummaryLimiter=Streak.Class.subclass({className:"PipelineSummaryLimiter",superclass:Streak.BentoBox.Services.FeatureLimiter,_memberVariables:[],_initialize:function(){Streak.BentoBox.Services.FeatureLimiter.prototype._initialize.call(this)},_getFeatureKey:function(){return"pipelineColumnAggregate"},_getGatewayTitle:function(){return BB.Locale.getString("column_aggregates_gateway_title")},_getGatewayBodyText:function(){return BB.Locale.getString("column_aggregates_gateway_text")},_getLimit:function(){return 1}});DependencyManager.addFunction({functionKey:"PipelineSummaryLimiterInitialized",functionReference:function(){Library.set("BentoBox.Services.PipelineSummaryLimiter",new PipelineSummaryLimiter)},dependentFunctionKeys:["userLoggedIn"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var RapportiveComposeFixer=Streak.Class.subclass({className:"RapportiveComposeFixer",superclass:Streak.Object,_memberVariables:[],_initialize:function(){Streak.Object.prototype._initialize.call(this);if(!BB.Services.RapportiveStatusController.isEnabled()){return}this._startMonitoringComposeArea()},_startMonitoringComposeArea:function(){Gmail.addTimerObserver(this._fixComposeWindowContainer.bind(this));NotificationCenter.getNotificationStream().filter(function(notification){return notification.eventName==="newComposeWindow"&&BB.UI.isBentoBoxView()}).delay(100).onValue(this._fixComposeWindowContainer.bind(this))},_fixComposeWindowContainer:function(notification){if(!BB.UI.isBentoBoxView()){return}if(Gmail.GmailComposeWindowMasterController.getComposeWindows().length===0){return}var containerElement=Gmail.getComposeWindowContainerElement();var marginRightValue=containerElement[0].style.marginRight;if(marginRightValue===""){return}containerElement[0].style.marginRight="";var firstComposeWindow=Gmail.GmailComposeWindowMasterController.getComposeWindows()[0];firstComposeWindow.minimize();firstComposeWindow.restore()}});Streak.DependencyManager.addFunction({functionKey:"RapportiveComposeFixerInitialized",functionReference:function(){Library.set("BentoBox.Modules.RapportiveComposeFixer",new RapportiveComposeFixer)},dependentFunctionKeys:["userLoggedIn","gmailLoaded"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TagView=Streak.Class.subclass({className:"TagView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._setupBindings()},_setupElement:function(){Streak.UI.View.prototype._setupElement.call(this);this._element[0].innerHTML='<div class="vN"><div class="vT streak__tag_text"></div><div class="vM streak__tag_x"></div></div>';this._element.addClass("streak__tag vR");this._element[0].setAttribute("tabindex",-1)},setText:function(text){this._element.find(".streak__tag_text").text(text);this._element[0].setAttribute("data-tooltip",text)},focus:function(){this._element.focus()},_setupBindings:function(){var self=this;this._element.on("click",function(e){self._element.focus();e.preventDefault();e.stopPropagation()});this._element.focus(function(e){self._element.addClass("vS");self._eventStream.push({eventName:"focus",event:e})});this._element.blur(function(e){self._element.removeClass("vS")});this._element.find(".streak__tag_x").on("mousedown",function(e){self._eventStream.push({eventName:"xClicked",event:e});e.stopPropagation()});this._element.on("keypress",function(e){self._eventStream.push({eventName:"keypress",event:e,which:e.which})});this._element[0].addEventListener("keydown",function(e){self._eventStream.push({eventName:"keydown",event:e,which:e.which});e.preventDefault();e.stopPropagation();e.stopImmediatePropagation()},true)}});Library.set("BentoBox.Widgets.TagView",TagView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TagViewController=Streak.Class.subclass({className:"TagViewController",superclass:Streak.UI.ViewController,_memberVariables:[],_initialize:function(text){Streak.UI.ViewController.prototype._initialize.call(this);if(text){this.setText(text)}},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.TagView")},setText:function(text){this._view.setText(text)},focus:function(){this._view.focus()}});Library.set("BentoBox.Widgets.TagViewController",TagViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTagsModel=Streak.Class.subclass({className:"SmartTagsModel",superclass:BB.Widgets.ListView.ListViewBaseModel,_memberVariables:[{name:"_text",destroy:false},{name:"_currentlySelectedKeys",destroy:false,defaultValue:[]},{name:"_newOptions",destroy:false,defaultValue:[]},{name:"_optionSource",destroy:false,set:true},{name:"_listRows",destroy:true},{name:"_shouldHighlight",destroy:true,defaultValue:false}],_initialize:function(){BB.Widgets.ListView.ListViewBaseModel.prototype._initialize.call(this)},setText:function(text){this._text=text.trim();this._refresh()},setCurrentlySelectedKeys:function(keys){this._currentlySelectedKeys=keys||[];this._refresh()},addNewOption:function(optionName){this._newOptions.push({tag:optionName})},clearNewOptions:function(){this._newOptions=[]},_refresh:function(){this._sections=[];var _text=this._text||"";var searchText=_text.toLowerCase();var hasExactMatch=false;var self=this;this._shouldHighlight=false;this._listRows=_.chain(this._optionSource.getOptions()).concat(this._newOptions).sortBy(function(option){return option.tag.toLowerCase()}).filter(function(option){return option.tag.toLowerCase().indexOf(searchText)===0}).map(function(option){hasExactMatch=hasExactMatch||option.tag===_text;var isHighlighted=searchText.length>0&&option.tag.toLowerCase().indexOf(searchText)===0;self._shouldHighlight=self._shouldHighlight||isHighlighted;return{text:option.tag,option:option,isHighlighted:isHighlighted,isSelected:self._currentlySelectedKeys.indexOf(option.key||option.tag)>-1}}).value();if(this._listRows.length===0){if(this._text){this._addNoMatchingOptionsMessageSection()}else{this._addNoOptionsMessageSection()}this._sections.push({isSeparator:true})}else if(this._listRows.length>0){this._sections.push({rows:this._listRows});this._sections.push({isSeparator:true})}var isDisabled=hasExactMatch||!searchText;this._addCreateOptionSection(isDisabled);this._callDelegateFunction("dataChanged")},_addNoMatchingOptionsMessageSection:function(){this._sections.push({isFreeForm:true,element:'<div class="streak__listViewRow_disabled streak__dropdown_noOptions">'+BB.Locale.getString("tag_no_matching_options")+"</div>"})},_addNoOptionsMessageSection:function(){this._sections.push({isFreeForm:true,element:'<div class="streak__listViewRow_disabled streak__dropdown_noOptions">'+BB.Locale.getString("tag_no_options")+"</div>"})},_addCreateOptionSection:function(isDisabled){var buttonText;if(this._text&&!isDisabled){buttonText=BB.Locale.getString("tag_create_text_option",{option:this._text})}else{buttonText=BB.Locale.getString("tag_create_option")}this._sections.push({rows:[{text:buttonText,isCreateNew:true,isDisabled:isDisabled,displayClass:isDisabled?"streak__listViewRow_disabled":null}]})},isSectionSeparator:function(sectionIndex){return this._sections[sectionIndex].isSeparator},isSectionFreeForm:function(sectionIndex){return this._sections[sectionIndex].isFreeForm},getSectionFreeFormElement:function(sectionIndex){return this._sections[sectionIndex].element},dontHighlightOnDataChange:function(){return!this._shouldHighlight}});Library.set("BentoBox.Widgets.SmartTagsModel",SmartTagsModel)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTagsView=Streak.Class.subclass({className:"SmartTagsView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._setupEvents()},_setupElement:function(){Streak.UI.View.prototype._setupElement.call(this);this.addClass("smartInput streak__smartTags");this._element[0].setAttribute("tabindex",-1);this._element[0].innerHTML='<div class="R5"><div class="streak__smartTags_read"></div><div class="streak__smartTags_edit"></div></div>'},showRead:function(){this._element.find(".streak__smartTags_read").show();this._element.find(".streak__smartTags_edit").hide()},showEdit:function(){this._element.find(".streak__smartTags_read").hide();this._element.find(".streak__smartTags_edit").show()},setReadText:function(text){this._element.find(".streak__smartTags_read").text(text)},addTagView:function(tagView){this._element.find(".streak__smartTags_edit").prepend(tagView.getElement())},setTextInputView:function(textInputView){this._element.find(".streak__smartTags_edit").append(textInputView.getElement())},showGreyBorder:function(){this._element.removeClass("acm streak__transparentBorder");this._element.addClass("aco")},showBlueBorder:function(){this._element.addClass("acm");this._element.removeClass("aco streak__transparentBorder")},removeBorder:function(){this._element.removeClass("acm aco");this._element.addClass("streak__transparentBorder")},_setupEvents:function(){var self=this;this._element.click(function(e){self._eventStream.push({eventName:"click",event:e})});this._element.focus(function(e){self._eventStream.push({eventName:"focus",event:e})});this._element.mouseover(function(e){self._eventStream.push({eventName:"mouseover",event:e})});this._element.mouseleave(function(e){self._eventStream.push({eventName:"mouseleave",event:e})})}});Library.set("BentoBox.Widgets.SmartTagsView",SmartTagsView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,jwerty=Streak.jwerty,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTagsViewController=Streak.Class.subclass({className:"SmartTagsViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_model",destroy:false},{name:"_property",destroy:false},{name:"_tagKeys",destroy:false},{name:"_newTags",destroy:false},{name:"_optionSource",destroy:false},{name:"_unsubscribeFunction",destroy:true},{name:"_gmailTextareaViewController",destroy:true},{name:"_listViewController",destroy:true},{name:"_menuListWrapper",destroy:true},{name:"_smartTagsModel",destroy:true},{name:"_tagViewControllers",destroy:true,defaultValue:{}},{name:"_alwaysShowBorder",destroy:true},{name:"_inEditMode",destroy:true,defaultValue:true}],_initialize:function(options){Streak.UI.ViewController.prototype._initialize.call(this);this._model=options.model;this._property=options.property;this._tagKeys=this._model.get(this._property)||[];this._alwaysShowBorder=options.alwaysShowBorder;this._optionSource=options.optionSource;this._smartTagsModel=new BB.Widgets.SmartTagsModel;this._smartTagsModel.setOptionSource(this._optionSource);this._setupViewControllers();this._subscribeToViewEvents();this._subscribeToViewControllerEventStreams();this._subscribeToModelEventStream();this._updateDisplayValue();this._showRead()},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.SmartTagsView")},_setupViewControllers:function(){this._listViewController=new BB.Widgets.ListView.ListViewViewController;this._listViewController.setDataSource(this._smartTagsModel);this._menuListWrapper=BB.Widgets.Menu.create();this._menuListWrapper.addSection(this._listViewController.getView().getElement());this._menuListWrapper.getElement().addClass("streak__smartTags_menu");this._gmailTextareaViewController=new BB.Widgets.GmailTextareaViewController({plainTextOnly:true,multiline:false,noBorder:true});this._gmailTextareaViewController.addDelegate(this._listViewController);this._view.setTextInputView(this._gmailTextareaViewController.getView())},_subscribeToViewEvents:function(){var self=this;this._view.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="click"||eventWrapper.eventName==="focus"}).onValue(function(e){self._viewFocused()});this._view.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="mouseover"&&!self._alwaysShowBorder&&!self._inEditMode}).onValue(function(){self._view.showGreyBorder()});this._view.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="mouseleave"&&!self._alwaysShowBorder&&!self._inEditMode&&!self._areNoTagsSet()}).onValue(function(){self._view.removeBorder()})},_viewFocused:function(){if(this._inEditMode){this._gmailTextareaViewController.focus();return}this._showEdit();this._gmailTextareaViewController.focus();this._inEditMode=true},_subscribeToModelEventStream:function(){var self=this;this._unsubscribeFunction=this._model.getEventStream().filter(function(notification){return notification.property===self._property&&notification.eventName==="set"&&!self._inEditMode}).onValue(function(notification){self._tagKeys=notification.newValue||[];self._updateDisplayValue()})},_subscribeToViewControllerEventStreams:function(){var self=this;this._gmailTextareaViewController.getEventStream().onValue(this,"_gmailTextareaEvent");this._listViewController.getEventStream().onValue(this,"_listViewControllerEvent")},_gmailTextareaEvent:function(eventWrapper){switch(eventWrapper.eventName){case"focus":this._textInputFocused();break;case"input":this._textInputChanged();break;case"keydown":var event=eventWrapper.event;if(jwerty.is("tab",event)){this._tabPressed(event)}else if(jwerty.is("shift+tab",event)){this._tabPressed(event)}else if(jwerty.is("right",event)){this._rightPressed(event)}else if(jwerty.is("left",event)){this._leftPressed(event)}else if(jwerty.is("delete/backspace",event)){this._deletePressed(event)}else if(jwerty.is("escape",event)){this._escapePressed(event)}break}},_textInputFocused:function(){this._resetMenu()},_textInputChanged:function(){this._smartTagsModel.setText(this._gmailTextareaViewController.getText());this._displayMenu()},_tabPressed:function(event){event.preventDefault();event.stopPropagation();if(this._listViewController.isRowHighlighted()){var rowData=this._listViewController.getHighlightedRowData();if(rowData){if(!rowData.isDisabled){if(rowData.isCreateNew){this._createNewOption()}else{this._tryToSetValueBasedOnKey(rowData.option.key,true)}}}this._resetTextInput();return}this._resetTextInput();this._setAndSaveTagKeys();this._showRead();if(event.shiftKey){this._view.getElement().trigger("shiftTabPressed")}else{this._view.getElement().trigger("tabPressed")}},_rightPressed:function(event){if(this._gmailTextareaViewController.isCursorAtEnd()){event.preventDefault()}},_leftPressed:function(event){if(!this._gmailTextareaViewController.isCursorAtStart()){return}event.preventDefault();if(!this._gmailTextareaViewController.getText()){this._moveToLeftTag()}},_deletePressed:function(event){if(this._gmailTextareaViewController.getText()){return}if(this._gmailTextareaViewController.isCursorAtStart()){this._removeLastTag()}},_escapePressed:function(event){event.preventDefault();event.stopPropagation();this._smartTagsModel.clearNewOptions();this._tagKeys=_.clone(this._model.get(this._property)||[]);this._newTags=[];this._updateDisplayValue();this._showRead();this._view.getElement().trigger("escapePressed")},_listViewControllerEvent:function(eventWrapper){switch(eventWrapper.eventName){case"rowPressed":var rowData=eventWrapper.rowData;if(rowData.isCreateNew===true){this._createNewPressed(eventWrapper.rowData)}else if(!rowData.isSelected){this._rowPressed(rowData)}else{this._resetMenu()}break;case"emptyPressed":this._enterPressed();break}},_createNewPressed:function(rowData){if(rowData.isDisabled){this._listViewController.refresh()}else{this._createNewOption();this._resetTextInput();this._resetMenu()}},_rowPressed:function(rowData){var tagKey=rowData.option.key||rowData.option.tag;this._tryToSetValueBasedOnKey(tagKey);this._resetTextInput();this._gmailTextareaViewController.focus()},_tryToSetValueBasedOnText:function(fromTab){var text=this._gmailTextareaViewController.getText().trim();if(text){this._showNoSelectionError();return}this._detachMenu(fromTab)},_tryToSetValueBasedOnKey:function(key,fromTab){var value=this._getCurrentValue();value.push(key);this._updateDisplayValue();this._resetMenu();BB.Tracker.track("smartTags.setValue")},_showNoSelectionError:function(){BB.ButterBarManager.showError({message:BB.Locale.getString("tag_option_error"),time:6*1e3})},_updateDisplayValue:function(){this._clearTags();this._renderTags();this._view.setReadText(this._getReadDisplayValue(this._tagKeys))},_getReadDisplayValue:function(value){if(!value){return""}var self=this;return _.chain(value).map(function(tagKey){return self._optionSource.getOption(tagKey).tag}).value().join(", ")},_clearTags:function(){var keys=_.keys(this._tagViewControllers);for(var ii=0;ii<keys.length;ii++){this._tagViewControllers[keys[ii]].destroy()}this._tagViewControllers={}},_renderTags:function(){for(var ii=this._tagKeys.length-1;ii>=0;ii--){this._renderTag(this._tagKeys[ii])}},_renderTag:function(tagKey){var tagOption=this._optionSource.getOption(tagKey);if(!tagOption){return}var tagViewController=new BB.Widgets.TagViewController(tagOption.tag);this._subscribeToTagEvents(tagViewController,tagKey);this._addTagViewControllerToView(tagViewController);this._tagViewControllers[tagKey]=tagViewController},_subscribeToTagEvents:function(tagViewController,tagKey){var self=this;tagViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="focus"}).onValue(function(){self._detachMenu()});var xClickedStream=tagViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="xClicked"});xClickedStream.onValue(function(){self._removeTag(tagKey)});xClickedStream.delay(50).onValue(function(){self._gmailTextareaViewController.focus()});tagViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="keydown"}).map(function(eventWrapper){return eventWrapper.event}).onValue(function(event){if(jwerty.is("left",event)){self._moveToLeftTag(tagKey)}else if(jwerty.is("right",event)){self._moveToRightTag(tagKey)}else if(jwerty.is("enter",event)){self._enterPressed(event)}else if(jwerty.is("delete/backspace",event)){self._removeTag(tagKey);self._gmailTextareaViewController.focus()}else if(jwerty.is("tab",event)){if(event.shiftKey){self._view.getElement().trigger("shiftTabPressed")}else{self._view.getElement().trigger("tabPressed")}}else if(jwerty.is("escape",event)){self._escapePressed(event)}})},_addTagViewControllerToView:function(tagViewController){this._view.addTagView(tagViewController.getView())},_moveToLeftTag:function(tagKey){var value=this._getCurrentValue();if(!value||value.length===0){return}var newTagKey;if(!tagKey){newTagKey=_.last(value)}else{var index=value.indexOf(tagKey);if(index===0||index===-1){return}newTagKey=value[index-1]}this._tagViewControllers[newTagKey].focus()},_moveToRightTag:function(tagKey){var value=this._getCurrentValue();if(!value||value.length===0){return}var index=value.indexOf(tagKey);if(index===-1){return}if(index===value.length-1){this._gmailTextareaViewController.focus();return}var newTagKey=value[index+1];this._tagViewControllers[newTagKey].focus()},_removeLastTag:function(){var tags=this._getCurrentValue();if(!tags||tags.length===0){return}var lastTagKey=_.last(tags);this._removeTag(lastTagKey)},_removeTag:function(tagKey){var tagViewController=this._tagViewControllers[tagKey];if(tagViewController){delete this._tagViewControllers[tagKey];tagViewController.destroy()}var value=this._getCurrentValue();value.removeVal(tagKey);this._resetMenu();this._updateDisplayValue()},_getCurrentValue:function(){return this._tagKeys},_enterPressed:function(){this._setAndSaveTagKeys();this._showRead()},_showRead:function(){this._inEditMode=false;this._view.showRead();this._detachMenu();this._gmailTextareaViewController.setText("");if(this._alwaysShowBorder){this._view.showGreyBorder();return}if(this._areNoTagsSet()){this._view.showGreyBorder()}else{this._view.removeBorder()}this._view.getElement().unbindBodyCloseAndStop()},_areNoTagsSet:function(){var value=this._getCurrentValue();return!value||value.length===0},_showEdit:function(){this._smartTagsModel.clearNewOptions();this._tagKeys=_.clone(this._model.get(this._property)||[]);
this._newTags=[];this._resetMenu();this._view.showEdit();this._view.showBlueBorder();this._setupBodyCloseAndStop()},_detachMenu:function(fromTab){if(this._menuListWrapper){this._menuListWrapper.getElement().detach()}},_resetTextInput:function(){this._gmailTextareaViewController.setText("");this._smartTagsModel.setText("")},_resetMenu:function(){this._smartTagsModel.setCurrentlySelectedKeys(this._getCurrentValue());this._displayMenu()},_displayMenu:function(){if(!this._menuListWrapper){return}var menuElement=this._menuListWrapper.getElement();if(menuElement.isVisible()){menuElement.containByScreen(this._gmailTextareaViewController.getView().getElement());return}Gmail.elements.body.append(menuElement);menuElement[0].style.position="fixed";menuElement.containByScreen(this._gmailTextareaViewController.getView().getElement())},_setupBodyCloseAndStop:function(){var self=this;this._view.getElement().bodyCloseAndStop({closeFunction:function(){self._showRead();self._setAndSaveTagKeys()},body:Gmail.elements.body,stop:this._menuListWrapper.getElement()})},_createNewOption:function(){var optionName=this._gmailTextareaViewController.getText();if(!optionName){return}this._newTags.push(optionName);this._tagKeys.push(optionName);this._smartTagsModel.addNewOption(optionName);this._updateDisplayValue();BB.Tracker.track("smartTags.addNewOption")},_setAndSaveTagKeys:function(){BB.Tracker.track("smartTags.updateTags");this._optionSource.updateTags(this._newTags,this._tagKeys,this._model);this._updateDisplayValue()},getElement:function(){return this._view.getElement()},destroy:function(){this._view.getElement().unbindBodyCloseAndStop();Streak.UI.ViewController.prototype.destroy.call(this)}});Library.set("BentoBox.Widgets.SmartTagsViewController",SmartTagsViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=Streak.BentoBox.Widgets.SmartTagsViewController;var SpreadsheetSmartTagsViewController=Streak.Class.subclass({className:"SpreadsheetSmartTagsViewController",superclass:superclass,_memberVariables:[],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._inEditMode=true;this._smartTagsModel=new BB.Widgets.SmartTagsModel;this._setupViewControllers();this._subscribeToViewEvents();this._subscribeToViewControllerEventStreams()},_setupView:function(){this._view=Library.getInstance("BentoBox.Widgets.SmartTagsView")},focus:function(){this._showEdit();this._resetTextInput();this._resetMenu();this._updateDisplayValue();this._gmailTextareaViewController.focus()},set:function(value){this.focus();var self=this;setTimeout(function(){self._gmailTextareaViewController.setText(value);self._textInputChanged();self._gmailTextareaViewController.setCursorToEnd()},20)},setup:function(options){if(this._unsubscribeFunction){this._unsubscribeFunction()}this._model=options.model;this._property=options.property;this._optionSource=options.optionSource;this._smartTagsModel.setOptionSource(this._optionSource)},updateValue:function(){this._detachMenu();this._setAndSaveTagKeys()},_subscribeToViewEvents:function(){var self=this;this._view.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="click"||eventWrapper.eventName==="focus"}).onValue(function(e){self._viewFocused()})},_setupViewControllers:function(){superclass.prototype._setupViewControllers.call(this);this._menuListWrapper.getElement().addClass("streak__spreadsheetSmartTags_menu");var menuElement=this._menuListWrapper.getElement()},_updateDisplayValue:function(){this._clearTags();this._renderTags()},_showEdit:function(){this._smartTagsModel.clearNewOptions();this._tagKeys=_.clone(this._model.get(this._property)||[]);this._newTags=[];this._resetMenu();this._view.showEdit()},_enterPressed:function(){this._view.getElement().trigger("enterPressed")}});Library.set("BentoBox.Widgets.SpreadsheetSmartTagsViewController",SpreadsheetSmartTagsViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var GmailCheckboxView=Streak.Class.subclass({className:"GmailCheckboxView",superclass:Streak.UI.View,_memberVariables:[{name:"_initialText",destroy:true}],_initialize:function(initialText){this._initialText=initialText;Streak.UI.View.prototype._initialize.call(this)},setIsChecked:function(checked){this._element.setChecked(checked)},isChecked:function(){return this._element.isChecked()},setText:function(text){this._element.find("span").text(text)},focus:function(){this._element.focus()},disable:function(){},enable:function(){},_setupElement:function(){this._element=Gmail.widgets.getCheckbox(this._initialText);this._bindToEvents()},_bindToEvents:function(){var self=this;this._element.bind("change",function(){self._eventStream.push({eventName:"valueChanged",isChecked:self.isChecked()})})},getCheckStream:function(){return this._eventStream.filter(function(eventWrapper){return eventWrapper.eventName==="valueChanged"}).map(function(eventWrapper){return eventWrapper.isChecked})}});Library.set("BentoBox.Widgets.GmailCheckboxView",GmailCheckboxView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,jwerty=Streak.jwerty,BB=Streak.BentoBox;var GmailTextCalendarViewController=Streak.Class.subclass({className:"GmailTextCalendarViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_gmailTextareaViewController",destroy:true},{name:"_pickdate",destroy:false},{name:"_shouldIncludeTime",destroy:true,defaultValue:true},{name:"_shouldAutoClose",destroy:true,defaultValue:true},{name:"_date",destroy:true,set:true,get:true}],_initialize:function(options){if(options){this._shouldIncludeTime=_.isReal(options.shouldIncludeTime)?options.shouldIncludeTime:true;this._shouldAutoClose=_.isReal(options.shouldAutoClose)?options.shouldAutoClose:true}Streak.UI.ViewController.prototype._initialize.call(this)},setDateString:function(dateString){var date=Date.create(dateString);this.setDate(date)},setDate:function(date){if(date&&!date.isValid()){date=null}this._date=date;this._updatePickdateDate();this._updateDisplay()},focus:function(){this._gmailTextareaViewController.focus()},setText:function(text){this._gmailTextareaViewController.setText(text)},setCursorToEnd:function(){this._gmailTextareaViewController.setCursorToEnd()},setEnabled:function(isEnabled){this._gmailTextareaViewController.setEnabled(isEnabled)},showCalendar:function(){this._showCalendar()},hideCalendar:function(){this._hideCalendar()},setPlaceholderText:function(text){this._gmailTextareaViewController.setPlaceholderText(text)},_setupView:function(){this._gmailTextareaViewController=new BB.Widgets.GmailTextareaViewController({multiline:false,plainTextOnly:true});this._view=this._gmailTextareaViewController.getView();this._view.addClass("streak__gmailTextCalendar");this._pickdate=this._view.getTextInput().pickdate({animationDuration:0,body:Gmail.elements.body,allowEmpty:true,appendTo:this._view.getElement(),useFixedPosition:true,autoClose:this._shouldAutoClose,onSelect:this._calendarDateSelected.bind(this),onClose:this._calendarClosed.bind(this)});this._view.getEventStream().onValue(this,"_textInputEvent")},_textInputEvent:function(eventWrapper){switch(eventWrapper.eventName){case"focus":this._showCalendar();break;case"keydown":if(jwerty.is("tab/shift+tab",eventWrapper.event)){this._extractAndSetDateFromText()}break}},_calendarDateSelected:function(selectedDate){this._gmailTextareaViewController.setText(selectedDate.prettyDate(true))},_calendarClosed:function(isEnter){this._extractAndSetDateFromText();if(isEnter){this._view.blur();this._getTextInput().trigger("enterPressed")}},_extractAndSetDateFromText:function(){var text=this._gmailTextareaViewController.getText();if(!text){if(!this._date){return}this.setDate(null);this._eventStream.push({eventName:"dateSelected",date:this._date});return}var date=Date.create(text);if(date.isValid()){if(this._date&&date.getTime()===this._date.getTime()){this.setDate(date);return}this.setDate(date);this._eventStream.push({eventName:"dateSelected",date:this._date})}else{this.setDate(this._date)}},_showCalendar:function(){this._updatePickdateDate();this._pickdate.showCalendar()},_hideCalendar:function(){this._pickdate.hideCalendar()},_updatePickdateDate:function(){if(this._date){this._getTextInput().data("time",this._date.getTime())}else{this._getTextInput().data("time",null)}},_getTextInput:function(){return this._gmailTextareaViewController.getView().getTextInput()},_updateDisplay:function(){if(!this._date){this._gmailTextareaViewController.setText("");return}this._gmailTextareaViewController.setText(this._date.prettyDate(true))}});Library.set("BentoBox.Widgets.GmailTextCalendarViewController",GmailTextCalendarViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var SmartTextCalendarViewController=Streak.Class.subclass({className:"SmartTextCalendarViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_gmailTextCalendarViewController",destroy:true},{name:"_model",destroy:false},{name:"_property",destroy:false},{name:"_alwaysShowBorder",destroy:true},{name:"_unsubscribeFunction",destroy:false}],_initialize:function(options){this._model=options.model;this._property=options.property;this._alwaysShowBorder=options.alwaysShowBorder;Streak.UI.ViewController.prototype._initialize.call(this);this._subscribeToModelEventStream();this._updateBorderDisplay();if(this._model){this._gmailTextCalendarViewController.setDateString(this._model.get(this._property));this._gmailTextCalendarViewController.setEnabled(this._model.getIsEditable())}},_setupView:function(){this._gmailTextCalendarViewController=new BB.Widgets.GmailTextCalendarViewController({shouldIncludeTime:false});this._view=this._gmailTextCalendarViewController.getView();this._view.addClass("smartInput");this._gmailTextCalendarViewController.getEventStream().onValue(this,"_gmailTextCalendarEvent")},_subscribeToModelEventStream:function(){var self=this;this._unsubscribeFunction=this._model.getEventStream().filter(function(notification){return notification.property===self._property&&notification.eventName==="set"}).map(function(notification){return notification.newValue}).onValue(function(value){self._gmailTextCalendarViewController.setDateString(value)})},focus:function(){this._gmailTextCalendarViewController.focus()},getElement:function(){return this._view.getElement()},_gmailTextCalendarEvent:function(eventWrapper){switch(eventWrapper.eventName){case"dateSelected":var date=eventWrapper.date;if(date){this._model.set(this._property,eventWrapper.date.getTime())}else{this._model.set(this._property,"")}this._model.save();this._updateBorderDisplay();BB.Tracker.track("dateFieldChanged");break;case"keydown":if(Streak.jwerty.is("tab",eventWrapper.event)){this.getElement().trigger("tabPressed")}else if(Streak.jwerty.is("shift+tab",eventWrapper.event)){this.getElement().trigger("shiftTabPressed")}break;case"mouseover":if(this._alwaysShowBorder){return}this._view.showBorder();break;case"mouseleave":this._updateBorderDisplay();break}},_updateBorderDisplay:function(){if(this._alwaysShowBorder){return}if(this._model.get(this._property)){this._view.hideBorder()}else{this._view.showBorder()}}});Library.set("BentoBox.Widgets.SmartTextCalendarViewController",SmartTextCalendarViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var superclass=BB.Widgets.SmartTextCalendarViewController;var SpreadsheetSmartTextCalendarViewController=Streak.Class.subclass({className:"SpreadsheetSmartTextCalendarViewController",superclass:superclass,_memberVariables:[{name:"_parentElement",destroy:false}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._gmailTextCalendarViewController=new BB.Widgets.GmailTextCalendarViewController({shouldIncludeTime:false,shouldAutoClose:false});this._view=this._gmailTextCalendarViewController.getView();this._view.addClass("smartInput");this._gmailTextCalendarViewController.getEventStream().onValue(this,"_gmailTextCalendarEvent")},set:function(value){this.focus();var self=this;setTimeout(function(){self._gmailTextCalendarViewController.setText(value);self._gmailTextCalendarViewController.setCursorToEnd()},20)},setup:function(options){this._model=options.model;this._property=options.property;this._gmailTextCalendarViewController.setDateString(this._model.get(this._property))},updateValue:function(){this._gmailTextCalendarViewController.hideCalendar()},_gmailTextCalendarEvent:function(eventWrapper){switch(eventWrapper.eventName){case"dateSelected":var date=eventWrapper.date;if(date){this._model.set(this._property,eventWrapper.date.getTime())}else{this._model.set(this._property,"")}this._model.save();this.getElement().trigger("escapePressed");BB.Tracker.track("dateFieldChanged");break;case"keydown":if(Streak.jwerty.is("escape",eventWrapper.event)){this._gmailTextCalendarViewController.setDateString(this._model.get(this._property));this.getElement().trigger("escapePressed")}else if(Streak.jwerty.is("enter",eventWrapper.event)){this.getElement().trigger("enterPressed")}break}}});Library.set("BentoBox.Widgets.SpreadsheetSmartTextCalendarViewController",SpreadsheetSmartTextCalendarViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendFileOptionsView=Streak.Class.subclass({className:"DocSendFileOptionsView",superclass:Streak.UI.View,_memberVariables:[{name:"_allowAnonymousViewing",destroy:true},{name:"_allowDownloading",destroy:true},{name:"_expireCheckbox",destroy:true},{name:"_passcodeCheckbox",destroy:true},{name:"_expireTimeHour",destroy:true},{name:"_expireTimeDate",destroy:true},{name:"_passcode",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._setupWidgets();this.resetState()},_setupElement:function(){this._element=HTML.getElement("docsend_main_options_container")},resetState:function(){this._allowAnonymousViewing.setIsChecked(false);this._allowDownloading.setIsChecked(false);this._expireCheckbox.setIsChecked(false);this._passcodeCheckbox.setIsChecked(false);this._expireTimeHour.resetCurrentTime();this._expireTimeDate.setDate(Date.create("one day from now"));this._expireTimeDate.setText("");this._passcode.setText("");this._expireTimeHour.disable();this._expireTimeDate.setEnabled(false);this._passcode.setEnabled(false)},afterOpening:function(){this._setupTabOrder();this.focus()},focus:function(){this._allowAnonymousViewing.focus()},setSubmitButton:function(buttonView){this._submitButton=buttonView;this._element.find(".docsend_submit").html(buttonView.getElement())},setChangeDocumentButton:function(buttonView){this._changeDocumentButton=buttonView;this._element.find(".docsend_change_document").html(buttonView.getElement())},setDocumentName:function(name){this._element.find(".docsend_document_name").text(name)},getOptions:function(){var options={allowAnonymousViewing:this._allowAnonymousViewing.isChecked(),allowDownloading:this._allowDownloading.isChecked(),expires:this._expireCheckbox.isChecked(),hasPasscode:this._passcodeCheckbox.isChecked(),passcode:this._passcode.getText()};if(options.expires){options.expireTime=this._constructExpireTime()}return options},_setupWidgets:function(){this._allowAnonymousViewing=new BB.Widgets.GmailCheckboxView("Allow anonymous viewing");this._allowDownloading=new BB.Widgets.GmailCheckboxView("Allow downloading");this._expireCheckbox=new BB.Widgets.GmailCheckboxView("Expire:");this._passcodeCheckbox=new BB.Widgets.GmailCheckboxView("Passcode:");this._expireTimeHour=new BB.Widgets.TimePickerButtonMenuViewController;this._expireTimeDate=new BB.Widgets.GmailTextCalendarViewController({shouldIncludeTime:false,shouldAutoClose:true});this._passcode=new BB.Widgets.GmailTextareaViewController({multiline:false});this._element.find(".docsend_allow_anonymous_viewing").html(this._allowAnonymousViewing.getElement());this._element.find(".docsend_allow_downloading").html(this._allowDownloading.getElement());this._element.find(".docsend_expire_toggle").html(this._expireCheckbox.getElement());this._element.find(".docsend_passcode_toggle").html(this._passcodeCheckbox.getElement());this._element.find(".docsend_expire_hour").html(this._expireTimeHour.getView().getElement());this._element.find(".docsend_expire_date").html(this._expireTimeDate.getView().getElement());this._element.find(".docsend_passcode").html(this._passcode.getView().getElement());this._expireTimeDate.setPlaceholderText("Pick Date");this._setupContentEditability()},_setupContentEditability:function(){this._expireCheckbox.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="valueChanged"}).map(function(eventWrapper){return eventWrapper.isChecked}).onValue(this,"_setExpireContentEditable");this._passcodeCheckbox.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="valueChanged"}).map(function(eventWrapper){return eventWrapper.isChecked}).onValue(this,"_setPasscodeContentEditable")},_setExpireContentEditable:function(isChecked){if(isChecked){this._expireTimeHour.enable()}else{this._expireTimeHour.disable()}this._expireTimeDate.setEnabled(isChecked);this._setupTabOrder()},_setPasscodeContentEditable:function(isChecked){this._passcode.setEnabled(isChecked);this._setupTabOrder()},_setupTabOrder:function(){var chain=[this._submitButton.getElement(),this._changeDocumentButton.getElement(),this._allowAnonymousViewing.getElement(),this._allowDownloading.getElement(),this._expireCheckbox.getElement()];if(this._expireCheckbox.isChecked()){chain.push(this._expireTimeHour.getView().getElement());chain.push(this._expireTimeDate.getView().getElement())}chain.push(this._passcodeCheckbox.getElement());if(this._passcodeCheckbox.isChecked()){chain.push(this._passcode.getView().getElement())}$.tabChain(chain)},_constructExpireTime:function(){var expireDate=this._expireTimeDate.getDate()||new Date;var expireHour=this._expireTimeHour.getCurrentTime();expireDate.setHours(expireHour.getHours());expireDate.setMinutes(expireHour.getMinutes());return expireDate}});Library.set("BentoBox.Modules.DocSend.DocSendFileOptionsView",DocSendFileOptionsView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendFileOptionsViewController=Streak.Class.subclass({className:"DocSendFileOptionsViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_documentInfo",destroy:true},{name:"_changeDocumentButton",destroy:true},{name:"_submitButton",destroy:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.DocSend.DocSendFileOptionsView");this._createSubmitButton()},setDocumentInfo:function(documentInfo){this._documentInfo=documentInfo;this._view.setDocumentName(documentInfo.name)},afterOpening:function(){this.getView().afterOpening()},createChangeDocumentButton:function(callback){this._changeDocumentButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Text",color:"blue",text:"change",onFunction:callback});this._view.setChangeDocumentButton(this._changeDocumentButton)},_createSubmitButton:function(){this._submitButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"green",text:BB.Locale.getString("docSend_insert_link"),onFunction:this._submit.bind(this)});this._view.setSubmitButton(this._submitButton)},_submit:function(){var options=this._view.getOptions();options.documentInfo=this._documentInfo;this._eventStream.push({eventName:"submit",options:options})}});Library.set("BentoBox.Modules.DocSend.DocSendFileOptionsViewController",DocSendFileOptionsViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,Library=Streak.Library,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendMenuView=Streak.Class.subclass({className:"DocSendMenuView",superclass:Streak.UI.View,_memberVariables:[{name:"_loadingPanel",destroy:true},{name:"_docListPanel",destroy:true},{name:"_docOptionsPanel",destroy:true},{name:"_loginPanel",destroy:true},{name:"_errorPanel",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("docsend_main_menu_container");this._setupStates()},setListView:function(listView){this._docListPanel.find(".docsend_doc_list_container").html(listView.getElement())},setOptionsView:function(optionsView){this._docOptionsPanel.find(".docsend_doc_options_container").html(optionsView.getElement())},setLoginButton:function(buttonView){this._element.find(".docsend_login_button").html(buttonView.getElement())},showLoadingPanel:function(){this._hideAllPanels();this._loadingPanel.show().css("display","-webkit-flex")},showNoDocsPanel:function(){this._hideAllPanels();this._docListPanel.show();this._noDocsPanel.show()},addGoToDocSendButton:function(button){this._noDocsPanel.find(".docsend__goToDocSendHolder").append(button.getElement())},showDocListPanel:function(){this._hideAllPanels();this._docListPanel.show()},showDocOptionsPanel:function(){this._hideAllPanels();this._docOptionsPanel.show()},showLoginPanel:function(){this._hideAllPanels();this._loginPanel.show()},show3rdPartyCookiesWarning:function(){this._loginPanel.find(".docsend_3rd_party_cookies").show()},showErrorPanel:function(){this._hideAllPanels();this._errorPanel.show()},_setupStates:function(){this._loadingPanel=this._element.find(".docsend_loading_panel");this._noDocsPanel=this._element.find(".docsend_noDocs_panel");this._docListPanel=this._element.find(".docsend_doc_list_panel");this._docOptionsPanel=this._element.find(".docsend_doc_options_panel");this._loginPanel=this._element.find(".docsend_login_panel");this._errorPanel=this._element.find(".docsend_error_panel")},_hideAllPanels:function(){this._loadingPanel.hide();this._noDocsPanel.hide();this._docListPanel.hide();this._docOptionsPanel.hide();this._loginPanel.hide();this._errorPanel.hide()}});Library.set("BentoBox.Modules.DocSend.DocSendMenuView",DocSendMenuView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendDataAccess=Streak.Class.subclass({className:"DocSendDataAccess",superclass:Streak.Object,_memberVariables:[],getDocList:function(){var request=new Streak.Request("GET","https://docsend.com","/api/gmail/documents");return request.getPromise()},createLink:function(linkOptions){var request=new Streak.Request("POST","https://docsend.com","/api/gmail/links",{contentType:"application/json",bodyData:JSON.stringify({link:linkOptions})});return request.getPromise()},updateLink:function(linkId,linkOptions){var request=new Streak.Request("PUT","https://docsend.com","/api/gmail/links/"+linkId,{contentType:"application/json",responseType:"text",bodyData:JSON.stringify({link:linkOptions})});return request.getPromise()}});Library.set("BentoBox.Modules.DocSend.DocSendDataAccess",new DocSendDataAccess)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendMenuViewController=Streak.Class.subclass({className:"DocSendMenuViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_searchableListViewController",destroy:true},{name:"_folders",destroy:true},{name:"_loginAttempted",destroy:false,defaultValue:false},{name:"_goToDocSendButton",destroy:true},{name:"_docOptionsViewController",destroy:true,get:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this);this._folders=[];this._setupGoToDocSendButton();this._setupSearchableListViewController();this._setupDocOptionsViewController();this._setupLoginButton()},getElement:function(){return this._view.getElement()},resetState:function(){this._view.showLoadingPanel();this._refreshDocs();this._docOptionsViewController.getView().resetState()},_setupView:function(){this._view=Library.getInstance("BentoBox.Modules.DocSend.DocSendMenuView")},_setupGoToDocSendButton:function(){this._goToDocSendButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"green",text:"Go to DocSend",onFunction:function(){window.open("https://docsend.com")}});this._view.addGoToDocSendButton(this._goToDocSendButton)},_setupSearchableListViewController:function(){this._searchableListViewController=Library.getInstance("BentoBox.Widgets.SearchableListViewController");this._searchableListViewController.setShouldLockSelection(false);this._searchableListViewController.getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="rowSelected"}).map(function(eventWrapper){return eventWrapper.rowData}).onValue(this,"_documentSelected");this._searchableListViewController.setDataSource(this);this._view.setListView(this._searchableListViewController.getView())},_setupDocOptionsViewController:function(){this._docOptionsViewController=Library.getInstance("BentoBox.Modules.DocSend.DocSendFileOptionsViewController");this._docOptionsViewController.createChangeDocumentButton(this._showSearchableDocumentList.bind(this));this._view.setOptionsView(this._docOptionsViewController.getView())},_setupLoginButton:function(){var loginButton=BB.Widgets.Buttons.ButtonFactory.createButton({type:"Gmail",color:"blue",text:"Sign In Now",onFunction:this._showLoginWindow.bind(this)});this._view.setLoginButton(loginButton)},_showLoginWindow:function(){var height=810;var width=768;var left=window.screenX+(window.outerWidth/2-width/2);var top=window.screenY+(window.outerHeight/2-height/2);var openWindow=window.open("https://docsend.com/api/gmail/login","DocSend Login","height="+height+",width="+width+",left="+left+",top="+top+",toolbar=0,resizable=0,menubar=0,location=0,status=0,scrollbars=0");var self=this;var closeChecker=_.repeatEvery(function(){if(openWindow&&openWindow.closed){closeChecker.stop();self._loginAttempted=true;self._refreshDocs()}},500)},_refreshDocs:function(){var self=this;BB.Modules.DocSend.DocSendDataAccess.getDocList().then(function(response){self._setupListViewWithDocumentFolders(response.folders)}).catch(this.handleDocSendRequestError.bind(this))},handleDocSendRequestError:function(errorObject){if(errorObject&&errorObject.xhr&&errorObject.xhr.status===401){this._view.showLoginPanel();if(this._loginAttempted){this._view.show3rdPartyCookiesWarning()}}else{this._view.showErrorPanel()}},_setupListViewWithDocumentFolders:function(folders){this._folders=folders;if(this._noDocumentsExist()){this._view.showNoDocsPanel();return}this._searchableListViewController.dataUpdated();this._showSearchableDocumentList()},_noDocumentsExist:function(){if(!this._folders){return true}if(this._folders.length===0){return true}!_.any(this._folders,function(folder){return folder.documents&&folder.documents.length>0})},_showSearchableDocumentList:function(){this._searchableListViewController.clearQuery();this._view.showDocListPanel();this._searchableListViewController.focus()},getNumberOfSections:function(){return this._folders.length},getSectionTitle:function(sectionIndex){return this._folders[sectionIndex].name},getSectionAfterTitleIconClass:function(sectionIndex){var folder=this._folders[sectionIndex];if(folder.teamIcon){return"streak__docsend_team"}return null},getNumberOfRows:function(sectionIndex){return this._folders[sectionIndex].documents.length},getRowData:function(sectionIndex,rowIndex){var doc=this._folders[sectionIndex].documents[rowIndex];if(doc.teamIcon){return{html:"<span>"+_.escape(doc.name)+"</span>"+'<span class="streak__bbIcon streak__docsend_team"></span>',doc:doc}}else{return{text:doc.name,doc:doc}}},getRowSearchString:function(sectionIndex,rowIndex){return this._folders[sectionIndex].documents[rowIndex].name},dontHighlightOnDataChange:function(){return true},_documentSelected:function(rowData){this._docOptionsViewController.setDocumentInfo(rowData.doc);this._view.showDocOptionsPanel();this._docOptionsViewController.afterOpening()}});Library.set("BentoBox.Modules.DocSend.DocSendMenuViewController",DocSendMenuViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var DocSendOnComposeViewController=Streak.Class.subclass({className:"DocSendOnComposeViewController",superclass:BB.Modules.ComposeViewControllerBase,_memberVariables:[{name:"_menuButton",destroy:true},{name:"_menu",destroy:true}],_initialize:function(){BB.Modules.ComposeViewControllerBase.prototype._initialize.apply(this,_.toArray(arguments))},initialize:function(composeWindowViewController){this._composeWindowViewController=composeWindowViewController;this._setupMenuButton();return this},_setupMenuButton:function(){this._setupMenuViewController();var self=this;this._menuButton=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailIcon",color:"icon",iconClass:"docSendIcon",menu:self._menu,isBottomAligned:true,isFixedPosition:true,useCapture:false,preOnFunction:function(){if(self._anyLinksInUserSelection()){BB.ButterBarManager.showMessage("Can't insert DocSend link over a link.",{messageKey:"DocSend"});return true}else{self._menu.resetState()}}});this._menuButton.getElement()[0].addEventListener("mousedown",function(event){BB.ButterBarManager.hideMessage("DocSend");event.preventDefault()},true);this._menuButton.setTooltip(BB.Locale.getString("docSend_tooltip"))},_anyLinksInUserSelection:function(){return _.any(this._getAllComposeWindowLinks(),function(link){return window.getSelection().containsNode(link,true)})},_setupMenuViewController:function(){this._menu=new BB.Modules.DocSend.DocSendMenuViewController;this._menu.getDocOptionsViewController().getEventStream().filter(function(eventWrapper){return eventWrapper.eventName==="submit"}).map(function(eventWrapper){return eventWrapper.options}).onValue(this,"_createDocumentLink")},_createDocumentLink:function(documentOptions){var linkOptions={recipients:this._composeWindowViewController.getToEmailAddresses(),document_id:documentOptions.documentInfo.id,allow_anonymous:documentOptions.allowAnonymousViewing,downloadable:documentOptions.allowDownloading};if(documentOptions.expires){linkOptions.expire_at=documentOptions.expireTime.getTime()/1e3;if(documentOptions.expireTime.getTime()<Date.now()){BB.ButterBarManager.showMessage("Please enter a valid expiration date.",{messageKey:"DocSendInvalidExpire"});
return}else{BB.ButterBarManager.hideMessage("DocSendInvalidExpire")}}if(documentOptions.hasPasscode){linkOptions.passcode=documentOptions.passcode;if(linkOptions.passcode.length===0){BB.ButterBarManager.showMessage("Please enter a valid passcode.",{messageKey:"DocSendInvalidPasscode"});return}else{BB.ButterBarManager.hideMessage("DocSendInvalidPasscode")}}var self=this;BB.Modules.DocSend.DocSendDataAccess.createLink(linkOptions).then(function(response){self._handleLinkInformation(documentOptions.documentInfo.name,response.link)}).catch(this._menu.handleDocSendRequestError.bind(this._menu));this._menu.getView().showLoadingPanel()},_handleLinkInformation:function(documentName,linkInfo){this._resetState();this._insertLink(documentName,linkInfo)},_resetState:function(){this._menuButton.off()},_insertLink:function(name,linkInfo){this._composeWindowViewController.getEditor().focus();this._composeWindowViewController.getInsertLinkButton().simulateRawClick();if($("#linkdialog-text").length===0){return}var originalText=$("#linkdialog-text").val();var href=linkInfo.fullUrl+"?id="+linkInfo.id;this._fakeHumanishInputToSelector("#linkdialog-onweb-tab-input",href);$("button[name=ok]").click();var $link=this._composeWindowViewController.getEditor().find('a[href="'+href+'"]');if(originalText.length===0){$link.text(name)}},_fakeHumanishInputToSelector:function(selector,text){var input=$(selector);input.val(text);var evt=document.createEvent("Event");evt.initEvent("input");input[0].dispatchEvent(evt)},getModificationType:function(){return"ADD_ELEMENT"},getModificationArea:function(){return"BOTTOM_TOOLBAR"},getModificationPlacement:function(){return"BEFORE_FORMATTING"},getModificationPriority:function(){return 1e3},getModificationElement:function(){return this._menuButton.getElement()},aboutToSend:function(){var recipients=this._composeWindowViewController.getToEmailAddresses();var linkIds=this._gatherLinkIds();_.each(linkIds,function(linkId){BB.Modules.DocSend.DocSendDataAccess.updateLink(linkId,{recipients:recipients})})},potentiallyDiscardedOrSent:function(){this._menuButton.off()},_gatherLinkIds:function(){return _.chain(this._getAllComposeWindowLinks()).filter(this._isaDocSendLink).map(this._removeAndReturnIdFromLink).value()},_getAllComposeWindowLinks:function(){return this._composeWindowViewController.getEditor().find("a")},_isaDocSendLink:function(link){return link.href.slice(8,25)==="docsend.com/view/"},_removeAndReturnIdFromLink:function(link){var match=link.href.match(/(.+)\?id=(\d+)/);$(link).attr("href",match[1]);return parseInt(match[2])},destroy:function(){Streak.NotificationCenter.unsubscribe({observer:this});BB.Modules.ComposeViewControllerBase.prototype.destroy.call(this)}});Library.set("BentoBox.Modules.DocSend.DocSendOnComposeViewController",DocSendOnComposeViewController);DependencyManager.addFunction({functionKey:"docSendOnComposeViewControllerInitialized",functionReference:function(callback){var modifierModule={getViewControllers:function(){return new DocSendOnComposeViewController}};Gmail.GmailComposeManager.registerModifierModule(modifierModule);Gmail.GmailReplyManager.registerModifierModule(modifierModule)},dependentFunctionKeys:["gmailComposeWindowMasterControllerInitialized","gmailLoaded","localeLoaded","htmlLoaded","docsendEnabled"]});DependencyManager.addFunction({functionKey:"docSendFirstRunInitialized",functionReference:function(callback){if(!BB.LocalSettings.get("docSendFirstRunSeen")){BB.Modules.Help.HelpLoader.getHelpViewController().startChapter("DocSend First Run");BB.LocalSettings.set("docSendFirstRunSeen",true)}},dependentFunctionKeys:["docSendOnComposeViewControllerInitialized","helpLoaderInitialized","localSettingsInitialized"]})})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var TimePickerButtonMenuViewController=Streak.Class.subclass({className:"TimePickerButtonMenuViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_currentTime",destroy:true,get:true,set:true},{name:"_minuteGranularity",destroy:true},{name:"_buttonMenu",destroy:true},{name:"_menu",destroy:true}],_initialize:function(minuteGranularity,currentTime){if(_.isReal(currentTime)){this._currentTime=currentTime}else{this._currentTime=Date.create()}this._currentTime.setMinutes(0);this._currentTime.setSeconds(0);this._minuteGranularity=minuteGranularity||60;Streak.UI.ViewController.prototype._initialize.call(this)},resetCurrentTime:function(){this._currentTime=Date.create();this._currentTime.setMinutes(0);this._currentTime.setSeconds(0);this._updateCurrentTime()},setCurrentTime:function(timeDate){this._setCurrentTime(timeDate)},disable:function(){this._buttonMenu.disable()},enable:function(){this._buttonMenu.enable()},_setupView:function(){this._setupMenu();this._setupButtonMenu();this._view=this._buttonMenu},_setupMenu:function(){this._menu=BB.Widgets.Menu.create();var numberOfSteps=24*60/this._minuteGranularity;for(var ii=0;ii<numberOfSteps;ii++){var timeDate=Date.create("12AM");var minutesToAdd=this._minuteGranularity*ii;timeDate.addMinutes(minutesToAdd);this._addTimeEntry(timeDate)}},_addTimeEntry:function(timeDate){var self=this;this._menu.addItem(timeDate.customFormat("shortTime"),function(event){event.stopPropagation();self._setCurrentTime(timeDate);self._eventStream.push({eventName:"timeChanged",value:timeDate})})},_setupButtonMenu:function(){this._buttonMenu=BB.Widgets.Buttons.ButtonFactory.createMenuButton({type:"GmailArrow",color:"default",text:this._currentTime.customFormat("shortTime"),menu:this._menu,isFixedPosition:true,isRightAligned:true,menuClickTriggersOff:true});this._buttonMenu.setTabIndex(-1)},_setCurrentTime:function(timeDate){this._currentTime=timeDate;this._updateCurrentTime()},_updateCurrentTime:function(){this._buttonMenu.setText(this._currentTime.customFormat("shortTime"))}});Library.set("BentoBox.Widgets.TimePickerButtonMenuViewController",TimePickerButtonMenuViewController)})(Streak);(function(Streak){"use strict";var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var defaults={menuClickTriggersOff:false,itemList:[]};var MultiSelectMenuButton=function(inOptions){var options=_.extend({},defaults,inOptions);options.menu=BB.Widgets.Menu.create();options.menu.getElement().addClass("streak__multiSelectMenu");BB.Widgets.Buttons.FixedPositionMenuButton.call(this,options);this._eventStream=new Streak.Bacon.Bus;this._itemListMap={};this._currentlySelectedValues=[];this._defaultText=options.defaultText;this.setItemList(options.itemList);this._updateButtonText()};MultiSelectMenuButton.prototype=Object.create(BB.Widgets.Buttons.FixedPositionMenuButton.prototype);_.extend(MultiSelectMenuButton.prototype,{setItemList:function(itemList){this.options.menu.empty();this._itemListMap={};this._itemList=itemList||[];for(var ii=0;ii<this._itemList.length;ii++){this._addListItem(this._itemList[ii])}},setCurrentlySelectedValues:function(values){this._currentlySelectedValues=values||[];var mapKeys=_.keys(this._itemListMap);for(var ii=0;ii<mapKeys.length;ii++){this._updateItemSelectedState(mapKeys[ii])}this._updateButtonText()},getCurrentlySelectedValues:function(){return this._currentlySelectedValues},getEventStream:function(){return this._eventStream},_addListItem:function(listItem){if(!listItem){return}if(listItem==="__separator"){this.options.menu.addSeparator();return}var html;if(listItem.displayHTML){html=displayHTML}else if(listItem.displayText){html=_.escape(listItem.displayText)}if(!html){return}var self=this;var checkbox=this.options.menu.addCheckItem(html,function(isChecked){self._updateSelectedValue(isChecked,listItem.value)});this._itemListMap[listItem.value]=checkbox},_updateSelectedValue:function(isChecked,itemValue){if(isChecked){this._currentlySelectedValues.push(itemValue)}else{this._currentlySelectedValues.removeVal(itemValue)}this._eventStream.push({eventName:"selectedValuesChanged",currentlySelectedValues:_.clone(this._currentlySelectedValues)});this._updateButtonText()},_updateItemSelectedState:function(itemValue){var checkbox=this._itemListMap[itemValue];if(!checkbox){return}checkbox.setCheckboxState(this._currentlySelectedValues.indexOf(itemValue)>-1)},_updateButtonText:function(){var displayHTML;if(this._currentlySelectedValues.length===0){displayHTML=_.escape(this._defaultText)}else if(this._currentlySelectedValues.length===1){var listItem;for(var jj=0;jj<this._itemList.length;jj++){if(this._itemList[jj].value===this._currentlySelectedValues[0]){listItem=this._itemList[jj];break}}if(listItem){if(listItem.displayText){displayHTML=_.escape(listItem.displayText)}else if(listItem.displayHTML){displayHTML=listItem.displayHTML}}}else{displayHTML=_.escape(BB.Locale.getString("multiselect_chosen",{number:this._currentlySelectedValues.length}))}if(!displayHTML){displayHTML=_.escape(this._defaultText)}this.setHTML(displayHTML)}});Library.set("BentoBox.Widgets.Buttons.MultiSelectMenuButton",MultiSelectMenuButton)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var FormulaHelpViewController=Streak.Class.subclass({className:"FormulaHelpViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_unbindFunction",destroy:true},{name:"_initialHelpState",destroy:true}],_initialize:function(){Streak.UI.ViewController.prototype._initialize.call(this)},_setupView:function(){var self=this},forceOpen:function(){BB.LocalSettings.set("formulaHelp/state","open");this.activate()},activate:function(){this._initialHelpState=null;var state=BB.LocalSettings.get("formulaHelp/state");if(state==="closed"){return}this._initialHelpState=BB.Modules.Help.HelpLoader.getHelpViewController().getState();var self=this;this._unbindFunction=BB.Modules.Help.HelpLoader.getHelpViewController().getEventStream().onValue(function(eventWrapper){if(eventWrapper.eventName==="closeClicked"){self._closeClicked()}});NotificationCenter.subscribe({eventName:"tourHelpCloseClicked",functionToCall:this._closeClicked,observer:this});this._showFormulaHelp()},deactivate:function(){if(this._unbindFunction){this._unbindFunction()}if(this._initialHelpState){BB.Modules.Help.HelpLoader.getHelpViewController().setState(this._initialHelpState)}BB.Tour.TourChapterViewController.stopCurrentTour()},_closeClicked:function(){BB.Tracker.track("formula help menu closed");BB.LocalSettings.set("formulaHelp/state","closed")},_showFormulaHelp:function(){BB.Modules.Help.HelpLoader.getHelpViewController().setState({searchText:"Formula Columns",scrollPosition:0,viewState:"VISIBLE"});BB.Modules.Help.HelpLoader.getHelpViewController().startChapter("Formula Column Examples")},destroy:function(){NotificationCenter.unsubscribe({observer:this})}});Library.set("BentoBox.Widgets.FormulaHelpViewController",FormulaHelpViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineSharingSettingsContactEntryView=Streak.Class.subclass({className:"PipelineSharingSettingsContactEntryView",superclass:Streak.UI.View,_memberVariables:[],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("aclRow")},setupRowInfo:function(rowInfo){this._element.find(".name").prepend(rowInfo.name);this._element.find(".email").html(rowInfo.email);this._element.find(".status").html(rowInfo.status);this._element.find(".image").html(rowInfo.image)},getRemoveButton:function(){return this._element.find(".remove")}});Library.set("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsContactEntryView",PipelineSharingSettingsContactEntryView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineSharingSettingsContactEntryViewController=Streak.Class.subclass({className:"PipelineSharingSettingsContactEntryViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_person",destroy:false}],_initialize:function(person){this._person=person;Streak.UI.ViewController.prototype._initialize.call(this)},setupRemoveButton:function(callback){this._view.getRemoveButton().click(function(e){callback();e.preventDefault()})},_setupView:function(){this._view=Library.getInstance("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsContactEntryView");var person=this._person;this._view.setupRowInfo({name:person.fullName||person.email,email:person.fullName===person.email?"":person.email,status:BB.Locale.getString(person.isOwner?"share_owner":"share_edit"),image:this._constructImage(person.imageUrl)});if(person.isOwner){this._view.getRemoveButton().remove()}},_constructImage:function(imageUrl){return imageUrl?'<img src="'+imageUrl+'" />':'<div class="noUserImageWrapper"><div class="noUserImage"></div></div>'}});Library.set("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsContactEntryViewController",PipelineSharingSettingsContactEntryViewController)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineSharingSettingsModalView=Streak.Class.subclass({className:"PipelineSharingSettingsModalView",superclass:Streak.UI.View,_memberVariables:[{name:"_modal",destroy:true,get:true},{name:"_advancedOptionsButton",destroy:true}],_initialize:function(){Streak.UI.View.prototype._initialize.call(this);this._element=HTML.getElement("shareSettingsButtonModal");this._setupModal()},_setupModal:function(){this._modal=BB.Widgets.Modal.create({title:"Sharing Settings",inner:"here are your sharing settings",showCancel:true,confirmText:"Save",inner:this._element,width:"500px"})},addSharingRestrictionCheckbox:function(checkboxView){this._element.find(".restrictSharingToOrgCheck").html(checkboxView.getElement())},addOrgWideCheckbox:function(checkboxView){this._element.find(".shareOrgCheck").html(checkboxView.getElement())},addAdvancedOptionsButton:function(buttonView){this._element.find(".sharingOptionsHeader").append(buttonView.getElement());this._advancedOptionsButton=buttonView},addPersonPickerView:function(personPickerView){this._element.find(".sharingEnter").append(personPickerView.getElement())},showModal:function(){this._modal.show()},showWarning:function(message){this._element.find(".streak__shareModal_warning").show().html(message)},hideWarning:function(){this._element.find(".streak__shareModal_warning").hide()},setPrivate:function(){this.getPrivateButton().addClass("active");this.getSharedButton().removeClass("active");this._element.find(".sharingOptionsWrapper").hide()},setShared:function(){this.getPrivateButton().removeClass("active");this.getSharedButton().addClass("active");this._element.find(".sharingOptionsWrapper").show()},getPrivateButton:function(){return this._element.find(".private")},getSharedButton:function(){return this._element.find(".shared")},setOrgName:function(name){this._element.find(".orgName").text(name)},toggleOwnerUI:function(isOwner){this._element.find(".shareOrg").toggle(isOwner);this._advancedOptionsButton.getElement().toggle(isOwner)},showSharingRestriction:function(){this._element.find(".advancedOptionsLoading").hide();this._element.find(".restrictOrgMessage").show();this._element.find(".restrictSharingToOrgCheck").show()},hideSharingRestriction:function(){this._element.find(".advancedOptionsLoading").show();this._element.find(".restrictOrgMessage").hide();this._element.find(".restrictSharingToOrgCheck").hide()},removeACLRows:function(){this._element.find(".acl").empty()},addACLRow:function(row){this._element.find(".acl").append(row.getView().getElement())},showAdvancedOptions:function(){this._element.find(".restrictOrg").show();this._advancedOptionsButton.setHTML(BB.Locale.getString("hide_advanced_options"))},hideAdvancedOptions:function(){this._element.find(".restrictOrg").hide();this._advancedOptionsButton.setHTML(BB.Locale.getString("show_advanced_options"))}});Library.set("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsModalView",PipelineSharingSettingsModalView)})(Streak);(function(Streak){var $=Streak.jQuery,_=Streak._,Library=Streak.Library,Gmail=Streak.Gmail,Date=Streak.Date,HTML=Streak.HTML,UI=Streak.UI,NotificationCenter=Streak.NotificationCenter,DependencyManager=Streak.DependencyManager,BB=Streak.BentoBox;var PipelineSharingSettingsModalViewController=Streak.Class.subclass({className:"PipelineSharingSettingsModalViewController",superclass:Streak.UI.ViewController,_memberVariables:[{name:"_pipeline",destroy:false},{name:"_modelPatch",destroy:true},{name:"_personPicker",destroy:true},{name:"_restrictSharingToOrgCheckbox",destroy:true},{name:"_shareWithOrgCheckbox",destroy:true}],show:function(){this._view.showModal()},_initialize:function(pipeline){Streak.UI.ViewController.prototype._initialize.call(this);this._pipeline=pipeline;if(!pipeline){throw new Error("Tried to setup a pipeline sharing settings modal with no pipeline.")}this._modelPatch=this._pipeline.createPatch();this._modelPatch.set("aclEntries",_.clone(this._modelPatch.get("aclEntries")));this._isPrivate=this._initiallyIsPrivate();this._updateOrgRestictedSharingStatus();this._shareWithOrgCheckbox.setIsChecked(this._modelPatch.get("orgWide"));this._updatePersonPickerChoices();this._updateDisplay();this._view.getModal().setConfirmFunc(this._saveSharingSettings.bind(this))},_setupView:function(){this._view=Library.getInstance("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsModalView");this._setupPrivateAndSharedButtons();this._setupPersonPicker();this._setupAdvancedOptionsButton();this._setupOrgSharingCheckboxes()},_setupPrivateAndSharedButtons:function(){var self=this;this._view.getPrivateButton().click(function(e){self._isPrivate=true;self._updateDisplay();e.preventDefault()});this._view.getSharedButton().click(function(e){self._isPrivate=false;self._updateDisplay();self._personPicker.focus();e.preventDefault()})},_setupPersonPicker:function(){var self=this;this._personPicker=new BB.Widgets.PersonPickerViewController({contactSelectedCallback:function(person){if(!person.email){self._view.showWarning(BB.Locale.getString("invalid_email_address"));return}if(!self._isPersonValidInOrg(person)){self._view.showWarning(BB.Locale.getString("restricted_person",{org:self._modelPatch.get("organization").organizationId}));return}self._acl().push(person);self._newACLRow(person).getView().getElement().scrollintoview({duration:0});self._updatePersonPickerChoices();self._updateDisplay()}});this._view.addPersonPickerView(this._personPicker.getView())},_isPersonValidInOrg:function(person){return!this._modelPatch.get("sharingRestrictedToOrg")||BB.Modules.Paywall.AccountViewControllerInstance.isBillingAdminForAnyPlan()||this._modelPatch.get("organization").organizationId.toLowerCase()===person.email.split("@")[1].toLowerCase()},_updatePersonPickerChoices:function(){this._personPicker.setExcluded(this._acl().concat(this._modelPatch.get("owner")))},_setupAdvancedOptionsButton:function(){var advancedOptionsButton=BB.Widgets.Buttons.ButtonFactory.createToggleButton({type:"Text",text:BB.Locale.getString("show_advanced_options"),onFunction:this._view.showAdvancedOptions.bind(this._view),offFunction:this._view.hideAdvancedOptions.bind(this._view)});this._view.addAdvancedOptionsButton(advancedOptionsButton)},_setupOrgSharingCheckboxes:function(){this._restrictSharingToOrgCheckbox=new BB.Widgets.GmailCheckboxView;this._shareWithOrgCheckbox=new BB.Widgets.GmailCheckboxView;this._restrictSharingToOrgCheckbox.getCheckStream().onValue(this,"_setSharingRestriction");this._shareWithOrgCheckbox.getCheckStream().onValue(this,"_setOrgWide");this._view.addSharingRestrictionCheckbox(this._restrictSharingToOrgCheckbox);this._view.addOrgWideCheckbox(this._shareWithOrgCheckbox)},_setSharingRestriction:function(bool){this._modelPatch.set("sharingRestrictedToOrg",bool)},_setOrgWide:function(bool){this._modelPatch.set("orgWide",bool)},_initiallyIsPrivate:function(){return!this._modelPatch.get("orgWide")&&(!this._acl()||_.all(this._acl(),function(person){return person.isOwner}))},_updateOrgRestictedSharingStatus:function(){this._view.hideSharingRestriction();var self=this;this._pipeline.didBillingAdminRestrictSharingToOrg().then(function(isRestricted){self._view.showSharingRestriction();if(isRestricted){self._restrictSharingToOrgCheckbox.disable()}self._restrictSharingToOrgCheckbox.setIsChecked(isRestricted||self._modelPatch.get("sharingRestrictedToOrg"))})},_updateDisplay:function(){this._handleOrgOwnership(BB.getUser().getDomain());this._view.hideWarning();if(this._isPrivate){this._view.setPrivate()}else{this._view.setShared()}this._view.removeACLRows();this._newACLRow(this._modelPatch.get("owner"));_.each(this._acl(),this._newACLRow.bind(this))},_handleOrgOwnership:function(domain){var isOwner=this._isOrgOwner(domain);if(isOwner){this._view.setOrgName(domain.capitalize())}this._view.toggleOwnerUI(isOwner)},_isOrgOwner:function(domain){return this._modelPatch.get("orgKey")===BB.getUser().get("orgKey")&&!_.contains(BB.Constants.EMAIL_BLACK_LIST,domain)},_newACLRow:function(person){var row=new BB.Services.PipelineSharingSettings.PipelineSharingSettingsContactEntryViewController(person);if(!person.isOwner){var self=this;row.setupRemoveButton(function(){row.destroy();self._acl().removeVal(person);self._updatePersonPickerChoices()})}this._view.addACLRow(row);return row},_isUser:function(person){return person&&person.email&&person.email===BB.getUser().getEmail()},_saveSharingSettings:function(force){var self=this;var isUserRemovingOwnAccess=!this._userIsntRemovingOwnAccess();if(!force&&isUserRemovingOwnAccess){this._informUserRemovingOwnAccess();return true}if(this._isPrivate){this._modelPatch.set("orgWide",false);this._modelPatch.set("aclEntries",[])}this._modelPatch.commit();this._pipeline.save();if(isUserRemovingOwnAccess){this._pipeline.remove()}this.destroy()},_userIsntRemovingOwnAccess:function(){return this._modelPatch.get("creatorKey")===BB.getUser().key()||_.any(this._acl(),this._isUser)},_informUserRemovingOwnAccess:function(){this._view.showWarning(BB.Locale.getString("removing_own_access_warning"));this._view.getModal().getOkButton().getElement().text(BB.Locale.getString("confirm"));this._view.getModal().setConfirmFunc(this._saveSharingSettings.bind(this,true))},_acl:function(){return this._modelPatch.get("aclEntries")}});Library.set("BentoBox.Services.PipelineSharingSettings.PipelineSharingSettingsModalViewController",PipelineSharingSettingsModalViewController)})(Streak);